<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Offline-capable Film Production Budget Tool">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>mooBudgetTool v19.54-Beta</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moollc/mooBudgetTool/refs/heads/main/assets/cow-512.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack.min.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
/* --- Core Layout & Scrollbar --- */
        /* Logic Resolution: Increased bottom padding to prevent content overlap with footer */
        body { font-family: 'Inter', sans-serif; padding-bottom: 128px; background-color: #f3f4f6; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

/* --- 1. Interaction Protocols (Drag and drop behavior) --- */
        .draggable-row { cursor: grab; transition: all 0.2s ease-in-out; }
        .draggable-row:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(2px) scale(1.02); z-index: 1000; }
        .drag-over { background-color: #f3f4f6; border-top: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6; transition: all 0.2s ease-in-out; }

/* --- 2. Atomic UI Components --- */
        .alert-badge { position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .status-indicator { transition: opacity 0.5s ease-in-out; }
        .status-online { border-color: #22c55e; color: #15803d; background-color: #f0fdf4; }
        .status-offline { border-color: #ef4444; color: #b91c1c; background-color: #fef2f2; cursor: not-allowed; }

/* --- 3. Roadmap Visualization --- */
        .roadmap-past { color: #9ca3af; }
        .roadmap-current { color: #2563eb; font-weight: 700; }
        .roadmap-future { color: #1f2937; }

/* --- 4. Intelligence Suite Visuals --- */
        .ai-message { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.5; }
        .ai-message.user { background-color: #eff6ff; border: 1px solid #dbeafe; color: #1e3a8a; text-align: right; margin-left: 20%; }
        .ai-message.assistant { background-color: #f0fdf4; border: 1px solid #dcfce7; color: #14532d; margin-right: 10%; }
        .ai-message.assistant strong { color: #166534; font-weight: 700; }
        .ai-message.assistant ul { list-style-type: disc; margin-left: 20px; margin-top: 5px; }

/* --- 5. Support Interface --- */
        .bmc-btn { background-color: #FFDD00; color: #000000; font-family: 'Inter', sans-serif; font-weight: 600; border-radius: 8px; padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; text-decoration: none; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;}
        .bmc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

/* --- 6. Print Media Protocols --- */
        @media print { #footnote, #loginBtn, footer, #settingsBtn, #openAiToolsBtn { display: none !important; } }
        #bmac-btn-container, #bmc-wbtn { display: none !important; }

/* --- 7. Production Stage Visuals --- */
        #stagesCarousel { scrollbar-width: none; -ms-overflow-style: none; }
        #stagesCarousel::-webkit-scrollbar { display: none; }
        .stage-card { transition: transform 0.2s; }
        .stage-drop-zone { min-height: 100px; }
        .stage-draggable { transition: all 0.2s; touch-action: none; }
        .stage-draggable:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

/* --- 8. Mobile Platform Support --- */
        @media (max-width: 768px) {
            .mobile-desc-truncate { text-overflow: ellipsis; white-space: nowrap; overflow: hidden; width: 100%; display: block; }
            .mobile-desc-truncate:focus { white-space: normal; overflow: visible; position: relative; z-index: 50; background: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 4px; padding: 8px; height: auto; }
        }

/* --- 9. Navigation Elements --- */
        .sticky-section-header { position: sticky; top: 0; z-index: 30; background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .sticky-th { position: sticky; top: 43px; z-index: 20; background-color: #ffffff; }

/* --- 10. Document Studio Canvas --- */
        .grid-stack { background-color: #f3f4f6; min-height: 80vh; padding: 10px !important; }
        .grid-stack-item-content { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; overflow: hidden !important; display: flex; flex-direction: column; cursor: grab; }
   
/* --- 11. Form Utilities (Spinner Removal) --- */
        .no-spinner::-webkit-inner-spin-button, 
        .no-spinner::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-spinner { -moz-appearance: textfield; appearance: none; }

/* --- 12. Crew Contact Popups (Adapted Legacy Logic) --- */
        .crew-wrapper { 
            position: relative; 
            z-index: 20; 
            display: inline-block;
        }
        
        /* Main Avatar Button */
        .crew-avatar {
            /* Adapted size: 28px -> 32px for better touch, shrinks to 28px on tiny screens via HTML classes */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); /* Legacy "Pop" effect */
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 20; /* Always above the pill */
        }
        .crew-avatar:hover { transform: scale(1.15); }
        .crew-avatar:active { transform: scale(0.95); }

        /* The Floating Pill (Hidden State) */
        .crew-popup {
            position: absolute;
            left: 50%; /* Start centered behind avatar */
            top: 50%;
            transform: translate(-50%, -50%) scale(0.5); /* Start small and centered */
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 9999px;
            padding: 4px 6px 4px 28px; /* Left padding creates the visual gap for the avatar */
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 10; /* Behind avatar */
            white-space: nowrap;
        }

        /* The "Hit Buffer" (Invisible bridge so mouse doesn't lose focus) */
        .crew-popup::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 30px; /* Covers the gap between avatar and buttons */
            background: transparent;
            z-index: -1;
        }

        /* Active State (Hover OR Mobile Class) */
        @media (hover: hover) {
            .crew-wrapper:hover .crew-popup {
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
                transform: translate(20px, -50%) scale(1); /* Slide out to the right */
            }
        }
        
        /* Mobile Toggle State */
        .crew-wrapper.mobile-active .crew-popup {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translate(20px, -50%) scale(1);
        }

        /* Action Buttons inside the Pill */
        .contact-action-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: transform 0.2s ease;
            flex-shrink: 0;
            text-decoration: none;
        }
        .contact-action-btn:hover { transform: scale(1.2); }
        .contact-action-btn svg { width: 14px; height: 14px; }

        /* Legacy Colors adapted for Tailwind Palette */
        .action-call { background-color: #10b981; } /* Emerald-500 */
        .action-wa { background-color: #25D366; }   /* WhatsApp Brand Color */
        .action-email { background-color: #3b82f6; } /* Blue-500 */
        .action-profile { background-color: #64748b; } /* Slate-500 */

/* --- 13. Classic Theme Overrides (Legacy Mode) --- */
        /* Logic Resolution: CSS Nesting to strip modern UI features when enabled */
        .classic-theme { font-family: 'Arial', sans-serif !important; }
        
        /* Squared Corners & Borders */
        .classic-theme .rounded-2xl, .classic-theme .rounded-3xl, 
        .classic-theme .rounded-xl, .classic-theme .rounded-lg, 
        .classic-theme .rounded-md, .classic-theme .rounded,
        .classic-theme .rounded-full { border-radius: 2px !important; }
        
        /* Flatten Depth (Remove Shadows, Add Borders) */
        .classic-theme .shadow-2xl, .classic-theme .shadow-xl, 
        .classic-theme .shadow-lg, .classic-theme .shadow-sm { 
            box-shadow: none !important; 
            border: 1px solid #9ca3af !important; 
        }
        
        /* Retro Typography */
        .classic-theme header input#projectName { 
            font-family: 'Courier New', monospace; 
            letter-spacing: -1px; 
            background: #fff;
            border: 1px solid #000 !important;
        }
        .classic-theme .uppercase { text-transform: none !important; }
        .classic-theme .tracking-widest { letter-spacing: normal !important; }
        
        /* High Contrast Colors */
        .classic-theme .bg-slate-900 { background-color: #333 !important; border: 1px solid #000; }
        .classic-theme .bg-blue-600 { background-color: #0044cc !important; }
        .classic-theme .text-blue-600 { color: #0044cc !important; }
        .classic-theme .bg-emerald-600 { background-color: #007733 !important; }
        
        /* Inputs & Tables */
        .classic-theme input, .classic-theme select { 
            background-color: #fff !important; 
            border: 1px solid #ccc !important; 
            border-radius: 0 !important;
        }
        .classic-theme .bg-slate-50 { background-color: #eee !important; }
        
</style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack-all.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
	<script data-name="BMC-Widget" data-id="jaysonmy" data-description="Support mooBudget development!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js"></script>
</head>

<body class="bg-gray-100 pb-24">
    <div id="app" class="max-w-7xl mx-auto px-4 py-8"></div>
    <div id="global-modal-container"></div>

    <footer class="fixed bottom-0 left-0 right-0 z-[100] p-4 pointer-events-none">
        <div class="max-w-xl mx-auto bg-slate-900/90 backdrop-blur-xl border border-white/10 rounded-[32px] shadow-2xl p-2 px-6 flex justify-between items-center pointer-events-auto">
            
            <button id="stagesFooterBtn" class="flex flex-col items-center gap-1 group transition-all active:scale-90">
                <div class="text-slate-400 group-hover:text-emerald-400" id="icon-stages"></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-emerald-400">Stages</span>
            </button>

            <button id="docsFooterBtn" class="flex flex-col items-center gap-1 group transition-all active:scale-90">
                <div class="text-slate-400 group-hover:text-blue-400" id="icon-docs"></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-blue-400">Documents</span>
            </button>

            <button id="mainActionBtn" class="w-14 h-14 bg-blue-600 rounded-[22px] shadow-xl shadow-blue-500/20 flex items-center justify-center text-white border-2 border-white/20 transition-all hover:bg-blue-500 active:scale-90">
                <div id="icon-main-action"></div>
            </button>

            <button id="secondaryActionBtn" class="flex flex-col items-center gap-1 group transition-all active:scale-90">
                <div class="text-slate-400 group-hover:text-indigo-400" id="icon-secondary-action"></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-indigo-400">Publish</span>
            </button>

            <button id="footerCoffeeBtn" class="flex flex-col items-center gap-1 group transition-all active:scale-90">
                <div class="text-slate-400 group-hover:text-amber-400" id="icon-coffee"></div>
                <span class="text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-amber-400">Support</span>
            </button>
        </div>
    </footer>
</body>

<script>
/* ================= v19.55 TIER 1: Environment Configuration v19.55 ================= */

/* --- 1. Global System Identity --- */
    const APP_VERSION = "19.54";
    const storageKeyPrefix = 'prodBudget_v5_';
    const trashKey = `${storageKeyPrefix}trash`;
    const globalItemsKey = `${storageKeyPrefix}globalItems`;
    const templatesKey = `${storageKeyPrefix}templates`;
    const projectDateFormatKey = `${storageKeyPrefix}projectDateFormat`;
    const projectNameSeparatorKey = `${storageKeyPrefix}projectNameSeparator`;
    
    // Core physics and hydration state
    let budget = null;
    let currentProjectName = null;
    let historyStack = [];
    let historyIndex = -1;
    const MAX_HISTORY = 15;

/* --- 2. Dynamic Multi-Currency Logic --- */
    let displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
    
    // Base Rates (Defaults for offline endurance)
    let exchangeRates = JSON.parse(localStorage.getItem(`${storageKeyPrefix}rates`)) || {
        'USD': 1.0, 'JMD': 157.50, 'GBP': 0.79, 'CAD': 1.36, 'EUR': 0.92,
        'AUD': 1.52, 'NZD': 1.63, 'ZAR': 18.50, 'INR': 83.00, 'JPY': 150.00, 'CNY': 7.20
    };

    const FILM_CURRENCIES = [
        { code: 'JMD', label: 'JMD' }, { code: 'USD', label: 'USD' },
        { code: 'GBP', label: 'GBP' }, { code: 'CAD', label: 'CAD' },
        { code: 'EUR', label: 'EUR' }, { code: 'AUD', label: 'AUD' },
        { code: 'NZD', label: 'NZD' }, { code: 'ZAR', label: 'ZAR' },
        { code: 'INR', label: 'INR' }, { code: 'CNY', label: 'CNY' },
        { code: 'JPY', label: 'JPY' }
    ];

/* --- 3. Master Asset Registry (Consolidated SVG Library) --- */
    const mBTAssets = {
appLogo: `<svg viewBox="0 0 502.17 507.14" fill="none"><circle cx="251.1" cy="253.6" r="251" fill="#fdba35"/><ellipse cx="251.08" cy="254.6" rx="219.09" ry="222.65" fill="#e68b2e"/><rect x="203.17" y="63.34" width="39.87" height="58.38" rx="12" ry="12" fill="#fdba35"/><rect x="287.89" y="63.34" width="39.87" height="58.38" rx="12" ry="12" fill="#fdba35"/><path fill="#ffffff" d="M435.26 218.85c-9.37 8.14-49.07 32.97-49.8 15.81 11.55-127.5-229.22-149.43-231.01-24.74 6.07 54.05 43.35 54.26 87.82 52.06 146.67-19.16 207.1 157.09 46.91 189.89-58.04 11.48-128.93-19.18-142.75-80.18 46.88 38.84 113.67 68.1 171.96 37.26 26.86-13.77 47.21-49.89 26.52-76.85-38.48-58.02-113.62-26.74-169.36-43.4-33.76-8.68-39.32-44.89-49.26-40.21-40.71 11.77-74.81-18.1-93.73-51.57-11.64-17.99 23.01-37.67 23.01-37.67 78.34-46.2 83.04-2.52 100.98-30.11 13.01-12.52 28.91-19.88 45.88-25.26 14.39-.81-2.14-26.45 12.52-30.74 8.55-3.29 22.55-1.35 21.53 10.41v7.96q0 5.96 6.03 5.19c15.31-1.13 30.59-.73 45.84 1.04 4.51 1.52 6.39.14 5.88-4.8.18-6.63-2.41-16.54 5.48-19.48 39.51-10.45 11.06 33.02 28.69 33.36 24.13 8.69 46.04 20.74 62.06 41.52 1.37 1.77 2.67 1.3 4.34.83 21.56-6.19 44.45 3.51 61.99 15.88 16.53 11.27-10.05 43.62-21.53 53.81Zm-303.07-60.53c-15.13-3.64-31.31 1.65-45.48 7.89-10.48 5.14-25.95 13.17-31.69 19.68-7.43 4.29 10.4 20.59 13.85 25.15 12.7 13.47 31.71 23.14 50.39 17.73 2.48-.4 3.49-1.51 3.13-3.82-2.68-22.93-.15-45.14 9.8-66.63m311.98 17.39c-2.49-5.29-32.19-13.69-45.6-11.24 3.21 8.51 7.77 19.74 8.85 29.37 2.12 18.88 1.07 24.71.92 25.13 14.31-5.74 40.59-33.14 35.83-43.26m-244.14 12.41c-8.45-1.05-18.22 1.95-18.24 12 .78 10.17-4.5 33.22 12 33.15 8.45 1.05 18.22-1.95 18.24-12-.78-10.17 4.5-33.22-12-33.14Zm-6.08 168.77c-1.38-2.31-16.01-18.07-16.01-18.07-3.59-3.64-6.21-13.1-14.02-8.77-3.6 2.84-5.79 3.83-.54 12.88 7.81 11.59 24.83 28.14 30.57 13.96m-87.43-126.66c.73.03 1.47.03 2.21.02-.74.01-1.48 0-2.21-.02m-37.65-19.19c.27.27.53.54.8.81-.27-.27-.53-.54-.8-.81m258.53-22.92c-8.45-1.05-18.22 1.95-18.24 12 .78 10.17-4.5 33.22 12 33.15 8.45 1.05 18.22-1.95 18.24-12-.78-10.17 4.5-33.22-12-33.14Z"/></svg>`,

       // --- Core UI & Actions ---
    plus: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
    trash: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
    search: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
    close: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
    drag: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>`,
    
    // --- Status & Access ---
    lock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
    unlock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`,
    
    // --- Intelligence & Tools ---
    sparkle: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,
    doctor: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
    chat: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
    target: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
    zap: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
    
    // --- Contact & Personnel ---
    user: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
    phone: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
    mail: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
    wa: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>`,
    
    // --- File System ---
    file: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>`,
    folder: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`,
    cloud: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19A5.5 5.5 0 0 0 18 8.02a9 9 0 0 0-17.53 1.98 7 7 0 0 0 .03 14h12.5a5.5 5.5 0 0 0 4.5-9z"/></svg>`,
    clip: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>`,
    
    // --- Editor Controls ---
    money: `<svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.15-1.46-3.27-3.4h1.96c.1 1.05 1.18 1.91 2.53 1.91 1.38 0 2.29-.84 2.29-1.93 0-1.02-.75-1.58-2.31-2.03l-1.3-.39C8.3 11.5 7 10.15 7 8.35c0-1.69 1.33-2.92 2.76-3.32V3h2.67v1.93c1.61.35 2.89 1.43 3.03 3.19h-1.95c-.13-.9-.95-1.64-2.18-1.64-1.2 0-2.02.77-2.02 1.96 0 .93.75 1.58 2.21 2.03l1.41.44c2.56.77 3.91 2.21 3.91 4.19 0 1.93-1.47 3.32-3.43 3.68z"/></svg>`,
    wand: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21 2-2 2m-7.61 7.61a2 2 0 1 1-2.83 2.83l9.99-9.99a2 2 0 0 1 2.83 2.83l-9.99 9.99"/><path d="M18 16v.01M7 8V8.01M7 16V16.01M3 12V12.01M10 20V20.01M15 5V5.01M12 9V9.01"/></svg>`,
    undo: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>`,
    redo: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 14 5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/></svg>`,
    copy: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`,
    list: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
    grid: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>`,
    save: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
    print: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>`,
    
    // --- New Template Icons ---
    film: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>`,
    camera: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>`,

    // --- Footer New Assets ---
gear: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>`,
coffee: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>`,
paperPlane: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`,
image: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`,
};

/* --- 4. Master Link Map (Backwards Compatibility) --- */
    const uiIcons = mBTAssets, tplIcons = mBTAssets, docIcons = mBTAssets, dashIcons = mBTAssets;
    const stageModIcons = mBTAssets, analyticsIcons = mBTAssets, contactIcons = mBTAssets;
    const fileIcons = mBTAssets, opsIcons = mBTAssets, studioIcons = mBTAssets, trashIcons = mBTAssets;

/* --- 5. Production Presets (Industry standard stage ratios) --- */
    const STAGE_PRESETS = {
        'TVC': { 'dev': 10, 'pre': 25, 'prod': 15, 'post': 35, 'dist': 15 },
        'Music Video': { 'dev': 10, 'pre': 20, 'prod': 15, 'post': 40, 'dist': 15 },
        'Documentary': { 'dev': 20, 'pre': 15, 'prod': 35, 'post': 20, 'dist': 10 },
        'Feature Film': { 'dev': 25, 'pre': 20, 'prod': 20, 'post': 25, 'dist': 10 }
    };

/* --- 6. Budget Templates (Industry Standard Structures) --- */
    const BUDGET_TEMPLATES = {
        'Commercial': {
            icon: 'film',
            label: 'TV Commercial',
            desc: 'Standard TVC structure. High-end crew, talent fees, and heavy post-production.',
            structure: [
                { id: 'atl', name: 'Above The Line', items: ['Director', 'Producer', 'Copywriter (Pitch/Treatment)', 'Casting Director'] },
                { id: 'prod', name: 'Production', items: ['Director of Photography (DP)', 'Camera Operator', 'Gaffer', 'Key Grip', 'Sound Mixer', 'Makeup Artist (Key)', 'Production Designer', 'Wardrobe Stylist'] },
                { id: 'post', name: 'Post-Production', items: ['Editor', 'Colorist', 'VFX Artist', 'Sound Designer', 'Music Supervisor'] },
                { id: 'other', name: 'Logistics & Talent', items: ['Cast - Lead', 'Location Manager', 'Catering (Per Head)', 'Equipment Rental', 'Insurance'] }
            ]
        },
        'Documentary': {
            icon: 'camera',
            label: 'Documentary',
            desc: 'Run-and-gun optimized. Prioritizes travel, field logistics, research, and archival licensing.',
            structure: [
                { id: 'atl', name: 'Creative & Research', items: ['Director', 'Producer', 'Researcher', 'Subject Consultant'] },
                { id: 'prod', name: 'Field Production', items: ['Director of Photography (DP)', 'Sound Mixer', 'Fixer/Local Producer', 'Drone Operator'] },
                { id: 'travel', name: 'Travel & Logistics', items: ['Flights', 'Accommodation', 'Per Diems', 'Vehicle Rental', 'Carnets/Visas'] },
                { id: 'post', name: 'Post & Archive', items: ['Editor', 'Transcription', 'Archival Researcher', 'Archival Licensing', 'Colorist'] }
            ]
        },
        'Live Stream': {
            icon: 'zap',
            label: 'Live Broadcast',
            desc: 'Multi-cam setup. Focus on bandwidth redundancy, switching hardware, and technical operators.',
            structure: [
                { id: 'tech', name: 'Technical Crew', items: ['Technical Director', 'Stream Technician', 'Camera Operator', 'Camera Operator', 'Sound Mixer', 'Graphics Op'] },
                { id: 'gear', name: 'Hardware & Rigging', items: ['Switcher/Encoder', 'Cameras (3-Cam Kit)', 'Comms System', 'Bonded Cellular', 'Lighting Package'] },
                { id: 'conn', name: 'Connectivity', items: ['Dedicated Internet Line', '4G/5G Backup Data', 'IT Support'] },
                { id: 'other', name: 'Venue & Logistics', items: ['Venue Power Fee', 'Rigging', 'Crew Meals', 'Transport'] }
            ]
        }
    };
    
    // --- MASTER NAMESPACE (Tier 1 Hoist) ---
    // Logic Resolution: Establishing the root namespace early to allow Tiers 2-6 to attach modules safely.
    window.mBT = {
        config: { version: APP_VERSION },
        core: {},    // Tier 1 (Kernel)
        data: {},    // Tier 2
        logic: {},   // Tier 3
        ui: {},      // Tier 4
        features: {} // Tier 5
    };

    /* ========= v19.65 TIER 1.5: THE KERNEL (mBTCore) ========= */
    // Logic Resolution: Central Event Bus and Initialization Handler
    mBT.core = {
        // Pub/Sub Event Bus
        events: {
            listeners: {},
            on(event, callback) {
                if (!this.listeners[event]) this.listeners[event] = [];
                this.listeners[event].push(callback);
            },
            emit(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(cb => cb(data));
                }
            },
            off(event, callback) {
                if (!this.listeners[event]) return;
                this.listeners[event] = this.listeners[event].filter(cb => cb !== callback);
            }
        },

        // --- NEW: Action Registry (The Nervous System) ---
        actions: {},
        
        // Register an action (e.g., core.action('save', () => ...))
        action(name, fn) { this.actions[name] = fn; },

        // Router: Finds the closest action and executes it
        route(e) {
            // 1. Find the trigger
            const el = e.target.closest('[data-action]');
            if (!el) return false;
            
            // 2. Match the action
            const actionName = el.dataset.action;
            const handler = this.actions[actionName];
            
            // 3. Execute
            if (handler) {
                // Prevent default for clicks to stop form submissions or link jumps, 
                // but allow 'change' events to propagate if needed.
                if (e.type === 'click' || e.type === 'submit') e.preventDefault();
                handler(e, el); 
                return true; 
            }
            return false;
        },
        
        // System Bootstrap (Migration from Tier 6)
        async init() {
            console.log("mBTCore: Boot Sequence Initiated.");

            // 1. Establish The Reactive Loop
            // Logic Resolution: The UI now listens to the Kernel, not the Data directly.
            this.events.on('budget:updated', () => {
                if (mBT.ui && typeof mBT.ui.refresh === 'function') {
                    mBT.ui.refresh();
                }
            });

            // 2. Document Identity
            document.title = `mooBudgetTool v${APP_VERSION}`;
            
            // 3. State Hydration
            displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
            
            // 4. Brain Handshake
            if (typeof fetchExchangeRates === 'function') fetchExchangeRates();
            if (typeof injectFooterIcons === 'function') injectFooterIcons();
            
            // 5. Persistence Recovery (ASYNC UPGRADE)
            let projectToLoad = localStorage.getItem(`${storageKeyPrefix}lastLoaded`);
            
            // Logic Resolution: Await the project list from Async Storage
            let projectList = [];
            if (typeof getProjectList === 'function') {
                try {
                    const result = getProjectList();
                    // Support both Promise (Tier 2) and Array (Legacy)
                    projectList = result instanceof Promise ? await result : result;
                } catch (e) { 
                    console.warn("Project list unavailable:", e); 
                    projectList = [];
                }
            }
            
            if (!projectToLoad || !projectList.includes(projectToLoad)) {
                projectToLoad = projectList.length > 0 ? projectList[0] : null;
            }
            
            // 6. Structural Resolution
            try {
                if (!projectToLoad) {
                    if (typeof handleNewProject === 'function') {
                        const res = handleNewProject(false);
                        if(res instanceof Promise) await res;
                    }
                } else {
                    if (typeof loadBudget === 'function') {
                        const res = loadBudget(projectToLoad);
                        if(res instanceof Promise) await res;
                    }
                }
            } catch (bootErr) {
                console.error("Boot Critical Failure:", bootErr);
                // Emergency Recovery
                if(typeof mBT.data.newProject === 'function') await mBT.data.newProject(true);
            }
            
            // 7. UI Ignition
            // Logic Resolution: We trigger the first render via the Event Bus
            if (typeof bindAppEventListeners === 'function') bindAppEventListeners();
            
            this.events.emit('budget:updated');
            console.log(`Studio Core v${APP_VERSION} Synchronized via mBTCore.`);
        }
    };
    console.log("Script parsing started");



/* ========= v19.55 TIER 2: State Proxy & Storage Engine ========= */

    /* --- 1. mBT.data: THE MODEL (Unified Data Architecture) --- */
    mBT.data = {
        // --- A. State Governor (Reactivity) ---
        state: {
            _timer: null,      // Fast Timer: Math & UI
            _saveTimer: null,  // Slow Timer: Storage
            _isInitialLoad: true,
            _subscribers: [], 
            subscribe: function(callback) { this._subscribers.push(callback); },
            handler: {
                set(target, prop, value) {
                    if (target[prop] === value) return true; 
                    target[prop] = value;
                    if (!mBT.data.state._isInitialLoad) mBT.data.state.requestReconciliation();
                    return true;
                }
            },
            requestReconciliation() {
                // Stream A: Logic & Visuals (Fast Debounce)
                clearTimeout(this._timer);
                this._timer = setTimeout(() => {
                    if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
                    mBT.core.events.emit('budget:updated');
                    this._subscribers.forEach(cb => { try { cb(budget); } catch(e) {} });
                }, 50);

                // Stream B: Persistence (Slow Debounce - ASYNC)
                clearTimeout(this._saveTimer);
                this._saveTimer = setTimeout(async () => {
                    await mBT.data.save(); 
                    const statusMsg = document.getElementById('statusBarMessage');
                    if (statusMsg) {
                        const originalText = statusMsg.textContent;
                        statusMsg.textContent = "Saved to disk.";
                        setTimeout(() => statusMsg.textContent = originalText, 2000);
                    }
                }, 1000);
            },
            wrap: function(data) {
                this._isInitialLoad = true;
                const proxied = new Proxy(data, this.handler);
                this._isInitialLoad = false;
                return proxied;
            }
        },
        
        // --- C. Template Manager (Formerly mBTDBM) ---
        // Logic Resolution: Manages custom user budget templates.
        templates: {
             getTemplates: function() {
                const defaults = {
                    'Commercial': { items: [{ description: 'Director', rate: 1500, unit: 'Day' }, { description: 'DOP', rate: 1200, unit: 'Day' }] },
                    'Music Video': { items: [{ description: 'Director', rate: 800, unit: 'Day' }, { description: 'Editor', rate: 600, unit: 'Flat' }] }
                };
                const stored = JSON.parse(localStorage.getItem('mBT_templates') || '{}');
                return { ...defaults, ...stored };
            },
            saveTemplate: function(name, items) {
                const custom = JSON.parse(localStorage.getItem('mBT_templates') || '{}');
                custom[name] = { items: items };
                localStorage.setItem('mBT_templates', JSON.stringify(custom));
            },
            deleteTemplate: function(name) {
                if(['Commercial', 'Music Video'].includes(name)) return alert('Cannot delete default templates.');
                const custom = JSON.parse(localStorage.getItem('mBT_templates') || '{}');
                delete custom[name];
                localStorage.setItem('mBT_templates', JSON.stringify(custom));
                return true;
            },
            renderTemplateOptions: function(selected) {
                return Object.keys(this.getTemplates()).map(k => 
                    `<option value="${k}" ${k === selected ? 'selected' : ''}>${k}</option>`
                ).join('');
            }
        },
        
        // --- STORAGE & PERSISTENCE (ASYNC UPGRADE) ---
        // Logic Resolution: Swapped synchronous localStorage for Async localForage to unblock UI thread.
        storage: {
            async save(key, data) { await localforage.setItem(key, data); },
            async load(key) { return await localforage.getItem(key); },
            async remove(key) { await localforage.removeItem(key); },
            async keys() { return await localforage.keys(); }
        },

        async save() {
            if (!budget) return;
            const projectKey = storageKeyPrefix + budget.projectName;
            
            // Fix: Strip Proxy before saving to IndexedDB (Prevent "could not be cloned" error)
            // We use JSON parse/stringify to create a clean deep copy free of Proxy traps.
            // This ensures strict serialization for the database while keeping the app reactive.
            try {
                const cleanData = JSON.parse(JSON.stringify(budget));
                await this.storage.save(projectKey, cleanData);
                localStorage.setItem(`${storageKeyPrefix}lastLoaded`, budget.projectName);
            } catch (e) {
                console.error("Save Failed:", e);
                // Fallback: If JSON fails (e.g. circular refs), try basic object copy
                const fallbackData = { ...budget };
                await this.storage.save(projectKey, fallbackData);
            }
        },

        async load(projectName) {
            const projectKey = storageKeyPrefix + projectName;
            let data = await this.storage.load(projectKey);

            // Lazy Migration Logic: If not in Forage, check Local and upgrade
            if (!data) {
                const raw = localStorage.getItem(projectKey);
                if (raw) {
                    try {
                        data = JSON.parse(raw);
                        await this.storage.save(projectKey, data); // Upgrade
                        console.log(`Migrated ${projectName} to Async Storage`);
                    } catch(e) { console.error("Migration failed", e); }
                }
            }

            if (data) {
                budget = mBT.data.state.wrap(data);
                currentProjectName = budget.projectName;
                if(typeof render === 'function') render();
                if(typeof renderProjectManagement === 'function') renderProjectManagement();
            }
        },

        async getList() {
            const fKeys = await this.storage.keys();
            const lKeys = Object.keys(localStorage);
            const combined = new Set([...fKeys, ...lKeys]);
            
            return Array.from(combined)
                .filter(k => k.startsWith(storageKeyPrefix) && 
                    !k.includes('_trash') && 
                    !k.includes('_globalItems') && 
                    !k.includes('_templates') && 
                    !k.endsWith('currency') && 
                    !k.endsWith('rates') && 
                    !k.endsWith('lastLoaded') &&
                    !k.endsWith('ApiKey') && 
                    !k.endsWith('selectedAiProvider') &&
                    !k.endsWith('projectDateFormat') && 
                    !k.endsWith('projectNameSeparator')
                )
                .map(k => k.replace(storageKeyPrefix, ''));
        },
        
        newProject: async function(force = false, type = 'Commercial') {
            try {
                if (force && !confirm("Create new budget?")) return;
                
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                
                const dateFmt = localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD';
                const dateStr = dateFmt === 'MMDDYYYY' ? `${mm}${dd}${yyyy}` : `${yyyy}${mm}${dd}`;
                
                const storedSep = localStorage.getItem(projectNameSeparatorKey);
                const sep = storedSep !== null ? storedSep : ' ';
                
                // --- TEMPLATE RESOLUTION ENGINE ---
                let sections = {};
                let baseLabel = "Project";

                // 1. Check System Templates (Tier 1)
                if (typeof BUDGET_TEMPLATES !== 'undefined' && BUDGET_TEMPLATES[type]) {
                    const tmpl = BUDGET_TEMPLATES[type];
                    baseLabel = tmpl.label;
                    
                    // Logic Upgrade: Hydrate rates from Open Gate Database
                    const rateDb = (typeof mBT.opengate !== 'undefined' && mBT.opengate.rates) ? mBT.opengate.rates : [];

                    tmpl.structure.forEach(s => {
                        sections[s.name] = {
                            id: s.id,
                            isOpen: true,
                            items: s.items.map((desc, idx) => {
                                // Find matching rate in database (Safe Access)
                                const match = rateDb.find(r => r && r.description && desc && r.description.toLowerCase() === desc.toLowerCase());
                                return {
                                    id: `item_${Date.now()}_${idx}_${Math.floor(Math.random()*1000)}`,
                                    description: desc,
                                    quantity: 1,
                                    unit: match ? match.unit : 'Day',
                                    rate: match ? match.rate : 0, // Auto-fill rate if found
                                    multiplier: 1,
                                    actual: 0,
                                    rateType: 'negotiable',
                                    crew: {}
                                };
                            })
                        };
                    });
                } 
                // 2. Check User Templates (Tier 2 Custom)
                else if (mBT.data.templates.getTemplates()[type]) {
                    const customTmpl = mBT.data.templates.getTemplates()[type];
                    baseLabel = type;
                    
                    if (customTmpl.structure) {
                        // Handle Blueprint Structure
                        customTmpl.structure.forEach(s => {
                            sections[s.name] = {
                                id: s.id,
                                isOpen: true,
                                items: s.items.map((i, idx) => ({
                                    id: `item_${Date.now()}_${idx}_${Math.floor(Math.random()*1000)}`,
                                    ...i,
                                    quantity: 1, multiplier: 1, actual: 0, crew: {}
                                }))
                            };
                        });
                    } else {
                        // Legacy Flat List Fallback
                        sections['Production'] = { 
                            id: 'prod', 
                            isOpen: true, 
                            items: customTmpl.items ? customTmpl.items.map((i, idx) => ({
                                id: `item_${Date.now()}_${idx}`,
                                ...i,
                                quantity: 1, multiplier: 1, actual: 0, crew: {}
                            })) : [] 
                        };
                        // Add standard headers
                        sections['Above The Line'] = { id: 'atl', isOpen: true, items: [] };
                        sections['Post-Production'] = { id: 'post', isOpen: true, items: [] };
                    }
                }
                // 3. Fallback Default
                else {
                    sections = {
                        'Above The Line': { id: 'atl', isOpen: true, items: [] },
                        'Production': { id: 'prod', isOpen: true, items: [] },
                        'Post-Production': { id: 'post', isOpen: true, items: [] },
                        'Other': { id: 'other', isOpen: true, items: [] }
                    };
                }

                // --- COLLISION DETECTION (Tier 2 Logic Injection) ---
                // Fix: Prevent Zombie Logic overwrite by checking existence before saving
                let proposedName = `${baseLabel}${sep}${dateStr}`;
                let uniqueName = proposedName;
                let counter = 1;
                
                // Check Async Storage (Primary) and LocalStorage (Legacy) for collision
                while (
                    (await this.storage.load(storageKeyPrefix + uniqueName)) || 
                    localStorage.getItem(storageKeyPrefix + uniqueName)
                ) {
                    uniqueName = `${proposedName}_${counter}`;
                    counter++;
                }

                const newBudget = {
                    projectName: uniqueName,
                    company: "Independent",
                    startDate: new Date().toISOString().split('T')[0],
                    sections: sections,
                    grandTotal: 0,
                    subtotal: 0,
                    actualTotal: 0,
                    contingencyPercentage: 10,
                    salesTaxPercentage: 0,
                    discountPercentage: 0,
                    documents: [],
                    attachments: [],
                    aiContext: { chat: [], analysis: "" }
                };
                
                budget = mBT.data.state.wrap(newBudget);
                currentProjectName = budget.projectName;
                await this.save();
                if(typeof render === 'function') render();
                // Fix: Trigger UI Refresh for Project Selector
                if(typeof renderProjectManagement === 'function') await renderProjectManagement();
                
                // Set the value of the dropdown to the new project
                const projectSelect = document.getElementById('projectSelect');
                if (projectSelect) {
                    projectSelect.value = uniqueName;
                }
            } catch (err) {
                console.error("Critical Failure in New Project Logic:", err);
                alert("Could not create project. Check console for details: " + err.message);
            }
        },
        
        duplicate: async function() {
            if(!budget) return;
            const copy = JSON.parse(JSON.stringify(budget));
            copy.projectName = copy.projectName + " (Copy)";
            budget = mBT.data.state.wrap(copy);
            await this.save();
            if(typeof render === 'function') render();
        },
        
        deleteProject: async function(name) {
             if (confirm(`Move "${name}" to Bin?`)) {
                // Async Load before trash
                let data = await this.storage.load(storageKeyPrefix + name);
                if(!data) {
                    const raw = localStorage.getItem(storageKeyPrefix + name);
                    if(raw) data = JSON.parse(raw);
                }

                if(data) {
                    const trashed = JSON.parse(localStorage.getItem(trashKey) || '[]');
                    trashed.push(data);
                    localStorage.setItem(trashKey, JSON.stringify(trashed));
                }
                
                await this.storage.remove(storageKeyPrefix + name);
                localStorage.removeItem(storageKeyPrefix + name); // Clean legacy

                const list = await this.getList();
                if (list.length) await this.load(list[0]); else await this.newProject();
                if(typeof renderProjectManagement === 'function') renderProjectManagement();
            }
        },
        
        importFile: function(input) {
             const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.projectName) throw new Error("Invalid file structure");
                    
                    const projectKey = storageKeyPrefix + data.projectName;
                    const existing = await this.storage.load(projectKey) || localStorage.getItem(projectKey);
                    
                    if (existing && !confirm(`Overwrite existing project "${data.projectName}"?`)) { input.value = ''; return; }
                    budget = mBT.data.state.wrap(data);
                    await this.save();
                    await this.load(data.projectName);
                    if(typeof renderProjectManagement === 'function') renderProjectManagement();
                    alert("Project environment restored.");
                } catch (err) { alert("Import failed: " + err.message); }
                input.value = '';
            };
            reader.readAsText(file);
        },
        
         pushHistory: function(desc) {
            historyStack = historyStack.slice(0, historyIndex + 1);
            historyStack.push({ description: desc, budget: JSON.parse(JSON.stringify(budget)) });
            if (historyStack.length > MAX_HISTORY) historyStack.shift();
            historyIndex = historyStack.length - 1;
            if(typeof renderStatusBar === 'function') renderStatusBar();
        }
    };

    /* ========= v19.55 TIER 2.5: OPEN GATE INFRASTRUCTURE (mBT.opengate) ========= */
    mBT.opengate = {
        settings: {
            optInSharing: JSON.parse(localStorage.getItem('moo_og_share') || 'false'),
            location: localStorage.getItem('moo_og_loc') || 'Jamaica'
        },
        rates: [], 
        contacts: [], 
        templates: [], // Document Definitions (Studio Builder)

        init() {
            this.loadRates();
            this.loadContacts();
            this.loadTemplates();
            console.log(`Open Gate Initialized: ${this.rates.length} rates, ${this.contacts.length} contacts.`);
        },

        loadRates() {
            const stored = JSON.parse(localStorage.getItem('prodBudget_v5_globalItems') || '[]');
            this.rates.length = 0; 
            if (stored.length === 0) {
                this.rates.push(...this._getJamaicaDatabase());
                this.saveRates();
            } else {
                this.rates.push(...stored);
            }
        },

        loadContacts() { 
            const c = JSON.parse(localStorage.getItem('moo_contacts') || '[]');
            this.contacts.length = 0; 
            this.contacts.push(...c);
        },

        // --- PERSISTENCE LAYER ---
        saveRates() { localStorage.setItem('prodBudget_v5_globalItems', JSON.stringify(this.rates)); },
        saveContacts() { localStorage.setItem('moo_contacts', JSON.stringify(this.contacts)); },

        // --- NON-TRUNCATABLE TEMPLATE REGISTRY (Documents) ---
        loadTemplates() {
            const t = [
                { id: 'script', cat: 'Pre-Prod', label: 'Script', icon: '', default: true },
                { id: 'treatment', cat: 'Pre-Prod', label: 'Story Treatment', icon: '', default: false },
                { id: 'breakdown', cat: 'Pre-Prod', label: 'Script Breakdowns', icon: '', default: true },
                { id: 'shotlist', cat: 'Pre-Prod', label: 'Shot Lists', icon: '', default: true },
                { id: 'storyboard', cat: 'Pre-Prod', label: 'Storyboards', icon: '', default: false },
                { id: 'preCheck', cat: 'Pre-Prod', label: 'Pre-Prod Checklist', icon: '', default: true },
                { id: 'charProf', cat: 'Pre-Prod', label: 'Character Profiles', icon: '', default: false },
                { id: 'casting', cat: 'Pre-Prod', label: 'Casting Sheets', icon: '', default: false },
                { id: 'dood', cat: 'Pre-Prod', label: 'Day Out of Days', icon: '', default: false },
                { id: 'stripboard', cat: 'Pre-Prod', label: 'Stripboard Schedule', icon: '', default: false },
                { id: 'techScout', cat: 'Pre-Prod', label: 'Tech Scout Report', icon: '', default: false },
                { id: 'budgetRep', cat: 'Pre-Prod', label: 'Budget/Cost Report', icon: '', default: true },
                { id: 'vendorBid', cat: 'Pre-Prod', label: 'Vendor Bid Comparison', icon: '', default: false },
                { id: 'pitchDeck', cat: 'Pre-Prod', label: 'Funding Pitch Deck', icon: '', default: false },
                { id: 'callSheet', cat: 'Production', label: 'Daily Call Sheet', icon: '', default: true },
                { id: 'prodReport', cat: 'Production', label: 'Production Report', icon: '', default: true },
                { id: 'continuity', cat: 'Production', label: 'Continuity/Sound Log', icon: '', default: false },
                { id: 'muahCont', cat: 'Production', label: 'Hair/Makeup Continuity', icon: '', default: false },
                { id: 'propList', cat: 'Production', label: 'Prop List', icon: '', default: false },
                { id: 'crewList', cat: 'Production', label: 'Crew Contact List', icon: '', default: true },
                { id: 'transport', cat: 'Production', label: 'Transport Schedule', icon: '', default: false },
                { id: 'catering', cat: 'Production', label: 'Catering/Meal Tracker', icon: '', default: false },
                { id: 'pettyCash', cat: 'Production', label: 'Petty Cash Log', icon: '', default: false },
                { id: 'po', cat: 'Production', label: 'Purchase Order', icon: '', default: false },
                { id: 'timecard', cat: 'Production', label: 'Timecards', icon: '', default: false },
                { id: 'riskAI', cat: 'Production', label: 'AI Risk Assessment', icon: '', default: false },
                { id: 'carbon', cat: 'Production', label: 'Carbon Calculator', icon: '', default: false },
                { id: 'vfxBreak', cat: 'Post-Prod', label: 'VFX Breakdown', icon: '', default: false },
                { id: 'postSched', cat: 'Post-Prod', label: 'Post Schedule', icon: '', default: true },
                { id: 'delivery', cat: 'Post-Prod', label: 'Delivery Schedule', icon: '', default: false },
                { id: 'festTrack', cat: 'Post-Prod', label: 'Festival Tracker', icon: '', default: false },
                { id: 'talentAgr', cat: 'Legal', label: 'Talent Agreement', icon: '', default: true },
                { id: 'locRel', cat: 'Legal', label: 'Location Release', icon: '', default: true },
                { id: 'kitRental', cat: 'Legal', label: 'Kit Rental Agreement', icon: '', default: false },
                { id: 'permit', cat: 'Legal', label: 'Filming Permit', icon: '', default: false },
                { id: 'insurance', cat: 'Legal', label: 'Insurance Cert', icon: '', default: false },
                { id: 'dealMemo', cat: 'Legal', label: 'Crew Deal Memo', icon: '', default: false },
                { id: 'covid', cat: 'Legal', label: 'COVID Protocols', icon: '', default: false },
                { id: 'sag', cat: 'Legal', label: 'SAG-AFTRA Paperwork', icon: '', default: false }
            ];
            this.templates.length = 0; 
            this.templates.push(...t);
        },

        // --- INTELLIGENT INGESTION ENGINE ---
        ingest(items, type = 'rate') {
            let added = 0;
            
            // PATH A: Rate Ingestion
            if (type === 'rate') {
                const existing = new Set(this.rates.map(i => i.description.toLowerCase()));
                items.forEach(i => {
                    if (!existing.has(i.description.toLowerCase())) {
                        this.rates.push({ description: i.description, unit: i.unit || 'Day', rate: parseFloat(i.rate) || 0 });
                        added++;
                    }
                });
                if (added > 0) this.saveRates();
            } 
            
            // PATH B: Contact Ingestion
            else if (type === 'contact') {
                const existing = new Set(this.contacts.map(c => `${c.name}|${c.role}`.toLowerCase()));
                items.forEach(i => {
                    // Normalize Inputs: Handles variations in CSV headers (case insensitive)
                    const name = (i.Name || i.name || '').trim();
                    const role = (i.Role || i.role || 'Crew').trim();
                    const phone = (i.Phone || i.phone || '').trim();
                    const email = (i.Email || i.email || '').trim();
                    const contactStr = phone || email; // Legacy fallback

                    if (!name) return; // Skip empty rows

                    const key = `${name}|${role}`.toLowerCase();
                    if (!existing.has(key)) {
                        this.contacts.push({
                            id: 'c_' + Date.now() + '_' + Math.floor(Math.random() * 1000),
                            name: name,
                            role: role,
                            phone: phone,
                            email: email,
                            contact: contactStr
                        });
                        existing.add(key);
                        added++;
                    }
                });
                if (added > 0) this.saveContacts();
            }
            return added;
        },

        // --- NON-TRUNCATABLE JAMAICA 2025 DATABASE ---
        _getJamaicaDatabase() {
            return [
                { description: 'Storyboard Artist', unit: 'Day', rate: 45000 },
                { description: 'Copywriter (Pitch/Treatment)', unit: 'Flat', rate: 75000 },
                { description: 'Script Consultant / Doctor', unit: 'Flat', rate: 150000 },
                { description: 'Pitch Deck Designer', unit: 'Flat', rate: 120000 },
                { description: 'Researcher', unit: 'Day', rate: 25000 },
                { description: 'Concept Artist', unit: 'Day', rate: 40000 },
                { description: 'Legal - Rights & Clearances', unit: 'Flat', rate: 250000 },
                { description: 'Director', unit: 'Day', rate: 85000 },
                { description: 'Executive Producer', unit: 'Flat', rate: 500000 },
                { description: 'Producer', unit: 'Day', rate: 75000 },
                { description: 'Line Producer', unit: 'Day', rate: 65000 },
                { description: 'Screenwriter', unit: 'Flat', rate: 350000 },
                { description: 'Cast - Lead', unit: 'Day', rate: 100000 },
                { description: 'Cast - Supporting', unit: 'Day', rate: 50000 },
                { description: 'Stunt Coordinator', unit: 'Day', rate: 60000 },
                { description: 'Unit Production Manager (UPM)', unit: 'Day', rate: 60000 },
                { description: 'Production Coordinator', unit: 'Day', rate: 30000 },
                { description: '1st Assistant Director (1st AD)', unit: 'Day', rate: 65000 },
                { description: '2nd Assistant Director', unit: 'Day', rate: 45000 },
                { description: '2nd 2nd AD', unit: 'Day', rate: 25000 },
                { description: 'Key PA', unit: 'Day', rate: 20000 },
                { description: 'Set PA', unit: 'Day', rate: 15000 },
                { description: 'Office PA', unit: 'Day', rate: 15000 },
                { description: 'Truck PA', unit: 'Day', rate: 18000 },
                { description: 'Location Manager', unit: 'Day', rate: 50000 },
                { description: 'Location Scout', unit: 'Day', rate: 35000 },
                { description: 'Script Supervisor', unit: 'Day', rate: 40000 },
                { description: 'Medic / Set Nurse', unit: 'Day', rate: 35000 },
                { description: 'Security Guard', unit: 'Day', rate: 12000 },
                { description: 'Craft Service', unit: 'Day', rate: 25000 },
                { description: 'Catering (Per Head)', unit: 'Flat', rate: 2500 },
                { description: 'Director of Photography (DP)', unit: 'Day', rate: 90000 },
                { description: 'Camera Operator', unit: 'Day', rate: 60000 },
                { description: '1st Assistant Camera (Focus)', unit: 'Day', rate: 45000 },
                { description: '2nd Assistant Camera', unit: 'Day', rate: 35000 },
                { description: 'Digital Imaging Tech (DIT)', unit: 'Day', rate: 50000 },
                { description: 'Steadicam Operator', unit: 'Day', rate: 70000 },
                { description: 'Drone Operator', unit: 'Day', rate: 55000 },
                { description: 'Camera Utility', unit: 'Day', rate: 25000 },
                { description: 'Gaffer', unit: 'Day', rate: 55000 },
                { description: 'Best Boy Electric', unit: 'Day', rate: 40000 },
                { description: 'Electrician', unit: 'Day', rate: 30000 },
                { description: 'Key Grip', unit: 'Day', rate: 50000 },
                { description: 'Best Boy Grip', unit: 'Day', rate: 40000 },
                { description: 'Dolly Grip', unit: 'Day', rate: 40000 },
                { description: 'Grip', unit: 'Day', rate: 30000 },
                { description: 'Generator Operator', unit: 'Day', rate: 35000 },
                { description: 'Sound Mixer', unit: 'Day', rate: 50000 },
                { description: 'Boom Operator', unit: 'Day', rate: 35000 },
                { description: 'Sound Utility', unit: 'Day', rate: 25000 },
                { description: 'Production Designer', unit: 'Day', rate: 65000 },
                { description: 'Art Director', unit: 'Day', rate: 50000 },
                { description: 'Set Decorator', unit: 'Day', rate: 45000 },
                { description: 'Set Dresser', unit: 'Day', rate: 30000 },
                { description: 'Props Master', unit: 'Day', rate: 45000 },
                { description: 'Assistant Props', unit: 'Day', rate: 30000 },
                { description: 'Costume Designer', unit: 'Day', rate: 55000 },
                { description: 'Wardrobe Stylist', unit: 'Day', rate: 45000 },
                { description: 'Wardrobe Assistant', unit: 'Day', rate: 25000 },
                { description: 'Makeup Artist (Key)', unit: 'Day', rate: 45000 },
                { description: 'Hair Stylist (Key)', unit: 'Day', rate: 45000 },
                { description: 'Makeup/Hair Assistant', unit: 'Day', rate: 25000 },
                { description: 'Post-Production Supervisor', unit: 'Week', rate: 200000 },
                { description: 'Editor', unit: 'Day', rate: 50000 },
                { description: 'Assistant Editor (AE)', unit: 'Day', rate: 25000 },
                { description: 'Colorist', unit: 'Hour', rate: 15000 },
                { description: 'VFX Supervisor', unit: 'Day', rate: 70000 },
                { description: 'VFX Artist', unit: 'Day', rate: 55000 },
                { description: 'Sound Designer', unit: 'Flat', rate: 150000 },
                { description: 'Composer', unit: 'Flat', rate: 200000 },
                { description: 'Music Supervisor', unit: 'Flat', rate: 100000 }
            ];
        }
    };

    // --- 4. BACKWARD COMPATIBILITY ALIASES (The Bridge) ---
    // Logic Resolution: Ensures all existing calls in Tier 3-6 continue to function.
    window.mBTState = mBT.data.state;
    window.mBTStorage = mBT.data.storage;
    window.saveBudget = mBT.data.save.bind(mBT.data);
    window.loadBudget = mBT.data.load.bind(mBT.data);
    window.handleNewProject = mBT.data.newProject.bind(mBT.data);
    window.handleDuplicateProject = mBT.data.duplicate.bind(mBT.data);
    window.deleteProject = mBT.data.deleteProject.bind(mBT.data);
    window.handleImportFile = mBT.data.importFile.bind(mBT.data);
    window.getProjectList = mBT.data.getList.bind(mBT.data);
    window.pushToHistory = mBT.data.pushHistory.bind(mBT.data);
    
    // Initialize Open Gate immediately
    mBT.opengate.init();
    
    // --- 5. Global Aliases for Migrated Globals ---
    window.mBTOG = mBT.opengate; // OPEN GATE Alias
    window.mBTDBM = mBT.data.templates; // Database Manager (Templates)

/* ================= v19.54 TIER 3: Core Logic Engines v19.55 ================= */

    // ... (Keep fetchExchangeRates and Mathematical Utilities) ...

    /* --- 3. Core Calculation Utilities (Restored) --- */
    // Logic Resolution: Essential math helpers required by the UI Render Engine.
    
    function toDisp(val) { return parseFloat(val) || 0; }

    function calculateItem(item) {
        const qty = parseFloat(item.quantity) || 0;
        const rate = parseFloat(item.rate) || 0;
        const mult = parseFloat(item.multiplier) || 1;
        const est = qty * rate * mult;
        const act = parseFloat(item.actual) || 0;
        return { estimated: est, variance: act - est };
    }

    function formatAbbreviated(value, currency = 'JMD') {
        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
        if (value >= 1000) return (value / 1000).toFixed(1) + 'k';
        if (typeof mBTLE !== 'undefined' && mBTLE.format) {
            return mBTLE.format.currency(value, currency);
        }
        return new Intl.NumberFormat('en-JM', { style: 'currency', currency: 'JMD' }).format(value);
    }

    /* ========= mBT.logic: CORE INTELLIGENCE (Math & Metrics) ========= */
    mBT.logic = {
        // ... (Keep existing math and stages) ...
        math: {
            config: {
                currencies: {
                    'JMD': { locale: 'en-JM', symbol: 'JMD$', rate: 1 },
                    'USD': { locale: 'en-US', symbol: '$', rate: 1 },
                    'GBP': { locale: 'en-GB', symbol: '', rate: 1 },
                    'CAD': { locale: 'en-CA', symbol: 'CA$', rate: 1 },
                    'EUR': { locale: 'de-DE', symbol: '', rate: 1 }
                }
            },
            format: {
                currency: function(value, code) {
                    const currencyCode = code || displayCurrency || 'JMD';
                    const cfg = mBT.logic.math.config.currencies[currencyCode] || mBT.logic.math.config.currencies['USD'];
                    return new Intl.NumberFormat(cfg.locale, {
                        style: 'currency', currency: currencyCode, currencyDisplay: 'narrowSymbol'
                    }).format(value);
                }
            },
            validate: {
                item: function(item) {
                    item.quantity = Math.max(0, parseFloat(item.quantity) || 0);
                    item.rate = Math.max(0, parseFloat(item.rate) || 0);
                    item.multiplier = Math.max(1, parseFloat(item.multiplier) || 1);
                    return item;
                }
            },
            reconcile: function() {
                // Deficiency 3 Fix: Pure Logic Only. NO DOM MANIPULATION.
                // This function now only updates the 'budget' state object.
                // Visual updates are delegated to mBT.ui.paint() or render().
                
                if (!budget || !budget.sections) return;
                let subtotal = 0; let grandActual = 0;

                Object.keys(budget.sections).forEach(sectionKey => {
                    let sectionEstTotal = 0;
                    const section = budget.sections[sectionKey];
                    section.items.forEach(item => {
                        this.validate.item(item);

                        // --- LOGIC INJECTION: Stage Aggregation ---
                        if (item.stageData && Object.keys(item.stageData).length > 0) {
                            let stageSumCost = 0;
                            let stageSumDays = 0;
                            Object.values(item.stageData).forEach(d => {
                                const dDays = parseFloat(d.days) || 0;
                                const dRate = parseFloat(d.rate) || 0;
                                stageSumCost += (dDays * dRate);
                                stageSumDays += dDays;
                            });
                            
                            item.quantity = stageSumDays;
                            item.total = stageSumCost;
                            item.rate = stageSumDays > 0 ? (stageSumCost / stageSumDays) : 0;
                            if(stageSumDays > 0) item.unit = 'Day'; 
                        } else {
                            const calc = calculateItem(item);
                            item.total = calc.estimated;
                        }

                        sectionEstTotal += item.total;
                        grandActual += parseFloat(item.actual) || 0;
                    });
                    section.total = sectionEstTotal;
                    subtotal += sectionEstTotal;
                });

                const contingency = subtotal * ((budget.contingencyPercentage || 0) / 100);
                const tax = subtotal * ((budget.salesTaxPercentage || 0) / 100);
                const preDiscount = subtotal + contingency + tax;
                const discount = preDiscount * ((budget.discountPercentage || 0) / 100);
                
                budget.subtotal = subtotal;
                budget.grandTotal = preDiscount - discount;
                budget.actualTotal = grandActual;
                // Note: DOM updates removed. Relying on Paint Engine.
            },
            // [DELETED] updateUI() removed from logic layer.
        },

        // --- 2. Stage Metrics (Previously mBTStagesEngine) ---
        stages: {
            // Returns { grandTotal, stageTotals: {dev: $, ...}, totalCap: $ }
            getMetrics: function() {
                const tl = budget.targetLock || { totalCap: 0, stages: {} };
                const result = {
                    grandTotal: 0,
                    stageTotals: { dev: 0, pre: 0, prod: 0, post: 0, dist: 0 },
                    totalCap: tl.totalCap || 0
                };

                Object.values(budget.sections).forEach(sec => {
                    sec.items.forEach(item => {
                        if (item.stageData) {
                            Object.entries(item.stageData).forEach(([key, data]) => {
                                const k = key.toLowerCase();
                                if (result.stageTotals[k] !== undefined) {
                                    const cost = (parseFloat(data.days) || 0) * (parseFloat(data.rate) || 0);
                                    result.stageTotals[k] += cost;
                                    result.grandTotal += cost;
                                }
                            });
                        }
                    });
                });
                return result;
            },

            // Returns Status Object for Ring/Bars
            getBurnStatus: function(current, cap) {
                const pct = cap > 0 ? (current / cap) * 100 : 0;
                if (pct > 100) return { color: 'text-red-600', bg: 'bg-red-500', ring: 'border-red-200', pct };
                if (pct > 85) return { color: 'text-yellow-600', bg: 'bg-blue-500', ring: 'border-yellow-200', pct }; 
                return { color: 'text-green-600', bg: 'bg-green-500', ring: 'border-green-200', pct };
            }
        }
    };

    // --- Aliases for Backward Compatibility ---
    window.mBTLE = mBT.logic.math;
    window.mBTStagesEngine = mBT.logic.stages;

    // [DELETED] mBTOG was here. It has been moved to mBT.data.library.
    // [DELETED] mBTDBM was here. It has been moved to mBT.data.templates.

    /* --- 2. Logic Bridges & Data Normalization --- */
    function recalculateTemplateQuantities(data) {
        if (!data.days) return;
        const { principal, scouting, preprod } = data.days;
        const totalDays = (parseFloat(principal) || 0) + (parseFloat(scouting) || 0) + (parseFloat(preprod) || 0);
        Object.values(data.sections).forEach(section => {
            section.items.forEach(item => { if (item.unit === 'Day') item.quantity = totalDays; });
        });
    }

    // Logic Resolution: Core budget item updater (Restored)
    function handleUpdate(sectionName, itemId, field, value, context) {
        const section = budget.sections[sectionName];
        if (!section) return;
        const item = section.items.find(i => i.id === itemId);
        if (!item) return;

        if (field === 'description') item.description = value;
        else if (field === 'quantity') item.quantity = parseFloat(value) || 0;
        else if (field === 'rate') item.rate = parseFloat(value) || 0;
        else if (field === 'unit') item.unit = value;
        else if (field === 'actual') item.actual = parseFloat(value) || 0;

        // Deficiency 1 Fix: Single-Source of Truth
        // We rely on the Proxy (Tier 2) to trigger Global Math & Persistence (debounced).
        // We ONLY call paint() here for instant, non-blocking visual feedback on the active row.
        if (typeof mBT.ui.paint === 'function') {
            requestAnimationFrame(() => mBT.ui.paint());
        }
    }

    function balanceStageSliders(changedKey, newValue) {
        const stages = budget.targetLock.stages;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        
        newValue = parseFloat(newValue);
        if (isNaN(newValue)) newValue = 0;
        
        const lockedKeys = validKeys.filter(k => k !== changedKey && stages[k].locked);
        const unlockedKeys = validKeys.filter(k => k !== changedKey && !stages[k].locked);
        
        const lockedTotal = lockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
        const maxAvailable = 100 - lockedTotal;
        
        if (newValue > maxAvailable) newValue = maxAvailable;
        if (newValue < 0) newValue = 0;
        
        stages[changedKey].ratio = newValue;
        
        const remaining = Math.max(0, 100 - newValue - lockedTotal);
        
        if (unlockedKeys.length > 0) {
            const currentUnlockedTotal = unlockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
            unlockedKeys.forEach(k => {
                let newRatio;
                if (currentUnlockedTotal <= 0.01) {
                    newRatio = remaining / unlockedKeys.length;
                } else {
                    const share = stages[k].ratio / currentUnlockedTotal;
                    newRatio = remaining * share;
                }
                stages[k].ratio = newRatio;
            });
        }
    }

    // Preset Handler
    window.applyStagePreset = function(presetName) {
        const ratios = STAGE_PRESETS[presetName];
        if (!ratios) return;
        Object.keys(ratios).forEach(k => {
            if (budget.targetLock.stages[k]) {
                budget.targetLock.stages[k].ratio = ratios[k];
                budget.targetLock.stages[k].locked = false;
            }
        });
        if(typeof window.updateAllHeaders === 'function') window.updateAllHeaders();
        if(typeof pushToHistory === 'function') pushToHistory(`Applied ${presetName} preset`);
    };

    const mBTAssign = {
        assignFromContacts() {
            const contacts = (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG.contacts || []));
            if (!contacts.length) return { assigned: 0, message: 'No records found' };
            let assigned = 0;
            Object.values(budget.sections).forEach(s => s.items.forEach(i => {
                if (i.crew?.name) return;
                const match = contacts.find(c => c.role && i.description.toLowerCase().includes(c.role.toLowerCase()));
                if (match) { 
                    i.crew = { name: match.name, phone: match.contact?.includes('@') ? '' : match.contact, email: match.contact?.includes('@') ? match.contact : '' }; 
                    assigned++; 
                }
            }));
            if (assigned > 0) {
                mBTLE.reconcile();
                // Logic Resolution: Auto-Assign modifies complex DOM (Avatars) that Paint() skips.
                // We must trigger a full structural refresh here.
                render(); 
            }
            return { assigned, message: `${assigned} personnel synchronized` };
        }
    };

/* ========= v19.55 CONNECTIVE TISSUE: Logic Resolution Utilities ========= */

    // NOTE: Project Inventory, Data Hydration, and History functions 
    // have been consolidated into mBT.data (Tier 2). 
    // Global aliases maintain compatibility.

    /* --- 3. Configuration & System Utilities (Restored) --- */
    // Logic Resolution: Helpers for global settings accessed by mBT.features.settings
    function getProjectDateFormat() { return localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD'; }
    function getProjectNameSeparator() { return localStorage.getItem(projectNameSeparatorKey) || ' '; }
    function hardResetApp() { 
        if(confirm("Factory Reset: This will clear all local data and reload. Continue?")) {
            localStorage.clear(); 
            window.location.reload(); 
        }
    }

    /* --- 4. Neural Link Bridge (AI API Utilities) --- */
    mBT.features.ai = {
        // Configuration Defaults
        config: {
            // Logic Resolution: Updated to the Preview-compatible model for Canvas environment stability.
            geminiModel: "gemini-2.5-flash-preview-09-2025", 
            openAiModel: "gpt-4o-mini",
            deepSeekModel: "deepseek-chat",
            grokModel: "grok-beta",
            // Logic Resolution: Extremely strict prompt to eliminate "yapping" and force data-first output.
            systemContext: "ROLE: Strict Budget Auditor. MO: Brutal efficiency. No intro/outro fluff. No philosophical advice. OUTPUT: Markdown bullet points only. Start immediately with facts. CONTEXT: Film Production, Jamaica 2025 rates."
        },

        // Storage Accessors
        getStoredApiKey: (provider) => localStorage.getItem(`${storageKeyPrefix}${provider}ApiKey`) || '',
        saveStoredApiKey: (provider, key) => localStorage.setItem(`${storageKeyPrefix}${provider}ApiKey`, key),
        getSelectedProvider: () => localStorage.getItem(`${storageKeyPrefix}selectedAiProvider`) || 'gemini',
        getSystemPrompt: () => localStorage.getItem(`${storageKeyPrefix}aiSystemPrompt`) || '',
        saveSystemPrompt: (val) => localStorage.setItem(`${storageKeyPrefix}aiSystemPrompt`, val),
        
        /**
         * Centralized Intelligence Dispatcher
         * Handles routing to specific providers (Gemini/OpenAI/DeepSeek/Grok) and standardizes the response.
         */
        callUnifiedAI: async function(provider, apiKey, prompt, customSystemMsg = "") {
            // Logic Resolution: Combine base strictness with user-defined constraints
            const userConstraints = this.getSystemPrompt();
            const baseInstruction = customSystemMsg || this.config.systemContext;
            const systemInstruction = userConstraints ? `${baseInstruction} USER CONSTRAINTS: ${userConstraints}` : baseInstruction;

            try {
                // 1. Google Gemini Strategy
                if (provider === 'gemini') {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${this.config.geminiModel}:generateContent?key=${apiKey}`;
                    
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    };

                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(`Gemini Error ${response.status}: ${err.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Assistant: No analysis generated.";
                } 
                
                // 2. OpenAI Compatible Strategy (OpenAI, DeepSeek, Grok)
                else {
                    let url, model;
                    
                    if (provider === 'openai') {
                        url = 'https://api.openai.com/v1/chat/completions';
                        model = this.config.openAiModel;
                    } else if (provider === 'deepseek') {
                        url = 'https://api.deepseek.com/chat/completions';
                        model = this.config.deepSeekModel;
                    } else if (provider === 'grok') {
                        url = 'https://api.x.ai/v1/chat/completions';
                        model = this.config.grokModel;
                    } else {
                        throw new Error(`Provider '${provider}' not supported.`);
                    }

                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "system", content: systemInstruction },
                                { role: "user", content: prompt }
                            ]
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(`${provider.toUpperCase()} Error ${response.status}: ${err.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    return data.choices?.[0]?.message?.content || "Assistant: No analysis generated.";
                }

            } catch (error) {
                console.error("mBT AI Failure:", error);
                return `Analysis Failed: ${error.message}`;
            }
        },

        // Helper: Quick analysis of current budget state (Budget Analysis)
        analyzeCurrentBudget: async function() {
            const provider = this.getSelectedProvider();
            const apiKey = this.getStoredApiKey(provider);
            
            if(!apiKey) return alert("Assistant Offline: Please configure API Key in settings.");
            
            // Logic Resolution: Enhanced Context Gathering (Broad Access)
            // Includes budget numbers, active documents, attached files, and crew status.
            const context = {
                project: budget.projectName,
                total: budget.grandTotal,
                currency: displayCurrency,
                sections: Object.keys(budget.sections).map(k => ({
                    name: k,
                    total: budget.sections[k].total,
                    itemCount: budget.sections[k].items.length
                })),
                documents: (budget.documents || []).map(d => ({ type: d.type, label: d.label })),
                attachments: (budget.attachments || []).map(a => a.name),
                crewSummary: Object.values(budget.sections).reduce((acc, sec) => acc + sec.items.filter(i => i.crew?.name).length, 0) + " assigned",
                previousAnalysis: (budget.aiContext?.analysis || "").substring(0, 1000) // Feedback loop: Awareness of past diagnosis
            };

            const prompt = `Analyze this budget data: ${JSON.stringify(context)}. Review financials, logistics (documents), and staffing. Identify 3 risks and 3 savings opportunities. Be concise.`;
            
            if(mBTME.showLoader) mBTME.showLoader("Neural Analysis in progress...");
            
            const result = await this.callUnifiedAI(provider, apiKey, prompt);
            
            if(mBTME.hideLoader) mBTME.hideLoader();
            
            // Logic Resolution: Save analysis to state so Chat can reference it later
            if(!budget.aiContext) budget.aiContext = { chat: [], analysis: "" };
            budget.aiContext.analysis = result;
            saveBudget();

            // Logic Resolution: Render Markdown properly using 'marked' library
            const formattedResult = (typeof marked !== 'undefined') ? marked.parse(result) : result;
            
            // Logic Resolution: UI Renamed to 'Budget Analysis'
            mBTME.open('aiAnalysis', 'Budget Analysis', `
                <div class="p-6 text-sm leading-relaxed text-slate-700 max-h-[60vh] overflow-y-auto prose prose-sm prose-slate max-w-none">
                    ${formattedResult}
                </div>`, 'max-w-2xl');
        },

        // --- Context Management Utilities ---
        clearContext: function() {
            if(confirm("Clear AI memory and chat history? This cannot be undone.")) {
                budget.aiContext = { chat: [], analysis: "" };
                saveBudget();
                // Refresh the chat view if open
                const history = document.getElementById('aiChatHistory');
                if(history) history.innerHTML = '<div class="text-center text-slate-400 text-xs mt-10">Memory Cleared. Start fresh.</div>';
                const count = document.getElementById('aiMsgCount');
                if(count) count.textContent = "Context: 0 msgs";
            }
        },

        exportChat: function() {
            if(!budget.aiContext?.chat?.length) return alert("No chat history to export.");
            const text = budget.aiContext.chat.map(m => `[${m.role.toUpperCase()}]: ${m.content}`).join('\n\n-------------------\n\n');
            const blob = new Blob([text], { type: 'text/plain' });
            if(typeof mBTPublisher !== 'undefined' && mBTPublisher.io) {
                mBTPublisher.io.forceDownload(blob, `${budget.projectName}_AI_Chat.txt`);
            }
        },

        // Logic Resolution: Restored Chat Interface (Assistant)
        openChat: function() {
            if (!budget.aiContext) budget.aiContext = { chat: [], analysis: "" };
            
            const renderMessages = () => {
                return budget.aiContext.chat.map(msg => {
                    // Logic Resolution: Parse Markdown for AI, strict escape for User
                    const contentHtml = msg.role === 'assistant' 
                        ? (typeof marked !== 'undefined' ? marked.parse(msg.content) : msg.content)
                        : mBT.ui.render.esc(msg.content);
                        
                    return `
                    <div class="ai-message ${msg.role} mb-4 p-3 rounded-lg ${msg.role === 'user' ? 'bg-blue-50 ml-8 text-right' : 'bg-white border border-slate-100 mr-8'}">
                        <strong class="block text-[9px] uppercase tracking-widest text-slate-400 mb-1">${msg.role === 'user' ? 'You' : 'Assistant'}</strong>
                        <div class="text-xs leading-relaxed text-slate-700 prose prose-sm max-w-none ${msg.role === 'user' ? '' : 'prose-headings:text-slate-800 prose-strong:text-slate-900'}">${contentHtml}</div>
                    </div>`;
                }).join('');
            };

            const content = `
                <div class="flex flex-col h-[500px] bg-slate-50">
                    <!-- Chat Toolbar -->
                    <div class="flex justify-between items-center px-4 py-2 bg-white border-b border-slate-100 shrink-0">
                        <span id="aiMsgCount" class="text-[9px] font-black uppercase tracking-widest text-slate-400">Context: ${budget.aiContext.chat.length} msgs</span>
                        <div class="flex gap-2">
                            <button onclick="mBT.features.ai.exportChat()" title="Export Discussion" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all">${mBTAssets.file}</button>
                            <button onclick="mBT.features.ai.clearContext()" title="Clear Memory" class="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all">${mBTAssets.trash}</button>
                        </div>
                    </div>
                    
                    <div id="aiChatHistory" class="flex-grow overflow-y-auto p-4 space-y-2">
                        ${budget.aiContext.chat.length ? renderMessages() : '<div class="text-center text-slate-400 text-xs mt-10">Start a conversation...</div>'}
                    </div>
                    
                    <div class="p-3 bg-white border-t border-slate-100 flex gap-2 shrink-0">
                        <input type="text" id="aiChatInput" class="flex-grow p-3 bg-slate-50 border-none rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-blue-100 transition-all" placeholder="Ask about rates, logistics, or risks..." onkeydown="if(event.key==='Enter') document.getElementById('aiChatSendBtn').click()">
                        <button id="aiChatSendBtn" class="p-3 bg-blue-600 text-white rounded-xl shadow-lg hover:bg-blue-500 transition-all w-12 flex items-center justify-center shrink-0">
                            ${mBTAssets.paperPlane || '->'} 
                        </button>
                    </div>
                </div>`;

            mBTME.open('aiChat', 'Discussions', content, 'max-w-lg', { noPadding: true });

            // Scroll to bottom
            const historyEl = document.getElementById('aiChatHistory');
            if(historyEl) setTimeout(() => historyEl.scrollTop = historyEl.scrollHeight, 10);

            // Attach listener
            setTimeout(() => {
                const btn = document.getElementById('aiChatSendBtn');
                const input = document.getElementById('aiChatInput');
                if(btn && input) {
                    btn.onclick = async () => {
                        const text = input.value.trim();
                        if(!text) return;
                        
                        // Add User Msg
                        budget.aiContext.chat.push({ role: 'user', content: text });
                        saveBudget();
                        input.value = '';
                        
                        // Re-render immediate
                        const history = document.getElementById('aiChatHistory');
                        history.innerHTML = renderMessages() + `<div class="ai-message assistant animate-pulse p-3 bg-white border border-slate-100 mr-8 rounded-lg"><div class="text-xs text-slate-400">Analyzing...</div></div>`;
                        history.scrollTop = history.scrollHeight;
                        
                        const count = document.getElementById('aiMsgCount');
                        if(count) count.textContent = `Context: ${budget.aiContext.chat.length} msgs`;

                        // Call AI
                        const provider = this.getSelectedProvider();
                        const apiKey = this.getStoredApiKey(provider);
                        
                        if(!apiKey) {
                            history.lastElementChild.innerHTML = "<div class='text-rose-500 text-xs'>Error: API Key missing. Check Settings.</div>";
                            return;
                        }

                        // Context Injection: Add rich context including docs, attachments, and previous analysis
                        const docList = (budget.documents || []).map(d => d.label).join(', ');
                        const attachList = (budget.attachments || []).map(a => a.name).join(', ');
                        const prevAnalysis = (budget.aiContext.analysis || "None").substring(0, 500); // Truncate to save tokens
                        
                        // Construct hidden System Context
                        const contextSummary = `[SYSTEM CONTEXT: Project="${budget.projectName}", Total=${displayCurrency} ${budget.grandTotal}, Docs=[${docList}], Attachments=[${attachList}], Last Analysis Summary="${prevAnalysis}"]`;
                        
                        // Only inject context if it's the start of a conversation to save tokens later
                        const finalPrompt = budget.aiContext.chat.length < 2 ? `${contextSummary} \n\n User Query: ${text}` : text;

                        const response = await this.callUnifiedAI(provider, apiKey, finalPrompt);
                        
                        // Update with response
                        budget.aiContext.chat.push({ role: 'assistant', content: response });
                        saveBudget();
                        history.innerHTML = renderMessages();
                        history.scrollTop = history.scrollHeight;
                        if(count) count.textContent = `Context: ${budget.aiContext.chat.length} msgs`;
                    };
                    input.focus();
                }
            }, 50);
        },

        // Logic Resolution: Restored UI Menu for the Dashboard Button
        openTools: function() {
             const provider = this.getSelectedProvider();
            const apiKey = this.getStoredApiKey(provider);
            const statusColor = apiKey ? 'text-emerald-500' : 'text-rose-500';
            const statusText = apiKey ? 'Online' : 'Offline';

            const content = `
                <div class="grid grid-cols-2 gap-4 p-4">
                    <button onclick="mBT.features.ai.analyzeCurrentBudget(); mBTME.close('aiToolsModal');" class="p-4 bg-indigo-50 border border-indigo-200 rounded-2xl flex flex-col items-center gap-2 hover:bg-indigo-100 transition-all group">
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-indigo-500 group-hover:scale-110 transition-all">${mBTAssets.doctor}</div>
                        <div class="text-center">
                            <h4 class="font-black text-[10px] uppercase tracking-widest text-slate-700">Budget Analysis</h4>
                            <p class="text-[8px] text-slate-400 font-bold">Deep Scan</p>
                        </div>
                    </button>

                    <button onclick="mBT.features.ai.openChat(); mBTME.close('aiToolsModal');" class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl flex flex-col items-center gap-2 hover:bg-emerald-100 transition-all group">
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-emerald-500 group-hover:scale-110 transition-all">${mBTAssets.chat}</div>
                        <div class="text-center">
                            <h4 class="font-black text-[10px] uppercase tracking-widest text-slate-700">Discussions</h4>
                            <p class="text-[8px] text-slate-400 font-bold">Chat & Consult</p>
                        </div>
                    </button>
                </div>
                
                <div class="px-4 pb-4">
                    <button onclick="showSettingsModal('ai'); mBTME.close('aiToolsModal');" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl flex items-center justify-between hover:bg-white transition-all group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-400">${mBTAssets.gear}</div>
                            <div class="text-left">
                                <h4 class="font-black text-[9px] uppercase tracking-widest text-slate-700">Configuration</h4>
                                <p class="text-[8px] font-bold ${statusColor} mt-0.5">${statusText}</p>
                            </div>
                        </div>
                        <span class="text-slate-300 group-hover:text-blue-500"></span>
                    </button>
                </div>`;
            
            mBTME.open('aiTools', 'Assistant', content, 'max-w-sm');
        }
    };

    // Logic Resolution: Global Aliases for Backward Compatibility (Preserves Tier 5 Settings UI)
    // Note: Bind 'this' to ensure internal config access works when called globally
    const getStoredApiKey = mBT.features.ai.getStoredApiKey.bind(mBT.features.ai);
    const saveStoredApiKey = mBT.features.ai.saveStoredApiKey.bind(mBT.features.ai);
    const getSelectedProvider = mBT.features.ai.getSelectedProvider.bind(mBT.features.ai);
    const callUnifiedAI = mBT.features.ai.callUnifiedAI.bind(mBT.features.ai);
    // Logic Resolution: Restore global access for the main dashboard button
    window.showAIToolsModal = mBT.features.ai.openTools.bind(mBT.features.ai);

// Logic Resolution: Handles renaming projects.
    function handleProjectNameChange(e) {
        const newName = e.target.value.trim();
        if(!newName) return;
        const oldKey = storageKeyPrefix + budget.projectName;
        const newKey = storageKeyPrefix + newName;
        if(localStorage.getItem(newKey)) {
            alert("Project name already exists.");
            e.target.value = budget.projectName;
            return;
        }
        localStorage.removeItem(oldKey);
        budget.projectName = newName;
        saveBudget();
        currentProjectName = newName;
    }

console.log("TIER 3 complete");


/* ========= v19.54 TIER 4: Atomic Render Pipeline v19.55 ========= */

    // ... (keep getAbbreviatedName function) ...

    /* --- 3. UI Namespace Consolidation --- */
    // Logic Resolution: Moving all UI logic under one roof.
    
    // 2. The Main Render Loop (The Gatekeeper)
    mBT.ui.refresh = function() {
        const app = document.getElementById('app');
        if (!budget || !app) return;

        // Deficiency Fix: Theme Toggle Latency
        // We apply the container classes and styles here, on every cycle.
        // This ensures checking the "Classic Theme" box updates the UI immediately without a reload.
        const isClassic = budget.settings?.classicTheme || false;
        app.className = `max-w-7xl mx-auto px-4 py-8 ${isClassic ? 'classic-theme' : ''}`;
        if(isClassic) document.body.style.backgroundColor = "#e5e5e5";
        else document.body.style.backgroundColor = "#f3f4f6";
        
        // A. Smart Detection: Does the shell exist?
        const shellExists = document.getElementById('projectName') && document.getElementById('budget-sections');
        
        if (!shellExists) {
            // Path 1: Full Rebuild (Initial Load / Hard Reset)
            this._fullRender(app);
        } else {
            // Path 2: Surgical Update
            
            // Sub-check: Has the structure changed? (Row count mismatch)
            // This allows us to handle "Add Item" without a full app flash, but keeps typing fast.
            let dataCount = 0;
            Object.values(budget.sections).forEach(s => dataCount += s.items.length);
            const domCount = document.querySelectorAll('.draggable-row').length;

            if (dataCount !== domCount) {
                // Structural Mismatch: Rebuild only the list container
                const sectionContainer = document.getElementById('budget-sections');
                if(sectionContainer) sectionContainer.innerHTML = renderBudgetSections();
                
                // Re-bind specific list listeners
                if (typeof initializeDragAndDrop === 'function') initializeDragAndDrop();
            }

            // Always Paint values (covers typing, calculations, and the new rows)
            this.paint();
        }
        
        // B. Auxiliary Interface Updates (Top Level)
        if (typeof renderProjectManagement === 'function') renderProjectManagement();
        if (typeof renderStatusBar === 'function') renderStatusBar();
        if (typeof updateOnlineStatus === 'function') updateOnlineStatus(); 
        
        // C. Focus Restoration (Legacy support for structural updates)
        // Note: Paint() handles this natively, but we keep this for the list-rebuild path.
        const active = document.activeElement;
        if (active && active.id) {
            const el = document.getElementById(active.id);
            if (el) {
                // Only refocus if we lost it (e.g. element was recreated)
                if (document.activeElement !== el) el.focus();
            }
        }
    };

    // New Internal Method: Heavy HTML Generation (The Builder)
    mBT.ui._fullRender = function(app) {
        // Logic Resolution: Container styling moved to mBT.ui.refresh() for instant toggling.
        // app.className and body background are now managed upstream.

        app.innerHTML = `
        <header class="mb-6 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto flex-grow">
                <input type="text" id="projectName" value="${budget.projectName}" class="text-2xl sm:text-4xl font-black uppercase text-slate-900 bg-transparent min-w-0 flex-grow focus:outline-none focus:bg-white p-3 rounded-2xl transition-all tracking-tighter" />
                <button id="loginBtn" class="w-12 h-12 rounded-full border-2 flex items-center justify-center transition-all shadow-xl flex-shrink-0 active:scale-90"></button>
            </div>
            <div id="project-management-container" class="w-full md:w-auto flex-shrink-0"></div>
        </header>

        <div class="flex gap-2 items-center mb-6">
            <button id="openAiToolsBtn" class="p-3 bg-indigo-600 text-white rounded-2xl shadow-lg transition-all hover:bg-indigo-700 active:scale-95 flex items-center justify-center">
                ${mBTAssets.wand}
            </button>
            <div id="statusBar" class="flex-grow p-3.5 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest flex justify-between items-center shadow-2xl"></div>
        </div>

        <div id="summary" class="mb-10 space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-blue-600 text-white p-6 rounded-[32px] shadow-2xl flex flex-col justify-center relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 transition-transform group-hover:scale-110 duration-700">${mBTAssets.money}</div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-blue-200 mb-1">Estimated Grand Total</p>
                    <p id="summaryGrandTotal" class="text-4xl font-black tracking-tighter">--</p>
                </div>
                <div class="bg-emerald-600 text-white p-6 rounded-[32px] shadow-2xl flex flex-col justify-center relative overflow-hidden group">
                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-200 mb-1">Actual Expenditure</p>
                    <p id="summaryActualTotal" class="text-4xl font-black tracking-tighter">--</p>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Discount</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="discountPercentage" value="${budget.discountPercentage || 0}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryDiscount" class="text-lg font-black text-slate-800">--</p>
                </div>

                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Contingency</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="contingencyPercentage" value="${budget.contingencyPercentage}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryContingency" class="text-lg font-black text-slate-800">--</p>
                </div>

                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Sales Tax</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="salesTaxPercentage" value="${budget.salesTaxPercentage}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryTax" class="text-lg font-black text-slate-800">--</p>
                </div>

                <div class="p-4 bg-slate-900 rounded-2xl shadow-xl">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2">Project Subtotal</p>
                    <p id="summarySubtotal" class="text-lg font-black text-white">--</p>
                </div>
            </div>
        </div>

        <main id="budget-sections" class="space-y-4">${renderBudgetSections()}</main>

        <div class="mt-12 p-5 bg-slate-900 rounded-[32px] text-[10px] text-slate-400 font-bold uppercase tracking-widest border border-black shadow-2xl">
            <span class="opacity-50">Intelligence:</span> Industrial personnel rates based on 2025 verified logic. Regional data resolution applied.
            <button id="compareRatesBtn" class="ml-3 text-blue-400 hover:text-white transition-colors underline decoration-blue-500/30 underline-offset-4">Open Matrix</button>
        </div>`;
        
        // Re-bind all initial listeners for a fresh DOM
        if (typeof initializeInteractiveInputs === 'function') initializeInteractiveInputs();
        if (typeof initializeDragAndDrop === 'function') initializeDragAndDrop();
        
        this.paint(); // Initial population of values
    };

    // Deficiency 1 Fix: Surgical DOM Update (The "Paint" Engine)
    // Updates values IN PLACE without destroying DOM nodes.
    mBT.ui.paint = function() {
        if (!budget) return;

        // Fix: Surgical update of Project Name Header
        // We ensure the visual header matches the internal data state immediately.
        // The check for activeElement prevents cursor jumping while the user is typing.
        const projNameInput = document.getElementById('projectName');
        if (projNameInput && document.activeElement !== projNameInput) {
            projNameInput.value = budget.projectName;
        }

        const fmt = mBTLE.format.currency;
        const isMobile = window.innerWidth < 768;
        
        // 1. Update Summaries
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
        
        // Recalculate derived totals based on current percentages
        // Note: These calculations mirror mBTLE.reconcile() to ensure visual sync
        const contingency = budget.subtotal * ((budget.contingencyPercentage || 0) / 100);
        const tax = budget.subtotal * ((budget.salesTaxPercentage || 0) / 100);
        const preDiscount = budget.subtotal + contingency + tax;
        const discount = preDiscount * ((budget.discountPercentage || 0) / 100);
        
        setTxt('summaryGrandTotal', fmt(budget.grandTotal));
        setTxt('summaryActualTotal', fmt(budget.actualTotal));
        setTxt('summarySubtotal', fmt(budget.subtotal));
        setTxt('summaryDiscount', fmt(-discount)); // Show as negative visually
        setTxt('summaryContingency', fmt(contingency));
        setTxt('summaryTax', fmt(tax));

        // 2. Update Line Items
        Object.keys(budget.sections).forEach(sectionKey => {
            const section = budget.sections[sectionKey];
            
            // Update Section Total Header
            // We escape quotes in the key to prevent selector breakage
            const safeKey = sectionKey.replace(/"/g, '\\"');
            const sectionTotalEl = document.querySelector(`[data-section-total="${safeKey}"]`);
            if (sectionTotalEl) sectionTotalEl.textContent = fmt(section.total);

            section.items.forEach(item => {
                const { estimated, variance } = calculateItem(item); 
                
                // Update Estimated Cell
                const estCell = document.querySelector(`[data-estimated-id="${item.id}"]`);
                if (estCell) estCell.textContent = isMobile ? formatAbbreviated(estimated, displayCurrency) : fmt(estimated);
                
                // Update Variance Cell
                const varCell = document.querySelector(`[data-variance-id="${item.id}"]`);
                if (varCell) {
                    varCell.textContent = isMobile ? formatAbbreviated(variance, displayCurrency) : fmt(variance);
                    // Update class for color
                    varCell.className = `p-1 md:p-2 w-[50px] md:w-28 text-right font-mono font-black text-[10px] md:text-xs ${variance > 0 ? 'text-red-500' : 'text-green-600'}`;
                }

                // Update Inputs (Non-destructive)
                // CRITICAL: We only update if the user is NOT currently typing in that specific input
                const updateInput = (field, val) => {
                    const input = document.querySelector(`input[data-id="${item.id}"][data-field="${field}"]`);
                    if (input && document.activeElement !== input) {
                        input.value = val;
                    }
                };
                
                updateInput('quantity', item.quantity);
                updateInput('rate', toDisp(item.rate).toFixed(2));
                updateInput('actual', toDisp(item.actual).toFixed(2));
                // We skip description/unit here as they are rarely changed programmatically during calc loops
            });
        });
    };

    // --- NEW: Surgical DOM Operations ("The Surgeon") ---
    // Logic Resolution: Direct DOM manipulation for Add/Remove to avoid full re-renders
    mBT.ui.ops = {
        add: function(sectionName, item) {
            // 1. Generate HTML string using the Render Engine
            // Note: We use the global alias RenderEngine if available, or fall back to local
            const renderer = window.RenderEngine || mBT.ui.render;
            const html = renderer.lineItem(item, sectionName);
            
            // 2. Locate the specific section body
            // We use the same selector strategy as the full render
            const safeName = sectionName.replace(/"/g, '\\"');
            const tbody = document.querySelector(`tbody[data-section-body="${safeName}"]`);
            
            if (tbody) {
                // 3. Inject HTML at the end of the list
                tbody.insertAdjacentHTML('beforeend', html);
                
                // 4. UX Polish: Auto-scroll and flash the new row
                const newRow = tbody.lastElementChild;
                if (newRow) {
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    newRow.classList.add('bg-blue-50');
                    setTimeout(() => newRow.classList.remove('bg-blue-50'), 500);
                    
                    // 5. Re-bind Drag & Drop (Logic Resolution)
                    if (typeof initializeDragAndDrop === 'function') initializeDragAndDrop();
                }
            }
        },
        
        remove: function(sectionName, itemId) {
            // 1. Locate the specific row by ID
            const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
            
            if (row) {
                // 2. UX Polish: Fade out before removal
                row.style.transition = 'all 0.2s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-10px)';
                
                // 3. Remove from DOM after animation
                setTimeout(() => row.remove(), 200);
            }
        }
    };

    // --- Global Alias for Backward Compatibility (The Bridge) ---
    // Logic Resolution: Calls to global 'render()' are now proxied to the UI namespace.
    window.render = mBT.ui.refresh.bind(mBT.ui);

// Logic Resolution: Prevents long filenames from breaking Studio layout containers.
function getAbbreviatedName(name, maxLen = 25) {
    if (name.length <= maxLen) return name;
    const ext = name.split('.').pop();
    const base = name.substring(0, name.lastIndexOf('.'));
    const keep = maxLen - ext.length - 4;
    return base.substring(0, keep) + '...' + ext;
}
    
    // --- mBT.ui.render: VISUAL CONSTRUCTION ENGINE ---
    // Previously: RenderEngine
    mBT.ui.render = {
        // --- XSS Neutralization: Standardized string escaping ---
        // Logic Resolution: Protects the DOM from injection by sanitizing all user-generated strings.
        esc(str) { 
            return !str ? '' : String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;'); 
        },

        /* --- v19.55 UI BLUEPRINTS: Standardized Component Generators --- */
        ui: {
            // 1. Tab Navigation Generator
            tabs: function({ items, activeId, onClick }) {
                return `<div class="flex border-b border-slate-100 bg-slate-50/50 rounded-t-xl overflow-hidden select-none">
                    ${items.map(t => {
                        const isActive = t.id === activeId;
                        const activeClass = "bg-white text-blue-600 border-b-2 border-blue-600 shadow-sm";
                        const inactiveClass = "text-slate-400 hover:text-slate-600 hover:bg-slate-100/50";
                        return `<button onclick="${onClick}('${t.id}')" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest transition-all ${isActive ? activeClass : inactiveClass}">
                            ${t.label} ${t.count !== undefined ? `<span class="opacity-50 ml-1">(${t.count})</span>` : ''}
                        </button>`;
                    }).join('')}
                </div>`;
            },

            // 2. Standard List Row (Used in Settings, Trash, Databases)
            listRow: function({ id, icon, title, subtitle, actions = [], onClick = null, classes = '' }) {
                const clickAttr = onClick ? `onclick="${onClick}"` : '';
                const cursorClass = onClick ? 'cursor-pointer' : '';
                
                const actionHtml = actions.map(a => 
                    `<button onclick="${a.onClick}" class="p-2 text-slate-300 hover:text-${a.color || 'blue'}-500 transition-colors scale-90 hover:scale-100" title="${a.title || ''}">${a.icon}</button>`
                ).join('');

                return `<div class="flex items-center justify-between p-3 bg-white border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors group ${classes} ${cursorClass}" ${clickAttr}>
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-white group-hover:text-blue-500 group-hover:shadow-sm transition-all text-lg shrink-0">${icon || ''}</div>
                        <div class="overflow-hidden min-w-0">
                            <div class="text-[10px] font-black uppercase text-slate-700 truncate">${mBT.ui.render.esc(title)}</div>
                            ${subtitle ? `<div class="text-[9px] text-slate-400 font-bold truncate">${mBT.ui.render.esc(subtitle)}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                        ${actionHtml}
                    </div>
                </div>`;
            },

            // 3. Grid Card (Used in Documents, Templates)
            card: function({ id, icon, title, subtitle, badge, actions = [], onClick = null }) {
                const clickAttr = onClick ? `onclick="${onClick}"` : '';
                const cursorClass = onClick ? 'cursor-pointer' : '';

                const actionHtml = actions.map(a => 
                    `<button onclick="${a.onClick}" class="p-2 text-slate-300 hover:text-${a.color || 'blue'}-600 transition-colors" title="${a.title || ''}">${a.icon}</button>`
                ).join('');

                return `<div class="group bg-white p-4 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md hover:border-blue-200 transition-all flex items-center justify-between ${cursorClass}">
                    <div class="flex items-center gap-4 flex-grow overflow-hidden" ${clickAttr}>
                        <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-100 group-hover:scale-110 transition-transform shrink-0">
                            ${icon || ''}
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-black text-slate-900 text-xs uppercase tracking-tighter truncate">${mBT.ui.render.esc(title)}</h4>
                            ${subtitle ? `<p class="text-[9px] text-blue-500 font-bold uppercase tracking-widest truncate">${mBT.ui.render.esc(subtitle)}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                        ${actionHtml}
                    </div>
                </div>`;
            },

            // 4. Empty State Placeholder
            emptyState: function({ icon, message, subtext }) {
                return `<div class="h-64 flex flex-col items-center justify-center text-slate-300 select-none">
                    <div class="text-4xl mb-4 opacity-30">${icon || ''}</div>
                    <p class="font-black uppercase text-[10px] tracking-widest opacity-60">${message || 'No Items Found'}</p>
                    ${subtext ? `<p class="text-[9px] font-bold mt-1 opacity-40">${subtext}</p>` : ''}
                </div>`;
            }
        },

        /* --- v19.55 LAYOUT ENGINES: High-level Container Abstractions --- */
        layouts: {
            // Logic Resolution: Standardized "Studio Panel" (Header + Search + Scroll List + optional Footer)
            studioPanel: function({ title, searchId, searchPlaceholder, contentId, contentHtml, actions = [], footerHtml = '', containerClasses = 'p-6 space-y-3' }) {
                const actionBtns = actions.map(a => 
                    `<button onclick="${a.onClick}" class="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-${a.color || 'blue'}-500 transition-all" title="${a.title||''}">${a.icon}</button>`
                ).join('');

                return `<div class="flex flex-col max-h-[90vh]">
                    <div class="p-6 bg-white border-b border-slate-100 flex-shrink-0 z-10">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-black text-slate-900 text-xs uppercase tracking-widest">${mBT.ui.render.esc(title)}</h3>
                            <div class="flex gap-2">${actionBtns}</div>
                        </div>
                        <div class="relative">
                            <input type="text" id="${searchId}" placeholder="${searchPlaceholder || 'SEARCH...'}" class="w-full p-3 pr-10 bg-slate-50 border-none rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">${mBTAssets.search}</div>
                        </div>
                    </div>
                    <div id="${contentId}" class="flex-grow overflow-y-auto no-scrollbar bg-slate-50/50 ${containerClasses}">
                        ${contentHtml}
                    </div>
                    ${footerHtml ? `<div class="p-6 bg-white border-t border-slate-100 flex-shrink-0 z-10">${footerHtml}</div>` : ''}
                </div>`;
            }
        },

        // --- Layout Shell: Section container generation ---
        // Logic Resolution: Constructs the collapsible department headers and their item containers.
        // Updated to use delegation: data-action="section-toggle"
        section({ name, total = '', isOpen = true, content = '' }) {
            const safeName = this.esc(name);
            return `
                <div class="mb-4 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="sticky-section-header relative min-h-[48px] bg-slate-50 border-b border-slate-100 select-none group z-30">
                        <div class="px-4 py-3 flex justify-between items-center cursor-pointer" data-action="section-toggle" data-id="${safeName}">
                            <div class="flex items-center gap-3 pointer-events-none">
                                <h2 class="text-[11px] font-black text-slate-800 uppercase tracking-widest leading-none pl-1">${safeName}</h2>
                            </div>
                            <span data-section-total="${safeName}" class="text-sm font-black text-blue-600 font-mono flex-shrink-0 pointer-events-none">${total}</span>
                        </div>
                        
                        <!-- Integrated Column Headers (Desktop Only) -->
                        <div class="${isOpen ? 'hidden md:flex' : 'hidden'} px-2 pb-2 text-[10px] font-black uppercase tracking-tighter text-slate-400 w-full">
                            <div class="w-12 text-center">Crew</div>
                            <div class="w-8"></div>
                            <div class="flex-grow pl-2">Description</div>
                            <div class="w-16 text-center">Qty</div>
                            <div class="w-20 text-center">Unit</div>
                            <div class="w-32 text-right md:text-left">Rate</div>
                            <div class="w-28 text-right md:text-left">Est</div>
                            <div class="w-28 text-right md:text-left">Act</div>
                            <div class="w-28 text-right">Var</div>
                            <div class="w-10"></div>
                        </div>
                    </div>
                    <div class="section-content ${isOpen ? '' : 'hidden'} animate-in fade-in slide-in-from-top-1 duration-200">
                        ${content}
                    </div>
                </div>`;
        },

        // --- Data Row Blueprint: Itemized line generation ---
        // Logic Resolution: Mobile-optimized widths, font-scaling, and "touch-friendly" inputs.
        // Updated to use delegation: data-action attributes for buttons.
        lineItem(item, sectionName) {
            const safeId = this.esc(item.id); 
            const safeSection = this.esc(sectionName);
            const isMobile = window.innerWidth < 768;
            const { estimated, variance } = calculateItem(item); 
            const crew = item.crew || {};
            const isLocked = item.rateType === 'fixed';
            const initials = crew.name ? crew.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
            
            // Logic: Clean phone for links
            const cleanPhone = crew.phone ? crew.phone.replace(/\D/g, '') : '';
            const waLink = `https://wa.me/${(cleanPhone.length === 10 && (cleanPhone.startsWith('876') || cleanPhone.startsWith('658'))) ? '1'+cleanPhone : cleanPhone}`;

            return `
                <tr class="group border-b border-slate-50 hover:bg-blue-50/30 transition-all draggable-row" data-item-id="${safeId}" data-section="${safeSection}">
                    <td class="p-2 text-center relative w-[40px] md:w-12 overflow-visible">
                        <div class="crew-wrapper inline-block">
                            <button data-action="crew-toggle" class="crew-avatar w-7 h-7 md:w-8 md:h-8 rounded-full border-2 border-dashed border-slate-200 flex items-center justify-center text-slate-300 hover:border-blue-400 hover:text-blue-500 transition-all ${crew.name ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white'} relative z-20">
                                <span class="text-[8px] md:text-[10px] font-black pointer-events-none">${initials}</span>
                            </button>

                            <div class="crew-popup">
                                ${crew.name ? `
                                    ${cleanPhone.length > 6 ? `
                                        <a href="tel:${cleanPhone}" class="contact-action-btn action-call" title="Call">${mBTAssets.phone}</a>
                                        <a href="${waLink}" target="_blank" class="contact-action-btn action-wa" title="WhatsApp">${mBTAssets.wa}</a>
                                    ` : ''}
                                    ${crew.email && crew.email.includes('@') ? `
                                        <a href="mailto:${crew.email}" class="contact-action-btn action-email" title="Email">${mBTAssets.mail}</a>
                                    ` : ''}
                                    <button data-action="crew-profile" data-id="${safeId}" data-section="${safeSection}" class="contact-action-btn action-profile" title="Profile">${mBTAssets.user}</button>
                                ` : `
                                    <button data-action="crew-profile" data-id="${safeId}" data-section="${safeSection}" class="flex items-center gap-1 text-[9px] font-black uppercase text-slate-400 hover:text-white transition-colors">
                                        <span class="pointer-events-none">Assign</span> ${mBTAssets.plus}
                                    </button>
                                `}
                            </div>
                        </div>
                    </td>
                    
                    <td class="p-2 w-[30px] md:w-8 drag-handle text-slate-200 hover:text-slate-400 cursor-grab active:cursor-grabbing text-center">${mBTAssets.drag}</td>
                    
                    <td class="p-2 text-left">
                        <input type="text" data-id="${safeId}" data-section="${safeSection}" data-field="description" value="${this.esc(item.description)}" 
                               class="w-full bg-transparent border-none font-bold text-xs md:text-sm text-slate-700 focus:ring-0 truncate mobile-desc-truncate" placeholder="Item...">
                    </td>
                    
                    <td class="p-1 md:p-2 w-[35px] md:w-16">
                        <input type="number" data-id="${safeId}" data-section="${safeSection}" data-field="quantity" value="${item.quantity}" 
                               class="w-full bg-transparent border-none text-center font-black text-[10px] md:text-xs text-blue-600 focus:ring-0 no-spinner p-0">
                    </td>
                    
                    <td class="p-1 md:p-2 w-[40px] md:w-20">
                        <select data-id="${safeId}" data-section="${safeSection}" data-field="unit" 
                                class="w-full bg-transparent border-none text-[8px] md:text-[10px] font-black uppercase tracking-tighter text-slate-400 focus:ring-0 cursor-pointer p-0 text-center">
                            ${['Day','Week','Flat','Policy','Hour'].map(u => `<option value="${u}" ${item.unit === u ? 'selected' : ''}>${u.substring(0,3)}</option>`).join('')}
                        </select>
                    </td>
                    
                    <td class="p-1 md:p-2 w-[50px] md:w-32">
                        <div class="flex items-center gap-1 justify-end md:justify-start">
                            <button data-action="row-lock" data-id="${safeId}" data-section="${safeSection}" class="hidden md:flex w-6 h-6 rounded-lg transition-all flex-shrink-0 items-center justify-center ${isLocked ? 'text-rose-500 bg-rose-50' : 'text-emerald-600 bg-emerald-50'}">
                                <span class="scale-75 pointer-events-none">${isLocked ? mBTAssets.lock : mBTAssets.zap}</span>
                            </button>
                            <input type="number" step="0.01" data-id="${safeId}" data-section="${safeSection}" data-field="rate" value="${toDisp(item.rate).toFixed(2)}" 
                                   class="w-full bg-transparent border-none font-mono font-bold text-[10px] md:text-xs text-slate-500 focus:ring-0 no-spinner text-right md:text-left p-0">
                        </div>
                    </td>
                    
                    <td class="p-1 md:p-2 w-[55px] md:w-28 font-mono font-bold text-[10px] md:text-xs text-slate-800 text-right" data-estimated-id="${safeId}">
                        ${isMobile ? formatAbbreviated(estimated, displayCurrency) : mBTLE.format.currency(estimated)}
                    </td>
                    
                    <td class="p-1 md:p-2 w-[55px] md:w-28">
                        <input type="number" step="0.01" data-id="${safeId}" data-section="${safeSection}" data-field="actual" value="${toDisp(item.actual || 0).toFixed(2)}" 
                               class="w-full bg-blue-50/50 rounded-md border-none font-mono font-bold text-[10px] md:text-xs text-emerald-600 focus:ring-0 no-spinner text-right p-1" placeholder="0">
                    </td>
                    
                    <td class="p-1 md:p-2 w-[50px] md:w-28 text-right font-mono font-black text-[10px] md:text-xs" data-variance-id="${safeId}">
                        ${isMobile ? formatAbbreviated(variance, displayCurrency) : mBTLE.format.currency(variance)}
                    </td>
                    
                    <td class="p-1 md:p-2 text-center w-[30px] md:w-10">
                        <button data-action="row-delete" data-id="${safeId}" data-section="${safeSection}" class="text-slate-200 hover:text-rose-500 transition-colors scale-75 md:scale-100">
                            ${mBTAssets.trash}
                        </button>
                    </td>
                </tr>`;
        },

        // --- Stage Visualization: Production phase card generation ---
        // Logic Resolution: Renders specialized cards for the Production Stages view with burn-rate telemetry.
        // Updated: Removed inline listeners in favor of delegation.
        stageCard(item, stageKey) {
            const cost = (item._sDays || 0) * (item._sRate || 0);
            return `
                <div class="stage-card-item p-3 bg-white border border-slate-100 rounded-xl shadow-sm space-y-2 group relative cursor-grab active:cursor-grabbing" 
                     draggable="true" 
                     ondragstart="handleStageDragStart(event, '${item.id}', '${stageKey}')"
                     data-item-id="${item.id}" data-stage-key="${stageKey}">
                    <div class="flex justify-between items-start">
                        <div class="min-w-0 pr-2">
                            <p class="text-[10px] font-black text-slate-800 uppercase truncate">${this.esc(item.description)}</p>
                            <p class="text-[8px] text-slate-400 font-bold uppercase tracking-widest">${this.esc(item._sec)}</p>
                        </div>
                        <span id="cost-${item.id}-${stageKey}" class="text-[10px] font-black text-slate-900 font-mono flex-shrink-0">${formatAbbreviated(cost, displayCurrency)}</span>
                        <button data-action="stage-remove" data-id="${item.id}" data-section="${item._sec}" data-stage="${stageKey}" class="absolute bottom-1 right-1 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all bg-white rounded-full p-1 shadow-sm border border-slate-100 z-10">
                            ${mBTAssets.trash}
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1">
                            <label class="block text-[7px] font-black text-slate-400 uppercase">Days</label>
                            <input type="number" value="${item._sDays}" data-action="stage-update" data-field="days" data-id="${item.id}" data-section="${item._sec}" data-stage="${stageKey}" 
                                   class="w-full bg-slate-50 border-none rounded p-1 text-[10px] font-bold text-blue-600 no-spinner">
                        </div>
                        <div class="flex-[2]">
                            <label class="block text-[7px] font-black text-slate-400 uppercase">Rate</label>
                            <input type="number" value="${item._sRate}" data-action="stage-update" data-field="rate" data-id="${item.id}" data-section="${item._sec}" data-stage="${stageKey}" 
                                   class="w-full bg-slate-50 border-none rounded p-1 text-[10px] font-mono font-bold text-slate-600 no-spinner">
                        </div>
                    </div>
                </div>`;
        }
    };
    
    // --- Global Alias for Backward Compatibility (The Bridge) ---
    window.RenderEngine = mBT.ui.render;

/* --- 4. Render Orchestration: Global UI drawing logic --- */
    function renderBudgetSections() {
        if (!budget || !budget.sections) return '';
        return Object.entries(budget.sections).map(([name, section]) => {
            // Logic Resolution: Responsive Table Headers
            // Note: Header moved to RenderEngine.section to prevent visual blocking. Table is now body-only.
            const bodyContent = `
                <div class="table-container overflow-x-auto no-scrollbar">
                    <table class="w-full border-collapse min-w-full table-fixed md:table-auto">
                        <tbody data-section-body="${name}">
                            ${section.items.map(item => RenderEngine.lineItem(item, name)).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="bg-white border-t border-slate-100">
                    <button data-action="section-add" data-id="${name}" class="w-full py-3 flex items-center justify-center gap-2 text-blue-600 font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 transition-all">
                        <span class="scale-75 pointer-events-none">${mBTAssets.plus}</span> Add Line Item
                    </button>
                </div>`;

            return RenderEngine.section({
                name: name,
                total: mBTLE.format.currency(section.total),
                isOpen: section.isOpen,
                content: bodyContent
            });
        }).join('');
    }

// Logic Resolution: Toggles visibility of section items.
function handleToggleSection(sectionName) {
    const sec = budget.sections[sectionName];
    if (sec) {
        sec.isOpen = !sec.isOpen;
        saveBudget();
        render();
    }
}

// Logic Resolution: Removes items from the budget object.
function handleRemoveItem(sectionName, itemId) {
    if(!confirm("Remove this line item permanently?")) return;
    const sec = budget.sections[sectionName];
    if(sec) {
        sec.items = sec.items.filter(i => i.id !== itemId);
        
        // Tier 4 Surgeon: Remove DOM node instantly
        if (mBT.ui && mBT.ui.ops) {
            mBT.ui.ops.remove(sectionName, itemId);
            mBTLE.reconcile(); // Update Math
            mBT.ui.paint();    // Update Totals
        } else {
            mBTLE.reconcile();
            render(); // Fallback
        }
    }
}

// Logic Resolution: Modal for adding new line items from Open Gate.
function showItemSelectorModal(sectionName) {
    // Define the commit handler globally for HTML access
    window._commitAddItem = (desc, rate, unit) => {
        const section = budget.sections[sectionName];
        if (!section) return;
        const newItem = {
            id: 'item_' + Date.now(),
            description: desc || 'New Item',
            quantity: 1,
            unit: unit || 'Day',
            rate: parseFloat(rate) || 0,
            multiplier: 1,
            actual: 0,
            crew: { name: '', phone: '', email: '' },
            rateType: 'negotiable'
        };
        section.items.push(newItem);
        mBTME.close('itemSelectorModal');
        
        // Tier 4 Surgeon: Inject DOM node instantly
        if (mBT.ui && mBT.ui.ops) {
            mBT.ui.ops.add(sectionName, newItem);
            mBTLE.reconcile(); // Update Math
            mBT.ui.paint();    // Update Totals
        } else {
            mBTLE.reconcile();
            render(); // Fallback
        }
    };

    const rates = mBTOG.rates || [];
    
    // Custom filter logic to preserve the 'Create Custom' button dynamically
    window._filterItemSelector = (val) => {
        const container = document.getElementById('ogItemList');
        if(!container) return;
        const term = val.toLowerCase();
        const filtered = rates.filter(r => r.description.toLowerCase().includes(term));
        
        const customBtn = `
            <button onclick="window._commitAddItem('${RenderEngine.esc(val)}', 0, 'Day')" class="w-full text-left p-3 rounded-lg border border-dashed border-indigo-200 text-indigo-600 hover:bg-indigo-50 transition-all mb-2 flex justify-between items-center group">
                <span class="text-[10px] font-black uppercase tracking-widest">+ Create "${RenderEngine.esc(val) || 'New Item'}"</span>
            </button>`;

        const listHtml = filtered.map(r => `
            <button onclick="window._commitAddItem('${RenderEngine.esc(r.description)}', ${r.rate}, '${r.unit}')" class="w-full text-left p-3 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all flex justify-between items-center group border-b border-slate-50 last:border-0">
                <span class="text-[10px] font-bold text-slate-700 uppercase">${r.description}</span>
                <span class="text-[9px] font-mono text-slate-400 group-hover:text-blue-500 font-bold">${mBTLE.format.currency(r.rate)} / ${r.unit}</span>
            </button>
        `).join('');
        
        container.innerHTML = customBtn + listHtml;
    };

    const content = `
        <div class="flex flex-col h-[500px]">
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <input type="text" oninput="window._filterItemSelector(this.value)" placeholder="SEARCH OPEN GATE..." class="w-full p-3 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-indigo-500 transition-all" autofocus>
            </div>
            <div id="ogItemList" class="flex-grow overflow-y-auto p-2 bg-white no-scrollbar">
                <button onclick="window._commitAddItem('New Item', 0, 'Day')" class="w-full text-left p-3 rounded-lg border border-dashed border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all mb-2 flex justify-between items-center group">
                    <span class="text-[10px] font-black uppercase tracking-widest">+ Create Custom</span>
                </button>
                ${rates.map(r => `
                    <button onclick="window._commitAddItem('${RenderEngine.esc(r.description)}', ${r.rate}, '${r.unit}')" class="w-full text-left p-3 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all flex justify-between items-center group border-b border-slate-50 last:border-0">
                        <span class="text-[10px] font-bold text-slate-700 uppercase">${r.description}</span>
                        <span class="text-[9px] font-mono text-slate-400 group-hover:text-blue-500 font-bold">${mBTLE.format.currency(r.rate)} / ${r.unit}</span>
                    </button>
                `).join('')}
            </div>
        </div>`;

    mBTME.open('itemSelector', `Add to ${sectionName}`, content, 'max-w-md');
    // Auto-focus logic for better UX
    setTimeout(() => document.querySelector('#itemSelectorModal input')?.focus(), 50);
}

// Logic Resolution: Placeholders for event listeners handled by Tier 6.
function initializeInteractiveInputs() {}

// Logic Resolution: Drag and drop initialization.
function initializeDragAndDrop() {
    document.querySelectorAll('tbody').forEach(el => {
        if(typeof Sortable !== 'undefined') {
            new Sortable(el, { 
                handle: '.drag-handle', 
                animation: 150
            });
        }
    });
}

// Logic Resolution: Stage Drag and Drop initialization.
function initializeStageDragAndDrop() {
    const draggables = document.querySelectorAll('.stage-draggable');
    draggables.forEach(d => {
        d.addEventListener('dragstart', () => d.classList.add('dragging'));
        d.addEventListener('dragend', () => d.classList.remove('dragging'));
    });
}

// Logic Resolution: Updates UI based on connectivity.
function updateOnlineStatus() {
    if(typeof resolveConnectivityStatus === 'function') resolveConnectivityStatus();
}

// Logic Resolution: Project Template Selector (Visual Bridge)
window.showNewProjectModal = function() {
    // 1. Build Cards from Tier 1 Registry
    // Update: Passed 'false' to newProject to skip confirmation dialog
    const templates = Object.entries(BUDGET_TEMPLATES).map(([key, t]) => `
        <button onclick="mBT.data.newProject(false, '${key}'); mBTME.close('newProjectModal');"
            class="group relative flex flex-col items-start p-6 bg-white border border-slate-200 rounded-2xl hover:border-blue-500 hover:shadow-xl hover:-translate-y-1 transition-all text-left w-full">
            <div class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-400 group-hover:bg-blue-600 group-hover:text-white flex items-center justify-center mb-4 transition-colors shadow-sm">
                ${mBTAssets[t.icon] || mBTAssets.file}
            </div>
            <h3 class="text-xs font-black uppercase tracking-widest text-slate-900 mb-2 group-hover:text-blue-600 transition-colors">${t.label}</h3>
            <p class="text-[10px] text-slate-500 font-medium leading-relaxed opacity-80">${t.desc}</p>
        </button>
    `).join('');

    // 2. Build Modal Layout
    // Update: Removed the icon circle div above the title
    const content = `
        <div class="p-8 bg-slate-50 min-h-[400px] flex flex-col">
            <div class="text-center mb-8 shrink-0">
                <h2 class="text-lg font-black uppercase tracking-tighter text-slate-900">Select Blueprint</h2>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-2">Choose a production structure to begin</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 grow">
                ${templates}
            </div>
            <div class="mt-8 text-center shrink-0 border-t border-slate-200/50 pt-4">
                <button onclick="mBT.data.newProject(false, 'Blank'); mBTME.close('newProjectModal');" class="text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-colors hover:bg-slate-200/50 px-4 py-2 rounded-lg">
                    Skip & Create Blank Budget
                </button>
            </div>
        </div>`;

    // 3. Launch via Tier 5 Modal Engine
    mBTME.open('newProject', '', content, 'max-w-4xl', { hideHeader: true, noPadding: true });
};

console.log("TIER 4 render defined", typeof render);


/* ================= TIER 5: MODULE CONTROLLERS & SMART FEATURES ================= */
    /* ========= v19.55 mBT.ui.modal: MODAL ENGINE (Window orchestration) ========= */
    // Previously: mBTME
    mBT.ui.modal = {
        containerId: 'global-modal-container',
        // --- Registry Resolution: Pointing to Tier 1 Asset Registry ---
        icons: { close: mBTAssets.close },
      
        // --- Portal Generation: Dynamic injection of overlay layers ---
        open: function(id, title, contentHtml, maxWidth = 'max-w-2xl', options = {}) {
            const container = document.getElementById(this.containerId);
            if (!container) return;
            
            // Logic Resolution: Prevent background scrolling while modal is active
            document.body.style.overflow = 'hidden';

            const modalId = `${id}Modal`;
            this.close(modalId, true);
            // UPDATED HEADER: Uses grid to perfectly center the title while keeping the close button right-aligned
            const headerHtml = options.hideHeader ? '' : `
                <div class="p-4 border-b border-slate-100 bg-white rounded-t-2xl relative grid grid-cols-[1fr_auto_1fr] items-center shrink-0">
                    <div></div> <h2 class="text-xs font-black uppercase tracking-widest text-slate-800 text-center">${title}</h2>
                    <div class="text-right">
                        <button onclick="mBT.ui.modal.close('${modalId}')" class="text-slate-400 hover:text-red-500 transition-all p-1 rounded-md hover:bg-slate-50">${this.icons.close}</button>
                    </div>
                </div>`;
            const fullHtml = `
                <div id="${modalId}" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[999] transition-opacity duration-300 opacity-0 hidden" tabindex="-1">
                    <div id="${modalId}Content" class="bg-white rounded-2xl shadow-2xl w-full ${maxWidth} mx-auto max-h-[95vh] flex flex-col transition-all duration-300 transform scale-95 border border-white/20 overflow-hidden">
                        ${headerHtml}
                        <div class="flex-grow overflow-hidden ${options.noPadding ? 'p-0' : 'p-0'}" id="${modalId}Body">${contentHtml}</div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', fullHtml);
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById(`${modalId}Content`)?.classList.remove('scale-95');
            }, 10);
          
            modal.addEventListener('click', (e) => { if (e.target === modal) this.close(modalId); });
            if (options.onOpen && typeof options.onOpen === 'function') setTimeout(options.onOpen, 50);
            return modal;
        },
        // --- Portal Dissolution: Synchronized removal of UI layers ---
        close: function(modalId, instant = false) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Logic Resolution: Release body scroll if no other modals are open
            if(document.querySelectorAll('[id$="Modal"]').length <= 1) document.body.style.overflow = '';

            if (instant) { modal.remove(); } else {
                modal.classList.add('opacity-0');
                document.getElementById(`${modalId}Content`)?.classList.add('scale-95');
                // --- Handshake: Reconcile logic on environment exit ---
                setTimeout(() => { modal.remove(); if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); }, 300);
            }
        },
        // --- Search Integration: Filtering logic for modal lists ---
        attachSearch: function(inputId, listContainerId, dataItems, renderRowFn) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listContainerId);
            if (!input || !list) return;
            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = dataItems.filter(item => (item.description || item.name || item.label || '').toLowerCase().includes(term));
                // Logic Resolution: Added col-span-full to support grid layouts in "No Matches" state
                list.innerHTML = filtered.length > 0 ? filtered.map(renderRowFn).join('') : `<div class="p-12 text-center text-slate-300 text-[10px] font-black uppercase tracking-widest col-span-full">No Matches</div>`;
            });
        }
    };
    
    // --- Global Alias for Backward Compatibility (The Bridge) ---
    window.mBTME = mBT.ui.modal;

    /* ========= v19.54 mBTPublisher: OUTPUT & COMMUNICATIONS ENGINE ========= */
    const mBTPublisher = {
        config: {
            pdf: { margin: 0.2, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }
        },

        /* --- 1. Communication Protocols (The "Comms" Layer) --- */
        comm: {
            // Logic Resolution: Centralized link generation for consistency
            cleanPhone: (p) => p ? p.replace(/\D/g, '') : '',
            
            whatsapp: function(phone, text = '') {
                const p = this.cleanPhone(phone);
                if (!p) return '#';
                // Industry Standard: Auto-append country code for Jamaica/US if missing
                const num = (p.length === 10 && (p.startsWith('876') || p.startsWith('658'))) ? '1'+p : p;
                return `https://wa.me/${num}?text=${encodeURIComponent(text)}`;
            },
            
            email: function(email, subject = '', body = '') {
                return `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            },

            call: function(phone) {
                return `tel:${this.cleanPhone(phone)}`;
            },

            // Logic Resolution: Generates the "Share Sheet" for a document
            generateShareSheet: function(doc) {
                const title = doc.label || 'Document';
                const date = doc.content?.data?.meta?.shootDate || 'TBD';
                return `Here is the ${title} for ${date}. Please review.`;
            }
        },

        /* --- 2. IO & File Systems (The "Hard Drive" Layer) --- */
        io: {
            forceDownload: function(blob, filename) {
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            },

            saveMoo: function(budgetData) {
                const blob = new Blob([JSON.stringify(budgetData, null, 2)], { type: 'application/json' });
                this.forceDownload(blob, `${(budgetData.projectName || 'project').toLowerCase().replace(/\s+/g, '_')}.moo`);
            },

            saveTemplate: function(templateData) {
                const blob = new Blob([JSON.stringify(templateData, null, 2)], { type: 'application/json' });
                this.forceDownload(blob, `${(templateData.label || 'template').toLowerCase().replace(/\s+/g, '_')}.mtemp`);
            }
        },

        /* --- 3. Render Formats (The "Printer" Layer) --- */
        format: {
            // PDF Export (Studio Documents)
            pdf: function(elementId, filename) {
                const element = document.getElementById(elementId);
                if (!element) return alert("Source element not found");
                
                // Visual Polish: Flatten inputs for print
                const originalBg = element.style.background;
                element.style.background = "white";
                element.classList.add('print-mode'); // CSS hook for hiding buttons
                
                html2pdf().set(mBTPublisher.config.pdf).from(element).save(filename + '.pdf')
                    .then(() => {
                        element.style.background = originalBg;
                        element.classList.remove('print-mode');
                    });
            },

            // Fast Preview (JPEG Snapshot)
            jpeg: function(elementId, callback) {
                const source = document.getElementById(elementId);
                if(!source) return;

                // Clone to isolate from current view state
                const clone = source.cloneNode(true);
                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                clone.style.width = '1000px'; 
                clone.classList.remove('editing-mode');
                
                // Scrub UI controls
                clone.querySelectorAll('button, .widget-controls, .grid-stack-handle').forEach(el => el.remove());
                clone.querySelectorAll('textarea').forEach(el => {
                    const div = document.createElement('div');
                    div.innerHTML = el.value.replace(/\n/g, '<br>');
                    div.className = 'text-xs p-2 leading-relaxed whitespace-pre-wrap';
                    el.parentNode.replaceChild(div, el);
                });
                clone.querySelectorAll('input').forEach(el => {
                    if(el.type !== 'hidden') {
                        const span = document.createElement('span');
                        span.textContent = el.value;
                        span.className = el.className;
                        span.style.border = 'none';
                        span.style.background = 'transparent';
                        el.parentNode.replaceChild(span, el);
                    }
                });

                document.body.appendChild(clone);
                html2canvas(clone, { scale: 1.5, useCORS: true, logging: false }).then(canvas => {
                    document.body.removeChild(clone);
                    if (callback) callback(canvas.toDataURL('image/jpeg', 0.9));
                });
            }
        },

        // --- Bridge: Main Entry Points ---
        exportToPDF: function(id, name) { this.format.pdf(id, name); },
        toMoo: function() { this.io.saveMoo(budget); },
        generateFastPreview: function(mode, data, cb) { this.format.jpeg('mBTDB_Workspace', cb); }, // Adapter for old calls
        downloadJPEG: function(url, title) {
            const a = document.createElement('a'); a.href = url; a.download = `${title}.jpg`; a.click();
        },
        
        // --- Compatibility Stubs (Prevent legacy crashes) ---
        processAutofill: function() { console.log("Legacy autofill bypassed"); },
        renderEditor: function() { return ""; },
        interpret: function() { return ""; }
    };

/* ========= v19.54 mBTDB: STUDIO BUILDER ENGINE ========= */
window.mBTDB = {
    state: { currentDocId: null, isEditing: false, grid: null, history: [], historyPointer: -1 },
    // --- 1. Registry Resolution: Tier 1 Asset Map ---
    icons: {
        trash: mBTAssets.trash, plus: mBTAssets.plus, user: mBTAssets.user,
        cloud: mBTAssets.cloud, save: mBTAssets.save, undo: mBTAssets.undo,
        redo: mBTAssets.redo, copy: mBTAssets.copy, print: mBTAssets.print,
        close: mBTAssets.close, wand: mBTAssets.wand, grid: mBTAssets.grid,
        list: mBTAssets.list, image: mBTAssets.image
    },
  
    templates: {
        // --- CORE STANDARD ---
        'default': { label: "Blank Document", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }] },
        'callSheet': {
            label: "Daily Call Sheet",
            widgets: [
                { id: 'contacts', x: 0, y: 0, w: 12, h: 4, type: 'contacts', label: "Key Contacts" },
                { id: 'logistics', x: 0, y: 4, w: 12, h: 6, type: 'logistics', label: "Logistics" },
                { id: 'schedule', x: 0, y: 10, w: 12, h: 8, type: 'schedule', label: "Schedule" },
                { id: 'cast', x: 0, y: 18, w: 6, h: 8, type: 'cast', label: "Cast List" },
                { id: 'crew', x: 6, y: 18, w: 6, h: 8, type: 'crew', label: "Crew List" },
                { id: 'notes', x: 0, y: 26, w: 12, h: 4, type: 'richText', label: "General Notes" }
            ]
        },
        
        // --- PRE-PRODUCTION ---
        'breakdown': {
            label: "Script Breakdown",
            widgets: [
                { id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' },
                { id: 'cast', x: 0, y: 2, w: 6, h: 8, type: 'cast', label: "Characters" },
                { id: 'logistics', x: 6, y: 2, w: 6, h: 8, type: 'logistics', label: "Locations" },
                { id: 'notes', x: 0, y: 10, w: 12, h: 6, type: 'richText', label: "Scene Notes & Requirements" }
            ]
        },
        'shotlist': {
            label: "Shot List",
            widgets: [
                { id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' },
                { id: 'schedule', x: 0, y: 2, w: 12, h: 12, type: 'schedule', label: "Shot Sequence" },
                { id: 'logistics', x: 0, y: 14, w: 12, h: 4, type: 'logistics', label: "Locations" }
            ]
        },
        'casting': {
            label: "Casting Sheet",
            widgets: [
                { id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' },
                { id: 'cast', x: 0, y: 2, w: 12, h: 10, type: 'cast', label: "Audition List" },
                { id: 'notes', x: 0, y: 12, w: 12, h: 4, type: 'richText', label: "Casting Director Notes" }
            ]
        },
        'techScout': {
            label: "Tech Scout Report",
            widgets: [
                { id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' },
                { id: 'logistics', x: 0, y: 2, w: 12, h: 10, type: 'logistics', label: "Location Details" },
                { id: 'notes', x: 0, y: 12, w: 12, h: 6, type: 'richText', label: "Tech Notes (Power/Parking/Access)" }
            ]
        },

        // --- PRODUCTION ---
        'prodReport': {
            label: "Production Report",
            widgets: [
                { id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' },
                { id: 'schedule', x: 0, y: 2, w: 12, h: 6, type: 'schedule', label: "Scenes Shot" },
                { id: 'crew', x: 0, y: 8, w: 12, h: 6, type: 'crew', label: "Crew Attendance" },
                { id: 'notes', x: 0, y: 14, w: 6, h: 6, type: 'richText', label: "Production Notes" },
                { id: 'delays', x: 6, y: 14, w: 6, h: 6, type: 'richText', label: "Delays / Issues" }
            ]
        },
        'crewList': {
            label: "Crew Contact List",
            widgets: [
                { id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' },
                { id: 'contacts', x: 0, y: 2, w: 12, h: 4, type: 'contacts', label: "Production Team" },
                { id: 'crew', x: 0, y: 6, w: 12, h: 12, type: 'crew', label: "Department Heads & Crew" }
            ]
        },

        // --- WRITING / LEGAL / GENERIC ---
        'script': { label: "Script", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }, { id: 'body', x: 0, y: 2, w: 12, h: 12, type: 'richText', label: "Screenplay" }] },
        'treatment': { label: "Treatment", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }, { id: 'body', x: 0, y: 2, w: 12, h: 12, type: 'richText', label: "Story Treatment" }] },
        'pitchDeck': { label: "Pitch Deck", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }, { id: 'body', x: 0, y: 2, w: 12, h: 12, type: 'richText', label: "Pitch Content" }] },
        'dealMemo': { label: "Deal Memo", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }, { id: 'terms', x: 0, y: 2, w: 12, h: 10, type: 'richText', label: "Terms of Agreement" }] },
        'insurance': { label: "Insurance", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }, { id: 'details', x: 0, y: 2, w: 12, h: 10, type: 'richText', label: "Coverage Details" }] },
        'permit': { label: "Permit", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }, { id: 'details', x: 0, y: 2, w: 12, h: 10, type: 'richText', label: "Permit Details" }] }
    },
    // --- 2. Portal Orchestration ---
    open: function(docId) {
        this.state.currentDocId = docId;
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc) return;
        if (!doc.content) doc.content = { data: {}, widgets: [] };
        if (!doc.content.widgets || doc.content.widgets.length === 0) {
            // Logic Resolution: Fallback to 'script' layout for text-heavy types if specific template missing
            let tKey = this.templates[doc.type] ? doc.type : 'default';
            if (tKey === 'default' && ['storyboard','budgetRep','vendorBid','riskAI','carbon','postSched'].includes(doc.type)) tKey = 'script'; 
            
            doc.content.widgets = JSON.parse(JSON.stringify(this.templates[tKey].widgets));
            if(!doc.content.data.meta) doc.content.data = this._generateDefaultData();
        }
        if(typeof mBTME !== 'undefined') {
            // Logic Resolution: Fixed ID string to match the close() function target (removed extra 'Modal' suffix in call)
            mBTME.open('documentViewer', 'Document Studio', '<div id="mBTDB_Container"></div>', 'w-full h-full max-w-full', { noPadding: true, hideHeader: true });
            this.renderFrame();
        }
    },
    close: function() {
        if (this.state.isEditing) {
            this._saveLayoutState();
            this.state.isEditing = false;
        }
        if (typeof mBTME !== 'undefined') mBTME.close('documentViewerModal');
        document.body.classList.remove('print-mode');
        this.state.currentDocId = null;
        if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
        if (typeof render === 'function') render();
    },
    toggleEditMode: function() {
        if (this.state.isEditing && this.state.grid) this._saveLayoutState();
        this.state.isEditing = !this.state.isEditing;
        const container = document.getElementById('mBTDB_Workspace');
        const grid = this.state.grid;
        if (container && grid) {
            if (this.state.isEditing) {
                container.classList.add('editing-mode');
                grid.setStatic(false);
                grid.enable();
            } else {
                container.classList.remove('editing-mode');
                grid.setStatic(true);
                grid.disable();
            }
            this._updateHeaderButtons();
        }
    },
    _saveLayoutState: function() {
        if (!this.state.grid) return;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        this.state.grid.engine.nodes.forEach(node => {
            const widget = doc.content.widgets.find(w => w.id === node.id);
            if (widget) { widget.x = node.x; widget.y = node.y; widget.w = node.w; widget.h = node.h; }
        });
        this._triggerSave();
    },
    // --- 3. Publishing & Intelligence Hub ---
    previewDoc: function(mode) {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        if (!doc || typeof mBTPublisher === 'undefined') return;
        if(mBTME.showLoader) mBTME.showLoader("Generating Professional Preview...");
        mBTPublisher.generateFastPreview(mode, doc.content.data, (jpegURL) => {
            if(mBTME.hideLoader) mBTME.hideLoader();
            mBTME.open('previewModal', `Industry View: ${mode.toUpperCase()}`,
                `<div class="flex flex-col items-center bg-slate-900 h-full p-8 overflow-auto no-scrollbar"><img src="${jpegURL}" id="finalPreviewImage" class="shadow-2xl border border-black max-w-full h-auto mb-24 bg-white rounded-sm"><div class="fixed bottom-10 left-1/2 -translate-x-1/2 flex gap-4 z-[10001]"><button onclick="mBTPublisher.downloadJPEG('${jpegURL}', '${doc.label}')" class="flex items-center gap-3 bg-blue-600 text-white px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-blue-500 transition-all active:scale-95">Download JPEG</button><button onclick="mBTDB.sendToDistribution('${jpegURL}')" class="flex items-center gap-3 bg-emerald-600 text-white px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-emerald-500 transition-all active:scale-95">Send to Crew</button><button onclick="mBTME.close('previewModal')" class="bg-white text-slate-900 px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-slate-100 transition-all">Close</button></div></div>`, 'w-full h-full');
        });
    },
    sendToDistribution: function(jpegURL) {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        this.close();
        if(window.openDocumentShareSelector) openDocumentShareSelector(doc.id);
    },
    autoFillWidget: function(type, docId) {
        if(!confirm(`Auto-fill ${type}? Current items will be preserved.`)) return;
        if(type === 'contacts') {
            const roles = ['director', 'producer', '1st ad'];
            roles.forEach(r => {
                const c = mBTOG.contacts.find(x => x.role && x.role.toLowerCase().includes(r));
                if(c) this.updateData(docId, `contacts.${r === '1st ad' ? 'ad' : r}`, `${c.name} ${c.contact||''}`);
            });
        } else if(type === 'crew') {
            Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                if(i.crew && i.crew.name) this.addRow(docId, 'crew', 'person', { department: i.description, name: i.crew.name, contact: i.crew.phone });
            }));
        }
        this.renderFrame();
    },
    autoFillWeather: async function(docId, index, name) {
        const btn = document.getElementById(`w-btn-${index}`);
        if(btn) btn.innerHTML = `<span class="animate-spin inline-block">...</span>`;
        try {
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`);
            const geo = await geoRes.json();
            if(!geo.results) throw new Error("Location not found");
            const { latitude, longitude } = geo.results[0];
            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`);
            const wData = await wRes.json();
            const today = wData.daily;
            const code = today.weather_code[0];
            let summary = "Clear Skies"; if(code > 3) summary = "Cloudy"; if(code > 50) summary = "Rainy";
            const str = `${summary} | Max: ${today.temperature_2m_max[0]}C / Min: ${today.temperature_2m_min[0]}C\nSunrise: ${today.sunrise[0].split('T')[1]} / Sunset: ${today.sunset[0].split('T')[1]}`;
            this.updateRow(docId, 'locations', index, 'weather', str);
            this.renderFrame();
        } catch(e) { alert("Weather Synchronization Failure"); if(btn) btn.innerHTML = this.icons.cloud; }
    },
    // --- 4. Render Engine Handshake ---
    renderFrame: function() {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const container = document.getElementById('mBTDB_Container');
        if(!container) return;
        const toolbarHTML = `<div id="mBTDB_Header" class="bg-slate-900 text-white p-3 flex justify-between items-center sticky top-0 z-50 shadow-xl border-b border-black print:hidden"><div class="flex items-center gap-4"><h2 class="font-black text-xs uppercase tracking-widest text-slate-400 flex items-center gap-2"><span class="text-blue-500">${this.icons.list}</span> Studio: ${RenderEngine.esc(doc.label)}</h2><div class="flex bg-slate-800 rounded-lg overflow-hidden border border-slate-700"><button onclick="mBTDB.syncFromBudget()" class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 text-slate-300 hover:bg-slate-700 border-r border-slate-700 transition-colors">Sync Budget</button><button onclick="mBTDB.syncFromPrevious()" class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 text-slate-300 hover:bg-slate-700 transition-colors">Sync Prev</button></div></div><div class="flex gap-2 items-center" id="mBTDB_Buttons"></div></div>`;
        const workspaceHTML = `<div id="mBTDB_Workspace" class="bg-slate-100 min-h-screen p-6 overflow-y-auto no-scrollbar ${this.state.isEditing ? 'editing-mode' : ''}"><div id="mBTDB_MetaArea" class="mb-6 bg-white p-6 shadow-2xl rounded-2xl border border-slate-200 animate-in fade-in duration-500"></div><div class="grid-stack no-scrollbar"></div></div>`;
        container.innerHTML = toolbarHTML + workspaceHTML;
        this._renderMetaHeader(doc);
        setTimeout(() => {
            if(typeof GridStack === 'undefined') return console.error("GridStack resolution failure.");
            this.state.grid = GridStack.init({ column: 12, cellHeight: 65, minRow: 1, margin: 8, animate: true, float: true, staticGrid: !this.state.isEditing }, container.querySelector('.grid-stack'));
            this._loadWidgetsToGrid(doc);
            this._updateHeaderButtons();
            this.state.grid.on('change', () => this._triggerSave());
        }, 50);
    },
    _loadWidgetsToGrid: function(doc) {
        const grid = this.state.grid; grid.removeAll(); grid.batchUpdate();
        doc.content.widgets.forEach(w => { if(w.type === 'header') return; grid.addWidget({ x: w.x, y: w.y, w: w.w, h: w.h, content: this._generateWidgetHTML(w, doc), id: w.id }); });
        grid.commit();
    },
    _generateWidgetHTML: function(widget, doc) {
        const data = doc.content.data; const cleanTitle = widget.label || (widget.type.charAt(0).toUpperCase() + widget.type.slice(1));
        let tools = ''; if(widget.type === 'contacts') tools += `<button onclick="mBTDB.toggleVertical('${widget.id}')" class="p-1.5 hover:bg-slate-100 rounded-md transition-colors">${widget.vertical ? this.icons.grid : this.icons.list}</button>`;
        if(widget.type !== 'image') tools += `<button onclick="mBTDB.autoFillWidget('${widget.type}', '${doc.id}')" class="p-1.5 text-purple-600 hover:bg-purple-50 rounded-md transition-all">${this.icons.wand}</button>`;
        return `<div class="grid-stack-item-content group"><div class="widget-header flex justify-between items-center p-2 bg-white border-b border-slate-50"><input value="${cleanTitle}" onchange="mBTDB.updateWidgetLabel('${doc.id}', '${widget.id}', this.value)" class="bg-transparent border-none font-black text-[10px] uppercase tracking-widest text-slate-500 w-32 outline-none focus:text-blue-600 transition-colors"><div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">${tools}<button onclick="mBTDB.deleteWidget('${widget.id}')" class="p-1.5 hover:text-red-600 transition-colors">${this.icons.trash}</button></div></div><div class="widget-body flex-grow overflow-y-auto no-scrollbar relative text-slate-800 h-full bg-white">${this._getContentForWidget(widget, doc)}</div></div>`;
    },
    _getContentForWidget: function(widget, doc) {
        const data = doc.content.data;
        if (widget.type === 'contacts') return this._renderContacts(doc.id, data, widget);
        if (['logistics', 'locations'].includes(widget.type)) return this._renderLogistics(doc.id, data);
        if (widget.type === 'schedule') return this._renderSchedule(doc.id, data);
        if (widget.type === 'crew') return this._renderCrew(doc.id, data);
        if (widget.type === 'cast') return this._renderTalent(doc.id, data);
        if (widget.type === 'richText') return this._renderRichText(doc.id, widget.id, data);
        if (widget.type === 'image') return this._renderImage(doc.id, widget.id, data);
        return '';
    },
    _renderMetaHeader: function(doc) {
        const d = doc.content.data;
        const html = `<div class="flex flex-wrap gap-4 items-end justify-between px-2"><div class="w-full sm:w-auto flex-grow"><input value="${d.meta.productionTitle || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionTitle', this.value)" class="text-3xl font-black uppercase w-full outline-none text-slate-900 bg-transparent mb-1 tracking-tighter" placeholder="PRODUCTION TITLE"><div class="flex gap-4"><div class="flex items-center gap-1.5"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Date</span><input type="date" value="${d.meta.shootDate}" onchange="mBTDB.updateData('${doc.id}', 'meta.shootDate', this.value); mBTDB.renderFrame();" class="mbt-input w-auto font-bold border-none bg-slate-50 px-2 rounded-md"></div><div class="flex items-center gap-1.5"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Call</span><input type="text" value="${d.meta.crewCallTime}" onchange="mBTDB.updateData('${doc.id}', 'meta.crewCallTime', this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input w-16 bg-yellow-300 font-black border-none text-center rounded-md" placeholder="00:00"></div><div class="flex items-center gap-1.5 bg-slate-100 px-2.5 py-0.5 rounded-md"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Day</span><span class="text-xs font-black text-slate-800">${this.calcShootDay(d.meta.shootDate)}</span></div></div></div><div class="w-48 text-right"><input value="${d.meta.productionCompany || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionCompany', this.value)" class="mbt-input text-right font-bold border-none text-slate-500 italic" placeholder="Production Company"></div></div>`;
        const container = document.getElementById('mBTDB_MetaArea'); if(container) container.innerHTML = html;
    },
    _renderContacts: function(docId, d, widget) {
        const gridClass = widget.vertical ? "grid-cols-1" : "grid-cols-1 sm:grid-cols-3";
        const renderField = (path, val, label, role) => `<div class="relative group"><div class="flex justify-between items-center mb-1"><div class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${label}</div><div class="cursor-pointer text-slate-300 hover:text-blue-500 transition-colors" onclick="mBTDB.pullFromOpenGate('${docId}', '${path}', '${role}')">${this.icons.user}</div></div><input value="${val||''}" onchange="mBTDB.updateData('${docId}', '${path}', this.value)" class="mbt-input font-bold border-slate-100 hover:border-slate-300 focus:bg-white transition-all"></div>`;
        return `<div class="grid ${gridClass} gap-4 p-4 h-full overflow-y-auto no-scrollbar">${renderField('contacts.director', d.contacts.director, 'Director', 'director')}${renderField('contacts.producer', d.contacts.producer, 'Producer', 'producer')}${renderField('contacts.ad', d.contacts.ad, '1st AD', 'ad')}</div>`;
    },
    _renderLogistics: function(docId, d) {
        return `<div class="flex flex-col h-full"><div class="px-4 py-2 border-b border-slate-100 bg-slate-50/50 flex gap-2 items-center justify-between"><div class="flex items-center gap-2"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Sun Cycles:</span><input value="${d.meta.sunriseSunset||''}" onchange="mBTDB.updateData('${docId}','meta.sunriseSunset',this.value)" class="bg-transparent text-[10px] font-bold w-32 outline-none" placeholder="06:00 / 18:00"></div></div><div class="flex-grow overflow-y-auto p-4 space-y-4 no-scrollbar">${(d.locations||[]).map((l,i) => `<div class="flex flex-wrap gap-4 items-start border-b border-slate-50 pb-4 mb-2"><div class="w-full sm:w-1/3 space-y-2"><input value="${l.name}" onchange="mBTDB.updateRow('${docId}','locations',${i},'name',this.value)" class="mbt-input font-black uppercase text-xs" placeholder="LOCATION NAME"><input type="text" value="${l.timeOnLocation||''}" onchange="mBTDB.updateRow('${docId}','locations',${i},'timeOnLocation',this.value)" class="mbt-input text-[10px]" placeholder="Time at Location"></div><div class="w-full sm:w-1/3"><textarea onchange="mBTDB.updateRow('${docId}','locations',${i},'address',this.value)" class="mbt-input h-20 resize-none text-[10px] leading-relaxed" placeholder="Full Address...">${l.address}</textarea></div><div class="w-full sm:w-1/4 flex-grow"><div class="relative"><textarea onchange="mBTDB.updateRow('${docId}','locations',${i},'weather',this.value)" class="mbt-input h-20 resize-none text-[10px] bg-blue-50/30 border-blue-100" placeholder="Weather Forecast...">${l.weather}</textarea><button id="w-btn-${i}" onclick="mBTDB.autoFillWeather('${docId}', ${i}, '${l.name}')" class="absolute bottom-2 right-2 bg-white text-blue-600 p-1.5 rounded-lg shadow-sm border border-blue-100 hover:bg-blue-600 hover:text-white transition-all">${this.icons.cloud}</button></div></div></div>`).join('')}<button onclick="mBTDB.addRow('${docId}','locations','loc')" class="w-full py-2 bg-white text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-blue-600 hover:border-blue-200 rounded-xl border border-dashed border-slate-200 transition-all flex items-center justify-center gap-2">${this.icons.plus} Add Location</button></div></div>`;
    },
    _renderSchedule: function(docId, d) {
        return `<div class="h-full flex flex-col"><div class="flex-grow overflow-auto no-scrollbar"><table class="w-full text-[10px] border-collapse min-w-[700px]"><thead><tr class="bg-slate-50 text-slate-400 font-black uppercase tracking-tighter"><th class="p-2 w-16 text-center">Time</th><th class="p-2 w-12 text-center">Scn</th><th class="p-2 text-left">Description / Scene Note</th><th class="p-2 w-32 text-left">Cast</th><th class="p-2 w-12 text-center">I/E</th><th class="p-2 w-32 text-left">Location</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-slate-50">${d.schedule.map((row, i) => `<tr class="${row.type==='meal'?'bg-amber-50/50':''}"><td><input value="${row.time}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'time',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center font-black text-slate-900 bg-transparent border-0 outline-none"></td>${row.type==='meal'? `<td colspan="4"><input value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="w-full text-center font-black uppercase text-amber-700 bg-transparent border-0 outline-none tracking-widest"></td>`: `<td><input value="${row.scene}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'scene',this.value)" class="w-full text-center font-bold bg-transparent border-0 outline-none"></td><td><input value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="w-full bg-transparent border-0 outline-none font-medium px-2"></td><td><input value="${row.cast}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'cast',this.value)" class="w-full bg-transparent border-0 outline-none italic"></td><td><input value="${row.ie}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'ie',this.value)" class="w-full text-center text-[9px] font-black uppercase bg-transparent border-0 outline-none"></td>`}<td><input value="${row.loc}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'loc',this.value)" class="w-full bg-transparent border-0 outline-none text-slate-500"></td><td class="text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','schedule',${i}, 'schedule')" class="text-slate-200 hover:text-red-500 transition-colors">${this.icons.trash}</button></td></tr>`).join('')}</tbody></table></div><div class="flex gap-2 p-2 bg-slate-50/50 border-t border-slate-100 widget-controls"><button onclick="mBTDB.addRow('${docId}','schedule','shot')" class="flex-1 bg-white border border-slate-200 text-emerald-600 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl hover:shadow-sm transition-all">+ Add Shot</button><button onclick="mBTDB.addRow('${docId}','schedule','meal')" class="flex-1 bg-white border border-slate-200 text-amber-600 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl hover:shadow-sm transition-all">+ Add Meal</button></div></div>`;
    },
    _renderCrew: function(docId, d) {
        return `<div class="h-full flex flex-col"><div class="flex-grow overflow-auto no-scrollbar"><table class="w-full text-[10px] border-collapse"><thead><tr class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest"><th class="p-2 text-left">Department</th><th class="p-2 text-left">Position</th><th class="p-2 text-left">Name</th><th class="p-2 text-left">Contact</th><th class="p-2 w-20 text-center">Call</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-slate-50">${(d.crew||[]).map((c,i) => `<tr class="hover:bg-slate-50/30 transition-colors"><td class="p-1"><input value="${c.department||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'department',this.value)" class="w-full font-black uppercase text-[9px] text-slate-400 bg-transparent border-0 outline-none"></td><td class="p-1"><input value="${c.position||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'position',this.value)" class="w-full font-bold text-slate-700 bg-transparent border-0 outline-none"></td><td class="p-1"><div class="relative flex items-center"><input value="${c.name||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'name',this.value)" class="w-full font-black text-slate-900 bg-transparent border-0 outline-none"><div class="cursor-pointer text-slate-200 hover:text-blue-500 ml-1" onclick="mBTDB.pullFromOpenGate('${docId}','crew.${i}.name','${c.position||'crew'}')">${this.icons.user}</div></div></td><td class="p-1"><input value="${c.contact||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'contact',this.value)" class="w-full text-[9px] text-slate-500 bg-transparent border-0 outline-none font-mono"></td><td class="p-1"><input type="text" value="${c.callTime||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'callTime',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center font-black bg-transparent border-0 outline-none text-blue-600"></td><td class="p-1 text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','crew',${i}, 'crew')" class="text-slate-200 hover:text-red-500">${this.icons.trash}</button></td></tr>`).join('')}</tbody></table></div><div class="p-2 border-t border-slate-100 widget-controls bg-slate-50/30"><button onclick="mBTDB.addRow('${docId}','crew','person')" class="w-full bg-white border border-slate-200 text-slate-500 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl transition-all hover:text-blue-600">+ Add Crew Member</button></div></div>`;
    },
    _renderTalent: function(docId, d) {
        return `<div class="h-full flex flex-col"><div class="flex-grow overflow-auto no-scrollbar"><table class="w-full text-[10px] border-collapse min-w-[500px]"><thead><tr class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest"><th class="p-2 text-left">Character</th><th class="p-2 text-left">Actor Name</th><th class="p-2 text-left">Contact</th><th class="p-2 w-10 text-center">Status</th><th class="p-2 w-16 text-center">PU</th><th class="p-2 w-16 text-center">HMU</th><th class="p-2 w-16 text-center text-blue-600">SET</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-slate-50">${(d.cast||[]).map((c,i) => `<tr><td class="p-1"><input value="${c.character||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'character',this.value)" class="w-full font-bold text-slate-500 bg-transparent border-0 outline-none px-2"></td><td class="p-1"><div class="relative flex items-center"><input value="${c.actor||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'actor',this.value)" class="w-full font-black text-slate-900 bg-transparent border-0 outline-none"><div class="cursor-pointer text-slate-200 hover:text-blue-500 ml-1" onclick="mBTDB.pullFromOpenGate('${docId}','cast.${i}.actor','actor')">${this.icons.user}</div></div></td><td class="p-1"><input value="${c.contact||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'contact',this.value)" class="w-full text-[9px] font-mono bg-transparent border-0 outline-none text-slate-400"></td><td class="p-1"><input value="${c.status||'W'}" onchange="mBTDB.updateRow('${docId}','cast',${i},'status',this.value)" class="w-full text-center font-black uppercase bg-transparent border-0 outline-none"></td><td class="p-1"><input type="text" value="${c.pickup||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'pickup',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center bg-transparent border-0 outline-none"></td><td class="p-1"><input type="text" value="${c.hmu||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'hmu',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center bg-transparent border-0 outline-none"></td><td class="p-1"><input type="text" value="${c.setCall||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'setCall',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center font-black bg-yellow-100 rounded border-0 outline-none text-slate-900"></td><td class="p-1 text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','cast',${i}, 'cast')" class="text-slate-200 hover:text-red-500">${this.icons.trash}</button></td></tr>`).join('')}</tbody></table></div><div class="p-2 border-t border-slate-100 widget-controls bg-slate-50/30"><button onclick="mBTDB.addRow('${docId}','cast','talent')" class="w-full bg-white border border-slate-200 text-slate-500 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl hover:text-purple-600 transition-all">+ Add Talent</button></div></div>`;
    },
    _renderRichText: function(docId, widgetId, data) {
        const val = data.additional ? data.additional[widgetId] : (data[widgetId] || "");
        return `<div class="h-full flex flex-col p-2"><div class="flex-grow relative"><textarea onchange="mBTDB.updateData('${docId}', 'additional.${widgetId}', this.value)" class="w-full h-full p-2 text-xs text-slate-800 bg-transparent border-0 outline-none resize-none font-medium leading-relaxed" placeholder="Type notes...">${val||''}</textarea></div></div>`;
    },
    // Logic Resolution: New Image Rendering Logic with Optimization
    _renderImage: function(docId, widgetId, data) {
        const val = data.additional ? data.additional[widgetId] : (data[widgetId] || "");
        
        if (val) {
            // Image Display State
            return `
            <div class="relative w-full h-full group bg-slate-50 flex items-center justify-center overflow-hidden">
                <img src="${val}" class="max-w-full max-h-full object-contain">
                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                    <button onclick="document.getElementById('file_${widgetId}').click()" class="bg-white text-slate-900 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-blue-50">Change</button>
                    <button onclick="mBTDB.updateData('${docId}', 'additional.${widgetId}', '')" class="bg-white text-rose-600 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-rose-50">Remove</button>
                </div>
                <input type="file" id="file_${widgetId}" accept="image/*" class="hidden" onchange="mBTDB._handleImageUpload(this, '${docId}', '${widgetId}')">
            </div>`;
        } else {
            // Empty State
            return `
            <div class="w-full h-full flex flex-col items-center justify-center bg-slate-50 hover:bg-blue-50/50 transition-colors border-2 border-dashed border-slate-100 hover:border-blue-200 cursor-pointer p-4 group" onclick="document.getElementById('file_${widgetId}').click()">
                <div class="text-slate-300 group-hover:text-blue-400 mb-2 scale-125 transition-transform group-hover:scale-150">${this.icons.image}</div>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest group-hover:text-blue-500">Upload Image</span>
                <input type="file" id="file_${widgetId}" accept="image/*" class="hidden" onchange="mBTDB._handleImageUpload(this, '${docId}', '${widgetId}')">
            </div>`;
        }
    },
    // Logic Resolution: Automatic image resizing to protect LocalStorage limits
    _handleImageUpload: function(input, docId, widgetId) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        // Size Limit Check (2MB raw)
        if (file.size > 2 * 1024 * 1024) {
            if(!confirm("Large image detected. It will be compressed to save space. Continue?")) return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                // Constraint: Max width 800px for storage efficiency
                const MAX_WIDTH = 800;
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Compress to JPEG 0.7 quality
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                this.updateData(docId, `additional.${widgetId}`, dataUrl);
                this.renderFrame();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    },

    // --- 5. Navigation & Logic Controllers ---
    toggleVertical: function(wid) { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const w = doc.content.widgets.find(x => x.id === wid); if(w) { w.vertical = !w.vertical; this.renderFrame(); } },
    updateWidgetLabel: function(docId, widgetId, newLabel) { const doc = budget.documents.find(d => d.id === docId); const w = doc.content.widgets.find(x => x.id === widgetId); if(w) { w.label = newLabel; this._triggerSave(); } },
    updateData: function(docId, path, value) { const doc = budget.documents.find(d => d.id === docId); const parts = path.split('.'); let target = doc.content.data; for(let i=0; i<parts.length-1; i++) { if(!target[parts[i]]) target[parts[i]]={}; target = target[parts[i]]; } target[parts[parts.length-1]] = value; this._triggerSave(); },
    updateRow: function(docId, section, index, key, value) { const doc = budget.documents.find(d => d.id === docId); if(doc.content.data[section][index]) { doc.content.data[section][index][key] = value; this._triggerSave(); const type = (section === 'locations') ? 'logistics' : section; const widget = doc.content.widgets.find(w => w.type === type); if(widget) this._autoResizeWidget(widget.id); } },
    addRow: function(docId, section, type, presetData) { const doc = budget.documents.find(d => d.id === docId); if(!doc.content.data[section]) doc.content.data[section] = []; let newRow = presetData || { id: Date.now() }; if(!presetData) { if(section==='schedule') newRow = { ...newRow, type, time:"", scene:"", description: type==='meal'?"LUNCH":"New Shot", cast:"", ie:"", loc:"", note:"" }; else if(section==='cast') newRow = { ...newRow, character:"", actor:"", status:"W", pickup:"", hmu:"", setCall:"", contact:"" }; else if(section==='crew') newRow = { ...newRow, department:"", position:"", name:"", contact:"", callTime:"" }; else if(section==='locations') newRow = { ...newRow, name:"", address:"", weather:"", hospital:"", mapLink:"", timeOnLocation:"" }; } doc.content.data[section].push(newRow); this._triggerSave(); this.renderFrame(); const widget = doc.content.widgets.find(w => w.type === (section === 'locations' ? 'logistics' : section)); if(widget) this._autoResizeWidget(widget.id); },
    deleteRow: function(docId, section, index, widgetType) { const doc = budget.documents.find(d => d.id === docId); doc.content.data[section].splice(index, 1); this._triggerSave(); this.renderFrame(); const widget = doc.content.widgets.find(w => w.type === (widgetType || section)); if(widget) this._autoResizeWidget(widget.id); },
    deleteWidget: function(id) { if(!confirm("Delete widget?")) return; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const el = document.querySelector(`.grid-stack-item[gs-id="${id}"]`); if(el) this.state.grid.removeWidget(el); doc.content.widgets = doc.content.widgets.filter(w => w.id !== id); this._triggerSave(); },
    addWidget: function() {
        const select = document.getElementById('mBTDB_WidgetSelect');
        if(!select) return;
        const type = select.value;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const w = { id: type+'_'+Date.now(), type, w: 6, h: 4, autoPosition: true, label: type.toUpperCase() };
        const html = this._generateWidgetHTML(w, doc);
        const node = this.state.grid.addWidget({ w: 6, h: 4, content: html, id: w.id, autoPosition: true });
        w.x = node.gridstackNode.x; w.y = node.gridstackNode.y;
        doc.content.widgets.push(w);
        this._triggerSave();
    },
    _autoResizeWidget: function(widgetId) { const el = document.querySelector(`.grid-stack-item[gs-id="${widgetId}"]`); if(!el) return; const body = el.querySelector('.widget-body'); if(!body) return; const currentHeight = body.style.height; body.style.height = 'auto'; const contentHeight = body.scrollHeight + 45; body.style.height = currentHeight; let newH = Math.ceil(contentHeight / 60); if(newH < 3) newH = 3; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const w = doc.content.widgets.find(x => x.id === widgetId); if(w && w.h !== newH) { w.h = newH; this.state.grid.update(el, { h: newH }); this._triggerSave(); } },
    formatTime: function(el) { let val = el.value.replace(/[^0-9]/g, ''); if(val.length === 4) { el.value = val.substring(0,2) + ':' + val.substring(2,4); el.dispatchEvent(new Event('change')); } },
    saveTemplate: function() { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const name = prompt("Template Name:", doc.label + " Preset"); if(!name) return; const tmpl = { id: 'tmpl_' + Date.now(), label: name, widgets: JSON.parse(JSON.stringify(doc.content.widgets)) }; if(!budget.templates) budget.templates = []; budget.templates.push(tmpl); alert(`Template "${name}" saved.`); },
    calcShootDay: function(dateStr) { if(!budget.startDate) return "Day 1"; const start = new Date(budget.startDate); const current = new Date(dateStr); if(isNaN(start) || isNaN(current)) return "Day 1"; const diffDays = Math.ceil((current - start) / (1000 * 60 * 60 * 24)) + 1; return `Day ${diffDays}`; },
    syncFromBudget: function() { if(!confirm("Synchronization with Budget details?")) return; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const defaults = this._generateDefaultData(); doc.content.data.crew = defaults.crew; doc.content.data.contacts = defaults.contacts; mBTLE.reconcile(); this.renderFrame(); },
    syncFromPrevious: function() { alert("Environmental cache resolution pending..."); },
    snapshotDoc: function() { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const newDoc = JSON.parse(JSON.stringify(doc)); newDoc.id = 'doc_' + Date.now(); newDoc.label = doc.label + " (Copy)"; budget.documents.push(newDoc); mBTDB.open(newDoc.id); },
    pullFromOpenGate: function(docId, path, roleQuery) { if (typeof mBTOG === 'undefined') return alert("Database Resolution Failure."); const matches = mBTOG.contacts.filter(c => c.role?.toLowerCase().includes(roleQuery.toLowerCase())); if (matches.length === 0) return alert(`No ${roleQuery} found.`); const apply = (c) => { const parts = path.split('.'); if(parts.length === 3 && (parts[0] === 'crew' || parts[0] === 'cast')) { this.updateRow(docId, parts[0], parseInt(parts[1]), parts[2], c.name); if(c.contact) this.updateRow(docId, parts[0], parseInt(parts[1]), 'contact', c.contact); } else { this.updateData(docId, path, `${c.name} ${c.contact ? '('+c.contact+')' : ''}`); } this.renderFrame(); }; if (matches.length === 1) apply(matches[0]); else { const choice = prompt(matches.map((c,i)=>`${i+1}. ${c.name}`).join('\n')); const idx = parseInt(choice)-1; if(matches[idx]) apply(matches[idx]); } },
    printToPDF: function(mode) { if (typeof mBTPublisher === 'undefined') return alert("Publisher Resolution Failure."); const original = document.getElementById('mBTDB_Workspace'); const clone = original.cloneNode(true); clone.id = "mBTDB_Print_Container"; clone.classList.remove('editing-mode'); clone.classList.add('print-container', mode === 'standard' ? 'print-standard' : 'print-graphic'); const originalInputs = original.querySelectorAll('input, textarea'); const cloneInputs = clone.querySelectorAll('input, textarea'); originalInputs.forEach((input, i) => { if(cloneInputs[i]) cloneInputs[i].value = input.value; }); document.body.appendChild(clone); mBTPublisher.exportToPDF('mBTDB_Print_Container', `${budget.projectName}_CallSheet`); setTimeout(() => { document.body.removeChild(clone); }, 2000); },
    // --- 6. Switchboard Integration ---
    _updateHeaderButtons: function() {
        const btnContainer = document.getElementById('mBTDB_Buttons'); if(!btnContainer) return; const isEd = this.state.isEditing;
        const previewMenu = `<div class="relative inline-block"><button onclick="this.nextElementSibling.classList.toggle('hidden');" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-700 flex items-center gap-2 transition-all outline-none"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>Preview</button><div class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-2xl border border-slate-100 z-[9999] overflow-hidden"><button onclick="mBTDB.previewDoc('standard'); this.parentElement.classList.add('hidden')" class="flex items-center gap-3 w-full text-left px-4 py-3 text-[10px] text-slate-600 hover:bg-blue-50 hover:text-blue-700 font-black uppercase tracking-widest border-b border-slate-50 transition-colors">Standard Layout</button><button onclick="mBTDB.previewDoc('graphic'); this.parentElement.classList.add('hidden')" class="flex items-center gap-3 w-full text-left px-4 py-3 text-[10px] text-slate-600 hover:bg-blue-50 hover:text-blue-700 font-black uppercase tracking-widest transition-colors">Graphic View</button></div></div>`;
        btnContainer.innerHTML = `<div class="flex gap-1 mr-4 border-r border-slate-700 pr-4"><button onclick="mBTDB.undo()" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition-colors" title="Undo">${this.icons.undo}</button><button onclick="mBTDB.redo()" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition-colors" title="Redo">${this.icons.redo}</button><button onclick="mBTDB.snapshotDoc()" class="p-2 hover:bg-blue-900/50 rounded-lg text-blue-400 transition-colors" title="Clone">${this.icons.copy}</button><button onclick="mBTDB.saveTemplate()" class="p-2 hover:bg-emerald-900/50 rounded-lg text-emerald-400 transition-colors" title="Save Template">${this.icons.save}</button></div>${isEd ? `<div class="flex items-center bg-slate-800 rounded-lg px-2 mr-2"><select id="mBTDB_WidgetSelect" class="bg-transparent text-[9px] font-black uppercase tracking-widest text-white h-8 outline-none cursor-pointer"><option value="richText">Note Block</option><option value="image">Image Container</option><option value="schedule">Schedule</option><option value="cast">Cast List</option><option value="crew">Crew List</option><option value="logistics">Logistics</option><option value="contacts">Contacts</option></select><button onclick="mBTDB.addWidget()" class="text-emerald-400 p-2 hover:scale-110 transition-transform">${this.icons.plus}</button></div>` : ''}<button onclick="mBTDB.toggleEditMode()" class="px-4 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest shadow-lg transition-all ${isEd ? 'bg-emerald-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-500'}">${isEd ? 'Save Layout' : 'Modify Layout'}</button>${previewMenu}<button onclick="mBTDB.close()" class="bg-red-900/80 text-red-200 p-2 rounded-lg hover:bg-red-600 hover:text-white transition-all ml-2">${this.icons.close}</button>`;
    },
    _triggerSave: function() {
        if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
        if(typeof saveBudget === 'function') saveBudget();
    },
    _generateDefaultData: function() {
        return { meta: { productionTitle: budget.projectName||"", productionCompany: budget.company||"", shootDate: new Date().toISOString().split('T')[0], crewCallTime: "08:00" }, contacts: { director: "", producer: "", ad: "" }, schedule: [], crew: [], cast: [], locations: [{name:"Base Camp", address:"", weather:"", hospital:"", mapLink:""}], additional: {} };
    }
};

    /* ======= TIER 5: Part 2: Module Controllers & Intelligence ======== */
    // --- ROOT NAMESPACE DECLARATION ---
    // Note: Namespace definition hoisted to Tier 1. 
    // We extend it here for Feature modules.

    /* ========= v19.65 BLUEPRINT ENGINE (mBT.features.blueprints) ========= */
    mBT.features.blueprints = {
        saveCurrentAsBlueprint: function() {
            if (!budget) return;
            const name = prompt("Name this Blueprint:", budget.projectName + " Template");
            if (!name) return;

            const structure = [];
            Object.values(budget.sections).forEach(sec => {
                structure.push({
                    id: sec.id,
                    name: sec.name,
                    items: sec.items.map(i => ({
                        description: i.description,
                        unit: i.unit,
                        rate: i.rate,
                        multiplier: i.multiplier,
                        rateType: i.rateType
                        // Note: We strip actuals, crew, and transient IDs to create a clean template
                    }))
                });
            });

            mBT.data.templates.saveTemplate(name, { 
                structure: structure, 
                label: name, 
                desc: 'Custom User Blueprint',
                icon: 'file'
            });
            
            alert(`Blueprint "${name}" saved! It is now available in the New Project menu.`);
        }
    };
    
    // Core Action Binding for Blueprint
    mBT.core.action('blueprint-save', () => mBT.features.blueprints.saveCurrentAsBlueprint());

    /* ========= v19.55 RECYCLE BIN (mBT.features.trash) ========= */
		mBT.features.trash = {
        state: { activeTab: 'documents', selected: new Set() },
        icons: { folder: mBTAssets.folder, file: mBTAssets.file, trash: mBTAssets.trash, undo: mBTAssets.undo, check: mBTAssets.target },
      
        open: function(tab = 'documents') {
            const currentTab = this.state.activeTab;
            // Logic Resolution: Clear selections only when switching context
            if (tab !== currentTab) this.state.selected.clear();
            this.state.activeTab = tab;

            const type = this.state.activeTab;
            const docTrash = budget.documentTrash || [];
            const projectTrash = JSON.parse(localStorage.getItem(trashKey) || '[]');
            
            const items = type === 'documents' ? docTrash : projectTrash;
            const selectedCount = this.state.selected.size;
            const hasItems = items.length > 0;

            const tabHtml = RenderEngine.ui.tabs({
                items: [
                    { id: 'documents', label: 'Documents', count: docTrash.length },
                    { id: 'projects', label: 'Projects', count: projectTrash.length }
                ],
                activeId: type,
                onClick: 'mBT.features.trash.open' 
            });

            // Logic Resolution: Dynamic Toolbar for Bulk Actions with Checkbox Logic
            const toolbarHtml = `
                <div class="px-4 py-3 bg-white border-b border-slate-100 flex items-center justify-between sticky top-0 z-20 shadow-sm">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" 
                               onchange="mBT.features.trash.toggleAll(this.checked)" 
                               ${hasItems && selectedCount === items.length ? 'checked' : ''} 
                               ${!hasItems ? 'disabled' : ''}
                               class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        <span class="text-[9px] font-black uppercase tracking-widest text-slate-400">${selectedCount} Selected</span>
                    </div>
                    <div class="flex gap-2">
                        ${selectedCount > 0 ? `
                            <button onclick="mBT.features.trash.performAction('restore')" class="px-3 py-1.5 bg-emerald-50 text-emerald-600 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-emerald-100 transition-all flex items-center gap-1">${this.icons.undo} Restore</button>
                            <button onclick="mBT.features.trash.performAction('delete')" class="px-3 py-1.5 bg-rose-50 text-rose-600 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-rose-100 transition-all flex items-center gap-1">${this.icons.trash} Delete</button>
                        ` : `
                            <button onclick="mBT.features.trash.performAction('empty')" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-rose-50 hover:text-rose-600 transition-all" ${!hasItems ? 'disabled style="opacity:0.5"' : ''}>Empty Bin</button>
                        `}
                    </div>
                </div>`;

            let listHtml = '';
            
            if (!hasItems) {
                listHtml = RenderEngine.ui.emptyState({
                    icon: this.icons.trash,
                    message: 'Bin is Empty',
                    subtext: type === 'documents' ? 'No deleted documents found' : 'No deleted projects found'
                });
            } else {
                listHtml = items.map(item => {
                    const id = type === 'documents' ? item.id : item.projectName; // Projects use name as ID in trash
                    const isSel = this.state.selected.has(id);
                    const label = type === 'documents' ? (item.label || item.name || 'Untitled') : (item.projectName || 'Untitled Project');
                    const meta = type === 'documents' ? `Type: ${item.type || 'Custom'}` : `Company: ${item.company || 'Indie'}`;
                    
                    return `
                    <div class="flex items-center justify-between p-3 bg-white border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors group cursor-pointer" onclick="mBT.features.trash.toggleItem('${RenderEngine.esc(id)}')">
                        <div class="flex items-center gap-3 overflow-hidden flex-grow">
                            <div class="flex-shrink-0" onclick="event.stopPropagation(); mBT.features.trash.toggleItem('${RenderEngine.esc(id)}');">
                                <input type="checkbox" ${isSel ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 pointer-events-none">
                            </div>
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-white group-hover:text-blue-500 group-hover:shadow-sm transition-all text-lg shrink-0">
                                ${type === 'documents' ? this.icons.file : this.icons.folder}
                            </div>
                            <div class="overflow-hidden min-w-0">
                                <div class="text-[10px] font-black uppercase text-slate-700 truncate">${RenderEngine.esc(label)}</div>
                                <div class="text-[9px] text-slate-400 font-bold truncate">${RenderEngine.esc(meta)}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                            <button onclick="event.stopPropagation(); mBT.features.trash.singleAction('restore', '${RenderEngine.esc(id)}')" class="p-2 text-slate-300 hover:text-emerald-500 transition-colors" title="Restore">${this.icons.undo}</button>
                            <button onclick="event.stopPropagation(); mBT.features.trash.singleAction('delete', '${RenderEngine.esc(id)}')" class="p-2 text-slate-300 hover:text-rose-500 transition-colors" title="Delete Forever">${this.icons.trash}</button>
                        </div>
                    </div>`;
                }).join('');
            }

            // Logic Resolution: Persistent UI Updates (Prevents Flickering/Re-opening)
            const domId = 'trashModal';
            const existingModal = document.getElementById(domId);
            
            if (existingModal) {
                const nav = document.getElementById('trashTabNav');
                const tool = document.getElementById('trashToolbarArea');
                const list = document.getElementById('trashListArea');
                
                if (nav) nav.innerHTML = tabHtml;
                if (tool) tool.innerHTML = toolbarHtml;
                if (list) list.innerHTML = listHtml;
                return;
            }

            const content = `
                <div class="flex flex-col h-[600px] max-h-[80vh]">
                    <div id="trashTabNav">${tabHtml}</div>
                    <div id="trashToolbarArea">${toolbarHtml}</div>
                    <div id="trashListArea" class="flex-grow overflow-y-auto p-4 bg-slate-50 no-scrollbar space-y-2">
                        ${listHtml}
                    </div>
                </div>`;
            mBTME.open('trash', 'Recycle Bin', content, 'max-w-lg', { noPadding: true, hideHeader: true });
        },
        
        // --- Selection Logic ---
        toggleItem: function(id) {
            if (this.state.selected.has(id)) this.state.selected.delete(id);
            else this.state.selected.add(id);
            this.open(this.state.activeTab); // Re-render state
        },
        toggleAll: function(checked) {
            this.state.selected.clear();
            if (checked) {
                const list = this.state.activeTab === 'documents' ? (budget.documentTrash||[]) : JSON.parse(localStorage.getItem(trashKey)||'[]');
                list.forEach(i => this.state.selected.add(this.state.activeTab === 'documents' ? i.id : i.projectName));
            }
            this.open(this.state.activeTab);
        },

        // --- Action Routers ---
        singleAction: function(action, id) {
            this.state.selected.clear();
            this.state.selected.add(id);
            this.performAction(action);
        },
        
        performAction: function(action) {
            const isDoc = this.state.activeTab === 'documents';
            const count = this.state.selected.size;
            
            // Empty Bin Logic
            if (action === 'empty') {
                if(!confirm(`WARNING: This will permanently DELETE ALL items in the ${isDoc?'Documents':'Projects'} bin.\n\nThis cannot be undone.\n\nProceed?`)) return;
                if(isDoc) budget.documentTrash = [];
                else localStorage.setItem(trashKey, '[]');
                saveBudget();
                this.open(this.state.activeTab);
                return;
            }

            if (count === 0) return;

            // Delete / Restore Logic
            if (action === 'delete') {
                if(!confirm(`WARNING: ${count} item(s) will be DELETED FOREVER.\n\nThis action cannot be undone.\n\nConfirm deletion?`)) return;
                if(isDoc) {
                    budget.documentTrash = budget.documentTrash.filter(d => !this.state.selected.has(d.id));
                    saveBudget();
                } else {
                    const list = JSON.parse(localStorage.getItem(trashKey)||'[]');
                    const filtered = list.filter(p => !this.state.selected.has(p.projectName));
                    localStorage.setItem(trashKey, JSON.stringify(filtered));
                }
            } else if (action === 'restore') {
                if(!confirm(`Restore ${count} items?`)) return;
                if(isDoc) {
                    const toRestore = budget.documentTrash.filter(d => this.state.selected.has(d.id));
                    budget.documentTrash = budget.documentTrash.filter(d => !this.state.selected.has(d.id));
                    if(!budget.documents) budget.documents = [];
                    budget.documents.push(...toRestore);
                    saveBudget();
                    render(); // Refresh main view to show restored docs
                } else {
                    const list = JSON.parse(localStorage.getItem(trashKey)||'[]');
                    const keptTrash = [];
                    list.forEach(p => {
                        if(this.state.selected.has(p.projectName)) {
                            const key = storageKeyPrefix + p.projectName;
                            // Check collision
                            if(localStorage.getItem(key)) {
                                if(confirm(`Project "${p.projectName}" already exists. Overwrite?`)) {
                                    localStorage.setItem(key, JSON.stringify(p));
                                } else {
                                    keptTrash.push(p); // Keep in trash if user cancels overwrite
                                }
                            } else {
                                localStorage.setItem(key, JSON.stringify(p));
                            }
                        } else {
                            keptTrash.push(p);
                        }
                    });
                    localStorage.setItem(trashKey, JSON.stringify(keptTrash));
                    if(typeof renderProjectManagement === 'function') renderProjectManagement(); // Refresh project dropdown
                }
            }
            
            this.state.selected.clear();
            this.open(this.state.activeTab);
        },

        // --- External Hooks ---
        trashDocument: function(docId) {
            if(!confirm("Move document to Recycle Bin?")) return;
            const idx = budget.documents.findIndex(d => d.id === docId);
            if (idx > -1) {
                const doc = budget.documents.splice(idx, 1)[0];
                if (!budget.documentTrash) budget.documentTrash = [];
                budget.documentTrash.push(doc);
                saveBudget();
                render(); // Update Vault UI if open
                if (document.getElementById('documentsModal')) showDocumentsModal();
            }
        }
    };
    
    // --- Backward Compatibility Alias (for buttons using old global names) ---
    window.mBTTrash = mBT.features.trash;


    /* ========= v19.60 SETTINGS & CONFIGURATION (mBT.features.settings) ========= */
    mBT.features.settings = {
        
        // --- 1. Sub-View Generators ---
        renderDbView: function(subTab) {
            if (subTab === 'contacts') {
                const globalContacts = mBTOG.contacts || [];
                const assignedContacts = [];
                Object.values(budget.sections || {}).forEach(sec => {
                    sec.items.forEach(item => {
                        if (item.crew && item.crew.name) {
                            assignedContacts.push({
                                id: 'assigned_' + item.id,
                                name: item.crew.name,
                                role: item.description || 'Crew',
                                phone: item.crew.phone || '',
                                email: item.crew.email || '',
                                assigned: true
                            });
                        }
                    });
                });
                const allContacts = [...globalContacts];
                assignedContacts.forEach(ac => {
                    if (!allContacts.some(gc => gc.name.toLowerCase() === ac.name.toLowerCase())) {
                        allContacts.push(ac);
                    }
                });

                const listContent = allContacts.length > 0 ? allContacts.map(c => RenderEngine.ui.listRow({
                    id: c.id,
                    icon: c.name ? c.name.charAt(0).toUpperCase() : '?',
                    title: c.name,
                    subtitle: `${c.role || 'No Role'}${c.assigned ? ' (Assigned)' : ''}`,
                    actions: c.assigned ? [] : [{
                        icon: mBTAssets.trash,
                        title: 'Delete',
                        color: 'rose',
                        onClick: `mBT.features.settings.deleteContact('${c.id}')`
                    }]
                })).join('') : RenderEngine.ui.emptyState({ icon: mBTAssets.user, message: 'No Contacts Found' });

                return `
                    <div class="flex flex-col h-full bg-white overflow-hidden rounded-xl border border-slate-100 shadow-sm">
                        <div class="p-3 bg-indigo-50 border-b border-indigo-100 flex flex-col gap-3 shrink-0 z-10">
                            <div class="flex justify-center gap-3 flex-wrap">
                                <button onclick="mBT.features.settings.openAddContactModal()" class="bg-indigo-200 text-indigo-800 px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-indigo-300 transition-all flex items-center gap-1.5">
                                    ${mBTAssets.plus} Add
                                </button>
                                <input type="file" id="csvImportInput" class="hidden" accept=".csv" onchange="importContactsCSV(this)">
                                <button onclick="document.getElementById('csvImportInput').click()" class="bg-indigo-200 text-indigo-800 px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-indigo-300 transition-all flex items-center gap-1.5">
                                    ${mBTAssets.plus} Import CSV
                                </button>
                                <button onclick="mBTAssign.assignFromContacts()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest shadow-sm active:scale-95 transition-all">
                                    Auto-Assign
                                </button>
                            </div>
                            <div class="relative">
                                <input type="text" id="contactsSearchInput" placeholder="SEARCH PERSONNEL..." class="w-full p-2.5 pr-10 bg-white border border-indigo-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-indigo-300 transition-all">
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none">${mBTAssets.search}</div>
                            </div>
                        </div>
                        <div id="contactsListBody" class="flex-grow overflow-y-auto no-scrollbar relative bg-white">
                            ${listContent}
                        </div>
                    </div>`;
            }
            if (subTab === 'lineItems') {
                const isSharing = mBTOG.settings.optInSharing;
                return `
                    <div class="flex flex-col h-full bg-white overflow-hidden rounded-xl border border-slate-100 shadow-sm">
                        <div class="p-3 bg-slate-50 border-b border-slate-100 shrink-0 z-10 space-y-3">
                            <div class="flex gap-2">
                                <button onclick="mBT.features.settings.openAddRateModal()" class="flex-1 py-2 bg-white border border-slate-200 rounded-lg text-[9px] font-black uppercase tracking-widest text-slate-600 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm flex items-center justify-center gap-2">
                                    ${mBTAssets.plus} Add Line Item
                                </button>
                                <button onclick="mBT.features.settings.toggleOpenGateSharing()" class="flex-1 py-2 border rounded-lg text-[9px] font-black uppercase tracking-widest transition-all shadow-sm flex items-center justify-center gap-2 ${isSharing ? 'bg-emerald-50 border-emerald-200 text-emerald-600' : 'bg-white border-slate-200 text-slate-400 hover:text-slate-600'}">
                                    ${mBTAssets.cloud} ${isSharing ? 'Sharing On' : 'Share Data'}
                                </button>
                            </div>
                            <div class="relative">
                                <input type="text" id="dbSearchInput" placeholder="SEARCH GLOBAL RATES..." class="w-full p-2.5 pr-10 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-blue-100 transition-all">
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">${mBTAssets.search}</div>
                            </div>
                        </div>
                        <div id="dbListBody" class="flex-grow overflow-y-auto no-scrollbar relative min-h-0 bg-white">
                            ${mBTOG.rates.map(r => RenderEngine.ui.listRow({
                                id: r.id || r.description,
                                icon: mBTAssets.money, 
                                title: r.description,
                                subtitle: `${mBTLE.format.currency(r.rate)} / ${r.unit}`,
                                classes: 'border-b border-slate-50'
                            })).join('')}
                        </div>
                    </div>`;
            }
            if (subTab === 'templates') {
                const templates = Array.isArray(mBTOG.templates) ? mBTOG.templates : [];
                const listContent = templates.length > 0 ? templates.map(t => RenderEngine.ui.listRow({
                    id: t.id,
                    icon: t.icon || '',
                    title: t.label,
                    subtitle: t.cat || 'General',
                    actions: [{
                        icon: mBTAssets.plus,
                        title: 'Use Template',
                        color: 'blue',
                        onClick: `createNewDocumentFromTemplate('${t.id}')`
                    }]
                })).join('') : RenderEngine.ui.emptyState({ icon: mBTAssets.file, message: 'No Templates' });

                return `
                    <div class="flex flex-col h-full bg-white overflow-hidden rounded-xl border border-slate-100 shadow-sm">
                        <div class="p-3 bg-indigo-50 border-b border-indigo-100 shrink-0 z-10">
                             <div class="relative">
                                <input type="text" id="templateSearchInput" placeholder="SEARCH TEMPLATES..." class="w-full p-2.5 pr-10 bg-white border border-indigo-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-indigo-300 transition-all">
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none">${mBTAssets.search}</div>
                            </div>
                        </div>
                        <div id="templatesListBody" class="flex-grow overflow-y-auto no-scrollbar relative bg-white">
                            ${listContent}
                        </div>
                    </div>`;
            }
            return '';
        },

        // --- 2. Main Content Generator ---
        getTabContent: function(tabName, subTab = 'lineItems') {
            if (tabName === 'general') {
                const currentDateFormat = getProjectDateFormat();
                const currentSeparator = getProjectNameSeparator();
                const isCompact = budget.settings?.compactMode || false;
                const syncAoD = budget.settings?.syncAoD || false;
                // Logic Resolution: Prep for future legacy theme switch
                const isClassic = budget.settings?.classicTheme || false;
              
                return `
                    <div class="h-full overflow-y-auto no-scrollbar p-6 space-y-6 animate-in fade-in duration-300">
                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center text-center gap-3">
                            <div class="w-16 h-16 rounded-2xl shadow-lg border-2 border-slate-50 overflow-hidden bg-[#fdba35]">${mBTAssets.appLogo}</div>
                            <div>
                                <h3 class="text-xs font-black uppercase tracking-widest text-slate-800">MooBudget Studio</h3>
                                <p class="text-[9px] text-slate-400 font-bold mt-1">Build v${APP_VERSION}  ${navigator.onLine ? '<span class="text-emerald-500">Online</span>' : '<span class="text-rose-500">Offline</span>'}</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Date Format</label>
                                    <select id="dateFormatSelect" onchange="localStorage.setItem('${projectDateFormatKey}', this.value)" class="w-full text-[10px] p-2 bg-slate-50 border-none rounded-lg font-bold outline-none cursor-pointer">
                                        <option value="YYYYMMDD" ${currentDateFormat === 'YYYYMMDD' ? 'selected' : ''}>YYYY-MM-DD</option>
                                        <option value="MMDDYYYY" ${currentDateFormat === 'MMDDYYYY' ? 'selected' : ''}>MM-DD-YYYY</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Separator</label>
                                    <input type="text" id="separatorInput" maxlength="1" value="${currentSeparator}" onchange="localStorage.setItem('${projectNameSeparatorKey}', this.value)" class="w-full text-[10px] p-2 bg-slate-50 border-none rounded-lg font-bold text-center outline-none">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-800">Compact View</h4>
                                        <p class="text-[9px] text-slate-400 font-bold mt-0.5">Denser layout for small screens</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="compactModeToggle" ${isCompact ? 'checked' : ''} onchange="if(!budget.settings) budget.settings={}; budget.settings.compactMode = this.checked; saveBudget(); render();" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-800">Connect to AoD Database</h4>
                                        <p class="text-[9px] text-slate-400 font-bold mt-0.5">Pull crew by location, availability and role</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="aodSyncToggle" ${syncAoD ? 'checked' : ''} onchange="if(!budget.settings) budget.settings={}; budget.settings.syncAoD = this.checked; saveBudget();" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                                    </label>
                                </div>
                            </div>
                            <!-- NEW: Classic Theme Placeholder -->
                            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-800">Classic Theme</h4>
                                        <p class="text-[9px] text-slate-400 font-bold mt-0.5">Legacy visual style (Pre-v19.54)</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="classicThemeToggle" ${isClassic ? 'checked' : ''} onchange="if(!budget.settings) budget.settings={}; budget.settings.classicTheme = this.checked; saveBudget(); render();" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-slate-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                             <a href="https://raw.githubusercontent.com/jaysonmy/moobudget/refs/heads/main/index.html" target="_blank" download="moobudget-beta.html" class="flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-slate-200 transition-colors">${mBTAssets.cloud} Get Beta</a>
                             <button onclick="hardResetApp()" class="flex items-center justify-center gap-2 px-4 py-3 bg-rose-50 text-rose-600 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-rose-100 transition-colors">${mBTAssets.zap} Fix Bugs</button>
                        </div>
                        <div class="flex justify-center">
                             <button onclick="mBTME.close('settingsModal'); showCoffeeWidget();" class="flex items-center gap-2 px-8 py-4 bg-[#FFDD00] text-black rounded-xl font-black text-[10px] uppercase tracking-widest hover:scale-105 transition-transform shadow-lg">${mBTAssets.coffee} Support Development</button>
                        </div>
                    </div>`;
            }
            if (tabName === 'ai') {
                const provider = getSelectedProvider();
                const saveHistory = budget.aiContext?.saveHistory ?? true;
                const storedPrompt = mBT.features.ai.getSystemPrompt();
                
                // Logic Resolution: Map for dynamic "Get API Key" links
                const keyLinks = {
                    'gemini': 'https://aistudio.google.com/app/apikey',
                    'openai': 'https://platform.openai.com/api-keys',
                    'deepseek': 'https://platform.deepseek.com/api_keys',
                    'grok': 'https://console.x.ai/'
                };
                
                return `
                    <div class="h-full overflow-y-auto no-scrollbar p-6 space-y-6 animate-in fade-in duration-300">
                        <div class="p-5 bg-slate-900 rounded-2xl border border-black shadow-lg text-white">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Assistant</h3>
                                    <p class="text-[9px] text-slate-500 font-bold mt-0.5">Configure Provider Access</p>
                                </div>
                                <div class="text-slate-700">${mBTAssets.sparkle}</div>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1.5">Active Provider</label>
                                    <select id="aiProviderSelect" onchange="const link=document.getElementById('apiKeyLink'); const map=${JSON.stringify(keyLinks).replace(/"/g, "'")}; link.href=map[this.value];" class="w-full bg-slate-800 text-white border-none rounded-lg p-2.5 text-[10px] font-bold outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer">
                                        <option value="gemini" ${provider === 'gemini' ? 'selected' : ''}>Google Gemini API</option>
                                        <option value="openai" ${provider === 'openai' ? 'selected' : ''}>OpenAI API</option>
                                        <option value="deepseek" ${provider === 'deepseek' ? 'selected' : ''}>DeepSeek API</option>
                                        <option value="grok" ${provider === 'grok' ? 'selected' : ''}>Grok (xAI) API</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1.5">
                                        <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest">API Credentials</label>
                                        <a id="apiKeyLink" href="${keyLinks[provider] || '#'}" target="_blank" class="text-[9px] font-bold text-blue-400 hover:text-blue-300 uppercase tracking-widest flex items-center gap-1 transition-colors">
                                            Get API Key <span></span>
                                        </a>
                                    </div>
                                    <input type="password" id="apiKeyInput" value="${getStoredApiKey(provider)}" class="w-full bg-slate-800 text-white border-none rounded-lg p-2.5 text-[10px] font-mono outline-none focus:ring-1 focus:ring-blue-500" placeholder="sk-...">
                                </div>
                                <div>
                                    <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1.5">Persona & Constraints</label>
                                    <textarea id="aiSystemPromptInput" class="w-full bg-slate-800 text-white border-none rounded-lg p-2.5 text-[10px] outline-none focus:ring-1 focus:ring-blue-500 resize-none h-16 placeholder-slate-600" placeholder="e.g. Be sarcastic. Focus only on Below The Line. Use JMD currency symbol.">${storedPrompt}</textarea>
                                </div>
                                <div class="flex items-center gap-3 py-1">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" id="aiContextToggle" ${saveHistory ? 'checked' : ''} onchange="if(!budget.aiContext) budget.aiContext={chat:[], analysis:''}; budget.aiContext.saveHistory = this.checked; saveBudget();" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                    </div>
                                    <label for="aiContextToggle" class="text-[9px] font-bold text-slate-400 uppercase tracking-wide cursor-pointer select-none">Save Conversation Context</label>
                                </div>
                                <button id="saveApiKeyBtn" onclick="const p=document.getElementById('aiProviderSelect').value; const k=document.getElementById('apiKeyInput').value; const s=document.getElementById('aiSystemPromptInput').value; saveStoredApiKey(p,k); mBT.features.ai.saveSystemPrompt(s); localStorage.setItem('${storageKeyPrefix}selectedAiProvider', p); alert('Assistant Settings Synchronized');" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black uppercase tracking-widest text-[9px] shadow-lg hover:bg-blue-500 transition-all mt-2">Synchronize Link</button>
                            </div>
                        </div>
                    </div>`;
            }
            if (tabName === 'database') {
                const nav = RenderEngine.ui.tabs({
                    items: [
                        { id: 'lineItems', label: 'Line Items' },
                        { id: 'contacts', label: 'Contacts' },
                        { id: 'templates', label: 'Templates' }
                    ],
                    activeId: subTab,
                    onClick: "mBT.features.settings.open('database',"
                }).replace(/open\('database',\s*'([^']+)'\)/g, "open('database', '$1')"); 

                return `<div class="flex flex-col h-full p-6 pb-0 overflow-hidden space-y-4">
                    ${nav.replace(/onclick="mBT.features.settings.open\('database',\('([^']+)'\)\)"/g, "onclick=\"mBT.features.settings.open('database', '$1')\"")} 
                    <div class="flex-grow flex flex-col relative overflow-hidden min-h-0">
                        ${this.renderDbView(subTab)}
                    </div>
                </div>`;
            }
            return `<div class="p-8 text-center text-slate-300 font-bold uppercase tracking-widest">Logic Stream Not Found</div>`;
        },

        // --- 3. Main Entry Point ---
        open: function(tab = 'general', subTab = 'lineItems') {
            const domId = 'settingsModal';
            const contentHTML = this.getTabContent(tab, subTab);
            
            const tabNavHTML = RenderEngine.ui.tabs({
                items: [
                    { id: 'general', label: `General` },
                    { id: 'database', label: `Database` },
                    { id: 'ai', label: `AI` }
                ],
                activeId: tab,
                onClick: 'mBT.features.settings.open'
            });

            const existingModal = document.getElementById(domId);
            if (existingModal) {
                const contentArea = document.getElementById('settingsContentArea');
                const navArea = document.getElementById('settingsTabNav');
                if (contentArea) contentArea.innerHTML = contentHTML;
                if (navArea) navArea.innerHTML = tabNavHTML;
                this._attachListeners(tab, subTab);
                return;
            }

            const fullContent = `
                <div class="flex flex-col min-h-[600px] max-h-[90vh] bg-slate-50/50">
                    <div id="settingsTabNav" class="shrink-0 bg-white">
                        ${tabNavHTML}
                    </div>
                    <div id="settingsContentArea" class="flex-grow flex flex-col relative overflow-hidden">
                        ${contentHTML}
                    </div>
                </div>`;
            mBTME.open('settings', 'Settings', fullContent, 'max-w-2xl', { noPadding: true, hideHeader: true });
            this._attachListeners(tab, subTab);
        },

        // --- 4. Internal Logic & Listeners ---
        _attachListeners: function(tab, subTab) {
            if (tab === 'database' && subTab === 'lineItems') {
                mBTME.attachSearch('dbSearchInput', 'dbListBody', mBTOG.rates, (r) => RenderEngine.ui.listRow({
                    id: r.id || r.description,
                    icon: mBTAssets.money,
                    title: r.description,
                    subtitle: `${mBTLE.format.currency(r.rate)} / ${r.unit}`,
                    classes: 'border-b border-slate-50'
                }));
            }
            if (tab === 'database' && subTab === 'contacts') {
                const globalContacts = mBTOG.contacts || [];
                const assignedContacts = [];
                Object.values(budget.sections || {}).forEach(sec => {
                    sec.items.forEach(item => {
                        if (item.crew && item.crew.name) assignedContacts.push({id: 'assigned_'+item.id, name: item.crew.name, role: item.description||'Crew', assigned: true});
                    });
                });
                const allContacts = [...globalContacts];
                assignedContacts.forEach(ac => { if(!allContacts.some(gc=>gc.name.toLowerCase()===ac.name.toLowerCase())) allContacts.push(ac); });
                
                mBTME.attachSearch('contactsSearchInput', 'contactsListBody', allContacts, (c) => RenderEngine.ui.listRow({
                    id: c.id,
                    icon: c.name ? c.name.charAt(0).toUpperCase() : '?',
                    title: c.name,
                    subtitle: `${c.role || 'No Role'}${c.assigned ? ' (Assigned)' : ''}`,
                    actions: c.assigned ? [] : [{ icon: mBTAssets.trash, title: 'Delete', color: 'rose', onClick: `mBT.features.settings.deleteContact('${c.id}')` }]
                }));
            }
            if (tab === 'database' && subTab === 'templates') {
                mBTME.attachSearch('templateSearchInput', 'templatesListBody', mBTOG.templates, (t) => RenderEngine.ui.listRow({
                    id: t.id,
                    icon: t.icon || '',
                    title: t.label,
                    subtitle: t.cat || 'General',
                    actions: [{ icon: mBTAssets.plus, title: 'Use Template', color: 'blue', onClick: `createNewDocumentFromTemplate('${t.id}')` }]
                }));
            }
        },

        // --- 5. Action Handlers ---
        openAddContactModal: function() {
            const dummyItem = { id: 'dummy_new_contact', crew: { name: '', phone: '', email: '' } };
            const dummySection = 'general';
            openCrewProfile(null, null, dummyItem.id, dummySection);
        },
        addContact: function(e) {
            // ... Logic moved here if invoked directly, but mostly handled by openCrewProfile form commit ...
        },
        deleteContact: function(id) {
            if(!confirm("Remove global contact?")) return;
            const idx = mBTOG.contacts.findIndex(c => c.id === id);
            if(idx > -1) {
                mBTOG.contacts.splice(idx, 1);
                localStorage.setItem('moo_contacts', JSON.stringify(mBTOG.contacts));
                this.open('database', 'contacts'); // Refresh
            }
        },

        // --- 6. Database Tools (Tier 5 Additions) ---
        openAddRateModal: function() {
            const content = `
                <div class="space-y-4 p-2">
                    <div>
                        <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Description</label>
                        <input type="text" id="newRateDesc" class="w-full p-3 bg-slate-50 border-none rounded-xl text-xs font-black uppercase tracking-tighter outline-none focus:ring-2 focus:ring-blue-100" placeholder="ITEM NAME">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Rate</label>
                            <input type="number" id="newRateVal" class="w-full p-3 bg-slate-50 border-none rounded-xl text-xs font-mono font-bold outline-none focus:ring-2 focus:ring-blue-100" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Unit</label>
                            <select id="newRateUnit" class="w-full p-3 bg-slate-50 border-none rounded-xl text-xs font-bold outline-none cursor-pointer">
                                <option value="Day">Day</option>
                                <option value="Flat">Flat</option>
                                <option value="Week">Week</option>
                                <option value="Hour">Hour</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="mBT.features.settings.addRate()" class="w-full py-4 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-2xl shadow-xl hover:bg-black transition-all active:scale-95 mt-4">Add to Database</button>
                </div>`;
            mBTME.open('addRate', 'New Global Rate', content, 'max-w-sm');
        },

        addRate: function() {
            const desc = document.getElementById('newRateDesc').value.trim();
            const rate = parseFloat(document.getElementById('newRateVal').value) || 0;
            const unit = document.getElementById('newRateUnit').value;

            if (!desc) return alert("Description required");

            mBTOG.rates.push({ description: desc, rate: rate, unit: unit });
            mBTOG.saveRates(); // Calls Tier 2.5 persistence
            
            mBTME.close('addRateModal');
            this.open('database', 'lineItems'); // Refresh list
        },

        toggleOpenGateSharing: function() {
            mBTOG.settings.optInSharing = !mBTOG.settings.optInSharing;
            localStorage.setItem('moo_og_share', JSON.stringify(mBTOG.settings.optInSharing));
            
            // Visual feedback
            if (mBTOG.settings.optInSharing) {
                alert("Open Gate Sharing Enabled. Anonymous rate data will be synchronized.");
            }
            this.open('database', 'lineItems'); // Refresh UI toggle state
        }
    };

    // --- Backward Compatibility Alias ---
    // Fix: We use .bind() to ensure 'this' refers to the settings object, not the window
    window.showSettingsModal = mBT.features.settings.open.bind(mBT.features.settings);

// ---- Tier 5 Part 3 ---- //
 /* ========= v19.60 DOCUMENTS HUB (mBT.features.documents) ========= */
    mBT.features.documents = {
        // Logic Resolution: Creates a new document instance from a template definition
        createFromTemplate: function(templateId) {
            const tmpl = mBTOG.templates.find(t => t.id === templateId);
            if (!tmpl) return alert("Template definition not found.");

            const newDoc = {
                id: 'doc_' + Date.now(),
                type: tmpl.id, 
                label: tmpl.label,
                content: {
                    data: mBTDB._generateDefaultData(),
                    widgets: [] // Populated by mBTDB.open based on type defaults
                }
            };
            
            if (!budget.documents) budget.documents = [];
            budget.documents.push(newDoc);
            
            saveBudget();
            mBTME.close('newDocSelectorModal');
            
            // Refresh Vault list if open
            if(document.getElementById('documentsModal')) this.openVault();
            
            // Launch Studio immediately
            mBTDB.open(newDoc.id);
        },

        // Logic Resolution: Opens the Document Vault (List of saved docs)
        openVault: function() {
            const docs = budget.documents || [];
            
            // Logic Resolution: View Layout Strategy linked to Settings
            const isCompact = budget.settings?.compactMode || false;
            
            // 2. Define Layout Classes (Grid vs List)
            // Fix: If empty, force flex layout so empty state centers. Otherwise obey compact setting.
            const listContainerClass = (isCompact && docs.length > 0)
                ? 'grid grid-cols-2 md:grid-cols-3 gap-4 content-start' 
                : 'flex flex-col gap-3';
            
            // 3. Adjust Modal Width based on View
            const modalWidth = (isCompact && docs.length > 0) ? 'max-w-5xl' : 'max-w-2xl';

            // Logic Resolution: Dynamic Item Renderer (Grid Card vs List Row)
            const renderDocItem = (doc) => {
                if (isCompact) {
                    // Grid Card (Vertical Layout)
                    return `
                    <div class="relative group bg-white p-4 rounded-2xl border border-slate-100 hover:border-blue-200 shadow-sm hover:shadow-md transition-all cursor-pointer flex flex-col items-center gap-3 text-center h-full" onclick="mBTDB.open('${doc.id}')">
                         <div class="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:text-blue-500 group-hover:bg-blue-50 transition-colors shrink-0">
                            ${mBTAssets.file}
                         </div>
                         <div class="w-full overflow-hidden">
                            <div class="text-[10px] font-black uppercase text-slate-700 truncate w-full" title="${RenderEngine.esc(doc.label)}">${RenderEngine.esc(doc.label || 'Untitled')}</div>
                            <div class="text-[9px] text-slate-400 font-bold truncate w-full">${doc.type ? doc.type.toUpperCase() : 'DOC'}</div>
                         </div>
                         <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 bg-white/90 rounded-lg shadow-sm p-1">
                            <button onclick="event.stopPropagation(); mBTDB.snapshotDoc('${doc.id}')" class="p-1 hover:bg-blue-50 text-slate-400 hover:text-blue-500 rounded" title="Duplicate">${mBTAssets.copy}</button>
                            <button onclick="event.stopPropagation(); window.handleDocTrash('${doc.id}')" class="p-1 hover:bg-rose-50 text-slate-400 hover:text-rose-500 rounded" title="Archive">${mBTAssets.trash}</button>
                         </div>
                    </div>`;
                } else {
                    // List Row (Horizontal Layout)
                    return RenderEngine.ui.card({
                        id: doc.id,
                        icon: mBTAssets.file,
                        title: doc.label || 'Untitled Document',
                        subtitle: doc.type ? doc.type.charAt(0).toUpperCase() + doc.type.slice(1) : 'Document',
                        onClick: `mBTDB.open('${doc.id}')`,
                        actions: [
                            { icon: mBTAssets.copy, title: 'Duplicate', color: 'blue', onClick: `mBTDB.snapshotDoc('${doc.id}')` },
                            { icon: mBTAssets.trash, title: 'Archive', color: 'rose', onClick: `window.handleDocTrash('${doc.id}')` }
                        ]
                    });
                }
            };

            const docsHtml = docs.length > 0 
                ? docs.map(renderDocItem).join('') 
                : `<div class="col-span-full">${RenderEngine.ui.emptyState({ 
                    icon: mBTAssets.file, 
                    message: 'Vault is Empty', 
                    subtext: 'Create a new document to get started' 
                })}</div>`;

            // Logic Resolution: Custom Header with Centered Title "DOCUMENTS"
            const content = `
                <div class="flex flex-col max-h-[90vh]">
                    <div class="p-6 bg-white border-b border-slate-100 flex-shrink-0 z-10">
                        <div class="flex justify-between items-center mb-4 relative">
                            <!-- Left: Add Button -->
                            <button onclick="mBT.features.documents.openTemplateSelector()" class="px-4 py-2 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-black transition-all flex items-center gap-2 shadow-sm active:scale-95">
                                ${mBTAssets.plus} Add
                            </button>
                            
                            <!-- Center: Title -->
                            <h3 class="absolute left-1/2 -translate-x-1/2 font-black text-slate-900 text-xs uppercase tracking-widest">DOCUMENTS</h3>
                            
                            <!-- Right: Actions -->
                            <div class="flex gap-2">
                                <button onclick="mBT.features.trash.open('documents')" class="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-rose-500 hover:bg-rose-50 transition-all" title="Recycle Bin">${mBTAssets.trash}</button>
                                <button onclick="mBTME.close('documentsModal')" class="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-slate-600 transition-all">${mBTAssets.close}</button>
                            </div>
                        </div>
                        <div class="relative">
                            <input type="text" id="docSearch" placeholder="SEARCH DOCUMENTS..." class="w-full p-3 pr-10 bg-slate-50 border-none rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">${mBTAssets.search}</div>
                        </div>
                    </div>
                    
                    <div class="flex-grow overflow-y-auto no-scrollbar bg-slate-50/50 p-6">
                        <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-3 px-1 col-span-full">Active Production Files</div>
                        <div id="activeDocsList" class="${listContainerClass}">
                            ${docsHtml}
                        </div>
                    </div>
                </div>`;
            
            mBTME.open('documents', 'Documents', content, modalWidth, { noPadding: true, hideHeader: true });
        
            mBTME.attachSearch('docSearch', 'activeDocsList', docs, renderDocItem);
        },

        // Logic Resolution: Opens the Template Selector (Blueprints)
        openTemplateSelector: function() {
            const templates = mBTOG.templates || [];
            const templateHtml = templates.map(tmpl => RenderEngine.ui.card({
                id: tmpl.id,
                icon: tmpl.icon || '',
                title: tmpl.label,
                subtitle: tmpl.cat || 'General',
                onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')`,
                actions: [{ icon: mBTAssets.plus, title: 'Create', color: 'blue', onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')` }]
            })).join('');

            const content = RenderEngine.layouts.studioPanel({
                title: 'Select Template',
                searchId: 'tmplSearch',
                searchPlaceholder: 'FILTER TEMPLATES...',
                contentId: 'templateListBody',
                contentHtml: templateHtml,
                actions: [] 
            });
                
            mBTME.open('newDocSelector', 'Studio Blueprints', content, 'max-w-md', { noPadding: true, hideHeader: true });
            
            mBTME.attachSearch('tmplSearch', 'templateListBody', templates, (tmpl) => RenderEngine.ui.card({
                id: tmpl.id,
                icon: tmpl.icon || '',
                title: tmpl.label,
                subtitle: tmpl.cat || 'General',
                onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')`,
                actions: [{ icon: mBTAssets.plus, title: 'Create', color: 'blue', onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')` }]
            }));
        }
    };

    // --- Global Aliases for Backward Compatibility (Footer Buttons & Switchboard) ---
    window.showDocumentsModal = mBT.features.documents.openVault.bind(mBT.features.documents);
    window.showNewDocumentSelector = mBT.features.documents.openTemplateSelector.bind(mBT.features.documents);
    window.createNewDocumentFromTemplate = mBT.features.documents.createFromTemplate.bind(mBT.features.documents);

    // (openAddContactModal and renderDatabaseSubView removed from global scope to enforce strict mode)

/* ======= Studio Orchestration & Switchboard ======== */
    /* --- 1. Personnel Hub Intelligence (Interaction behavior) --- */
    // Logic Resolution: Manages the floating contact cards and profile resolution.
    window.toggleCrewPopup = function(el, event) {
        if(event) event.stopPropagation();
        const wrapper = el.parentElement;
        document.querySelectorAll('.crew-wrapper').forEach(div => { if (div !== wrapper) div.classList.remove('mobile-active'); });
        wrapper.classList.toggle('mobile-active');
    };
window.openCrewProfile = function(el, event, itemId, sectionName) {
    if(event) event.stopPropagation();

    // Safe fallback for dummy add from Settings
    let section = { items: [] };
    let item = null;
    if (itemId && sectionName && budget.sections && budget.sections[sectionName]) {
        section = budget.sections[sectionName];
        item = section.items.find(i => i.id === itemId);
    }
    // If no valid item found (dummy case), create temporary item
    if (!item) {
        item = { id: itemId || 'temp', crew: { name: '', phone: '', email: '' }, description: 'New Contact' };
    }
    const crew = item.crew || { name: '', phone: '', email: '' };

    // Actions logic
    const cleanPhone = crew.phone ? crew.phone.replace(/\D/g, '') : '';
    const hasPhone = cleanPhone.length > 6;
    const hasEmail = crew.email && crew.email.includes('@');

    const actionsBar = `
        <div class="flex justify-center gap-3 mb-6 mt-2">
            ${hasPhone ? `
                <a href="tel:${cleanPhone}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 border border-green-200 flex items-center justify-center shadow-sm group-hover:bg-green-600 group-hover:text-white transition-colors">${mBTAssets.phone}</div>
                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Call</span>
                </a>
                <a href="https://wa.me/${cleanPhone}" target="_blank" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-200 flex items-center justify-center shadow-sm group-hover:bg-emerald-600 group-hover:text-white transition-colors">${mBTAssets.wa}</div>
                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">WA</span>
                </a>` : ''}
            ${hasEmail ? `
                <a href="mailto:${crew.email}" class="flex flex-col items-center gap-1 group">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 border border-blue-200 flex items-center justify-center shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors">${mBTAssets.mail}</div>
                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Email</span>
                </a>` : ''}
        </div>`;

    const content = `
        <form id="crewProfileForm" class="space-y-6">
            <div class="text-center relative">
                <div class="w-24 h-24 mx-auto rounded-[32px] bg-slate-900 flex items-center justify-center text-white font-black text-4xl shadow-2xl border-4 border-white rotate-3">
                    ${crew.name ? RenderEngine.esc(crew.name.substring(0,1).toUpperCase()) : '?'}
                </div>
                <h3 class="text-xl font-black text-slate-900 mt-4 uppercase tracking-tighter">${RenderEngine.esc(crew.name || 'Unknown')}</h3>
                <p class="text-[10px] text-blue-600 font-black uppercase tracking-widest bg-blue-50 inline-block px-3 py-1 rounded-full mt-1">${RenderEngine.esc(item.description || 'New Contact')}</p>
            </div>
            ${actionsBar}
            <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Profile</h4>
                    <button type="button" id="importContactBtn" class="text-[10px] font-black uppercase tracking-widest text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-2">${mBTAssets.plus} Import</button>
                </div>
                <div class="space-y-3">
                    <input type="text" id="crewName" value="${RenderEngine.esc(crew.name || '')}" placeholder="FULL NAME" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-black uppercase tracking-tighter outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="tel" id="crewPhone" value="${RenderEngine.esc(crew.phone || '')}" placeholder="PHONE" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-mono font-bold outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                        <input type="email" id="crewEmail" value="${RenderEngine.esc(crew.email || '')}" placeholder="EMAIL" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-mono font-bold outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                    </div>
                </div>
            </div>
            <div class="pt-4 flex justify-between items-center gap-4">
                <button type="button" class="text-rose-500 text-[10px] font-black uppercase tracking-widest hover:bg-rose-50 px-4 py-3 rounded-2xl transition-all" onclick="window.clearCrewAssignment('${itemId}', '${sectionName}')">Remove</button>
                <button type="submit" class="flex-grow py-4 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-2xl shadow-xl hover:bg-black transition-all active:scale-95">Save</button>
            </div>
        </form>`;

    mBTME.open('crewProfile', '', content, 'max-w-sm', { hideHeader: true });

    setTimeout(() => {
        const importBtn = document.getElementById('importContactBtn');
        if(importBtn) {
            importBtn.addEventListener('click', async () => {
                if ('contacts' in navigator && 'ContactsManager' in window) {
                    try {
                        const contacts = await navigator.contacts.select(['name', 'tel', 'email'], { multiple: false });
                        if (contacts.length) {
                            const c = contacts[0];
                            if(c.name?.[0]) document.getElementById('crewName').value = c.name[0];
                            if(c.tel?.[0]) document.getElementById('crewPhone').value = c.tel[0];
                            if(c.email?.[0]) document.getElementById('crewEmail').value = c.email[0];
                        }
                    } catch (ex) { console.log('Import failed/cancelled', ex); }
                } else {
                    alert("Contact import not supported on this browser.");
                }
            });
        }

        const form = document.getElementById('crewProfileForm');
        if(form) {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('crewName').value.trim();
                const phone = document.getElementById('crewPhone').value.trim();
                const email = document.getElementById('crewEmail').value.trim();

               if (itemId && itemId.startsWith('dummy_new_contact')) {
                    // Global add from Settings
                    if (!name) return alert("Name is required.");
                    const exists = mBTOG.contacts.some(c => c.name.toLowerCase() === name.toLowerCase());
                    if (exists) return alert("Contact already exists in database.");

                    const newContact = {
                        id: 'c_' + Date.now(),
                        name,
                        role: 'Crew',
                        phone,
                        email
                    };
                    mBTOG.contacts.push(newContact);
                    mBTOG.saveContacts(); // Encapsulated Save (Tier 2.5)
                    mBTME.close('crewProfileModal');
                    showSettingsModal('database', 'contacts');
                } else {
                    // Normal project assignment
                    item.crew = { name, phone, email };
                    mBTME.close('crewProfileModal');
                    render();
                    if(document.getElementById('stagesViewModal')) showStagesModal();
                }
            });
        }
    }, 50);
};
    window.clearCrewAssignment = function(itemId, sectionName) {
        if(confirm('Remove assignment?')) {
            const item = budget.sections[sectionName].items.find(i => i.id === itemId);
            if(item) {
                delete item.crew;
                mBTME.close('crewProfileModal');
                render();
            }
        }
    };
    /* --- 2. Studio Builder Logic Expansion --- */
    // Logic Resolution: High-speed bi-directional data flow for the Studio environment.
    window.mBTDB = {
        ...window.mBTDB, // Preserve parts 1 & 2
        updateData: function(docId, path, value) {
            const doc = budget.documents.find(d => d.id === docId);
            const parts = path.split('.');
            let target = doc.content.data;
            for(let i=0; i<parts.length-1; i++) { if(!target[parts[i]]) target[parts[i]]={}; target = target[parts[i]]; }
            target[parts[parts.length-1]] = value;
            this._triggerSave();
        },
        updateRow: function(docId, section, index, key, value) {
            const doc = budget.documents.find(d => d.id === docId);
            if(doc.content.data[section][index]) {
                doc.content.data[section][index][key] = value;
                this._triggerSave();
            }
        },
        addRow: function(docId, section, type, presetData) {
            const doc = budget.documents.find(d => d.id === docId);
            if(!doc.content.data[section]) doc.content.data[section] = [];
            let newRow = presetData || { id: Date.now() };
            doc.content.data[section].push(newRow);
            this._triggerSave();
            this.renderFrame();
        },
        deleteRow: function(docId, section, index) {
            const doc = budget.documents.find(d => d.id === docId);
            doc.content.data[section].splice(index, 1);
            this._triggerSave();
            this.renderFrame();
        },
        _triggerSave: function() { if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); },
        _generateDefaultData: function() {
            return {
                meta: { productionTitle: budget.projectName||"", productionCompany: budget.company||"", shootDate: new Date().toISOString().split('T')[0], crewCallTime: "08:00" },
                contacts: { director: "", producer: "", ad: "" },
                schedule: [], crew: [], cast: [],
                locations: [{name:"Base Camp", address:"", weather:"", hospital:"", mapLink:""}],
                additional: {}
            };
        }
    };
/* --- 3. Stage & Analytics Interface (Orchestration) --- */
    
// --- A. CRUD Handlers ---
    window.handleStageAddItem = function(stageKey) {
        // Detect Target Section
        const sectionNames = Object.keys(budget.sections);
        let targetSectionName = null;

        if (stageKey === 'post') targetSectionName = sectionNames.find(s => /post|edit/.test(s.toLowerCase()));
        else if (stageKey === 'dev') targetSectionName = sectionNames.find(s => /development|creative/.test(s.toLowerCase()));
        else if (stageKey === 'pre') targetSectionName = sectionNames.find(s => /pre|staff/.test(s.toLowerCase()));
        else if (stageKey === 'dist') targetSectionName = sectionNames.find(s => /distribution|market/.test(s.toLowerCase()));
        
        // Fallback
        if (!targetSectionName) {
             targetSectionName = sectionNames.find(s => s.toLowerCase().includes('production')) || sectionNames[0];
        }

        if (!targetSectionName) return alert("No budget sections found.");

        // --- Gather Existing Items Candidates ---
        const existingItems = [];
        Object.entries(budget.sections).forEach(([secName, sec]) => {
            sec.items.forEach(i => {
                // Only show items NOT already in this specific stage
                if (!(i.stageData && i.stageData[stageKey])) {
                    existingItems.push({ 
                        ...i, 
                        isExisting: true, 
                        sectionName: secName 
                    });
                }
            });
        });

        // Combine for Initial Render (Top 10 existing + Top 20 Global)
        const initialList = [...existingItems.slice(0, 10), ...mBTOG.rates.slice(0, 20)];

        const content = `
            <div class="flex flex-col h-[400px]">
                <div class="mb-3">
                    <input type="text" id="stageDbSearch" placeholder="Search Budget & Database..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none text-sm font-bold">
                </div>

                <div id="stageDbList" class="flex-grow overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 mb-3">
                    ${renderStageDatabaseList(initialList, stageKey, targetSectionName)}
                </div>

                <button id="toggleStageCustomForm" class="text-xs text-blue-600 font-bold hover:underline text-center mb-2">
                    + Create Custom Item
                </button>

                <div id="stageCustomForm" class="hidden space-y-3 border-t pt-3 bg-white">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">Description</label>
                        <input type="text" id="stageCustomDesc" class="w-full p-2 border rounded text-sm" placeholder="Item Name">
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Rate</label>
                            <input type="number" id="stageCustomRate" class="w-full p-2 border rounded text-sm text-right" placeholder="0.00">
                        </div>
                        <div class="w-1/3">
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Unit</label>
                            <select id="stageCustomUnit" class="w-full p-2 border rounded text-sm bg-white">
                                <option>Day</option><option>Flat</option><option>Week</option>
                            </select>
                        </div>
                    </div>
                    <button id="stageAddCustomBtn" class="w-full py-2 bg-blue-600 text-white font-bold rounded shadow hover:bg-blue-700">Add Item</button>
                </div>
            </div>
        `;

        mBTME.open('stageAdd', `Add to ${budget.targetLock.stages[stageKey].label} <span class='text-gray-400 font-normal text-xs'>(${targetSectionName})</span>`, content, 'max-w-sm');

        // Attach Listeners
        const searchInput = document.getElementById('stageDbSearch');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                
                // Filter Existing (Prioritize these)
                const matchedExisting = existingItems.filter(i => i.description.toLowerCase().includes(term));
                
                // Filter Global
                const matchedGlobal = mBTOG.rates.filter(i => i.description.toLowerCase().includes(term));
                
                document.getElementById('stageDbList').innerHTML = renderStageDatabaseList([...matchedExisting, ...matchedGlobal], stageKey, targetSectionName);
            });
            setTimeout(() => searchInput.focus(), 50);
        }

        const toggleBtn = document.getElementById('toggleStageCustomForm');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
                const form = document.getElementById('stageCustomForm');
                const list = document.getElementById('stageDbList');
                const isHidden = form.classList.contains('hidden');
                
                if (isHidden) {
                    form.classList.remove('hidden');
                    list.classList.add('hidden');
                    e.target.textContent = " Back to Search";
                    document.getElementById('stageCustomDesc').focus();
                } else {
                    form.classList.add('hidden');
                    list.classList.remove('hidden');
                    e.target.textContent = "+ Create Custom Item";
                }
            });
        }

        const addBtn = document.getElementById('stageAddCustomBtn');
        if (addBtn) {
            addBtn.addEventListener('click', () => {
                const desc = document.getElementById('stageCustomDesc').value.trim();
                const rate = parseFloat(document.getElementById('stageCustomRate').value) || 0;
                const unit = document.getElementById('stageCustomUnit').value;
                if(!desc) return;
                
                addStageItemToBudget(desc, rate, unit, stageKey, targetSectionName);
            });
        }
    };

    window.renderStageDatabaseList = function(items, stageKey, targetSectionName) {
        if (items.length === 0) return `<div class="p-4 text-center text-xs text-gray-400 italic">No matches found.</div>`;
        
        return items.map((item) => {
            const safeDesc = item.description.replace(/'/g, "\\'");
            
            if (item.isExisting) {
                // Existing Budget Item (Link Action)
                return `
                <div onclick="assignItemToStage('${item.id}', '${stageKey}')" 
                     class="p-3 border-b border-gray-100 bg-white hover:bg-emerald-50 cursor-pointer flex justify-between items-center group transition-colors border-l-4 border-l-transparent hover:border-l-emerald-400">
                    <div>
                        <div class="text-sm font-bold text-gray-700 group-hover:text-emerald-700">${item.description}</div>
                        <div class="text-[10px] text-emerald-600 font-black uppercase tracking-widest flex items-center gap-1">
                            <span class="opacity-50">LINK FROM:</span> ${item.sectionName}
                        </div>
                    </div>
                    <div class="font-mono text-xs text-gray-500 font-bold group-hover:text-emerald-600">
                        ${mBTLE.format.currency(item.rate)}
                    </div>
                </div>`;
            } else {
                // Global Template (Create Action)
                return `
                <div onclick="addStageItemToBudget('${safeDesc}', ${item.rate}, '${item.unit}', '${stageKey}', '${targetSectionName}')" 
                     class="p-3 border-b border-gray-100 bg-white hover:bg-blue-50 cursor-pointer flex justify-between items-center group transition-colors">
                    <div>
                        <div class="text-sm font-bold text-gray-700 group-hover:text-blue-700">${item.description}</div>
                        <div class="text-[10px] text-gray-400">${item.unit}</div>
                    </div>
                    <div class="font-mono text-xs text-gray-500 font-bold group-hover:text-blue-600">
                        ${mBTLE.format.currency(item.rate)}
                    </div>
                </div>`;
            }
        }).join('');
    };

    // New: Links an existing item to a new stage without duplicating the row
    window.assignItemToStage = function(itemId, stageKey) {
        let item = null;
        let secName = '';
        for (const [sName, sec] of Object.entries(budget.sections)) {
            item = sec.items.find(i => i.id === itemId);
            if (item) { secName = sName; break; }
        }
        
        if (!item) return;
        if (!item.stageData) item.stageData = {};
        if (item.stageData[stageKey]) return alert("Item already in this stage.");
        
        // Add to stage with default 1 day
        item.stageData[stageKey] = { days: 1, rate: item.rate || 0 };
        
        saveBudget();
        mBTME.close('stageAddModal');
        
        // Surgical Update
        if(document.getElementById('stagesViewModal')) {
            if(typeof window.updateAllHeaders === 'function') window.updateAllHeaders(); 
            const col = document.querySelector(`.stage-drop-zone[data-stage-key="${stageKey}"]`);
            if(col) {
               const vizItem = { ...item, _sDays: 1, _sRate: item.rate, _sCost: item.rate, _sec: secName };
               const wrapper = document.createElement('div');
               wrapper.innerHTML = RenderEngine.stageCard(vizItem, stageKey);
               col.appendChild(wrapper.firstElementChild);
               col.scrollTop = col.scrollHeight;
            }
        }
        
        mBTLE.reconcile();
        if(typeof render === 'function') render(); 
    };

    window.addStageItemToBudget = function(desc, rate, unit, stageKey, targetSectionName) {
        const newItem = {
            id: crypto.randomUUID(),
            description: desc,
            quantity: 1,
            unit: unit,
            multiplier: 1,
            rate: rate,
            actual: 0,
            rateType: 'negotiable',
            assignedStage: [stageKey],
            stageData: {} 
        };

        newItem.stageData[stageKey] = { days: 1, rate: rate };

        if(budget.sections[targetSectionName]) {
            budget.sections[targetSectionName].items.push(newItem);
            if(typeof pushToHistory === 'function') pushToHistory(`Added '${desc}' to ${targetSectionName}`);
            mBTME.close('stageAddModal');
            
            saveBudget();
            
            if(document.getElementById('stagesViewModal')) {
                if(typeof window.updateAllHeaders === 'function') window.updateAllHeaders(); 
                
                const col = document.querySelector(`.stage-drop-zone[data-stage-key="${stageKey}"]`);
                if(col) {
                   const vizItem = { ...newItem, _sDays: 1, _sRate: rate, _sCost: rate, _sec: targetSectionName };
                   const wrapper = document.createElement('div');
                   wrapper.innerHTML = RenderEngine.stageCard(vizItem, stageKey);
                   col.appendChild(wrapper.firstElementChild);
                   
                   col.scrollTop = col.scrollHeight;
                }
            }
            
            if(typeof render === 'function') render(); 
        }
    };

    // --- BATCH 3: STAGE DRAG & DROP LOGIC ---
    window.handleStageDragStart = function(e, itemId, sourceStage) {
        e.dataTransfer.setData('text/plain', JSON.stringify({ itemId, sourceStage }));
        e.dataTransfer.effectAllowed = 'move';
        // Visual cue
        setTimeout(() => e.target.classList.add('opacity-50'), 0);
    };

    window.handleStageDragOver = function(e) {
        e.preventDefault(); // Necessary to allow dropping
        e.dataTransfer.dropEffect = 'move';
        const zone = e.target.closest('.stage-drop-zone');
        if (zone) zone.classList.add('bg-blue-50', 'border-blue-300');
    };

    window.handleStageDragLeave = function(e) {
        const zone = e.target.closest('.stage-drop-zone');
        if (zone) zone.classList.remove('bg-blue-50', 'border-blue-300');
    };

    window.handleStageDrop = function(e, targetStage) {
        e.preventDefault();
        const zone = e.target.closest('.stage-drop-zone');
        if (zone) zone.classList.remove('bg-blue-50', 'border-blue-300');

        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        const { itemId, sourceStage } = data;

        if (sourceStage === targetStage) return;

        // 1. Locate Item
        let foundItem = null;
        Object.values(budget.sections).forEach(sec => {
            if (!foundItem) foundItem = sec.items.find(i => i.id === itemId);
        });

        if (foundItem && foundItem.stageData && foundItem.stageData[sourceStage]) {
            // 2. CLONE Data (Tier 4 Logic Resolution)
            // We copy the source data to the target stage. 
            // We do NOT delete the source (creating a "Clone" effect).
            // Updates to this new stage entry are independent.
            foundItem.stageData[targetStage] = { ...foundItem.stageData[sourceStage] };
            
            // 3. Save & Refresh
            mBTLE.reconcile();
            saveBudget();
            showStagesModal(); // Re-render to show card in new column
        }
    };

    window.removeStageItem = function(itemId, sectionName, stageKey) {
        if(!confirm("Remove this item from the stage?")) return;

        // Find the item
        const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
        
        if (item && item.stageData) {
            // 1. DELETE the data for this specific stage
            delete item.stageData[stageKey];

            saveBudget();

            // 2. Surgical DOM Removal (No Flicker)
            // We try both selectors to be safe (data-stage and data-stage-key)
            const card = document.querySelector(`.stage-card-item[data-item-id="${itemId}"][data-stage="${stageKey}"]`) 
                      || document.querySelector(`.stage-card-item[data-item-id="${itemId}"][data-stage-key="${stageKey}"]`);
            
            if (card) card.remove();

            // 3. Update Header Totals
            if(typeof window.updateAllHeaders === 'function') {
                window.updateAllHeaders();
            }

            // 4. Update Background Budget
            mBTLE.reconcile();
            if(typeof render === 'function') render(); 
        }
    };

    window.updateStageItem = function(itemId, sectionName, stageKey, field, value) {
        const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
        
        if (item && item.stageData && item.stageData[stageKey]) {
            // 1. Update Data
            item.stageData[stageKey][field] = parseFloat(value) || 0;
            
            // 2. Visuals (Card Cost)
            const d = item.stageData[stageKey];
            const cost = (parseFloat(d.days) || 0) * (parseFloat(d.rate) || 0);
            
            const costEl = document.getElementById(`cost-${itemId}-${stageKey}`);
            if(costEl) costEl.textContent = formatAbbreviated(cost, displayCurrency);

            // 3. Global Updates & Background Refresh
            if(typeof window.updateAllHeaders === 'function') window.updateAllHeaders();
            saveBudget();
            
            // Triggers the Main Budget table to repaint with new totals immediately
            mBTLE.reconcile();
            if(typeof render === 'function') render();
        }
    };

    /* --- Feature: Production Stages Carousel --- */
    // Logic Resolution: Enhanced Stage Management with Setup & Analytics
    window.handleStageBulkAction = function(action) {
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        let changed = false;
        
        if (action === 'lockAll' || action === 'unlockAll') {
            const isLocked = (action === 'lockAll');
            validKeys.forEach(k => budget.targetLock.stages[k].locked = isLocked);
            changed = true;
        } else if (action === 'syncDays') {
            if(confirm("Sync Days will overwrite individual item days with the Stage Days setting. Continue?")) {
                validKeys.forEach(k => {
                    const targetDays = budget.targetLock.stages[k].days;
                    if(targetDays > 0) {
                        Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                            if(i.stageData && i.stageData[k]) { i.stageData[k].days = targetDays; }
                        }));
                    }
                });
                changed = true;
            }
        } else if (action === 'dedupe') {
            if(confirm("Remove duplicates? Keeps first instance per stage.")) {
                validKeys.forEach(k => {
                    const seen = new Set();
                    Object.values(budget.sections).forEach(sec => {
                        sec.items.forEach(i => {
                            if(i.stageData && i.stageData[k]) {
                                const key = i.description.toLowerCase();
                                if(seen.has(key)) delete i.stageData[k];
                                else seen.add(key);
                            }
                        });
                    });
                });
                changed = true;
            }
        }
        
        if (changed) {
            saveBudget();
            window.showStagesModal(); // Full redraw
            if(typeof render === 'function') render();
        }
    };

    // Logic Resolution: Dedicated handler for column locking to ensure state persistence
    window.toggleStageLock = function(stageKey) {
        if (!budget.targetLock.stages[stageKey]) return;
        budget.targetLock.stages[stageKey].locked = !budget.targetLock.stages[stageKey].locked;
        saveBudget();
        window.showStagesModal();
    };

    window.showStagesModal = function() {
        if (!budget.targetLock) budget.targetLock = { enabled: false, totalCap: 0, stages: {} };
        const tl = budget.targetLock;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        validKeys.forEach(k => { if (!tl.stages[k]) tl.stages[k] = { label: k.toUpperCase(), ratio: 20, days: 0, locked: false }; });

        // 1. Setup Card (Configuration & Sliders)
        const setupCard = `
            <div id="card-setup" class="stage-card min-w-[320px] w-[320px] flex-shrink-0 bg-slate-900 text-white flex flex-col snap-center border-r border-slate-800 h-full rounded-l-[24px]">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="font-black text-xs uppercase tracking-widest text-slate-400">Configuration</h3>
                    <div class="relative group">
                        <button class="text-slate-400 hover:text-white transition-colors">${mBTAssets.gear}</button>
                        <!-- Bulk Actions Menu (Simple absolute positioning) -->
                        <div class="hidden group-hover:block absolute right-0 top-full mt-2 w-40 bg-white border border-slate-200 shadow-xl rounded-xl z-50 overflow-hidden">
                            <div class="p-2 border-b border-slate-100 text-[9px] font-black text-slate-400 uppercase tracking-widest bg-slate-50">Bulk Actions</div>
                            <button onclick="handleStageBulkAction('syncDays')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 transition-colors">Sync Days</button>
                            <button onclick="handleStageBulkAction('dedupe')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:text-red-600 hover:bg-red-50 px-4 py-2 transition-colors">Remove Dupes</button>
                            <div class="border-t border-slate-100 my-1"></div>
                            <button onclick="handleStageBulkAction('lockAll')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:bg-slate-50 px-4 py-2 transition-colors">Lock All</button>
                            <button onclick="handleStageBulkAction('unlockAll')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:bg-slate-50 px-4 py-2 transition-colors">Unlock All</button>
                        </div>
                    </div>
                </div>
                <div class="p-5 space-y-6 overflow-y-auto no-scrollbar">
                    <div>
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Total Cap Limit</label>
                        <div class="flex items-center gap-2 border-b border-slate-600 pb-1">
                            <span class="text-slate-500 text-lg">$</span>
                            <input type="number" value="${tl.totalCap}" onchange="budget.targetLock.totalCap=parseFloat(this.value); saveBudget(); window.updateAllHeaders();" class="w-full bg-transparent text-xl font-black text-white outline-none no-spinner placeholder-slate-700">
                        </div>
                    </div>
                    <div class="space-y-5">
                        ${validKeys.map(k => `
                            <div class="relative">
                                <div class="flex justify-between text-[9px] font-black uppercase text-slate-400 mb-1.5">
                                    <span class="tracking-widest">${tl.stages[k].label}</span>
                                    <span id="setup_perc_disp_${k}" class="text-white">${tl.stages[k].ratio.toFixed(1)}%</span>
                                </div>
                                <div class="h-2 bg-slate-800 rounded-full relative overflow-visible">
                                    <div id="setup_bar_${k}" class="absolute h-full bg-blue-600 rounded-full opacity-80 pointer-events-none transition-all duration-300" style="width:0%"></div>
                                    <input type="range" min="0" max="100" step="0.1" value="${tl.stages[k].ratio}" data-stage-key="${k}" class="stage-slider absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" ${tl.stages[k].locked ? 'disabled' : ''}>
                                    <div class="absolute w-4 h-4 bg-white rounded-full top-1/2 -translate-y-1/2 shadow-md pointer-events-none transition-all duration-75" style="left: ${tl.stages[k].ratio}%; margin-left: -8px;"></div>
                                </div>
                            </div>`).join('')}
                    </div>
                    <div class="pt-6 border-t border-slate-800">
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3 block">Distribution Model</label>
                        <select onchange="window.applyStagePreset(this.value); window.showStagesModal();" class="w-full bg-slate-800 text-white text-[10px] font-bold p-3 rounded-xl outline-none border border-slate-700 focus:border-blue-600 transition-colors cursor-pointer appearance-none">
                            <option value="" disabled selected>Load Industry Preset...</option>
                            ${Object.keys(STAGE_PRESETS).map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>`;

        // 2. Overview Card (Burn Rate & Analytics Link)
        const overviewCard = `
            <div id="card-overview" class="stage-card min-w-[320px] w-[320px] flex-shrink-0 bg-white flex flex-col snap-center border-r border-slate-200 h-full">
                <div class="p-8 flex flex-col items-center justify-center border-b border-slate-100 flex-grow relative overflow-hidden">
                    <div class="absolute inset-0 bg-slate-50/50 -skew-y-12 scale-150 origin-bottom-left z-0 pointer-events-none"></div>
                    <div id="burnRateRing" class="w-48 h-48 rounded-full border-[16px] border-slate-100 flex items-center justify-center relative mb-8 transition-all duration-500 z-10 bg-white shadow-sm">
                        <div class="text-center">
                            <span id="burnRateText" class="text-5xl font-black text-slate-300 block leading-none tracking-tighter">0%</span>
                            <span class="text-[9px] font-black uppercase tracking-widest text-slate-400 mt-2 block">Burn Rate</span>
                        </div>
                    </div>
                    <div class="text-center w-full z-10 space-y-4">
                        <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-200 pb-2">
                            <span>Estimated</span>
                            <span id="ovGrandTotal" class="text-slate-800 text-xs">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-400">
                            <span>Cap Limit</span>
                            <span id="ovTotalCap" class="text-slate-800 text-xs">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="p-6 bg-white z-10">
                    <button onclick="openAnalyticsHub()" class="w-full py-4 bg-white border-2 border-slate-100 text-blue-600 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-sm hover:shadow-md hover:border-blue-200 hover:bg-blue-50 transition-all flex items-center justify-center gap-3 group">
                        <span class="scale-125 group-hover:scale-110 transition-transform">${mBTAssets.doctor}</span> Open Analytics Hub
                    </button>
                </div>
            </div>`;

        // 3. Main Modal Structure (Injecting Cards)
        const content = `
            <div class="flex flex-col h-[85vh] w-full max-w-[95vw] bg-white rounded-[32px] shadow-2xl overflow-hidden font-sans">
                <!-- Navigation Header -->
                <div class="flex items-center gap-2 px-4 bg-white border-b border-slate-100 h-14 flex-shrink-0 overflow-x-auto no-scrollbar shadow-sm z-30">
                    <button onclick="document.getElementById('card-setup').scrollIntoView({behavior:'smooth',inline:'center'})" class="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 whitespace-nowrap transition-all shadow-md">Setup</button>
                    <button onclick="document.getElementById('card-overview').scrollIntoView({behavior:'smooth',inline:'center'})" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-blue-600 hover:border-blue-200 whitespace-nowrap transition-all">Overview</button>
                    <div class="w-px h-6 bg-slate-200 mx-2"></div>
                    ${validKeys.map(k => `<button onclick="document.getElementById('card-${k}').scrollIntoView({behavior:'smooth',inline:'center'})" class="px-3 py-2 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition-colors whitespace-nowrap">${tl.stages[k].label}</button>`).join('')}
                </div>
                
                <!-- Horizontal Scroll Area with Injected Cards -->
                <div id="stagesCarousel" class="flex-grow flex overflow-x-auto snap-x snap-mandatory no-scrollbar cursor-grab active:cursor-grabbing select-none bg-slate-100">
                    ${setupCard}
                    ${overviewCard}
                    ${validKeys.map(k => {
                        const config = tl.stages[k];
                        return `
                        <div id="card-${k}" class="stage-card min-w-[340px] w-[340px] flex-shrink-0 flex flex-col h-full bg-white border-r border-slate-200 snap-center relative group">
                            <div class="p-4 bg-white border-b border-slate-50 flex-shrink-0 sticky top-0 z-20 shadow-[0_4px_6px_-1px_rgba(0,0,0,0.02)]">
                                <div class="flex justify-between items-center mb-4">
                                    <div class="flex items-center gap-3">
                                        <button onclick="toggleStageLock('${k}')" class="text-slate-300 hover:text-blue-500 transition-colors p-1 hover:bg-slate-50 rounded-lg">${config.locked ? mBTAssets.lock : mBTAssets.unlock}</button>
                                        <span class="font-black text-xs text-slate-800 uppercase tracking-widest">${config.label}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="relative w-14 group/input">
                                            <input type="number" id="header_perc_${k}" value="${config.ratio.toFixed(1)}" class="stage-number-input w-full text-right text-[10px] font-bold bg-slate-50 rounded-lg px-2 py-1 outline-none no-spinner text-slate-600 focus:text-blue-600 focus:bg-blue-50 focus:ring-2 focus:ring-blue-100 transition-all" data-stage-key="${k}" ${config.locked ? 'disabled' : ''}>
                                            <span class="absolute right-7 top-1/2 -translate-y-1/2 text-[8px] text-slate-400 group-hover/input:text-blue-400 pointer-events-none">%</span>
                                        </div>
                                        <div class="relative w-12 group/days">
                                            <input type="number" value="${config.days}" onchange="budget.targetLock.stages['${k}'].days=parseFloat(this.value); saveBudget(); handleStageBulkAction('syncDays');" class="w-full text-center text-[10px] font-bold bg-slate-50 rounded-lg px-1 py-1 outline-none no-spinner text-blue-600 focus:ring-2 focus:ring-blue-100" placeholder="0">
                                            <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[6px] text-slate-300 font-black uppercase pointer-events-none">Day</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1.5 mb-3 overflow-hidden"><div id="bar-${k}" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                                <div class="flex justify-between text-[9px] font-mono font-bold text-slate-400 mb-4"><span id="total-${k}" class="text-slate-600">$0</span><span id="limit-${k}">Cap: $0</span></div>
                                <button onclick="handleStageAddItem('${k}')" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-blue-600 hover:text-white hover:shadow-lg transition-all flex items-center justify-center gap-2 transform active:scale-95">${mBTAssets.plus} Add Item</button>
                            </div>
                            <div class="stage-drop-zone flex-grow overflow-y-auto p-3 space-y-3 bg-slate-50/50 no-scrollbar pb-10" data-stage-key="${k}" ondragover="handleStageDragOver(event)" ondragleave="handleStageDragLeave(event)" ondrop="handleStageDrop(event, '${k}')">
                                ${renderStageItems(k)}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;

        mBTME.open('stagesView', '', content, 'max-w-none w-fit bg-transparent shadow-none', { hideHeader: true, noPadding: true, onOpen: () => {
            if (typeof initializeStageDragAndDrop === 'function') initializeStageDragAndDrop();
            
            // Interaction Bindings for Real-time Slider Sync
            const bindInput = (el) => {
                el.addEventListener('input', (e) => {
                    if(typeof balanceStageSliders === 'function') balanceStageSliders(e.target.dataset.stageKey, parseFloat(e.target.value));
                    if(window.updateAllHeaders) window.updateAllHeaders();
                });
                el.addEventListener('change', () => saveBudget());
            };
            document.querySelectorAll('.stage-slider').forEach(bindInput);
            document.querySelectorAll('.stage-number-input').forEach(bindInput);

            // Header Update Logic
            window.updateAllHeaders = () => {
                const metrics = mBTStagesEngine.getMetrics();
                const burn = mBTStagesEngine.getBurnStatus(metrics.grandTotal, metrics.totalCap);
                
                // Update Overview
                const ovGrandTotal = document.getElementById('ovGrandTotal');
                const ovTotalCap = document.getElementById('ovTotalCap');
                if(ovGrandTotal) ovGrandTotal.textContent = mBTLE.format.currency(metrics.grandTotal);
                if(ovTotalCap) ovTotalCap.textContent = mBTLE.format.currency(metrics.totalCap);

                const ring = document.getElementById('burnRateRing');
                const ringTxt = document.getElementById('burnRateText');
                if(ring && ringTxt) {
                    ring.className = `w-48 h-48 rounded-full border-[16px] ${burn.ring} flex items-center justify-center relative mb-8 transition-all duration-500 z-10 bg-white shadow-sm`;
                    ringTxt.className = `text-5xl font-black ${burn.color} block leading-none tracking-tighter`;
                    ringTxt.textContent = Math.round(burn.pct) + '%';
                }

                validKeys.forEach(k => {
                    const cfg = budget.targetLock.stages[k];
                    const cap = metrics.totalCap * (cfg.ratio / 100);
                    const total = metrics.stageTotals[k];
                    
                    // Sync Sliders/Inputs
                    const slider = document.querySelector(`.stage-slider[data-stage-key="${k}"]`);
                    const numInput = document.querySelector(`#header_perc_${k}`);
                    const dispPerc = document.getElementById(`setup_perc_disp_${k}`);
                    if(slider && document.activeElement !== slider) slider.value = cfg.ratio;
                    if(numInput && document.activeElement !== numInput) numInput.value = cfg.ratio.toFixed(1);
                    if(dispPerc) dispPerc.textContent = cfg.ratio.toFixed(1) + '%';

                    // Update Bars & Text
                    const bar = document.getElementById(`bar-${k}`);
                    const setupBar = document.getElementById(`setup_bar_${k}`);
                    const barColor = total > cap ? 'bg-red-500' : 'bg-blue-500';
                    if(bar) {
                        bar.style.width = Math.min((total/cap)*100, 100) + '%';
                        bar.className = `${barColor} h-full transition-all duration-500`;
                    }
                    if(setupBar) setupBar.style.width = Math.min((total/metrics.totalCap)*100, 100) + '%';
                    
                    const totalEl = document.getElementById(`total-${k}`);
                    const limitEl = document.getElementById(`limit-${k}`);
                    if(totalEl) totalEl.textContent = mBTLE.format.currency(total);
                    if(limitEl) limitEl.textContent = `Cap: ${mBTLE.format.currency(cap)}`;
                });
            };
            window.updateAllHeaders();

            // Drag to Scroll Logic
            const slider = document.getElementById('stagesCarousel');
            if(slider) {
                let isDown = false; let startX; let scrollLeft;
                slider.addEventListener('mousedown', (e) => {
                    if(['INPUT','BUTTON','SELECT'].includes(e.target.tagName) || e.target.closest('.stage-draggable')) return;
                    isDown = true; startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft;
                });
                slider.addEventListener('mouseleave', () => isDown = false);
                slider.addEventListener('mouseup', () => isDown = false);
                slider.addEventListener('mousemove', (e) => {
                    if(!isDown) return; e.preventDefault();
                    const x = e.pageX - slider.offsetLeft;
                    slider.scrollLeft = scrollLeft - (x - startX) * 2;
                });
            }
        }});
    };

    function renderStageItems(stageKey) {
        let html = '';
        Object.entries(budget.sections).forEach(([secName, sec]) => {
            sec.items.forEach(item => {
                if (item.stageData && item.stageData[stageKey]) {
                    html += RenderEngine.stageCard({
                        ...item,
                        _sDays: item.stageData[stageKey].days,
                        _sRate: item.stageData[stageKey].rate,
                        _sec: secName
                    }, stageKey);
                }
            });
        });
        return html || '<div class="h-32 flex items-center justify-center text-[9px] font-black text-slate-300 uppercase tracking-widest border-2 border-dashed border-slate-100 rounded-xl m-2">Empty Stage</div>';
    }

    // --- B. Main Dashboard Logic ---
    window.showStagesModal = function() {
        if (!budget.targetLock) budget.targetLock = { enabled: false, totalCap: 0, stages: {} };
        const tl = budget.targetLock;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        validKeys.forEach(k => { if (!tl.stages[k]) tl.stages[k] = { label: k.toUpperCase(), ratio: 20, days: 0, locked: false }; });

        // Setup Card HTML
        const setupCard = `
            <div id="card-setup" class="stage-card w-[300px] flex-shrink-0 bg-slate-900 text-white flex flex-col snap-center border-r border-slate-800">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="font-black text-xs uppercase tracking-widest">Configuration</h3>
                    <div class="relative group">
                        <button class="text-slate-400 hover:text-white">${mBTAssets.gear}</button>
                        <!-- Bulk Actions Menu (Simple absolute positioning) -->
                        <div class="hidden group-hover:block absolute right-0 top-full mt-2 w-32 bg-slate-800 border border-slate-700 shadow-xl rounded-xl z-50 overflow-hidden">
                            <button onclick="handleStageBulkAction('syncDays')" class="w-full text-left text-[9px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 px-3 py-2">Sync Days</button>
                            <button onclick="handleStageBulkAction('dedupe')" class="w-full text-left text-[9px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 px-3 py-2">Remove Dupes</button>
                            <button onclick="handleStageBulkAction('lockAll')" class="w-full text-left text-[9px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 px-3 py-2">Lock All</button>
                            <button onclick="handleStageBulkAction('unlockAll')" class="w-full text-left text-[9px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 px-3 py-2">Unlock All</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 space-y-6 overflow-y-auto no-scrollbar">
                    <div>
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Total Cap Limit</label>
                        <div class="flex items-center gap-1 border-b border-slate-700 mt-1">
                            <span class="text-slate-500">$</span>
                            <input type="number" value="${tl.totalCap}" onchange="budget.targetLock.totalCap=parseFloat(this.value); saveBudget(); window.updateAllHeaders();" class="w-full bg-transparent text-xl font-black text-white outline-none no-spinner">
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${validKeys.map(k => `
                            <div class="relative">
                                <div class="flex justify-between text-[9px] font-black uppercase text-slate-400 mb-1">
                                    <span>${tl.stages[k].label}</span>
                                    <span id="setup_perc_disp_${k}">${tl.stages[k].ratio.toFixed(1)}%</span>
                                </div>
                                <div class="h-2 bg-slate-800 rounded-full relative">
                                    <div id="setup_bar_${k}" class="absolute h-full bg-blue-600 rounded-full opacity-50" style="width:0%"></div>
                                    <input type="range" min="0" max="100" step="0.1" value="${tl.stages[k].ratio}" data-stage-key="${k}" class="stage-slider absolute inset-0 w-full h-full opacity-0 cursor-pointer" ${tl.stages[k].locked ? 'disabled' : ''}>
                                    <div class="absolute w-3 h-3 bg-white rounded-full top-1/2 -translate-y-1/2 pointer-events-none transition-all shadow-sm" style="left: ${tl.stages[k].ratio}%"></div>
                                </div>
                            </div>`).join('')}
                    </div>
                    <div class="pt-4 border-t border-slate-800">
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2 block">Distribution Model</label>
                        <select onchange="window.applyStagePreset(this.value); window.showStagesModal();" class="w-full bg-slate-800 text-white text-[10px] font-bold p-2 rounded outline-none border border-slate-700 focus:border-blue-600 transition-colors">
                            <option value="" disabled selected>Load Industry Preset...</option>
                            ${Object.keys(STAGE_PRESETS).map(k => `<option value="${k}">${k}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>`;

        // Overview Card HTML
        const overviewCard = `
            <div id="card-overview" class="stage-card w-[300px] flex-shrink-0 bg-white flex flex-col snap-center border-r border-slate-100">
                <div class="p-8 flex flex-col items-center justify-center border-b border-slate-50 flex-grow">
                    <div id="burnRateRing" class="w-40 h-40 rounded-full border-[12px] border-slate-100 flex items-center justify-center relative mb-6 transition-all duration-500">
                        <div class="text-center">
                            <span id="burnRateText" class="text-4xl font-black text-slate-300 block leading-none">0%</span>
                            <span class="text-[9px] font-black uppercase tracking-widest text-slate-400 mt-1 block">Burn Rate</span>
                        </div>
                    </div>
                    <div class="text-center w-full">
                        <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-50 pb-2 mb-2">
                            <span>Estimated</span>
                            <span id="ovGrandTotal" class="text-slate-800">$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-400">
                            <span>Cap Limit</span>
                            <span id="ovTotalCap" class="text-slate-800">$0.00</span>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-slate-50/50">
                    <button onclick="openAnalyticsHub()" class="w-full py-4 bg-white border border-slate-200 text-blue-600 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-sm hover:shadow-md hover:border-blue-300 transition-all flex items-center justify-center gap-2">
                        ${mBTAssets.doctor} Open Analytics Hub
                    </button>
                </div>
            </div>`;

        // Combine
        const content = `
            <div class="flex flex-col h-[85vh] w-full max-w-[95vw] bg-white rounded-xl shadow-2xl overflow-hidden font-sans">
                <!-- Navigation -->
                <div class="flex items-center gap-1 px-2 bg-slate-50 border-b border-slate-100 h-10 flex-shrink-0 overflow-x-auto no-scrollbar">
                    <button onclick="document.getElementById('card-setup').scrollIntoView({behavior:'smooth',inline:'center'})" class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-[9px] font-black uppercase tracking-widest text-slate-500 hover:text-blue-600 hover:border-blue-200 whitespace-nowrap transition-all shadow-sm">Setup</button>
                    <button onclick="document.getElementById('card-overview').scrollIntoView({behavior:'smooth',inline:'center'})" class="px-3 py-1 bg-white border border-slate-200 rounded-lg text-[9px] font-black uppercase tracking-widest text-slate-500 hover:text-blue-600 hover:border-blue-200 whitespace-nowrap transition-all shadow-sm">Overview</button>
                    <div class="w-px h-4 bg-slate-300 mx-2"></div>
                    ${validKeys.map(k => `<button onclick="document.getElementById('card-${k}').scrollIntoView({behavior:'smooth',inline:'center'})" class="px-2 text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-blue-600 transition-colors">${tl.stages[k].label}</button>`).join('')}
                </div>
                
                <!-- Carousel -->
                <div id="stagesCarousel" class="flex-grow flex overflow-x-auto snap-x snap-mandatory no-scrollbar cursor-grab active:cursor-grabbing select-none bg-slate-100">
                    ${setupCard}
                    ${overviewCard}
                    ${validKeys.map(k => {
                        const config = tl.stages[k];
                        return `
                        <div id="card-${k}" class="stage-card w-[340px] flex-shrink-0 flex flex-col h-full bg-white border-r border-slate-100 snap-center relative">
                            <div class="p-3 bg-white border-b border-slate-50 flex-shrink-0 sticky top-0 z-20 shadow-[0_4px_6px_-1px_rgba(0,0,0,0.02)]">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="flex items-center gap-2">
                                        <button onclick="budget.targetLock.stages['${k}'].locked = !budget.targetLock.stages['${k}'].locked; saveBudget(); showStagesModal();" class="text-slate-300 hover:text-blue-500 transition-colors">${config.locked ? mBTAssets.lock : mBTAssets.unlock}</button>
                                        <span class="font-black text-[10px] text-slate-700 uppercase tracking-widest">${config.label}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="relative w-12 group">
                                            <input type="number" id="header_perc_${k}" value="${config.ratio.toFixed(1)}" class="stage-number-input w-full text-right text-[10px] font-bold bg-slate-50 rounded px-1 outline-none no-spinner text-slate-600 focus:text-blue-600 focus:bg-blue-50 transition-colors" data-stage-key="${k}" ${config.locked ? 'disabled' : ''}>
                                            <span class="absolute right-6 top-0 text-[8px] text-slate-400 group-hover:text-blue-400">%</span>
                                        </div>
                                        <input type="number" value="${config.days}" onchange="budget.targetLock.stages['${k}'].days=parseFloat(this.value); saveBudget(); handleStageBulkAction('syncDays');" class="w-8 text-center text-[10px] font-bold bg-slate-50 rounded outline-none no-spinner text-blue-600 focus:ring-1 focus:ring-blue-200" placeholder="Day">
                                    </div>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-1.5 mb-2 overflow-hidden"><div id="bar-${k}" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                                <div class="flex justify-between text-[9px] font-mono font-bold text-slate-400 mb-2"><span id="total-${k}">$0</span><span id="limit-${k}">Cap: $0</span></div>
                                <button onclick="handleStageAddItem('${k}')" class="w-full py-2 bg-blue-50 text-blue-600 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-blue-100 hover:shadow-inner transition-all flex items-center justify-center gap-1">${mBTAssets.plus} Add Item</button>
                            </div>
                            <div class="stage-drop-zone flex-grow overflow-y-auto p-2 space-y-2 bg-slate-50/50 no-scrollbar" data-stage-key="${k}">
                                ${renderStageItems(k)}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;

        mBTME.open('stagesView', '', content, 'max-w-none w-fit bg-transparent shadow-none', { hideHeader: true, noPadding: true, onOpen: () => {
            initializeStageDragAndDrop();
            
            // Interaction Bindings
            const bindInput = (el) => {
                el.addEventListener('input', (e) => {
                    balanceStageSliders(e.target.dataset.stageKey, parseFloat(e.target.value));
                    window.updateAllHeaders();
                });
                el.addEventListener('change', () => saveBudget());
            };
            document.querySelectorAll('.stage-slider').forEach(bindInput);
            document.querySelectorAll('.stage-number-input').forEach(bindInput);

            // Drag to Scroll Logic
            const slider = document.getElementById('stagesCarousel');
            if(slider) {
                let isDown = false; let startX; let scrollLeft;
                slider.addEventListener('mousedown', (e) => {
                    if(['INPUT','BUTTON','SELECT'].includes(e.target.tagName) || e.target.closest('.stage-draggable')) return;
                    isDown = true; startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft;
                });
                slider.addEventListener('mouseleave', () => isDown = false);
                slider.addEventListener('mouseup', () => isDown = false);
                slider.addEventListener('mousemove', (e) => {
                    if(!isDown) return; e.preventDefault();
                    const x = e.pageX - slider.offsetLeft;
                    slider.scrollLeft = scrollLeft - (x - startX) * 2;
                });
            }
        }});
    };

    window.openAnalyticsHub = function() {
        // 1. Data Crunching
        let allItems = [];
        let deptTotals = {};
        let grandTotal = 0;

        // Calculate totals based on STAGE DATA (More accurate than main budget)
        Object.entries(budget.sections).forEach(([secName, section]) => {
            let secTotal = 0;
            section.items.forEach(item => {
                let itemTotal = 0;
                if (item.stageData) {
                    Object.values(item.stageData).forEach(d => {
                        itemTotal += (parseFloat(d.days) || 0) * (parseFloat(d.rate) || 0);
                    });
                } else {
                    itemTotal = (parseFloat(item.quantity) || 0) * (parseFloat(item.rate) || 0);
                }

                if (itemTotal > 0) {
                    grandTotal += itemTotal;
                    secTotal += itemTotal;
                    allItems.push({ name: item.description, sec: secName, total: itemTotal });
                }
            });
            if (secTotal > 0) deptTotals[secName] = secTotal;
        });

        // Sort Drivers by TOTAL (Descending)
        allItems.sort((a, b) => b.total - a.total);
        const topDrivers = allItems.slice(0, 10);

        // Sort Depts by TOTAL
        const topDepts = Object.entries(deptTotals)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 6);

        // 2. Build Content
        const content = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 h-[500px] overflow-y-auto no-scrollbar bg-slate-50">
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                    <h3 class="text-[10px] font-black text-slate-800 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="bg-rose-50 text-rose-600 p-1 rounded-lg"></span> Primary Cost Drivers
                    </h3>
                    <div class="space-y-3">
                        ${topDrivers.map((item, idx) => {
                            const percent = ((item.total / grandTotal) * 100).toFixed(1);
                            return `
                            <div class="relative text-xs">
                                <div class="flex justify-between items-end mb-1 relative z-10">
                                    <span class="font-bold text-slate-700 text-[10px] uppercase">${idx+1}. ${item.name}</span>
                                    <div class="text-right">
                                        <span class="font-black block text-slate-900 font-mono text-[10px]">${formatAbbreviated(item.total, displayCurrency)}</span>
                                        <span class="text-[9px] font-bold text-slate-400">${percent}%</span>
                                    </div>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-rose-400" style="width: ${percent * 4}%"></div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                    <h3 class="text-[10px] font-black text-slate-800 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="bg-blue-50 text-blue-600 p-1 rounded-lg"></span> Dept. Breakdown
                    </h3>
                    <div class="space-y-4">
                        ${topDepts.map(([name, total]) => {
                            const percent = ((total / grandTotal) * 100).toFixed(1);
                            return `
                            <div class="text-xs">
                                <div class="flex justify-between mb-1">
                                    <span class="font-bold text-slate-600 text-[10px] uppercase">${name}</span>
                                    <span class="font-black text-slate-900 text-[10px]">${percent}%</span>
                                </div>
                                <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden flex">
                                    <div class="h-full bg-blue-600" style="width: ${percent}%"></div>
                                </div>
                                <div class="text-right text-[9px] font-bold font-mono text-slate-400 mt-0.5">${formatAbbreviated(total, displayCurrency)}</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            </div>`;

        mBTME.open('analyticsHub', 'Budget Intelligence', content, 'max-w-4xl');
    };
    /* --- 4. Switchboard Bridge Hooks --- */
    window.autofillMtemp = function(docId) {
        const doc = budget.documents.find(d => d.id === docId);
        if (doc && typeof mBTPublisher !== 'undefined') {
            mBTPublisher.processAutofill(doc, budget);
            if (typeof openDocumentViewer === 'function') openDocumentViewer(docId);
        }
    };


// --- Tier 5 Part 4 --- //
/* ========= v19.54 CONNECTIVE UI & Interaction Handlers ========= */
/* --- 1. UI Module: Project & Status Bar Resolution --- */
    // Logic Resolution: Async Project Management UI to handle Promise-based storage
    async function renderProjectManagement() {
        const container = document.getElementById('project-management-container');
        if (!container) return; 

        // Logic Resolution: Await the async storage list via the new Data Engine
        // Fallback to empty array if mBT.data is initializing or unavailable
        let projects = (mBT.data && mBT.data.getList) ? await mBT.data.getList() : [];
        
        // Tier 5 Fix: Sort projects descending (Newest first)
        // This ensures recent projects (named with dates) appear at the top.
        projects.sort().reverse();
        
        // Logic Resolution: Define Menu Structure with 'Budget First' philosophy
        const menuItems = [
            { label: 'New Budget', icon: mBTAssets.plus, color: 'text-emerald-600', bg: 'hover:bg-emerald-50', action: 'project-new' },
            { label: 'Duplicate Budget', icon: mBTAssets.copy, color: 'text-blue-600', bg: 'hover:bg-blue-50', action: 'project-duplicate' },
            { label: 'Save as Blueprint', icon: mBTAssets.save, color: 'text-indigo-600', bg: 'hover:bg-indigo-50', action: 'blueprint-save' },
            { label: 'Import Budget', icon: mBTAssets.cloud, color: 'text-purple-600', bg: 'hover:bg-purple-50', action: 'project-import-trigger' },
            { label: 'Recycle Bin', icon: mBTAssets.trash, color: 'text-slate-500', bg: 'hover:bg-slate-50', action: 'project-recycle' },
            { label: 'LiveStream Data', icon: mBTAssets.zap, color: 'text-amber-600', bg: 'hover:bg-amber-50', action: 'project-sync' },
            { divider: true },
            { label: 'Delete Budget', icon: mBTAssets.trash, color: 'text-rose-600', bg: 'hover:bg-rose-50', action: 'project-delete' }
        ];

        let html = `
            <div class="flex items-center gap-2 bg-white p-1 rounded-2xl border border-slate-200 shadow-sm relative z-50">
                <!-- Project Select -->
                <div class="relative group">
                    <select id="projectSelect" data-action="project-switch" class="appearance-none bg-slate-50 border-none text-[10px] font-black uppercase tracking-widest text-slate-700 rounded-xl pl-3 pr-8 py-2.5 outline-none focus:ring-2 focus:ring-blue-100 cursor-pointer min-w-[140px] transition-all hover:bg-slate-100">
        `;

        // Logic Resolution: Handle empty states or fresh boots gracefully
        if (projects.length === 0 && typeof currentProjectName !== 'undefined' && currentProjectName) {
             html += `<option value="${currentProjectName}" selected>${currentProjectName}</option>`;
        }

        projects.forEach(p => {
            const selected = (typeof currentProjectName !== 'undefined' && p === currentProjectName) ? 'selected' : '';
            html += `<option value="${p}" ${selected}>${p}</option>`;
        });

        html += `
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400 group-hover:text-slate-600">
                        <svg class="fill-current h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>

                <!-- File Menu (Consolidated) -->
                <div class="relative">
                    <button onclick="const m=document.getElementById('fileMenuDropdown'); m.classList.toggle('hidden');" class="flex items-center gap-2 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 hover:text-emerald-700 px-4 py-2.5 rounded-xl transition-all active:scale-95 group">
                        <span class="text-[10px] font-black uppercase tracking-widest">File</span>
                        <svg class="w-3 h-3 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    
                    <!-- Dropdown -->
                    <div id="fileMenuDropdown" class="hidden absolute right-0 top-full mt-2 w-56 bg-white border border-slate-100 rounded-xl shadow-xl z-50 overflow-hidden py-1 animate-in fade-in slide-in-from-top-2 duration-200" onmouseleave="this.classList.add('hidden')">
                        ${menuItems.map(item => item.divider ? 
                            `<div class="h-px bg-slate-100 my-1"></div>` : 
                            `<button data-action="${item.action}" onclick="document.getElementById('fileMenuDropdown').classList.add('hidden')" class="w-full text-left px-4 py-2.5 flex items-center gap-3 ${item.color} ${item.bg} transition-colors group">
                                <span class="opacity-70 group-hover:opacity-100 scale-90">${item.icon}</span>
                                <span class="text-[9px] font-black uppercase tracking-widest">${item.label}</span>
                            </button>`
                        ).join('')}
                    </div>
                </div>
                
                <!-- Hidden Import Input -->
                <input type="file" id="importFile" class="hidden" accept=".json" data-action="project-import-file">
            </div>
        `;

        container.innerHTML = html;
    }
    // --- B. Global Action Wrappers (Legacy Compatibility for Tier 1.5) ---
    // Logic Resolution: Connecting HTML event listeners to the new mBT.data Engine
    
    window.handleProjectChange = async function(select) {
        if (select.value) {
            // Show simple feedback before the async load finishes
            const originalText = select.options[select.selectedIndex].text;
            select.options[select.selectedIndex].text = "Loading...";
            await mBT.data.load(select.value);
        }
    };

    window.handleNewProject = async function(force) {
        await mBT.data.newProject(force);
    };
    
    // Bridging Tier 1.5 Boot calls to Tier 2 Data Engine
    window.getProjectList = () => mBT.data.getList(); 
    window.loadBudget = (name) => mBT.data.load(name);

    function renderStatusBar() {
        const container = document.getElementById('statusBar');
        if (!container) return;
        const lastAction = historyStack[historyIndex]?.description || "ENVIRONMENT READY";
        container.innerHTML = `
            <span id="statusBarMessage" class="truncate pr-4">${lastAction}</span>
            <div class="flex gap-2 flex-shrink-0 border-l border-white/20 pl-4">
                <button id="undoBtn" class="hover:text-blue-400 transition-colors" ${historyIndex <= 0 ? 'disabled style="opacity:0.3"' : ''}>UNDO</button>
                <button id="redoBtn" class="hover:text-blue-400 transition-colors" ${historyIndex >= historyStack.length - 1 ? 'disabled style="opacity:0.3"' : ''}>REDO</button>
            </div>`;
    }
    /* --- 2. History & State Resolution --- */
    function handleUndo() {
        if (historyIndex > 0) {
            historyIndex--;
            budget = mBTState.wrap(JSON.parse(JSON.stringify(historyStack[historyIndex].budget)));
            render();
        }
    }
    function handleRedo() {
        if (historyIndex < historyStack.length - 1) {
            historyIndex++;
            budget = mBTState.wrap(JSON.parse(JSON.stringify(historyStack[historyIndex].budget)));
            render();
        }
    }
    /* --- 3. Telemetry: Exchange Rate Resolution --- */
    async function fetchExchangeRates() {
        if (!navigator.onLine) return;
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/USD');
            const data = await res.json();
            if (data?.rates) {
                exchangeRates = data.rates;
                localStorage.setItem(`${storageKeyPrefix}rates`, JSON.stringify(exchangeRates));
            }
        } catch (e) { console.warn("Currency synchronization failure."); }
    }
    /* --- 4. Interactive Routing Logic --- */
    function handleNewProjectSelection(e) {
        const val = e.target.value;
        if (val === 'Duplicate') handleDuplicateProject();
        else if (val === 'Import') document.getElementById('importMooFile').click();
        else if (val === 'Restore') { 
            // UPDATED: Using new Namespace
            if(typeof mBT.features.trash !== 'undefined') mBT.features.trash.open('projects'); 
        }
        else if (val === 'LiveStream') { 
            fetchExchangeRates(); 
            alert("Live Stream: Currency & Data Synchronized."); 
        }
        else if (val) handleNewProject(true, val);
        e.target.value = "";
    }

    function handleImportFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.projectName) throw new Error("Invalid file structure");
                
                const existing = localStorage.getItem(storageKeyPrefix + data.projectName);
                if (existing) {
                    if (!confirm(`Overwrite existing project "${data.projectName}"?`)) {
                        input.value = '';
                        return;
                    }
                }
                
                budget = mBTState.wrap(data);
                saveBudget();
                loadBudget(data.projectName);
                if(typeof renderProjectManagement === 'function') renderProjectManagement(); // refresh list
                alert("Project environment restored.");
            } catch (err) {
                alert("Import failed: " + err.message);
            }
            input.value = '';
        };
        reader.readAsText(file);
    }

    // --- PHASE 3: Global Bridge for Contact CSV Import ---
    window.importContactsCSV = function(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            if (!text) return;
            
            // Lightweight Parser (Newline -> Comma)
            const lines = text.split(/\r\n|\n/);
            if (lines.length < 2) return alert("Invalid CSV format.");
            
            const headers = lines[0].split(',').map(h => h.trim());
            const contacts = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.split(',');
                const obj = {};
                
                // Map values to headers
                headers.forEach((h, idx) => {
                    let val = values[idx] ? values[idx].trim() : '';
                    // Basic quote cleaning
                    if(val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                    obj[h] = val;
                });
                contacts.push(obj);
            }

            // Handshake with Open Gate (Tier 2.5)
            const count = mBTOG.ingest(contacts, 'contact');
            
            if (count > 0) {
                alert(`Success: ${count} new contacts imported.`);
                // Refresh Settings UI (Tier 5)
                showSettingsModal('database', 'contacts');
            } else {
                alert("Import completed. No new contacts added (duplicates skipped).");
            }
            input.value = '';
        };
        reader.readAsText(file);
    };

    function deleteProject(name) {
        if (confirm(`Move "${name}" to Bin?`)) {
            // Backup before delete
            const data = localStorage.getItem(storageKeyPrefix + name);
            if(data) {
                const trashed = JSON.parse(localStorage.getItem(trashKey) || '[]');
                trashed.push(JSON.parse(data));
                localStorage.setItem(trashKey, JSON.stringify(trashed));
            }
            
            localStorage.removeItem(storageKeyPrefix + name);
            const list = getProjectList();
            if (list.length) loadBudget(list[0]); else handleNewProject();
            if(typeof renderProjectManagement === 'function') renderProjectManagement();
        }
    }
/* --- Feature: Production Stages Carousel --- */
window.showStagesModal = function() {
    if (!budget.targetLock) budget.targetLock = { enabled: false, totalCap: 0, stages: {} };
    const tl = budget.targetLock;
    const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
    validKeys.forEach(k => { if (!tl.stages[k]) tl.stages[k] = { label: k.toUpperCase(), ratio: 20, days: 0, locked: false }; });

    // 1. Setup Card (Configuration & Sliders)
    const setupCard = `
        <div id="card-setup" class="stage-card min-w-[320px] w-[320px] flex-shrink-0 bg-slate-900 text-white flex flex-col snap-center border-r border-slate-800 h-full rounded-l-[24px]">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-black text-xs uppercase tracking-widest text-slate-400">Configuration</h3>
                <div class="relative group">
                    <button class="text-slate-400 hover:text-white transition-colors">${mBTAssets.gear}</button>
                    <!-- Bulk Actions Menu (Simple absolute positioning) -->
                    <div class="hidden group-hover:block absolute right-0 top-full mt-2 w-40 bg-white border border-slate-200 shadow-xl rounded-xl z-50 overflow-hidden">
                        <div class="p-2 border-b border-slate-100 text-[9px] font-black text-slate-400 uppercase tracking-widest bg-slate-50">Bulk Actions</div>
                        <button onclick="handleStageBulkAction('syncDays')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 transition-colors">Sync Days</button>
                        <button onclick="handleStageBulkAction('dedupe')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:text-red-600 hover:bg-red-50 px-4 py-2 transition-colors">Remove Dupes</button>
                        <div class="border-t border-slate-100 my-1"></div>
                        <button onclick="handleStageBulkAction('lockAll')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:bg-slate-50 px-4 py-2 transition-colors">Lock All</button>
                        <button onclick="handleStageBulkAction('unlockAll')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:bg-slate-50 px-4 py-2 transition-colors">Unlock All</button>
                    </div>
                </div>
            </div>
            <div class="p-5 space-y-6 overflow-y-auto no-scrollbar">
                <div>
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Total Cap Limit</label>
                    <div class="flex items-center gap-2 border-b border-slate-600 pb-1">
                        <span class="text-slate-500 text-lg">$</span>
                        <input type="number" value="${tl.totalCap}" onchange="budget.targetLock.totalCap=parseFloat(this.value); saveBudget(); window.updateAllHeaders();" class="w-full bg-transparent text-xl font-black text-white outline-none no-spinner placeholder-slate-700">
                    </div>
                </div>
                <div class="space-y-5">
                    ${validKeys.map(k => `
                        <div class="relative">
                            <div class="flex justify-between text-[9px] font-black uppercase text-slate-400 mb-1.5">
                                <span class="tracking-widest">${tl.stages[k].label}</span>
                                <span id="setup_perc_disp_${k}" class="text-white">${tl.stages[k].ratio.toFixed(1)}%</span>
                            </div>
                            <div class="h-2 bg-slate-800 rounded-full relative overflow-visible">
                                <div id="setup_bar_${k}" class="absolute h-full bg-blue-600 rounded-full opacity-80 pointer-events-none transition-all duration-300" style="width:0%"></div>
                                <input type="range" min="0" max="100" step="0.1" value="${tl.stages[k].ratio}" data-stage-key="${k}" class="stage-slider absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" ${tl.stages[k].locked ? 'disabled' : ''}>
                                <div class="absolute w-4 h-4 bg-white rounded-full top-1/2 -translate-y-1/2 shadow-md pointer-events-none transition-all duration-75" style="left: ${tl.stages[k].ratio}%; margin-left: -8px;"></div>
                            </div>
                        </div>`).join('')}
                </div>
                <div class="pt-6 border-t border-slate-800">
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3 block">Distribution Model</label>
                    <select onchange="window.applyStagePreset(this.value); window.showStagesModal();" class="w-full bg-slate-800 text-white text-[10px] font-bold p-3 rounded-xl outline-none border border-slate-700 focus:border-blue-600 transition-colors cursor-pointer appearance-none">
                        <option value="" disabled selected>Load Industry Preset...</option>
                        ${Object.keys(STAGE_PRESETS).map(k => `<option value="${k}">${k}</option>`).join('')}
                    </select>
                </div>
            </div>
        </div>`;

    // 2. Overview Card (Burn Rate & Analytics Link)
    const overviewCard = `
        <div id="card-overview" class="stage-card min-w-[320px] w-[320px] flex-shrink-0 bg-white flex flex-col snap-center border-r border-slate-200 h-full">
            <div class="p-8 flex flex-col items-center justify-center border-b border-slate-100 flex-grow relative overflow-hidden">
                <div class="absolute inset-0 bg-slate-50/50 -skew-y-12 scale-150 origin-bottom-left z-0 pointer-events-none"></div>
                <div id="burnRateRing" class="w-48 h-48 rounded-full border-[16px] border-slate-100 flex items-center justify-center relative mb-8 transition-all duration-500 z-10 bg-white shadow-sm">
                    <div class="text-center">
                        <span id="burnRateText" class="text-5xl font-black text-slate-300 block leading-none tracking-tighter">0%</span>
                        <span class="text-[9px] font-black uppercase tracking-widest text-slate-400 mt-2 block">Burn Rate</span>
                    </div>
                </div>
                <div class="text-center w-full z-10 space-y-4">
                    <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-200 pb-2">
                        <span>Estimated</span>
                        <span id="ovGrandTotal" class="text-slate-800 text-xs">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-400">
                        <span>Cap Limit</span>
                        <span id="ovTotalCap" class="text-slate-800 text-xs">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-white z-10">
                <button onclick="openAnalyticsHub()" class="w-full py-4 bg-white border-2 border-slate-100 text-blue-600 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-sm hover:shadow-md hover:border-blue-200 hover:bg-blue-50 transition-all flex items-center justify-center gap-3 group">
                    <span class="scale-125 group-hover:scale-110 transition-transform">${mBTAssets.doctor}</span> Open Analytics Hub
                </button>
            </div>
        </div>`;

    // 3. Main Modal Structure (Injecting Cards)
    const content = `
        <div class="flex flex-col h-[85vh] w-full max-w-[95vw] bg-white rounded-[32px] shadow-2xl overflow-hidden font-sans">
            <!-- Navigation Header -->
            <div class="flex items-center gap-2 px-4 bg-white border-b border-slate-100 h-14 flex-shrink-0 overflow-x-auto no-scrollbar shadow-sm z-30">
                <button onclick="document.getElementById('card-setup').scrollIntoView({behavior:'smooth',inline:'center'})" class="px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 whitespace-nowrap transition-all shadow-md">Setup</button>
                <button onclick="document.getElementById('card-overview').scrollIntoView({behavior:'smooth',inline:'center'})" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-blue-600 hover:border-blue-200 whitespace-nowrap transition-all">Overview</button>
                <div class="w-px h-6 bg-slate-200 mx-2"></div>
                ${validKeys.map(k => `<button onclick="document.getElementById('card-${k}').scrollIntoView({behavior:'smooth',inline:'center'})" class="px-3 py-2 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition-colors whitespace-nowrap">${tl.stages[k].label}</button>`).join('')}
            </div>
            
            <!-- Horizontal Scroll Area with Injected Cards -->
            <div id="stagesCarousel" class="flex-grow flex overflow-x-auto snap-x snap-mandatory no-scrollbar cursor-grab active:cursor-grabbing select-none bg-slate-100">
                ${setupCard}
                ${overviewCard}
                ${validKeys.map(k => {
                    const config = tl.stages[k];
                    return `
                    <div id="card-${k}" class="stage-card min-w-[340px] w-[340px] flex-shrink-0 flex flex-col h-full bg-white border-r border-slate-200 snap-center relative group">
                        <div class="p-4 bg-white border-b border-slate-50 flex-shrink-0 sticky top-0 z-20 shadow-[0_4px_6px_-1px_rgba(0,0,0,0.02)]">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-3">
                                    <button onclick="budget.targetLock.stages['${k}'].locked = !budget.targetLock.stages['${k}'].locked; saveBudget(); showStagesModal();" class="text-slate-300 hover:text-blue-500 transition-colors p-1 hover:bg-slate-50 rounded-lg">${config.locked ? mBTAssets.lock : mBTAssets.unlock}</button>
                                    <span class="font-black text-xs text-slate-800 uppercase tracking-widest">${config.label}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="relative w-14 group/input">
                                        <input type="number" id="header_perc_${k}" value="${config.ratio.toFixed(1)}" class="stage-number-input w-full text-right text-[10px] font-bold bg-slate-50 rounded-lg px-2 py-1 outline-none no-spinner text-slate-600 focus:text-blue-600 focus:bg-blue-50 focus:ring-2 focus:ring-blue-100 transition-all" data-stage-key="${k}" ${config.locked ? 'disabled' : ''}>
                                        <span class="absolute right-7 top-1/2 -translate-y-1/2 text-[8px] text-slate-400 group-hover/input:text-blue-400 pointer-events-none">%</span>
                                    </div>
                                    <div class="relative w-12 group/days">
                                        <input type="number" value="${config.days}" onchange="budget.targetLock.stages['${k}'].days=parseFloat(this.value); saveBudget(); handleStageBulkAction('syncDays');" class="w-full text-center text-[10px] font-bold bg-slate-50 rounded-lg px-1 py-1 outline-none no-spinner text-blue-600 focus:ring-2 focus:ring-blue-100" placeholder="0">
                                        <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[6px] text-slate-300 font-black uppercase pointer-events-none">Day</span>
                                    </div>
                                </div>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mb-3 overflow-hidden"><div id="bar-${k}" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                            <div class="flex justify-between text-[9px] font-mono font-bold text-slate-400 mb-4"><span id="total-${k}" class="text-slate-600">$0</span><span id="limit-${k}">Cap: $0</span></div>
                            <button onclick="handleStageAddItem('${k}')" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-blue-600 hover:text-white hover:shadow-lg transition-all flex items-center justify-center gap-2 transform active:scale-95">${mBTAssets.plus} Add Item</button>
                        </div>
                        <div class="stage-drop-zone flex-grow overflow-y-auto p-3 space-y-3 bg-slate-50/50 no-scrollbar pb-10" data-stage-key="${k}">
                            ${renderStageItems(k)}
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>`;

    mBTME.open('stagesView', '', content, 'max-w-none w-fit bg-transparent shadow-none', { hideHeader: true, noPadding: true, onOpen: () => {
        if (typeof initializeStageDragAndDrop === 'function') initializeStageDragAndDrop();
        
        // Interaction Bindings for Real-time Slider Sync
        const bindInput = (el) => {
            el.addEventListener('input', (e) => {
                if(typeof balanceStageSliders === 'function') balanceStageSliders(e.target.dataset.stageKey, parseFloat(e.target.value));
                if(window.updateAllHeaders) window.updateAllHeaders();
            });
            el.addEventListener('change', () => saveBudget());
        };
        document.querySelectorAll('.stage-slider').forEach(bindInput);
        document.querySelectorAll('.stage-number-input').forEach(bindInput);

        // Header Update Logic
        window.updateAllHeaders = () => {
            const metrics = mBTStagesEngine.getMetrics();
            const burn = mBTStagesEngine.getBurnStatus(metrics.grandTotal, metrics.totalCap);
            
            // Update Overview
            const ovGrandTotal = document.getElementById('ovGrandTotal');
            const ovTotalCap = document.getElementById('ovTotalCap');
            if(ovGrandTotal) ovGrandTotal.textContent = mBTLE.format.currency(metrics.grandTotal);
            if(ovTotalCap) ovTotalCap.textContent = mBTLE.format.currency(metrics.totalCap);

            const ring = document.getElementById('burnRateRing');
            const ringTxt = document.getElementById('burnRateText');
            if(ring && ringTxt) {
                ring.className = `w-48 h-48 rounded-full border-[16px] ${burn.ring} flex items-center justify-center relative mb-8 transition-all duration-500 z-10 bg-white shadow-sm`;
                ringTxt.className = `text-5xl font-black ${burn.color} block leading-none tracking-tighter`;
                ringTxt.textContent = Math.round(burn.pct) + '%';
            }

            validKeys.forEach(k => {
                const cfg = budget.targetLock.stages[k];
                const cap = metrics.totalCap * (cfg.ratio / 100);
                const total = metrics.stageTotals[k];
                
                // Sync Sliders/Inputs
                const slider = document.querySelector(`.stage-slider[data-stage-key="${k}"]`);
                const numInput = document.querySelector(`#header_perc_${k}`);
                const dispPerc = document.getElementById(`setup_perc_disp_${k}`);
                if(slider && document.activeElement !== slider) slider.value = cfg.ratio;
                if(numInput && document.activeElement !== numInput) numInput.value = cfg.ratio.toFixed(1);
                if(dispPerc) dispPerc.textContent = cfg.ratio.toFixed(1) + '%';

                // Update Bars & Text
                const bar = document.getElementById(`bar-${k}`);
                const setupBar = document.getElementById(`setup_bar_${k}`);
                const barColor = total > cap ? 'bg-red-500' : 'bg-blue-500';
                if(bar) {
                    bar.style.width = Math.min((total/cap)*100, 100) + '%';
                    bar.className = `${barColor} h-full transition-all duration-500`;
                }
                if(setupBar) setupBar.style.width = Math.min((total/metrics.totalCap)*100, 100) + '%';
                
                const totalEl = document.getElementById(`total-${k}`);
                const limitEl = document.getElementById(`limit-${k}`);
                if(totalEl) totalEl.textContent = mBTLE.format.currency(total);
                if(limitEl) limitEl.textContent = `Cap: ${mBTLE.format.currency(cap)}`;
            });
        };
        window.updateAllHeaders();
 
        // Drag to Scroll Logic
        const slider = document.getElementById('stagesCarousel');
        if(slider) {
            let isDown = false; let startX; let scrollLeft;
            slider.addEventListener('mousedown', (e) => {
                if(['INPUT','BUTTON','SELECT'].includes(e.target.tagName) || e.target.closest('.stage-draggable')) return;
                isDown = true; startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => isDown = false);
            slider.addEventListener('mouseup', () => isDown = false);
            slider.addEventListener('mousemove', (e) => {
                if(!isDown) return; e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                slider.scrollLeft = scrollLeft - (x - startX) * 2;
            });
        }
    }});
};
function renderStageItems(stageKey) {
    let html = '';
    Object.values(budget.sections).forEach(sec => {
        sec.items.forEach(item => {
            if (item.stageData && item.stageData[stageKey]) {
                html += RenderEngine.stageCard({
                    ...item,
                    _sDays: item.stageData[stageKey].days,
                    _sRate: item.stageData[stageKey].rate,
                    _sec: sec.name
                }, stageKey);
            }
        });
    });
    return html || '<p class="text-[8px] text-center mt-10 font-black text-slate-300 uppercase">Drop Items Here</p>';
}
// --- Global Stages Header Update Logic (Available before modal open) ---
window.updateAllHeaders = () => {
    const metrics = mBTStagesEngine.getMetrics();
    const burn = mBTStagesEngine.getBurnStatus(metrics.grandTotal, metrics.totalCap);
    
    // Update Overview
    const ovGrandTotal = document.getElementById('ovGrandTotal');
    const ovTotalCap = document.getElementById('ovTotalCap');
    if(ovGrandTotal) ovGrandTotal.textContent = mBTLE.format.currency(metrics.grandTotal);
    if(ovTotalCap) ovTotalCap.textContent = mBTLE.format.currency(metrics.totalCap);

    const ring = document.getElementById('burnRateRing');
    const ringTxt = document.getElementById('burnRateText');
    if(ring && ringTxt) {
        ring.className = `w-48 h-48 rounded-full border-[16px] ${burn.ring} flex items-center justify-center relative mb-8 transition-all duration-500 z-10 bg-white shadow-sm`;
        ringTxt.className = `text-5xl font-black ${burn.color} block leading-none tracking-tighter`;
        ringTxt.textContent = Math.round(burn.pct) + '%';
    }

    validKeys.forEach(k => {
        const cfg = budget.targetLock.stages[k];
        const cap = metrics.totalCap * (cfg.ratio / 100);
        const total = metrics.stageTotals[k];
        
        // Sync Sliders/Inputs
        const slider = document.querySelector(`.stage-slider[data-stage-key="${k}"]`);
        const numInput = document.querySelector(`#header_perc_${k}`);
        const dispPerc = document.getElementById(`setup_perc_disp_${k}`);
        if(slider && document.activeElement !== slider) slider.value = cfg.ratio;
        if(numInput && document.activeElement !== numInput) numInput.value = cfg.ratio.toFixed(1);
        if(dispPerc) dispPerc.textContent = cfg.ratio.toFixed(1) + '%';

        // Update Bars & Text
        const bar = document.getElementById(`bar-${k}`);
        const setupBar = document.getElementById(`setup_bar_${k}`);
        const barColor = total > cap ? 'bg-red-500' : 'bg-blue-500';
        if(bar) {
            bar.style.width = Math.min((total/cap)*100, 100) + '%';
            bar.className = `${barColor} h-full transition-all duration-500`;
        }
        if(setupBar) setupBar.style.width = Math.min((total/metrics.totalCap)*100, 100) + '%';
        
        const totalEl = document.getElementById(`total-${k}`);
        const limitEl = document.getElementById(`limit-${k}`);
        if(totalEl) totalEl.textContent = mBTLE.format.currency(total);
        if(limitEl) limitEl.textContent = `Cap: ${mBTLE.format.currency(cap)}`;
    });
};

/* --- Feature: Advanced Documents Hub (mBT.features.documents) --- */
mBT.features.documents = {
    // Logic Resolution: Creates a new document instance from a template definition
    createFromTemplate: function(templateId) {
        const tmpl = mBTOG.templates.find(t => t.id === templateId);
        if (!tmpl) return alert("Template definition not found.");

        const newDoc = {
            id: 'doc_' + Date.now(),
            type: tmpl.id, 
            label: tmpl.label,
            content: {
                data: mBTDB._generateDefaultData(),
                widgets: [] // Populated by mBTDB.open based on type defaults
            }
        };
        
        if (!budget.documents) budget.documents = [];
        budget.documents.push(newDoc);
        
        saveBudget();
        mBTME.close('newDocSelectorModal');
        
        // Refresh Vault list if open
        if(document.getElementById('documentsModal')) this.openVault();
        
        // Launch Studio immediately
        mBTDB.open(newDoc.id);
    },

    // Logic Resolution: Opens the Document Vault (List of saved docs)
    openVault: function() {
        const docs = budget.documents || [];
        
        const docsHtml = docs.length > 0 ? docs.map(doc => RenderEngine.ui.card({
            id: doc.id,
            icon: mBTAssets.file,
            title: doc.label || 'Untitled Document',
            subtitle: doc.type ? doc.type.charAt(0).toUpperCase() + doc.type.slice(1) : 'Document',
            onClick: `mBTDB.open('${doc.id}')`,
            actions: [
                { icon: mBTAssets.copy, title: 'Duplicate', color: 'blue', onClick: `mBTDB.snapshotDoc('${doc.id}')` },
                { icon: mBTAssets.trash, title: 'Archive', color: 'rose', onClick: `window.handleDocTrash('${doc.id}')` }
            ]
        })).join('') : RenderEngine.ui.emptyState({ 
            icon: mBTAssets.file, 
            message: 'Vault is Empty', 
            subtext: 'Create a new document to get started' 
        });

        const content = RenderEngine.layouts.studioPanel({
            title: 'Studio Vault',
            searchId: 'docSearch',
            searchPlaceholder: 'SEARCH VAULT...',
            contentId: 'activeDocsList',
            contentHtml: `<div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 px-1">Active Production Files</div>${docsHtml}`,
            actions: [{ 
                icon: mBTAssets.trash, 
                title: 'Recycle Bin', 
                onClick: "mBT.features.trash.open('documents')" 
            }],
            footerHtml: `<button onclick="mBT.features.documents.openTemplateSelector()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-black transition-all active:scale-95 flex items-center justify-center gap-3">${mBTAssets.plus} New Production Template</button>`
        });
        
        mBTME.open('documents', 'Production Studio', content, 'max-w-2xl', { noPadding: true, hideHeader: true });
    
        mBTME.attachSearch('docSearch', 'activeDocsList', docs, (doc) => RenderEngine.ui.card({
            id: doc.id,
            icon: mBTAssets.file,
            title: doc.label,
            subtitle: doc.type,
            onClick: `mBTDB.open('${doc.id}')`,
            actions: [
                { icon: mBTAssets.copy, title: 'Duplicate', color: 'blue', onClick: `mBTDB.snapshotDoc('${doc.id}')` },
                { icon: mBTAssets.trash, title: 'Archive', color: 'rose', onClick: `window.handleDocTrash('${doc.id}')` }
            ]
        }));
    },

    // Logic Resolution: Opens the Template Selector (Blueprints)
    openTemplateSelector: function() {
        const templates = mBTOG.templates || [];
        const templateHtml = templates.map(tmpl => RenderEngine.ui.card({
            id: tmpl.id,
            icon: tmpl.icon || '',
            title: tmpl.label,
            subtitle: tmpl.cat || 'General',
            onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')`,
            actions: [{ icon: mBTAssets.plus, title: 'Create', color: 'blue', onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')` }]
        })).join('');

        const content = RenderEngine.layouts.studioPanel({
            title: 'Select Template',
            searchId: 'tmplSearch',
            searchPlaceholder: 'FILTER TEMPLATES...',
            contentId: 'templateListBody',
            contentHtml: templateHtml,
            actions: [] 
        });
            
        mBTME.open('newDocSelector', 'Studio Blueprints', content, 'max-w-md', { noPadding: true, hideHeader: true });
        
        mBTME.attachSearch('tmplSearch', 'templateListBody', templates, (tmpl) => RenderEngine.ui.card({
            id: tmpl.id,
            icon: tmpl.icon || '',
            title: tmpl.label,
            subtitle: tmpl.cat || 'General',
            onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')`,
            actions: [{ icon: mBTAssets.plus, title: 'Create', color: 'blue', onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')` }]
        }));
    }
};

// --- Global Aliases for Backward Compatibility (Footer Buttons & Switchboard) ---
window.showDocumentsModal = mBT.features.documents.openVault.bind(mBT.features.documents);
window.showNewDocumentSelector = mBT.features.documents.openTemplateSelector.bind(mBT.features.documents);
window.createNewDocumentFromTemplate = mBT.features.documents.createFromTemplate.bind(mBT.features.documents);

// Logic Resolution: Publish Window (Export Options)
window.showPublishModal = function() {
    const content = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4">
            <button onclick="mBTPublisher.toMoo()" class="p-6 bg-slate-50 border border-slate-200 rounded-2xl flex flex-col items-center gap-3 hover:bg-blue-50 hover:border-blue-200 transition-all group">
                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-400 group-hover:text-blue-600 group-hover:scale-110 transition-all">${mBTAssets.cloud}</div>
                <div class="text-center">
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-700">Backup Environment</h4>
                    <p class="text-[9px] text-slate-400 font-bold mt-1">Save .moo file</p>
                </div>
            </button>
            <button onclick="window.print()" class="p-6 bg-slate-50 border border-slate-200 rounded-2xl flex flex-col items-center gap-3 hover:bg-indigo-50 hover:border-indigo-200 transition-all group">
                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-400 group-hover:text-indigo-600 group-hover:scale-110 transition-all">${mBTAssets.print}</div>
                <div class="text-center">
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-700">Print Budget</h4>
                    <p class="text-[9px] text-slate-400 font-bold mt-1">Standard PDF Layout</p>
                </div>
            </button>
            <button onclick="alert('Excel export requires pro license')" class="p-6 bg-slate-50 border border-slate-200 rounded-2xl flex flex-col items-center gap-3 hover:bg-emerald-50 hover:border-emerald-200 transition-all group">
                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-400 group-hover:text-emerald-600 group-hover:scale-110 transition-all">${mBTAssets.file}</div>
                <div class="text-center">
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-700">Export Data</h4>
                    <p class="text-[9px] text-slate-400 font-bold mt-1">Convert to .XLSX</p>
                </div>
            </button>
        </div>
        <div class="mt-4 p-4 bg-yellow-50 rounded-xl border border-yellow-100 flex items-start gap-3">
            <div class="text-yellow-600 mt-0.5">${mBTAssets.sparkle}</div>
            <div>
                <h4 class="font-black text-[10px] uppercase tracking-widest text-yellow-800">Finalization Check</h4>
                <p class="text-[10px] text-yellow-700 leading-relaxed mt-1">Ensure all "To Be Determined" (TBD) fields in the Studio are resolved before generating final contracts.</p>
            </div>
        </div>`;
    mBTME.open('publishModal', 'Production Output', content, 'max-w-2xl');
};
// Logic Resolution: Coffee Widget (In-App Support)
// Coffee Widget (Support)
window.showCoffeeWidget = function() {
    const widgetUrl = "https://www.buymeacoffee.com/widget/page/jaysonmy?description=Support%20mooBudget%20development!&color=%23FFDD00";
   
    const content = `
        <div class="flex flex-col h-[650px] w-full bg-white rounded-2xl overflow-hidden">
            <div class="p-6 text-center bg-[#FFDD00] text-black relative overflow-hidden">
                <div class="absolute top-[-20px] right-[-20px] opacity-10 rotate-12 transform scale-150">
                    ${mBTAssets.coffee}
                </div>
                <h3 class="text-xl font-black uppercase tracking-tighter mb-1 relative z-10">Fuel the Code</h3>
            </div>
            <div class="flex-grow relative bg-slate-50">
                <iframe
                    src="${widgetUrl}"
                    style="width: 100%; height: 100%; border: none;"
                    title="Buy Me A Coffee"
                    loading="lazy">
                </iframe>
            </div>
        </div>`;
    mBTME.open('coffeeModal', 'Support', content, 'max-w-md', { hideHeader: true, noPadding: true });
};
console.log("TIER 5 complete");


/* ================= v19.65 TIER 6: SYSTEM IGNITION & EVENTS ================= */

    /* --- 1. OFFLINE ENDURANCE SERVICE (Service Worker Registration) --- */
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' })
                .then(reg => {
                    console.log('SW Synchronization active:', reg.scope);
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                if(confirm("New production logic available! Synchronize environment now?")) {
                                    window.location.reload();
                                }
                            }
                        };
                    };
                })
                .catch(err => console.log('Service Worker initialization failure:', err));
        });
    }

/* --- 2. ACTION REGISTRY (The Nervous System Configuration) --- */
    function registerCoreActions() {
        // A. Header / Project Actions
        mBT.core.action('project-switch', async (e, el) => {
            if (e.type !== 'change') return;
            if (el.value) {
                const originalText = el.options[el.selectedIndex].text;
                el.options[el.selectedIndex].text = "Loading...";
                await mBT.data.load(el.value);
            }
        });

        mBT.core.action('project-new', () => showNewProjectModal());
        mBT.core.action('project-duplicate', async () => await mBT.data.duplicate());
        mBT.core.action('project-delete', async () => { if (currentProjectName) await mBT.data.deleteProject(currentProjectName); });
        
        // New File Menu Actions
        mBT.core.action('project-recycle', () => { if(typeof mBT.features.trash !== 'undefined') mBT.features.trash.open('projects'); });
        mBT.core.action('project-sync', () => { fetchExchangeRates(); alert("Live Stream: Currency & Data Synchronized."); });

        mBT.core.action('project-import-trigger', () => { const input = document.getElementById('importFile'); if(input) input.click(); });
        mBT.core.action('project-import-file', (e, el) => { if(e.type === 'change') mBT.data.importFile(el); });

        // B. Global Utilities
        mBT.core.action('set-currency', (e, el) => {
            displayCurrency = el.value;
            localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
            if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
            if(typeof render === 'function') render();
        });

        mBT.core.action('backup-env', () => { if(typeof mBTPublisher !== 'undefined') mBTPublisher.toMoo(); });
        mBT.core.action('print-pdf', () => window.print());
        mBT.core.action('export-xlsx', () => alert('Excel export requires pro license'));
        mBT.core.action('publish-modal', () => showPublishModal());
        
        // C. Footer / Global Modals
        mBT.core.action('stages-modal', () => showStagesModal());
        mBT.core.action('docs-modal', () => showDocumentsModal());
        mBT.core.action('settings-modal', () => showSettingsModal());
        mBT.core.action('support-modal', () => showCoffeeWidget());
        
        // D. Budget Interaction (The Synapse)
        mBT.core.action('section-toggle', (e, el) => handleToggleSection(el.dataset.id));
        mBT.core.action('section-add', (e, el) => showItemSelectorModal(el.dataset.id));
        mBT.core.action('row-delete', (e, el) => handleRemoveItem(el.dataset.section, el.dataset.id));
        
        mBT.core.action('row-lock', (e, el) => {
            const item = budget.sections[el.dataset.section]?.items.find(i => i.id === el.dataset.id);
            if(item) {
                item.rateType = item.rateType === 'fixed' ? 'negotiable' : 'fixed';
                saveBudget();
                render(); // Full render needed to swap icon state
            }
        });

        // E. Personnel Actions
        mBT.core.action('crew-toggle', (e, el) => toggleCrewPopup(el, e));
        mBT.core.action('crew-profile', (e, el) => openCrewProfile(el, e, el.dataset.id, el.dataset.section));

        // F. Stage Actions
        mBT.core.action('stage-remove', (e, el) => removeStageItem(el.dataset.id, el.dataset.section, el.dataset.stage));
        mBT.core.action('stage-update', (e, el) => {
             // Only process if value changed to avoid jitter, handled by 'change' event in router
             updateStageItem(el.dataset.id, el.dataset.section, el.dataset.stage, el.dataset.field, el.value);
        });

        // G. History
        mBT.core.action('undo', () => handleUndo());
        mBT.core.action('redo', () => handleRedo());
    }

    /* --- 3. GLOBAL EVENT ORCHESTRATION --- */
    function bindAppEventListeners() {
        const appContainer = document.getElementById('app');
        const footer = document.querySelector('footer');
        
        // Initialize Registry
        registerCoreActions();

        if (appContainer && !appContainer.dataset.listenersBound) {
            appContainer.dataset.listenersBound = 'true';
            
            // --- Master Router (Delegation) ---
            const router = (e) => {
                // 1. Try Action Registry (New System)
                if (mBT.core.route(e)) return;

                // 2. Fallback: Specific Legacy / ID Handlers
                const target = e.target;
                
                // Login Button
                if (target.id === 'loginBtn') handleLogin();
                
                // AI Tools Trigger
                if (target.closest('#openAiToolsBtn')) showAIToolsModal();
            };

            appContainer.addEventListener('click', router);
            appContainer.addEventListener('change', router);

            // --- Real-time Input Handling (Performance Critical) ---
            // Separated from Action Router for speed on keypress/input
            appContainer.addEventListener('input', (e) => {
                const input = e.target;
                
                // Project Name (Special Case)
                if (input.id === 'projectName') {
                    handleProjectNameChange(e);
                    return;
                }

                // Global Percentages
                if (['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(input.id)) {
                    budget[input.id] = parseFloat(input.value) || 0;
                    if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
                    return;
                }

                // Line Item Fields (If no specific action is assigned)
                if (input.dataset.field && !input.dataset.action) {
                    handleUpdate(input.dataset.section, input.dataset.id, input.dataset.field, input.value, 'User Input');
                }
            });
        }

        // --- Footer Routing ---
        if (footer) {
            footer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                // Manual ID mapping for static footer
                if (btn.id === 'stagesFooterBtn') mBT.core.actions['stages-modal']();
                else if (btn.id === 'docsFooterBtn') mBT.core.actions['docs-modal']();
                else if (btn.id === 'mainActionBtn') mBT.core.actions['settings-modal']();
                else if (btn.id === 'secondaryActionBtn') mBT.core.actions['publish-modal']();
                else if (btn.id === 'footerCoffeeBtn') mBT.core.actions['support-modal']();
            });
        }

        window.addEventListener('online', resolveConnectivityStatus);
        window.addEventListener('offline', resolveConnectivityStatus);
    }

    /* --- 4. INFRASTRUCTURE TELEMETRY --- */
    function resolveConnectivityStatus() {
        const isOnline = navigator.onLine;
        const btn = document.getElementById('loginBtn');
        if(btn) {
            btn.className = `w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0 ${isOnline ? 'border-emerald-400 bg-emerald-50 text-emerald-600' : 'border-rose-400 bg-rose-50 text-rose-600'}`;
            btn.title = isOnline ? "Studio Online" : "Studio Offline";
            btn.innerHTML = mBTAssets.user;
        }
        const aiBtn = document.getElementById('openAiToolsBtn');
        if(aiBtn) {
            aiBtn.className = `p-3 text-white rounded-2xl shadow-lg transition-all active:scale-95 flex items-center justify-center ${isOnline ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-400 cursor-not-allowed'}`;
            if(!isOnline) aiBtn.title = "AI Consultant Offline";
        }
    }
    
    function handleLogin() {
        if (navigator.onLine && confirm("Establish secure connection to Moo Studio Cloud infrastructure?")) {
            alert("Environment Authenticated.");
        }
    }

    function injectFooterIcons() {
        const mapping = {
            'icon-stages': mBTAssets.grid,
            'icon-docs': mBTAssets.file,
            'icon-main-action': mBTAssets.gear,
            'icon-secondary-action': mBTAssets.paperPlane,
            'icon-coffee': mBTAssets.coffee
        };
        Object.entries(mapping).forEach(([id, svg]) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = svg;
        });
    }

    /* --- 5. GLOBAL BOOT TRIGGER --- */
    // Logic Resolution: Global Bridge Hooks for external calls
    window.showBinModal = () => { if (typeof mBT.features.trash !== 'undefined') mBT.features.trash.open('documents'); };
    window.handleDocTrash = (id) => { if (typeof mBT.features.trash !== 'undefined') mBT.features.trash.trashDocument(id); };
    
    // System Start
    document.addEventListener('DOMContentLoaded', () => {
        if (mBT.core && typeof mBT.core.init === 'function') {
            mBT.core.init();
        } else if (typeof init === 'function') {
            init(); // Fallback for safety
        }
    });

/* ======= END OF mBT ========== */
</script>
</body>
</html>
