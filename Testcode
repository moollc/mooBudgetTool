<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Offline-capable Film Production Budget Tool">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>mooBudgetTool v19.54-Beta</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moollc/mooBudgetTool/refs/heads/main/assets/cow-512.png">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack.min.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
        
/* --- Core Layout & Scrollbar --- */
        /* Logic Resolution: Increased bottom padding to prevent content overlap with footer */
        body { font-family: 'Inter', sans-serif; padding-bottom: 128px; background-color: #f3f4f6; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

/* --- 1. Interaction Protocols (Drag and drop behavior) --- */
        .draggable-row { cursor: grab; transition: all 0.2s ease-in-out; }
        .draggable-row:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(2px) scale(1.02); z-index: 1000; }
        .drag-over { background-color: #f3f4f6; border-top: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6; transition: all 0.2s ease-in-out; }

/* --- 2. Atomic UI Components --- */
        .alert-badge { position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .status-indicator { transition: opacity 0.5s ease-in-out; }
        .status-online { border-color: #22c55e; color: #15803d; background-color: #f0fdf4; }
        .status-offline { border-color: #ef4444; color: #b91c1c; background-color: #fef2f2; cursor: not-allowed; }

/* --- 3. Roadmap Visualization --- */
        .roadmap-past { color: #9ca3af; }
        .roadmap-current { color: #2563eb; font-weight: 700; }
        .roadmap-future { color: #1f2937; }

/* --- 4. Intelligence Suite Visuals --- */
        .ai-message { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.5; }
        .ai-message.user { background-color: #eff6ff; border: 1px solid #dbeafe; color: #1e3a8a; text-align: right; margin-left: 20%; }
        .ai-message.assistant { background-color: #f0fdf4; border: 1px solid #dcfce7; color: #14532d; margin-right: 10%; }
        .ai-message.assistant strong { color: #166534; font-weight: 700; }
        .ai-message.assistant ul { list-style-type: disc; margin-left: 20px; margin-top: 5px; }

/* --- 5. Support Interface --- */
        .bmc-btn { background-color: #FFDD00; color: #000000; font-family: 'Inter', sans-serif; font-weight: 600; border-radius: 8px; padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; text-decoration: none; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;}
        .bmc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

/* --- 6. Print Media Protocols --- */
        @media print { #footnote, #loginBtn, footer, #settingsBtn, #openAiToolsBtn { display: none !important; } }
        #bmac-btn-container, #bmc-wbtn { display: none !important; }

/* --- 7. Production Stage Visuals --- */
        #stagesCarousel { scrollbar-width: none; -ms-overflow-style: none; }
        #stagesCarousel::-webkit-scrollbar { display: none; }
        .stage-card { transition: transform 0.2s; }
        .stage-drop-zone { min-height: 100px; }
        .stage-draggable { transition: all 0.2s; touch-action: none; }
        .stage-draggable:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

/* --- 8. Mobile Platform Support --- */
        @media (max-width: 768px) {
            .mobile-desc-truncate { text-overflow: ellipsis; white-space: nowrap; overflow: hidden; width: 100%; display: block; }
            .mobile-desc-truncate:focus { white-space: normal; overflow: visible; position: relative; z-index: 50; background: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 4px; padding: 8px; height: auto; }
        }

/* --- 9. Navigation Elements --- */
        .sticky-section-header { position: sticky; top: 0; z-index: 30; background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .sticky-th { position: sticky; top: 43px; z-index: 20; background-color: #ffffff; }

/* --- 10. Document Studio Canvas --- */
        .grid-stack { background-color: #64748b; min-height: 80vh; padding: 20px !important; }
        
        /* Print Standard Override */
        .print-standard .grid-stack-item-content { box-shadow: none !important; border: 1px solid #000 !important; border-radius: 0 !important; }
        .print-standard input, .print-standard textarea { color: #000 !important; font-weight: bold !important; }
        
        /* Visual Hardening - Unified Container Logic */
        /* Replaces legacy card style with Industry Standard "Flat" look */
        .grid-stack-item-content { 
            background-color: white; 
            border: 2px solid #000 !important; 
            border-radius: 0 !important; 
            box-shadow: none !important; 
            /* Batch 3.1: Liquid CSS Engine - Vertical Flex Protocol */
            container-type: inline-size;
            container-name: widget;
            overflow: hidden !important; /* Strict containment to prevent overlap */
            display: flex; 
            flex-direction: column; 
            cursor: grab; 
        }

        /* Fluid Typography (Smart Scaling) */
        @container widget (max-width: 200px) {
            .widget-header { padding: 2px 4px !important; min-height: 24px !important; }
            .widget-header input { font-size: 8px !important; }
            .widget-tools { transform: scale(0.7); transform-origin: right center; }
            .widget-body, .cs-table { font-size: 8px !important; }
            .cs-table th, .cs-table td { padding: 1px !important; }
        }
        @container widget (min-width: 201px) and (max-width: 400px) {
            .widget-header input { font-size: 10px !important; }
            .widget-body, .cs-table { font-size: 10px !important; }
        }
        @container widget (min-width: 401px) {
            .widget-header input { font-size: 12px !important; }
            .widget-body, .cs-table { font-size: 12px !important; }
        }
        
        /* Widget Contrast Fixes: Force darker labels on white widgets */
        .grid-stack-item-content .text-slate-400 { color: #64748b; } 

        /* Batch 2.2: Resize Handle Clean-up */
        /* Ensures handles are completely invisible and unclickable in view mode */
        #mBTDB_Workspace:not(.editing-mode) .ui-resizable-handle,
        #mBTDB_Workspace:not(.editing-mode) .grid-stack-handle,
        #mBTDB_Workspace:not(.editing-mode) .widget-tools { 
            display: none !important; 
            pointer-events: none !important;
        }
        
        /* --- [Feat15]. Visual Hardening (Flatten nested widget borders) --- */
        /* Context: Strips borders from nested components to enforce flat industry-standard look */
        .grid-stack-item-content .cs-box { 
            border: none !important; 
            margin: 0 !important; 
            box-shadow: none !important;
        }
        .grid-stack-item-content .cs-table {
            border-top: none !important;
        }
     
/* --- 11. Form Utilities (Spinner Removal) --- */
        .no-spinner::-webkit-inner-spin-button, 
        .no-spinner::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-spinner { -moz-appearance: textfield; appearance: none; }

/* --- 12. Crew Contact Popups (Adapted Legacy Logic) --- */
        .crew-wrapper { 
            position: relative; 
            z-index: 20; 
            display: inline-block;
        }
        
        /* Main Avatar Button */
        .crew-avatar {
            /* Adapted size: 28px -> 32px for better touch, shrinks to 28px on tiny screens via HTML classes */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); /* Legacy "Pop" effect */
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 20; /* Always above the pill */
        }
        .crew-avatar:hover { transform: scale(1.15); }
        .crew-avatar:active { transform: scale(0.95); }

        /* The Floating Pill (Hidden State) */
        .crew-popup {
            position: absolute;
            left: 50%; /* Start centered behind avatar */
            top: 50%;
            transform: translate(-50%, -50%) scale(0.5); /* Start small and centered */
            background: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 9999px;
            padding: 4px 6px 4px 28px; /* Left padding creates the visual gap for the avatar */
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 10; /* Behind avatar */
            white-space: nowrap;
        }

        /* The "Hit Buffer" (Invisible bridge so mouse doesn't lose focus) */
        .crew-popup::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 30px; /* Covers the gap between avatar and buttons */
            background: transparent;
            z-index: -1;
        }

        /* Active State (Hover OR Mobile Class) */
        @media (hover: hover) {
            .crew-wrapper:hover .crew-popup {
                opacity: 1;
                visibility: visible;
                pointer-events: auto;
                transform: translate(20px, -50%) scale(1); /* Slide out to the right */
            }
        }
        
        /* Mobile Toggle State */
        .crew-wrapper.mobile-active .crew-popup {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translate(20px, -50%) scale(1);
        }

        /* Action Buttons inside the Pill */
        .contact-action-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: transform 0.2s ease;
            flex-shrink: 0;
            text-decoration: none;
        }
        .contact-action-btn:hover { transform: scale(1.2); }
        .contact-action-btn svg { width: 14px; height: 14px; }

        /* Legacy Colors adapted for Tailwind Palette */
        .action-call { background-color: #10b981; } /* Emerald-500 */
        .action-wa { background-color: #25D366; }   /* WhatsApp Brand Color */
        .action-email { background-color: #3b82f6; } /* Blue-500 */
        .action-profile { background-color: #64748b; } /* Slate-500 */

/* --- 13. Classic Theme Overrides (Legacy Mode) --- */
        /* Logic Resolution: CSS Nesting to strip modern UI features when enabled */
        .classic-theme { font-family: 'Arial', sans-serif !important; }
        
        /* Squared Corners & Borders */
        .classic-theme .rounded-2xl, .classic-theme .rounded-3xl, 
        .classic-theme .rounded-xl, .classic-theme .rounded-lg, 
        .classic-theme .rounded-md, .classic-theme .rounded,
        .classic-theme .rounded-full { border-radius: 2px !important; }
        
        /* Flatten Depth (Remove Shadows, Add Borders) */
        .classic-theme .shadow-2xl, .classic-theme .shadow-xl, 
        .classic-theme .shadow-lg, .classic-theme .shadow-sm { 
            box-shadow: none !important; 
            border: 1px solid #9ca3af !important; 
        }
        
        /* Retro Typography */
        .classic-theme header input#projectName { 
            font-family: 'Courier New', monospace; 
            letter-spacing: -1px; 
            background: #fff;
            border: 1px solid #000 !important;
        }
        .classic-theme .uppercase { text-transform: none !important; }
        .classic-theme .tracking-widest { letter-spacing: normal !important; }
        
        /* High Contrast Colors */
        .classic-theme .bg-slate-900 { background-color: #333 !important; border: 1px solid #000; }
        .classic-theme .bg-blue-600 { background-color: #0044cc !important; }
        .classic-theme .text-blue-600 { color: #0044cc !important; }
        .classic-theme .bg-emerald-600 { background-color: #007733 !important; }
        
        /* Inputs & Tables */
        .classic-theme input, .classic-theme select { 
            background-color: #fff !important; 
            border: 1px solid #ccc !important; 
            border-radius: 0 !important;
        }
        .classic-theme .bg-slate-50 { background-color: #eee !important; }
        
/* --- 14. Studio Interface (New) --- */
        .studio-input { 
            background-color: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 4px; 
            padding: 6px 8px; font-size: 11px; font-weight: 700; color: #334155; 
            transition: all 0.2s; width: 100%; 
        }
        .studio-input:focus { 
            background-color: #ffffff; border-color: #3b82f6; 
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); outline: none; 
        }
        .studio-input:hover:not(:focus) { border-color: #cbd5e1; background-color: #f1f5f9; }
        
        /* [CLEANUP] Removed duplicate .grid-stack-item-content definitions here. */
        /* Visual Hardening" above for the active rules. */

        /* Interior Refinement - Header & Body Polish */
        .widget-header {
            background-color: #000 !important; 
            color: #fff !important;
            padding: 2px 8px !important; /* Compact Padding */
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 24px !important; /* Reduced Height (was 32px) */
            border-bottom: 1px solid #000 !important;
            flex-shrink: 0; /* Prevent header collapse */
        }

        /* High-Contrast Inputs in Header */
        .widget-header input {
            color: #fff !important;
            font-family: 'Roboto Condensed', sans-serif !important;
            font-weight: 700 !important;
            font-size: 10px !important; /* Scaled down font */
            text-transform: uppercase !important;
            letter-spacing: 0.05em !important;
            background: transparent !important;
            height: 100%;
        }
        .widget-header input:focus {
            background-color: rgba(255,255,255,0.2) !important;
        }

        /* Tool Icons in Header */
        .widget-tools button { color: #9ca3af !important; transform: scale(0.85); }
        .widget-tools button:hover {
            color: #fff !important;
            background-color: rgba(255,255,255,0.2) !important;
        }

        /* Body Logic: Scroll internally, strict square corners */
        .widget-body { 
            /* Batch 3.1: Liquid Scroll Protocol */
            flex-grow: 1;
            min-height: 0;
            height: auto !important;
            overflow-y: auto !important; 
            overflow-x: hidden;
            background: #fff;
            border-radius: 0 !important; /* Strict Square */
            padding: 0 !important; 
            display: flex;
            flex-direction: column;
        }
        
        /* Batch 3.1: Dynamic Content Scaling */
        .widget-body textarea, .widget-body .studio-input {
            flex-grow: 1;
            height: 100% !important;
            resize: none !important;
        }

        .ui-resizable-handle { z-index: 100 !important; }
        .editing-mode .ui-resizable-se { 
            display: block !important; width: 20px !important; height: 20px !important; 
            right: 2px !important; bottom: 2px !important; 
        }
        .editing-mode .ui-resizable-se::after {
            content: ''; position: absolute; right: 4px; bottom: 4px;
            width: 6px; height: 6px; border-right: 2px solid #94a3b8; border-bottom: 2px solid #94a3b8;
        }

        /* --- 15. The Paper Protocol (WYSIWYG Layout) --- */
        /* Logic Resolution: Darkened workspace for "Super-App" contrast. Paper is transparent in edit mode to let widgets pop. */
        .sheet-workspace { background-color: #0f172a; padding: 40px; display: flex; justify-content: center; min-height: 100%; overflow-y: auto; }
        .sheet-a4 { 
            width: 210mm; min-height: 297mm; background: transparent; 
            box-shadow: none; padding: 10mm; 
            position: relative; box-sizing: border-box; 
            display: flex; flex-direction: column;
            border: 1px dashed #334155; /* Visual Guide for Print Bounds */
        }
        
        /* Champion/Studio Layout Kit */
        .cs-theme { font-family: 'Arial Narrow', 'Roboto Condensed', sans-serif; color: #000; }
        .cs-theme input, .cs-theme textarea, .cs-theme select { background: transparent; border: 1px solid transparent; width: 100%; font-family: inherit; }
        .cs-theme input:hover, .cs-theme textarea:hover { border-color: #e2e8f0; background-color: #f8fafc; }
        .cs-theme input:focus, .cs-theme textarea:focus { border-color: #3b82f6; outline: none; background-color: white; }
        
        .cs-box { border: 2px solid #000; margin-bottom: -2px; position: relative; }
        .cs-header-bar { background: #000; color: #fff; font-weight: 800; text-transform: uppercase; padding: 2px 6px; font-size: 10px; letter-spacing: 0.5px; }
        
        .cs-table { width: 100%; border-collapse: collapse; font-size: 9px; }
        .cs-table th { 
            border: 1px solid #000; 
            background: #000; 
            color: #fff; 
            text-transform: uppercase; 
            padding: 2px 4px; /* Compact Padding */
            font-weight: 700; 
            text-align: left;
            font-size: 8px !important; /* Compact Font */
            line-height: 1.1; 
        }
        .cs-table td { border: 1px solid #000; padding: 4px; vertical-align: top; }
        
        /* Print Protocol */        @media print {
            body { background: white; padding: 0; }
            .sheet-workspace { background: white; padding: 0; display: block; overflow: visible; }
            .sheet-a4 { box-shadow: none; margin: 0; width: 100%; height: 100%; page-break-after: always; padding: 0; }
            .no-print, .widget-tools, .ui-resizable-handle { display: none !important; }
        }

/* --- 16. Offline Survival Kit (Tailwind Polyfill) --- */
        /* Critical layout primitives to ensure UI structure persists without CDN */
        
        /* Layout & Flexbox */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .flex-grow { flex-grow: 1; }
        .shrink-0 { flex-shrink: 0; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .z-10 { z-index: 10; } .z-20 { z-index: 20; } .z-30 { z-index: 30; } .z-50 { z-index: 50; }
        .overflow-hidden { overflow: hidden; } .overflow-y-auto { overflow-y: auto; }
        
        /* Grid System */
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .gap-1 { gap: 0.25rem; } .gap-2 { gap: 0.5rem; } .gap-3 { gap: 0.75rem; } .gap-4 { gap: 1rem; }
        
        /* Spacing */
        .p-1 { padding: 0.25rem; } .p-2 { padding: 0.5rem; } .p-3 { padding: 0.75rem; } .p-4 { padding: 1rem; } .p-6 { padding: 1.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; } .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; } .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; } .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .mb-1 { margin-bottom: 0.25rem; } .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 1rem; } .mt-2 { margin-top: 0.5rem; }
        .w-full { width: 100%; } .h-full { height: 100%; } .h-screen { height: 100vh; }
        
        /* Typography */
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .font-bold { font-weight: 700; } .font-black { font-weight: 900; }
        .uppercase { text-transform: uppercase; } .tracking-widest { letter-spacing: 0.1em; }
        .text-center { text-align: center; } .text-right { text-align: right; }
        
        /* Decoration */
        .rounded-lg { border-radius: 0.5rem; } .rounded-xl { border-radius: 0.75rem; } .rounded-2xl { border-radius: 1rem; } .rounded-full { border-radius: 9999px; }
        .border { border-width: 1px; border-style: solid; } .border-b { border-bottom-width: 1px; }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Colors (Fallback Palette) */
        .bg-white { background-color: #ffffff; }
        .bg-slate-50 { background-color: #f8fafc; }
        .bg-slate-100 { background-color: #f1f5f9; }
        .bg-slate-200 { background-color: #e2e8f0; }
        .bg-slate-900 { background-color: #0f172a; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-emerald-600 { background-color: #059669; }
        .bg-rose-500 { background-color: #f43f5e; }
        .text-white { color: #ffffff; }
        .text-slate-300 { color: #cbd5e1; }
        .text-slate-400 { color: #94a3b8; }
        .text-slate-500 { color: #64748b; }
        .text-slate-800 { color: #1e293b; }
        .text-slate-900 { color: #0f172a; }
        .text-blue-600 { color: #2563eb; }
        .border-slate-100 { border-color: #f1f5f9; }
        .border-slate-200 { border-color: #e2e8f0; }

        /* State & Interactive */
        .hidden { display: none !important; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .cursor-pointer { cursor: pointer; }
        .outline-none { outline: 2px solid transparent; outline-offset: 2px; }

        /* GridStack Offline Fallback (Vertical Stack) */
        .no-gridstack .grid-stack { display: flex !important; flex-direction: column !important; height: auto !important; padding: 10px !important; }
        .no-gridstack .grid-stack-item { position: relative !important; width: 100% !important; top: auto !important; left: auto !important; height: auto !important; margin-bottom: 20px; }
        .no-gridstack .grid-stack-item-content { height: auto !important; min-height: 200px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        .no-gridstack .widget-body { height: 300px; overflow-y: auto; }
        .no-gridstack .ui-resizable-handle { display: none !important; }
    </style>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack-all.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script data-name="BMC-Widget" data-id="jaysonmy" data-description="Support mooBudget development!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js"></script>
    <script>
        // --- OFFLINE GUARDRAIL ---
        // Checks if critical libraries loaded; applies fallback classes if not.
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof GridStack === 'undefined') {
                console.warn("Offline Mode: GridStack missing. Enabling linear layout fallback.");
                document.body.classList.add('no-gridstack');
            }
            if (typeof Sortable === 'undefined') {
                console.warn("Offline Mode: Sortable missing. Drag-and-drop disabled.");
            }
            // Check if Tailwind loaded by testing a known utility class style
            const testEl = document.createElement('div');
            testEl.className = 'bg-slate-900';
            document.body.appendChild(testEl);
            const color = window.getComputedStyle(testEl).backgroundColor;
            document.body.removeChild(testEl);
            
            // Logic Resolution: Detect failure and enable Safe Mode hooks
            // rgb(15, 23, 42) is the computed value of slate-900
            if (color !== 'rgb(15, 23, 42)' && color !== '#0f172a') {
                console.warn("Offline Mode: Tailwind CDN failed. Reverting to Survival Kit.");
                document.body.classList.add('tailwind-offline');
            }
        });
    </script>
</head>

<body class="bg-gray-100 pb-24">
    <div id="app" class="max-w-7xl mx-auto px-4 py-8"></div>
    <div id="global-modal-container"></div>

    <footer class="fixed bottom-0 left-0 right-0 z-[100] p-4 pointer-events-none">
        <div class="max-w-xl mx-auto bg-slate-900/90 backdrop-blur-xl border border-white/10 rounded-[32px] shadow-2xl p-2 px-6 flex justify-between items-center pointer-events-auto">
            
            <button id="stagesFooterBtn" aria-label="Stages View" class="flex flex-col items-center gap-1 group transition-all active:scale-90 justify-center w-12 h-12 sm:w-auto sm:h-auto">
                <div class="text-slate-400 group-hover:text-emerald-400 [&>svg]:w-6 [&>svg]:h-6" id="icon-stages"></div>
                <span class="hidden sm:block text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-emerald-400">Stages</span>
            </button>

            <button id="docsFooterBtn" aria-label="Document Vault" class="flex flex-col items-center gap-1 group transition-all active:scale-90 justify-center w-12 h-12 sm:w-auto sm:h-auto">
                <div class="text-slate-400 group-hover:text-blue-400 [&>svg]:w-6 [&>svg]:h-6" id="icon-docs"></div>
                <span class="hidden sm:block text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-blue-400">Documents</span>
            </button>

            <button id="mainActionBtn" aria-label="Main Menu" class="w-14 h-14 bg-blue-600 rounded-[22px] shadow-xl shadow-blue-500/20 flex items-center justify-center text-white border-2 border-white/20 transition-all hover:bg-blue-500 active:scale-90">
                <div id="icon-main-action" class="[&>svg]:w-7 [&>svg]:h-7"></div>
            </button>

            <button id="secondaryActionBtn" aria-label="Publish Menu" class="flex flex-col items-center gap-1 group transition-all active:scale-90 justify-center w-12 h-12 sm:w-auto sm:h-auto">
                <div class="text-slate-400 group-hover:text-indigo-400 [&>svg]:w-6 [&>svg]:h-6" id="icon-secondary-action"></div>
                <span class="hidden sm:block text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-indigo-400">Publish</span>
            </button>

            <button id="footerCoffeeBtn" aria-label="Support" class="flex flex-col items-center gap-1 group transition-all active:scale-90 justify-center w-12 h-12 sm:w-auto sm:h-auto">
                <div class="text-slate-400 group-hover:text-amber-400 [&>svg]:w-6 [&>svg]:h-6" id="icon-coffee"></div>
                <span class="hidden sm:block text-[8px] font-black uppercase tracking-widest text-slate-500 group-hover:text-amber-400">Support</span>
            </button>
        </div>
    </footer>
</body>

<script>
/* ================= v19.54 TIER 1: Environment Configuration ================= */

/* --- 1. Global System Identity --- */
    const APP_VERSION = "19.54";
    const storageKeyPrefix = 'prodBudget_v5_';
    const trashKey = `${storageKeyPrefix}trash`;
    const globalItemsKey = `${storageKeyPrefix}globalItems`;
    const templatesKey = `${storageKeyPrefix}templates`;
    const projectDateFormatKey = `${storageKeyPrefix}projectDateFormat`;
    const projectNameSeparatorKey = `${storageKeyPrefix}projectNameSeparator`;
    const projectStorageProtocolKey = `${storageKeyPrefix}projectStorageProtocol`;
    
    // Core physics and hydration state
    let budget = null;
    let currentProjectName = null;
    let historyStack = [];
    let historyIndex = -1;
    const MAX_HISTORY = 15;

/* --- 2. Dynamic Multi-Currency Logic --- */
    let displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
    
    // Base Rates (Defaults for offline endurance)
    let exchangeRates = JSON.parse(localStorage.getItem(`${storageKeyPrefix}rates`)) || {
        'USD': 1.0, 'JMD': 157.50, 'GBP': 0.79, 'CAD': 1.36, 'EUR': 0.92,
        'AUD': 1.52, 'NZD': 1.63, 'ZAR': 18.50, 'INR': 83.00, 'JPY': 150.00, 'CNY': 7.20
    };

    const FILM_CURRENCIES = [
        { code: 'JMD', label: 'JMD' }, { code: 'USD', label: 'USD' },
        { code: 'GBP', label: 'GBP' }, { code: 'CAD', label: 'CAD' },
        { code: 'EUR', label: 'EUR' }, { code: 'AUD', label: 'AUD' },
        { code: 'NZD', label: 'NZD' }, { code: 'ZAR', label: 'ZAR' },
        { code: 'INR', label: 'INR' }, { code: 'CNY', label: 'CNY' },
        { code: 'JPY', label: 'JPY' }
    ];

/* --- 3. Master Asset Registry (Consolidated SVG Library) --- */
const mBTAssets = {
appLogo: `<svg viewBox="0 0 502.17 507.14" fill="none"><circle cx="251.1" cy="253.6" r="251" fill="#fdba35"/><ellipse cx="251.08" cy="254.6" rx="219.09" ry="222.65" fill="#e68b2e"/><rect x="203.17" y="63.34" width="39.87" height="58.38" rx="12" ry="12" fill="#fdba35"/><rect x="287.89" y="63.34" width="39.87" height="58.38" rx="12" ry="12" fill="#fdba35"/><path fill="#ffffff" d="M435.26 218.85c-9.37 8.14-49.07 32.97-49.8 15.81 11.55-127.5-229.22-149.43-231.01-24.74 6.07 54.05 43.35 54.26 87.82 52.06 146.67-19.16 207.1 157.09 46.91 189.89-58.04 11.48-128.93-19.18-142.75-80.18 46.88 38.84 113.67 68.1 171.96 37.26 26.86-13.77 47.21-49.89 26.52-76.85-38.48-58.02-113.62-26.74-169.36-43.4-33.76-8.68-39.32-44.89-49.26-40.21-40.71 11.77-74.81-18.1-93.73-51.57-11.64-17.99 23.01-37.67 23.01-37.67 78.34-46.2 83.04-2.52 100.98-30.11 13.01-12.52 28.91-19.88 45.88-25.26 14.39-.81-2.14-26.45 12.52-30.74 8.55-3.29 22.55-1.35 21.53 10.41v7.96q0 5.96 6.03 5.19c15.31-1.13 30.59-.73 45.84 1.04 4.51 1.52 6.39.14 5.88-4.8.18-6.63-2.41-16.54 5.48-19.48 39.51-10.45 11.06 33.02 28.69 33.36 24.13 8.69 46.04 20.74 62.06 41.52 1.37 1.77 2.67 1.3 4.34.83 21.56-6.19 44.45 3.51 61.99 15.88 16.53 11.27-10.05 43.62-21.53 53.81Zm-303.07-60.53c-15.13-3.64-31.31 1.65-45.48 7.89-10.48 5.14-25.95 13.17-31.69 19.68-7.43 4.29 10.4 20.59 13.85 25.15 12.7 13.47 31.71 23.14 50.39 17.73 2.48-.4 3.49-1.51 3.13-3.82-2.68-22.93-.15-45.14 9.8-66.63m311.98 17.39c-2.49-5.29-32.19-13.69-45.6-11.24 3.21 8.51 7.77 19.74 8.85 29.37 2.12 18.88 1.07 24.71.92 25.13 14.31-5.74 40.59-33.14 35.83-43.26m-244.14 12.41c-8.45-1.05-18.22 1.95-18.24 12 .78 10.17-4.5 33.22 12 33.15 8.45 1.05 18.22-1.95 18.24-12-.78-10.17 4.5-33.22-12-33.14Zm-6.08 168.77c-1.38-2.31-16.01-18.07-16.01-18.07-3.59-3.64-6.21-13.1-14.02-8.77-3.6 2.84-5.79 3.83-.54 12.88 7.81 11.59 24.83 28.14 30.57 13.96m-87.43-126.66c.73.03 1.47.03 2.21.02-.74.01-1.48 0-2.21-.02m-37.65-19.19c.27.27.53.54.8.81-.27-.27-.53-.54-.8-.81m258.53-22.92c-8.45-1.05-18.22 1.95-18.24 12 .78 10.17-4.5 33.22 12 33.15 8.45 1.05 18.22-1.95 18.24-12-.78-10.17 4.5-33.22-12-33.14Z"/></svg>`,

       // ---     // --- Core UI & Actions ---
    plus: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
    trash: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
    sync: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>`,
    refresh: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>`,
    search: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
	close: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
    drag: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>`,
    
    // --- Status & Access ---
    lock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
    unlock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`,
    
    // --- Intelligence & Tools ---
    sparkle: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,
    doctor: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
    chat: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
    target: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
    zap: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
    
    // --- Contact & Personnel ---
    user: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
    phone: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
    mail: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
    wa: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>`,
    
    // --- File System ---
    file: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>`,
    folder: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`,
    cloud: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19A5.5 5.5 0 0 0 18 8.02a9 9 0 0 0-17.53 1.98 7 7 0 0 0 .03 14h12.5a5.5 5.5 0 0 0 4.5-9z"/></svg>`,
    clip: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>`,
    
    // --- Editor Controls ---
    money: `<svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.15-1.46-3.27-3.4h1.96c.1 1.05 1.18 1.91 2.53 1.91 1.38 0 2.29-.84 2.29-1.93 0-1.02-.75-1.58-2.31-2.03l-1.3-.39C8.3 11.5 7 10.15 7 8.35c0-1.69 1.33-2.92 2.76-3.32V3h2.67v1.93c1.61.35 2.89 1.43 3.03 3.19h-1.95c-.13-.9-.95-1.64-2.18-1.64-1.2 0-2.02.77-2.02 1.96 0 .93.75 1.58 2.21 2.03l1.41.44c2.56.77 3.91 2.21 3.91 4.19 0 1.93-1.47 3.32-3.43 3.68z"/></svg>`,
    wand: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 4l1.6 4.5h4.8l-3.8 3 1.4 4.5-3.8-3-3.8 3 1.4-4.5-3.8-3h4.8Z"/><path d="M2 22l9.5-9.5"/></svg>`,    undo: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>`,
    redo: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 14 5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/></svg>`,
    copy: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`,
    list: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
    grid: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>`,
    save: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
    minusCircle: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>`,
    print: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>`,
    
    // --- New Template Icons ---
    film: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/><line x1="2" y1="7" x2="7" y2="7"/><line x1="2" y1="17" x2="7" y2="17"/><line x1="17" y1="17" x2="22" y2="17"/><line x1="17" y1="7" x2="22" y2="7"/></svg>`,
    camera: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>`,

    // --- Footer New Assets ---
gear: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>`,
coffee: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>`,
paperPlane: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`,
image: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`,
wallet: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"/></svg>`,

// --- 1. Document & Studio Navigation ---
    eye: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
    share: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>`,
    check: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
    filter: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>`,

    // --- 2. Analytics Cortex (Tier 5 Intelligence) ---
    barChart: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>`,
    heatmap: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>`,
    history: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
    alert: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,

    // --- 3. Finance & Payment (Foundations Phase 3) ---
    bank: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18M5 21V7l8-4 8 4v14M10 10v6M14 10v6"/></svg>`,
    globe: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`,
    creditCard: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>`,
    receipt: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1z"></path><line x1="16" y1="6" x2="8" y2="6"></line><line x1="16" y1="10" x2="8" y2="10"></line><line x1="12" y1="14" x2="8" y2="14"></line></svg>`,

    // --- 4. Production Logistics & Metadata ---
    mapPin: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`,
    calendar: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`,
    sun: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
    hazard: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,

    // --- 5. UI Structure & Navigation ---
    chevronDown: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`,
    chevronRight: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`,
    maximize: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>`,
    minimize: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>`,
};

/* --- 4. Master Link Map (Backwards Compatibility) --- */
    const uiIcons = mBTAssets, tplIcons = mBTAssets, docIcons = mBTAssets, dashIcons = mBTAssets;
    const stageModIcons = mBTAssets, analyticsIcons = mBTAssets, contactIcons = mBTAssets;
    const fileIcons = mBTAssets, opsIcons = mBTAssets, studioIcons = mBTAssets, trashIcons = mBTAssets;

/* --- 5. Production Presets (Industry standard stage ratios) --- */
    const STAGE_PRESETS = {
        'TVC': { 'dev': 10, 'pre': 25, 'prod': 15, 'post': 35, 'dist': 15 },
        'Music Video': { 'dev': 10, 'pre': 20, 'prod': 15, 'post': 40, 'dist': 15 },
        'Documentary': { 'dev': 20, 'pre': 15, 'prod': 35, 'post': 20, 'dist': 10 },
        'Feature Film': { 'dev': 25, 'pre': 20, 'prod': 20, 'post': 25, 'dist': 10 }
    };

/* --- 5.1. Payment Methods (Foundations Phase 3) --- */
    const PAYMENT_SERVICES = [
        { id: 'cash', label: 'Cash / Petty Cash', icon: mBTAssets.money },
        { id: 'transfer', label: 'Bank Transfer (JMD)', icon: mBTAssets.bank },
        { id: 'wire', label: 'Intl Wire (USD)', icon: mBTAssets.globe },
        { id: 'cheque', label: 'Cheque', icon: mBTAssets.receipt },
        { id: 'paypal', label: 'PayPal', icon: mBTAssets.creditCard },
        { id: 'wise', label: 'Wise', icon: mBTAssets.wallet },
        { id: 'payoneer', label: 'Payoneer', icon: mBTAssets.creditCard }
    ];

/* --- 6. Budget Templates (Industry Standard Structures) --- */
    const BUDGET_TEMPLATES = {
        'Commercial': {
            icon: 'film',
            label: 'TV Commercial',
            desc: 'Standard TVC structure. High-end crew, talent fees, and heavy post-production.',
            structure: [
                { id: 'atl', name: 'Above The Line', items: ['Director', 'Producer', 'Copywriter (Pitch/Treatment)', 'Casting Director'] },
                { id: 'prod', name: 'Production', items: ['Director of Photography (DP)', 'Camera Operator', 'Gaffer', 'Key Grip', 'Sound Mixer', 'Makeup Artist (Key)', 'Production Designer', 'Wardrobe Stylist'] },
                { id: 'post', name: 'Post-Production', items: ['Editor', 'Colorist', 'VFX Artist', 'Sound Designer', 'Music Supervisor'] },
                { id: 'other', name: 'Logistics & Talent', items: ['Cast - Lead', 'Location Manager', 'Catering (Per Head)', 'Equipment Rental', 'Insurance'] }
            ]
        },
        'Documentary': {
            icon: 'camera',
            label: 'Documentary',
            desc: 'Run-and-gun optimized. Prioritizes travel, field logistics, research, and archival licensing.',
            structure: [
                { id: 'atl', name: 'Creative & Research', items: ['Director', 'Producer', 'Researcher', 'Subject Consultant'] },
                { id: 'prod', name: 'Field Production', items: ['Director of Photography (DP)', 'Sound Mixer', 'Fixer/Local Producer', 'Drone Operator'] },
                { id: 'travel', name: 'Travel & Logistics', items: ['Flights', 'Accommodation', 'Per Diems', 'Vehicle Rental', 'Carnets/Visas'] },
                { id: 'post', name: 'Post & Archive', items: ['Editor', 'Transcription', 'Archival Researcher', 'Archival Licensing', 'Colorist'] }
            ]
        },
        'Live Stream': {
            icon: 'zap',
            label: 'Live Broadcast',
            desc: 'Multi-cam setup. Focus on bandwidth redundancy, switching hardware, and technical operators.',
            structure: [
                { id: 'tech', name: 'Technical Crew', items: ['Technical Director', 'Stream Technician', 'Camera Operator', 'Camera Operator', 'Sound Mixer', 'Graphics Op'] },
                { id: 'gear', name: 'Hardware & Rigging', items: ['Switcher/Encoder', 'Cameras (3-Cam Kit)', 'Comms System', 'Bonded Cellular', 'Lighting Package'] },
                { id: 'conn', name: 'Connectivity', items: ['Dedicated Internet Line', '4G/5G Backup Data', 'IT Support'] },
                { id: 'other', name: 'Venue & Logistics', items: ['Venue Power Fee', 'Rigging', 'Crew Meals', 'Transport'] }
            ]
        }
    };
    
    // --- MASTER NAMESPACE (Tier 1 Hoist) ---
    // Logic Resolution: Establishing the root namespace early to allow Tiers 2-6 to attach modules safely.
    window.mBT = {
        config: { version: APP_VERSION },
        core: {},    // Tier 1 (Kernel)
        data: {},    // Tier 2
        logic: {},   // Tier 3
        ui: {},      // Tier 4
        features: {} // Tier 5
    };

    /* ========= v19.54 TIER 1.5: THE KERNEL (mBTCore) ========= */
    // Logic Resolution: Central Event Bus and Initialization Handler
    mBT.core = {
        // Pub/Sub Event Bus
        events: {
            listeners: {},
            on(event, callback) {
                if (!this.listeners[event]) this.listeners[event] = [];
                this.listeners[event].push(callback);
            },
            emit(event, data) {
                if (this.listeners[event]) {
                    this.listeners[event].forEach(cb => cb(data));
                }
            },
            off(event, callback) {
                if (!this.listeners[event]) return;
                this.listeners[event] = this.listeners[event].filter(cb => cb !== callback);
            }
        },

        // --- NEW: Action Registry (The Nervous System) ---
        actions: {},
        
        // Register an action (e.g., core.action('save', () => ...))
        action(name, fn) { this.actions[name] = fn; },

        // Router: Finds the closest action and executes it
        route(e) {
            // 1. Find the trigger
            const el = e.target.closest('[data-action]');
            if (!el) return false;
            
            // 2. Match the action
            const actionName = el.dataset.action;
            const handler = this.actions[actionName];
            
            // 3. Execute
            if (handler) {
                // Prevent default for clicks to stop form submissions or link jumps, 
                // but allow 'change' events to propagate if needed.
                if (e.type === 'click' || e.type === 'submit') e.preventDefault();
                handler(e, el); 
                return true; 
            }
            return false;
        },
        
        // System Bootstrap (Migration from Tier 6)
        async init() {
            // 1. Establish The Reactive Loop
            // Logic Resolution: The UI now listens to the Kernel, not the Data directly.
            this.events.on('budget:updated', () => {
                if (mBT.ui && typeof mBT.ui.refresh === 'function') {
                    mBT.ui.refresh();
                }
            });

            // 2. Document Identity
            document.title = `mooBudgetTool v${APP_VERSION}`;
            
            // 3. State Hydration
            displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
            
            // 3.5 Database Pre-flight (Async Migration)
            // Ensures Rate DB is ready before UI renders
            if(mBT.opengate && typeof mBT.opengate.init === 'function') {
                await mBT.opengate.init();
            }

            // 4. Brain Handshake
            if (typeof fetchExchangeRates === 'function') fetchExchangeRates();
            if (typeof injectFooterIcons === 'function') injectFooterIcons();
            
            // 5. Persistence Recovery (ASYNC UPGRADE)
            let projectToLoad = localStorage.getItem(`${storageKeyPrefix}lastLoaded`);
            
            // Logic Resolution: Await the project list from Async Storage
            let projectList = [];
            if (typeof getProjectList === 'function') {
                try {
                    const result = getProjectList();
                    // Support both Promise (Tier 2) and Array (Legacy)
                    projectList = result instanceof Promise ? await result : result;
                } catch (e) { 
                    console.warn("Project list unavailable:", e); 
                    projectList = [];
                }
            }
            
            if (!projectToLoad || !projectList.includes(projectToLoad)) {
                projectToLoad = projectList.length > 0 ? projectList[0] : null;
            }
            
            // 6. Structural Resolution
            try {
                if (!projectToLoad) {
                    if (typeof handleNewProject === 'function') {
                        const res = handleNewProject(false);
                        if(res instanceof Promise) await res;
                    }
                } else {
                    if (typeof loadBudget === 'function') {
                        const res = loadBudget(projectToLoad);
                        if(res instanceof Promise) await res;
                    }
                }
            } catch (bootErr) {
                console.error("Boot Critical Failure:", bootErr);
                // Emergency Recovery
                if(typeof mBT.data.newProject === 'function') await mBT.data.newProject(true);
            }
            
            // 7. UI Ignition
            // Logic Resolution: We trigger the first render via the Event Bus
            if (typeof bindAppEventListeners === 'function') bindAppEventListeners();
            
            // Logic Resolution: Enforce Zoom/Viewport Settings immediately
            if (mBT.ui && typeof mBT.ui.updateViewport === 'function') mBT.ui.updateViewport();

            this.events.emit('budget:updated');
            console.log(`Studio Core v${APP_VERSION} Synchronized via mBTCore.`);
        }
    };



/* ========= v19.54 TIER 2: State Proxy & Storage Engine ========= */

    /* --- 1. mBT.data: THE MODEL (Unified Data Architecture) --- */
    mBT.data = {
        // --- A. State Governor (Reactivity) ---
        state: {
            _timer: null,      // Fast Timer: Math & UI
            _saveTimer: null,  // Slow Timer: Storage
            _logBuffer: {},    // Tier 2: Audit Debounce Map
            _isInitialLoad: true,
            _subscribers: [], 
            
            subscribe: function(callback) { this._subscribers.push(callback); },
            
            // Tier 2: Audit Recording Engine
            audit: function(action, targetName, meta = {}) {
                if(this._isInitialLoad || !budget || !budget.activityLog) return;
                
                const entry = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                    ts: new Date().toISOString(),
                    user: "Local User", 
                    action: action, 
                    target: targetName,
                    section: meta.section || 'General',
                    diff: meta.diff || null,
                    itemId: meta.itemId || null // Logic Resolution: Persist ID for Revert capability
                };

                // Cap log size to prevent storage bloat
                if(budget.activityLog.length >= 200) budget.activityLog.shift();
                budget.activityLog.push(entry);
            },

            handler: {
                set(target, prop, value) {
                    if (target[prop] === value) return true; 
                    
                    // Tier 2 Audit Logic: Trap Changes
                    // Filter out internal state, existing log updates, and pure UI toggles
                    const pKey = prop.toString();
                    const isInternal = pKey.startsWith('_') || pKey === 'activityLog' || pKey === 'isOpen';
                    
                    if (!mBT.data.state._isInitialLoad && !isInternal) {
                        const itemId = target.id || (target.projectName ? 'Project' : 'Root');
                        const label = target.description || target.name || target.projectName || pKey;
                        const debounceId = `${itemId}_${pKey}`;
                        
                        const diff = { field: pKey, oldValue: target[prop], newValue: value };

                        // Strategy: Debounce Strings (typing), Immediate Numbers/Bools
                        if (typeof value === 'string') {
                            clearTimeout(mBT.data.state._logBuffer[debounceId]);
                            mBT.data.state._logBuffer[debounceId] = setTimeout(() => {
                                // Logic Resolution: Pass itemId to audit for linkage
                                mBT.data.state.audit('UPDATE', label, { diff: diff, itemId: itemId });
                                delete mBT.data.state._logBuffer[debounceId];
                            }, 800);
                        } else {
                            // Immediate Log for critical math/logic changes
                            mBT.data.state.audit('UPDATE', label, { diff: diff, itemId: itemId });
                        }
                    }

                    target[prop] = value;
                    if (!mBT.data.state._isInitialLoad) mBT.data.state.requestReconciliation();
                    return true;
                }
            },
            
            requestReconciliation() {
                // Stream A: Logic & Visuals (Fast Debounce)
                clearTimeout(this._timer);
                this._timer = setTimeout(() => {
                    if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
                    mBT.core.events.emit('budget:updated');
                    this._subscribers.forEach(cb => { try { cb(budget); } catch(e) {} });
                }, 50);

                // Stream B: Persistence (Slow Debounce - ASYNC)
                clearTimeout(this._saveTimer);
                this._saveTimer = setTimeout(async () => {
                    await mBT.data.save(); 
                    const statusMsg = document.getElementById('statusBarMessage');
                    if (statusMsg) {
                        const originalText = statusMsg.textContent;
                        statusMsg.textContent = "Saved to disk.";
                        setTimeout(() => statusMsg.textContent = originalText, 2000);
                    }
                }, 1000);
            },
            wrap: function(data) {
                this._isInitialLoad = true;
                const proxied = new Proxy(data, this.handler);
                this._isInitialLoad = false;
                return proxied;
            }
        },

        // --- NEW: History Namespace (Tier 2 Architecture Alignment) ---
        history: {
            // 1. Granular Revert (Activity Log Logic)
            revert: function(logId) {
                const entry = budget.activityLog.find(e => e.id === logId);
                if (!entry || !entry.diff || !entry.itemId) return mBTME.alert("Error", "Cannot revert this change (Missing Data).");

                const { itemId, diff } = entry;
                
                // Locate the item in the live budget
                let targetItem = null;
                if (itemId === 'Project') targetItem = budget;
                else if (itemId === 'Root') targetItem = budget;
                else {
                    Object.values(budget.sections).forEach(sec => {
                        if (!targetItem) targetItem = sec.items.find(i => i.id === itemId);
                    });
                }

                if (targetItem) {
                    mBTME.confirm("Revert Change", `Revert "${entry.target}" to previous value?`, () => {
                        // Apply the old value
                        targetItem[diff.field] = diff.oldValue;
                        
                        // Force update
                        mBTLE.reconcile();
                        if (typeof mBT.ui.paint === 'function') mBT.ui.paint();
                        
                        // Log the Reversion
                        mBT.data.state.audit('REVERT', entry.target, { 
                            diff: { field: diff.field, oldValue: diff.newValue, newValue: diff.oldValue },
                            itemId: itemId 
                        });
                        
                        mBTME.alert("Success", "Value restored.");
                        // Refresh history UI if open
                        if(document.getElementById('activityLogModal')) mBT.features.history.open();
                    });
                } else {
                    mBTME.alert("Error", "Original item no longer exists.");
                }
            },

            // 2. Global Snapshot Logic (Moved from Global Scope)
            undoSnapshot: function() {
                if (historyIndex > 0) {
                    historyIndex--;
                    const snapshot = historyStack[historyIndex];
                    budget = mBT.data.state.wrap(JSON.parse(JSON.stringify(snapshot.budget)));
                    
                    // Logic Resolution: Log restoration event to explain state jump in Activity Log
                    if(mBT.data.state && mBT.data.state.audit) {
                        mBT.data.state.audit('RESTORE', `Undo: ${snapshot.description || 'System State'}`, { section: 'System' });
                    }

                    if(typeof render === 'function') render();
                }
            },
            redoSnapshot: function() {
                if (historyIndex < historyStack.length - 1) {
                    historyIndex++;
                    const snapshot = historyStack[historyIndex];
                    budget = mBT.data.state.wrap(JSON.parse(JSON.stringify(snapshot.budget)));
                    
                    // Logic Resolution: Log restoration event
                    if(mBT.data.state && mBT.data.state.audit) {
                        mBT.data.state.audit('RESTORE', `Redo: ${snapshot.description || 'System State'}`, { section: 'System' });
                    }
                    
                    if(typeof render === 'function') render();
                }
            }
        },
        
          // --- C. Template Manager (Formerly mBTDBM) ---
        // Logic Resolution: Manages custom user budget templates.
        templates: {
             getTemplates: function() {
                const defaults = {
                    'Commercial': { items: [{ description: 'Director', rate: 1500, unit: 'Day' }, { description: 'DOP', rate: 1200, unit: 'Day' }] },
                    'Music Video': { items: [{ description: 'Director', rate: 800, unit: 'Day' }, { description: 'Editor', rate: 600, unit: 'Flat' }] }
                };
                const stored = JSON.parse(localStorage.getItem('mBT_templates') || '{}');
                return { ...defaults, ...stored };
            },
            saveFromProject: function(projectData) {
                const structure = [];
                const sections = projectData.sections || {};
                
                Object.entries(sections).forEach(([key, sec]) => {
                    const items = (sec.items || []).map(i => {
                        const item = JSON.parse(JSON.stringify(i));
                        item.actual = 0;
                        item.crew = { name: '', phone: '', email: '' };
                        if (['Day', 'Week'].includes(item.unit)) item.quantity = 1;
                        if (item.stageData) Object.keys(item.stageData).forEach(k => item.stageData[k].days = 1);
                        return item;
                    });
                    structure.push({ id: sec.id, name: key, items: items });
                });

                const name = projectData.projectName + " (Blueprint)";
                this.saveTemplate(name, { 
                    structure: structure, 
                    label: name, 
                    desc: 'Sanitized Project Clone', 
                    icon: 'file' 
                });
            },
            saveTemplate: function(name, items) {
                const custom = JSON.parse(localStorage.getItem('mBT_templates') || '{}');                custom[name] = { items: items };
                localStorage.setItem('mBT_templates', JSON.stringify(custom));
            },
            deleteTemplate: function(name) {
                if(['Commercial', 'Music Video'].includes(name)) return mBTME.alert("System Error", "Cannot delete default templates.");
                const custom = JSON.parse(localStorage.getItem('mBT_templates') || '{}');
                delete custom[name];
                localStorage.setItem('mBT_templates', JSON.stringify(custom));
                return true;
            },
            renderTemplateOptions: function(selected) {
                return Object.keys(this.getTemplates()).map(k => 
                    `<option value="${k}" ${k === selected ? 'selected' : ''}>${k}</option>`
                ).join('');
            }
        },
        
        // --- STORAGE & PERSISTENCE (ASYNC UPGRADE) ---
        // Logic Resolution: Swapped synchronous localStorage for Async localForage to unblock UI thread.
        storage: {
            // Internal Helper: Check if Engine is Online
            _ready: function() { return typeof localforage !== 'undefined'; },

            async save(key, data) { 
                if (this._ready()) await localforage.setItem(key, data); 
                else localStorage.setItem(key, JSON.stringify(data)); 
            },
            
            async load(key) { 
                if (this._ready()) return await localforage.getItem(key);
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : null;
            },
            
            async remove(key) { 
                if (this._ready()) await localforage.removeItem(key);
                else localStorage.removeItem(key);
            },
            
            async keys() { 
                if (this._ready()) return await localforage.keys();
                return Object.keys(localStorage);
            },

            // Task 1: Binary Storage Extension (Blobs)
            async saveBlob(key, blob) { 
                try { 
                    if (this._ready()) {
                        await localforage.setItem(key, blob); 
                        return true; 
                    } else {
                        console.warn("Blob storage requires localForage (Offline Fallback Active). Asset skipped.");
                        return false; 
                    }
                } 
                catch(e) { console.error("Blob Storage Error:", e); return false; }
            },
            async loadBlob(key) {
                try { 
                    if (this._ready()) {
                        const blob = await localforage.getItem(key); 
                        return blob instanceof Blob ? URL.createObjectURL(blob) : null; 
                    }
                    return null;
                } catch(e) { console.error("Blob Retrieval Error:", e); return null; }
            }
        },

        async save() {

            if (!budget) return;
            const projectKey = storageKeyPrefix + budget.projectName;
            
            // Fix: Strip Proxy before saving to IndexedDB (Prevent "could not be cloned" error)
            // We use JSON parse/stringify to create a clean deep copy free of Proxy traps.
            // This ensures strict serialization for the database while keeping the app reactive.
            try {
                const cleanData = JSON.parse(JSON.stringify(budget));
                await this.storage.save(projectKey, cleanData);
                localStorage.setItem(`${storageKeyPrefix}lastLoaded`, budget.projectName);
            } catch (e) {
                console.error("Save Failed:", e);
                // Fallback: If JSON fails (e.g. circular refs), try basic object copy
                const fallbackData = { ...budget };
                await this.storage.save(projectKey, fallbackData);
            }
        },

        async load(projectName) {
            const projectKey = storageKeyPrefix + projectName;
            let data = await this.storage.load(projectKey);

            // Lazy Migration Logic: If not in Forage, check Local and upgrade
            if (!data) {
                const raw = localStorage.getItem(projectKey);
                if (raw) {
                    try {
                        data = JSON.parse(raw);
                        await this.storage.save(projectKey, data); // Upgrade
                        console.log(`Migrated ${projectName} to Async Storage`);
                    } catch(e) { console.error("Migration failed", e); }
                }
            }

            if (data) {
                budget = mBT.data.state.wrap(data);
                currentProjectName = budget.projectName;
                if(typeof render === 'function') render();
                if(typeof renderProjectManagement === 'function') renderProjectManagement();
            }
        },

        async getList() {
            const fKeys = await this.storage.keys();
            const lKeys = Object.keys(localStorage);
            const combined = new Set([...fKeys, ...lKeys]);
            
            return Array.from(combined)
                .filter(k => k.startsWith(storageKeyPrefix) && 
                    !k.includes('_trash') && 
                    !k.includes('_globalItems') && 
                    !k.includes('_templates') && 
                    !k.endsWith('currency') && 
                    !k.endsWith('rates') && 
                    !k.endsWith('lastLoaded') &&
                    !k.endsWith('ApiKey') && 
                    !k.endsWith('selectedAiProvider') &&
                    !k.endsWith('projectDateFormat') && 
                    !k.endsWith('projectNameSeparator')
                )
                .map(k => k.replace(storageKeyPrefix, ''));
        },
        
        newProject: async function(force = false, type = 'Commercial') {
            const executeCreate = async () => {
                try {
                    const now = new Date();
                    const yyyy = now.getFullYear();
                    const mm = String(now.getMonth() + 1).padStart(2, '0');
                    const dd = String(now.getDate()).padStart(2, '0');
                    
                    const dateFmt = localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD';
                    const dateStr = dateFmt === 'MMDDYYYY' ? `${mm}${dd}${yyyy}` : `${yyyy}${mm}${dd}`;
                    
                    const storedSep = localStorage.getItem(projectNameSeparatorKey);
                    const sep = storedSep !== null ? storedSep : ' ';
                    
                    // --- TEMPLATE RESOLUTION ENGINE ---
                    let sections = {};
                    let baseLabel = "Project";

                    // 1. Check System Templates (Tier 1)
                    if (typeof BUDGET_TEMPLATES !== 'undefined' && BUDGET_TEMPLATES[type]) {
                        const tmpl = BUDGET_TEMPLATES[type];
                        baseLabel = tmpl.label;
                        
                        // Logic Upgrade: Hydrate rates from Open Gate Database
                        const rateDb = (typeof mBT.opengate !== 'undefined' && mBT.opengate.rates) ? mBT.opengate.rates : [];

                        tmpl.structure.forEach(s => {
                            sections[s.name] = {
                                id: s.id,
                                isOpen: true,
                                items: s.items.map((desc, idx) => {
                                    // Find matching rate in database (Safe Access)
                                    const match = rateDb.find(r => r && r.description && desc && r.description.toLowerCase() === desc.toLowerCase());
                                    return {
                                        id: `item_${Date.now()}_${idx}_${Math.floor(Math.random()*1000)}`,
                                        description: desc,
                                        quantity: 1,
                                        unit: match ? match.unit : 'Day',
                                        rate: match ? match.rate : 0, // Auto-fill rate if found
                                        multiplier: 1,
                                        actual: 0,
                                        rateType: 'negotiable',
                                        crew: {}
                                    };
                                })
                            };
                        });
                    } 
                    // 2. Check User Templates (Tier 2 Custom)
                    else if (mBT.data.templates.getTemplates()[type]) {
                        const customTmpl = mBT.data.templates.getTemplates()[type];
                        baseLabel = type;
                        
                        if (customTmpl.structure) {
                            // Handle Blueprint Structure
                            customTmpl.structure.forEach(s => {
                                sections[s.name] = {
                                    id: s.id,
                                    isOpen: true,
                                    items: s.items.map((i, idx) => ({
                                        id: `item_${Date.now()}_${idx}_${Math.floor(Math.random()*1000)}`,
                                        ...i,
                                        quantity: 1, multiplier: 1, actual: 0, crew: {}
                                    }))
                                };
                            });
                        } else {
                            // Legacy Flat List Fallback
                            sections['Production'] = { 
                                id: 'prod', 
                                isOpen: true, 
                                items: customTmpl.items ? customTmpl.items.map((i, idx) => ({
                                    id: `item_${Date.now()}_${idx}`,
                                    ...i,
                                    quantity: 1, multiplier: 1, actual: 0, crew: {}
                                })) : [] 
                            };
                            // Add standard headers
                            sections['Above The Line'] = { id: 'atl', isOpen: true, items: [] };
                            sections['Post-Production'] = { id: 'post', isOpen: true, items: [] };
                        }
                    }
                    // 3. Fallback Default
                    else {
                        sections = {
                            'Above The Line': { id: 'atl', isOpen: true, items: [] },
                            'Production': { id: 'prod', isOpen: true, items: [] },
                            'Post-Production': { id: 'post', isOpen: true, items: [] },
                            'Other': { id: 'other', isOpen: true, items: [] }
                        };
                    }

                    // --- COLLISION DETECTION (Tier 2 Logic Injection) ---
                    let proposedName = `${baseLabel}${sep}${dateStr}`;
                    let uniqueName = proposedName;
                    let counter = 1;
                    
                    while (
                        (await this.storage.load(storageKeyPrefix + uniqueName)) || 
                        localStorage.getItem(storageKeyPrefix + uniqueName)
                    ) {
                        uniqueName = `${proposedName}_${counter}`;
                        counter++;
                    }

                    const newBudget = {
                        projectName: uniqueName,
                        company: "Independent",
                        startDate: new Date().toISOString().split('T')[0],
                        sections: sections,
                        grandTotal: 0,
                        subtotal: 0,
                        actualTotal: 0,
                        contingencyPercentage: 10,
                        salesTaxPercentage: 0,
                        discountPercentage: 0,
                        documents: [],
                        attachments: [],
                        aiContext: { chat: [], analysis: "" },
                        activityLog: [], // Tier 2 Audit Init
                        mediaRoot: null,
                        storageProtocol: 'internal'
                    };
                    
                    budget = mBT.data.state.wrap(newBudget);
                    currentProjectName = budget.projectName;
                    await this.save();
                    if(typeof render === 'function') render();
                    if(typeof renderProjectManagement === 'function') await renderProjectManagement();
                    
                    const projectSelect = document.getElementById('projectSelect');
                    if (projectSelect) {
                        projectSelect.value = uniqueName;
                    }
                } catch (err) {
                    console.error("Critical Failure in New Project Logic:", err);
                    mBTME.alert("Error", "Could not create project. Check console.");
                }
            };

            if (force) {
                mBTME.confirm("Create Project", "Start a new budget? Unsaved changes will be lost.", executeCreate);
            } else {
                executeCreate();
            }
        },
        
        duplicate: async function() {
            if(!budget) return;
            const copy = JSON.parse(JSON.stringify(budget));
            copy.projectName = copy.projectName + " (Copy)";
            budget = mBT.data.state.wrap(copy);
            await this.save();
            if(typeof render === 'function') render();
        },
        
        deleteProject: async function(name) {
             mBTME.confirm("Delete Project", `Are you sure you want to move "${name}" to the Recycle Bin?`, async () => {
                // Async Load before trash
                let data = await this.storage.load(storageKeyPrefix + name);
                if(!data) {
                    const raw = localStorage.getItem(storageKeyPrefix + name);
                    if(raw) data = JSON.parse(raw);
                }

                if(data) {
                    const trashed = JSON.parse(localStorage.getItem(trashKey) || '[]');
                    trashed.push(data);
                    localStorage.setItem(trashKey, JSON.stringify(trashed));
                }
                
                await this.storage.remove(storageKeyPrefix + name);
                localStorage.removeItem(storageKeyPrefix + name); // Clean legacy

                const list = await this.getList();
                if (list.length) await this.load(list[0]); else await this.newProject();
                if(typeof renderProjectManagement === 'function') renderProjectManagement();
            });
        },
        
        importFile: function(input) {
            const file = input.files[0];
            if (!file) return;

            // Shared Finalizer Logic
            const finalizeImport = async (data, assetReport = null) => {
                try {
                    if (!data.projectName) throw new Error("Invalid file structure");
                    const projectKey = storageKeyPrefix + data.projectName;
                    const existing = await this.storage.load(projectKey) || localStorage.getItem(projectKey);
                    
                    const execute = async () => {
                        budget = mBT.data.state.wrap(data);
                        await this.save();
                        await this.load(data.projectName);
                        if(typeof renderProjectManagement === 'function') renderProjectManagement();
                        
                        let msg = "Project restored successfully.";
                        if (assetReport) {
                            msg += `\nAssets: ${assetReport.restored}/${assetReport.total} rehydrated.`;
                            if (assetReport.missing > 0) mBTME.alert("Integrity Warning", msg + `\n${assetReport.missing} files were missing from the bundle.`);
                            else mBTME.alert("Import Complete", msg);
                        } else {
                            mBTME.alert("Import Successful", msg);
                        }
                    };

                    if (existing) mBTME.confirm("Overwrite", `Overwrite existing project "${data.projectName}"?`, execute);
                    else execute();
                } catch (err) { mBTME.alert("Import Failed", err.message); }
                input.value = '';
            };

        // Tier 2: Intent Gatekeeper
        const askUserIntent = (data, assetReport = null) => {
            const content = `
            <div class="grid grid-cols-1 gap-4 p-6 sm:grid-cols-2">
                <button id="btnImportResume" class="flex flex-col items-center gap-4 p-6 bg-emerald-50 border border-emerald-100 rounded-2xl hover:border-emerald-500 hover:shadow-xl transition-all group text-center">
                    <div class="w-14 h-14 bg-white text-emerald-600 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform shadow-sm">${mBTAssets.wand}</div>
                    <div>
                        <h4 class="font-black text-xs uppercase tracking-widest text-emerald-900">Resume Project</h4>
                        <p class="text-[9px] text-emerald-600 font-bold mt-1">Load Budget & Assets</p>
                    </div>
                </button>

                <button id="btnImportBlueprint" class="flex flex-col items-center gap-4 p-6 bg-indigo-50 border border-indigo-100 rounded-2xl hover:border-indigo-500 hover:shadow-xl transition-all group text-center">
                    <div class="w-14 h-14 bg-white text-indigo-600 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform shadow-sm">${mBTAssets.copy}</div>
                    <div>
                        <h4 class="font-black text-xs uppercase tracking-widest text-indigo-900">Save as Blueprint</h4>
                        <p class="text-[9px] text-indigo-600 font-bold mt-1">Extract Structure Only</p>
                    </div>
                </button>
            </div>
            <div class="px-6 pb-4 text-center">
                <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Source: ${mBT.ui.render.esc(data.projectName)}</p>
            </div>`;

            mBTME.open('importIntent', 'Import Strategy', content, 'max-w-lg', { noPadding: true });

            setTimeout(() => {
                const resume = document.getElementById('btnImportResume');
                const blueprint = document.getElementById('btnImportBlueprint');
                
                if(resume) resume.onclick = () => {
                    mBTME.close('importIntentModal');
                    finalizeImport(data, assetReport);
                };
                
                if(blueprint) blueprint.onclick = () => {
                    mBTME.close('importIntentModal');
                    mBT.data.templates.saveFromProject(data);
                    mBTME.alert("Success", "Structure extracted to My Blueprints.", () => {
                        if(typeof showNewProjectModal === 'function') showNewProjectModal();
                    });
                };
            }, 50);
        };
        
        // --- UNIVERSAL LOADER (Zip First -> Text Fallback) ---
        mBTME.showLoader("Analyzing Container...");
        
        JSZip.loadAsync(file).then(async (zip) => {
            // PATH A: Valid Bundle (New .moo or .zip)
            try {
                // 1. Extract Core Data
                const mooFile = Object.values(zip.files).find(f => f.name.endsWith('.moo') && !f.name.startsWith('__MACOSX'));
                if (!mooFile) throw new Error("Invalid Bundle: No .moo manifest found.");
                
                const jsonStr = await mooFile.async("string");
                const data = JSON.parse(jsonStr);
                
                // 2. Rehydration Loop
                let stats = { total: 0, restored: 0, missing: 0 };
                
                if (data.documents) {
                    for (const doc of data.documents) {
                        if (!doc.attachments) continue;
                        for (let i = 0; i < doc.attachments.length; i++) {
                            const att = doc.attachments[i];
                            if (att.location === 'internal' && att.key) {
                                stats.total++;
                                const safeName = (att.name || 'file').replace(/[^a-z0-9.]/gi, '_');
                                const zipPath = `assets/${doc.id}_${i}_${safeName}`;
                                const assetFile = zip.file(zipPath);
                                
                                if (assetFile) {
                                    try {
                                        const blob = await assetFile.async("blob");
                                        await mBT.data.storage.saveBlob(att.key, blob);
                                        stats.restored++;
                                    } catch (e) {
                                        console.error("Asset Write Fail:", att.name, e);
                                        stats.missing++;
                                    }
                                } else {
                                    stats.missing++;
                                }
                            }
                        }
                    }
                }
                
                mBTME.hideLoader();
                askUserIntent(data, stats);

            } catch(e) {
                throw e; // Pass to fallback handler
            }

        }).catch(e => {
            // PATH B: Legacy Text Import (JSON)
            // If JSZip failed, it's likely a text file.
            
            const reader = new FileReader();
            reader.onload = (e) => {
                mBTME.hideLoader();
                try {
                    const json = JSON.parse(e.target.result);
                    askUserIntent(json);
                } catch (parseErr) {
                    // If both Zip and JSON fail, it's truly invalid
                    mBTME.alert("Import Error", "File format not recognized. (Not a valid Bundle or Legacy JSON)");
                }
            };
            reader.onerror = () => {
                mBTME.hideLoader();
                mBTME.alert("System Error", "Could not read file.");
            };
            reader.readAsText(file);
        });
    },
        
        recorder: {
            snapshot: function(actionDescription) {
                if (!budget) return;
                // Logic Resolution: Prune "Future" history if we are in the middle of a stack
                if (historyIndex < historyStack.length - 1) historyStack = historyStack.slice(0, historyIndex + 1);
                
                try {
                    // Logic Resolution: Deep Clean Copy (Strip Proxy & Circular Refs)
                    const cleanState = JSON.parse(JSON.stringify(budget));
                    
                    historyStack.push({ 
                        id: `snap_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                        description: actionDescription, 
                        timestamp: new Date().toISOString(),
                        budget: cleanState // Maintain '.budget' key for legacy compatibility
                    });
                    
                    // Logic Resolution: Enforce Memory Constraints
                    if (historyStack.length > MAX_HISTORY) historyStack.shift();
                    
                    historyIndex = historyStack.length - 1;
                    
                    // Logic Resolution: Update UI Indicators (Passive)
                    if(typeof renderStatusBar === 'function') renderStatusBar();
                    
                } catch (e) {
                    console.error("Snapshot Failed:", e);
                }
            }
        },
        
        // Alias for backward compatibility (mapped to recorder)
        pushHistory: function(desc) { this.recorder.snapshot(desc); }
    };

    /* ========= v19.54 TIER 2.5: OPEN GATE INFRASTRUCTURE (mBT.opengate) ========= */
    mBT.opengate = {
        settings: {
            optInSharing: JSON.parse(localStorage.getItem('moo_og_share') || 'false'),
            location: localStorage.getItem('moo_og_loc') || 'Jamaica'
        },
        rates: [], 
        contacts: [], 
        templates: [], // Document Definitions (Studio Builder)

        async init() {
            await Promise.all([this.loadRates(), this.loadContacts()]);
            this.loadTemplates();
            console.log(`Open Gate Initialized (Async): ${this.rates.length} rates, ${this.contacts.length} contacts.`);
        },

        async loadRates() {
            const key = 'prodBudget_v5_globalItems';
            let stored = await mBT.data.storage.load(key);
            
            // Migration Bridge: Check legacy sync storage if async is empty
            if (!stored) {
                const raw = localStorage.getItem(key);
                if(raw) {
                    try { stored = JSON.parse(raw); await mBT.data.storage.save(key, stored); } 
                    catch(e) { console.warn("Rate migration failed", e); }
                }
            }

            this.rates.length = 0; 
            if (!stored || stored.length === 0) {
                this.rates.push(...this._getJamaicaDatabase());
                await this.saveRates();
            } else {
                this.rates.push(...stored);
            }
        },

        async loadContacts() { 
            const key = 'moo_contacts';
            let c = await mBT.data.storage.load(key);
            
            // Migration Bridge
            if (!c) {
                const raw = localStorage.getItem(key);
                if(raw) {
                    try { c = JSON.parse(raw); await mBT.data.storage.save(key, c); }
                    catch(e) { console.warn("Contact migration failed", e); }
                }
            }

            this.contacts.length = 0; 
            if(c) this.contacts.push(...c);
        },

        // --- PERSISTENCE LAYER ---
        async saveRates() { await mBT.data.storage.save('prodBudget_v5_globalItems', this.rates); },
        async saveContacts() { await mBT.data.storage.save('moo_contacts', this.contacts); },

        // --- NON-TRUNCATABLE TEMPLATE REGISTRY (Documents) ---
        loadTemplates() {
            // Logic Resolution: Centralized Blueprint Schemas (Migrated from Tier 5)
            // Open Gate is now the single source of truth for Document Layouts.
            // Batch 2.3: Liquid Grid Protocol - Removed 'y' coords, added autoPosition:true
            const t = [
                // --- WRITING & CORE ---
                {
                    id: 'script', cat: 'Pre-Prod', label: 'Script', icon: 'file', default: true,
                    widgets: [{ id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true }, { id: 'body', x: 0, w: 12, h: 12, type: 'richText', label: "Screenplay", autoPosition: true }]
                },
                {
                    id: 'treatment', cat: 'Pre-Prod', label: 'Story Treatment', icon: 'file', default: false,
                    widgets: [{ id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true }, { id: 'body', x: 0, w: 12, h: 12, type: 'richText', label: "Story Treatment", autoPosition: true }]
                },
                // --- PRE-PRODUCTION ---
                {
                    id: 'breakdown', cat: 'Pre-Prod', label: 'Script Breakdowns', icon: 'search', default: true,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'cast', x: 0, w: 6, h: 6, type: 'cast', label: "Characters", autoPosition: true },
                        { id: 'logistics', x: 6, w: 6, h: 6, type: 'logistics', label: "Locations", autoPosition: true },
                        { id: 'notes', x: 0, w: 12, h: 4, type: 'richText', label: "Scene Notes & Requirements", autoPosition: true }
                    ]
                },
                {
                    id: 'shotlist', cat: 'Pre-Prod', label: 'Shot Lists', icon: 'film', default: true,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'schedule', x: 0, w: 12, h: 12, type: 'schedule', label: "Shot Sequence", autoPosition: true },
                        { id: 'logistics', x: 0, w: 12, h: 4, type: 'logistics', label: "Locations", autoPosition: true }
                    ]
                },
                {
                    id: 'storyboard', cat: 'Pre-Prod', label: 'Storyboards', icon: 'image', default: false,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'frame1', x: 0, w: 4, h: 6, type: 'image', label: "Frame 1", autoPosition: true },
                        { id: 'desc1', x: 0, w: 4, h: 3, type: 'richText', label: "Action 1", autoPosition: true },
                        { id: 'frame2', x: 4, w: 4, h: 6, type: 'image', label: "Frame 2", autoPosition: true },
                        { id: 'desc2', x: 4, w: 4, h: 3, type: 'richText', label: "Action 2", autoPosition: true },
                        { id: 'frame3', x: 8, w: 4, h: 6, type: 'image', label: "Frame 3", autoPosition: true },
                        { id: 'desc3', x: 8, w: 4, h: 3, type: 'richText', label: "Action 3", autoPosition: true }
                    ]
                },
                {
                    id: 'preCheck', cat: 'Pre-Prod', label: 'Pre-Prod Checklist', icon: 'check', default: true,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'logistics', x: 0, w: 6, h: 10, type: 'richText', label: "Logistics Checklist", autoPosition: true },
                        { id: 'creative', x: 6, w: 6, h: 10, type: 'richText', label: "Creative Checklist", autoPosition: true }
                    ]
                },
                {
                    id: 'casting', cat: 'Pre-Prod', label: 'Casting Sheets', icon: 'user', default: false,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'cast', x: 0, w: 12, h: 10, type: 'cast', label: "Audition List", autoPosition: true },
                        { id: 'notes', x: 0, w: 12, h: 4, type: 'richText', label: "Casting Director Notes", autoPosition: true }
                    ]
                },
                {
                    id: 'techScout', cat: 'Pre-Prod', label: 'Tech Scout Report', icon: 'mapPin', default: false,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'logistics', x: 0, w: 12, h: 10, type: 'logistics', label: "Location Details", autoPosition: true },
                        { id: 'notes', x: 0, w: 12, h: 6, type: 'richText', label: "Tech Notes (Power/Parking/Access)", autoPosition: true }
                    ]
                },
                { id: 'charProf', cat: 'Pre-Prod', label: 'Character Profiles', icon: 'user', default: false },
                { id: 'dood', cat: 'Pre-Prod', label: 'Day Out of Days', icon: 'calendar', default: false },
                { id: 'stripboard', cat: 'Pre-Prod', label: 'Stripboard Schedule', icon: 'calendar', default: false },
                
                // --- FINANCIAL & PITCH ---
                {
                    id: 'pitchDeck', cat: 'Pre-Prod', label: 'Funding Pitch Deck', icon: 'maximize', default: false,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'cover', x: 0, w: 6, h: 8, type: 'image', label: "Key Art", autoPosition: true },
                        { id: 'synopsis', x: 6, w: 6, h: 8, type: 'richText', label: "Logline & Synopsis", autoPosition: true },
                        { id: 'mood1', x: 0, w: 4, h: 4, type: 'image', label: "Tone Ref 1", autoPosition: true },
                        { id: 'mood2', x: 4, w: 4, h: 4, type: 'image', label: "Tone Ref 2", autoPosition: true },
                        { id: 'mood3', x: 8, w: 4, h: 4, type: 'image', label: "Tone Ref 3", autoPosition: true },
                        { id: 'team', x: 0, w: 12, h: 6, type: 'contacts', label: "Key Creative Team", autoPosition: true }
                    ]
                },
                {
                    id: 'budgetRep', cat: 'Pre-Prod', label: 'Budget Report', icon: 'money', default: true,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'summary', x: 0, w: 12, h: 4, type: 'richText', label: "Executive Summary", autoPosition: true },
                        { id: 'breakdown', x: 0, w: 12, h: 12, type: 'schedule', label: "Cost Breakdown", autoPosition: true }
                    ]
                },
                { id: 'vendorBid', cat: 'Pre-Prod', label: 'Vendor Bid Comparison', icon: 'alert', default: false },

                // --- PRODUCTION ---
                {
                    id: 'callSheet', cat: 'Production', label: 'Daily Call Sheet', icon: 'alert', default: true,
                    widgets: [
                        { id: 'contacts', x: 0, w: 6, h: 4, type: 'contacts', label: "Key Contacts", autoPosition: true },
                        { id: 'logistics', x: 6, w: 6, h: 4, type: 'logistics', label: "Logistics", autoPosition: true },
                        { id: 'schedule', x: 0, w: 12, h: 6, type: 'schedule', label: "Schedule", autoPosition: true },
                        { id: 'cast', x: 0, w: 6, h: 6, type: 'cast', label: "Cast List", autoPosition: true },
                        { id: 'crew', x: 6, w: 6, h: 6, type: 'crew', label: "Crew List", autoPosition: true },
                        { id: 'notes', x: 0, w: 12, h: 2, type: 'richText', label: "General Notes", autoPosition: true },
                        { id: 'footer', x: 0, w: 12, h: 2, type: 'footer', label: "Safety Footer", autoPosition: true }
                    ]
                },
                {
                    id: 'prodReport', cat: 'Production', label: 'Production Report', icon: 'barChart', default: true,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'schedule', x: 0, w: 12, h: 5, type: 'schedule', label: "Scenes Shot", autoPosition: true },
                        { id: 'crew', x: 0, w: 12, h: 5, type: 'crew', label: "Crew Attendance", autoPosition: true },
                        { id: 'notes', x: 0, w: 6, h: 4, type: 'richText', label: "Production Notes", autoPosition: true },
                        { id: 'delays', x: 6, w: 6, h: 4, type: 'richText', label: "Delays / Issues", autoPosition: true }
                    ]
                },
                {
                    id: 'crewList', cat: 'Production', label: 'Crew Contact List', icon: 'phone', default: true,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'contacts', x: 0, w: 12, h: 4, type: 'contacts', label: "Production Team", autoPosition: true },
                        { id: 'crew', x: 0, w: 12, h: 12, type: 'crew', label: "Department Heads & Crew", autoPosition: true }
                    ]
                },
                { id: 'transport', cat: 'Production', label: 'Transport Schedule', icon: 'mapPin', default: false },
                { id: 'continuity', cat: 'Production', label: 'Continuity/Sound Log', icon: 'film', default: false },
                { id: 'muahCont', cat: 'Production', label: 'Hair/Makeup Continuity', icon: 'user', default: false },
                { id: 'propList', cat: 'Production', label: 'Prop List', icon: 'hazard', default: false },
                { id: 'catering', cat: 'Production', label: 'Catering/Meal Tracker', icon: 'coffee', default: false },
                { id: 'pettyCash', cat: 'Production', label: 'Petty Cash Log', icon: 'money', default: false },
                { id: 'po', cat: 'Production', label: 'Purchase Order', icon: 'receipt', default: false },
                { id: 'timecard', cat: 'Production', label: 'Timecards', icon: 'history', default: false },
                { id: 'riskAI', cat: 'Production', label: 'AI Risk Assessment', icon: 'sparkle', default: false },
                { id: 'carbon', cat: 'Production', label: 'Carbon Calculator', icon: 'sparkle', default: false },

                // --- POST & LEGAL ---
                {
                    id: 'talentAgr', cat: 'Legal', label: 'Talent Agreement', icon: 'check', default: true,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'terms', x: 0, w: 12, h: 14, type: 'richText', label: "Contract Terms & Conditions", autoPosition: true }
                    ]
                },
                {
                    id: 'dealMemo', cat: 'Legal', label: 'Crew Deal Memo', icon: 'file', default: false,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'terms', x: 0, w: 12, h: 10, type: 'richText', label: "Terms of Agreement", autoPosition: true }
                    ]
                },
                {
                    id: 'permit', cat: 'Legal', label: 'Filming Permit', icon: 'file', default: false,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'details', x: 0, w: 12, h: 10, type: 'richText', label: "Permit Details", autoPosition: true }
                    ]
                },
                {
                    id: 'insurance', cat: 'Legal', label: 'Insurance Cert', icon: 'lock', default: false,
                    widgets: [
                        { id: 'meta_header', x: 0, w: 12, h: 2, type: 'header', autoPosition: true },
                        { id: 'details', x: 0, w: 12, h: 10, type: 'richText', label: "Coverage Details", autoPosition: true }
                    ]
                },
                { id: 'vfxBreak', cat: 'Post-Prod', label: 'VFX Breakdown', icon: 'hazard', default: false },
                { id: 'postSched', cat: 'Post-Prod', label: 'Post Schedule', icon: 'calendar', default: true },
                { id: 'delivery', cat: 'Post-Prod', label: 'Delivery Schedule', icon: 'folder', default: false },
                { id: 'festTrack', cat: 'Post-Prod', label: 'Festival Tracker', icon: 'sparkle', default: false },
                { id: 'locRel', cat: 'Legal', label: 'Location Release', icon: 'mapPin', default: true },
                { id: 'kitRental', cat: 'Legal', label: 'Kit Rental Agreement', icon: 'camera', default: false },
                { id: 'covid', cat: 'Legal', label: 'COVID Protocols', icon: 'hazard', default: false },
                { id: 'sag', cat: 'Legal', label: 'SAG-AFTRA Paperwork', icon: 'sparkle', default: false }
            ];
            this.templates.length = 0; 
            this.templates.push(...t);
        },

        // --- INTELLIGENT INGESTION ENGINE ---
        async ingest(items, type = 'rate') {
            let added = 0;
            
            // PATH A: Rate Ingestion
            if (type === 'rate') {
                const existing = new Set(this.rates.map(i => i.description.toLowerCase()));
                items.forEach(i => {
                    if (!existing.has(i.description.toLowerCase())) {
                        this.rates.push({ description: i.description, unit: i.unit || 'Day', rate: parseFloat(i.rate) || 0 });
                        added++;
                    }
                });
                if (added > 0) await this.saveRates();
            } 
            
            // PATH B: Contact Ingestion
            else if (type === 'contact') {
                const existing = new Set(this.contacts.map(c => `${c.name}|${c.role}`.toLowerCase()));
                items.forEach(i => {
                    // Normalize Inputs: Handles variations in CSV headers (case insensitive)
                    const name = (i.Name || i.name || '').trim();
                    const role = (i.Role || i.role || 'Crew').trim();
                    const phone = (i.Phone || i.phone || '').trim();
                    const email = (i.Email || i.email || '').trim();
                    const contactStr = phone || email; // Legacy fallback

                    if (!name) return; // Skip empty rows

                    const key = `${name}|${role}`.toLowerCase();
                    if (!existing.has(key)) {
                        this.contacts.push({
                            id: 'c_' + Date.now() + '_' + Math.floor(Math.random() * 1000),
                            name: name,
                            role: role,
                            phone: phone,
                            email: email,
                            contact: contactStr
                        });
                        existing.add(key);
                        added++;
                    }
                });
                if (added > 0) await this.saveContacts();
            }
            return added;
        },
        
        // --- NON-TRUNCATABLE JAMAICA 2025 DATABASE ---
        _getJamaicaDatabase() {
            return [
                { description: 'Storyboard Artist', unit: 'Day', rate: 45000 },
                { description: 'Copywriter (Pitch/Treatment)', unit: 'Flat', rate: 75000 },
                { description: 'Script Consultant / Doctor', unit: 'Flat', rate: 150000 },
                { description: 'Pitch Deck Designer', unit: 'Flat', rate: 120000 },
                { description: 'Researcher', unit: 'Day', rate: 25000 },
                { description: 'Concept Artist', unit: 'Day', rate: 40000 },
                { description: 'Legal - Rights & Clearances', unit: 'Flat', rate: 250000 },
                { description: 'Director', unit: 'Day', rate: 85000 },
                { description: 'Executive Producer', unit: 'Flat', rate: 500000 },
                { description: 'Producer', unit: 'Day', rate: 75000 },
                { description: 'Line Producer', unit: 'Day', rate: 65000 },
                { description: 'Screenwriter', unit: 'Flat', rate: 350000 },
                { description: 'Cast - Lead', unit: 'Day', rate: 100000 },
                { description: 'Cast - Supporting', unit: 'Day', rate: 50000 },
                { description: 'Stunt Coordinator', unit: 'Day', rate: 60000 },
                { description: 'Unit Production Manager (UPM)', unit: 'Day', rate: 60000 },
                { description: 'Production Coordinator', unit: 'Day', rate: 30000 },
                { description: '1st Assistant Director (1st AD)', unit: 'Day', rate: 65000 },
                { description: '2nd Assistant Director', unit: 'Day', rate: 45000 },
                { description: '2nd 2nd AD', unit: 'Day', rate: 25000 },
                { description: 'Key PA', unit: 'Day', rate: 20000 },
                { description: 'Set PA', unit: 'Day', rate: 15000 },
                { description: 'Office PA', unit: 'Day', rate: 15000 },
                { description: 'Truck PA', unit: 'Day', rate: 18000 },
                { description: 'Location Manager', unit: 'Day', rate: 50000 },
                { description: 'Location Scout', unit: 'Day', rate: 35000 },
                { description: 'Script Supervisor', unit: 'Day', rate: 40000 },
                { description: 'Medic / Set Nurse', unit: 'Day', rate: 35000 },
                { description: 'Security Guard', unit: 'Day', rate: 12000 },
                { description: 'Craft Service', unit: 'Day', rate: 25000 },
                { description: 'Catering (Per Head)', unit: 'Flat', rate: 2500 },
                { description: 'Director of Photography (DP)', unit: 'Day', rate: 90000 },
                { description: 'Camera Operator', unit: 'Day', rate: 60000 },
                { description: '1st Assistant Camera (Focus)', unit: 'Day', rate: 45000 },
                { description: '2nd Assistant Camera', unit: 'Day', rate: 35000 },
                { description: 'Digital Imaging Tech (DIT)', unit: 'Day', rate: 50000 },
                { description: 'Steadicam Operator', unit: 'Day', rate: 70000 },
                { description: 'Drone Operator', unit: 'Day', rate: 55000 },
                { description: 'Camera Utility', unit: 'Day', rate: 25000 },
                { description: 'Gaffer', unit: 'Day', rate: 55000 },
                { description: 'Best Boy Electric', unit: 'Day', rate: 40000 },
                { description: 'Electrician', unit: 'Day', rate: 30000 },
                { description: 'Key Grip', unit: 'Day', rate: 50000 },
                { description: 'Best Boy Grip', unit: 'Day', rate: 40000 },
                { description: 'Dolly Grip', unit: 'Day', rate: 40000 },
                { description: 'Grip', unit: 'Day', rate: 30000 },
                { description: 'Generator Operator', unit: 'Day', rate: 35000 },
                { description: 'Sound Mixer', unit: 'Day', rate: 50000 },
                { description: 'Boom Operator', unit: 'Day', rate: 35000 },
                { description: 'Sound Utility', unit: 'Day', rate: 25000 },
                { description: 'Production Designer', unit: 'Day', rate: 65000 },
                { description: 'Art Director', unit: 'Day', rate: 50000 },
                { description: 'Set Decorator', unit: 'Day', rate: 45000 },
                { description: 'Set Dresser', unit: 'Day', rate: 30000 },
                { description: 'Props Master', unit: 'Day', rate: 45000 },
                { description: 'Assistant Props', unit: 'Day', rate: 30000 },
                { description: 'Costume Designer', unit: 'Day', rate: 55000 },
                { description: 'Wardrobe Stylist', unit: 'Day', rate: 45000 },
                { description: 'Wardrobe Assistant', unit: 'Day', rate: 25000 },
                { description: 'Makeup Artist (Key)', unit: 'Day', rate: 45000 },
                { description: 'Hair Stylist (Key)', unit: 'Day', rate: 45000 },
                { description: 'Makeup/Hair Assistant', unit: 'Day', rate: 25000 },
                { description: 'Post-Production Supervisor', unit: 'Week', rate: 200000 },
                { description: 'Editor', unit: 'Day', rate: 50000 },
                { description: 'Assistant Editor (AE)', unit: 'Day', rate: 25000 },
                { description: 'Colorist', unit: 'Hour', rate: 15000 },
                { description: 'VFX Supervisor', unit: 'Day', rate: 70000 },
                { description: 'VFX Artist', unit: 'Day', rate: 55000 },
                { description: 'Sound Designer', unit: 'Flat', rate: 150000 },
                { description: 'Composer', unit: 'Flat', rate: 200000 },
                { description: 'Music Supervisor', unit: 'Flat', rate: 100000 }
            ];
        }
    };

    // --- 4. BACKWARD COMPATIBILITY ALIASES (The Bridge) ---
    // Logic Resolution: Ensures all existing calls in Tier 3-6 continue to function.
    window.mBTState = mBT.data.state;
    window.mBTStorage = mBT.data.storage;
    window.saveBudget = mBT.data.save.bind(mBT.data);
    window.loadBudget = mBT.data.load.bind(mBT.data);
    window.handleNewProject = mBT.data.newProject.bind(mBT.data);
    window.handleDuplicateProject = mBT.data.duplicate.bind(mBT.data);
    window.deleteProject = mBT.data.deleteProject.bind(mBT.data);
    window.handleImportFile = mBT.data.importFile.bind(mBT.data);
    window.getProjectList = mBT.data.getList.bind(mBT.data);
    window.pushToHistory = mBT.data.pushHistory.bind(mBT.data);
    
    // --- 5. Global Aliases for Migrated Globals ---
    window.mBTOG = mBT.opengate; // OPEN GATE Alias
    window.mBTDBM = mBT.data.templates; // Database Manager (Templates)
    
    /* ================= v19.54 TIER 3: Core Logic Engines ================= */

    // ... (Keep fetchExchangeRates and Mathematical Utilities) ...

    /* --- 3. Core Calculation Utilities (Restored) --- */
    // Logic Resolution: Essential math helpers required by the UI Render Engine.
    
    function toDisp(val) { return parseFloat(val) || 0; }

    function calculateItem(item) {
        const qty = parseFloat(item.quantity) || 0;
        const rate = parseFloat(item.rate) || 0;
        const mult = parseFloat(item.multiplier) || 1;
        const est = qty * rate * mult;
        const act = parseFloat(item.actual) || 0;
        return { estimated: est, variance: act - est };
    }

    function formatAbbreviated(value, currency = 'JMD') {
        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
        if (value >= 1000) return (value / 1000).toFixed(1) + 'k';
        if (typeof mBTLE !== 'undefined' && mBTLE.format) {
            return mBTLE.format.currency(value, currency);
        }
        return new Intl.NumberFormat('en-JM', { style: 'currency', currency: 'JMD' }).format(value);
    }

    /* ========= mBT.logic: CORE INTELLIGENCE (Math & Metrics) ========= */
    mBT.logic = {
        // ... (Keep existing math and stages) ...
        math: {
            config: {
                currencies: {
                    'JMD': { locale: 'en-JM', symbol: 'JMD$', rate: 1 },
                    'USD': { locale: 'en-US', symbol: '$', rate: 1 },
                    'GBP': { locale: 'en-GB', symbol: '', rate: 1 },
                    'CAD': { locale: 'en-CA', symbol: 'CA$', rate: 1 },
                    'EUR': { locale: 'de-DE', symbol: '', rate: 1 }
                }
            },
            format: {
                currency: function(value, code) {
                    const currencyCode = code || displayCurrency || 'JMD';
                    const cfg = mBT.logic.math.config.currencies[currencyCode] || mBT.logic.math.config.currencies['USD'];
                    return new Intl.NumberFormat(cfg.locale, {
                        style: 'currency', currency: currencyCode, currencyDisplay: 'narrowSymbol'
                    }).format(value);
                }
            },
            validate: {
                item: function(item) {
                    item.quantity = Math.max(0, parseFloat(item.quantity) || 0);
                    item.rate = Math.max(0, parseFloat(item.rate) || 0);
                    item.multiplier = Math.max(1, parseFloat(item.multiplier) || 1);
                    return item;
                }
            },
            reconcile: function(target) {
                // Deficiency 3 Fix: Pure Logic Only. NO DOM MANIPULATION.
                // Logic Resolution: Now accepts optional 'target' for Shadow Budgeting (Simulations)
                const b = target || budget;
                
                if (!b || !b.sections) return;
                let subtotal = 0; let grandActual = 0;

                Object.keys(b.sections).forEach(sectionKey => {
                    let sectionEstTotal = 0;
                    const section = b.sections[sectionKey];
                    section.items.forEach(item => {
                        this.validate.item(item);

                        // --- LOGIC INJECTION: Stage Aggregation ---
                        if (item.stageData && Object.keys(item.stageData).length > 0) {
                            let stageSumCost = 0;
                            let stageSumDays = 0;
                            Object.values(item.stageData).forEach(d => {
                                const dDays = parseFloat(d.days) || 0;
                                const dRate = parseFloat(d.rate) || 0;
                                stageSumCost += (dDays * dRate);
                                stageSumDays += dDays;
                            });
                            
                            item.quantity = stageSumDays;
                            item.total = stageSumCost;
                            item.rate = stageSumDays > 0 ? (stageSumCost / stageSumDays) : 0;
                            if(stageSumDays > 0) item.unit = 'Day'; 
                        } else {
                            const calc = calculateItem(item);
                            item.total = calc.estimated;
                        }

                        sectionEstTotal += item.total;
                        grandActual += parseFloat(item.actual) || 0;
                    });
                    section.total = sectionEstTotal;
                    subtotal += sectionEstTotal;
                });

                const contingency = subtotal * ((b.contingencyPercentage || 0) / 100);
                const tax = subtotal * ((b.salesTaxPercentage || 0) / 100);
                const preDiscount = subtotal + contingency + tax;
                const discount = preDiscount * ((b.discountPercentage || 0) / 100);
                
                b.subtotal = subtotal;
                b.grandTotal = preDiscount - discount;
                b.actualTotal = grandActual;
            },
            
            // --- Phase 9: AI Simulation Engine (Neural Risk Mitigation) ---
            simulate: function(modifications) {
                if (!budget) return null;
                
                // 1. Create Shadow Budget (Deep Clone to prevent Mutation)
                const shadow = JSON.parse(JSON.stringify(budget));
                
                // 2. Apply Deltas
                // Supports generic callback for complex AI logic logic
                if (typeof modifications === 'function') {
                    modifications(shadow);
                } 
                // Supports structured array from Cortex: [{ id, field, value }, ...]
                else if (Array.isArray(modifications)) {
                    const findItem = (id) => {
                        for (const sec of Object.values(shadow.sections)) {
                            const found = sec.items.find(i => i.id === id);
                            if (found) return found;
                        }
                        return null;
                    };
                    
                    modifications.forEach(mod => {
                        if (mod.id) {
                            const item = findItem(mod.id);
                            if (item && mod.field) item[mod.field] = mod.value;
                        } else if (mod.globalRateAdj) {
                            Object.values(shadow.sections).forEach(s => s.items.forEach(i => i.rate *= (1 + mod.globalRateAdj)));
                        }
                    });
                }

                // 3. Reconcile Shadow State
                this.reconcile(shadow);

                // 4. Return Financial Impact
                return {
                    original: budget.grandTotal,
                    simulated: shadow.grandTotal,
                    delta: shadow.grandTotal - budget.grandTotal,
                    percentChange: ((shadow.grandTotal - budget.grandTotal) / budget.grandTotal) * 100
                };
            }
        },

        // --- 2. Stage Metrics (Previously mBTStagesEngine) ---
        stages: {
            // Returns { grandTotal, stageTotals: {dev: $, ...}, totalCap: $, dailyBurn: $, runwayDays: # }
            calculateMetrics: function() {
                const tl = budget.targetLock || { totalCap: 0, stages: {} };
                const result = {
                    grandTotal: 0,
                    stageTotals: { dev: 0, pre: 0, prod: 0, post: 0, dist: 0 },
                    totalCap: tl.totalCap || 0,
                    totalDays: 0,
                    dailyBurn: 0,
                    runwayDays: 0
                };

                // 1. Calculate Costs
                Object.values(budget.sections).forEach(sec => {
                    sec.items.forEach(item => {
                        const qty = parseFloat(item.quantity) || 0;
                        const rate = parseFloat(item.rate) || 0;
                        const est = parseFloat(item.total) || (qty * rate * (parseFloat(item.multiplier) || 1));
                        const act = parseFloat(item.actual) || 0;
                        
                        wsData.push([
                            "", 
                            item.description, 
                            qty, 
                            item.unit, 
                            rate, 
                            est, 
                            act, 
                            act - est
                        ]);
                    });
                });

                // 2. Calculate Burn Logic
                const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
                validKeys.forEach(k => {
                    if (tl.stages && tl.stages[k]) {
                        result.totalDays += (parseFloat(tl.stages[k].days) || 0);
                    }
                });
                
                if (result.totalDays > 0) result.dailyBurn = result.grandTotal / result.totalDays;
                if (result.dailyBurn > 0) result.runwayDays = result.totalCap / result.dailyBurn;

                return result;
            },

            // Alias for Tier 5 compatibility
            getMetrics: function() { return this.calculateMetrics(); },

            // Returns Status Object for Ring/Bars
            getBurnStatus: function(current, cap) {
                const pct = cap > 0 ? (current / cap) * 100 : 0;
                if (pct > 100) return { color: 'text-red-600', bg: 'bg-red-500', ring: 'border-red-200', pct };
                if (pct > 85) return { color: 'text-yellow-600', bg: 'bg-blue-500', ring: 'border-yellow-200', pct }; 
                return { color: 'text-green-600', bg: 'bg-green-500', ring: 'border-green-200', pct };
            },

            // --- TIER 3 UPGRADE: Timeline Validation Logic (Restored) ---
            validateTimeline: function(stageKey) {
                let maxItemDays = 0;
                let hasItems = false;
                
                // 1. Scan the physics model for the longest item in this stage
                if (budget && budget.sections) {
                    Object.values(budget.sections).forEach(sec => {
                        sec.items.forEach(item => {
                            if (item.stageData && item.stageData[stageKey]) {
                                hasItems = true;
                                const d = parseFloat(item.stageData[stageKey].days) || 0;
                                if (d > maxItemDays) maxItemDays = d;
                            }
                        });
                    });
                }

                // 2. Compare against the "Governor" (User Input)
                const userDays = (budget.targetLock && budget.targetLock.stages[stageKey]) 
                    ? (parseFloat(budget.targetLock.stages[stageKey].days) || 0) 
                    : 0;

                // 3. Return Truth
                return {
                    isValid: userDays >= maxItemDays, // Safe if User Input >= Max Item
                    maxNeeded: maxItemDays,
                    current: userDays,
                    delta: userDays - maxItemDays,     // Negative value indicates shortage
                    isBankrupt: hasItems && userDays === 0 // Logic Resolution: Items exist but no time allocated
                };
            },

            // --- TIER 3 UPGRADE: Temporal Projection Engine (Phase 1 + 3.3 Overrun Logic) ---
            calculateTimeline: function() {
                const timeline = {};
                // Default to today if start date is missing
                let cursor = new Date(budget.startDate || new Date());
                // Handle Timezone offset for pure dates (prevent "yesterday" bugs)
                cursor = new Date(cursor.getTime() + cursor.getTimezoneOffset() * 60000);

                const stages = ['dev', 'pre', 'prod', 'post', 'dist'];
                
                stages.forEach(k => {
                    const days = (budget.targetLock && budget.targetLock.stages[k]) 
                        ? (parseFloat(budget.targetLock.stages[k].days) || 0) 
                        : 0;
                    
                    const start = new Date(cursor);
                    // Add days (milliseconds)
                    const end = new Date(start.getTime() + (days * 24 * 60 * 60 * 1000));
                    
                    // Format: "Jan 1 - Jan 15"
                    const fmt = d => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    timeline[k] = {
                        start: start,
                        end: end,
                        // If 0 days, show TBD, otherwise show range
                        label: days > 0 ? `${fmt(start)} - ${fmt(end)}` : 'SCHEDULE TBD'
                    };
                    
                    // Move cursor to end of this stage for next stage start
                    cursor = end;
                });

                // --- Phase 3.3: Overrun Calculation ---
                if (budget.deliveryDate) {
                    const target = new Date(budget.deliveryDate);
                    // Normalize target timezone to match cursor
                    const targetAdj = new Date(target.getTime() + target.getTimezoneOffset() * 60000);
                    
                    // Diff in days (Target Date - Projected End Date)
                    const diffTime = targetAdj - cursor; 
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    let status = 'On Track';
                    let statusColor = 'text-emerald-500';
                    let ringColor = 'border-slate-100'; // Default Gray Ring
                    
                    if (diffDays < 0) {
                        status = 'OVERDUE';
                        statusColor = 'text-rose-600';
                        ringColor = 'border-rose-500'; // Red Ring Trigger
                    } else if (diffDays < 7) {
                        status = 'Tight';
                        statusColor = 'text-amber-500';
                        ringColor = 'border-amber-400'; // Amber Ring Trigger
                    }

                    // Attach analysis to the timeline object for UI consumption
                    timeline._analysis = {
                        projectedEnd: cursor,
                        targetDate: targetAdj,
                        variance: diffDays,
                        status: status,
                        color: statusColor,
                        ring: ringColor
                    };
                }

                return timeline;
            },

            // --- TIER 5 UPGRADE: Phase 3.4 Risk Analyst (The Brain) ---
            analyzeRisk: function(metrics, timeline) {
                // 1. Daily Burn Rate (Cash per Day)
                // Use totalDays calculated in metrics (sum of all stage durations)
                const dailyBurn = metrics.totalDays > 0 ? (metrics.grandTotal / metrics.totalDays) : 0;
                
                // 2. Variance (Days Late) from Timeline
                // timeline._analysis might be undefined if no deadline set
                const variance = (timeline && timeline._analysis) ? timeline._analysis.variance : 0;
                
                // If early or on time (variance >= 0), no financial risk from time
                if (variance >= 0) return null;

                // 3. Cost of Delay (Daily Burn * Days Late)
                const daysLate = Math.abs(variance);
                const delayCost = dailyBurn * daysLate;
                
                // 4. Projected Total (Current Estimated + Cost of Delay)
                const projectedTotal = metrics.grandTotal + delayCost;
                
                // 5. The "Crash" Check
                // Do we have enough Cap Room to absorb this delay?
                const cap = metrics.totalCap || 0;
                const isCritical = cap > 0 && projectedTotal > cap;

                return {
                    status: isCritical ? 'CRITICAL' : 'WARNING',
                    daysLate: daysLate,
                    dailyBurn: dailyBurn,
                    cost: delayCost,
                    projectedTotal: projectedTotal,
                    message: isCritical ? "INSOLVENCY RISK" : "DELAY COST",
                    subMessage: isCritical 
                        ? `Projected ${mBT.logic.math.format.currency(projectedTotal)} exceeds Cap` 
                        : `Est. Penalty: ${mBT.logic.math.format.currency(delayCost)}`
                };
            }
        }
    };
    
    // --- Tier 5 Handshake Polyfill ---
    mBT.utils = { formatCurrency: mBT.logic.math.format.currency };

    // --- Aliases for Backward Compatibility ---
    window.mBTLE = mBT.logic.math;
    window.mBTStagesEngine = mBT.logic.stages;

    /* --- 2. Logic Bridges & Data Normalization --- */
    function recalculateTemplateQuantities(data) {
        if (!data.days) return;
        const { principal, scouting, preprod } = data.days;
        const totalDays = (parseFloat(principal) || 0) + (parseFloat(scouting) || 0) + (parseFloat(preprod) || 0);
        Object.values(data.sections).forEach(section => {
            section.items.forEach(item => { if (item.unit === 'Day') item.quantity = totalDays; });
        });
    }

    // Logic Resolution: Core budget item updater (Restored)
    function handleUpdate(sectionName, itemId, field, value, context) {
        const section = budget.sections[sectionName];
        if (!section) return;
        const item = section.items.find(i => i.id === itemId);
        if (!item) return;

        if (field === 'description') item.description = value;
        else if (field === 'quantity') item.quantity = parseFloat(value) || 0;
        else if (field === 'rate') item.rate = parseFloat(value) || 0;
        else if (field === 'unit') item.unit = value;
        else if (field === 'actual') item.actual = parseFloat(value) || 0;

        // Deficiency 1 Fix: Single-Source of Truth
        // We rely on the Proxy (Tier 2) to trigger Global Math & Persistence (debounced).
        // We ONLY call paint() here for instant, non-blocking visual feedback on the active row.
        if (typeof mBT.ui.paint === 'function') {
            requestAnimationFrame(() => mBT.ui.paint());
        }
    }

    function balanceStageSliders(changedKey, newValue) {
        const stages = budget.targetLock.stages;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        
        newValue = parseFloat(newValue);
        if (isNaN(newValue)) newValue = 0;
        
        const lockedKeys = validKeys.filter(k => k !== changedKey && stages[k].locked);
        const unlockedKeys = validKeys.filter(k => k !== changedKey && !stages[k].locked);
        
        const lockedTotal = lockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
        const maxAvailable = 100 - lockedTotal;
        
        if (newValue > maxAvailable) newValue = maxAvailable;
        if (newValue < 0) newValue = 0;
        
        stages[changedKey].ratio = newValue;
        
        const remaining = Math.max(0, 100 - newValue - lockedTotal);
        
        if (unlockedKeys.length > 0) {
            const currentUnlockedTotal = unlockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
            unlockedKeys.forEach(k => {
                let newRatio;
                if (currentUnlockedTotal <= 0.01) {
                    newRatio = remaining / unlockedKeys.length;
                } else {
                    const share = stages[k].ratio / currentUnlockedTotal;
                    newRatio = remaining * share;
                }
                stages[k].ratio = newRatio;
            });
        }
    }

    // Preset Handler
    window.applyStagePreset = function(presetName) {
        const ratios = STAGE_PRESETS[presetName];
        if (!ratios) return;
        Object.keys(ratios).forEach(k => {
            if (budget.targetLock.stages[k]) {
                budget.targetLock.stages[k].ratio = ratios[k];
                budget.targetLock.stages[k].locked = false;
            }
        });
        if(typeof window.updateAllHeaders === 'function') window.updateAllHeaders();
        if(typeof pushToHistory === 'function') pushToHistory(`Applied ${presetName} preset`);
    };

    const mBTAssign = {
        assignFromContacts() {
            const contacts = (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG.contacts || []));
            if (!contacts.length) return { assigned: 0, message: 'No records found' };
            let assigned = 0;
            Object.values(budget.sections).forEach(s => s.items.forEach(i => {
                if (i.crew?.name) return;
                const match = contacts.find(c => c.role && i.description.toLowerCase().includes(c.role.toLowerCase()));
                if (match) { 
                    i.crew = { name: match.name, phone: match.contact?.includes('@') ? '' : match.contact, email: match.contact?.includes('@') ? match.contact : '' }; 
                    assigned++; 
                }
            }));
            if (assigned > 0) {
                mBTLE.reconcile();
                // Logic Resolution: Auto-Assign modifies complex DOM (Avatars) that Paint() skips.
                // We must trigger a full structural refresh here.
                render(); 
            }
            return { assigned, message: `${assigned} personnel synchronized` };
        }
    };

/* ========= v19.54 CONNECTIVE TISSUE: Logic Resolution Utilities ========= */

    // NOTE: Project Inventory, Data Hydration, and History functions 
    // have been consolidated into mBT.data (Tier 2). 
    // Global aliases maintain compatibility.

    /* --- 3. Configuration & System Utilities (Restored) --- */
    // Logic Resolution: Helpers for global settings accessed by mBT.features.settings
    function getProjectDateFormat() { return localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD'; }
    function getProjectNameSeparator() { return localStorage.getItem(projectNameSeparatorKey) || ' '; }
    function hardResetApp() { 
        mBTME.confirm("Factory Reset", "This will clear all local data and reload. Continue?", () => {
            localStorage.clear(); 
            window.location.reload(); 
        });
    }

    /* --- 4. Neural Link Bridge (AI API Utilities) --- */
    mBT.features.ai = {
        // Configuration Defaults
        config: {
            // Logic Resolution: Updated to the official production model.
            geminiModel: "gemini-2.5-flash", 
            openAiModel: "gpt-4o-mini",
            deepSeekModel: "deepseek-chat",
            grokModel: "grok-beta",
            // Logic Resolution: Extremely strict prompt to eliminate "yapping" and force data-first output.
            systemContext: "ROLE: Strict Budget Auditor. MO: Brutal efficiency. No intro/outro fluff. No philosophical advice. OUTPUT: Markdown bullet points only. Start immediately with facts. CONTEXT: Film Production, Jamaica 2025 rates."
        },

        // Storage Accessors
        getStoredApiKey: (provider) => localStorage.getItem(`${storageKeyPrefix}${provider}ApiKey`) || '',
        saveStoredApiKey: (provider, key) => localStorage.setItem(`${storageKeyPrefix}${provider}ApiKey`, key),
        getSelectedProvider: () => localStorage.getItem(`${storageKeyPrefix}selectedAiProvider`) || 'gemini',
        getSystemPrompt: () => localStorage.getItem(`${storageKeyPrefix}aiSystemPrompt`) || '',
        saveSystemPrompt: (val) => localStorage.setItem(`${storageKeyPrefix}aiSystemPrompt`, val),
        
        /**
         * Centralized Intelligence Dispatcher
         * Handles routing to specific providers (Gemini/OpenAI/DeepSeek/Grok) and standardizes the response.
         */
        callUnifiedAI: async function(provider, apiKey, prompt, customSystemMsg = "") {
            // Logic Resolution: Combine base strictness with user-defined constraints
            const userConstraints = this.getSystemPrompt();
            const baseInstruction = customSystemMsg || this.config.systemContext;
            const systemInstruction = userConstraints ? `${baseInstruction} USER CONSTRAINTS: ${userConstraints}` : baseInstruction;

            try {
                // 1. Google Gemini Strategy
                if (provider === 'gemini') {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${this.config.geminiModel}:generateContent?key=${apiKey}`;
                    
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    };

                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(`Gemini Error ${response.status}: ${err.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Assistant: No analysis generated.";
                } 
                
                // 2. OpenAI Compatible Strategy (OpenAI, DeepSeek, Grok)
                else {
                    let url, model;
                    
                    if (provider === 'openai') {
                        url = 'https://api.openai.com/v1/chat/completions';
                        model = this.config.openAiModel;
                    } else if (provider === 'deepseek') {
                        url = 'https://api.deepseek.com/chat/completions';
                        model = this.config.deepSeekModel;
                    } else if (provider === 'grok') {
                        url = 'https://api.x.ai/v1/chat/completions';
                        model = this.config.grokModel;
                    } else {
                        throw new Error(`Provider '${provider}' not supported.`);
                    }

                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [
                                { role: "system", content: systemInstruction },
                                { role: "user", content: prompt }
                            ]
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(`${provider.toUpperCase()} Error ${response.status}: ${err.error?.message || response.statusText}`);
                    }

                    const data = await response.json();
                    return data.choices?.[0]?.message?.content || "Assistant: No analysis generated.";
                }

            } catch (error) {
                console.error("mBT AI Failure:", error);
                return `Analysis Failed: ${error.message}`;
            }
        },

        // Helper: Quick analysis of current budget state (Budget Analysis)
        analyzeCurrentBudget: async function() {
            const provider = this.getSelectedProvider();
            const apiKey = this.getStoredApiKey(provider);
            
            if(!apiKey) return mBTME.alert("Assistant Offline", "Please configure API Key in settings.");
            
            // Logic Resolution: Enhanced Context Gathering (Broad Access)
            // Includes budget numbers, active documents, attached files, and crew status.
            const context = {
                project: budget.projectName,
                total: budget.grandTotal,
                currency: displayCurrency,
                sections: Object.keys(budget.sections).map(k => ({
                    name: k,
                    total: budget.sections[k].total,
                    itemCount: budget.sections[k].items.length
                })),
                documents: (budget.documents || []).map(d => ({ type: d.type, label: d.label })),
                attachments: (budget.attachments || []).map(a => a.name),
                crewSummary: Object.values(budget.sections).reduce((acc, sec) => acc + sec.items.filter(i => i.crew?.name).length, 0) + " assigned",
                previousAnalysis: (budget.aiContext?.analysis || "").substring(0, 1000) // Feedback loop: Awareness of past diagnosis
            };

            const prompt = `Analyze this budget data: ${JSON.stringify(context)}. Review financials, logistics (documents), and staffing. Identify 3 risks and 3 savings opportunities. Be concise.`;
            
            if(mBTME.showLoader) mBTME.showLoader("Neural Analysis in progress...");
            
            const result = await this.callUnifiedAI(provider, apiKey, prompt);
            
            if(mBTME.hideLoader) mBTME.hideLoader();
            
            // Logic Resolution: Save analysis to state so Chat can reference it later
            if(!budget.aiContext) budget.aiContext = { chat: [], analysis: "" };
            budget.aiContext.analysis = result;
            saveBudget();

            // Logic Resolution: Render Markdown properly using 'marked' library
            const formattedResult = (typeof marked !== 'undefined') ? marked.parse(result) : result;
            
            // Logic Resolution: UI Renamed to 'Budget Analysis'
            mBTME.open('aiAnalysis', 'Budget Analysis', `
                <div class="p-6 text-sm leading-relaxed text-slate-700 max-h-[60vh] overflow-y-auto prose prose-sm prose-slate max-w-none">
                    ${formattedResult}
                </div>`, 'max-w-2xl');
        },

        // --- Context Management Utilities ---
        clearContext: function() {
            mBTME.confirm("Clear Memory", "Clear AI memory and chat history? This cannot be undone.", () => {
                budget.aiContext = { chat: [], analysis: "" };
                saveBudget();
                // Refresh the chat view if open
                const history = document.getElementById('aiChatHistory');
                if(history) history.innerHTML = '<div class="text-center text-slate-400 text-xs mt-10">Memory Cleared. Start fresh.</div>';
                const count = document.getElementById('aiMsgCount');
                if(count) count.textContent = "Context: 0 msgs";
            });
        },

        exportChat: function() {
            if(!budget.aiContext?.chat?.length) return mBTME.alert("Export Error", "No chat history to export.");
            const text = budget.aiContext.chat.map(m => `[${m.role.toUpperCase()}]: ${m.content}`).join('\n\n-------------------\n\n');
            const blob = new Blob([text], { type: 'text/plain' });
            if(typeof mBTPublisher !== 'undefined' && mBTPublisher.io) {
                mBTPublisher.io.forceDownload(blob, `${budget.projectName}_AI_Chat.txt`);
            }
        },

        // Logic Resolution: Restored Chat Interface (Assistant)
        openChat: function() {
            if (!budget.aiContext) budget.aiContext = { chat: [], analysis: "" };
            
            const renderMessages = () => {
                return budget.aiContext.chat.map(msg => {
                    // Logic Resolution: Parse Markdown for AI, strict escape for User
                    const contentHtml = msg.role === 'assistant' 
                        ? (typeof marked !== 'undefined' ? marked.parse(msg.content) : msg.content)
                        : mBT.ui.render.esc(msg.content);
                        
                    return `
                    <div class="ai-message ${msg.role} mb-4 p-3 rounded-lg ${msg.role === 'user' ? 'bg-blue-50 ml-8 text-right' : 'bg-white border border-slate-100 mr-8'}">
                        <strong class="block text-[9px] uppercase tracking-widest text-slate-400 mb-1">${msg.role === 'user' ? 'You' : 'Assistant'}</strong>
                        <div class="text-xs leading-relaxed text-slate-700 prose prose-sm max-w-none ${msg.role === 'user' ? '' : 'prose-headings:text-slate-800 prose-strong:text-slate-900'}">${contentHtml}</div>
                    </div>`;
                }).join('');
            };

            const content = `
                <div class="flex flex-col h-[500px] bg-slate-50">
                    <!-- Chat Toolbar -->
                    <div class="flex justify-between items-center px-4 py-2 bg-white border-b border-slate-100 shrink-0">
                        <span id="aiMsgCount" class="text-[9px] font-black uppercase tracking-widest text-slate-400">Context: ${budget.aiContext.chat.length} msgs</span>
                        <div class="flex gap-2">
                            <button onclick="mBT.features.ai.exportChat()" title="Export Discussion" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all">${mBTAssets.file}</button>
                            <button onclick="mBT.features.ai.clearContext()" title="Clear Memory" class="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all">${mBTAssets.trash}</button>
                        </div>
                    </div>
                    
                    <div id="aiChatHistory" class="flex-grow overflow-y-auto p-4 space-y-2">
                        ${budget.aiContext.chat.length ? renderMessages() : '<div class="text-center text-slate-400 text-xs mt-10">Start a conversation...</div>'}
                    </div>
                    
                    <div class="p-3 bg-white border-t border-slate-100 flex gap-2 shrink-0">
                        <input type="text" id="aiChatInput" class="flex-grow p-3 bg-slate-50 border-none rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-blue-100 transition-all" placeholder="Ask about rates, logistics, or risks..." onkeydown="if(event.key==='Enter') document.getElementById('aiChatSendBtn').click()">
                        <button id="aiChatSendBtn" class="p-3 bg-blue-600 text-white rounded-xl shadow-lg hover:bg-blue-500 transition-all w-12 flex items-center justify-center shrink-0">
                            ${mBTAssets.paperPlane || '->'} 
                        </button>
                    </div>
                </div>`;

            mBTME.open('aiChat', 'Discussions', content, 'max-w-lg', { noPadding: true });

            // Scroll to bottom
            const historyEl = document.getElementById('aiChatHistory');
            if(historyEl) setTimeout(() => historyEl.scrollTop = historyEl.scrollHeight, 10);

            // Attach listener
            setTimeout(() => {
                const btn = document.getElementById('aiChatSendBtn');
                const input = document.getElementById('aiChatInput');
                if(btn && input) {
                    btn.onclick = async () => {
                        const text = input.value.trim();
                        if(!text) return;
                        
                        // Add User Msg
                        budget.aiContext.chat.push({ role: 'user', content: text });
                        saveBudget();
                        input.value = '';
                        
                        // Re-render immediate
                        const history = document.getElementById('aiChatHistory');
                        history.innerHTML = renderMessages() + `<div class="ai-message assistant animate-pulse p-3 bg-white border border-slate-100 mr-8 rounded-lg"><div class="text-xs text-slate-400">Analyzing...</div></div>`;
                        history.scrollTop = history.scrollHeight;
                        
                        const count = document.getElementById('aiMsgCount');
                        if(count) count.textContent = `Context: ${budget.aiContext.chat.length} msgs`;

                        // Call AI
                        const provider = this.getSelectedProvider();
                        const apiKey = this.getStoredApiKey(provider);
                        
                        if(!apiKey) {
                            history.lastElementChild.innerHTML = "<div class='text-rose-500 text-xs'>Error: API Key missing. Check Settings.</div>";
                            return;
                        }

                        // Context Injection: Add rich context including docs, attachments, and previous analysis
                        const docList = (budget.documents || []).map(d => d.label).join(', ');
                        const attachList = (budget.attachments || []).map(a => a.name).join(', ');
                        const prevAnalysis = (budget.aiContext.analysis || "None").substring(0, 500); // Truncate to save tokens
                        
                        // Construct hidden System Context
                        const contextSummary = `[SYSTEM CONTEXT: Project="${budget.projectName}", Total=${displayCurrency} ${budget.grandTotal}, Docs=[${docList}], Attachments=[${attachList}], Last Analysis Summary="${prevAnalysis}"]`;
                        
                        // Only inject context if it's the start of a conversation to save tokens later
                        const finalPrompt = budget.aiContext.chat.length < 2 ? `${contextSummary} \n\n User Query: ${text}` : text;

                        const response = await this.callUnifiedAI(provider, apiKey, finalPrompt);
                        
                        // Update with response
                        budget.aiContext.chat.push({ role: 'assistant', content: response });
                        saveBudget();
                        history.innerHTML = renderMessages();
                        history.scrollTop = history.scrollHeight;
                        if(count) count.textContent = `Context: ${budget.aiContext.chat.length} msgs`;
                    };
                    input.focus();
                }
            }, 50);
        },

        // Logic Resolution: Restored UI Menu for the Dashboard Button
        openTools: function() {
             const provider = this.getSelectedProvider();
            const apiKey = this.getStoredApiKey(provider);
            const statusColor = apiKey ? 'text-emerald-500' : 'text-rose-500';
            const statusText = apiKey ? 'Online' : 'Offline';

            const content = `
                <div class="grid grid-cols-2 gap-4 p-4">
                    <button onclick="mBT.features.ai.analyzeCurrentBudget(); mBTME.close('aiToolsModal');" class="p-4 bg-indigo-50 border border-indigo-200 rounded-2xl flex flex-col items-center gap-2 hover:bg-indigo-100 transition-all group">
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-indigo-500 group-hover:scale-110 transition-all">${mBTAssets.doctor}</div>
                        <div class="text-center">
                            <h4 class="font-black text-[10px] uppercase tracking-widest text-slate-700">Budget Analysis</h4>
                            <p class="text-[8px] text-slate-400 font-bold">Deep Scan</p>
                        </div>
                    </button>

                    <button onclick="mBT.features.ai.openChat(); mBTME.close('aiToolsModal');" class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl flex flex-col items-center gap-2 hover:bg-emerald-100 transition-all group">
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center text-emerald-500 group-hover:scale-110 transition-all">${mBTAssets.chat}</div>
                        <div class="text-center">
                            <h4 class="font-black text-[10px] uppercase tracking-widest text-slate-700">Discussions</h4>
                            <p class="text-[8px] text-slate-400 font-bold">Chat & Consult</p>
                        </div>
                    </button>
                </div>
                
                <div class="px-4 pb-4">
                    <button onclick="showSettingsModal('ai'); mBTME.close('aiToolsModal');" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl flex items-center justify-between hover:bg-white transition-all group">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-white rounded-full shadow-sm flex items-center justify-center text-slate-400">${mBTAssets.gear}</div>
                            <div class="text-left">
                                <h4 class="font-black text-[9px] uppercase tracking-widest text-slate-700">Configuration</h4>
                                <p class="text-[8px] font-bold ${statusColor} mt-0.5">${statusText}</p>
                            </div>
                        </div>
                        <span class="text-slate-300 group-hover:text-blue-500"></span>
                    </button>
                </div>`;
            
            mBTME.open('aiTools', 'Assistant', content, 'max-w-sm');
        }
    };

    // Logic Resolution: Global Aliases for Backward Compatibility (Preserves Tier 5 Settings UI)
    // Note: Bind 'this' to ensure internal config access works when called globally
    const getStoredApiKey = mBT.features.ai.getStoredApiKey.bind(mBT.features.ai);
    const saveStoredApiKey = mBT.features.ai.saveStoredApiKey.bind(mBT.features.ai);
    const getSelectedProvider = mBT.features.ai.getSelectedProvider.bind(mBT.features.ai);
    const callUnifiedAI = mBT.features.ai.callUnifiedAI.bind(mBT.features.ai);
    // Logic Resolution: Restore global access for the main dashboard button
    window.showAIToolsModal = mBT.features.ai.openTools.bind(mBT.features.ai);

// Logic Resolution: Handles renaming projects.
    function handleProjectNameChange(e) {
        const newName = e.target.value.trim();
        if(!newName) return;
        const oldKey = storageKeyPrefix + budget.projectName;
        const newKey = storageKeyPrefix + newName;
        if(localStorage.getItem(newKey)) {
            mBTME.alert("Naming Error", "Project name already exists.");
            e.target.value = budget.projectName;
            return;
        }
        localStorage.removeItem(oldKey);
        budget.projectName = newName;
        saveBudget();
        currentProjectName = newName;
    }


/* ========= v19.54 TIER 4: Atomic Render Pipeline ========= */

    // ... (keep getAbbreviatedName function) ...

    /* --- 3. UI Namespace Consolidation --- */
    // Logic Resolution: Moving all UI logic under one roof.

    // 1. Viewport Manager (Mobile Zoom Control)
    mBT.ui.updateViewport = function() {
        const allow = budget?.settings?.allowZoom || false;
        const meta = document.querySelector('meta[name="viewport"]');
        if (meta) {
            // Toggles between locked (app-like) and unlocked (accessible) states
            meta.content = `width=device-width, initial-scale=1.0, viewport-fit=cover${allow ? '' : ', maximum-scale=1.0, user-scalable=no'}`;
        }
    };

    // 2. The Main Render Loop (The Gatekeeper)
    mBT.ui.refresh = function() {
        const app = document.getElementById('app');
        if (!budget || !app) return;

        // Deficiency Fix: Theme Toggle Latency
        // Updated: Standardized on Slate-200 (#e2e8f0) for improved production environment contrast.
        const isClassic = budget.settings?.classicTheme || false;
        app.className = `max-w-7xl mx-auto px-4 py-8 ${isClassic ? 'classic-theme' : ''}`;
        if(isClassic) document.body.style.backgroundColor = "#e5e5e5";
        else document.body.style.backgroundColor = "#e2e8f0";
        
        // A. Smart Detection: Does the shell exist?
        const shellExists = document.getElementById('projectName') && document.getElementById('budget-sections');
        
        if (!shellExists) {
            // Path 1: Full Rebuild (Initial Load / Hard Reset)
            this._fullRender(app);
        } else {
            // Path 2: Surgical Update
            
            // Sub-check: Has the structure changed? (Row count mismatch)
            // This allows us to handle "Add Item" without a full app flash, but keeps typing fast.
            let dataCount = 0;
            Object.values(budget.sections).forEach(s => dataCount += s.items.length);
            const domCount = document.querySelectorAll('.draggable-row').length;

            if (dataCount !== domCount) {
                // Structural Mismatch: Rebuild only the list container
                const sectionContainer = document.getElementById('budget-sections');
                if(sectionContainer) sectionContainer.innerHTML = renderBudgetSections();
                
                // Re-bind specific list listeners
                if (typeof initializeDragAndDrop === 'function') initializeDragAndDrop();
            }

            // Always Paint values (covers typing, calculations, and the new rows)
            this.paint();
        }
        
        // B. Auxiliary Interface Updates (Top Level)
        if (typeof renderProjectManagement === 'function') renderProjectManagement();
        if (typeof renderStatusBar === 'function') renderStatusBar();
        if (typeof updateOnlineStatus === 'function') updateOnlineStatus(); 
        
        // C. Focus Restoration (Legacy support for structural updates)
        // Note: Paint() handles this natively, but we keep this for the list-rebuild path.
        const active = document.activeElement;
        if (active && active.id) {
            const el = document.getElementById(active.id);
            if (el) {
                // Only refocus if we lost it (e.g. element was recreated)
                if (document.activeElement !== el) el.focus();
            }
        }
    };

    // New Internal Method: Heavy HTML Generation (The Builder)
    mBT.ui._fullRender = function(app) {
        // Logic Resolution: Container styling moved to mBT.ui.refresh() for instant toggling.
        // app.className and body background are now managed upstream.

        app.innerHTML = `
        <header class="mb-6 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto flex-grow">
                <input type="text" id="projectName" value="${budget.projectName}" class="text-2xl sm:text-4xl font-black uppercase text-slate-900 bg-transparent min-w-0 flex-grow focus:outline-none focus:bg-white p-3 rounded-2xl transition-all tracking-tighter" />
                <button id="loginBtn" class="w-12 h-12 rounded-full border-2 flex items-center justify-center transition-all shadow-xl flex-shrink-0 active:scale-90"></button>
            </div>
            <div id="project-management-container" class="w-full md:w-auto flex-shrink-0"></div>
        </header>

        <div class="flex gap-2 items-center mb-6">
            <button id="openAiToolsBtn" class="p-3 bg-indigo-600 text-white rounded-2xl shadow-lg transition-all hover:bg-indigo-700 active:scale-95 flex items-center justify-center">
                ${mBTAssets.wand}
            </button>
            <div id="statusBar" class="flex-grow p-3.5 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest flex justify-between items-center shadow-2xl"></div>
        </div>

        <div id="summary" class="mb-10 space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-blue-600 text-white p-6 rounded-[32px] shadow-2xl flex flex-col justify-center relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 transition-transform group-hover:scale-110 duration-700">${mBTAssets.money}</div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-blue-200 mb-1">Estimated Grand Total</p>
                    <p id="summaryGrandTotal" class="text-4xl font-black tracking-tighter">--</p>
                </div>
                <div class="bg-emerald-600 text-white p-6 rounded-[32px] shadow-2xl flex flex-col justify-center relative overflow-hidden group">
                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-200 mb-1">Actual Expenditure</p>
                    <p id="summaryActualTotal" class="text-4xl font-black tracking-tighter">--</p>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Discount</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="discountPercentage" value="${budget.discountPercentage || 0}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryDiscount" class="text-lg font-black text-slate-800">--</p>
                </div>

                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Contingency</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="contingencyPercentage" value="${budget.contingencyPercentage}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryContingency" class="text-lg font-black text-slate-800">--</p>
                </div>

                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Sales Tax</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="salesTaxPercentage" value="${budget.salesTaxPercentage}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryTax" class="text-lg font-black text-slate-800">--</p>
                </div>

                <div class="p-4 bg-slate-900 rounded-2xl shadow-xl">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2">Project Subtotal</p>
                    <p id="summarySubtotal" class="text-lg font-black text-white">--</p>
                </div>
            </div>
        </div>

        <main id="budget-sections" class="space-y-4">${renderBudgetSections()}</main>

        <div class="mt-12 p-5 bg-slate-900 rounded-[32px] text-[10px] text-slate-400 font-bold uppercase tracking-widest border border-black shadow-2xl">
            <span class="opacity-50">Intelligence:</span> Industrial personnel rates based on 2025 verified logic. Regional data resolution applied.
            <button id="compareRatesBtn" class="ml-3 text-blue-400 hover:text-white transition-colors underline decoration-blue-500/30 underline-offset-4">Open Matrix</button>
        </div>`;
        
        // Re-bind all initial listeners for a fresh DOM
        if (typeof initializeInteractiveInputs === 'function') initializeInteractiveInputs();
        if (typeof initializeDragAndDrop === 'function') initializeDragAndDrop();
        
        this.paint(); // Initial population of values
    };

    // Deficiency 1 Fix: Surgical DOM Update (The "Paint" Engine)
    // Updates values IN PLACE without destroying DOM nodes.
    mBT.ui.paint = function() {
        if (!budget) return;

        // Fix: Surgical update of Project Name Header
        // We ensure the visual header matches the internal data state immediately.
        // The check for activeElement prevents cursor jumping while the user is typing.
        const projNameInput = document.getElementById('projectName');
        if (projNameInput && document.activeElement !== projNameInput) {
            projNameInput.value = budget.projectName;
        }

        const fmt = mBTLE.format.currency;
        const isMobile = window.innerWidth < 768;
        
        // 1. Update Summaries
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
        
        // Recalculate derived totals based on current percentages
        // Note: These calculations mirror mBTLE.reconcile() to ensure visual sync
        const contingency = budget.subtotal * ((budget.contingencyPercentage || 0) / 100);
        const tax = budget.subtotal * ((budget.salesTaxPercentage || 0) / 100);
        const preDiscount = budget.subtotal + contingency + tax;
        const discount = preDiscount * ((budget.discountPercentage || 0) / 100);
        
        setTxt('summaryGrandTotal', fmt(budget.grandTotal));
        setTxt('summaryActualTotal', fmt(budget.actualTotal));
        setTxt('summarySubtotal', fmt(budget.subtotal));
        setTxt('summaryDiscount', fmt(-discount)); // Show as negative visually
        setTxt('summaryContingency', fmt(contingency));
        setTxt('summaryTax', fmt(tax));

        // 2. Update Line Items
        Object.keys(budget.sections).forEach(sectionKey => {
            const section = budget.sections[sectionKey];
            
            // Update Section Total Header
            // We escape quotes in the key to prevent selector breakage
            const safeKey = sectionKey.replace(/"/g, '\\"');
            const sectionTotalEl = document.querySelector(`[data-section-total="${safeKey}"]`);
            if (sectionTotalEl) sectionTotalEl.textContent = fmt(section.total);

            section.items.forEach(item => {
                const { estimated, variance } = calculateItem(item); 
                
                // Update Estimated Cell
                const estCell = document.querySelector(`[data-estimated-id="${item.id}"]`);
                if (estCell) estCell.textContent = isMobile ? formatAbbreviated(estimated, displayCurrency) : fmt(estimated);
                
                // Update Variance Cell
                const varCell = document.querySelector(`[data-variance-id="${item.id}"]`);
                if (varCell) {
                    varCell.textContent = isMobile ? formatAbbreviated(variance, displayCurrency) : fmt(variance);
                    // Update class for color
                    varCell.className = `p-1 md:p-2 w-[50px] md:w-28 text-right font-mono font-black text-[10px] md:text-xs ${variance > 0 ? 'text-red-500' : 'text-green-600'}`;
                }

                // Update Inputs (Non-destructive)
                // CRITICAL: We only update if the user is NOT currently typing in that specific input
                const updateInput = (field, val) => {
                    const input = document.querySelector(`input[data-id="${item.id}"][data-field="${field}"]`);
                    if (input && document.activeElement !== input) {
                        input.value = val;
                    }
                };
                
                updateInput('quantity', item.quantity);
                updateInput('rate', toDisp(item.rate).toFixed(2));
                updateInput('actual', toDisp(item.actual).toFixed(2));
                // We skip description/unit here as they are rarely changed programmatically during calc loops
            });
        });
    };

    // --- NEW: Surgical DOM Operations ("The Surgeon") ---
    // Logic Resolution: Direct DOM manipulation for Add/Remove to avoid full re-renders
    mBT.ui.ops = {
        add: function(sectionName, item) {
            // 1. Generate HTML string using the Render Engine
            // Logic Resolution: Use internal namespace directly to ensure strict dependency resolution
            const renderer = mBT.ui.render;
            const html = renderer.lineItem(item, sectionName);
            
            // 2. Locate the specific section body
            // We use the same selector strategy as the full render
            const safeName = sectionName.replace(/"/g, '\\"');
            const tbody = document.querySelector(`tbody[data-section-body="${safeName}"]`);
            
            if (tbody) {
                // 3. Inject HTML at the end of the list
                tbody.insertAdjacentHTML('beforeend', html);
                
                // 4. UX Polish: Auto-scroll and flash the new row
                const newRow = tbody.lastElementChild;
                if (newRow) {
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    newRow.classList.add('bg-blue-50');
                    setTimeout(() => newRow.classList.remove('bg-blue-50'), 500);
                    
                    // 5. Re-bind Drag & Drop (Logic Resolution)
                    if (typeof initializeDragAndDrop === 'function') initializeDragAndDrop();
                }
            }
        },
        
        remove: function(sectionName, itemId) {
            // 1. Locate the specific row by ID
            const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
            
            if (row) {
                // 2. UX Polish: Fade out before removal
                row.style.transition = 'all 0.2s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-10px)';
                
                // 3. Remove from DOM after animation
                setTimeout(() => row.remove(), 200);
            }
        }
    };

    // --- Global Alias for Backward Compatibility (The Bridge) ---
    // Logic Resolution: Calls to global 'render()' are now proxied to the UI namespace.
    window.render = mBT.ui.refresh.bind(mBT.ui);

// Logic Resolution: Prevents long filenames from breaking Studio layout containers.
function getAbbreviatedName(name, maxLen = 25) {
    if (name.length <= maxLen) return name;
    const ext = name.split('.').pop();
    const base = name.substring(0, name.lastIndexOf('.'));
    const keep = maxLen - ext.length - 4;
    return base.substring(0, keep) + '...' + ext;
}
    
    // --- mBT.ui.render: VISUAL CONSTRUCTION ENGINE ---
    // Previously: RenderEngine
    mBT.ui.render = {
        // --- XSS Neutralization: Standardized string escaping ---
        // Logic Resolution: Protects the DOM from injection by sanitizing all user-generated strings.
        esc(str) { 
            return !str ? '' : String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;'); 
        },

        /* --- v19.54 UI BLUEPRINTS: Standardized Component Generators --- */
        ui: {
            // 1. Tab Navigation Generator
            tabs: function({ items, activeId, onClick, dataAction }) {
                return `<div class="flex border-b border-slate-100 bg-slate-50/50 rounded-t-xl overflow-hidden select-none">
                    ${items.map(t => {
                        const isActive = t.id === activeId;
                        const activeClass = "bg-white text-blue-600 border-b-2 border-blue-600 shadow-sm";
                        const inactiveClass = "text-slate-400 hover:text-slate-600 hover:bg-slate-100/50";
                        // Logic Resolution: Support both legacy onClick and modern data-action delegation
                        const actionAttr = dataAction ? `data-action="${dataAction}" data-tab="${t.id}"` : `onclick="${onClick}('${t.id}')"`;
                        
                        return `<button type="button" ${actionAttr} class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest transition-all ${isActive ? activeClass : inactiveClass}">
                            ${t.label} ${t.count !== undefined ? `<span class="opacity-50 ml-1">(${t.count})</span>` : ''}
                        </button>`;
                    }).join('')}
                </div>`;
            },

            // 2. Standard List Row (Used in Settings, Trash, Databases)
            listRow: function({ id, icon, title, subtitle, actions = [], onClick = null, classes = '' }) {
                const clickAttr = onClick ? `onclick="${onClick}"` : '';
                const cursorClass = onClick ? 'cursor-pointer' : '';
                
                const actionHtml = actions.map(a => 
                    `<button type="button" aria-label="${a.title || 'Action'}" onclick="${a.onClick}" class="p-2 text-slate-300 hover:text-${a.color || 'blue'}-500 transition-colors scale-90 hover:scale-100" title="${a.title || ''}">${a.icon}</button>`
                ).join('');

                return `<div class="flex items-center justify-between p-3 bg-white border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors group ${classes} ${cursorClass}" ${clickAttr}>
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-white group-hover:text-blue-500 group-hover:shadow-sm transition-all text-lg shrink-0">${icon || ''}</div>
                        <div class="overflow-hidden min-w-0">
                            <div class="text-[10px] font-black uppercase text-slate-700 truncate">${mBT.ui.render.esc(title)}</div>
                            ${subtitle ? `<div class="text-[9px] text-slate-400 font-bold truncate">${mBT.ui.render.esc(subtitle)}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                        ${actionHtml}
                    </div>
                </div>`;
            },

            // 3. Grid Card (Used in Documents, Templates)
            card: function({ id, icon, title, subtitle, badge, actions = [], onClick = null }) {
                const clickAttr = onClick ? `onclick="${onClick}"` : '';
                const cursorClass = onClick ? 'cursor-pointer' : '';

                const actionHtml = actions.map(a => 
                    `<button type="button" aria-label="${a.title || 'Action'}" onclick="${a.onClick}" class="p-2 text-slate-300 hover:text-${a.color || 'blue'}-600 transition-colors" title="${a.title || ''}">${a.icon}</button>`
                ).join('');

                return `<div class="group bg-white p-4 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md hover:border-blue-200 transition-all flex items-center justify-between ${cursorClass}">
                    <div class="flex items-center gap-4 flex-grow overflow-hidden" ${clickAttr}>
                        <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-100 group-hover:scale-110 transition-transform shrink-0">
                            ${icon || ''}
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-black text-slate-900 text-xs uppercase tracking-tighter truncate">${mBT.ui.render.esc(title)}</h4>
                            ${subtitle ? `<p class="text-[9px] text-blue-500 font-bold uppercase tracking-widest truncate">${mBT.ui.render.esc(subtitle)}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                        ${actionHtml}
                    </div>
                </div>`;
            },

            // 4. Empty State Placeholder
            emptyState: function({ icon, message, subtext }) {
                return `<div class="h-64 flex flex-col items-center justify-center text-slate-300 select-none">
                    <div class="text-4xl mb-4 opacity-30">${icon || ''}</div>
                    <p class="font-black uppercase text-[10px] tracking-widest opacity-60">${message || 'No Items Found'}</p>

                    ${subtext ? `<p class="text-[9px] font-bold mt-1 opacity-40">${subtext}</p>` : ''}
                </div>`;
            },

            // 5. Media Asset Card (Universal Bundle Blueprint)
            mediaCard: function({ id, title, type, src, size, location, onClick, actions = [] }) {
                const isInternal = location === 'internal';
                const statusColor = isInternal ? 'bg-emerald-500' : 'bg-amber-500';
                const statusLabel = isInternal ? 'Secure' : 'Linked';
                
                const actionHtml = actions.map(a => 
                    `<button onclick="${a.onClick}" class="p-2 bg-white/90 rounded-lg text-slate-400 hover:text-${a.color || 'blue'}-600 transition-colors shadow-sm backdrop-blur-sm" title="${a.title || ''}">${a.icon}</button>`
                ).join('');

                return `<div class="group relative aspect-square bg-slate-100 rounded-2xl overflow-hidden border border-slate-200 shadow-sm hover:shadow-md transition-all select-none">
                    <!-- Preview Canvas -->
                    <div class="absolute inset-0 flex items-center justify-center bg-slate-50 cursor-pointer" onclick="${onClick}">
                        ${src ? `<img src="${src}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity">` 
                              : `<div class="text-4xl text-slate-300 opacity-50">${mBTAssets.file}</div>`}
                    </div>
                    
                    <!-- HUD Overlay -->
                    <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-slate-900/90 via-slate-900/50 to-transparent p-4 pt-12 text-white pointer-events-none">
                        <div class="flex justify-between items-end">
                            <div class="min-w-0 pr-2">
                                <h4 class="font-black text-[10px] uppercase tracking-widest truncate text-white shadow-black drop-shadow-md">${mBT.ui.render.esc(title)}</h4>
                                <p class="text-[8px] font-bold text-slate-300 mt-0.5 uppercase tracking-wide">${type}  ${size}</p>
                            </div>
                            <div class="flex items-center gap-1.5 shrink-0 bg-black/30 px-2 py-1 rounded-full backdrop-blur-md border border-white/10">
                                <span class="w-1.5 h-1.5 rounded-full ${statusColor} shadow-[0_0_6px_currentColor]"></span>
                                <span class="text-[7px] font-black uppercase tracking-widest opacity-80">${statusLabel}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Floating Actions (Hover) -->
                    <div class="absolute top-2 right-2 flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-all translate-x-2 group-hover:translate-x-0 duration-200 z-10">
                        ${actionHtml}
                    </div>
                </div>`;
            }
        },

        // --- Payment Interface (Foundations Phase 3) ---
        paymentModal: function(contactId, contactName, balance, currency = 'JMD') {
            const services = (typeof PAYMENT_SERVICES !== 'undefined' ? PAYMENT_SERVICES : []);
            
            return `
                <div class="p-6 bg-slate-50 h-full flex flex-col">
                    <!-- Header / Balance -->
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-3 shadow-sm border border-emerald-200">
                            ${mBTAssets.wallet}
                        </div>
                        <h3 class="text-lg font-black text-slate-800 uppercase tracking-tighter">${this.esc(contactName)}</h3>
                        <div class="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm mt-2">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Est. Balance</span>
                            <span class="text-sm font-mono font-bold ${balance > 0 ? 'text-slate-700' : 'text-emerald-600'}">${balance > 0 ? '' : ''}${mBTLE.format.currency(Math.abs(balance), currency)}</span>
                        </div>
                    </div>

                    <!-- Form -->
                    <div class="space-y-4 flex-grow">
                        <div>
                            <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5 ml-1">Payment Amount</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                                <input type="number" id="payAmount" class="w-full p-4 pl-8 bg-white border-none rounded-2xl text-2xl font-black text-slate-800 outline-none focus:ring-4 focus:ring-emerald-100 transition-all placeholder-slate-200" placeholder="0.00" autofocus>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5 ml-1">Method</label>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="payService" class="col-span-2 w-full p-3 bg-white border-none rounded-xl text-xs font-bold text-slate-600 outline-none focus:ring-2 focus:ring-blue-50 cursor-pointer">
                                    ${services.map(s => `<option value="${s.id}">${s.icon} ${s.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div>
                             <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5 ml-1">Date</label>
                             <input type="date" id="payDate" value="${new Date().toISOString().split('T')[0]}" class="w-full p-3 bg-white border-none rounded-xl text-xs font-bold text-slate-600 outline-none">
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="mt-6 pt-6 border-t border-slate-200/50">
                        <button onclick="mBT.features.finance.processPayment('${contactId}')" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg shadow-emerald-200 hover:bg-emerald-500 hover:shadow-xl hover:-translate-y-0.5 transition-all active:scale-95 flex items-center justify-center gap-2">
                            <span>Process Payment</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                        </button>
                    </div>
                </div>
            `;
        },

        // --- Payment History Ledger (Phase 7) ---
        paymentHistory: function(contact) {
            const payments = contact.payments || [];
            const totalPaid = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const sorted = [...payments].sort((a,b) => new Date(b.date) - new Date(a.date));

            if (sorted.length === 0) {
                return this.ui.emptyState({ 
                    icon: mBTAssets.money, 
                    message: 'No Transaction History', 
                    subtext: 'Payments logged will appear here' 
                });
            }
            const list = sorted.map(p => {
                const serviceDef = (typeof PAYMENT_SERVICES !== 'undefined') ? PAYMENT_SERVICES.find(s => s.id === p.service) : null;
                const icon = serviceDef ? serviceDef.icon : mBTAssets.money;
                const label = serviceDef ? serviceDef.label : (p.service || 'Payment');

                return `<div class="flex items-center justify-between p-3 bg-white border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center text-sm shadow-sm border border-emerald-100">${icon}</div>
                        <div>
                            <div class="text-[10px] font-black uppercase text-slate-700">${this.esc(label)}</div>
                            <div class="text-[9px] text-slate-400 font-bold">${this.esc(p.date)}  ${this.esc(p.projectId || 'Unknown Project')}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] font-black text-slate-800 font-mono">${mBTLE.format.currency(p.amount, p.currency)}</div>
                        <div class="text-[8px] text-emerald-500 font-bold uppercase tracking-widest">Paid</div>
                    </div>
                </div>`;
            }).join('');

            return `<div class="flex flex-col h-full bg-slate-50">
                <div class="p-4 bg-white border-b border-slate-100 shrink-0">
                    <div class="flex justify-between items-end">
                        <div>
                            <h4 class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Total Paid</h4>
                            <div class="text-xl font-black text-slate-800 tracking-tighter">${mBTLE.format.currency(totalPaid)}</div>
                        </div>
                        <div class="text-[9px] font-bold text-slate-400">${sorted.length} Transactions</div>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto no-scrollbar p-3 space-y-2">${list}</div>
            </div>`;
        },

        /* --- v19.54 LAYOUT ENGINES: High-level Container Abstractions --- */
        layouts: {
            // Logic Resolution: Modular Studio Layout with Dedicated Title Bar and Expanded Control Header
            studioPanel: function({ title, searchId, searchPlaceholder, contentId, contentHtml, actions = [], toolbarId = '', footerHtml = '', containerClasses = 'p-6 space-y-3' }) {
                // Logic Resolution: Strip structural prefixes for the clean centered title
                const cleanTitle = title.replace(/^(Studio|Budget|Document):\s*/i, '');
                
                // Isolate System Close (isolated on right) from other actions
                const closeAction = actions.find(a => a.title === 'Close');

                const renderBtn = (a) => `
                    <button onclick="${a.onClick}" class="p-2.5 bg-slate-800/80 rounded-xl text-slate-300 hover:text-white hover:bg-${a.color || 'blue'}-600/50 transition-all shadow-sm border border-slate-700/50" title="${a.title||''}">
                        ${a.icon}
                    </button>`;

                // Logic Resolution: Only render the main control header if there are actually tools to show.
                // This removes the "dead black space" in simple views like the Template Selector.
                const showHeader = (toolbarId && toolbarId.trim().length > 0) || (actions && actions.length > 0);

                return `
                <div class="flex flex-col max-h-[90vh] bg-slate-200">
                    <!-- Sub-Header: Document Identity Bar -->
                    <div class="bg-slate-900 text-center py-2 border-b border-slate-800 flex-shrink-0 z-30">
                        <h3 class="font-black text-slate-400 text-[9px] uppercase tracking-[0.2em] truncate px-4">${mBT.ui.render.esc(cleanTitle)}</h3>
                    </div>

                    <!-- Main Studio Header (2-Column Control Grid) - Conditionally Rendered -->
                    ${showHeader ? `
                    <header class="bg-slate-900 p-3 flex-shrink-0 z-20 shadow-lg grid grid-cols-[1fr_auto] items-center gap-4">
                        <!-- Left: Integrated Toolbar & Operations (Occupies remaining space) -->
                        <div id="${toolbarId}" class="flex items-center gap-2 overflow-hidden min-w-0"></div>

                        <!-- Right: System Control (Isolated Close) -->
                        <div class="flex justify-end shrink-0">
                            ${closeAction ? renderBtn(closeAction) : ''}
                        </div>
                    </header>` : ''}

                    <!-- Search & Secondary Nav -->
                    <div class="p-4 bg-white border-b border-slate-100 flex-shrink-0 z-10 shadow-sm">
                        <div class="relative">
                            <input type="text" id="${searchId}" placeholder="${searchPlaceholder || 'SEARCH...'}" class="w-full p-3 pr-10 bg-slate-50 border-none rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">${mBTAssets.search}</div>
                        </div>
                    </div>

                    <!-- Main Content Workspace (Slate-200 background for Widget separation) -->
                    <div id="${contentId}" class="flex-grow overflow-y-auto no-scrollbar bg-slate-200 ${containerClasses}">
                        ${contentHtml}
                    </div>

                    <!-- Footer -->
                    ${footerHtml ? `<div class="p-6 bg-white border-t border-slate-100 flex-shrink-0 z-10">${footerHtml}</div>` : ''}
                </div>`;
            }
        },
        
        // --- Layout Shell: Section container generation ---
        // Logic Resolution: Constructs the collapsible department headers and their item containers.
        // Updated: Removed redundant integrated headers that caused visual double-up on desktop.
        section({ name, total = '', isOpen = true, content = '' }) {
            const safeName = this.esc(name);
            const rawId = name.replace(/"/g, '&quot;'); // Attribute-safe raw key for dataset lookups
            return `
                <div class="mb-4 bg-white rounded-2xl shadow-sm border border-slate-100">
                    <div class="sticky-section-header relative min-h-[48px] bg-slate-50 border-b border-slate-100 select-none group z-30">
                        <div class="px-4 py-3 flex justify-between items-center cursor-pointer z-40 active:bg-slate-100 transition-colors" data-action="section-toggle" data-id="${rawId}">
                            <div class="flex items-center gap-3 pointer-events-none">
                                <h2 class="text-[11px] font-black text-slate-800 uppercase tracking-widest leading-none pl-1">${safeName}</h2>
                            </div>
                            <span data-section-total="${safeName}" class="text-sm font-black text-blue-600 font-mono flex-shrink-0 pointer-events-none">${total}</span>
                        </div>
                    </div>
                    <div class="section-content ${isOpen ? '' : 'hidden'} animate-in fade-in slide-in-from-top-1 duration-200">
                        ${content}
                    </div>
                </div>`;
        },

        // --- Data Row Blueprint: Itemized line generation ---
        // Logic Resolution: Mobile-optimized widths, font-scaling, and "touch-friendly" inputs.
        // Updated to use delegation: data-action attributes for buttons.
        lineItem(item, sectionName) {
            const safeId = this.esc(item.id); 
            const safeSection = this.esc(sectionName);
            const isMobile = window.innerWidth < 768;
            const { estimated, variance } = calculateItem(item); 
            const crew = item.crew || {};
            const isLocked = item.rateType === 'fixed';
            const initials = crew.name ? crew.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
            
            // Logic: Clean phone for links
            const cleanPhone = crew.phone ? crew.phone.replace(/\D/g, '') : '';
            const waLink = `https://wa.me/${(cleanPhone.length === 10 && (cleanPhone.startsWith('876') || cleanPhone.startsWith('658'))) ? '1'+cleanPhone : cleanPhone}`;

            return `
                <tr class="group border-b border-slate-50 hover:bg-blue-50/30 transition-all draggable-row" data-item-id="${safeId}" data-section="${safeSection}">
                    <td class="p-2 text-center relative w-[40px] md:w-12 overflow-visible">
                        <div class="crew-wrapper inline-block">
                            <button data-action="crew-toggle" class="crew-avatar w-7 h-7 md:w-8 md:h-8 rounded-full border-2 border-dashed border-slate-200 flex items-center justify-center text-slate-300 hover:border-blue-400 hover:text-blue-500 transition-all ${crew.name ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white'} relative z-20">
                                <span class="text-[8px] md:text-[10px] font-black pointer-events-none">${initials}</span>
                            </button>

                            <div class="crew-popup">
                                ${crew.name ? `
                                    ${cleanPhone.length > 6 ? `
                                        <a href="tel:${cleanPhone}" class="contact-action-btn action-call" title="Call">${mBTAssets.phone}</a>
                                        <a href="${waLink}" target="_blank" class="contact-action-btn action-wa" title="WhatsApp">${mBTAssets.wa}</a>
                                    ` : ''}
                                    ${crew.email && crew.email.includes('@') ? `
                                        <a href="mailto:${crew.email}" class="contact-action-btn action-email" title="Email">${mBTAssets.mail}</a>
                                    ` : ''}
                                    <button data-action="crew-profile" data-id="${safeId}" data-section="${safeSection}" class="contact-action-btn action-profile" title="Profile">${mBTAssets.user}</button>
                                ` : `
                                    <button data-action="crew-profile" data-id="${safeId}" data-section="${safeSection}" class="flex items-center gap-1 text-[9px] font-black uppercase text-slate-400 hover:text-white transition-colors">
                                        <span class="pointer-events-none">Assign</span> ${mBTAssets.plus}
                                    </button>
                                `}
                            </div>
                        </div>
                    </td>
                    
                    <td class="p-2 w-[30px] md:w-8 drag-handle text-slate-200 hover:text-slate-400 cursor-grab active:cursor-grabbing text-center">${mBTAssets.drag}</td>
                    
                    <td class="p-2 text-left">
                        <input type="text" data-id="${safeId}" data-section="${safeSection}" data-field="description" value="${this.esc(item.description)}" 
                               class="w-full bg-transparent border-none font-bold text-xs md:text-sm text-slate-700 focus:ring-0 truncate mobile-desc-truncate" placeholder="Item...">
                    </td>
                    
                    <td class="p-1 md:p-2 w-[35px] md:w-16">
                        <input type="number" data-id="${safeId}" data-section="${safeSection}" data-field="quantity" value="${item.quantity}" 
                               class="w-full bg-transparent border-none text-center font-black text-[10px] md:text-xs text-blue-600 focus:ring-0 no-spinner p-0">
                    </td>
                    
                    <td class="p-1 md:p-2 w-[40px] md:w-20">
                        <select data-id="${safeId}" data-section="${safeSection}" data-field="unit" 
                                class="w-full bg-transparent border-none text-[8px] md:text-[10px] font-black uppercase tracking-tighter text-slate-400 focus:ring-0 cursor-pointer p-0 text-center">
                            ${['Day','Week','Flat','Policy','Hour'].map(u => `<option value="${u}" ${item.unit === u ? 'selected' : ''}>${u.substring(0,3)}</option>`).join('')}
                        </select>
                    </td>
                    
                    <td class="p-1 md:p-2 w-[50px] md:w-32">
                        <div class="flex items-center gap-1 justify-end md:justify-start">
                            <button data-action="row-lock" data-id="${safeId}" data-section="${safeSection}" class="hidden md:flex w-6 h-6 rounded-lg transition-all flex-shrink-0 items-center justify-center ${isLocked ? 'text-rose-500 bg-rose-50' : 'text-emerald-600 bg-emerald-50'}">
                                <span class="scale-75 pointer-events-none">${isLocked ? mBTAssets.lock : mBTAssets.zap}</span>
                            </button>
                            <input type="number" step="0.01" data-id="${safeId}" data-section="${safeSection}" data-field="rate" value="${toDisp(item.rate).toFixed(2)}" 
                                   class="w-full bg-transparent border-none font-mono font-bold text-[10px] md:text-xs text-slate-500 focus:ring-0 no-spinner text-right md:text-left p-0">
                        </div>
                    </td>
                    
                    <td class="p-1 md:p-2 w-[55px] md:w-28 font-mono font-bold text-[10px] md:text-xs text-slate-800 text-right" data-estimated-id="${safeId}">
                        ${isMobile ? formatAbbreviated(estimated, displayCurrency) : mBTLE.format.currency(estimated)}
                    </td>
                    
                    <td class="p-1 md:p-2 w-[55px] md:w-28">
                        <input type="number" step="0.01" data-id="${safeId}" data-section="${safeSection}" data-field="actual" value="${toDisp(item.actual || 0).toFixed(2)}" 
                               class="w-full bg-blue-50/50 rounded-md border-none font-mono font-bold text-[10px] md:text-xs text-emerald-600 focus:ring-0 no-spinner text-right p-1" placeholder="0">
                    </td>
                    
                    <td class="p-1 md:p-2 w-[50px] md:w-28 text-right font-mono font-black text-[10px] md:text-xs" data-variance-id="${safeId}">
                        ${isMobile ? formatAbbreviated(variance, displayCurrency) : mBTLE.format.currency(variance)}
                    </td>
                    
                    <td class="p-1 md:p-2 text-center w-[30px] md:w-10">
                        <button data-action="row-delete" data-id="${safeId}" data-section="${safeSection}" class="text-slate-200 hover:text-rose-500 transition-colors scale-75 md:scale-100">
                            ${mBTAssets.trash}
                        </button>
                    </td>
                </tr>`;
        },

        // --- Stage Visualization: Production phase card generation ---
        // Logic Resolution: Renders specialized cards for the Production Stages view with burn-rate telemetry.
        stageCard(item, stageKey) {
            const cost = (item._sDays || 0) * (item._sRate || 0);
            
            // TIER 4 VISUALS: Smart Days Conflict Detection
            const limit = (budget.targetLock && budget.targetLock.stages[stageKey]) ? (parseFloat(budget.targetLock.stages[stageKey].days)||0) : 0;
            const days = parseFloat(item._sDays)||0;
            const isConflict = limit > 0 && days > limit;
            
            // Note: onmousedown/ontouchstart removed. Sortable 'filter' now handles interaction locking.
            // Layout Update: Increased contrast (border-slate-300, shadow-md) and spacing (space-y-3).
            // Added 'pr-12' padding to container to accommodate the larger side button.
            return `
                <div class="stage-card-item p-3 pr-12 ${isConflict ? 'bg-amber-50 border-amber-200 shadow-amber-100' : 'bg-white border-slate-300'} border rounded-xl shadow-md space-y-3 group relative cursor-grab active:cursor-grabbing transition-colors duration-300 stage-draggable" 
                     data-item-id="${item.id}" data-stage-key="${stageKey}">
                    
                    <div class="flex justify-between items-start">
                        <div class="min-w-0 pr-2">
                            <p class="text-[10px] font-black ${isConflict ? 'text-amber-800' : 'text-slate-800'} uppercase truncate">${this.esc(item.description)}</p>
                            <p class="text-[8px] ${isConflict ? 'text-amber-600' : 'text-slate-400'} font-bold uppercase tracking-widest">${this.esc(item._sec)}</p>
                        </div>
                        <span id="cost-${item.id}-${stageKey}" class="text-[10px] font-black text-slate-900 font-mono flex-shrink-0">${formatAbbreviated(cost, displayCurrency)}</span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <!-- Layout Update: Compact widths (w-12, w-20) for mobile fit -->
                        <div class="w-12">
                            <label class="block text-[7px] font-black text-slate-400 uppercase">Days ${isConflict ? '(!)' : ''}</label>
                            <input type="number" value="${item._sDays}" 
                                   data-action="stage-update" data-field="days" data-id="${item.id}" data-section="${this.esc(item._sec)}" data-stage="${stageKey}" 
                                   class="w-full ${isConflict ? 'bg-white text-amber-600 font-black' : 'bg-slate-50 text-blue-600 font-bold'} border-none rounded p-1 text-[10px] no-spinner transition-colors">
                        </div>
                        <div class="w-20">
                            <label class="block text-[7px] font-black text-slate-400 uppercase">Rate</label>
                            <input type="number" value="${item._sRate}" 
                                   data-action="stage-update" data-field="rate" data-id="${item.id}" data-section="${this.esc(item._sec)}" data-stage="${stageKey}" 
                                   class="w-full bg-slate-50 border-none rounded p-1 text-[10px] font-mono font-bold text-slate-600 no-spinner">
                        </div>
                    </div>

                    <!-- Smart Remove: Centered Right, Larger Touch Target -->
                    <button 
                        class="stage-remove-btn absolute top-1/2 -translate-y-1/2 right-2 bg-white text-slate-300 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center shadow-md border border-slate-200 z-30 transition-all hover:scale-110 hover:shadow-lg hover:border-red-100"
                        onpointerdown="event.stopPropagation()"
                        onclick="mBT.features.stages.logic.removeItem(this)"
                        data-id="${item.id}"
                        data-section="${this.esc(item._sec)}"
                        data-stage="${stageKey}"
                        title="Remove from Stage">
                        ${mBTAssets.minusCircle}
                    </button>
                </div>`;
        }
    };
    
    // --- Global Alias for Backward Compatibility (The Bridge) ---
    window.RenderEngine = mBT.ui.render;

/* --- 4. Render Orchestration: Global UI drawing logic --- */
    function renderBudgetSections() {
        if (!budget || !budget.sections) return '';
        
        // Phase 9: Sub-Budget View Filter
        const filter = (mBT.ui && mBT.ui.state) ? mBT.ui.state.activeFilter : null;

        return Object.entries(budget.sections).map(([name, section]) => {
            // Logic Resolution: Sub-Budget Isolation
            if (filter && name !== filter) return '';

            // Logic Resolution: Responsive Table Headers
            // Note: Header moved to RenderEngine.section to prevent visual blocking. Table is now body-only.
            // Fix: Escape quotes in section name to prevent HTML attribute injection
            const safeSectionName = name.replace(/"/g, '&quot;');
            
            const bodyContent = `
                <div class="table-container overflow-x-auto no-scrollbar relative">
                    <table class="w-full border-collapse min-w-[800px] table-fixed md:table-auto">
                        <thead class="bg-slate-50 text-[10px] font-black uppercase tracking-tighter text-slate-400 border-b border-slate-100">
                            <tr>
                                <th class="p-2 w-12 text-center">Crew</th>
                                <th class="p-2 w-8 text-center"></th>
                                <th class="p-2 text-left sticky left-0 z-20 bg-slate-50 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">Description</th>
                                <th class="p-2 w-16 text-center">Qty</th>
                                <th class="p-2 w-20 text-center">Unit</th>
                                <th class="p-2 w-32 text-right md:text-left">Rate</th>
                                <th class="p-2 w-28 text-right md:text-left">Est</th>
                                <th class="p-2 w-28 text-right md:text-left">Act</th>
                                <th class="p-2 w-28 text-right">Var</th>
                                <th class="p-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody data-section-body="${safeSectionName}">
                            ${section.items.map(item => RenderEngine.lineItem(item, name)).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="bg-white border-t border-slate-100">
                    <button data-action="section-add" data-id="${safeSectionName}" class="w-full py-3 flex items-center justify-center gap-2 text-blue-600 font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 transition-all">
                        <span class="scale-75 pointer-events-none">${mBTAssets.plus}</span> Add Line Item
                    </button>
                </div>`;

            return RenderEngine.section({
                name: name,
                total: mBTLE.format.currency(section.total),
                isOpen: section.isOpen,
                content: bodyContent
            });
        }).join('');
    }

// Logic Resolution: Toggles visibility of section items.
function handleToggleSection(sectionName, triggerEl) {
    const sec = budget.sections[sectionName];
    if (sec) {
        sec.isOpen = !sec.isOpen;
        saveBudget();
        
        // Tier 4 Surgical Update: Direct DOM toggle
        // Logic Resolution: Ensures triggerEl.closest('.mb-4') finds the card wrapper
        // and container.querySelector('.section-content') targets the collapsible area.
        if (triggerEl) {
            const container = triggerEl.closest('.mb-4');
            const content = container ? container.querySelector('.section-content') : null;

            if (content) {
                if (sec.isOpen) content.classList.remove('hidden');
                else content.classList.add('hidden');
            }
        } else {
            render();
        }
    }
}

// Logic Resolution: Removes items from the budget object.
function handleRemoveItem(sectionName, itemId) {
    mBTME.confirm("Delete Line Item", "Remove this item from the budget permanently?", () => {
        const sec = budget.sections[sectionName];
        if(sec) {
            // SNAPSHOT TRIGGER: Capture state before deletion
            if (mBT.data && mBT.data.recorder) mBT.data.recorder.snapshot("Deleted Line Item");

            // Fix: Use string comparison to avoid type mismatches (Ghost Cost bug)
            sec.items = sec.items.filter(i => String(i.id) !== String(itemId));
            
            // Tier 4 Surgeon: Remove DOM node instantly
            if (mBT.ui && mBT.ui.ops) {
                mBT.ui.ops.remove(sectionName, itemId);
                mBTLE.reconcile(); // Update Math
                mBT.ui.paint();    // Update Totals
            } else {
                mBTLE.reconcile();
                render(); // Fallback
            }
        }
    });
}

// Logic Resolution: Modal for adding new line items from Open Gate.
function showItemSelectorModal(sectionName) {
    // Define the commit handler globally for HTML access
    window._commitAddItem = (desc, rate, unit) => {
        const section = budget.sections[sectionName];
        if (!section) return;

        // SNAPSHOT TRIGGER: Capture state before addition
        if (mBT.data && mBT.data.recorder) mBT.data.recorder.snapshot("Added Line Item");

        const newItem = {
            id: 'item_' + Date.now(),
            description: desc || 'New Item',
            quantity: 1,
            unit: unit || 'Day',
            rate: parseFloat(rate) || 0,
            multiplier: 1,
            actual: 0,
            crew: { name: '', phone: '', email: '' },
            rateType: 'negotiable'
        };
        section.items.push(newItem);
        mBTME.close('itemSelectorModal');
        
        // Tier 4 Surgeon: Inject DOM node instantly
        if (mBT.ui && mBT.ui.ops) {
            mBT.ui.ops.add(sectionName, newItem);
            mBTLE.reconcile(); // Update Math
            mBT.ui.paint();    // Update Totals
        } else {
            mBTLE.reconcile();
            render(); // Fallback
        }
    };

    const rates = mBTOG.rates || [];
    
    // Custom filter logic to preserve the 'Create Custom' button dynamically
    window._filterItemSelector = (val) => {
        const container = document.getElementById('ogItemList');
        if(!container) return;
        const term = val.toLowerCase();
        const filtered = rates.filter(r => r.description.toLowerCase().includes(term));
        
        const customBtn = `
            <button onclick="window._commitAddItem('${RenderEngine.esc(val)}', 0, 'Day')" class="w-full text-left p-3 rounded-lg border border-dashed border-indigo-200 text-indigo-600 hover:bg-indigo-50 transition-all mb-2 flex justify-between items-center group">
                <span class="text-[10px] font-black uppercase tracking-widest">+ Create "${RenderEngine.esc(val) || 'New Item'}"</span>
            </button>`;

        const listHtml = filtered.map(r => `
            <button onclick="window._commitAddItem('${RenderEngine.esc(r.description)}', ${r.rate}, '${r.unit}')" class="w-full text-left p-3 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all flex justify-between items-center group border-b border-slate-50 last:border-0">
                <span class="text-[10px] font-bold text-slate-700 uppercase">${r.description}</span>
                <span class="text-[9px] font-mono text-slate-400 group-hover:text-blue-500 font-bold">${mBTLE.format.currency(r.rate)} / ${r.unit}</span>
            </button>
        `).join('');
        
        container.innerHTML = customBtn + listHtml;
    };

    const content = `
        <div class="flex flex-col h-[500px]">
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <input type="text" oninput="window._filterItemSelector(this.value)" placeholder="SEARCH OPEN GATE..." class="w-full p-3 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-indigo-500 transition-all" autofocus>
            </div>
            <div id="ogItemList" class="flex-grow overflow-y-auto p-2 bg-white no-scrollbar">
                <button onclick="window._commitAddItem('New Item', 0, 'Day')" class="w-full text-left p-3 rounded-lg border border-dashed border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 hover:bg-indigo-50 transition-all mb-2 flex justify-between items-center group">
                    <span class="text-[10px] font-black uppercase tracking-widest">+ Create Custom</span>
                </button>
                ${rates.map(r => `
                    <button onclick="window._commitAddItem('${RenderEngine.esc(r.description)}', ${r.rate}, '${r.unit}')" class="w-full text-left p-3 rounded-lg hover:bg-slate-50 border border-transparent hover:border-slate-100 transition-all flex justify-between items-center group border-b border-slate-50 last:border-0">
                        <span class="text-[10px] font-bold text-slate-700 uppercase">${r.description}</span>
                        <span class="text-[9px] font-mono text-slate-400 group-hover:text-blue-500 font-bold">${mBTLE.format.currency(r.rate)} / ${r.unit}</span>
                    </button>
                `).join('')}
            </div>
        </div>`;

    mBTME.open('itemSelector', `Add to ${sectionName}`, content, 'max-w-md');
    // Auto-focus logic for better UX
    setTimeout(() => document.querySelector('#itemSelectorModal input')?.focus(), 50);
}

// Logic Resolution: Placeholders for event listeners handled by Tier 6.
function initializeInteractiveInputs() {}

// Logic Resolution: Drag and drop initialization.
function initializeDragAndDrop() {
    document.querySelectorAll('tbody').forEach(el => {
        // Fix: Idempotency Check to prevent multiple instances causing "locked" rows
        if (el.classList.contains('sortable-initialized')) return;

        if(typeof Sortable !== 'undefined') {
            new Sortable(el, { 
                handle: '.drag-handle', 
                animation: 150,
                // Fix: Filter inputs so typing doesn't trigger drag or get blocked
                filter: 'input, button, select, textarea, .no-drag',
                preventOnFilter: false,
                // TIER 2 FIX: Persist order changes to Data Model
                onEnd: function (evt) {
                    const itemEl = evt.item;
                    const secKey = itemEl.dataset.section; // Auto-decodes HTML entities
                    const oldIdx = evt.oldIndex;
                    const newIdx = evt.newIndex;

                    if (secKey && budget.sections[secKey] && oldIdx !== newIdx) {
                        const items = budget.sections[secKey].items;
                        
                        // SNAPSHOT TRIGGER: Capture state before reorder
                        if (mBT.data && mBT.data.recorder) mBT.data.recorder.snapshot("Reordered Items");

                        // Tier 2 Audit Hook: Log Reorder
                        if (mBT.data && mBT.data.state && mBT.data.state.audit) {
                            const movedItem = items[oldIdx];
                            mBT.data.state.audit('REORDER', movedItem.description, { section: secKey });
                        }

                        // Array Move: Splice out, then Splice in
                        const [movedItem] = items.splice(oldIdx, 1);
                        items.splice(newIdx, 0, movedItem);
                        
                        // Persist immediately (No render needed as DOM is already moved)
                        saveBudget();
                    }
                }
            });
            el.classList.add('sortable-initialized');
        }
    });
}

// Logic Resolution: Stage Drag and Drop initialization.
function initializeStageDragAndDrop() {
    // TIER 5 UPGRADE: Integrated Sortable.js for Stages
    const containers = document.querySelectorAll('.stage-drop-zone');
    
    containers.forEach(container => {
        // Fix: Idempotency Check to prevent multiple instances
        if (container.classList.contains('sortable-initialized')) return;

        if(typeof Sortable === 'undefined') return;
        
        new Sortable(container, {
            group: {
                name: 'stages',
                pull: 'clone', // Clone items instead of moving
                put: true
            },
            animation: 150,
            sort: true, // ENABLED: Allow reordering within the stage
            delay: 100, // Touch device debounce
            delayOnTouchOnly: true,
            ghostClass: 'opacity-50',
            filter: 'input, button, select, .no-drag, .stage-remove-btn',
            preventOnFilter: false, // Fix: Allow clicks to bubble up to Router
            
            // Event: Item reordered within the same list
            onUpdate: function(evt) {
                window.updateStageOrder(container.dataset.stageKey, container);
            },

            // Event: Item dropped from another list
            onAdd: function (evt) {
                const itemEl = evt.item;
                const targetStage = container.dataset.stageKey;
                const sourceStage = itemEl.dataset.stageKey;
                const itemId = itemEl.dataset.itemId;
                
                if (!itemId || !targetStage) {
                    showStagesModal(); // Revert
                    return; 
                }

                // Update State Logic
                let item = null;
                Object.values(budget.sections).forEach(sec => { 
                    if(!item) item = sec.items.find(i => i.id === itemId); 
                });

                if (item) {
                    if (!item.stageData) item.stageData = {};
                    
                    // If not already in stage, add it (prevent overwriting if dragging for reorder, though onAdd implies cross-list)
                    if (!item.stageData[targetStage] || sourceStage !== targetStage) {
                        // Clone data if coming from another stage, else default
                        let newData = { days: 1, rate: item.rate || 0 };
                        if (sourceStage && item.stageData[sourceStage]) {
                            newData = { ...item.stageData[sourceStage] };
                        }
                        item.stageData[targetStage] = newData;
                    }
                    
                    // Update Order based on drop position
                    window.updateStageOrder(targetStage, container);

                    // Full Redraw to ensure DOM ID/Input consistency
                    if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
                    showStagesModal();
                } else {
                     showStagesModal(); // Revert if item not found
                }
            }
        });
        container.classList.add('sortable-initialized');
    });
}

// Logic Resolution: Helper to persist visual order to data model
window.updateStageOrder = function(stageKey, container) {
    const children = Array.from(container.children);
    children.forEach((el, index) => {
        const itemId = el.dataset.itemId;
        if(!itemId) return;
        
        let item = null;
        Object.values(budget.sections).forEach(sec => { 
            if(!item) item = sec.items.find(i => i.id === itemId); 
        });
        
        if (item && item.stageData && item.stageData[stageKey]) {
            item.stageData[stageKey].order = index;
        }
    });
    saveBudget();
};

// Logic Resolution: Updates UI based on connectivity.
function updateOnlineStatus() {
    if(typeof resolveConnectivityStatus === 'function') resolveConnectivityStatus();
}

// Logic Resolution: Project Template Selector (Visual Bridge)
window.showNewProjectModal = function() {
    // 1. Build Cards from Tier 1 Registry (Industry Standards)
    const standardsHtml = Object.entries(BUDGET_TEMPLATES).map(([key, t]) => `
        <button onclick="mBT.data.newProject(false, '${key}'); mBTME.close('newProjectModal');"
            class="group relative flex flex-col items-start p-6 bg-white border border-slate-200 rounded-2xl hover:border-blue-500 hover:shadow-xl hover:-translate-y-1 transition-all text-left w-full h-full">
            <div class="w-12 h-12 rounded-2xl bg-slate-50 text-slate-400 group-hover:bg-blue-600 group-hover:text-white flex items-center justify-center mb-4 transition-colors shadow-sm">
                ${mBTAssets[t.icon] || mBTAssets.file}
            </div>
            <h3 class="text-xs font-black uppercase tracking-widest text-slate-900 mb-2 group-hover:text-blue-600 transition-colors">${t.label}</h3>
            <p class="text-[10px] text-slate-500 font-medium leading-relaxed opacity-80 line-clamp-2">${t.desc}</p>
        </button>
    `).join('');

    // 2. Build Cards from User Templates (Custom Blueprints)
    const allTmpl = mBT.data.templates.getTemplates();
    const systemKeys = Object.keys(BUDGET_TEMPLATES);
    
    const customHtml = Object.entries(allTmpl)
        .filter(([key]) => !systemKeys.includes(key))
        .map(([key, t]) => {
            const label = t.label || key;
            const icon = (t.icon && mBTAssets[t.icon]) ? mBTAssets[t.icon] : mBTAssets.file;
            const desc = t.desc || (t.items ? `${t.items.length} Items` : 'Custom Blueprint');
            
            return `
            <button onclick="mBT.data.newProject(false, '${key}'); mBTME.close('newProjectModal');"
                class="group flex flex-col p-4 bg-slate-50 border border-slate-200 rounded-xl hover:border-indigo-500 hover:bg-white hover:shadow-md transition-all text-left w-full h-full">
                <div class="flex items-center justify-between w-full mb-2">
                    <div class="text-[10px] font-black uppercase tracking-widest text-slate-700 truncate w-full pr-2 group-hover:text-indigo-600">${label}</div>
                    <div class="text-slate-300 group-hover:text-indigo-500 scale-75 flex-shrink-0">${icon}</div>
                </div>
                <div class="text-[8px] text-slate-400 font-bold truncate">${desc}</div>
            </button>`;
        }).join('');

    // 3. Build Modal Layout
    const content = `
        <div class="p-8 bg-slate-50 min-h-[500px] flex flex-col">
            <div class="text-center mb-8 shrink-0">
                <h2 class="text-lg font-black uppercase tracking-tighter text-slate-900">Start Production</h2>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-2">Select a blueprint to initialize budget</p>
            </div>
            
            <div class="flex-grow overflow-y-auto no-scrollbar pr-2">
                <!-- Industry Standards -->
                <div class="mb-3 flex items-center gap-3">
                    <span class="text-[9px] font-black uppercase tracking-widest text-slate-400">Industry Standards</span>
                    <div class="h-px bg-slate-200 flex-grow"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    ${standardsHtml}
                </div>

                <!-- Custom Blueprints (Conditional) -->
                ${customHtml ? `
                <div class="mb-3 flex items-center gap-3">
                    <span class="text-[9px] font-black uppercase tracking-widest text-slate-400">My Blueprints</span>
                    <div class="h-px bg-slate-200 flex-grow"></div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    ${customHtml}
                </div>` : ''}
            </div>

            <div class="mt-4 text-center shrink-0 border-t border-slate-200/50 pt-4">
                <button onclick="mBT.data.newProject(false, 'Blank'); mBTME.close('newProjectModal');" class="text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-colors hover:bg-slate-200/50 px-4 py-2 rounded-lg">
                    Skip & Create Blank Budget
                </button>
            </div>
        </div>`;

    // 4. Launch via Tier 5 Modal Engine
    mBTME.open('newProject', '', content, 'max-w-5xl', { hideHeader: true, noPadding: true });
};


/* ================= TIER 5: MODULE CONTROLLERS & SMART FEATURES ================= */
    /* ========= v19.54 mBT.ui.modal: MODAL ENGINE (Window orchestration) ========= */
    // Previously: mBTME
    mBT.ui.modal = {
        containerId: 'global-modal-container',
        // --- Registry Resolution: Pointing to Tier 1 Asset Registry ---
        icons: { 
            close: mBTAssets.close,
            alert: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`
        },
      
        // --- Portal Generation: Dynamic injection of overlay layers ---
        open: function(id, title, contentHtml, maxWidth = 'max-w-2xl', options = {}) {
            const container = document.getElementById(this.containerId);
            if (!container) return;
            
            // Logic Resolution: Prevent background scrolling while modal is active
            document.body.style.overflow = 'hidden';

            const modalId = `${id}Modal`;
            this.close(modalId, true);
            // UPDATED HEADER: Uses grid to perfectly center the title while keeping the close button right-aligned
            const headerHtml = options.hideHeader ? '' : `
                <div class="p-4 border-b border-slate-100 bg-white rounded-t-2xl relative grid grid-cols-[1fr_auto_1fr] items-center shrink-0">
                    <div></div> <h2 class="text-xs font-black uppercase tracking-widest text-slate-800 text-center">${title}</h2>
                    <div class="text-right">
                        <button onclick="mBT.ui.modal.close('${modalId}')" class="text-slate-400 hover:text-red-500 transition-all p-1 rounded-md hover:bg-slate-50">${this.icons.close}</button>
                    </div>
                </div>`;
            const fullHtml = `
                <div id="${modalId}" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[999] transition-opacity duration-300 opacity-0 hidden" tabindex="-1">
                    <div id="${modalId}Content" class="bg-white rounded-2xl shadow-2xl w-full ${maxWidth} mx-auto max-h-[95vh] flex flex-col transition-all duration-300 transform scale-95 border border-white/20 overflow-hidden">
                        ${headerHtml}
                        <div class="flex-grow overflow-hidden ${options.noPadding ? 'p-0' : 'p-0'}" id="${modalId}Body">${contentHtml}</div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', fullHtml);
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById(`${modalId}Content`)?.classList.remove('scale-95');
            }, 10);
          
            modal.addEventListener('click', (e) => { if (e.target === modal) this.close(modalId); });
            if (options.onOpen && typeof options.onOpen === 'function') setTimeout(options.onOpen, 50);
            return modal;
        },
        // --- Portal Dissolution: Synchronized removal of UI layers ---
        close: function(modalId, instant = false) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Logic Resolution: Release body scroll if no other modals are open
            if(document.querySelectorAll('[id$="Modal"]').length <= 1) document.body.style.overflow = '';

            if (instant) { modal.remove(); } else {
                modal.classList.add('opacity-0');
                document.getElementById(`${modalId}Content`)?.classList.add('scale-95');
                // --- Handshake: Reconcile logic on environment exit ---
                setTimeout(() => { modal.remove(); if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); }, 300);
            }
        },

        // --- System: Non-blocking Confirmation Modal ---
        confirm: function(title, message, onConfirm) {
            const content = `
                <div class="p-8 text-center flex flex-col items-center justify-center">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 mb-4 animate-bounce shadow-sm">
                        ${this.icons.alert}
                    </div>
                    <h3 class="text-sm font-black uppercase tracking-widest text-slate-800 mb-2">${title}</h3>
                    <p class="text-xs text-slate-500 font-bold mb-8 max-w-xs leading-relaxed">${message}</p>
                    <div class="flex gap-3 w-full max-w-xs">
                        <button id="mbtConfirmCancel" class="flex-1 py-3 bg-white border border-slate-200 text-slate-500 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 transition-all">Cancel</button>
                        <button id="mbtConfirmYes" class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-black shadow-lg transition-all transform active:scale-95">Confirm</button>
                    </div>
                </div>`;
            
            this.open('confirmation', '', content, 'max-w-sm', { hideHeader: true, noPadding: true });
            
            // Bind listeners after render
            setTimeout(() => {
                const cancelBtn = document.getElementById('mbtConfirmCancel');
                const yesBtn = document.getElementById('mbtConfirmYes');
                if(cancelBtn) cancelBtn.onclick = () => this.close('confirmationModal');
                if(yesBtn) yesBtn.onclick = () => {
                    this.close('confirmationModal');
                    if(onConfirm && typeof onConfirm === 'function') onConfirm();
                };
            }, 50);
        },

        // --- System: Non-blocking Alert Modal ---
        alert: function(title, message, onOk) {
            const content = `
                <div class="p-8 text-center flex flex-col items-center justify-center">
                    <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center text-blue-500 mb-4 shadow-sm">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    </div>
                    <h3 class="text-sm font-black uppercase tracking-widest text-slate-800 mb-2">${title}</h3>
                    <p class="text-xs text-slate-500 font-bold mb-8 max-w-xs leading-relaxed">${message}</p>
                    <button id="mbtAlertOk" class="w-full py-3 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-black shadow-lg transition-all transform active:scale-95">OK</button>
                </div>`;
            
            this.open('alert', '', content, 'max-w-sm', { hideHeader: true, noPadding: true });
            
            setTimeout(() => {
                const okBtn = document.getElementById('mbtAlertOk');
                if(okBtn) okBtn.onclick = () => {
                    this.close('alertModal');
                    if(onOk && typeof onOk === 'function') onOk();
                };
            }, 50);
        },

        // --- System: Non-blocking Prompt Modal ---
        prompt: function(title, message, defaultValue, onOk) {
            const content = `
                <div class="p-8 text-center flex flex-col items-center justify-center">
                    <h3 class="text-sm font-black uppercase tracking-widest text-slate-800 mb-2">${title}</h3>
                    <p class="text-xs text-slate-500 font-bold mb-4 max-w-xs leading-relaxed">${message}</p>
                    <input type="text" id="mbtPromptInput" value="${defaultValue || ''}" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500 mb-6" autofocus>
                    <div class="flex gap-3 w-full max-w-xs">
                        <button id="mbtPromptCancel" class="flex-1 py-3 bg-white border border-slate-200 text-slate-500 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 transition-all">Cancel</button>
                        <button id="mbtPromptOk" class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-black shadow-lg transition-all transform active:scale-95">OK</button>
                    </div>
                </div>`;
            
            this.open('prompt', '', content, 'max-w-sm', { hideHeader: true, noPadding: true });
            
            setTimeout(() => {
                const input = document.getElementById('mbtPromptInput');
                if(input) {
                    input.focus();
                    input.select();
                    input.addEventListener('keydown', (e) => {
                        if(e.key === 'Enter') document.getElementById('mbtPromptOk').click();
                    });
                }
                const cancelBtn = document.getElementById('mbtPromptCancel');
                const okBtn = document.getElementById('mbtPromptOk');
                if(cancelBtn) cancelBtn.onclick = () => this.close('promptModal');
                if(okBtn) okBtn.onclick = () => {
                    const val = document.getElementById('mbtPromptInput').value;
                    this.close('promptModal');
                    if(onOk && typeof onOk === 'function') onOk(val);
                };
            }, 50);
        },

        // --- System: Status Loader ---
        showLoader: function(message) {
            const content = `
                <div class="p-6 flex flex-col items-center justify-center">
                    <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-slate-500 animate-pulse">${message}</p>
                </div>`;
            this.open('loader', '', content, 'max-w-xs', { hideHeader: true, noPadding: true });
        },
        hideLoader: function() {
            this.close('loaderModal');
        },

         // --- Search Integration: Filtering logic for modal lists ---
        attachSearch: function(inputId, listContainerId, dataItems, renderRowFn) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listContainerId);
            if (!input || !list) return;
            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = dataItems.filter(item => (item.description || item.name || item.label || '').toLowerCase().includes(term));
                // Logic Resolution: Added col-span-full to support grid layouts in "No Matches" state
                list.innerHTML = filtered.length > 0 ? filtered.map(renderRowFn).join('') : `<div class="p-12 text-center text-slate-300 text-[10px] font-black uppercase tracking-widest col-span-full">No Matches</div>`;
            });
        }
    };
    
    // --- Global Alias for Backward Compatibility (The Bridge) ---
    window.mBTME = mBT.ui.modal;

    /* ========= v19.54 mBTPublisher: OUTPUT & COMMUNICATIONS ENGINE ========= */
    const mBTPublisher = {
        config: {
            pdf: { margin: 0.2, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }
        },

        /* --- 1. Communication Protocols (The "Comms" Layer) --- */
        comm: {
            // Logic Resolution: Centralized link generation for consistency
            cleanPhone: (p) => p ? p.replace(/\D/g, '') : '',
            
            whatsapp: function(phone, text = '') {
                const p = this.cleanPhone(phone);
                if (!p) return '#';
                // Industry Standard: Auto-append country code for Jamaica/US if missing
                const num = (p.length === 10 && (p.startsWith('876') || p.startsWith('658'))) ? '1'+p : p;
                return `https://wa.me/${num}?text=${encodeURIComponent(text)}`;
            },
            
            email: function(email, subject = '', body = '') {
                return `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            },

            call: function(phone) {
                return `tel:${this.cleanPhone(phone)}`;
            },

            // Logic Resolution: Generates the "Share Sheet" for a document
            generateShareSheet: function(doc) {
                const title = doc.label || 'Document';
                const date = doc.content?.data?.meta?.shootDate || 'TBD';
                return `Here is the ${title} for ${date}. Please review.`;
            }
        },

        /* --- 2. IO & File Systems (The "Hard Drive" Layer) --- */
        io: {
            forceDownload: function(blob, filename) {
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            },

            saveMoo: function(budgetData) {
                const blob = new Blob([JSON.stringify(budgetData, null, 2)], { type: 'application/json' });
                this.forceDownload(blob, `${(budgetData.projectName || 'project').toLowerCase().replace(/\s+/g, '_')}.moo`);
            },

            saveTemplate: function(templateData) {
                const blob = new Blob([JSON.stringify(templateData, null, 2)], { type: 'application/json' });
                this.forceDownload(blob, `${(templateData.label || 'template').toLowerCase().replace(/\s+/g, '_')}.mtemp`);
            },

            saveBundle: async function(budgetData) {
                if (typeof JSZip === 'undefined') return mBTME.alert("Error", "Bundler module (JSZip) missing.");
                
                const zip = new JSZip();
                const cleanName = (budgetData.projectName || 'project').toLowerCase().replace(/\s+/g, '_');
                
                // 1. Add Core Data
                zip.file(`${cleanName}.moo`, JSON.stringify(budgetData, null, 2));
                
            // 2. Add Manifest
            const readme = `Project: ${budgetData.projectName}\nExported: ${new Date().toLocaleString()}\n\nContains master budget data (.moo) and embedded assets.\nFormat: Unified Container (Zip-based)`;
            zip.file("README.txt", readme);

            // --- Asset Injection Loop ---
            const assetsFolder = zip.folder("assets");
            const cleanBase64 = (dataurl) => dataurl.split(',')[1];

            if (budgetData.documents) {
                for (const doc of budgetData.documents) {
                    if (doc.attachments) {
                        for (let i = 0; i < doc.attachments.length; i++) {
                            const file = doc.attachments[i];
                            // Sanitize filename to ensure ZIP compatibility
                            const safeName = (file.name || 'file').replace(/[^a-z0-9.]/gi, '_');
                            const fileName = `${doc.id}_${i}_${safeName}`;
                            
                            try {
                                if (file.location === 'internal' && file.key) {
                                    // Resolve Internal Blob from IndexedDB
                                    const blobUrl = await mBT.data.storage.loadBlob(file.key);
                                    if (blobUrl) {
                                        const response = await fetch(blobUrl);
                                        const blob = await response.blob();
                                        assetsFolder.file(fileName, blob);
                                    }
                                } else if (file.data) {
                                    // Handle Legacy Base64
                                    assetsFolder.file(fileName, cleanBase64(file.data), { base64: true });
                                }
                            } catch (err) {
                                console.warn(`Failed to bundle asset: ${file.name}`, err);
                            }
                        }
                    }
                }
            }

                // 3. Generate & Download
                try {
                    const content = await zip.generateAsync({ type: "blob" });
                    this.forceDownload(content, `${cleanName}.moo`);
                } catch(e) {
                    console.error("Bundle Error:", e);
                    mBTME.alert("Export Error", "Failed to generate bundle.");
                }
            }
        },

        /* --- 3. Render Formats (The "Printer" Layer) --- */
        format: {
            // PDF Export (Studio Documents)
            pdf: function(elementId, filename) {
                const element = document.getElementById(elementId);
                if (!element) return mBTME.alert("Export Error", "Source element not found");
                
                // Visual Polish: Flatten inputs for print
                const originalBg = element.style.background;
                element.style.background = "white";
                element.classList.add('print-mode'); // CSS hook for hiding buttons
                
                html2pdf().set(mBTPublisher.config.pdf).from(element).save(filename + '.pdf')
                    .then(() => {
                        element.style.background = originalBg;
                        element.classList.remove('print-mode');
                    });
            },

            // Fast Preview (JPEG Snapshot) with Linearization (Batch 4.1)
            jpeg: function(elementId, callback, options = {}) {
                const source = document.getElementById(elementId);
                if(!source) return;

                // 1. Clone & Clean (WYSIWYG Capture)
                const clone = source.cloneNode(true);
                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                clone.classList.remove('editing-mode');
                
                // Capture Background
                clone.style.background = options.bg || window.getComputedStyle(source).backgroundColor;
                
                // 2. Linearization Logic (The "Paper" Transform)
                if (options.linearize) {
                    clone.classList.remove('grid-stack'); 
                    clone.style.height = 'auto';
                    clone.style.minHeight = 'auto';
                    clone.style.width = '1200px'; // Fixed width for consistent high-res render
                    clone.style.display = 'flex';
                    clone.style.flexDirection = 'column';
                    clone.style.gap = '24px';
                    clone.style.padding = '40px'; 
                    clone.style.overflow = 'visible';

                    // Select and Sort Items (Top-Left priority)
                    const items = Array.from(clone.querySelectorAll('.grid-stack-item'));
                    items.sort((a,b) => {
                        const yA = parseInt(a.getAttribute('gs-y')) || 0;
                        const yB = parseInt(b.getAttribute('gs-y')) || 0;
                        const xA = parseInt(a.getAttribute('gs-x')) || 0;
                        const xB = parseInt(b.getAttribute('gs-x')) || 0;
                        return yA - yB || xA - xB;
                    });

                    // Flatten Items
                    items.forEach(item => {
                        item.style.position = 'relative';
                        item.style.inset = 'auto';
                        item.style.width = '100%';
                        item.style.height = 'auto'; 
                        item.style.marginBottom = '20px';
                        item.style.border = '1px solid #000'; // Enforce strict border for standard look
                        item.style.boxShadow = 'none';
                        item.style.borderRadius = '0';

                        // Fix content scrolling & expansion
                        const content = item.querySelector('.grid-stack-item-content');
                        if(content) {
                            content.style.height = 'auto';
                            content.style.overflow = 'visible';
                            content.style.border = 'none'; // handled by wrapper
                            content.style.boxShadow = 'none';
                        }
                        
                        const body = item.querySelector('.widget-body');
                        if(body) {
                            body.style.height = 'auto';
                            body.style.overflow = 'visible';
                            // Expand textareas to fit content
                            body.querySelectorAll('textarea').forEach(ta => {
                                ta.style.height = (ta.scrollHeight + 20) + 'px';
                            });
                        }
                        clone.appendChild(item); // Re-append sorted
                    });
                } else {
                    // Graphic Mode: Respect original dimensions
                    const rect = source.getBoundingClientRect();
                    clone.style.width = source.scrollWidth + "px";
                    clone.style.height = source.scrollHeight + "px"; 
                }

                // 3. De-Clutter (Remove Dashboard Artifacts)
                const artifacts = [
                    '.widget-tools', 
                    '.ui-resizable-handle', 
                    'button:not(.permanent)', 
                    '.grid-stack-handle', 
                    '.widget-controls',
                    '.stage-remove-btn'
                ];
                clone.querySelectorAll(artifacts.join(',')).forEach(el => el.remove());

                // 4. Flatten Data (Inputs -> Text) & Copy Canvas
                clone.querySelectorAll('input').forEach(el => {
                    if(el.type !== 'hidden') {
                        const span = document.createElement('span');
                        span.textContent = el.value;
                        span.className = el.className;
                        span.style.border = 'none';
                        span.style.background = 'transparent';
                        span.style.padding = '0';
                        span.style.fontWeight = 'bold';
                        span.style.width = '100%';
                        span.style.color = '#000'; // Force black text
                        if(el.type === 'checkbox') span.textContent = el.checked ? '' : '';
                        el.parentNode.replaceChild(span, el);
                    }
                });
                
                clone.querySelectorAll('textarea').forEach(el => {
                    const div = document.createElement('div');
                    div.innerHTML = el.value.replace(/\n/g, '<br>');
                    div.className = el.className + ' whitespace-pre-wrap';
                    div.style.height = 'auto';
                    div.style.border = 'none';
                    div.style.resize = 'none';
                    div.style.background = 'transparent';
                    div.style.color = '#000'; // Force black text
                    el.parentNode.replaceChild(div, el);
                });
                
                // Canvas (MudMaps) - Must manually copy data
                const origCanvases = source.querySelectorAll('canvas');
                const cloneCanvases = clone.querySelectorAll('canvas');
                origCanvases.forEach((orig, i) => {
                    if(cloneCanvases[i]) {
                        cloneCanvases[i].width = orig.width;
                        cloneCanvases[i].height = orig.height;
                        const ctx = cloneCanvases[i].getContext('2d');
                        ctx.drawImage(orig, 0, 0);
                    }
                });

                // 5. Capture
                document.body.appendChild(clone);
                
                html2canvas(clone, { 
                    scale: 2, // Retina quality
                    useCORS: true, 
                    logging: false,
                    backgroundColor: null // Transparent base to respect clone background
                }).then(canvas => {
                    document.body.removeChild(clone);
                    if (callback) callback(canvas.toDataURL('image/jpeg', 0.9));
                }).catch(err => {
                    console.error("Snapshot Failed", err);
                    document.body.removeChild(clone);
                });
            },
            
            // Digital Export (Standalone HTML)
            htmlStandalone: function(elementId, title) {
                const source = document.getElementById(elementId);
                if(!source) return mBTME.alert("Export Error", "Content source missing.");

                // 1. Clone & Clean
                const clone = source.cloneNode(true);
                clone.classList.remove('editing-mode');
                
                // Remove UI artifacts
                clone.querySelectorAll('button, .widget-controls, .grid-stack-handle, .ui-resizable-handle').forEach(el => el.remove());
                
                // Linearize GridStack (Convert absolute grid to vertical stack for reliability)
                clone.querySelectorAll('.grid-stack-item').forEach(item => {
                    item.style.position = 'relative';
                    item.style.left = 'auto';
                    item.style.top = 'auto';
                    item.style.width = '100%';
                    item.style.height = 'auto';
                    item.style.marginBottom = '24px';
                    const content = item.querySelector('.grid-stack-item-content');
                    if(content) content.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
                });
                const gridContainer = clone.querySelector('.grid-stack');
                if(gridContainer) {
                    gridContainer.style.height = 'auto';
                    gridContainer.className = 'flex flex-col'; // Remove grid-stack class
                }

                // Flatten Inputs to Read-Only Text
                clone.querySelectorAll('input, select').forEach(el => {
                    const span = document.createElement('span');
                    span.textContent = el.value;
                    span.className = el.className;
                    // Reset input styles
                    span.style.border = 'none';
                    span.style.background = 'transparent';
                    span.style.display = 'inline-block';
                    span.style.width = 'auto';
                    if(el.type === 'date' && el.value) span.textContent = new Date(el.value).toLocaleDateString();
                    el.parentNode.replaceChild(span, el);
                });

                clone.querySelectorAll('textarea').forEach(el => {
                    const div = document.createElement('div');
                    div.innerHTML = el.value.replace(/\n/g, '<br>');
                    div.className = el.className + ' whitespace-pre-wrap';
                    div.style.height = 'auto';
                    div.style.border = 'none';
                    div.style.resize = 'none';
                    el.parentNode.replaceChild(div, el);
                });

                // 2. Build Standalone Shell
                // Note: Script tags are escaped to prevent browser parsing errors in the main app
                const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${mBT.ui.render.esc(title)}</title>
    \x3Cscript src="https://cdn.tailwindcss.com">\x3C/script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; padding: 20px; }
        .grid-stack-item-content { background: white; border-radius: 16px; overflow: hidden; border: 1px solid #e5e7eb; }
        .widget-header { background: #f9fafb; padding: 12px; border-bottom: 1px solid #f3f4f6; font-weight: 900; text-transform: uppercase; font-size: 11px; letter-spacing: 1px; color: #9ca3af; }
        .widget-body { padding: 16px; }
    </style>
</head>
<body>
    <div class="max-w-3xl mx-auto">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-black uppercase tracking-tighter text-slate-900">${mBT.ui.render.esc(title)}</h1>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-2">MooBudget Digital Export</p>
        </div>
        ${clone.innerHTML}
        <div class="mt-12 text-center text-[10px] text-slate-300 font-bold uppercase tracking-widest">
            Generated by MooBudget Tool
        </div>
    </div>
</body>
</html>`;

                // 3. Export
                const blob = new Blob([html], { type: 'text/html' });
                mBTPublisher.io.forceDownload(blob, `${title.replace(/\s+/g, '_')}_Digital.html`);
            },

            // --- RESTORED: Professional Typesetter Engine (v19.50 Logic) ---
            professionalPdf: function(budgetData, options = {}) {
                if (typeof window.jspdf === 'undefined') return mBTME.alert("Error", "PDF Engine missing.");
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF(mBTPublisher.config.pdf.jsPDF);
                const currency = displayCurrency || 'JMD';
                const fmt = (val) => mBTLE.format.currency(val, currency);

                // --- 1. Header & Meta ---
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text((budgetData.projectName || "Untitled Production").toUpperCase(), 105, 15, { align: "center" });
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`${budgetData.company || "Independent"} | Date: ${new Date().toLocaleDateString()}`, 105, 22, { align: "center" });

                // --- 2. Executive Summary ---
                const summaryData = [
                    ["Subtotal", fmt(budgetData.subtotal)],
                    [`Contingency (${budgetData.contingencyPercentage}%)`, fmt(budgetData.subtotal * (budgetData.contingencyPercentage/100))],
                    [`Sales Tax (${budgetData.salesTaxPercentage}%)`, fmt(budgetData.subtotal * (budgetData.salesTaxPercentage/100))],
                    [`Discount (${budgetData.discountPercentage}%)`, `-${fmt(budgetData.subtotal * (budgetData.discountPercentage/100))}`],
                    [{content: "GRAND TOTAL", styles: {fontStyle: 'bold', fillColor: [240, 253, 244]}}, {content: fmt(budgetData.grandTotal), styles: {fontStyle: 'bold', textColor: [21, 128, 61]}}] // Emerald-700
                ];

                doc.autoTable({
                    startY: 30,
                    head: [['Financial Summary', 'Amount']],
                    body: summaryData,
                    theme: 'grid',
                    headStyles: { fillColor: [15, 23, 42], textColor: 255, fontStyle: 'bold' }, // Slate-900
                    columnStyles: { 0: { cellWidth: 140 }, 1: { cellWidth: 'auto', halign: 'right' } },
                    margin: { left: 14, right: 14 }
                });

                // --- 3. Detailed Line Items ---
                let finalY = doc.lastAutoTable.finalY + 10;
                
                const bodyRows = [];
                
                Object.entries(budgetData.sections).forEach(([secName, sec]) => {
                    // Section Header Row
                    bodyRows.push([{ content: secName.toUpperCase(), colSpan: 5, styles: { fillColor: [241, 245, 249], fontStyle: 'bold', textColor: [71, 85, 105] } }]); // Slate-100/600
                    
                    sec.items.forEach(item => {
                        const total = parseFloat(item.total) || 0;
                        const rate = parseFloat(item.rate) || 0;
                        const qty = parseFloat(item.quantity) || 0;
                        
                        bodyRows.push([
                            item.description,
                            qty,
                            item.unit,
                            fmt(rate),
                            fmt(total)
                        ]);
                    });
                    
                    // Section Footer
                    bodyRows.push([{ content: `Total ${secName}: ${fmt(sec.total)}`, colSpan: 5, styles: { halign: 'right', fontStyle: 'bold', textColor: [37, 99, 235] } }]); // Blue-600
                });

                doc.autoTable({
                    startY: finalY,
                    head: [['Description', 'Qty', 'Unit', 'Rate', 'Total']],
                    body: bodyRows,
                    theme: 'plain',
                    styles: { fontSize: 9, cellPadding: 2 },
                    headStyles: { fillColor: [51, 65, 85], textColor: 255 }, // Slate-700
                    columnStyles: {
                        0: { cellWidth: 'auto' },
                        1: { cellWidth: 15, halign: 'center' },
                        2: { cellWidth: 20, halign: 'center' },
                        3: { cellWidth: 30, halign: 'right' },
                        4: { cellWidth: 30, halign: 'right' }
                    },
                    margin: { left: 14, right: 14 },
                    didDrawPage: function (data) {
                        // Footer
                        const str = "Page " + doc.internal.getNumberOfPages();
                        doc.setFontSize(8);
                        doc.setTextColor(150);
                        const pageSize = doc.internal.pageSize;
                        const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                        doc.text(str, data.settings.margin.left, pageHeight - 10);
                        doc.text(`Generated by mooBudget v${APP_VERSION}`, pageSize.width - 14, pageHeight - 10, { align: 'right' });
                    }
                });

                // --- 4. Output ---
                const filename = `${(budgetData.projectName || 'Budget').replace(/[^a-z0-9]/gi, '_')}.pdf`;
                doc.save(filename);
            },

            // --- NEW: Champion Layout Engine (Strict A4) ---
            championCallSheet: function(docData) {
                const d = docData || {};
                const meta = d.meta || {};
                const contacts = d.contacts || {};
                const schedule = d.schedule || [];
                const cast = d.cast || [];
                const crew = d.crew || [];
                const locs = d.locations || [];
                
                // Helper: Time Format
                const t = (val) => val || '--:--';

                // 1. CSS (The "Champion" Style Definition)
                const css = `
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap');
                        .cs-body { font-family: 'Roboto Condensed', sans-serif; font-size: 10pt; color: #000; background: #fff; width: 210mm; min-height: 297mm; padding: 10mm; box-sizing: border-box; position: relative; }
                        .cs-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 10px; }
                        .cs-title { font-size: 24pt; font-weight: bold; text-transform: uppercase; line-height: 0.9; }
                        .cs-meta { font-size: 9pt; text-align: right; }
                        
                        .cs-grid-3 { display: grid; grid-template-columns: 1fr 1.5fr 1fr; gap: 10px; margin-bottom: 10px; font-size: 8pt; }
                        .cs-box { border: 1px solid #000; }
                        .cs-box-header { background: #000; color: #fff; font-weight: bold; padding: 2px 5px; text-transform: uppercase; font-size: 8pt; }
                        .cs-box-content { padding: 5px; }
                        
                        .cs-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 9pt; }
                        .cs-table th { background: #000; color: #fff; font-weight: bold; text-transform: uppercase; padding: 4px; border: 1px solid #000; text-align: left; }
                        .cs-table td { border: 1px solid #000; padding: 4px; vertical-align: top; }
                        .cs-row-grey { background: #eee; }
                        
                        .cs-banner { background: #000; color: #fff; font-weight: bold; text-align: center; padding: 3px; text-transform: uppercase; margin-bottom: 5px; font-size: 10pt; }
                        
                        .cs-weather { display: flex; justify-content: space-between; font-size: 8pt; }
                        
                        /* Density Utils */
                        .text-right { text-align: right; }
                        .text-center { text-align: center; }
                        .font-bold { font-weight: bold; }
                        .w-10 { width: 10%; }
                    </style>
                `;

                // 2. HTML Structure (Mapped to Data)
                const html = `
                    <div class="cs-body">
                        <!-- HEADER -->
                        <div class="cs-header">
                            <div>
                                <div class="cs-title">${mBT.ui.render.esc(meta.productionTitle || 'UNTITLED PROJECT')}</div>
                                <div style="font-weight:bold; font-size:12pt;">CALL SHEET</div>
                            </div>
                            <div class="cs-meta">
                                <div><strong>Date:</strong> ${meta.shootDate || 'TBD'}</div>
                                <div><strong>Crew Call:</strong> ${meta.crewCallTime || '07:00'}</div>
                                <div style="margin-top:5px; font-size:12pt; font-weight:bold;">${mBTDB.calcShootDay(meta.shootDate)}</div>
                            </div>
                        </div>

                        <!-- TOP INFO GRID -->
                        <div class="cs-grid-3">
                            <!-- Left: Production -->
                            <div class="cs-box">
                                <div class="cs-box-header">Production Office</div>
                                <div class="cs-box-content">
                                    <strong>Director:</strong> ${contacts.director || 'TBD'}<br>
                                    <strong>Producer:</strong> ${contacts.producer || 'TBD'}<br>
                                    <strong>1st AD:</strong> ${contacts.ad || 'TBD'}<br>
                                    <br>
                                    ${meta.productionCompany || 'Indie Prod'}
                                </div>
                            </div>
                            
                            <!-- Center: Locations -->
                            <div class="cs-box">
                                <div class="cs-box-header">Locations</div>
                                <div class="cs-box-content">
                                    ${locs.map((l, i) => `
                                        <div style="margin-bottom:5px;">
                                            <strong>LOC ${i+1}:</strong> ${l.name}<br>
                                            ${l.address}<br>
                                            <em style="font-size:7pt">Nearest Hosp: ${l.hospital || 'Dial 911'}</em>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Right: Weather & Specs -->
                            <div class="cs-box">
                                <div class="cs-box-header">Conditions</div>
                                <div class="cs-box-content">
                                    <div class="cs-weather">
                                        <span>Sunrise: ${meta.sunriseSunset ? meta.sunriseSunset.split('/')[0] : '06:00'}</span>
                                        <span>Sunset: ${meta.sunriseSunset ? meta.sunriseSunset.split('/')[1] : '18:00'}</span>
                                    </div>
                                    <hr style="border:0; border-top:1px dashed #ccc; margin:4px 0;">
                                    ${locs[0] && locs[0].weather ? locs[0].weather : 'Sunny, 30C'}
                                </div>
                            </div>
                        </div>

                        <!-- SHOOTING SCHEDULE -->
                        <div class="cs-banner">Shooting Schedule</div>
                        <table class="cs-table">
                            <thead>
                                <tr>
                                    <th style="width:10%">Time</th>
                                    <th style="width:8%">Scn</th>
                                    <th style="width:8%">I/E</th>
                                    <th>Description / Action</th>
                                    <th style="width:15%">Cast</th>
                                    <th style="width:15%">Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${schedule.map((row, i) => {
                                    const isMeal = row.type === 'meal';
                                    if (isMeal) return `<tr class="cs-row-grey"><td class="text-center font-bold">${t(row.time)}</td><td colspan="5" class="text-center font-bold uppercase">${row.description}</td></tr>`;
                                    return `
                                    <tr>
                                        <td class="text-center font-bold">${t(row.time)}</td>
                                        <td class="text-center">${row.scene || '-'}</td>
                                        <td class="text-center">${row.ie || '-'}</td>
                                        <td><strong>${row.description || ''}</strong><br><em style="font-size:8pt">${row.note || ''}</em></td>
                                        <td class="text-center">${row.cast || ''}</td>
                                        <td class="text-center">${row.loc || '1'}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>

                        <!-- CAST LIST -->
                        <div class="cs-banner">Cast & Talent</div>
                        <table class="cs-table">
                            <thead>
                                <tr>
                                    <th>Character</th>
                                    <th>Artist</th>
                                    <th class="text-center">Pickup</th>
                                    <th class="text-center">H/MU</th>
                                    <th class="text-center">Costume</th>
                                    <th class="text-center">Set Call</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cast.map(c => `
                                    <tr>
                                        <td><strong>${c.character}</strong></td>
                                        <td>${c.actor}</td>
                                        <td class="text-center">${t(c.pickup)}</td>
                                        <td class="text-center">${t(c.hmu)}</td>
                                        <td class="text-center">${t(c.costume)}</td>
                                        <td class="text-center font-bold">${t(c.setCall)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <!-- FOOTER -->
                        <div style="position: absolute; bottom: 10mm; width: 100%; border-top: 1px solid #000; padding-top:5px; font-size:8pt; text-align:center;">
                            PRODUCED BY: ${meta.productionCompany || 'Indie Prod'} | RECYCLE BIN: Please destroy this document after use.
                        </div>
                    </div>
                `;

                // 3. Render
                const win = window.open('', '_blank');
                win.document.write('<html><head><title>Call Sheet</title>' + css + '</head><body>' + html + '</body></html>');
                win.document.close();
                setTimeout(() => win.print(), 500);
            },

            professionalXlsx: function(budgetData) {
                if (typeof XLSX === 'undefined') return mBTME.alert("Error", "Excel Engine missing.");
                
                // 1. Setup Workbook
                const wb = XLSX.utils.book_new();
                const wsData = [];
                
                // 2. Headers
                wsData.push(["PROJECT", budgetData.projectName]);
                wsData.push(["COMPANY", budgetData.company]);
                wsData.push(["DATE", new Date().toLocaleDateString()]);
                wsData.push([]); // Spacer
                
                // 3. Summary
                wsData.push(["SUMMARY", "AMOUNT"]);
                wsData.push(["Subtotal", budgetData.subtotal]);
                wsData.push(["Contingency", budgetData.subtotal * (budgetData.contingencyPercentage/100)]);
                wsData.push(["Grand Total", budgetData.grandTotal]);
                wsData.push([]); 

                // 4. Detail Table Headers
                wsData.push(["SECTION", "DESCRIPTION", "QUANTITY", "UNIT", "RATE", "ESTIMATED", "ACTUAL", "VARIANCE"]);

                // 5. Populate Data
                Object.entries(budgetData.sections).forEach(([key, sec]) => {
                    // Section Header
                    wsData.push([key.toUpperCase(), "", "", "", "", "", "", ""]);
                    
                    sec.items.forEach(item => {
                        const qty = parseFloat(item.quantity) || 0;
                        const rate = parseFloat(item.rate) || 0;
                        const est = qty * rate;
                        const act = parseFloat(item.actual) || 0;
                        
                        wsData.push([
                            "", 
                            item.description, 
                            qty, 
                            item.unit, 
                            rate, 
                            est, // Formula could go here but raw numbers are safer for broad compatibility
                            act, 
                            act - est
                        ]);
                    });
                    // Section Footer spacer
                    wsData.push([]);
                });

                // 6. Generate Sheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Set Column Widths
                ws['!cols'] = [{wch:15}, {wch:40}, {wch:10}, {wch:10}, {wch:15}, {wch:15}, {wch:15}, {wch:15}];

                XLSX.utils.book_append_sheet(wb, ws, "Budget");
                XLSX.writeFile(wb, `${(budgetData.projectName||'budget').replace(/\s+/g, '_')}.xlsx`);
            },
        },

        // --- Bridge: Main Entry Points ---
        exportToPDF: function(id, name) { this.format.pdf(id, name); },
        toMoo: function() { this.io.saveMoo(budget); },
        
        // Logic Resolution: Adapter for Batch 4.1 Linearization (Standard vs Graphic)
        generateFastPreview: function(mode, data, cb) { 
            const opts = (mode === 'standard') ? { linearize: true, bg: '#ffffff' } : {};
            this.format.jpeg('mBTDB_Workspace', cb, opts); 
        }, 
        
        downloadJPEG: function(url, title) {
            const a = document.createElement('a'); a.href = url; a.download = `${title}.jpg`; a.click();
        }
    };

/* ========= v19.54 mBTDB: STUDIO BUILDER ENGINE ========= */
window.mBTDB = {
    state: { currentDocId: null, isEditing: false, grid: null, history: [], historyPointer: -1, _cache: null },
    
    // --- LIVE SYNC ENGINE (Phase 9) ---
    resolveLinkedData: function(doc) {
        // Optimization: Return cached deeply-cloned data if available for this render cycle
        // This prevents expensive JSON operations on purely visual updates (like toggling Edit Mode)
        if (this.state._cache && this.state._cache.docId === doc.id) {
            return this.state._cache.data;
        }

        // Deep clone to prevent render-cycle mutations from polluting storage
        const data = JSON.parse(JSON.stringify(doc.content.data));
        
        if (!budget || !budget.sections) {
            // Cache even if no budget link exists
            this.state._cache = { docId: doc.id, data: data };
            return data;
        }

        // Fast Lookup Map
        const budgetMap = new Map();
        Object.values(budget.sections).forEach(sec => {
            sec.items.forEach(i => budgetMap.set(i.id, i));
        });

        // 1. Sync Lists (Crew, Cast)
        ['crew', 'cast'].forEach(key => {
            if (Array.isArray(data[key])) {
                data[key] = data[key].map(item => {
                    if (item.linkedItemId && budgetMap.has(item.linkedItemId)) {
                        const bItem = budgetMap.get(item.linkedItemId);
                        if (key === 'crew') {
                            item.name = bItem.crew?.name || bItem.description;
                            item.contact = bItem.crew?.phone || item.contact;
                            item.position = bItem.description; 
                        } else if (key === 'cast') {
                            item.actor = bItem.crew?.name || item.actor;
                            item.contact = bItem.crew?.phone || item.contact;
                        }
                    }
                    return item;
                });
            }
        });

        // Store in cache
        this.state._cache = { docId: doc.id, data: data };
        return data;
    },

    // --- 1. Registry Resolution: Tier 1 Asset Map ---
    icons: {
        trash: mBTAssets.trash, plus: mBTAssets.plus, user: mBTAssets.user,
        cloud: mBTAssets.cloud, save: mBTAssets.save, undo: mBTAssets.undo,
        redo: mBTAssets.redo, copy: mBTAssets.copy, print: mBTAssets.print,
        close: mBTAssets.close, wand: mBTAssets.wand, grid: mBTAssets.grid,
        list: mBTAssets.list, image: mBTAssets.image
    },
  
    // Logic Resolution: Template Registry migrated to mBTOG (Open Gate)
    // We clear this local object to enforce the Single Source of Truth rule.
    templates: {}, 

    // --- 2. Portal Orchestration ---
    open: function(docId) {
        this.state.currentDocId = docId;
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc) return;
        if (!doc.content) doc.content = { data: {}, widgets: [] };
        
        // Logic Resolution: Auto-Hydrate from Central Registry (Open Gate)
        if (!doc.content.widgets || doc.content.widgets.length === 0) {
            // Tier 2.5 Handshake: Pull blueprints from Open Gate
            const registry = (typeof mBTOG !== 'undefined' && mBTOG.templates) ? mBTOG.templates : [];
            let tmpl = registry.find(t => t.id === doc.type);
            
            // Fallback Heuristics for Legacy Types
            if (!tmpl) {
                if (['storyboard','budgetRep','vendorBid','riskAI','carbon','postSched'].includes(doc.type)) {
                    // Map legacy complex types to Script defaults if specific template missing
                    tmpl = registry.find(t => t.id === 'script'); 
                }
                // Ultimate Fallback
                if (!tmpl) tmpl = { widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }] };
            }
            
            doc.content.widgets = JSON.parse(JSON.stringify(tmpl.widgets));
            if(!doc.content.data.meta) doc.content.data = this._generateDefaultData();
        }

        if(typeof mBTME !== 'undefined') {
            // Logic Resolution: Fixed ID string to match the close() function target
            mBTME.open('documentViewer', 'Document Studio', '<div id="mBTDB_Container"></div>', 'w-full h-full max-w-full', { noPadding: true, hideHeader: true });
            this.renderFrame();
        }
    },
    close: function() {
        if (this.state.isEditing) {
            this._saveLayoutState();
            this.state.isEditing = false;
        }
        if (typeof mBTME !== 'undefined') mBTME.close('documentViewerModal');
        document.body.classList.remove('print-mode');
        this.state.currentDocId = null;
        if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
        if (typeof render === 'function') render();
    },

    toggleEditMode: function() {
        if (this.state.isEditing && this.state.grid) this._saveLayoutState();
        this.state.isEditing = !this.state.isEditing;
        const container = document.getElementById('mBTDB_Workspace');
        const grid = this.state.grid;
        if (container && grid) {
            if (this.state.isEditing) {
                container.classList.add('editing-mode');
                grid.setStatic(false);
            } else {
                container.classList.remove('editing-mode');
                grid.setStatic(true);
            }
            
            // CRITICAL FIX: Re-render UI to update 'disabled' state on inputs
            const doc = budget.documents.find(d => d.id === this.state.currentDocId);
            if (doc) {
                this._renderMetaHeader(doc);
                doc.content.widgets.forEach(w => {
                    const el = document.querySelector(`.grid-stack-item[gs-id="${w.id}"] .widget-body`);
                    if(el) el.innerHTML = this._getContentForWidget(w, doc);
                });
                // Re-init canvas logic for MudMaps after re-render
                this._initMudMaps();
            }

            this._updateHeaderButtons();
        }
    },
    _saveLayoutState: function() {
        if (!this.state.grid) return;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        this.state.grid.engine.nodes.forEach(node => {
            const widget = doc.content.widgets.find(w => w.id === node.id);
            if (widget) { widget.x = node.x; widget.y = node.y; widget.w = node.w; widget.h = node.h; }
        });
        this._triggerSave();
        mBT.data.save(); // Force disk commit
    },

    // --- 3. Publishing & Intelligence Hub ---
    openPreviewSelector: function() {
        const content = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-6 bg-slate-50">
                <button onclick="mBTME.close('previewSelectorModal'); mBTDB.previewDoc('standard')" class="flex flex-col items-center gap-4 p-6 bg-white border border-slate-200 rounded-3xl hover:border-blue-500 hover:shadow-xl transition-all group text-center w-full">
                    <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                        ${mBTAssets.file}
                    </div>
                    <div>
                        <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">Industry Standard</h4>
                        <p class="text-[9px] text-slate-400 font-bold mt-1">Clean White  High Contrast</p>
                    </div>
                </button>

                <button onclick="mBTME.close('previewSelectorModal'); mBTDB.previewDoc('graphic')" class="flex flex-col items-center gap-4 p-6 bg-white border border-slate-200 rounded-3xl hover:border-purple-500 hover:shadow-xl transition-all group text-center w-full">
                    <div class="w-14 h-14 bg-purple-50 text-purple-600 rounded-2xl flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                        ${mBTAssets.image}
                    </div>
                    <div>
                        <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">Graphic Layout</h4>
                        <p class="text-[9px] text-slate-400 font-bold mt-1">Workspace Grey  Original UI</p>
                    </div>
                </button>
            </div>`;
        
        mBTME.open('previewSelector', 'Capture Mode', content, 'max-w-lg', { noPadding: true });
    },

    previewDoc: function(mode) {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        if (!doc || typeof mBTPublisher === 'undefined') return;
        
        const workspace = document.getElementById('mBTDB_Workspace');
        if(!workspace) return;

        // Logic Resolution: For 'standard' mode, we temporarily strip the workspace grey 
        // to ensure a high-contrast white paper export.
        if (mode === 'standard') {
            workspace.classList.remove('bg-slate-200');
            workspace.classList.add('bg-white');
        }

        if(mBTME.showLoader) mBTME.showLoader(`Rendering ${mode === 'standard' ? 'Industry' : 'Graphic'} Preview...`);
        
        mBTPublisher.generateFastPreview(mode, doc.content.data, (jpegURL) => {
            // Restore visual separation state
            if (mode === 'standard') {
                workspace.classList.remove('bg-white');
                workspace.classList.add('bg-slate-200');
            }

            if(mBTME.hideLoader) mBTME.hideLoader();
            mBTME.open('previewModal', `Snapshot: ${mode.toUpperCase()}`,
                `<div class="flex flex-col items-center bg-slate-900 h-full p-8 overflow-auto no-scrollbar"><img src="${jpegURL}" id="finalPreviewImage" class="shadow-2xl border border-black max-w-full h-auto mb-24 bg-white rounded-sm"><div class="fixed bottom-10 left-1/2 -translate-x-1/2 flex gap-4 z-[10001]"><button onclick="mBTPublisher.downloadJPEG('${jpegURL}', '${doc.label}')" class="flex items-center gap-3 bg-blue-600 text-white px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-blue-500 transition-all active:scale-95">Download JPEG</button><button onclick="mBTDB.sendToDistribution('${jpegURL}')" class="flex items-center gap-3 bg-emerald-600 text-white px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-emerald-500 transition-all active:scale-95">Send to Crew</button><button onclick="mBTME.close('previewModal')" class="bg-white text-slate-900 px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-slate-100 transition-all">Close</button></div></div>`, 'w-full h-full');
        });
    },

    sendToDistribution: function(jpegURL) {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        // Logic Resolution: Close only the preview modal, keeping the Studio active
        mBTME.close('previewModal'); 
        if(window.openDocumentShareSelector) window.openDocumentShareSelector(doc.id);
        else mBTME.alert("Module Error", "Distribution Hub not active.");
    },

    // --- NEW: AI Hospital Lookup ---
    autoFillHospital: async function(docId, index, address) {
        if (!address) return;
        const provider = mBT.features.ai.getSelectedProvider();
        const apiKey = mBT.features.ai.getStoredApiKey(provider);
        if (!apiKey) return; // Silent skip if no AI

        const prompt = `Identify the nearest emergency hospital to this address: "${address}". Return ONLY the name of the hospital. Do not include address or other text.`;
        
        try {
            const result = await mBT.features.ai.callUnifiedAI(provider, apiKey, prompt);
            // Cleanup response
            const clean = result.replace(/Here is the.*?|The nearest.*?is/gi, '').replace(/[".]/g, '').trim();
            this.updateRow(docId, 'locations', index, 'hospital', clean);
        } catch (e) { console.warn("AI Hospital Lookup failed", e); }
    },

    /* --- [Feat16]. Mud Map Intelligence (Geocoding Engine) --- */
    getCoordinates: async function(query) {
        if (!query) return null;
        try {
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1&language=en&format=json`);
            const data = await res.json();
            if (data.results && data.results.length > 0) {
                return { lat: data.results[0].latitude, lon: data.results[0].longitude };
            }
        } catch (e) { console.error("Geocoding failed", e); }
        return null;
    },

    /* --- [Feat16]. Mud Map Intelligence (Slate Generator) --- */
    loadMapBackground: async function(widgetId, docId) {
        const doc = budget.documents.find(d => d.id === docId);
        if(!doc) return;
        
        // 1. Find Context (First Location)
        const loc = doc.content.data.locations?.[0];
        const query = loc ? (loc.address || loc.name) : "";
        
        if(!query) return mBTME.alert("Map Error", "No location address found in Logistics.");
        
        mBTME.showLoader("Locating Site...");
        
        // 2. Geocode (Using logic from Batch 2.1)
        const coords = await this.getCoordinates(query);
        mBTME.hideLoader();
        
        if(!coords) return mBTME.alert("Not Found", "Could not locate address.");
        
        // 3. Generate Site Slate (Canvas Ops)
        const cvs = document.getElementById(`canvas_${widgetId}`);
        if(cvs) {
            const ctx = cvs.getContext('2d');
            const w = cvs.width;
            const h = cvs.height;
            
            // A. Background & Grid
            ctx.fillStyle = "#f8fafc"; // Slate-50
            ctx.fillRect(0, 0, w, h);
            
            ctx.strokeStyle = "#e2e8f0"; // Slate-200
            ctx.lineWidth = 1;
            for(let x=20; x<w; x+=40) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
            for(let y=20; y<h; y+=40) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
            
            // B. Header Block
            ctx.fillStyle = "#0f172a"; // Slate-900
            ctx.fillRect(0, 0, w, 60);
            
            ctx.fillStyle = "#ffffff";
            ctx.font = "bold 14px 'Arial', sans-serif";
            ctx.fillText("SITE PLAN / MUD MAP", 15, 25);
            
            ctx.font = "10px 'Arial', sans-serif";
            ctx.fillStyle = "#94a3b8";
            ctx.fillText(`LOC: ${loc.name.toUpperCase()}`, 15, 45);
            
            // C. GPS Watermark
            ctx.fillStyle = "#475569";
            ctx.font = "bold 12px 'Courier New', monospace";
            ctx.fillText(`ADDR: ${query}`, 15, 80);
            ctx.fillText(`GPS:  ${coords.lat.toFixed(6)}, ${coords.lon.toFixed(6)}`, 15, 95);
            
            // D. Compass Icon
            ctx.strokeStyle = "#cbd5e1";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(w-40, 90, 20, 0, 2*Math.PI);
            ctx.stroke();
            
            ctx.fillStyle = "#64748b";
            ctx.font = "bold 12px Arial";
            ctx.fillText("N", w-44, 94);
            
            // 4. Save to State (Persist as Image Data)
            this.updateData(docId, `additional.${widgetId}`, cvs.toDataURL());
        }
    },

    autoFillWidget: function(type, docId) {
        mBTME.confirm("Auto-Fill", `Auto-fill ${type}? This uses external services and AI.`, async () => {
            const doc = budget.documents.find(d => d.id === docId);
            if(!doc) return;

            if(type === 'contacts') {
                const map = { 'director': 'Director', 'producer': 'Producer', 'ad': '1st AD' };
                Object.entries(map).forEach(([key, role]) => {
                    let hit = null;
                    if(budget.sections) Object.values(budget.sections).some(s => {
                        const i = s.items.find(x => x.description.toLowerCase().includes(role.toLowerCase()) && x.crew && x.crew.name);
                        if(i) { hit = { name: i.crew.name, contact: i.crew.phone || i.crew.email }; return true; }
                    });
                    if(!hit) {
                        const g = mBTOG.contacts.find(x => x.role && x.role.toLowerCase().includes(role.toLowerCase()));
                        if(g) hit = { name: g.name, contact: g.contact || g.phone };
                    }
                    if(hit) this.updateData(docId, `contacts.${key}`, `${hit.name} ${hit.contact||''}`);
                });
            } else if(type === 'crew') {
                Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                    if(i.crew && i.crew.name) {
                        const exists = doc.content.data.crew.some(c => c.name === i.crew.name && c.department === i.description);
                        if(!exists) {
                            this.addRow(docId, 'crew', 'person', { department: i.description, name: i.crew.name, contact: i.crew.phone, linkedItemId: i.id });
                        }
                    }
                }));
            } 
            // --- NEW: Logistics / Locations Support ---
            else if (type === 'logistics' || type === 'locations') {
                const locs = doc.content.data.locations || [];
                mBTME.showLoader("Scanning Locations...");
                
                // Serial execution to prevent rate limiting
                for (let i = 0; i < locs.length; i++) {
                    const l = locs[i];
                    // 1. Weather & Sun (Open-Meteo Service)
                    if (l.name) await this.autoFillWeather(docId, i, l.name);
                    
                    // 2. Hospital (AI Analysis) - Only if address exists and hospital field is empty
                    if (l.address && !l.hospital) await this.autoFillHospital(docId, i, l.address);
                }
                mBTME.hideLoader();
            }
            
            // Logic Resolution: Use Surgical DOM Update instead of full RenderFrame() to preserve layout
            const widget = doc.content.widgets.find(w => w.type === type);
            if(widget) {
                const content = this._getContentForWidget(widget, doc);
                const el = document.querySelector(`.grid-stack-item[gs-id="${widget.id}"] .widget-body`);
                if(el) el.innerHTML = content;
                // Update Header Sun/Moon if modified
                if(type === 'logistics' || type === 'locations') this._renderMetaHeader(doc);
            } else {
                this.renderFrame();
            }
        });
    },

    neuralFill: async function(widgetId, docId) {
        const doc = budget.documents.find(d => d.id === docId);
        if(!doc) return;
        
        const widget = doc.content.widgets.find(w => w.id === widgetId);
        if(!widget) return;

        const provider = mBT.features.ai.getSelectedProvider();
        const apiKey = mBT.features.ai.getStoredApiKey(provider);
        
        if(!apiKey) return mBTME.alert("Assistant Offline", "Please configure API Key in settings to use Neural Fill.");

        // --- HYBRID ROUTER (Batch 3.1) ---
        const currentVal = doc.content.data.additional?.[widgetId] || "";
        const isScript = (doc.type === 'script' || widget.label.toLowerCase().includes('script')) && widget.type === 'richText';

        // ROUTE 1: SCRIPT PARSING (Structure Extraction)
        // Trigger: Script document + RichText widget + Content > 50 chars
        if (isScript && currentVal.length > 50) {
            mBTME.confirm("Script Analysis", "Analyze script text to extract Scenes and Cast data?", async () => {
                mBTME.showLoader("Analyzing Screenplay...");
                const prompt = `Analyze this screenplay text. Return valid JSON only. No markdown. 
                Structure: { "scenes": ["INT. LOCATION - DAY", ...], "cast": ["CHARACTER NAME", ...] }. 
                Text: \n\n ${currentVal.substring(0, 15000)}`; 
                
                try {
                    const result = await mBT.features.ai.callUnifiedAI(provider, apiKey, prompt, "ROLE: Data Parser. OUTPUT: Pure JSON. No chat.");
                    // Sanitize AI output (strip markdown code blocks)
                    const jsonStr = result.replace(/^```json\n?|```$/g, '').trim();
                    const data = JSON.parse(jsonStr);
                    
                    let report = `Extracted ${data.scenes?.length || 0} Scenes and ${data.cast?.length || 0} Characters.\n`;
                    let updates = 0;

                    // 1. Sync Schedule (Scenes)
                    if (data.scenes && Array.isArray(data.scenes)) {
                        if(!doc.content.data.schedule) doc.content.data.schedule = [];
                        data.scenes.forEach(sc => {
                            // Dedupe: Check if description matches
                            if (!doc.content.data.schedule.some(s => s.description === sc)) {
                                const parts = sc.split('-');
                                const loc = parts[0] ? parts[0].replace(/INT\.|EXT\./i, '').trim() : '';
                                
                                mBTDB.addRow(docId, 'schedule', 'shot', { 
                                    id: Date.now() + Math.random(), 
                                    description: sc, 
                                    scene: (doc.content.data.schedule.length + 1).toString(), 
                                    time: "00:00", 
                                    ie: sc.toUpperCase().includes("INT") ? "INT" : "EXT", 
                                    loc: loc,
                                    cast: "" 
                                });
                                updates++;
                            }
                        });
                    }
                    
                    // 2. Sync Cast (Characters)
                    if (data.cast && Array.isArray(data.cast)) {
                        if(!doc.content.data.cast) doc.content.data.cast = [];
                        data.cast.forEach(c => {
                            if (!doc.content.data.cast.some(existing => existing.character === c)) {
                                mBTDB.addRow(docId, 'cast', 'talent', { 
                                    id: Date.now() + Math.random(), 
                                    character: c, 
                                    actor: "", swf: "W", pickup: "", hmu: "", setCall: "", costume: "" 
                                });
                                updates++;
                            }
                        });
                    }
                    
                    mBTME.hideLoader();
                    if(updates > 0) {
                        mBTDB.renderFrame(); // Refresh UI to show new rows
                        mBTME.alert("Analysis Complete", report + `\n${updates} items added to lists.`);
                    }
                    else mBTME.alert("Analysis Complete", "No new items found to add.");
                    
                } catch (e) {
                    mBTME.hideLoader();
                    mBTME.alert("Parsing Error", "AI response could not be mapped to data structure.");
                    console.error(e);
                }
            });
            return;
        }

        // ROUTE 2: CONTENT GENERATION (Creative)
        mBTME.showLoader("Generating Content...");
        let prompt = "";
        
        if (widget.type === 'footer') {
             // Safety Footer Specific Logic
             const locSetting = (typeof mBTOG !== 'undefined' && mBTOG.settings) ? mBTOG.settings.location : 'Jamaica';
             const prodAddr = doc.content.data.production?.address || "";
             const locationContext = prodAddr.length > 5 ? `Production Address: ${prodAddr}` : `Jurisdiction: ${locSetting}`;
             
             prompt = `Generate a professional film production call sheet footer. 
             CONTEXT: ${locationContext}. 
             REQUIREMENTS: 
             1. Include a Health & Safety Disclaimer referencing specific local acts (e.g., "Health and Safety at Work Act 1974" for UK, "Factories Act" for Jamaica, "OSHA" for USA). Pick the one matching the context.
             2. Include a strict Anti-Harassment/Bullying Policy statement with a placeholder for a contact number.
             3. Keep it concise, serious, legalistic, and formatted as a compact block. No markdown, just text.`;
        } else if (isScript) {
             // Empty Script Generation
             prompt = `Write a sample screenplay scene for a film titled "${budget.projectName}". Format: Standard Screenplay format (Scene Heading, Action, Character, Dialogue). Keep it short (1 page).`;
        } else {
             // General Logic
             prompt = `Generate content for a section labeled "${widget.label}" for a film production named "${budget.projectName}" (${doc.label}). Context: Film Production. Keep it professional and concise.`;
        }

        try {
            const result = await mBT.features.ai.callUnifiedAI(provider, apiKey, prompt);
            
            // Logic Resolution: Sanitize output (remove markdown code fences if AI adds them)
            const cleanResult = result.replace(/^```[a-z]*\n|```$/g, '').trim();
            
            this.updateData(docId, `additional.${widgetId}`, cleanResult);
            mBTME.hideLoader();
            
            // Surgical update to avoid grid flicker
            const el = document.querySelector(`.grid-stack-item[gs-id="${widgetId}"] .widget-body textarea`);
            if(el) el.value = cleanResult;
            else this.renderFrame(); // Fallback if DOM lost
            
        } catch (e) {
            mBTME.hideLoader();
            mBTME.alert("Generation Failed", e.message);
        }
    },

    autoFillWeather: async function(docId, index, name) {
        const btn = document.getElementById(`w-btn-${index}`);
        if(btn) btn.innerHTML = `<span class="animate-spin inline-block">...</span>`;
        try {
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`);
            const geo = await geoRes.json();
            if(!geo.results) throw new Error("Location not found");
            const { latitude, longitude } = geo.results[0];
            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`);
            const wData = await wRes.json();
            const today = wData.daily;
            const code = today.weather_code[0];
            let summary = "Clear Skies"; if(code > 3) summary = "Cloudy"; if(code > 50) summary = "Rainy";
            
            const sunrise = today.sunrise[0].split('T')[1];
            const sunset = today.sunset[0].split('T')[1];
            
            const str = `${summary} | Max: ${today.temperature_2m_max[0]}C / Min: ${today.temperature_2m_min[0]}C\nSunrise: ${sunrise} / Sunset: ${sunset}`;
            
            // Logic Fix: Sync Sunrise/Sunset to Header
            this.updateData(docId, 'meta.sunriseSunset', `${sunrise}/${sunset}`);
            this.updateRow(docId, 'locations', index, 'weather', str);
            
            this.renderFrame();
        } catch(e) { mBTME.alert("Sync Error", "Weather Synchronization Failure"); if(btn) btn.innerHTML = this.icons.cloud; }
    },

    // --- NEW: Header Sync Logic ---
    syncProductionInfo: function(docId) {
        // 1. Search Open Gate for "Production Office" contact
        const contact = mBTOG.contacts.find(c => c.name.toLowerCase().includes('production office'));
        
        if (contact) {
            const data = {
                address: contact.address || '', 
                phone: contact.phone || '',
                email: contact.email || '',
                wifi: contact.wifi || '',
                pass: contact.pass || ''
            };
            
            // Batch update manually to avoid multiple re-renders
            const doc = budget.documents.find(d => d.id === docId);
            if(doc) {
                if(!doc.content.data.production) doc.content.data.production = {};
                Object.assign(doc.content.data.production, data);
                this._triggerSave();
                this.renderFrame();
                mBTME.alert("Synced", "Production Office details updated from Open Gate.");
            }
        } else {
            // Fallback: Use Budget Company Name
            this.updateData(docId, 'production.address', budget.company || '');
            mBTME.alert("Partial Sync", "No 'Production Office' contact found in Open Gate. Synced Company Name.");
        }
    },

    syncAgencyInfo: function(docId) {
        // Search Open Gate for Agency roles
        const producer = mBTOG.contacts.find(c => c.role && (c.role.toLowerCase().includes('agency producer') || c.role.toLowerCase().includes('client')));
        const creative = mBTOG.contacts.find(c => c.role && (c.role.toLowerCase().includes('creative') || c.role.toLowerCase().includes('director')));
        
        let updates = 0;
        if(producer) { this.updateData(docId, 'agency.producer', producer.name); updates++; }
        if(creative) { this.updateData(docId, 'agency.creative', creative.name); updates++; }
        
        if(updates > 0) this.renderFrame();
        else mBTME.alert("No Matches", "No contacts with 'Agency' or 'Client' roles found.");
    },

    // --- 4. Render Engine Handshake ---
    renderFrame: function() {
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const container = document.getElementById('mBTDB_Container');
        if(!container) return;

        // Standardized Studio Actions
        const actions = [
            { icon: mBTAssets.sync, title: "Sync Budget", onClick: "mBTDB.syncFromBudget()", color: "emerald" },
            { icon: mBTAssets.refresh, title: "Sync Previous", onClick: "mBTDB.syncFromPrevious()", color: "blue" },
            { icon: mBTAssets.image, title: "Preview", onClick: "mBTDB.previewDoc('standard')", color: "purple" },
            { icon: mBTAssets.close, title: "Close", onClick: "mBTDB.close()", color: "rose" }
        ];

        // --- NEW: Paper Protocol Structure ---
        const contentHtml = `
            <div class="sheet-workspace" id="mBTDB_ScrollArea">
                <div class="sheet-a4 cs-theme" id="mBTDB_Paper">
                    <!-- Embedded Header (Part of the Page) -->
                    <div id="mBTDB_MetaArea" class="mb-4"></div>
                    <!-- The Grid (Flexible Content) -->
                    <div class="grid-stack flex-grow"></div>
                    <!-- Footer Branding -->
                    <div class="mt-auto pt-4 border-t-2 border-slate-700 flex justify-between text-[8px] font-bold uppercase tracking-widest text-slate-500">
                        <span>${budget.company || 'Production Office'}</span>
                        <span>Generated by mooBudget</span>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = RenderEngine.layouts.studioPanel({
            title: `Studio: ${doc.label}`,
            searchId: 'mBTDB_Search',
            searchPlaceholder: 'SEARCH DOCUMENT...',
            contentId: 'mBTDB_Workspace',
            contentHtml: contentHtml,
            actions: actions,
            toolbarId: 'mBTDB_Buttons',
            containerClasses: 'p-0 overflow-hidden !bg-[#0f172a]' // Logic Resolution: Force Deep Slate Background
        });

        this._renderMetaHeader(doc);
        setTimeout(() => {
            if(typeof GridStack === 'undefined') return console.error("GridStack resolution failure.");
            const wrapper = document.getElementById('mBTDB_Workspace');
            // Re-apply editing class if state persisted
            if(this.state.isEditing) wrapper.classList.add('editing-mode');
            
            // Batch 2.1: Grid Physics Refinement
            // Reduced cellHeight (30px) for granular text matching. Increased margin for visual breathing room.
            this.state.grid = GridStack.init({ 
                column: 12, 
                cellHeight: 30, 
                minRow: 1, 
                margin: 5, 
                animate: true, 
                float: false, // Gravity Enabled (Widgets snap up)
                resizable: { handles: 'n,e,s,w,ne,se,sw,nw' },
                staticGrid: !this.state.isEditing 
            }, wrapper.querySelector('.grid-stack'));
            
            this._loadWidgetsToGrid(doc);
            this._updateHeaderButtons();
            this.state.grid.on('change', () => this._triggerSave());
            this._initMudMaps(); // Initialize canvases
        }, 50);
    },

    _loadWidgetsToGrid: function(doc) {
        const grid = this.state.grid; grid.removeAll(); grid.batchUpdate();
        doc.content.widgets.forEach(w => { if(w.type === 'header') return; grid.addWidget({ x: w.x, y: w.y, w: w.w, h: w.h, content: this._generateWidgetHTML(w, doc), id: w.id }); });
        grid.commit();
    },
    _generateWidgetHTML: function(widget, doc) {
        const cleanTitle = widget.label || (widget.type.charAt(0).toUpperCase() + widget.type.slice(1));
        
        let tools = ''; 
        if(widget.type === 'contacts') {
            tools += `<button type="button" aria-label="Toggle View" data-action="widget-toggle-view" data-id="${widget.id}" class="p-1 rounded transition-colors">${widget.vertical ? this.icons.grid : this.icons.list}</button>`;
        }
        if(widget.type !== 'image') {
            // Logic Resolution: Enable AI Wand for text-heavy or structural widgets (Hybrid Router)
            // Added 'footer' to enable Safety Logic and 'script' awareness for the Parser
            const isNeural = ['richText', 'treatment', 'breakdown', 'footer', 'script'].includes(widget.type) || ['script','screenplay'].some(s => (widget.label||'').toLowerCase().includes(s));
            const action = isNeural ? 'widget-neural-fill' : 'widget-autofill';
            const title = isNeural ? 'AI Generate / Parse' : 'Auto-Fill';
            tools += `<button type="button" aria-label="${title}" data-action="${action}" data-type="${widget.type}" data-doc-id="${doc.id}" data-id="${widget.id}" class="p-1 rounded transition-all" title="${title}">${this.icons.wand}</button>`;
        }
        
        return `<div class="grid-stack-item-content group">
            <div class="widget-header flex justify-between items-center">
                <input value="${cleanTitle}" onchange="mBTDB.updateWidgetLabel('${doc.id}', '${widget.id}', this.value)" class="bg-transparent border-none w-48 outline-none transition-colors">
                <div class="widget-tools flex items-center gap-1">
                    ${tools}
                    <button type="button" aria-label="Delete Widget" data-action="widget-delete" data-id="${widget.id}" class="p-1 rounded transition-colors">${this.icons.trash}</button>
                </div>
            </div>
            <div class="widget-body flex-grow overflow-y-auto no-scrollbar relative text-slate-800 h-full bg-white">${this._getContentForWidget(widget, doc)}</div>
        </div>`;
    },
    _getContentForWidget: function(widget, doc) {
        const data = this.resolveLinkedData(doc); // LIVE SYNC (Phase 9)        
        if (widget.type === 'contacts') return this._renderContacts(doc.id, data, widget);
        if (['logistics', 'locations'].includes(widget.type)) return this._renderLogistics(doc.id, data);
        if (widget.type === 'schedule') return this._renderSchedule(doc.id, data);
        if (widget.type === 'crew') return this._renderCrew(doc.id, data);
        if (widget.type === 'cast') return this._renderTalent(doc.id, data);
        if (widget.type === 'richText') return this._renderRichText(doc.id, widget.id, data);
        if (widget.type === 'image') return this._renderImage(doc.id, widget.id, data);
        // --- Batch 2: Logistics Routing ---
        if (widget.type === 'transport') return this._renderTransport(doc.id, data);
        if (widget.type === 'mudmap') return this._renderMudMap(doc.id, widget.id, data);
        if (widget.type === 'footer') return this._renderFooter(doc.id, widget.id, data);
        return '';
    },
    
    // --- Helper: Open Contact from Name ---
    openContactByName: function(name) {
        if (!name) return;
        // Logic Resolution: Clean name by removing parenthetical contact info often added by the system
        const rawName = name.split('(')[0].trim();
        const cleanName = rawName.toLowerCase();
        
        // 1. Search Active Budget Line Items First (Priority Scan)
        let foundInBudget = null;
        let sectionKey = null;
        
        if (budget && budget.sections) {
            Object.entries(budget.sections).some(([secName, sec]) => {
                const item = sec.items.find(i => 
                    i.crew && 
                    i.crew.name && 
                    (i.crew.name.toLowerCase() === cleanName || 
                     i.crew.name.toLowerCase().includes(cleanName) || 
                     cleanName.includes(i.crew.name.toLowerCase()))
                );
                if (item) {
                    foundInBudget = item;
                    sectionKey = secName;
                    return true;
                }
                return false;
            });
        }

        if (foundInBudget) {
            openCrewProfile(null, null, foundInBudget.id, sectionKey);
            return;
        }

        // 2. Fallback to Global Open Gate Database
        const contact = mBTOG.contacts.find(c => c.name.toLowerCase().includes(cleanName) || cleanName.includes(c.name.toLowerCase()));
        
        if (contact) {
            openCrewProfile(null, null, contact.id, null);
        } else {
            mBTME.confirm("Contact Not Found", `Create a new profile for "${rawName}"?`, () => {
                const dummyId = 'dummy_new_contact_' + Date.now();
                openCrewProfile(null, null, dummyId, null);
                setTimeout(() => {
                    const nameInput = document.getElementById('crewName');
                    if(nameInput) nameInput.value = rawName;
                }, 100);
            });
        }
    },

    _renderMetaHeader: function(doc) {
        const d = doc.content.data;
        const lock = this.state.isEditing ? '' : 'disabled';
        const is24h = d.meta.is24h || false;
        
        // Ensure agency object exists
        if(!d.agency) d.agency = {};
        if(!d.production) d.production = { address: '', phone: '', email: '', wifi: '', pass: '' }; // New Prod Office Data

        // Champion Layout Masthead (3-Column Grid)
        const html = `
        <div class="flex justify-between items-end border-b-4 border-black pb-2 mb-2">
            <input ${lock} value="${d.meta.productionTitle || 'UNTITLED PROJECT'}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionTitle', this.value)" class="text-4xl font-black uppercase w-full outline-none leading-none tracking-tighter" placeholder="TITLE">
            <div class="text-right shrink-0">
                <div class="text-2xl font-black">CALL SHEET</div>
                <div class="flex gap-4 text-xs font-bold mt-1">
                    <div>DATE: <input type="date" value="${d.meta.shootDate}" onchange="mBTDB.updateData('${doc.id}', 'meta.shootDate', this.value); mBTDB.renderFrame();" class="inline-block w-auto border-b border-slate-300"></div>
                    <div>CALL: <input type="time" value="${d.meta.crewCallTime}" onchange="mBTDB.updateData('${doc.id}', 'meta.crewCallTime', this.value)" class="inline-block w-24 text-center border-b border-slate-300"></div>
                    <div class="flex items-center gap-1.5 ${this.state.isEditing ? '' : 'hidden'}"><input type="checkbox" ${is24h ? 'checked' : ''} onchange="mBTDB.updateData('${doc.id}', 'meta.is24h', this.checked); mBTDB.renderFrame();" class="w-3 h-3 cursor-pointer"> 24h</div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-3 gap-2 mb-4 text-[10px]">
            <!-- Left: Production Office (Address & Logistics) -->
            <div class="cs-box p-2 flex flex-col h-full">
                <div class="font-bold border-b border-black mb-1 flex justify-between">
                    <span>PRODUCTION OFFICE</span>
                    <span>${this.icons.mapPin}</span>
                </div>
                <div class="flex-grow space-y-1">
                    <textarea ${lock} onchange="mBTDB.updateData('${doc.id}','production.address',this.value)" class="w-full resize-none h-8 leading-tight font-bold" placeholder="Office Address...">${d.production.address||''}</textarea>
                    <div class="grid grid-cols-[auto_1fr] gap-x-2 items-center">
                        <span class="font-bold">PH:</span> <input ${lock} value="${d.production.phone||''}" onchange="mBTDB.updateData('${doc.id}','production.phone',this.value)" class="w-full" placeholder="Office Phone">
                        <span class="font-bold">EMAIL:</span> <input ${lock} value="${d.production.email||''}" onchange="mBTDB.updateData('${doc.id}','production.email',this.value)" class="w-full" placeholder="production@email.com">
                    </div>
                    <div class="flex gap-2 pt-1 border-t border-slate-100 mt-1">
                        <div class="flex-1"><span class="font-bold">WIFI:</span> <input ${lock} value="${d.production.wifi||''}" onchange="mBTDB.updateData('${doc.id}','production.wifi',this.value)" class="w-16" placeholder="Network"></div>
                        <div class="flex-1"><span class="font-bold">PASS:</span> <input ${lock} value="${d.production.pass||''}" onchange="mBTDB.updateData('${doc.id}','production.pass',this.value)" class="w-16" placeholder="Password"></div>
                    </div>
                </div>
            </div>
            
            <!-- Center: Locations -->
            <div class="cs-box p-2">
                <div class="font-bold border-b border-black mb-1">LOCATIONS</div>
                ${(d.locations||[]).map((l,i) => `
                    <div class="mb-2">
                        <div class="flex justify-between"><span class="font-bold">                             <span class="opacity-50">HOSP:</span>
                             <input ${lock} value="${l.hospital||''}" onchange="mBTDB.updateRow('${doc.id}','locations',${i},'hospital',this.value)" class="w-full bg-transparent border-b border-red-100 focus:border-red-500 text-red-600" placeholder="Nearest Hospital...">
                        </div>
                    </div>
                `).join('')}
            </div>

            <!-- Right: Agency & Weather -->
            <div class="cs-box p-2 flex flex-col h-full">
                <!-- Agency Block -->
                <div class="font-bold border-b border-black mb-1 flex justify-between items-center cursor-pointer hover:bg-slate-50" onclick="if(!event.target.closest('button')) { const b=this.nextElementSibling; b.classList.toggle('hidden'); }">
                    <span>AGENCY / CLIENT</span> 
                    <div class="flex gap-2">
                        <button onclick="mBTDB.syncAgencyInfo('${doc.id}')" class="text-slate-400 hover:text-blue-600 transition-colors" title="Sync from Database">${this.icons.sync}</button>
                        <span class="text-[8px] text-slate-400"></span>
                    </div>
                </div>
                <div class="grid grid-cols-[auto_1fr] gap-x-2 gap-y-1 items-center mb-2 hidden">
                    <span class="font-bold">PRODUCER:</span>
                    <div class="flex items-center gap-1">
                        <input ${lock} value="${d.agency.producer||''}" onchange="mBTDB.updateData('${doc.id}','agency.producer',this.value)" class="w-full" placeholder="Name">
                        ${d.agency.producer ? `<button onclick="mBTDB.openContactByName('${d.agency.producer}')" class="text-blue-600 hover:scale-110 transition-transform">${this.icons.user}</button>` : ''}
                    </div>
                    <span class="font-bold">CREATIVE:</span>
                    <div class="flex items-center gap-1">
                        <input ${lock} value="${d.agency.creative||''}" onchange="mBTDB.updateData('${doc.id}','agency.creative',this.value)" class="w-full" placeholder="Name">
                        ${d.agency.creative ? `<button onclick="mBTDB.openContactByName('${d.agency.creative}')" class="text-blue-600 hover:scale-110 transition-transform">${this.icons.user}</button>` : ''}
                    </div>
                </div>

                <div class="font-bold border-b border-black mb-1 mt-auto">CONDITIONS</div>
                <div class="flex justify-between mb-1">
                    <span>Sunrise: <input ${lock} value="${d.meta.sunriseSunset?.split('/')[0]||''}" class="w-12 text-center border-b border-slate-200"></span>
                    <span>Sunset: <input ${lock} value="${d.meta.sunriseSunset?.split('/')[1]||''}" class="w-12 text-center border-b border-slate-200"></span>
                </div>
                <textarea ${lock} class="w-full h-8 resize-none" placeholder="Weather forecast...">${d.locations?.[0]?.weather || ''}</textarea>
            </div>
        </div>`;
        
        const container = document.getElementById('mBTDB_MetaArea'); if(container) container.innerHTML = html;
    },

    _renderContacts: function(docId, d, widget) {
        const lock = this.state.isEditing ? '' : 'disabled';
        const hideTool = this.state.isEditing ? '' : 'hidden';
        
        // Data Migration: Permanent Fix for Legacy Objects to Arrays
        if (!Array.isArray(d.contacts)) {
            const newArray = [
                { role: 'DIRECTOR', name: d.contacts.director || '' },
                { role: 'PRODUCER', name: d.contacts.producer || '' },
                { role: '1ST AD', name: d.contacts.ad || '' }
            ];
            // Persist migration immediately so Add/Delete works
            setTimeout(() => mBTDB.updateData(docId, 'contacts', newArray), 0);
            d.contacts = newArray;
        }

        const renderRow = (c, i) => {
            return `
            <div class="flex flex-col border-b border-slate-100 pb-1 mb-1 last:border-0 group/row">
                <!-- Role Header -->
                <input ${lock} value="${c.role||''}" onchange="mBTDB.updateRow('${docId}','contacts',${i},'role',this.value)" class="text-[7px] font-black uppercase tracking-widest text-slate-400 bg-transparent border-none p-0 w-full outline-none mb-0.5 focus:text-blue-600 transition-colors" placeholder="ROLE">
                
                <!-- Name Row -->
                <div class="flex items-center gap-2">
                    <!-- Import Button (Left) -->
                    ${this.state.isEditing ? `
                    <button class="text-slate-300 hover:text-blue-500 transition-colors shrink-0" onclick="mBTDB.pullFromOpenGate('${docId}', 'contacts.${i}.name', '${c.role||'crew'}')" title="Import from DB">
                        ${this.icons.user}
                    </button>` : ''}
                    
                    <!-- Name Input -->
                    <input ${lock} value="${c.name||''}" onchange="mBTDB.updateRow('${docId}','contacts',${i},'name',this.value)" class="flex-grow bg-transparent border-none p-0 text-[10px] font-bold text-slate-900 outline-none placeholder-slate-300" placeholder="Name...">
                    
                    <!-- Delete Button (Right) -->
                    <button onclick="mBTDB.deleteRow('${docId}','contacts',${i},'contacts')" class="text-slate-200 hover:text-red-500 transition-colors shrink-0 ${hideTool}" title="Remove Contact">
                        ${this.icons.trash}
                    </button>
                </div>
            </div>`;
        };

        return `
        <div class="h-full flex flex-col cs-box border-none">
            <div class="flex-grow overflow-y-auto p-2 no-scrollbar bg-white">
                ${d.contacts.map((c, i) => renderRow(c, i)).join('')}
            </div>
            <div class="p-2 border-t border-black bg-slate-50 ${hideTool}">
                <button onclick="mBTDB.addRow('${docId}','contacts','contact')" class="w-full bg-white border border-slate-300 text-[9px] font-bold uppercase py-1 hover:bg-slate-100">+ Add Contact</button>
            </div>
        </div>`;
    },
        
    _renderLogistics: function(docId, d) {
        const lock = this.state.isEditing ? '' : 'disabled';
        const hideTool = this.state.isEditing ? '' : 'hidden';
        
        // Parse Sun Data for Display
        const sunRaw = d.meta.sunriseSunset || '/';
        const [sunrise, sunset] = sunRaw.split('/');

        return `<div class="flex flex-col h-full">
            <!-- Compact Sun Header (Horizontal) -->
            <div class="px-2 py-1 border-b border-black flex justify-center items-center gap-4 bg-slate-50">
                <div class="flex items-center gap-1">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">SUN</span>
                    <input type="text" ${lock} value="${sunrise||''}" onchange="mBTDB.formatTime(this, '${docId}'); const current = '${sunRaw}'.split('/'); current[0]=this.value; mBTDB.updateData('${docId}','meta.sunriseSunset',current.join('/'))" class="bg-transparent text-[10px] font-bold w-16 text-center outline-none disabled:text-slate-800" placeholder="06:00">
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">SET</span>
                    <input type="text" ${lock} value="${sunset||''}" onchange="mBTDB.formatTime(this, '${docId}'); const current = '${sunRaw}'.split('/'); current[1]=this.value; mBTDB.updateData('${docId}','meta.sunriseSunset',current.join('/'))" class="bg-transparent text-[10px] font-bold w-16 text-center outline-none disabled:text-slate-800" placeholder="18:00">
                </div>
            </div>
            
            <div class="flex-grow overflow-y-auto p-2 space-y-3 no-scrollbar">${(d.locations||[]).map((l,i) => `<div class="flex flex-col gap-1 border-b-2 border-black pb-2 mb-1 relative group/loc">
            
            <!-- Row 1: Name and Time (Refined Font Size & Width) -->
            <div class="flex justify-between items-end gap-2 mb-1">
                <div class="flex-grow">
                    <label class="text-[7px] font-black text-slate-400 uppercase tracking-widest block mb-0.5">LOCATION ${i+1}</label>
                    <input ${lock} value="${l.name}" onchange="mBTDB.updateRow('${docId}','locations',${i},'name',this.value)" class="w-full bg-transparent border-none p-0 text-sm font-black text-slate-900 uppercase tracking-tight outline-none placeholder-slate-300" placeholder="NAME">
                </div>
                <div class="w-20 text-right shrink-0">
                     <label class="text-[7px] font-black text-slate-400 uppercase tracking-widest block mb-0.5">CALL</label>
                     <input ${lock} type="text" value="${l.timeOnLocation||''}" onchange="mBTDB.formatTime(this, '${docId}'); mBTDB.updateRow('${docId}','locations',${i},'timeOnLocation',this.value)" class="w-full bg-transparent border-none p-0 text-xs font-black text-blue-600 text-center outline-none" placeholder="00:00">
                </div>
            </div>
            
            <!-- Row 2: Address (Compact Height) -->
            <div class="w-full">
                 <textarea ${lock} onchange="mBTDB.updateRow('${docId}','locations',${i},'address',this.value)" class="w-full bg-slate-50 border-none rounded px-2 py-1 text-[9px] font-bold text-slate-700 placeholder-slate-400 h-10 resize-none leading-relaxed" placeholder="Full Address...">${l.address}</textarea>
            </div>

            <!-- Row 3: Hospital -->
            <div class="flex items-center gap-1 bg-red-50 px-2 py-1 rounded border border-red-100">
                <span class="text-[8px] font-black text-red-500 uppercase tracking-widest shrink-0">HOSP</span>
                <input ${lock} value="${l.hospital||''}" onchange="mBTDB.updateRow('${docId}','locations',${i},'hospital',this.value)" class="w-full bg-transparent border-none p-0 text-[9px] font-bold text-red-700 placeholder-red-200" placeholder="Nearest Medical...">
            </div>
            
            <!-- Row 4: Weather (Stacked Below, Compact) -->
            <div class="relative bg-blue-50 px-2 py-1 rounded border border-blue-100 h-8 flex items-center">
                <input ${lock} value="${l.weather||''}" onchange="mBTDB.updateRow('${docId}','locations',${i},'weather',this.value)" class="w-full bg-transparent border-none p-0 text-[9px] font-bold text-blue-800 placeholder-blue-200 pr-5" placeholder="Weather...">
                <button id="w-btn-${i}" onclick="mBTDB.autoFillLocationDetails('${docId}', ${i})" class="absolute top-1/2 -translate-y-1/2 right-1 text-blue-400 hover:text-blue-600 transition-colors ${hideTool}" title="Auto-Fill details">
                    ${this.icons.wand}
                </button>
            </div>

            <button onclick="mBTDB.deleteRow('${docId}','locations',${i},'logistics')" class="absolute top-0 right-0 text-slate-200 hover:text-red-500 transition-colors ${hideTool}"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>`).join('')}</div>
        <div class="p-2 border-t border-black bg-slate-50 ${hideTool}">
            <button onclick="mBTDB.addRow('${docId}','locations','loc')" class="w-full bg-white border border-slate-300 text-[9px] font-bold uppercase py-1 hover:bg-slate-100">+ Add Location</button>
        </div>
        </div>`;
    },

    autoFillLocationDetails: async function(docId, index) {
        const btn = document.getElementById(`w-btn-${index}`);
        if(btn) btn.innerHTML = `...`; 
        
        const doc = budget.documents.find(d => d.id === docId);
        if(!doc || !doc.content.data.locations[index]) return;
        
        const loc = doc.content.data.locations[index];
        // Prioritize address for accuracy
        const query = loc.address && loc.address.length > 5 ? loc.address : loc.name;
        
        try {
            // 1. Geocoding
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1&language=en&format=json`);
            const geo = await geoRes.json();
            
            if(!geo.results) throw new Error("Location not found via Geocoding.");
            const { latitude, longitude, name: geoName } = geo.results[0];
            
            // 2. Weather
            const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`);
            const wData = await wRes.json();
            
            const today = wData.daily;
            const code = today.weather_code[0];
            
            // WMO Code Mapping
            let summary = "Clear"; 
            if(code === 1 || code === 2 || code === 3) summary = "Partly Cloudy"; 
            else if(code === 45 || code === 48) summary = "Foggy";
            else if(code >= 51 && code <= 57) summary = "Drizzle";
            else if(code >= 61 && code <= 67) summary = "Rain";
            else if(code >= 80 && code <= 82) summary = "Showers";
            else if(code >= 95) summary = "Thunderstorm";
            
            const sunrise = today.sunrise[0].split('T')[1];
            const sunset = today.sunset[0].split('T')[1];
            
            // Logic Fix: Stripped Sunrise/Sunset info from weather string
            const weatherStr = `${summary} ${Math.round(today.temperature_2m_max[0])}/${Math.round(today.temperature_2m_min[0])}C`; 
            
            // Update Weather
            this.updateRow(docId, 'locations', index, 'weather', weatherStr);
            
            // Update Global Sun (First location only)
            if (index === 0) {
                this.updateData(docId, 'meta.sunriseSunset', `${sunrise}/${sunset}`);
            }
            
            // 3. Hospital AI
            const provider = mBT.features.ai.getSelectedProvider();
            const apiKey = mBT.features.ai.getStoredApiKey(provider);
            
            if (apiKey) {
                const prompt = `Find nearest emergency hospital to ${latitude},${longitude} (${geoName}). Return ONLY Hospital Name.`;
                const hospitalName = await mBT.features.ai.callUnifiedAI(provider, apiKey, prompt);
                const cleanHost = hospitalName.replace(/^(The nearest.*?is|Here is|Name:|Hospital:)/i, '').trim().replace(/\.$/, '');
                this.updateRow(docId, 'locations', index, 'hospital', cleanHost);
            }
            
            // Refresh
            // Logic Resolution: Trigger a repaint of this specific widget if possible to avoid full reload
            // But for safety in single-file, we call renderFrame.
            this.renderFrame();
            
        } catch(e) { 
            console.error("Autofill Logic Error:", e);
            mBTME.alert("Sync Error", "Could not fetch location data."); 
            if(btn) btn.innerHTML = this.icons.wand; 
        }
    },

    // Legacy Bridge: Prevents crash if old buttons invoke this
    autoFillWeather: async function(docId, index, name) {
        return this.autoFillLocationDetails(docId, index);
    },
       _renderSchedule: function(docId, d) {
        const lock = this.state.isEditing ? '' : 'disabled';
        const hideTool = this.state.isEditing ? '' : 'hidden';
        
        // High-Density Table (Header Removed)
        return `
        <div class="h-full flex flex-col border-none">
            <div class="flex-grow overflow-auto no-scrollbar">
                <table class="cs-table w-full">
                    <thead>
                        <tr>
                            <th class="w-20 text-center">TIME</th>
                            <th class="w-10 text-center">SCN</th>
                            <th class="w-10 text-center">I/E</th>
                            <th class="text-left">DESCRIPTION / ACTION / NOTES</th>
                            <th class="w-16 text-center">CAST</th>
                            <th class="w-20 text-left">LOC</th>
                            <th class="w-6"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${d.schedule.map((row, i) => {
                            const isMeal = row.type === 'meal';
                            const rowBg = isMeal ? 'bg-slate-100 font-bold' : '';
                            return `
                            <tr class="${rowBg} hover:bg-blue-50 transition-colors">
                                <td class="p-1"><input ${lock} type="text" value="${row.time}" onchange="mBTDB.formatTime(this, '${docId}'); mBTDB.updateRow('${docId}','schedule',${i},'time',this.value)" class="text-center font-bold" placeholder="00:00"></td>
                                ${isMeal ? 
                                `<td colspan="5" class="p-1 text-center uppercase tracking-widest text-[10px]"><input ${lock} value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="text-center w-full uppercase"></td>` : 
                                `
                                <td class="p-1"><input ${lock} value="${row.scene}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'scene',this.value)" class="text-center"></td>
                                <td class="p-1"><input ${lock} value="${row.ie}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'ie',this.value)" class="text-center uppercase"></td>
                                <td class="p-1"><input ${lock} value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="font-medium w-full"></td>
                                <td class="p-1"><input ${lock} value="${row.cast}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'cast',this.value)" class="text-center font-bold text-slate-600"></td>
                                <td class="p-1"><input ${lock} value="${row.loc}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'loc',this.value)" class="text-xs"></td>
                                `}
                                <td class="p-1 text-center ${hideTool}"><button onclick="mBTDB.deleteRow('${docId}','schedule',${i}, 'schedule')" class="text-slate-300 hover:text-red-500"></button></td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div class="flex gap-2 p-2 border-t border-black bg-slate-50 ${hideTool}">
                <button onclick="mBTDB.addRow('${docId}','schedule','shot')" class="flex-1 bg-white border border-slate-300 text-[9px] font-bold uppercase py-1 hover:bg-slate-100">+ Shot</button>
                <button onclick="mBTDB.addRow('${docId}','schedule','meal')" class="flex-1 bg-white border border-slate-300 text-[9px] font-bold uppercase py-1 hover:bg-slate-100">+ Meal</button>
            </div>
        </div>`;
    },
    _renderCrew: function(docId, d) {
        const lock = this.state.isEditing ? '' : 'disabled';
        const hideTool = this.state.isEditing ? '' : 'hidden';
        // Updated: High Density Crew List (Header Removed)
        return `
        <div class="h-full flex flex-col border-none">
            <div class="flex-grow overflow-auto no-scrollbar">
                <table class="cs-table w-full">
                    <thead>
                        <tr>
                            <th class="w-1/4">DEPARTMENT / POSITION</th>
                            <th class="w-1/4">NAME</th>
                            <th class="w-20 text-center">CALL</th>
                            <th>NOTES / INSTRUCTIONS</th>
                            <th class="w-6"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(d.crew||[]).map((c,i) => `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="p-1">
                                <input ${lock} value="${c.department||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'department',this.value)" class="font-black uppercase text-[8px] text-slate-400 block w-full mb-0.5" placeholder="DEPT">
                                <input ${lock} value="${c.position||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'position',this.value)" class="font-bold text-slate-800" placeholder="Position">
                            </td>
                            <td class="p-1">
                                <div class="flex items-center gap-1">
                                    <input ${lock} value="${c.name||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'name',this.value)" class="font-bold text-slate-900 w-full" placeholder="Name">
                                    ${this.state.isEditing ? `<div class="cursor-pointer text-slate-300 hover:text-blue-500" onclick="mBTDB.pullFromOpenGate('${docId}','crew.${i}.name','${c.position||'crew'}')">${this.icons.user}</div>` : 
                                      (c.name ? `<button onclick="mBTDB.openContactByName('${c.name}')" class="text-blue-600 hover:scale-110 transition-transform">${this.icons.user}</button>` : '')}
                                </div>
                                <input ${lock} value="${c.contact||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'contact',this.value)" class="text-[8px] font-mono text-slate-400 w-full" placeholder="Phone/Email">
                            </td>
                            <td class="p-1"><input ${lock} type="text" value="${c.callTime||''}" onchange="mBTDB.formatTime(this, '${docId}'); mBTDB.updateRow('${docId}','crew',${i},'callTime',this.value)" class="text-center font-black text-blue-600" placeholder="00:00"></td>
                            <td class="p-1"><input ${lock} value="${c.notes||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'notes',this.value)" class="italic text-slate-600 w-full" placeholder="Specific notes..."></td>
                            <td class="p-1 text-center ${hideTool}"><button onclick="mBTDB.deleteRow('${docId}','crew',${i}, 'crew')" class="text-slate-300 hover:text-red-500"></button></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
            <div class="p-2 border-t border-black bg-slate-50 ${hideTool}">
                <button onclick="mBTDB.addRow('${docId}','crew','person')" class="w-full bg-white border border-slate-300 text-[9px] font-bold uppercase py-1 hover:bg-slate-100">+ Add Crew</button>
            </div>
        </div>`;
    },
_renderTalent: function(docId, d) {
        const lock = this.state.isEditing ? '' : 'disabled';
        const hideTool = this.state.isEditing ? '' : 'hidden';
        // Updated: High Density Cast Grid (Header Removed)
        return `
        <div class="h-full flex flex-col border-none">
            <div class="flex-grow overflow-auto no-scrollbar">
                <table class="cs-table w-full">
                    <thead>
                        <tr>
                            <th class="w-24">CHARACTER</th>
                            <th>ARTIST</th>
                            <th class="w-10 text-center">SWF</th>
                            <th class="w-20 text-center">PU</th>
                            <th class="w-20 text-center">BF</th>
                            <th class="w-20 text-center">H/MU</th>
                            <th class="w-20 text-center">COST</th>
                            <th class="w-20 text-center bg-slate-100 text-black border-black">SET</th>
                            <th class="w-6"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(d.cast||[]).map((c,i) => `
                        <tr>
                            <td class="p-1"><input ${lock} value="${c.character||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'character',this.value)" class="font-bold text-slate-500 uppercase"></td>
                            <td class="p-1">
                                <div class="flex items-center gap-1">
                                    <input ${lock} value="${c.actor||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'actor',this.value)" class="font-black text-slate-900 w-full">
                                    ${this.state.isEditing ? `<div class="cursor-pointer text-slate-300 hover:text-blue-500" onclick="mBTDB.pullFromOpenGate('${docId}','cast.${i}.actor','actor')">${this.icons.user}</div>` : 
                                      (c.actor ? `<button onclick="mBTDB.openContactByName('${c.actor}')" class="text-blue-600 hover:scale-110 transition-transform">${this.icons.user}</button>` : '')}
                                </div>
                            </td>
                            <td class="p-1"><input ${lock} value="${c.swf||'W'}" onchange="mBTDB.updateRow('${docId}','cast',${i},'swf',this.value)" class="text-center font-black uppercase text-[9px]" placeholder="S/W/F"></td>
                            <td class="p-1"><input ${lock} type="text" value="${c.pickup||''}" onchange="mBTDB.formatTime(this, '${docId}'); mBTDB.updateRow('${docId}','cast',${i},'pickup',this.value)" class="text-center" placeholder="--:--"></td>
                            <td class="p-1"><input ${lock} type="text" value="${c.bf||''}" onchange="mBTDB.formatTime(this, '${docId}'); mBTDB.updateRow('${docId}','cast',${i},'bf',this.value)" class="text-center" placeholder="--:--"></td>
                            <td class="p-1"><input ${lock} type="text" value="${c.hmu||''}" onchange="mBTDB.formatTime(this, '${docId}'); mBTDB.updateRow('${docId}','cast',${i},'hmu',this.value)" class="text-center" placeholder="--:--"></td>
                            <td class="p-1"><input ${lock} type="text" value="${c.costume||''}" onchange="mBTDB.formatTime(this, '${docId}'); mBTDB.updateRow('${docId}','cast',${i},'costume',this.value)" class="text-center" placeholder="--:--"></td>
                            <td class="p-1 bg-slate-50"><input ${lock} type="text" value="${c.setCall||''}" onchange="mBTDB.formatTime(this, '${docId}'); mBTDB.updateRow('${docId}','cast',${i},'setCall',this.value)" class="text-center font-black text-slate-900" placeholder="00:00"></td>
                            <td class="p-1 text-center ${hideTool}"><button onclick="mBTDB.deleteRow('${docId}','cast',${i}, 'cast')" class="text-slate-300 hover:text-red-500"></button></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
            <div class="p-2 border-t border-black bg-slate-50 ${hideTool}">
                <button onclick="mBTDB.addRow('${docId}','cast','talent', {id:Date.now(), character:'', actor:'', swf:'W', pickup:'', bf:'', hmu:'', costume:'', setCall:'', contact:''})" class="w-full bg-white border border-slate-300 text-[9px] font-bold uppercase py-1 hover:bg-slate-100">+ Add Talent</button>
            </div>
        </div>`;
    },
    
    // Logic Resolution: 1/8th Page Calculation Heuristic
    // Standard screenplay format: ~54 lines per page. 1/8th page ~= 7 lines (approx 1 inch).
    _calcPages: function(text) {
        if (!text) return "0 Pgs";
        // Count newlines to estimate vertical length
        const lines = text.split(/\r\n|\r|\n/).length;
        // Basic heuristic: 55 lines = 1 page (Courier 12pt standard)
        const eighths = Math.ceil(lines / 7); // 7 lines per 1/8th
        const pages = Math.floor(eighths / 8);
        const rem = eighths % 8;
        
        if (pages === 0 && rem === 0) return "0 Pgs";
        if (pages === 0) return `${rem}/8 Pgs`;
        if (rem === 0) return `${pages} Pgs`;
        return `${pages} ${rem}/8 Pgs`;
    },

    // Logic Resolution: Live DOM Update for Script Metrics (Batch 1.2)
    _updateScriptHUD: function(widgetId, text) {
        const hud = document.getElementById(`hud_${widgetId}`);
        if(hud) hud.textContent = this._calcPages(text);
    },

    _renderRichText: function(docId, widgetId, data) {
        const lock = this.state.isEditing ? '' : 'disabled';
        const val = data.additional ? data.additional[widgetId] : (data[widgetId] || "");
        
        // Logic Resolution: Typography Enforcement for Screenplays (Batch 1.2.2)
        const doc = budget.documents.find(d => d.id === docId);
        const widget = doc.content.widgets.find(w => w.id === widgetId);
        
        // Detect Script Mode via Document Type or Widget Label
        const isScript = (doc && (doc.type === 'script' || (widget && widget.label && widget.label.toLowerCase().includes('screenplay'))));
        
        // Industry Standard: Courier Prime/New, 12pt, Single Spacing (1 page ~= 1 min)
        const styleClass = isScript 
            ? "font-mono text-sm leading-none bg-white text-black font-bold whitespace-pre-wrap border-none outline-none resize-none" 
            : "studio-input h-full p-3 text-xs text-slate-800 font-medium leading-relaxed resize-none";
            
        const customStyle = isScript ? 'font-family: "Courier Prime", "Courier New", monospace; font-size: 12pt; line-height: 1.0; padding: 40px;' : '';
        const placeholder = isScript ? 'INT. LOCATION - DAY\n\nAction description...' : 'Type notes...';

        // HUD Logic: Inject Visual Counter for Scripts (Batch 1.3)
        // Note: Initial calculation happens here on render. Live updates via oninput.
        const hudHtml = isScript 
            ? `<div id="hud_${widgetId}" class="absolute bottom-4 right-4 bg-slate-900/10 backdrop-blur-md px-3 py-1 rounded-full text-[10px] font-black text-slate-500 border border-slate-200 pointer-events-none select-none transition-opacity z-10">
                ${this._calcPages(val)}
               </div>` 
            : '';

        // Added 'relative group' to container for HUD positioning
        // Added 'oninput' for real-time math (surgical)
        // Kept 'onchange' for data persistence (debounced)
        return `<div class="h-full flex flex-col p-2 relative group">
            <div class="flex-grow relative h-full">
                <textarea ${lock} 
                    id="input_${widgetId}"
                    oninput="mBTDB._updateScriptHUD('${widgetId}', this.value)"
                    onchange="mBTDB.updateData('${doc.id}', 'additional.${widgetId}', this.value)" 
                    class="${styleClass} w-full h-full disabled:bg-transparent disabled:border-none" 
                    style="${customStyle}" 
                    placeholder="${placeholder}">${val||''}</textarea>
                ${hudHtml}
            </div>
        </div>`;
    },
    // Logic Resolution: New Image Rendering Logic with Optimization
    _renderImage: function(docId, widgetId, data) {        const val = data.additional ? data.additional[widgetId] : (data[widgetId] || "");
        
        if (val) {
            // Image Display State
            return `
            <div class="relative w-full h-full group bg-slate-50 flex items-center justify-center overflow-hidden">
                <img src="${val}" class="max-w-full max-h-full object-contain">
                ${this.state.isEditing ? `
                <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                    <button onclick="document.getElementById('file_${widgetId}').click()" class="bg-white text-slate-900 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-blue-50">Change</button>
                    <button onclick="mBTDB.updateData('${docId}', 'additional.${widgetId}', '')" class="bg-white text-rose-600 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-rose-50">Remove</button>
                </div>
                <input type="file" id="file_${widgetId}" accept="image/*" class="hidden" onchange="mBTDB._handleImageUpload(this, '${docId}', '${widgetId}')">` : ''}
            </div>`;
        } else {
            // Empty State
            if (!this.state.isEditing) return `<div class="w-full h-full flex items-center justify-center bg-slate-50 text-[10px] text-slate-300 font-bold uppercase tracking-widest">Empty Image Block</div>`;
            return `
            <div class="w-full h-full flex flex-col items-center justify-center bg-slate-50 hover:bg-blue-50/50 transition-colors border-2 border-dashed border-slate-100 hover:border-blue-200 cursor-pointer p-4 group" onclick="document.getElementById('file_${widgetId}').click()">
                <div class="text-slate-300 group-hover:text-blue-400 mb-2 scale-125 transition-transform group-hover:scale-150">${this.icons.image}</div>
                <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest group-hover:text-blue-500">Upload Image</span>
                <input type="file" id="file_${widgetId}" accept="image/*" class="hidden" onchange="mBTDB._handleImageUpload(this, '${docId}', '${widgetId}')">
            </div>`;
        }
    },

    // --- Batch 2: Logistics Widgets (Transport, MudMap, Footer) ---
    _renderTransport: function(docId, d) {
        const lock = this.state.isEditing ? '' : 'disabled';
        const hideTool = this.state.isEditing ? '' : 'hidden';
        // Updated: Header Removed
        return `
        <div class="h-full flex flex-col border-none">
            <div class="flex-grow overflow-auto no-scrollbar">
                <table class="cs-table w-full text-[9px]">
                    <thead>
                        <tr>
                            <th class="w-1/4">DRIVER / CONTACT</th>
                            <th class="w-1/5">VEHICLE</th>
                            <th class="w-10 text-center">PAX</th>
                            <th class="w-20 text-center">TIME</th>
                            <th>FROM > TO</th>
                            <th class="w-6"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(d.transport||[]).map((t,i) => `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="p-1">
                                <input ${lock} value="${t.driver||''}" onchange="mBTDB.updateRow('${docId}','transport',${i},'driver',this.value)" class="font-bold text-slate-900 w-full" placeholder="Driver Name">
                            </td>
                            <td class="p-1">
                                <input ${lock} value="${t.vehicle||''}" onchange="mBTDB.updateRow('${docId}','transport',${i},'vehicle',this.value)" class="text-slate-600 w-full" placeholder="Type/Plate">
                            </td>
                            <td class="p-1">
                                <input ${lock} value="${t.pax||''}" onchange="mBTDB.updateRow('${docId}','transport',${i},'pax',this.value)" class="text-center font-mono" placeholder="#">
                            </td>
                            <td class="p-1">
                                <input ${lock} type="time" value="${t.pickup||''}" onchange="mBTDB.updateRow('${docId}','transport',${i},'pickup',this.value)" class="text-center font-black text-blue-600">
                            </td>
                            <td class="p-1">
                                <input ${lock} value="${t.route||''}" onchange="mBTDB.updateRow('${docId}','transport',${i},'route',this.value)" class="w-full italic text-slate-500" placeholder="Loc A > Loc B">
                            </td>
                            <td class="p-1 text-center ${hideTool}">
                                <button onclick="mBTDB.deleteRow('${docId}','transport',${i},'transport')" class="text-slate-300 hover:text-red-500 font-bold"></button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>
            <div class="p-2 border-t border-black bg-slate-50 ${hideTool}">
                <button onclick="mBTDB.addRow('${docId}','transport','move')" class="w-full bg-white border border-slate-300 text-[9px] font-bold uppercase py-1 hover:bg-slate-100">+ Add Movement</button>
            </div>
        </div>`;
    },

    _renderMudMap: function(docId, widgetId, data) {
        // Logic Resolution: Use data-attributes to store ID references for the init function
        return `
        <div class="w-full h-full bg-white relative group border-2 border-black" id="mudmap_container_${widgetId}">
            <canvas id="canvas_${widgetId}" class="mudmap-canvas absolute inset-0 w-full h-full z-10 cursor-crosshair" data-doc-id="${docId}" data-widget-id="${widgetId}"></canvas>
            
            ${this.state.isEditing ? `
            <div class="absolute bottom-2 right-2 z-20 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <!-- [Feat16] Satellite Trigger -->
                <button onclick="mBTDB.loadMapBackground('${widgetId}', '${docId}')" class="bg-white text-blue-600 px-2 py-1 rounded shadow text-[9px] font-black uppercase tracking-widest border border-blue-200 hover:bg-blue-50" title="Load Site Plan from Logistics Address">Satellite</button>
                <button onclick="mBTDB._clearMudMap('${docId}', '${widgetId}')" class="bg-white text-rose-600 px-2 py-1 rounded shadow text-[9px] font-black uppercase tracking-widest border border-rose-200 hover:bg-rose-50">Clear</button>
            </div>
            <div class="absolute top-2 left-2 z-0 text-[10px] font-black text-slate-100 uppercase pointer-events-none select-none tracking-widest">
                SKETCH AREA (MUD MAP)
            </div>` : ''}
        </div>`;
    },

    _renderFooter: function(docId, widgetId, data) {
        const lock = this.state.isEditing ? '' : 'disabled';
        const val = data.additional ? data.additional[widgetId] : "";
        // Logic Resolution: Default Caribbean/UK Safety Standard if empty
        const defaultSafety = "EMERGENCY: DIAL 110/119 (JA) | NEAREST HOSPITAL: See Locations | SAFETY OFFICER: 1st AD\n\nHARASSMENT POLICY: This production operates a zero-tolerance policy towards harassment and bullying. Report concerns to the Producer or Unit Manager.";
        
        return `
        <div class="h-full flex flex-col justify-end p-3 border-t-4 border-black mt-2 bg-slate-50">
            <div class="text-[8px] font-black uppercase tracking-widest text-slate-500 mb-1 flex items-center gap-2">
                ${this.icons.hazard} HEALTH & SAFETY PROTOCOLS
            </div>
            <textarea ${lock} onchange="mBTDB.updateData('${docId}', 'additional.${widgetId}', this.value)" class="w-full h-full resize-none text-[9px] font-bold text-slate-800 bg-transparent outline-none leading-relaxed" placeholder="Enter safety details...">${val || defaultSafety}</textarea>
        </div>`;
    },

    _initMudMaps: function() {
        const canvases = document.querySelectorAll('.mudmap-canvas');
        canvases.forEach(cvs => {
            if(cvs.dataset.initialized) return;
            
            // 1. Resize Logic
            const rect = cvs.parentElement.getBoundingClientRect();
            cvs.width = rect.width; 
            cvs.height = rect.height;
            
            const ctx = cvs.getContext('2d');
            const docId = cvs.dataset.docId;
            const widgetId = cvs.dataset.widgetId;
            
            // 2. Hydrate Data
            const doc = budget.documents.find(d => d.id === docId);
            if(doc && doc.content.data.additional && doc.content.data.additional[widgetId]) {
                const img = new Image(); 
                img.onload = () => ctx.drawImage(img, 0, 0); 
                img.src = doc.content.data.additional[widgetId];
            }
            
            // 3. Drawing Logic
            let isDrawing = false;
            
            const start = (e) => { 
                if(!mBTDB.state.isEditing) return; 
                isDrawing = true; 
                ctx.beginPath(); 
                // Fix: Calculate offset correctly relative to canvas, not window
                const bounds = cvs.getBoundingClientRect(); 
                const x = (e.clientX || e.touches[0].clientX) - bounds.left;
                const y = (e.clientY || e.touches[0].clientY) - bounds.top;
                ctx.moveTo(x, y); 
            };
            
            const draw = (e) => { 
                if(!isDrawing) return; 
                const bounds = cvs.getBoundingClientRect(); 
                const x = (e.clientX || e.touches[0].clientX) - bounds.left;
                const y = (e.clientY || e.touches[0].clientY) - bounds.top;
                
                ctx.lineTo(x, y); 
                ctx.strokeStyle = "#000"; 
                ctx.lineWidth = 2; 
                ctx.lineCap = "round";
                ctx.stroke(); 
            };
            
            const end = () => { 
                if(!isDrawing) return; 
                isDrawing = false; 
                // Auto-save on stroke end
                mBTDB.updateData(docId, `additional.${widgetId}`, cvs.toDataURL()); 
            };
            
            // 4. Bind Events (Mouse & Touch)
            cvs.addEventListener('mousedown', start); 
            cvs.addEventListener('mousemove', draw); 
            cvs.addEventListener('mouseup', end); 
            cvs.addEventListener('mouseout', end);
            
            cvs.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); });
            cvs.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
            cvs.addEventListener('touchend', end);
            
            cvs.dataset.initialized = "true";
        });
    },

    _clearMudMap: function(docId, widgetId) {
        const cvs = document.getElementById(`canvas_${widgetId}`);
        if(cvs) { 
            const ctx = cvs.getContext('2d'); 
            ctx.clearRect(0, 0, cvs.width, cvs.height); 
            this.updateData(docId, `additional.${widgetId}`, ''); 
        }
    },

    // Logic Resolution: Silent High-Fidelity Image Processing (2K Max)
    _handleImageUpload: function(input, docId, widgetId) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                // Constraint: Max width 2048px (2K) for retina quality but safe storage
                const MAX_WIDTH = 2048;
                
                // Only scale down if larger than max width to preserve fidelity
                let width = img.width;
                let height = img.height;
                
                if (width > MAX_WIDTH) {
                    const scaleSize = MAX_WIDTH / width;
                    width = MAX_WIDTH;
                    height = img.height * scaleSize;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Compress to JPEG 0.8 quality (High Fidelity)
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                this.updateData(docId, `additional.${widgetId}`, dataUrl);
                this.renderFrame();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    },

    // --- 5. Navigation & Logic Controllers ---
    _refreshWidget: function(docId, widgetId) {
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc) return;
        const widget = doc.content.widgets.find(w => w.id === widgetId);
        if (!widget) return;
        
        const el = document.querySelector(`.grid-stack-item[gs-id="${widget.id}"] .widget-body`);
        const workspace = document.getElementById('mBTDB_Workspace');
        const currentScroll = workspace ? workspace.scrollTop : 0;

        if (el) {
            el.innerHTML = this._getContentForWidget(widget, doc);
            // Batch 3.2: Removed auto-resize call. Scrollbars handle overflow (CSS Batch 3.1).
            if(widget.type === 'mudmap') this._initMudMaps();
            
            // Logic Resolution: Restore scroll position to prevent "Jump to Top" on focus loss
            if (workspace) workspace.scrollTop = currentScroll;
        }
    },

    toggleVertical: function(wid) { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const w = doc.content.widgets.find(x => x.id === wid); if(w) { w.vertical = !w.vertical; this._refreshWidget(doc.id, wid); } },    
    updateWidgetLabel: function(docId, widgetId, newLabel) { const doc = budget.documents.find(d => d.id === docId); const w = doc.content.widgets.find(x => x.id === widgetId); if(w) { w.label = newLabel; this._triggerSave(); } },
    
    updateData: function(docId, path, value) { 
        const doc = budget.documents.find(d => d.id === docId); 
        // Invalidate Cache
        if (this.state._cache && this.state._cache.docId === docId) this.state._cache = null;

        const parts = path.split('.'); 
        let target = doc.content.data; 
        for(let i=0; i<parts.length-1; i++) { if(!target[parts[i]]) target[parts[i]]={}; target = target[parts[i]]; } 
        target[parts[parts.length-1]] = value; 
        
        // Phase 9: Sync Request Broadcast
        if (mBT.core && mBT.core.events) mBT.core.events.emit('sync-req', { docId, path });
        
        this._triggerSave(); 
    },
    
    updateRow: function(docId, section, index, key, value) { 
        const doc = budget.documents.find(d => d.id === docId); 
        if(doc.content.data[section][index]) { 
            // Invalidate Cache
            if (this.state._cache && this.state._cache.docId === docId) this.state._cache = null;

            doc.content.data[section][index][key] = value; 
            this._triggerSave(); 
            // Batch 3.2: Removed auto-resize logic. Data saves silently without moving UI.
        } 
    },
    
    addRow: function(docId, section, type, presetData) { 
        const doc = budget.documents.find(d => d.id === docId); 
        // Invalidate Cache
        if (this.state._cache && this.state._cache.docId === docId) this.state._cache = null;

        if(!doc.content.data[section]) doc.content.data[section] = []; 
        let newRow = presetData || { id: Date.now() }; 
        if(!presetData) { 
            if(section==='schedule') newRow = { ...newRow, type, time:"", scene:"", description: type==='meal'?"LUNCH":"New Shot", cast:"", ie:"", loc:"", note:"" }; 
            else if(section==='cast') newRow = { ...newRow, character:"", actor:"", status:"W", pickup:"", hmu:"", setCall:"", contact:"" }; 
            else if(section==='crew') newRow = { ...newRow, department:"", position:"", name:"", contact:"", callTime:"" }; 
            else if(section==='contacts') newRow = { ...newRow, role:"", name:"" }; 
            else if(section==='locations') newRow = { ...newRow, name:"", address:"", weather:"", hospital:"", mapLink:"", timeOnLocation:"" }; 
            else if(section==='transport') newRow = { ...newRow, driver:"", vehicle:"", pax:"", pickup:"", loc:"", dest:"" }; 
        } 
        doc.content.data[section].push(newRow); 
        this._triggerSave();

        // Surgical Widget Refresh
        const widgetType = (section === 'locations') ? 'logistics' : section;
        const widget = doc.content.widgets.find(w => w.type === widgetType);
        if(widget) this._refreshWidget(docId, widget.id);
        else this.renderFrame();
    },
    
    deleteRow: function(docId, section, index, widgetType) { 
        const doc = budget.documents.find(d => d.id === docId); 
        // Invalidate Cache
        if (this.state._cache && this.state._cache.docId === docId) this.state._cache = null;

        doc.content.data[section].splice(index, 1); 
        this._triggerSave(); 
        
        // Surgical Widget Refresh
        const type = widgetType || section;
        const widget = doc.content.widgets.find(w => w.type === type);
        if(widget) this._refreshWidget(docId, widget.id);
        else this.renderFrame();
    },
        deleteWidget: function(id) { 
        mBTME.confirm("Delete Widget", "Remove this block from layout?", () => {
            const doc = budget.documents.find(d => d.id === this.state.currentDocId); 
            const el = document.querySelector(`.grid-stack-item[gs-id="${id}"]`); 
            if(el) this.state.grid.removeWidget(el); 
            doc.content.widgets = doc.content.widgets.filter(w => w.id !== id); 
            this._triggerSave(); 
        });
    },
    addWidget: function() {
        const select = document.getElementById('mBTDB_WidgetSelect');
        if(!select) return;
        const type = select.value;
        const doc = budget.documents.find(d => d.id === this.state.currentDocId);
        const w = { id: type+'_'+Date.now(), type, w: 6, h: 4, autoPosition: true, label: type.toUpperCase() };
        const html = this._generateWidgetHTML(w, doc);
        const node = this.state.grid.addWidget({ w: 6, h: 4, content: html, id: w.id, autoPosition: true });
        w.x = node.gridstackNode.x; w.y = node.gridstackNode.y;
        doc.content.widgets.push(w);
        this._triggerSave();
        // Logic Fix: Ensure canvas initializes immediately after adding
        if (type === 'mudmap') setTimeout(() => this._initMudMaps(), 50);
    },
    _autoResizeWidget: function(widgetId) {
        // Batch 3.2: Deprecated.
        // We rely on GridStack manual sizing + Internal Flex Scrollbars (Batch 3.1).
        // No-op to prevent logic errors in legacy calls.
        return;
    },
    formatTime: function(el, docId) {
        // Logic Resolution: Robust manual time formatting (Smart Text)
        // 1400 -> 14:00, 930 -> 09:30
        let val = el.value.replace(/[^0-9]/g, '');
        if (val.length < 3) return; // Wait for at least 3 digits
        
        // Pad 3 digits to 4 (e.g., 800 -> 0800)
        if (val.length === 3) val = '0' + val;
        // Truncate if too long (e.g., pasted 12345)
        if (val.length > 4) val = val.substring(0, 4);

        let hh = parseInt(val.substring(0,2));
        let mm = parseInt(val.substring(2,4));
        
        // Logic Resolution: Enforce Military Time Constraint from Header Setting
        // This ensures the row data matches the document's declared format
        let is24h = false;
        if(docId) {
             const doc = budget.documents.find(d => d.id === docId);
             if(doc && doc.content.data.meta.is24h) is24h = true;
        }

        if (is24h) {
            // Military Clamp
            if (hh > 23) hh = 23;
        } else {
            // Standard Time Heuristics (Optional intelligent conversion could go here)
            if (hh > 23) hh = 23; 
        }
        
        if (mm > 59) mm = 59;
        
        // Output format is always HH:MM for data consistency
        el.value = String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
    },
    saveTemplate: function() { 
        const doc = budget.documents.find(d => d.id === this.state.currentDocId); 
        mBTME.prompt("Save Template", "Template Name:", doc.label + " Preset", (name) => {
            if(!name) return; 
            const tmpl = { id: 'tmpl_' + Date.now(), label: name, widgets: JSON.parse(JSON.stringify(doc.content.widgets)) }; 
            if(!budget.templates) budget.templates = []; 
            budget.templates.push(tmpl); 
            mBTME.alert("Success", `Template "${name}" saved.`);
        });
    },
    calcShootDay: function(dateStr) { if(!budget.startDate) return "Day 1"; const start = new Date(budget.startDate); const current = new Date(dateStr); if(isNaN(start) || isNaN(current)) return "Day 1"; const diffDays = Math.ceil((current - start) / (1000 * 60 * 60 * 24)) + 1; return `Day ${diffDays}`; },

    syncFromBudget: function() { 
        mBTME.confirm("Sync Data", "Import crew & data from current Budget?", () => {
            const doc = budget.documents.find(d => d.id === this.state.currentDocId); 
            // Invalidate Cache
            if (this.state._cache && this.state._cache.docId === doc.id) this.state._cache = null;

            // 1. Crew Map Logic (Budget Line Items -> Crew List)
            Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                if(i.crew && i.crew.name) {
                    // Check if already in list to avoid duplicates
                    const exists = doc.content.data.crew.some(c => c.name === i.crew.name && c.department === i.description);
                    if(!exists) {
                        this.addRow(doc.id, 'crew', 'person', { 
                            department: i.description, 
                            name: i.crew.name, 
                            contact: i.crew.phone, 
                            linkedItemId: i.id 
                        });
                    }
                }
            }));

            // 2. Key Contacts Logic (Map Specific Roles)
            const map = { 'director': 'Director', 'producer': 'Producer', 'ad': '1st AD' };
            Object.entries(map).forEach(([key, role]) => {
                // Scan Budget Line Items
                let found = null;
                Object.values(budget.sections).some(s => {
                    const i = s.items.find(x => x.description.toLowerCase().includes(role.toLowerCase()) && x.crew && x.crew.name);
                    if(i) { found = i.crew.name; return true; }
                });
                if(found) doc.content.data.contacts[key] = found;
            });

            // 3. Refresh
            mBTLE.reconcile(); 
            this.renderFrame(); 
            mBTME.alert("Sync Complete", "Budget personnel imported.");
        });
    },
    syncFromPrevious: function() { 
        const cur = budget.documents.find(d => d.id === this.state.currentDocId);
        if(!cur) return;
        
        let prev = null;
        let msg = "";

        if (cur.type === 'prodReport') {
            // Logic Resolution: Cross-Document Inheritance (DPR pulls from Call Sheet)
            const sheets = budget.documents.filter(d => d.type === 'callSheet')
                .sort((a,b) => (parseInt(b.id.split('_')[1])||0) - (parseInt(a.id.split('_')[1])||0));
            prev = sheets[0];
            msg = `Import data from Call Sheet "${prev?.label}"?`;
        } else {
            // Standard History: Inherit from previous of same type
            const others = budget.documents.filter(d => d.type === cur.type && d.id !== cur.id)
                .sort((a,b) => (parseInt(b.id.split('_')[1])||0) - (parseInt(a.id.split('_')[1])||0));
            prev = others[0];
            msg = `Import crew & contacts from "${prev?.label}"?`;
        }
            
        if(!prev) return mBTME.alert("Sync Info", "No source document found.");

        mBTME.confirm("Sync Previous", msg, () => {
            // Invalidate Cache
            if (this.state._cache && this.state._cache.docId === cur.id) this.state._cache = null;

            if(prev.content?.data?.contacts) cur.content.data.contacts = JSON.parse(JSON.stringify(prev.content.data.contacts));
            if(prev.content?.data?.crew) cur.content.data.crew = JSON.parse(JSON.stringify(prev.content.data.crew));
            
            // Logic Resolution: Date Inheritance for DPR
            if(cur.type === 'prodReport' && prev.content?.data?.meta?.shootDate) {
                cur.content.data.meta.shootDate = prev.content.data.meta.shootDate;
            }
            
            this._triggerSave();
            this.renderFrame();
        });
    },

    snapshotDoc: function() { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const newDoc = JSON.parse(JSON.stringify(doc)); newDoc.id = 'doc_' + Date.now(); newDoc.label = doc.label + " (Copy)"; budget.documents.push(newDoc); mBTDB.open(newDoc.id); },
    pullFromOpenGate: function(docId, path, roleQuery) { 
        if (typeof mBTOG === 'undefined') return mBTME.alert("System Error", "Database Resolution Failure."); 
        
        // Logic Resolution: Tier 5 Context-Aware Search
        // 1. Scan Active Budget First (Inheritance)
        const matches = [];
        const seen = new Set(); // Prevent duplicates

        if (budget.sections) {
            Object.values(budget.sections).forEach(sec => {
                sec.items.forEach(i => {
                    if (i.crew && i.crew.name && i.description.toLowerCase().includes(roleQuery.toLowerCase())) {
                        const key = `${i.crew.name}|${i.crew.phone}`;
                        if (!seen.has(key)) {
                            matches.push({
                                name: i.crew.name,
                                contact: i.crew.phone || i.crew.email,
                                role: i.description,
                                source: 'Budget' // Logic Resolution: Source tagging
                            });
                            seen.add(key);
                        }
                    }
                });
            });
        }

        // 2. Scan Global DB (Fallback)
        const globalMatches = mBTOG.contacts.filter(c => c.role?.toLowerCase().includes(roleQuery.toLowerCase())); 
        globalMatches.forEach(c => {
            const key = `${c.name}|${c.contact||c.phone}`;
            if (!seen.has(key)) {
                matches.push({ ...c, source: 'Global DB' });
                seen.add(key);
            }
        });

        if (matches.length === 0) return mBTME.alert("Not Found", `No ${roleQuery} found.`); 
        
        const apply = (c) => { 
            const parts = path.split('.'); 
            if(parts.length === 3 && (parts[0] === 'crew' || parts[0] === 'cast')) { 
                this.updateRow(docId, parts[0], parseInt(parts[1]), parts[2], c.name); 
                if(c.contact) this.updateRow(docId, parts[0], parseInt(parts[1]), 'contact', c.contact); 
            } else { 
                this.updateData(docId, path, `${c.name} ${c.contact ? '('+c.contact+')' : ''}`); 
            } 
            this.renderFrame(); 
        }; 
        
        if (matches.length === 1) {
            apply(matches[0]); 
        } else { 
            // Modern UI Replacement: Custom Modal with Buttons
            const listHtml = matches.map((c, i) => 
                `<button onclick="mBTDB._resolveOGSelection(${i})" class="w-full text-left p-3 bg-slate-50 hover:bg-blue-50 border border-transparent hover:border-blue-200 rounded-xl transition-all group mb-2">
                    <div class="flex justify-between items-center">
                        <div class="text-[10px] font-black uppercase text-slate-700 group-hover:text-blue-700">${c.name}</div>
                        <div class="text-[8px] font-bold text-slate-300 bg-white border border-slate-200 rounded px-1.5 py-0.5">${c.source}</div>
                    </div>
                    <div class="text-[9px] text-slate-400 font-mono">${c.contact || 'No Contact'}</div>
                </button>`
            ).join('');
            
            // Temporary resolver stored on the object to handle the async click
            this._resolveOGSelection = (idx) => {
                mBTME.close('ogSelectModal');
                if (matches[idx]) apply(matches[idx]);
                delete this._resolveOGSelection;
            };
            
            mBTME.open('ogSelect', `Select ${roleQuery}`, `<div class="p-4 max-h-[400px] overflow-y-auto no-scrollbar">${listHtml}</div>`, 'max-w-sm');
        } 
    },
    printToPDF: function(mode) { 
        if (typeof mBTPublisher === 'undefined') return mBTME.alert("Error", "Publisher Resolution Failure."); 
        const original = document.getElementById('mBTDB_Workspace'); 
        const clone = original.cloneNode(true); 
        clone.id = "mBTDB_Print_Container"; 
        clone.classList.remove('editing-mode'); 
        clone.classList.add('print-container', mode === 'standard' ? 'print-standard' : 'print-graphic'); 
        const originalInputs = original.querySelectorAll('input, textarea'); 
        const cloneInputs = clone.querySelectorAll('input, textarea'); 
        originalInputs.forEach((input, i) => { if(cloneInputs[i]) cloneInputs[i].value = input.value; }); 
        document.body.appendChild(clone); 
        mBTPublisher.exportToPDF('mBTDB_Print_Container', `${budget.projectName}_CallSheet`); 
        setTimeout(() => { document.body.removeChild(clone); }, 2000); 
    },

    // --- 6. Switchboard Integration ---
    _updateHeaderButtons: function() {
        const btnContainer = document.getElementById('mBTDB_Buttons'); 
        if(!btnContainer) return; 
        const isEd = this.state.isEditing;

        const pencilIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>`;
        const checkIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;

        // Widget Selector (Edit Mode Only)
        const widgetSelector = isEd ? `
            <div class="flex items-center bg-white rounded-lg px-2 py-1 mr-3 shadow-sm animate-in fade-in zoom-in duration-200 border border-slate-700/30">
                <select id="mBTDB_WidgetSelect" class="bg-transparent text-[10px] font-black uppercase tracking-widest text-slate-900 h-6 outline-none cursor-pointer border-none mr-2 w-24">
                    <option value="richText">Note Block</option>
                    <option value="image">Image Block</option>
                    <option value="schedule">Schedule</option>
                    <option value="cast">Cast List</option>
                    <option value="crew">Crew List</option>
                    <option value="logistics">Logistics</option>
                    <option value="contacts">Contacts</option>
                    <option value="transport">Transport</option>
                    <option value="mudmap">Mud Map</option>
                    <option value="footer">Safety Footer</option>
                </select>
                <button onclick="mBTDB.addWidget()" class="text-blue-600 hover:text-blue-800 transition-colors p-1 hover:bg-blue-50 rounded" title="Add Widget">
                    ${this.icons.plus}
                </button>
            </div>` : '';

        // Main Toolbar with Functional Grouping
        btnContainer.innerHTML = `
            <div class="flex items-center gap-1">
                ${widgetSelector}
                
                <!-- History Controls -->
                <div class="flex gap-1 mr-3 border-r border-slate-700/50 pr-3">
                    <button data-action="studio-undo" class="p-2 text-slate-400 hover:text-white transition-colors rounded-lg hover:bg-slate-800" title="Undo">${this.icons.undo}</button>
                    <button data-action="studio-redo" class="p-2 text-slate-400 hover:text-white transition-colors rounded-lg hover:bg-slate-800" title="Redo">${this.icons.redo}</button>
                </div>

                <!-- Integration Hub: Sync & Preview -->
                <div class="flex gap-1 mr-3 border-r border-slate-700/50 pr-3">
                    <button data-action="studio-sync" class="p-2 text-emerald-500 hover:text-emerald-400 transition-colors rounded-lg hover:bg-slate-800" title="Sync from Budget">${mBTAssets.sync}</button>
                    <button data-action="studio-sync-prev" class="p-2 text-blue-500 hover:text-blue-400 transition-colors rounded-lg hover:bg-slate-800" title="Sync from Previous">${mBTAssets.refresh}</button>
                    <button data-action="studio-preview" class="p-2 text-purple-500 hover:text-purple-400 transition-colors rounded-lg hover:bg-slate-800" title="Document Preview">${mBTAssets.image}</button>
                </div>

                <!-- Snapshot Tools -->
                <div class="flex gap-1 mr-3 border-r border-slate-700/50 pr-3">
                    <button data-action="studio-snapshot" class="p-2 text-slate-400 hover:text-white transition-colors rounded-lg hover:bg-slate-800" title="Duplicate Document">${this.icons.copy}</button>
                    <button data-action="studio-template" class="p-2 text-slate-400 hover:text-white transition-colors rounded-lg hover:bg-slate-800" title="Save Blueprint">${this.icons.save}</button>
                </div>

                <!-- Layout Toggle -->
                <button data-action="studio-toggle-edit" class="p-2 rounded-lg transition-all ${isEd ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-800'}" title="${isEd ? 'Finish Editing' : 'Edit Layout'}">
                    ${isEd ? checkIcon : pencilIcon}
                </button>
            </div>
        `;
    },

    _triggerSave: function() {

        if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
        if(typeof saveBudget === 'function') saveBudget();
    },
    _generateDefaultData: function() {
        return { 
            meta: { productionTitle: budget.projectName||"", productionCompany: budget.company||"", shootDate: new Date().toISOString().split('T')[0], crewCallTime: "08:00" }, 
            contacts: { director: "", producer: "", ad: "" }, 
            agency: { producer: "", creative: "" }, // Batch 1
            schedule: [], 
            crew: [], 
            cast: [], 
            locations: [{name:"Base Camp", address:"", weather:"", hospital:"", mapLink:""}], 
            transport: [], // Batch 2
            additional: {} 
        };
    }
};

    /* ======= TIER 5: Part 2: Module Controllers & Intelligence ======== */
    // --- ROOT NAMESPACE DECLARATION ---
    // Note: Namespace definition hoisted to Tier 1. 
    // We extend it here for Feature modules.

    /* ========= v19.54 BLUEPRINT ENGINE (mBT.features.blueprints) ========= */
    mBT.features.blueprints = {
        saveCurrentAsBlueprint: function() {
            if (!budget) return;
            mBTME.prompt("Save Blueprint", "Name this template:", budget.projectName + " Template", (name) => {
                if (!name) return;

                const structure = [];
                Object.values(budget.sections).forEach(sec => {
                    structure.push({
                        id: sec.id,
                        name: sec.name,
                        items: sec.items.map(i => ({
                            description: i.description,
                            unit: i.unit,
                            rate: i.rate,
                            multiplier: i.multiplier,
                            rateType: i.rateType
                            // Note: We strip actuals, crew, and transient IDs to create a clean template
                        }))
                    });
                });

                mBT.data.templates.saveTemplate(name, { 
                    structure: structure, 
                    label: name, 
                    desc: 'Custom User Blueprint',
                    icon: 'file'
                });
                
                mBTME.alert("Success", `Blueprint "${name}" saved! It is now available in the New Project menu.`);
            });
        }
    };
    
    // Core Action Binding for Blueprint
    mBT.core.action('blueprint-save', () => mBT.features.blueprints.saveCurrentAsBlueprint());

    /* ========= v19.54 ACTIVITY HISTORY (mBT.features.history) ========= */
    mBT.features.history = {
        open: function() {
            // Get logs, newest first
            const logs = (budget.activityLog || []).slice().reverse();
            
            const renderDiff = (diff) => {
                if(!diff || (diff.oldValue === undefined && diff.newValue === undefined)) return '';
                // Logic Resolution: Render visual diff for transparency
                return `<div class="mt-1 text-[9px] font-mono text-slate-500 bg-slate-50 p-1.5 rounded border border-slate-100 flex items-center gap-2">
                    <span class="line-through text-red-400 opacity-70">${mBT.ui.render.esc(diff.oldValue)}</span>
                    <span class="text-slate-300"></span>
                    <span class="text-emerald-600 font-bold">${mBT.ui.render.esc(diff.newValue)}</span>
                </div>`;
            };

            const listHtml = logs.length ? logs.map(l => {
                let iconColor = 'bg-blue-500';
                if(l.action === 'DELETE') iconColor = 'bg-rose-500';
                if(l.action === 'ADD') iconColor = 'bg-emerald-500';
                if(l.action === 'REORDER') iconColor = 'bg-amber-500';
                if(l.action === 'REVERT') iconColor = 'bg-purple-500';

                // Tier 5 Logic: Inject Revert Button for Reversible Actions
                let revertBtn = '';
                if (l.diff && l.action === 'UPDATE' && l.itemId) {
                    revertBtn = `<button onclick="mBT.data.history.revert('${l.id}')" class="opacity-0 group-hover:opacity-100 transition-opacity ml-2 px-2 py-1 bg-slate-100 hover:bg-rose-100 text-slate-400 hover:text-rose-600 rounded text-[8px] font-black uppercase tracking-widest" title="Revert value">Revert</button>`;
                }
                
                return `
                <div class="p-3 bg-white border-b border-slate-50 hover:bg-slate-50 transition-colors flex gap-3 group">
                    <div class="flex-shrink-0 mt-1.5">
                        <div class="w-1.5 h-1.5 rounded-full ${iconColor} shadow-sm"></div>
                    </div>
                    <div class="flex-grow min-w-0">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-black uppercase text-slate-700 tracking-widest truncate pr-2">${l.action}: ${mBT.ui.render.esc(l.target)}</span>
                            <span class="text-[8px] font-mono text-slate-400 shrink-0">${new Date(l.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="text-[9px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">${l.section}</div>
                            ${revertBtn}
                        </div>
                        ${renderDiff(l.diff)}
                    </div>
                </div>`;
            }).join('') : RenderEngine.ui.emptyState({ icon: mBTAssets.list, message: 'No Activity Recorded' });

            const content = `
                <div class="flex flex-col h-[500px] bg-slate-50">
                    <div class="p-4 bg-white border-b border-slate-100 shrink-0 flex justify-between items-center shadow-sm z-10">
                        <div>
                            <h3 class="text-xs font-black uppercase tracking-widest text-slate-800">Project Audit Log</h3>
                            <p class="text-[9px] text-slate-400 font-bold mt-0.5">${logs.length} Events</p>
                        </div>
                        <button onclick="mBT.features.history.export()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-50 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors text-[9px] font-black uppercase tracking-widest">
                            ${mBTAssets.save} Export CSV
                        </button>
                    </div>
                    <div class="flex-grow overflow-y-auto no-scrollbar">
                        ${listHtml}
                    </div>
                </div>`;
            
            mBTME.open('activityLog', 'History', content, 'max-w-md', { hideHeader: true, noPadding: true });
        },

        export: function() {
            if(!budget.activityLog?.length) return mBTME.alert("Empty", "No history to export.");
            
            // Logic Resolution: ISO Standard CSV Generation
            const headers = ["Timestamp", "User", "Action", "Target", "Section", "Old Value", "New Value"];
            const rows = budget.activityLog.map(e => {
                const escapeCsv = (val) => `"${String(val || '').replace(/"/g, '""')}"`;
                return [
                    e.ts,
                    e.user,
                    e.action,
                    e.target,
                    e.section,
                    e.diff?.oldValue,
                    e.diff?.newValue
                ].map(escapeCsv).join(",");
            });
            
            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${budget.projectName}_AuditLog_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    /* ========= v19.54 ANALYTICS CORTEX (mBT.features.cortex) ========= */
    mBT.features.cortex = {
        // --- 1. Logic Engine (The Brain) ---
        logic: {
            analyze: function() {
                const data = {
                    financials: { topCosts: [], bleeders: [], burnRate: 0 },
                    crew: { burnout: [], departmentLoad: {} },
                    stats: { totalItems: 0, assignedCrew: 0 }
                };
                
                const crewMap = {};
                let totalEst = 0;
                let totalAct = 0;
                let allItems = [];

                // A. Aggregation Loop
                if (budget && budget.sections) {
                    Object.values(budget.sections).forEach(sec => {
                        sec.items.forEach(item => {
                            data.stats.totalItems++;
                            const est = parseFloat(item.total) || 0; 
                            const act = parseFloat(item.actual) || 0;
                            const variance = act - est;
                            
                            totalEst += est;
                            totalAct += act;

                            allItems.push({ ...item, sectionName: sec.name, est, act, variance });

                            // Crew Aggregation Logic
                            if(item.crew && item.crew.name) {
                                data.stats.assignedCrew++;
                                const key = item.crew.name.toLowerCase();
                                if(!crewMap[key]) crewMap[key] = { name: item.crew.name, days: 0, roles: [], cost: 0 };
                                
                                // Day normalization (converting units to days for heatmap)
                                let days = parseFloat(item.quantity) || 0;
                                if(item.unit === 'Week') days *= 5;
                                else if(item.unit === 'Month') days *= 20;
                                else if(item.unit === 'Flat') days = 1; // Assumption for flat fees
                                
                                // Check Stage Data override (More accurate time tracking)
                                if(item.stageData) {
                                    let sDays = 0;
                                    Object.values(item.stageData).forEach(d => sDays += (parseFloat(d.days)||0));
                                    if(sDays > 0) days = sDays;
                                }

                                crewMap[key].days += days;
                                crewMap[key].cost += est;
                                // Avoid duplicate role names
                                const roleLabel = `${item.description} (${days}d)`;
                                if(!crewMap[key].roles.includes(roleLabel)) crewMap[key].roles.push(roleLabel);
                            }
                        });
                    });
                }

                // B. Financial Metrics
                data.financials.burnRate = totalEst > 0 ? (totalAct / totalEst) * 100 : 0;
                
                // Top Cost Drivers (The Heavy Hitters)
                data.financials.topCosts = [...allItems]
                    .sort((a,b) => b.est - a.est)
                    .slice(0, 5);

                // Top Bleeders (Variance > 0, highest mismatch)
                data.financials.bleeders = [...allItems]
                    .filter(i => i.variance > 0.01) // Filter out floating point noise
                    .sort((a,b) => b.variance - a.variance)
                    .slice(0, 5);

                // C. Crew Metrics
                data.crew.burnout = Object.values(crewMap)
                    .sort((a,b) => b.days - a.days)
                    .slice(0, 8); // Top 8 busiest people

                return data;
            },

            // --- Phase 9: Global Studio Scanner ---
            runGlobalAudit: async function() {
                const projects = await mBT.data.getList();
                const globalData = {
                    projectCount: projects.length,
                    totalBudget: 0,
                    totalSpend: 0,
                    crewEarnings: {},
                    projectSummaries: []
                };

                // Sequential load to prevent memory spike
                for (const pName of projects) {
                    // Manual load to bypass state wrapper
                    const raw = await mBT.data.storage.load(storageKeyPrefix + pName);
                    if (!raw) continue;

                    // Extract Metadata
                    const grandTotal = parseFloat(raw.grandTotal) || 0;
                    const actualTotal = parseFloat(raw.actualTotal) || 0;
                    
                    globalData.totalBudget += grandTotal;
                    globalData.totalSpend += actualTotal;

                    globalData.projectSummaries.push({
                        name: raw.projectName,
                        date: raw.startDate,
                        budget: grandTotal,
                        actual: actualTotal,
                        status: actualTotal > grandTotal ? 'Over' : 'Under'
                    });

                    // Deep Crew Scan
                    if (raw.sections) {
                        Object.values(raw.sections).forEach(sec => {
                            sec.items.forEach(item => {
                                if (item.crew && item.crew.name) {
                                    const key = item.crew.name;
                                    if (!globalData.crewEarnings[key]) globalData.crewEarnings[key] = 0;
                                    // Estimate earnings based on item total (Est) or Actual if available
                                    // Use Actual if > 0, else Est
                                    const earnings = (parseFloat(item.actual) > 0) ? parseFloat(item.actual) : (parseFloat(item.total) || 0);
                                    globalData.crewEarnings[key] += earnings;
                                }
                            });
                        });
                    }
                }

                // Sort Top Crew
                globalData.topCrew = Object.entries(globalData.crewEarnings)
                    .map(([name, amount]) => ({ name, amount }))
                    .sort((a, b) => b.amount - a.amount)
                    .slice(0, 10);

                return globalData;
            }
        },

        // --- 2. UI Engine (The Dashboard) ---
        ui: {
            openHub: function() {
                const analysis = mBT.features.cortex.logic.analyze();
                const fmt = mBTLE.format.currency;
                
                // --- Widget 1: Burn Rate KPI (Compact) ---
                // Visual logic: Green if <80%, Yellow <100%, Red >100%
                const burnRate = analysis.financials.burnRate;
                let burnColor = 'text-slate-800';
                if(burnRate > 100) burnColor = 'text-rose-600';
                else if(burnRate > 80) burnColor = 'text-amber-500';

                const burnWidget = `
                    <div class="col-span-1 md:col-span-2 p-4 bg-white rounded-2xl border border-slate-100 shadow-sm h-full flex flex-col justify-center items-center text-center">
                        <div class="text-[9px] font-black uppercase text-slate-300 mb-2 tracking-widest">Burn Rate</div>
                        <span class="text-3xl font-black ${burnColor} tracking-tighter">${burnRate.toFixed(1)}%</span>
                        <span class="text-[8px] font-bold text-slate-400 mt-1 uppercase tracking-wider">of budget</span>
                    </div>`;

                // --- Widget 2: Cost Drivers (List) ---
                const renderBar = (label, val, max, colorClass, subText) => {
                    const pct = max > 0 ? Math.min((val / max) * 100, 100) : 0;
                    return `
                    <div class="mb-3">
                        <div class="flex justify-between text-[9px] font-black uppercase text-slate-500 mb-1">
                            <span class="truncate pr-2" title="${RenderEngine.esc(label)}">${RenderEngine.esc(label)}</span>
                            <span>${fmt(val)}</span>
                        </div>
                        <div class="h-1.5 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full ${colorClass}" style="width: ${pct}%"></div>
                        </div>
                        ${subText ? `<div class="text-[8px] text-slate-400 font-mono mt-0.5 text-right">${subText}</div>` : ''}
                    </div>`;
                };

                const maxCost = analysis.financials.topCosts.length ? analysis.financials.topCosts[0].est : 1;
                const financialsWidget = `
                    <div class="col-span-1 md:col-span-4 p-4 bg-white rounded-2xl border border-slate-100 shadow-sm h-full overflow-y-auto no-scrollbar">
                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4 border-b border-slate-50 pb-2">Cost Drivers</h4>
                        
                        <div class="mb-6">
                            ${analysis.financials.topCosts.length ? analysis.financials.topCosts.map(i => renderBar(i.description, i.est, maxCost, 'bg-blue-600')).join('') : '<div class="text-[9px] text-slate-300 italic">No data</div>'}
                        </div>

                        ${analysis.financials.bleeders.length ? `
                            <div>
                                <div class="text-[9px] font-black uppercase text-rose-300 mb-3">Variance Alert</div>
                                ${analysis.financials.bleeders.map(i => renderBar(i.description, i.variance, i.variance, 'bg-rose-500', `Act: ${fmt(i.act)}`)).join('')}
                            </div>
                        ` : ''}
                    </div>`;

                // --- Widget 3: Human Heatmap Render ---
                const renderCrewRow = (c) => {
                    let statusColor = 'bg-emerald-100 text-emerald-700'; // Safe
                    let statusLabel = 'OK';
                    
                    if(c.days > 20) { statusColor = 'bg-rose-100 text-rose-700'; statusLabel = 'CRITICAL'; } 
                    else if(c.days > 10) { statusColor = 'bg-amber-100 text-amber-700'; statusLabel = 'HEAVY'; }
                    
                    return `
                    <div class="flex items-center justify-between p-2 mb-2 bg-slate-50 rounded-lg border border-transparent hover:border-slate-200 transition-colors">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-8 h-8 rounded-full bg-white text-slate-400 flex items-center justify-center font-black text-[9px] shadow-sm border border-slate-100 shrink-0">
                                ${c.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="min-w-0">
                                <div class="text-[10px] font-black text-slate-700 uppercase truncate" title="${RenderEngine.esc(c.name)}">${RenderEngine.esc(c.name)}</div>
                                <div class="text-[8px] text-slate-400 font-bold truncate">${c.roles.length} roles assigned</div>
                            </div>
                        </div>
                        <div class="text-right shrink-0">
                            <div class="px-2 py-1 rounded-md text-[9px] font-black ${statusColor} text-center">${statusLabel}</div>
                            <div class="text-[8px] text-slate-400 font-mono mt-0.5">${c.days} Days</div>
                        </div>
                    </div>`;
                };

                const crewWidget = `
                    <div class="col-span-1 md:col-span-3 p-4 bg-white rounded-2xl border border-slate-100 shadow-sm h-full overflow-y-auto no-scrollbar">
                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4 border-b border-slate-50 pb-2">Human Capital</h4>
                        
                        <div class="mb-6">
                            ${analysis.crew.burnout.length ? analysis.crew.burnout.map(renderCrewRow).join('') : '<div class="text-[9px] text-slate-300 italic">No crew data</div>'}
                        </div>
                    </div>`;

                // --- Widget 4: Live Auditor (Terminal) ---
                const auditorWidget = `
                    <div class="col-span-1 md:col-span-3 p-4 bg-slate-900 rounded-2xl border border-black shadow-2xl h-full flex flex-col relative overflow-hidden group">
                        <!-- Carbon Fiber Texture Overlay -->
                        <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(circle, #333 1px, transparent 1px); background-size: 4px 4px;"></div>
                        
                        <h4 class="text-[10px] font-black uppercase tracking-widest text-emerald-500 mb-4 border-b border-slate-800 pb-2 flex justify-between items-center z-10">
                            <span>Live Auditor</span>
                            <span class="flex h-2 w-2 relative">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                            </span>
                        </h4>
                        
                        <div id="cortex-terminal" class="flex-grow font-mono text-[10px] text-emerald-400 space-y-2 overflow-y-auto no-scrollbar leading-relaxed z-10">
                            <div class="opacity-50">> Initializing Cortex Engine v1.0...</div>
                            <div class="opacity-50">> Scanning ${analysis.stats.totalItems} data points...</div>
                            <div class="opacity-50">> Financial velocity calculated at ${analysis.financials.burnRate.toFixed(2)}%</div>
                            <div class="opacity-50">> Crew fatigue analysis complete.</div>
                            <div class="text-white mt-4 border-t border-slate-700 pt-2 font-bold">> SYSTEM READY. WAITING FOR AI AUDIT...</div>
                            <!-- AI Output targets here -->
                        </div>

                        <div class="mt-4 pt-4 border-t border-slate-800 z-10">
                             <button onclick="mBT.features.cortex.startLiveAuditor()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-black text-[10px] uppercase tracking-widest rounded-xl transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                                ${mBTAssets.zap} Run AI Risk Assessment
                             </button>
                        </div>
                    </div>`;

                // --- Grid Container (With Mission Control Toolbar) ---
                const content = `
                    <div class="flex flex-col h-[600px] max-h-[80vh] bg-slate-50 p-4">
                        <!-- Mission Control Toolbar -->
                        <div class="flex justify-between items-center mb-4 shrink-0">
                            <h3 class="text-xs font-black uppercase tracking-widest text-slate-400">Mission Control</h3>
                            <div class="flex gap-2">
                                <button onclick="mBT.features.cortex.ui.openGlobalDashboard()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-900 text-white border border-slate-900 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-slate-700 transition-all shadow-sm">
                                    Global View
                                </button>
                                <button onclick="mBT.features.ai.analyzeCurrentBudget()" class="flex items-center gap-2 px-3 py-1.5 bg-white border border-indigo-100 text-indigo-600 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-indigo-50 transition-all shadow-sm">
                                    ${mBTAssets.doctor} Deep Scan
                                </button>
                                <button onclick="mBT.features.ai.openChat()" class="flex items-center gap-2 px-3 py-1.5 bg-white border border-emerald-100 text-emerald-600 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-emerald-50 transition-all shadow-sm">
                                    ${mBTAssets.chat} Chat
                                </button>
                                <button onclick="showSettingsModal('ai')" class="flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-100 text-slate-600 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all shadow-sm">
                                    ${mBTAssets.gear}
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 flex-grow overflow-hidden min-h-0">
                            ${burnWidget}
                            ${financialsWidget}
                            ${crewWidget}
                            ${auditorWidget}
                        </div>
                    </div>`;

                mBTME.open('analyticsHub', 'Cortex Dashboard', content, 'max-w-5xl', { noPadding: true, hideHeader: true });
                
                // Manually inject close button since header is hidden
                const closeBtn = `<button onclick="mBTME.close('analyticsHubModal')" class="absolute top-4 right-4 z-50 p-2 bg-white rounded-full text-slate-400 hover:text-rose-500 shadow-sm transition-all hover:rotate-90">${mBTAssets.close}</button>`;
                const body = document.getElementById('analyticsHubModalBody');
                if(body) body.insertAdjacentHTML('beforeend', closeBtn);
            },

            openGlobalDashboard: async function() {
                mBTME.showLoader("Scanning Studio Archives...");
                try {
                    const data = await mBT.features.cortex.logic.runGlobalAudit();
                    mBTME.hideLoader();
                    
                    const fmt = mBTLE.format.currency;
                    
                    const kpiCard = (label, val, sub, color) => `
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-center text-center">
                            <div class="text-[9px] font-black uppercase text-slate-300 mb-2 tracking-widest">${label}</div>
                            <span class="text-2xl font-black ${color} tracking-tighter">${val}</span>
                            <span class="text-[8px] font-bold text-slate-400 mt-1 uppercase tracking-wider">${sub}</span>
                        </div>`;

                    const crewList = data.topCrew.map((c, i) => `
                        <div class="flex justify-between items-center p-2 border-b border-slate-50 last:border-0">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-[9px] font-black">${i + 1}</div>
                                <span class="text-[10px] font-bold text-slate-700 uppercase">${RenderEngine.esc(c.name)}</span>
                            </div>
                            <span class="text-[10px] font-mono font-bold text-emerald-600">${fmt(c.amount)}</span>
                        </div>
                    `).join('');

                    const projectList = data.projectSummaries.map(p => `
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl mb-2 border border-transparent hover:border-blue-200 transition-colors cursor-pointer" onclick="mBT.data.load('${p.name}'); mBTME.close('analyticsHubModal');">
                            <div>
                                <div class="text-[10px] font-black text-slate-800 uppercase">${RenderEngine.esc(p.name)}</div>
                                <div class="text-[8px] text-slate-400 font-bold">${p.date || 'No Date'}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-[10px] font-mono font-bold text-slate-600">${fmt(p.actual)} / ${fmt(p.budget)}</div>
                                <div class="text-[8px] font-black uppercase tracking-widest ${p.status === 'Over' ? 'text-rose-500' : 'text-emerald-500'}">${p.status}</div>
                            </div>
                        </div>
                    `).join('');

                    const content = `
                        <div class="flex flex-col h-[600px] max-h-[80vh] bg-slate-50 p-6 overflow-hidden">
                            <div class="flex justify-between items-center mb-6 shrink-0">
                                <div>
                                    <h3 class="text-lg font-black uppercase tracking-tighter text-slate-900">Global Studio Audit</h3>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Aggregate Analysis across ${data.projectCount} Projects</p>
                                </div>
                                <button onclick="mBT.features.cortex.ui.openHub()" class="text-slate-400 hover:text-blue-600 transition-colors flex items-center gap-1 text-[9px] font-black uppercase tracking-widest">
                                     Back to Project
                                </button>
                            </div>

                            <div class="grid grid-cols-3 gap-4 mb-6 shrink-0">
                                ${kpiCard('Total Spend (Actual)', fmt(data.totalSpend), 'Across All Projects', 'text-slate-800')}
                                ${kpiCard('Total Budget (Est)', fmt(data.totalBudget), 'Lifetime Projection', 'text-blue-600')}
                                ${kpiCard('Project Volume', data.projectCount, 'Active Files', 'text-indigo-500')}
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow min-h-0">
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex flex-col overflow-hidden">
                                    <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4 border-b border-slate-50 pb-2">Top Earners (Crew)</h4>
                                    <div class="overflow-y-auto no-scrollbar space-y-1">
                                        ${crewList || '<div class="text-center text-slate-300 text-[10px] mt-10">No crew data found.</div>'}
                                    </div>
                                </div>
                                <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex flex-col overflow-hidden">
                                    <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4 border-b border-slate-50 pb-2">Recent Projects</h4>
                                    <div class="overflow-y-auto no-scrollbar">
                                        ${projectList}
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    mBTME.open('analyticsHub', 'Global Dashboard', content, 'max-w-5xl', { noPadding: true, hideHeader: true });

                } catch (e) {
                    mBTME.hideLoader();
                    mBTME.alert("Audit Failed", "Could not scan local database.");
                    console.error(e);
                }
            },
            
            // Phase 3: Active AI Auditor Wiring
            startAuditor: async function() {
                 const term = document.getElementById('cortex-terminal');
                 if(!term) return;

                 // 1. UI Feedback
                 term.innerHTML += `<div class="mt-4 text-emerald-400 animate-pulse">> ESTABLISHING SECURE CONNECTION...</div>`;
                 term.scrollTop = term.scrollHeight;

                 // 2. Security Check
                 const provider = mBT.features.ai.getSelectedProvider();
                 const apiKey = mBT.features.ai.getStoredApiKey(provider);
                 
                 if(!apiKey) {
                     term.innerHTML += `<div class="mt-2 text-rose-500 font-bold">> ERROR: NO API KEY DETECTED. CONFIGURE SETTINGS.</div>`;
                     term.scrollTop = term.scrollHeight;
                     return;
                 }

                 // 3. Payload Construction
                 const analysis = mBT.features.cortex.logic.analyze();
                 const context = {
                     burnRate: analysis.financials.burnRate.toFixed(1) + '%',
                     topCosts: analysis.financials.topCosts.map(i => `${i.description}: ${mBTLE.format.currency(i.est)}`),
                     varianceBleeders: analysis.financials.bleeders.map(i => `${i.description} (Over by ${mBTLE.format.currency(i.variance)})`),
                     overworkedCrew: analysis.crew.burnout.filter(c => c.days > 6).map(c => `${c.name} (${c.days} days)`),
                     totalItems: analysis.stats.totalItems
                 };

                 const prompt = `ACT AS A HOSTILE COMPLETION GUARANTOR. 
                 DATA: ${JSON.stringify(context)}. 
                 TASK: Issue 3 short, brutal directives to reduce risk. 
                 FORMAT: Plain text, no markdown formatting (no bold/italic), typewriter style. Start lines with "> "`;

                 // 4. Execution
                 try {
                     const response = await mBT.features.ai.callUnifiedAI(provider, apiKey, prompt);
                     
                     // 5. Typewriter Effect Render
                     term.innerHTML += `<div class="mt-4 text-white border-t border-slate-700 pt-2">> INCOMING TRANSMISSION:</div><div class="mt-2 text-emerald-300 space-y-2" id="cortex-stream"></div>`;
                     
                     const streamEl = document.getElementById('cortex-stream');
                     // Split by newlines but handle markdown bullet points if AI ignores instructions
                     const lines = response.split('\n').filter(l => l.trim());
                     
                     let delay = 0;
                     lines.forEach((line, i) => {
                         setTimeout(() => {
                             // clean markdown bold
                             const cleanLine = line.replace(/\*\*/g, '').replace(/\*/g, '').trim(); 
                             streamEl.innerHTML += `<div class="mb-1 font-mono text-[10px]">${mBT.ui.render.esc(cleanLine)}</div>`;
                             term.scrollTop = term.scrollHeight;
                         }, delay);
                         delay += 800; // Slow typewriter pace
                     });

                 } catch(err) {
                     term.innerHTML += `<div class="mt-2 text-rose-500">> CONNECTION FAILURE: ${mBT.ui.render.esc(err.message)}</div>`;
                     term.scrollTop = term.scrollHeight;
                 }
            }
        },

        // --- Public Accessor ---
        startLiveAuditor: function() { this.ui.startAuditor(); }
    };

    
    // Core Action
    mBT.core.action('analytics-hub', () => mBT.features.cortex.ui.openHub());
    
    // Global Alias Overrides (Replacing the old AI menu with the new Dashboard)
    window.openAnalyticsHub = () => mBT.features.cortex.ui.openHub();

    /* ========= v19.54 STAGE INTELLIGENCE (mBT.features.stages) ========= */
    mBT.features.stages = {
        definitions: {
            'dev': ['writer', 'script', 'research', 'option', 'rights', 'legal', 'development', 'story', 'attorney', 'concept'],
            'pre': ['scout', 'casting', 'rehearsal', 'director', 'producer', 'coordinator', 'location', 'travel', 'prep', 'storyboard'],
            'prod': ['camera', 'sound mixer', 'boom', 'lighting', 'grip', 'gaffer', 'electric', 'art', 'wardrobe', 'costume', 'makeup', 'hair', 'unit', 'pa', 'production assistant', 'catering', 'craft', 'medic', 'security', 'transport', 'dop', 'cinematographer', 'operator', 'dit', 'utility'],
            'post': ['editor', 'color', 'vfx', 'sound design', 'sound edit', 'mix', 'music', 'score', 'post', 'titles', 'graphic', 'visual effects', 'composer'],
            'dist': ['marketing', 'sales', 'festival', 'publicity', 'premiere', 'distribution', 'deliverables', 'trailer']
        },
        logic: {
            // Strategy A: Find items existing in budget but not linked to stage
            findMatchesInBudget: function(stageKey) {
                const keywords = mBT.features.stages.definitions[stageKey] || [];
                const matches = [];
                if (!budget || !budget.sections) return [];
                
                Object.entries(budget.sections).forEach(([secName, sec]) => {
                    sec.items.forEach(item => {
                        // Skip if already in this stage
                        if (item.stageData && item.stageData[stageKey]) return;
                        
                        const text = (item.description + ' ' + secName).toLowerCase();
                        if (keywords.some(w => text.includes(w))) {
                            matches.push(item);
                        }
                    });
                });
                return matches;
            },
            // Strategy B: Find items in DB that are missing from budget entirely
            findMissingEssentials: function(stageKey) {
                const keywords = mBT.features.stages.definitions[stageKey] || [];
                const db = mBTOG.rates || [];
                const existingDesc = new Set();
                
                if (budget && budget.sections) {
                    Object.values(budget.sections).forEach(s => s.items.forEach(i => existingDesc.add(i.description.toLowerCase())));
                }
                
                return db.filter(dbItem => {
                    const text = dbItem.description.toLowerCase();
                    const isRelevant = keywords.some(w => text.includes(w));
                    const exists = existingDesc.has(text);
                    return isRelevant && !exists;
                });
            },
            // Logic Resolution: Smart removal logic linked to UI button
            removeItem: function(btn) {
                const itemId = btn.dataset.id;
                const sectionName = btn.dataset.section;
                const stageKey = btn.dataset.stage;

                let item = null;
                // Try fast lookup
                if (sectionName && budget.sections[sectionName]) {
                    item = budget.sections[sectionName].items.find(i => String(i.id) === String(itemId));
                }
                // Fallback scan
                if (!item) {
                    Object.values(budget.sections).forEach(sec => {
                        if(!item) item = sec.items.find(i => String(i.id) === String(itemId));
                    });
                }

                if (item) {
                    // Enhanced Confirmation with item name
                    mBTME.confirm("Remove from Stage", `Remove "${item.description}" from this stage? The main budget item will remain.`, () => {
                        if (item.stageData && item.stageData[stageKey]) {
                            delete item.stageData[stageKey];
                            saveBudget();
                            if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
                            if(window.showStagesModal) window.showStagesModal();
                        }
                    });
                }
            }
        },
        ui: {
            openAutoFillMenu: function(stageKey) {
                const matches = mBT.features.stages.logic.findMatchesInBudget(stageKey);
                const missing = mBT.features.stages.logic.findMissingEssentials(stageKey);
                const stageLabel = (budget.targetLock && budget.targetLock.stages[stageKey]) ? budget.targetLock.stages[stageKey].label : stageKey.toUpperCase();

                const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
                    <!-- Option A: Link Existing -->
                    <div class="bg-blue-50 border border-blue-100 p-5 rounded-2xl flex flex-col justify-between h-full group hover:border-blue-200 transition-colors">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-lg bg-blue-200 text-blue-700 flex items-center justify-center shadow-sm">${mBTAssets.clip}</div>
                                <h4 class="font-black text-[10px] uppercase tracking-widest text-blue-800">Link Existing</h4>
                            </div>
                            <p class="text-[10px] text-blue-600/80 leading-relaxed mb-4">
                                Scan your current budget line items. We found <strong>${matches.length}</strong> items that match this stage's criteria but haven't been assigned yet.
                            </p>
                        </div>
                        <button onclick="window.handleStageAutoFill('${stageKey}', 'link'); mBTME.close('autoFillModal');" class="w-full py-3 bg-blue-600 text-white rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-blue-700 transition-all shadow-md active:scale-95 flex items-center justify-center gap-2" ${matches.length === 0 ? 'disabled style="opacity:0.5"' : ''}>
                            Sync ${matches.length} Items
                        </button>
                    </div>

                    <!-- Option B: Generate Missing -->
                    <div class="bg-emerald-50 border border-emerald-100 p-5 rounded-2xl flex flex-col justify-between h-full group hover:border-emerald-200 transition-colors">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-lg bg-emerald-200 text-emerald-700 flex items-center justify-center shadow-sm">${mBTAssets.wand}</div>
                                <h4 class="font-black text-[10px] uppercase tracking-widest text-emerald-800">Generate Missing</h4>
                            </div>
                            <p class="text-[10px] text-emerald-600/80 leading-relaxed mb-4">
                                Database check complete. We found <strong>${missing.length}</strong> standard industry roles/items for this stage that are completely missing from your budget.
                            </p>
                        </div>
                        <button onclick="window.handleStageAutoFill('${stageKey}', 'generate'); mBTME.close('autoFillModal');" class="w-full py-3 bg-emerald-600 text-white rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-md active:scale-95 flex items-center justify-center gap-2" ${missing.length === 0 ? 'disabled style="opacity:0.5"' : ''}>
                            ${mBTAssets.plus} Add ${missing.length} Items
                        </button>
                    </div>
                </div>
                <div class="px-4 pb-4 text-center">
                    <p class="text-[8px] font-bold text-slate-300 uppercase tracking-widest">Changes are saved automatically upon execution</p>
                </div>`;
                
                mBTME.open('autoFill', `Smart Fill: ${stageLabel}`, content, 'max-w-xl');
            }
        }
    };

    /* ========= v19.54 RECYCLE BIN (mBT.features.trash) ========= */
		mBT.features.trash = {
        state: { activeTab: 'documents', selected: new Set() },
        icons: { folder: mBTAssets.folder, file: mBTAssets.file, trash: mBTAssets.trash, undo: mBTAssets.undo, check: mBTAssets.target },
      
        open: function(tab = 'documents') {
            const currentTab = this.state.activeTab;
            // Logic Resolution: Clear selections only when switching context
            if (tab !== currentTab) this.state.selected.clear();
            this.state.activeTab = tab;

            const type = this.state.activeTab;
            const docTrash = budget.documentTrash || [];
            const projectTrash = JSON.parse(localStorage.getItem(trashKey) || '[]');
            
            const items = type === 'documents' ? docTrash : projectTrash;
            const selectedCount = this.state.selected.size;
            const hasItems = items.length > 0;

            // Tier 5 Update: Manual Tab Construction for Event Delegation
            const tabs = [
                { id: 'documents', label: 'Documents', count: docTrash.length },
                { id: 'projects', label: 'Projects', count: projectTrash.length }
            ];
            
            const tabHtml = `<div class="flex border-b border-slate-100 bg-slate-50/50 rounded-t-xl overflow-hidden select-none">
                ${tabs.map(t => {
                    const isActive = t.id === type;
                    const activeClass = "bg-white text-blue-600 border-b-2 border-blue-600 shadow-sm";
                    const inactiveClass = "text-slate-400 hover:text-slate-600 hover:bg-slate-100/50";
                    return `<button data-action="nav-trash" data-tab="${t.id}" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest transition-all ${isActive ? activeClass : inactiveClass}">
                        ${t.label} <span class="opacity-50 ml-1">(${t.count})</span>
                    </button>`;
                }).join('')}
            </div>`;

            // Logic Resolution: Dynamic Toolbar for Bulk Actions with Checkbox Logic
            const toolbarHtml = `
                <div class="px-4 py-3 bg-white border-b border-slate-100 flex items-center justify-between sticky top-0 z-20 shadow-sm">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" 
                               data-action="trash-toggle-all"
                               ${hasItems && selectedCount === items.length ? 'checked' : ''} 
                               ${!hasItems ? 'disabled' : ''}
                               class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                        <span class="text-[9px] font-black uppercase tracking-widest text-slate-400">${selectedCount} Selected</span>
                    </div>
                    <div class="flex gap-2">
                        ${selectedCount > 0 ? `
                            <button data-action="trash-bulk" data-type="restore" class="px-3 py-1.5 bg-emerald-50 text-emerald-600 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-emerald-100 transition-all flex items-center gap-1">${this.icons.undo} Restore</button>
                            <button data-action="trash-bulk" data-type="delete" class="px-3 py-1.5 bg-rose-50 text-rose-600 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-rose-100 transition-all flex items-center gap-1">${this.icons.trash} Delete</button>
                        ` : `
                            <button data-action="trash-bulk" data-type="empty" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-rose-50 hover:text-rose-600 transition-all" ${!hasItems ? 'disabled style="opacity:0.5"' : ''}>Empty Bin</button>
                        `}
                    </div>
                </div>`;

            let listHtml = '';
            
            if (!hasItems) {
                listHtml = RenderEngine.ui.emptyState({
                    icon: this.icons.trash,
                    message: 'Bin is Empty',
                    subtext: type === 'documents' ? 'No deleted documents found' : 'No deleted projects found'
                });
            } else {
                listHtml = items.map(item => {
                    const id = type === 'documents' ? item.id : item.projectName; // Projects use name as ID in trash
                    const isSel = this.state.selected.has(id);
                    const label = type === 'documents' ? (item.label || item.name || 'Untitled') : (item.projectName || 'Untitled Project');
                    const meta = type === 'documents' ? `Type: ${item.type || 'Custom'}` : `Company: ${item.company || 'Indie'}`;
                    
                    return `
                    <div class="flex items-center justify-between p-3 bg-white border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors group cursor-pointer" data-action="trash-toggle" data-id="${RenderEngine.esc(id)}">
                        <div class="flex items-center gap-3 overflow-hidden flex-grow">
                            <div class="flex-shrink-0">
                                <input type="checkbox" ${isSel ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 pointer-events-none">
                            </div>
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-white group-hover:text-blue-500 group-hover:shadow-sm transition-all text-lg shrink-0">
                                ${type === 'documents' ? this.icons.file : this.icons.folder}
                            </div>
                            <div class="overflow-hidden min-w-0">
                                <div class="text-[10px] font-black uppercase text-slate-700 truncate">${RenderEngine.esc(label)}</div>
                                <div class="text-[9px] text-slate-400 font-bold truncate">${RenderEngine.esc(meta)}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                            <button data-action="trash-single" data-type="restore" data-id="${RenderEngine.esc(id)}" class="p-2 text-slate-300 hover:text-emerald-500 transition-colors" title="Restore">${this.icons.undo}</button>
                            <button data-action="trash-single" data-type="delete" data-id="${RenderEngine.esc(id)}" class="p-2 text-slate-300 hover:text-rose-500 transition-colors" title="Delete Forever">${this.icons.trash}</button>
                        </div>
                    </div>`;
                }).join('');
            }

            // Logic Resolution: Persistent UI Updates (Prevents Flickering/Re-opening)
            const domId = 'trashModal';
            const existingModal = document.getElementById(domId);
            
            if (existingModal) {
                const nav = document.getElementById('trashTabNav');
                const tool = document.getElementById('trashToolbarArea');
                const list = document.getElementById('trashListArea');
                
                if (nav) nav.innerHTML = tabHtml;
                if (tool) tool.innerHTML = toolbarHtml;
                if (list) list.innerHTML = listHtml;
                return;
            }

            const content = `
                <div class="flex flex-col h-[600px] max-h-[80vh]">
                    <div id="trashTabNav">${tabHtml}</div>
                    <div id="trashToolbarArea">${toolbarHtml}</div>
                    <div id="trashListArea" class="flex-grow overflow-y-auto p-4 bg-slate-50 no-scrollbar space-y-2">
                        ${listHtml}
                    </div>
                </div>`;
            mBTME.open('trash', 'Recycle Bin', content, 'max-w-lg', { noPadding: true, hideHeader: true });
        },
        
        // --- Selection Logic ---
        toggleItem: function(id) {
            if (this.state.selected.has(id)) this.state.selected.delete(id);
            else this.state.selected.add(id);
            this.open(this.state.activeTab); // Re-render state
        },
        toggleAll: function(checked) {
            this.state.selected.clear();
            if (checked) {
                const list = this.state.activeTab === 'documents' ? (budget.documentTrash||[]) : JSON.parse(localStorage.getItem(trashKey)||'[]');
                list.forEach(i => this.state.selected.add(this.state.activeTab === 'documents' ? i.id : i.projectName));
            }
            this.open(this.state.activeTab);
        },

        // --- Action Routers ---
        singleAction: function(action, id) {
            this.state.selected.clear();
            this.state.selected.add(id);
            this.performAction(action);
        },
        
        performAction: function(action) {
            const isDoc = this.state.activeTab === 'documents';
            const count = this.state.selected.size;
            
            // Empty Bin Logic
            if (action === 'empty') {
                mBTME.confirm("Empty Bin", `Permanently delete ALL items in the ${isDoc?'Documents':'Projects'} bin? This cannot be undone.`, () => {
                    if(isDoc) budget.documentTrash = [];
                    else localStorage.setItem(trashKey, '[]');
                    saveBudget();
                    this.open(this.state.activeTab);
                });
                return;
            }

            if (count === 0) return;

            // Delete / Restore Logic
            if (action === 'delete') {
                mBTME.confirm("Delete Forever", `Permanently delete ${count} selected item(s)? This cannot be undone.`, () => {
                    if(isDoc) {
                        budget.documentTrash = budget.documentTrash.filter(d => !this.state.selected.has(d.id));
                        saveBudget();
                    } else {
                        const list = JSON.parse(localStorage.getItem(trashKey)||'[]');
                        const filtered = list.filter(p => !this.state.selected.has(p.projectName));
                        localStorage.setItem(trashKey, JSON.stringify(filtered));
                    }
                    this.state.selected.clear();
                    this.open(this.state.activeTab);
                });
            } else if (action === 'restore') {
                mBTME.confirm("Restore Items", `Restore ${count} selected item(s)?`, () => {
                    if(isDoc) {
                        const toRestore = budget.documentTrash.filter(d => this.state.selected.has(d.id));
                        budget.documentTrash = budget.documentTrash.filter(d => !this.state.selected.has(d.id));
                        if(!budget.documents) budget.documents = [];
                        budget.documents.push(...toRestore);
                        saveBudget();
                        render(); // Refresh main view to show restored docs
                    } else {
                        const list = JSON.parse(localStorage.getItem(trashKey)||'[]');
                        const keptTrash = [];
                        list.forEach(p => {
                            if(this.state.selected.has(p.projectName)) {
                                const key = storageKeyPrefix + p.projectName;
                                // Check collision
                                if(localStorage.getItem(key)) {
                                    // Note: Simplified logic here for restoration collision to avoid nested confirms
                                    localStorage.setItem(key, JSON.stringify(p));
                                } else {
                                    localStorage.setItem(key, JSON.stringify(p));
                                }
                            } else {
                                keptTrash.push(p);
                            }
                        });
                        localStorage.setItem(trashKey, JSON.stringify(keptTrash));
                        if(typeof renderProjectManagement === 'function') renderProjectManagement(); // Refresh project dropdown
                    }
                    this.state.selected.clear();
                    this.open(this.state.activeTab);
                });
            }
        },

        // --- External Hooks ---
        trashDocument: function(docId) {
            mBTME.confirm("Archive Document", "Move this document to the Recycle Bin?", () => {
                const idx = budget.documents.findIndex(d => d.id === docId);
                if (idx > -1) {
                    const doc = budget.documents.splice(idx, 1)[0];
                    if (!budget.documentTrash) budget.documentTrash = [];
                    budget.documentTrash.push(doc);
                    saveBudget();
                    render(); // Update Vault UI if open
                    if (document.getElementById('documentsModal')) showDocumentsModal();
                }
            });
        }
    };
    
    // --- Backward Compatibility Alias (for buttons using old global names) ---
    window.mBTTrash = mBT.features.trash;


    /* ========= v19.54 SETTINGS & CONFIGURATION (mBT.features.settings) ========= */
    mBT.features.settings = {
        
        // --- 1. Sub-View Generators ---
        renderDbView: function(subTab) {
            if (subTab === 'contacts') {
                const globalContacts = mBTOG.contacts || [];
                const assignedContacts = [];
                Object.values(budget.sections || {}).forEach(sec => {
                    sec.items.forEach(item => {
                        if (item.crew && item.crew.name) {
                            assignedContacts.push({
                                id: 'assigned_' + item.id,
                                name: item.crew.name,
                                role: item.description || 'Crew',
                                phone: item.crew.phone || '',
                                email: item.crew.email || '',
                                assigned: true
                            });
                        }
                    });
                });
                const allContacts = [...globalContacts];
                assignedContacts.forEach(ac => {
                    if (!allContacts.some(gc => gc.name.toLowerCase() === ac.name.toLowerCase())) {
                        allContacts.push(ac);
                    }
                });

                const listContent = allContacts.length > 0 ? allContacts.map(c => RenderEngine.ui.listRow({
                    id: c.id,
                    icon: c.name ? c.name.charAt(0).toUpperCase() : '?',
                    title: c.name,
                    subtitle: `${c.role || 'No Role'}${c.assigned ? ' (Assigned)' : ''}`,
                    onClick: `openCrewProfile(this, event, '${c.id}', null)`,
                    actions: c.assigned ? [] : [{
                        icon: mBTAssets.trash,
                        title: 'Delete',
                        color: 'rose',
                        onClick: `mBT.features.settings.deleteContact('${c.id}')`
                    }]
                })).join('') : RenderEngine.ui.emptyState({ icon: mBTAssets.user, message: 'No Contacts Found' });

                return `
                    <div class="flex flex-col h-full bg-white overflow-hidden rounded-xl border border-slate-100 shadow-sm">
                        <div class="p-3 bg-indigo-50 border-b border-indigo-100 flex flex-col gap-3 shrink-0 z-10">
                            <div class="flex justify-center gap-3 flex-wrap">
                                <button onclick="mBT.features.settings.openAddContactModal()" class="bg-indigo-200 text-indigo-800 px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-indigo-300 transition-all flex items-center gap-1.5">
                                    ${mBTAssets.plus} Add
                                </button>
                                <input type="file" id="csvImportInput" class="hidden" accept=".csv" onchange="importContactsCSV(this)">
                                <button onclick="document.getElementById('csvImportInput').click()" class="bg-indigo-200 text-indigo-800 px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-indigo-300 transition-all flex items-center gap-1.5">
                                    ${mBTAssets.plus} Import CSV
                                </button>
                                <button onclick="mBTAssign.assignFromContacts()" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest shadow-sm active:scale-95 transition-all">
                                    Auto-Assign
                                </button>
                            </div>
                            <div class="relative">
                                <input type="text" id="contactsSearchInput" placeholder="SEARCH PERSONNEL..." class="w-full p-2.5 pr-10 bg-white border border-indigo-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-indigo-300 transition-all">
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none">${mBTAssets.search}</div>
                            </div>
                        </div>
                        <div id="contactsListBody" class="flex-grow overflow-y-auto no-scrollbar relative bg-white">
                            ${listContent}
                        </div>
                    </div>`;
            }
            if (subTab === 'lineItems') {
                const isSharing = mBTOG.settings.optInSharing;
                return `
                    <div class="flex flex-col h-full bg-white overflow-hidden rounded-xl border border-slate-100 shadow-sm">
                        <div class="p-3 bg-slate-50 border-b border-slate-100 shrink-0 z-10 space-y-3">
                            <div class="flex gap-2">
                                <button onclick="mBT.features.settings.openAddRateModal()" class="flex-1 py-2 bg-white border border-slate-200 rounded-lg text-[9px] font-black uppercase tracking-widest text-slate-600 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm flex items-center justify-center gap-2">
                                    ${mBTAssets.plus} Add Line Item
                                </button>
                                <button onclick="mBT.features.settings.toggleOpenGateSharing()" class="flex-1 py-2 border rounded-lg text-[9px] font-black uppercase tracking-widest transition-all shadow-sm flex items-center justify-center gap-2 ${isSharing ? 'bg-emerald-50 border-emerald-200 text-emerald-600' : 'bg-white border-slate-200 text-slate-400 hover:text-slate-600'}">
                                    ${mBTAssets.cloud} ${isSharing ? 'Sharing On' : 'Share Data'}
                                </button>
                            </div>
                            <div class="relative">
                                <input type="text" id="dbSearchInput" placeholder="SEARCH GLOBAL RATES..." class="w-full p-2.5 pr-10 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-blue-100 transition-all">
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">${mBTAssets.search}</div>
                            </div>
                        </div>
                        <div id="dbListBody" class="flex-grow overflow-y-auto no-scrollbar relative min-h-0 bg-white">
                            ${mBTOG.rates.map(r => RenderEngine.ui.listRow({
                                id: r.id || r.description,
                                icon: mBTAssets.money, 
                                title: r.description,
                                subtitle: `${mBTLE.format.currency(r.rate)} / ${r.unit}`,
                                classes: 'border-b border-slate-50'
                            })).join('')}
                        </div>
                    </div>`;
            }
            if (subTab === 'templates') {
                const templates = Array.isArray(mBTOG.templates) ? mBTOG.templates : [];
                const listContent = templates.length > 0 ? templates.map(t => RenderEngine.ui.listRow({
                    id: t.id,
                    icon: mBTAssets[t.icon] || mBTAssets.file,
                    title: t.label,
                    subtitle: t.cat || 'General',
                    actions: [{
                        icon: mBTAssets.plus,
                        title: 'Use Template',
                        color: 'blue',
                        onClick: `createNewDocumentFromTemplate('${t.id}')`
                    }]
                })).join('') : RenderEngine.ui.emptyState({ icon: mBTAssets.file, message: 'No Templates' });

                return `
                    <div class="flex flex-col h-full bg-white overflow-hidden rounded-xl border border-slate-100 shadow-sm">
                        <div class="p-3 bg-indigo-50 border-b border-indigo-100 shrink-0 z-10">
                             <div class="relative">
                                <input type="text" id="templateSearchInput" placeholder="SEARCH TEMPLATES..." class="w-full p-2.5 pr-10 bg-white border border-indigo-200 rounded-xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-2 focus:ring-indigo-300 transition-all">
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none">${mBTAssets.search}</div>
                            </div>
                        </div>
                        <div id="templatesListBody" class="flex-grow overflow-y-auto no-scrollbar relative bg-white">
                            ${listContent}
                        </div>
                    </div>`;
            }
            return '';
        },

        // --- 2. Main Content Generator ---
        getTabContent: function(tabName, subTab = 'lineItems') {
            if (tabName === 'general') {
                const currentDateFormat = getProjectDateFormat();
                const currentSeparator = getProjectNameSeparator();
                const isCompact = budget.settings?.compactMode || false;
                const syncAoD = budget.settings?.syncAoD || false;
                // Logic Resolution: Prep for future legacy theme switch
                const isClassic = budget.settings?.classicTheme || false;
                const allowZoom = budget.settings?.allowZoom || false;
              
                return `
                    <div class="h-full overflow-y-auto no-scrollbar p-6 space-y-6 animate-in fade-in duration-300">
                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center justify-center text-center gap-3">
                            <div class="w-16 h-16 rounded-2xl shadow-lg border-2 border-slate-50 overflow-hidden bg-[#fdba35]">${mBTAssets.appLogo}</div>
                            <div>
                                <h3 class="text-xs font-black uppercase tracking-widest text-slate-800">MooBudget Studio</h3>
                                <p class="text-[9px] text-slate-400 font-bold mt-1">Build v${APP_VERSION}  ${navigator.onLine ? '<span class="text-emerald-500">Online</span>' : '<span class="text-rose-500">Offline</span>'}</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Date Format</label>
                                    <select id="dateFormatSelect" onchange="localStorage.setItem('${projectDateFormatKey}', this.value)" class="w-full text-[10px] p-2 bg-slate-50 border-none rounded-lg font-bold outline-none cursor-pointer">
                                        <option value="YYYYMMDD" ${currentDateFormat === 'YYYYMMDD' ? 'selected' : ''}>YYYY-MM-DD</option>
                                        <option value="MMDDYYYY" ${currentDateFormat === 'MMDDYYYY' ? 'selected' : ''}>MM-DD-YYYY</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Separator</label>
                                    <input type="text" id="separatorInput" maxlength="1" value="${currentSeparator}" onchange="localStorage.setItem('${projectNameSeparatorKey}', this.value)" class="w-full text-[10px] p-2 bg-slate-50 border-none rounded-lg font-bold text-center outline-none">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-800">Allow Page Zoom</h4>
                                        <p class="text-[9px] text-slate-400 font-bold mt-0.5">Enable pinch-to-zoom gestures</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="zoomToggle" ${allowZoom ? 'checked' : ''} onchange="if(!budget.settings) budget.settings={}; budget.settings.allowZoom = this.checked; saveBudget(); mBT.ui.updateViewport();" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                    </label>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-800">Compact View</h4>
                                        <p class="text-[9px] text-slate-400 font-bold mt-0.5">Denser layout for small screens</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="compactModeToggle" ${isCompact ? 'checked' : ''} onchange="if(!budget.settings) budget.settings={}; budget.settings.compactMode = this.checked; saveBudget(); render();" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    </label>
                                </div>
                            </div>
                            <!-- NEW: Classic Theme Placeholder -->
                            <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-800">Classic Theme</h4>
                                        <p class="text-[9px] text-slate-400 font-bold mt-0.5">Legacy visual style (Pre-v19.54)</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="classicThemeToggle" ${isClassic ? 'checked' : ''} onchange="if(!budget.settings) budget.settings={}; budget.settings.classicTheme = this.checked; saveBudget(); render();" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-slate-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                             <a href="https://raw.githubusercontent.com/jaysonmy/moobudget/refs/heads/main/index.html" target="_blank" download="moobudget-beta.html" class="flex items-center justify-center gap-2 px-4 py-3 bg-slate-100 text-slate-600 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-slate-200 transition-colors">${mBTAssets.cloud} Get Beta</a>
                             <button onclick="hardResetApp()" class="flex items-center justify-center gap-2 px-4 py-3 bg-rose-50 text-rose-600 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-rose-100 transition-colors">${mBTAssets.zap} Fix Bugs</button>
                        </div>
                        <div class="flex justify-center">
                             <button onclick="mBTME.close('settingsModal'); showCoffeeWidget();" class="flex items-center gap-2 px-8 py-4 bg-[#FFDD00] text-black rounded-xl font-black text-[10px] uppercase tracking-widest hover:scale-105 transition-transform shadow-lg">${mBTAssets.coffee} Support Development</button>
                        </div>
                    </div>`;
            }
            if (tabName === 'ai') {
                const provider = getSelectedProvider();
                const saveHistory = budget.aiContext?.saveHistory ?? true;
                const storedPrompt = mBT.features.ai.getSystemPrompt();
                
                // Logic Resolution: Map for dynamic "Get API Key" links
                const keyLinks = {
                    'gemini': 'https://aistudio.google.com/app/apikey',
                    'openai': 'https://platform.openai.com/api-keys',
                    'deepseek': 'https://platform.deepseek.com/api_keys',
                    'grok': 'https://console.x.ai/'
                };
                
                return `
                    <div class="h-full overflow-y-auto no-scrollbar p-6 space-y-6 animate-in fade-in duration-300">
                        <div class="p-5 bg-slate-900 rounded-2xl border border-black shadow-lg text-white">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Assistant</h3>
                                    <p class="text-[9px] text-slate-500 font-bold mt-0.5">Configure Provider Access</p>
                                </div>
                                <div class="text-slate-700">${mBTAssets.sparkle}</div>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1.5">Active Provider</label>
                                    <select id="aiProviderSelect" onchange="const link=document.getElementById('apiKeyLink'); const map=${JSON.stringify(keyLinks).replace(/"/g, "'")}; link.href=map[this.value];" class="w-full bg-slate-800 text-white border-none rounded-lg p-2.5 text-[10px] font-bold outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer">
                                        <option value="gemini" ${provider === 'gemini' ? 'selected' : ''}>Google Gemini API</option>
                                        <option value="openai" ${provider === 'openai' ? 'selected' : ''}>OpenAI API</option>
                                        <option value="deepseek" ${provider === 'deepseek' ? 'selected' : ''}>DeepSeek API</option>
                                        <option value="grok" ${provider === 'grok' ? 'selected' : ''}>Grok (xAI) API</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-1.5">
                                        <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest">API Credentials</label>
                                        <a id="apiKeyLink" href="${keyLinks[provider] || '#'}" target="_blank" class="text-[9px] font-bold text-blue-400 hover:text-blue-300 uppercase tracking-widest flex items-center gap-1 transition-colors">
                                            Get API Key <span></span>
                                        </a>
                                    </div>
                                    <input type="password" id="apiKeyInput" value="${getStoredApiKey(provider)}" class="w-full bg-slate-800 text-white border-none rounded-lg p-2.5 text-[10px] font-mono outline-none focus:ring-1 focus:ring-blue-500" placeholder="sk-...">
                                </div>
                                <div>
                                    <label class="block text-[8px] font-black text-slate-500 uppercase tracking-widest mb-1.5">Persona & Constraints</label>
                                    <textarea id="aiSystemPromptInput" class="w-full bg-slate-800 text-white border-none rounded-lg p-2.5 text-[10px] outline-none focus:ring-1 focus:ring-blue-500 resize-none h-16 placeholder-slate-600" placeholder="e.g. Be sarcastic. Focus only on Below The Line. Use JMD currency symbol.">${storedPrompt}</textarea>
                                </div>
                                <div class="flex items-center gap-3 py-1">
                                    <div class="relative flex items-center">
                                        <input type="checkbox" id="aiContextToggle" ${saveHistory ? 'checked' : ''} onchange="if(!budget.aiContext) budget.aiContext={chat:[], analysis:''}; budget.aiContext.saveHistory = this.checked; saveBudget();" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                                    </div>
                                    <label for="aiContextToggle" class="text-[9px] font-bold text-slate-400 uppercase tracking-wide cursor-pointer select-none">Save Conversation Context</label>
                                </div>
                                <button id="saveApiKeyBtn" onclick="const p=document.getElementById('aiProviderSelect').value; const k=document.getElementById('apiKeyInput').value; const s=document.getElementById('aiSystemPromptInput').value; saveStoredApiKey(p,k); mBT.features.ai.saveSystemPrompt(s); localStorage.setItem('${storageKeyPrefix}selectedAiProvider', p); mBTME.alert('Success', 'Assistant Linked');" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black uppercase tracking-widest text-[9px] shadow-lg hover:bg-blue-500 transition-all mt-2">Synchronize Link</button>
                            </div>
                        </div>
                    </div>`;
            }
            if (tabName === 'database') {
                const nav = RenderEngine.ui.tabs({
                    items: [
                        { id: 'lineItems', label: 'Line Items' },
                        { id: 'contacts', label: 'Contacts' },
                        { id: 'templates', label: 'Templates' }
                    ],
                    activeId: subTab,
                    onClick: "mBT.features.settings.open('database',"
                }).replace(/open\('database',\s*'([^']+)'\)/g, "open('database', '$1')"); 

                return `<div class="flex flex-col h-full p-6 pb-0 overflow-hidden space-y-4">
                    ${nav.replace(/onclick="mBT.features.settings.open\('database',\('([^']+)'\)\)"/g, "onclick=\"mBT.features.settings.open('database', '$1')\"")} 
                    <div class="flex-grow flex flex-col relative overflow-hidden min-h-0">
                        ${this.renderDbView(subTab)}
                    </div>
                </div>`;
            }
            return `<div class="p-8 text-center text-slate-300 font-bold uppercase tracking-widest">Logic Stream Not Found</div>`;
        },

        // --- 3. Main Entry Point ---
        open: function(tab = 'general', subTab = 'lineItems') {
            const domId = 'settingsModal';
            const contentHTML = this.getTabContent(tab, subTab);
            
            // Tier 5 Update: Manual Tab Construction for Event Delegation
            const tabs = [
                { id: 'general', label: `General` },
                { id: 'database', label: `Database` },
                { id: 'ai', label: `AI` }
            ];
            
            const tabNavHTML = `<div class="flex border-b border-slate-100 bg-slate-50/50 rounded-t-xl overflow-hidden select-none">
                ${tabs.map(t => {
                    const isActive = t.id === tab;
                    const activeClass = "bg-white text-blue-600 border-b-2 border-blue-600 shadow-sm";
                    const inactiveClass = "text-slate-400 hover:text-slate-600 hover:bg-slate-100/50";
                    return `<button data-action="nav-settings" data-tab="${t.id}" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest transition-all ${isActive ? activeClass : inactiveClass}">
                        ${t.label}
                    </button>`;
                }).join('')}
            </div>`;

            const existingModal = document.getElementById(domId);
            if (existingModal) {
                const contentArea = document.getElementById('settingsContentArea');
                const navArea = document.getElementById('settingsTabNav');
                if (contentArea) contentArea.innerHTML = contentHTML;
                if (navArea) navArea.innerHTML = tabNavHTML;
                this._attachListeners(tab, subTab);
                return;
            }

            const fullContent = `
                <div class="flex flex-col min-h-[600px] max-h-[90vh] bg-slate-50/50">
                    <div id="settingsTabNav" class="shrink-0 bg-white">
                        ${tabNavHTML}
                    </div>
                    <div id="settingsContentArea" class="flex-grow flex flex-col relative overflow-hidden">
                        ${contentHTML}
                    </div>
                </div>`;
            mBTME.open('settings', 'Settings', fullContent, 'max-w-2xl', { noPadding: true, hideHeader: true });
            this._attachListeners(tab, subTab);
        },

        // --- 4. Internal Logic & Listeners ---
        _attachListeners: function(tab, subTab) {
            if (tab === 'database' && subTab === 'lineItems') {
                mBTME.attachSearch('dbSearchInput', 'dbListBody', mBTOG.rates, (r) => RenderEngine.ui.listRow({
                    id: r.id || r.description,
                    icon: mBTAssets.money,
                    title: r.description,
                    subtitle: `${mBTLE.format.currency(r.rate)} / ${r.unit}`,
                    classes: 'border-b border-slate-50'
                }));
            }
            if (tab === 'database' && subTab === 'contacts') {
                const globalContacts = mBTOG.contacts || [];
                const assignedContacts = [];
                Object.values(budget.sections || {}).forEach(sec => {
                    sec.items.forEach(item => {
                        if (item.crew && item.crew.name) assignedContacts.push({id: 'assigned_'+item.id, name: item.crew.name, role: item.description||'Crew', assigned: true});
                    });
                });
                const allContacts = [...globalContacts];
                assignedContacts.forEach(ac => { if(!allContacts.some(gc=>gc.name.toLowerCase()===ac.name.toLowerCase())) allContacts.push(ac); });
                
                mBTME.attachSearch('contactsSearchInput', 'contactsListBody', allContacts, (c) => RenderEngine.ui.listRow({
                    id: c.id,
                    icon: c.name ? c.name.charAt(0).toUpperCase() : '?',
                    title: c.name,
                    subtitle: `${c.role || 'No Role'}${c.assigned ? ' (Assigned)' : ''}`,
                    actions: c.assigned ? [] : [{ icon: mBTAssets.trash, title: 'Delete', color: 'rose', onClick: `mBT.features.settings.deleteContact('${c.id}')` }]
                }));
            }
            if (tab === 'database' && subTab === 'templates') {
                mBTME.attachSearch('templateSearchInput', 'templatesListBody', mBTOG.templates, (t) => RenderEngine.ui.listRow({
                    id: t.id,
                    icon: t.icon || '',
                    title: t.label,
                    subtitle: t.cat || 'General',
                    actions: [{ icon: mBTAssets.plus, title: 'Use Template', color: 'blue', onClick: `createNewDocumentFromTemplate('${t.id}')` }]
                }));
            }
        },

        // --- 5. Action Handlers ---
        openAddContactModal: function() {
            const dummyItem = { id: 'dummy_new_contact', crew: { name: '', phone: '', email: '' } };
            const dummySection = 'general';
            openCrewProfile(null, null, dummyItem.id, dummySection);
        },
        addContact: function(e) {
            // ... Logic moved here if invoked directly, but mostly handled by openCrewProfile form commit ...
        },
        deleteContact: function(id) {
            mBTME.confirm("Delete Contact", "Remove this global contact?", () => {
                const idx = mBTOG.contacts.findIndex(c => c.id === id);
                if(idx > -1) {
                    mBTOG.contacts.splice(idx, 1);
                    localStorage.setItem('moo_contacts', JSON.stringify(mBTOG.contacts));
                    this.open('database', 'contacts'); // Refresh
                }
            });
        },

        // --- 6. Database Tools (Tier 5 Additions) ---
        openAddRateModal: function() {
            const content = `
                <div class="space-y-4 p-2">
                    <div>
                        <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Description</label>
                        <input type="text" id="newRateDesc" class="w-full p-3 bg-slate-50 border-none rounded-xl text-xs font-black uppercase tracking-tighter outline-none focus:ring-2 focus:ring-blue-100" placeholder="ITEM NAME">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Rate</label>
                            <input type="number" id="newRateVal" class="w-full p-3 bg-slate-50 border-none rounded-xl text-xs font-mono font-bold outline-none focus:ring-2 focus:ring-blue-100" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Unit</label>
                            <select id="newRateUnit" class="w-full p-3 bg-slate-50 border-none rounded-xl text-xs font-bold outline-none cursor-pointer">
                                <option value="Day">Day</option>
                                <option value="Flat">Flat</option>
                                <option value="Week">Week</option>
                                <option value="Hour">Hour</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="mBT.features.settings.addRate()" class="w-full py-4 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-2xl shadow-xl hover:bg-black transition-all active:scale-95 mt-4">Add to Database</button>
                </div>`;
            mBTME.open('addRate', 'New Global Rate', content, 'max-w-sm');
        },

        addRate: function() {
            const desc = document.getElementById('newRateDesc').value.trim();
            const rate = parseFloat(document.getElementById('newRateVal').value) || 0;
            const unit = document.getElementById('newRateUnit').value;

            if (!desc) return mBTME.alert("Error", "Description required");

            mBTOG.rates.push({ description: desc, rate: rate, unit: unit });
            mBTOG.saveRates(); // Calls Tier 2.5 persistence
            
            mBTME.close('addRateModal');
            this.open('database', 'lineItems'); // Refresh list
        },

        toggleOpenGateSharing: function() {
            mBTOG.settings.optInSharing = !mBTOG.settings.optInSharing;
            localStorage.setItem('moo_og_share', JSON.stringify(mBTOG.settings.optInSharing));
            
            // Visual feedback
            if (mBTOG.settings.optInSharing) {
                mBTME.alert("Sharing Active", "Open Gate Sharing Enabled. Anonymous rate data will be synchronized.");
            }
            this.open('database', 'lineItems'); // Refresh UI toggle state
        }
    };

    /* ========= v19.54 FINANCE ENGINE (mBT.features.finance) ========= */
    mBT.features.finance = {
        openModal: function(itemId) {
            // 1. Locate Context
            let item = null;
            let sectionName = null;
            
            // Scan budget to find the specific line item
            Object.entries(budget.sections).forEach(([secName, sec]) => {
                const found = sec.items.find(i => i.id === itemId);
                if (found) { item = found; sectionName = secName; }
            });

            if (!item) return mBTME.alert("Error", "Line item not found.");

            // 2. Calculate Balance
            const est = parseFloat(item.total) || 0;
            const act = parseFloat(item.actual) || 0;
            const balance = est - act;
            const contactName = item.crew?.name || item.description;

            // 3. Render
            // Uses Tier 4 Render Engine template we added in Phase 3
            const content = mBT.ui.render.paymentModal(itemId, contactName, balance, displayCurrency);
            mBTME.open('payment', 'Issue Payment', content, 'max-w-sm', { hideHeader: true, noPadding: true });
            
            // 4. Focus Input
            setTimeout(() => {
                const input = document.getElementById('payAmount');
                if(input) input.focus();
            }, 50);
        },

        processPayment: function(itemId) {
            // 1. Capture Inputs
            const amountEl = document.getElementById('payAmount');
            const serviceEl = document.getElementById('payService');
            const dateEl = document.getElementById('payDate');
            
            const amount = parseFloat(amountEl.value);
            const serviceId = serviceEl.value;
            const date = dateEl.value;

            if (!amount || amount <= 0) return mBTME.alert("Error", "Valid amount required.");

            // 2. Update Budget (Local)
            let item = null;
            Object.values(budget.sections).forEach(sec => {
                if(!item) item = sec.items.find(i => i.id === itemId);
            });

            if (item) {
                const currentActual = parseFloat(item.actual) || 0;
                item.actual = currentActual + amount;
                
                // 3. Update Global History (Persistence)
                // We link via Name/Role because IDs might be transient across projects, 
                // but if we have a linked global ID, we use that.
                if (item.crew && item.crew.name) {
                    const globalContact = mBTOG.contacts.find(c => 
                        c.name.toLowerCase() === item.crew.name.toLowerCase()
                    );
                    
                    if (globalContact) {
                        if (!globalContact.payments) globalContact.payments = [];
                        globalContact.payments.push({
                            projectId: budget.projectName,
                            date: date,
                            amount: amount,
                            currency: displayCurrency,
                            service: serviceId,
                            description: item.description
                        });
                        mBTOG.saveContacts(); // Persist to Global DB
                    }
                }

                // 4. Save & Feedback
                mBTLE.reconcile(); // Recalculate Totals
                saveBudget();      // Persist Project
                mBT.ui.paint();    // Update UI Row
                
                mBTME.close('paymentModal');
                mBTME.alert("Success", `Payment of ${mBTLE.format.currency(amount)} logged.`);
            } else {
                mBTME.alert("Error", "Item reference lost.");
            }
        }
    };

    /* --- v19.54 PUBLISH BRIDGE --- */
    window.showPublishModal = function() {
        const content = `
        <div class="grid grid-cols-1 gap-4 p-6">
            <!-- PDF Button -->
            <button data-action="export" data-type="pdf" class="flex items-center gap-4 p-4 bg-white border border-slate-200 rounded-2xl hover:border-blue-500 hover:shadow-lg transition-all group text-left">
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform">${mBTAssets.print}</div>
                <div>
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">Export PDF (Report)</h4>
                    <p class="text-[10px] text-slate-400 font-bold mt-1">Professional Formatted Document</p>
                </div>
            </button>

            <!-- Save Project (Bundle .moo) -->
            <button data-action="export" data-type="bundle" class="flex items-center gap-4 p-4 bg-white border border-slate-200 rounded-2xl hover:border-emerald-500 hover:shadow-lg transition-all group text-left">
                <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform">${mBTAssets.save}</div>
                <div>
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">Master Project File</h4>
                    <p class="text-[10px] text-slate-400 font-bold mt-1">Unified Container (.moo) - Includes Assets</p>
                </div>
            </button>
            
            <!-- Digital/HTML -->
           <button data-action="export" data-type="html" class="flex items-center gap-4 p-4 bg-white border border-slate-200 rounded-2xl hover:border-purple-500 hover:shadow-lg transition-all group text-left">
                <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform">${mBTAssets.phone}</div>
                <div>
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">Digital Export</h4>
                    <p class="text-[10px] text-slate-400 font-bold mt-1">Interactive HTML Call Sheet</p>
                </div>
            </button>

            <!-- Excel -->
            <button data-action="export" data-type="xlsx" class="flex items-center gap-4 p-4 bg-white border border-slate-200 rounded-2xl hover:border-indigo-500 hover:shadow-lg transition-all group text-left">
                <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform">${mBTAssets.grid}</div>
                <div>
                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">Excel Export</h4>
                    <p class="text-[10px] text-slate-400 font-bold mt-1">Spreadsheet (.xlsx)</p>
                </div>
            </button>
        </div>`;
        mBTME.open('publish', 'Publish & Export', content, 'max-w-sm');
    };
    
    // --- Backward Compatibility Alias ---
    // Fix: We use .bind() to ensure 'this' refers to the settings object, not the window
    window.showSettingsModal = mBT.features.settings.open.bind(mBT.features.settings);

 // ---- Tier 5 Part 3 ---- //



/* ========= v19.54 DOCUMENTS HUB (mBT.features.documents) ========= */
    mBT.features.documents = {
        // Logic Resolution: Creates a new document instance from a template definition
        createFromTemplate: function(templateId) {
            const tmpl = mBTOG.templates.find(t => t.id === templateId);
            if (!tmpl) return mBTME.alert("Error", "Template definition not found.");

            const newDoc = {
                id: 'doc_' + Date.now(),
                type: tmpl.id, 
                label: tmpl.label,
                content: {
                    data: mBTDB._generateDefaultData(),
                    widgets: [] // Populated by mBTDB.open based on type defaults
                }
            };
            
            if (!budget.documents) budget.documents = [];
            budget.documents.push(newDoc);
            
            saveBudget();
            mBTME.close('newDocSelectorModal');
            
            // Refresh Vault list if open
            if(document.getElementById('documentsModal')) this.openVault();
            
            // Logic Resolution: Intercept auto-open. Show options instead.
            this.showOptions(newDoc.id);
        },

// Logic Resolution: Opens the Document Vault (List of saved docs)
        openVault: function(activeTab = 'All') {
            const docs = budget.documents || [];
            
            // Helper: Resolve Template Metadata
            const getTmpl = (type) => mBTOG.templates.find(x => x.id === type) || { cat: 'Other', icon: 'file' };
            const getCat = (type) => getTmpl(type).cat;
            const getIcon = (type) => mBTAssets[getTmpl(type).icon] || mBTAssets.file;

            // Filter Logic
            const filteredDocs = activeTab === 'All' 
                ? docs 
                : docs.filter(d => getCat(d.type) === activeTab);

            // Logic Resolution: View Layout Strategy linked to Settings
            const isCompact = budget.settings?.compactMode || false;
            
            // 2. Define Layout Classes (Grid vs List)
            const listContainerClass = (isCompact && filteredDocs.length > 0)
                ? 'grid grid-cols-2 md:grid-cols-3 gap-4 content-start' 
                : 'flex flex-col gap-3';
            
            // 3. Adjust Modal Width based on View
            const modalWidth = (isCompact && filteredDocs.length > 0) ? 'max-w-5xl' : 'max-w-2xl';

            // Logic Resolution: Dynamic Item Renderer (Grid Card vs List Row)
            const renderDocItem = (doc) => {
                const iconSvg = getIcon(doc.type);
                if (isCompact) {
                    // Grid Card (Vertical Layout) - Tier 5 Event Delegation Update
                    return `
                    <div class="relative group bg-white p-4 rounded-2xl border border-slate-100 hover:border-blue-200 shadow-sm hover:shadow-md transition-all cursor-pointer flex flex-col items-center gap-3 text-center h-full" data-action="doc-options" data-id="${doc.id}">
                         <div class="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 group-hover:text-blue-500 group-hover:bg-blue-50 transition-colors shrink-0">
                            ${iconSvg}
                         </div>
                         <div class="w-full overflow-hidden">
                            <div class="text-[10px] font-black uppercase text-slate-700 truncate w-full" title="${RenderEngine.esc(doc.label)}">${RenderEngine.esc(doc.label || 'Untitled')}</div>
                            <div class="text-[9px] text-slate-400 font-bold truncate w-full">${doc.type ? doc.type.toUpperCase() : 'DOC'}</div>
                         </div>
                         <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 bg-white/90 rounded-lg shadow-sm p-1">
                            <button data-action="doc-duplicate" data-id="${doc.id}" class="p-1 hover:bg-blue-50 text-slate-400 hover:text-blue-500 rounded" title="Duplicate">${mBTAssets.copy}</button>
                            <button data-action="doc-archive" data-id="${doc.id}" class="p-1 hover:bg-rose-50 text-slate-400 hover:text-rose-500 rounded" title="Archive">${mBTAssets.trash}</button>
                         </div>
                    </div>`;
                } else {
                    // List Row (Horizontal Layout) - Tier 5 Event Delegation Update
                    return `<div class="group bg-white p-4 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md hover:border-blue-200 transition-all flex items-center justify-between cursor-pointer">
                        <div class="flex items-center gap-4 flex-grow overflow-hidden" data-action="doc-options" data-id="${doc.id}">
                            <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-100 group-hover:scale-110 transition-transform shrink-0">
                                ${iconSvg}
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-black text-slate-900 text-xs uppercase tracking-tighter truncate">${mBT.ui.render.esc(doc.label || 'Untitled Document')}</h4>
                                <p class="text-[9px] text-blue-500 font-bold uppercase tracking-widest truncate">${doc.type ? doc.type.charAt(0).toUpperCase() + doc.type.slice(1) : 'Document'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0">
                            <button data-action="doc-duplicate" data-id="${doc.id}" class="p-2 text-slate-300 hover:text-blue-600 transition-colors" title="Duplicate">${mBTAssets.copy}</button>
                            <button data-action="doc-archive" data-id="${doc.id}" class="p-2 text-slate-300 hover:text-rose-600 transition-colors" title="Archive">${mBTAssets.trash}</button>
                        </div>
                    </div>`;
                }
            };

            const docsHtml = filteredDocs.length > 0 
                ? filteredDocs.map(renderDocItem).join('') 
                : `<div class="col-span-full">${RenderEngine.ui.emptyState({ 
                    icon: mBTAssets.file, 
                    message: activeTab === 'All' ? 'Vault is Empty' : 'No Documents', 
                    subtext: 'Create a new document to get started' 
                })}</div>`;

            // Tab Navigation
            const categories = ['All', 'Pre-Prod', 'Production', 'Post-Prod', 'Legal'];
            
            // Tier 5 Update: Manual Tab Construction for Event Delegation
            const tabHtml = `<div class="flex border-b border-slate-100 bg-slate-50/50 rounded-t-xl overflow-hidden select-none">
                ${categories.map(c => {
                    const count = c === 'All' ? docs.length : docs.filter(d => getCat(d.type) === c).length;
                    const isActive = c === activeTab;
                    const activeClass = "bg-white text-blue-600 border-b-2 border-blue-600 shadow-sm";
                    const inactiveClass = "text-slate-400 hover:text-slate-600 hover:bg-slate-100/50";
                    return `<button data-action="nav-docs" data-tab="${c}" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest transition-all ${isActive ? activeClass : inactiveClass}">
                        ${c} <span class="opacity-50 ml-1">(${count})</span>
                    </button>`;
                }).join('')}
            </div>`;

            // Logic Resolution: Persistent UI Updates (Prevents Flickering/Re-opening)
            const domId = 'documentsModal';
            const existingModal = document.getElementById(domId);
            
            if (existingModal) {
                const nav = document.getElementById('docsTabNav');
                const list = document.getElementById('activeDocsList');
                
                if (nav) nav.innerHTML = tabHtml;
                if (list) {
                    list.className = listContainerClass;
                    list.innerHTML = docsHtml;
                }
                
                const searchContainer = document.getElementById('docSearchContainer');
                if (searchContainer) {
                    searchContainer.innerHTML = `<input type="text" id="docSearch" placeholder="SEARCH ${activeTab.toUpperCase()}..." class="w-full p-3 pr-10 bg-slate-50 border-none rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-4 focus:ring-blue-50 transition-all"><div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">${mBTAssets.search}</div>`;
                }

                mBTME.attachSearch('docSearch', 'activeDocsList', filteredDocs, renderDocItem);
                return;
            }

            const content = `
                <div class="flex flex-col max-h-[90vh]">
                    <div class="p-6 pb-0 bg-white border-b border-slate-100 flex-shrink-0 z-10 space-y-4">
                        <div class="flex justify-between items-center relative">
                            <!-- Left: Add Button -->
                            <button onclick="mBT.features.documents.openTemplateSelector()" class="px-4 py-2 bg-slate-900 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-black transition-all flex items-center gap-2 shadow-sm active:scale-95">
                                ${mBTAssets.plus} Add
                            </button>
                            
                            <!-- Center: Title -->
                            <h3 class="absolute left-1/2 -translate-x-1/2 font-black text-slate-900 text-xs uppercase tracking-widest">DOCUMENTS</h3>
                            
                            <!-- Right: Actions -->
                            <div class="flex gap-2">
                                <button onclick="mBT.features.trash.open('documents')" class="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-rose-500 hover:bg-rose-50 transition-all" title="Recycle Bin">${mBTAssets.trash}</button>
                                <button onclick="mBTME.close('documentsModal')" class="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-slate-600 transition-all">${mBTAssets.close}</button>
                            </div>
                        </div>
                        
                        <!-- Search -->
                        <div class="relative" id="docSearchContainer">
                            <input type="text" id="docSearch" placeholder="SEARCH DOCUMENTS..." class="w-full p-3 pr-10 bg-slate-50 border-none rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">${mBTAssets.search}</div>
                        </div>

                        <!-- Tab Nav -->
                        <div id="docsTabNav" class="-mb-px">
                            ${tabHtml}
                        </div>
                    </div>
                    
                    <div class="flex-grow overflow-y-auto no-scrollbar bg-slate-50/50 p-6">
                        <div id="activeDocsList" class="${listContainerClass}">
                            ${docsHtml}
                        </div>
                    </div>
                </div>`;
            
            mBTME.open('documents', 'Documents', content, modalWidth, { noPadding: true, hideHeader: true });
        
            mBTME.attachSearch('docSearch', 'activeDocsList', filteredDocs, renderDocItem);
        },

        // Logic Resolution: Opens the Template Selector (Blueprints)
        openTemplateSelector: function() {
            const templates = mBTOG.templates || [];
            const renderTmplItem = (tmpl) => RenderEngine.ui.card({
                id: tmpl.id,
                icon: mBTAssets[tmpl.icon] || mBTAssets.file,
                title: tmpl.label,
                subtitle: tmpl.cat || 'General',
                onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')`,
                actions: [{ icon: mBTAssets.plus, title: 'Create', color: 'blue', onClick: `mBT.features.documents.createFromTemplate('${tmpl.id}')` }]
            });

            const templateHtml = templates.map(renderTmplItem).join('');

            // Logic Resolution: Custom Layout (White Theme) to eliminate black studio headers
            const content = `
                <div class="flex flex-col max-h-[80vh] bg-slate-50">
                    <div class="p-4 bg-white border-b border-slate-100 flex-shrink-0 z-10 space-y-2">
                        <div class="flex justify-between items-center">
                            <h3 class="font-black text-slate-900 text-sm uppercase tracking-widest">Select Template</h3>
                            <button onclick="mBTME.close('newDocSelectorModal')" class="p-2 bg-slate-50 rounded-xl text-slate-400 hover:text-slate-600 transition-all">${mBTAssets.close}</button>
                        </div>
                        <div class="relative">
                            <input type="text" id="tmplSearch" placeholder="FILTER TEMPLATES..." class="w-full p-3 pr-10 bg-slate-50 border-none rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none">${mBTAssets.search}</div>
                        </div>
                    </div>
                    <div id="templateListBody" class="flex-grow overflow-y-auto no-scrollbar p-4 space-y-3">
                        ${templateHtml}
                    </div>
                </div>`;
                
            mBTME.open('newDocSelector', 'Studio Blueprints', content, 'max-w-md', { noPadding: true, hideHeader: true });
            
            mBTME.attachSearch('tmplSearch', 'templateListBody', templates, renderTmplItem);
        },

        // Logic Resolution: Opens the Action Menu for choosing editor or storage
        showOptions: function(docId) {
            const doc = budget.documents.find(d => d.id === docId);
            if (!doc) return;

            const attachments = doc.attachments || [];
            const hasFile = attachments.length > 0;
            
            // Helper: Render Attachment List
            const renderAttachmentList = () => {
                if (attachments.length === 0) return '<div class="text-center text-[10px] text-slate-400 font-bold p-4 bg-slate-50 rounded-xl border border-dashed border-slate-200 col-span-2">No files attached</div>';
                
                return attachments.map((file, idx) => {
                    const isImg = file.type && file.type.startsWith('image/');
                    const src = (isImg && file.location !== 'internal') ? file.data : null; 

                    return RenderEngine.ui.mediaCard({
                        id: idx,
                        title: file.name,
                        type: file.type.split('/')[1]?.toUpperCase() || 'FILE',
                        size: file.size || 'N/A',
                        location: file.location || 'legacy',
                        src: src,
                        onClick: `mBT.features.documents.previewAttachment('${docId}', ${idx})`,
                        actions: [
                            { icon: mBTAssets.print, title: 'Print', color: 'slate', onClick: `mBT.features.documents.printAttachment('${docId}', ${idx})` },
                            { icon: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`, title: 'Download', color: 'blue', onClick: `mBT.features.documents.downloadAttachment('${docId}', ${idx})` },
                            { icon: mBTAssets.trash, title: 'Remove', color: 'rose', onClick: `mBT.features.documents.removeAttachment('${docId}', ${idx})` }
                        ]
                    });
                }).join('');
            };

            const content = `
                <div class="flex flex-col h-full bg-slate-50">
                    <div class="grid grid-cols-1 gap-4 p-6 shrink-0">
                        ${!hasFile ? `
                        <button onclick="mBTME.close('docOptionsModal'); mBTDB.open('${docId}');" 
                            class="flex items-center gap-4 p-4 bg-white border border-slate-200 rounded-2xl hover:border-blue-500 hover:shadow-lg transition-all group text-left w-full">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                                ${mBTAssets.wand}
                            </div>
                            <div>
                                <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">Open Studio</h4>
                                <p class="text-[10px] text-slate-400 font-bold mt-1">Interactive Editor</p>
                            </div>
                        </button>` : ''}

                        <div class="relative">
                            <button onclick="document.getElementById('docUpload_${docId}').click()" 
                                class="flex items-center gap-4 p-4 bg-white border border-slate-200 rounded-2xl hover:border-emerald-500 hover:shadow-lg transition-all group text-left w-full">
                                <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                                    ${mBTAssets.cloud}
                                </div>
                                <div>
                                    <h4 class="font-black text-xs uppercase tracking-widest text-slate-800">${hasFile ? 'Replace Existing' : 'Upload Existing'}</h4>
                                    <p class="text-[10px] text-slate-400 font-bold mt-1">PDF, Word, Excel, Images</p>
                                </div>
                            </button>
                            <input type="file" id="docUpload_${docId}" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,image/*" onchange="mBT.features.documents.handleFileUpload('${docId}', this)">
                        </div>
                    </div>
                    
                    <div class="px-6 pb-2">
                        <h4 class="text-[9px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-200 pb-2 mb-3">Attachments</h4>
                    </div>
                    <div class="flex-grow overflow-y-auto px-6 pb-6 no-scrollbar grid grid-cols-2 gap-3 content-start" style="max-height: 200px;">
                        ${renderAttachmentList()}
                    </div>
                </div>`;

            mBTME.open('docOptions', 'Document Actions', content, 'max-w-sm', { noPadding: true });
        },

        // Logic Resolution: Handles file attachments with proper format support
        handleFileUpload: async function(docId, input) {
            const file = input.files[0];
            if (!file) return;

            // Stability Limit: 7MB (IndexedDB Support)
            if (file.size > 7 * 1024 * 1024) {
                 mBTME.alert("File Too Large", "Please upload files smaller than 7MB to ensure offline storage stability.");
                 return;
            }

            const doc = budget.documents.find(d => d.id === docId);
            if (!doc) return;
            if (!doc.attachments) doc.attachments = [];

            // Protocol Branching: Bundle Mode vs Legacy
            if (budget.storageProtocol === 'internal') {
                const blobKey = `blob_${docId}_${Date.now()}_${Math.floor(Math.random()*1000)}`;
                try {
                    await mBT.data.storage.saveBlob(blobKey, file);
                    doc.attachments.push({
                        name: file.name,
                        type: file.type || 'application/octet-stream',
                        location: 'internal', 
                        key: blobKey,
                        data: null,
                        size: (file.size / 1024).toFixed(1) + ' KB',
                        ts: new Date().toISOString()
                    });
                    saveBudget();
                    this.showOptions(docId);
                } catch(e) { 
                    console.error("Blob Storage Failed", e);
                    mBTME.alert("Upload Error", "Failed to store file internally.");
                }
            } else {
                // Legacy Base64 Path
                const reader = new FileReader();
                reader.onload = (e) => {
                    doc.attachments.push({
                        name: file.name,
                        type: file.type || 'application/octet-stream',
                        data: e.target.result,
                        ts: new Date().toISOString()
                    });
                    saveBudget();
                    // Instant Refresh (No blocking alert)
                    this.showOptions(docId); 
                };
                reader.readAsDataURL(file);
            }
        },

        // --- NEW: Binary Conversion Utility ---
        _base64ToBuffer: function(base64) {
            const binary_string = window.atob(base64.split(',')[1]);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        },

        // --- NEW: Universal Preview Engine ---
        previewAttachment: async function(docId, index) {
            const doc = budget.documents.find(d => d.id === docId);
            if (!doc || !doc.attachments || !doc.attachments[index]) return;
            
            // Hybrid Clone to protect state
            const file = { ...doc.attachments[index] };
            const name = file.name.toLowerCase();

            // Resolve Internal Blob
            if (file.location === 'internal' && file.key) {
                file.data = await mBT.data.storage.loadBlob(file.key);
            }

            // A. Images: Direct Render
            if (file.type.includes('image')) {
                mBTME.open('previewFile', file.name, `<div class="flex justify-center bg-slate-900 p-4"><img src="${file.data}" class="max-w-full h-auto rounded shadow-lg"></div>`, 'max-w-4xl');
                return;
            }

            // B. Binary Buffer Resolution (Legacy Base64 or Blob Fetch)
            let buffer;
            if (file.location === 'internal') {
                const response = await fetch(file.data); // file.data is blobUrl here
                buffer = await response.arrayBuffer();
            } else {
                buffer = this._base64ToBuffer(file.data);
            }

            // C. PDF: Blob URL -> iFrame
            if (file.type === 'application/pdf' || name.endsWith('.pdf')) {
                let url;
                if (file.location === 'internal') {
                    url = file.data;
                } else {
                    const blob = new Blob([buffer], {type: 'application/pdf'});
                    url = URL.createObjectURL(blob);
                }
                mBTME.open('previewFile', file.name, `<iframe src="${url}" class="w-full h-[80vh] border-none bg-slate-100"></iframe>`, 'max-w-5xl', {noPadding: true});
            }
            // D. Word (DOCX): Mammoth.js
            else if (name.endsWith('.docx')) {
                if (typeof mammoth === 'undefined') return mBTME.alert("Error", "Word viewer offline.");
                mBTME.showLoader("Converting DOCX...");
                mammoth.convertToHtml({arrayBuffer: buffer})
                    .then(result => {
                        mBTME.hideLoader();
                        mBTME.open('previewFile', file.name, `<div class="prose prose-sm max-w-none p-8 bg-white text-slate-800">${result.value}</div>`, 'max-w-3xl');
                    })
                    .catch(err => { mBTME.hideLoader(); mBTME.alert("Conversion Error", err.message); });
            }
            // E. Excel (XLSX): SheetJS
            else if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
                if (typeof XLSX === 'undefined') return mBTME.alert("Error", "Excel viewer offline.");
                try {
                    const wb = XLSX.read(buffer, {type: 'array'});
                    const sheetName = wb.SheetNames[0];
                    const html = XLSX.utils.sheet_to_html(wb.Sheets[sheetName]);
                    mBTME.open('previewFile', file.name, `<div class="overflow-auto p-4 bg-white text-xs spreadsheet-view">${html}</div>`, 'max-w-5xl');
                } catch(e) { mBTME.alert("Error", "Could not parse spreadsheet."); }
            } 
            // Fallback
            else {
                mBTME.alert("Preview Unavailable", "This file type cannot be previewed. Please download it.");
            }
        },
        
        // --- NEW: Print Driver (Indirect Iframe Injection) ---
        printAttachment: async function(docId, index) {
            const doc = budget.documents.find(d => d.id === docId);
            if (!doc || !doc.attachments || !doc.attachments[index]) return;
            
            const file = { ...doc.attachments[index] };
            
            // Resolve Internal Blob if needed
            if (file.location === 'internal' && file.key) {
                file.data = await mBT.data.storage.loadBlob(file.key);
            }

            if (file.type.includes('image') || file.type === 'application/pdf') {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = file.data;
                document.body.appendChild(iframe);
                
                // Allow buffer time for rendering before print dialog
                iframe.onload = function() {
                    setTimeout(() => {
                        try {
                            iframe.contentWindow.focus();
                            iframe.contentWindow.print();
                        } catch(e) { 
                            console.warn("Auto-print failed, opening new tab fallback.");
                            window.open(file.data, '_blank');
                        }
                        // Cleanup
                        setTimeout(() => document.body.removeChild(iframe), 60000);
                    }, 500);
                };
            } else {
                mBTME.alert("Print Error", "Cannot print this file type directly. Please download it.");
            }
        },

        // Logic Resolution: Trigger download from internal DataURL
        downloadAttachment: async function(docId, index) {
            const doc = budget.documents.find(d => d.id === docId);
            if (doc && doc.attachments && doc.attachments[index]) {
                const file = doc.attachments[index];
                let blob = null;

                // Helper: DataURL to Blob for robust download
                const dataURLtoBlob = (dataurl) => {
                    try {
                        var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                        while(n--){ u8arr[n] = bstr.charCodeAt(n); }
                        return new Blob([u8arr], {type:mime});
                    } catch(e) { 
                        console.error("Blob Conversion Failed", e); 
                        return null; 
                    }
                };

                // Logic Upgrade: Hybrid Download
                if (file.location === 'internal' && file.key) {
                    const blobUrl = await mBT.data.storage.loadBlob(file.key);
                    if (blobUrl) {
                        const response = await fetch(blobUrl);
                        blob = await response.blob();
                    }
                } else {
                    blob = dataURLtoBlob(file.data);
                }
                
                // Primary Path: Use Publisher Engine
                if (blob && typeof mBTPublisher !== 'undefined' && mBTPublisher.io) {
                    mBTPublisher.io.forceDownload(blob, file.name);
                } 
                // Fallback Path: Direct Browser Action
                else if (blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); 
                    a.href = url; 
                    a.download = file.name;
                    document.body.appendChild(a); 
                    a.click(); 
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }
        },

        removeAttachment: function(docId, index) {
            mBTME.confirm("Remove Attachment", "Delete this file attachment?", () => {
                const doc = budget.documents.find(d => d.id === docId);
                if (doc && doc.attachments) {
                    doc.attachments.splice(index, 1);
                    saveBudget();
                    this.showOptions(docId);
                }
            });
        }
    };

    // --- Global Aliases for Backward Compatibility (Footer Buttons & Switchboard) ---
    window.showDocumentsModal = mBT.features.documents.openVault.bind(mBT.features.documents);
    window.showNewDocumentSelector = mBT.features.documents.openTemplateSelector.bind(mBT.features.documents);
   window.createNewDocumentFromTemplate = mBT.features.documents.createFromTemplate.bind(mBT.features.documents);

    // (openAddContactModal and renderDatabaseSubView removed from global scope to enforce strict mode)

/* ======= Studio Orchestration & Switchboard ======== */

    /* --- 1. Personnel Hub Intelligence (Interaction behavior) --- */
    window.toggleCrewPopup = function(el, event) {
        if(event) event.stopPropagation();
        const wrapper = el.parentElement;
        document.querySelectorAll('.crew-wrapper').forEach(div => { if (div !== wrapper) div.classList.remove('mobile-active'); });
        wrapper.classList.toggle('mobile-active');
    };

    // Helper for Contact Card Tabs (Phase 8.1 - Tier 6)
    window.toggleCrewProfileTab = function(tabId) {
        // Toggle Buttons
        document.querySelectorAll('.crew-tab-btn').forEach(btn => {
            const isActive = btn.dataset.tab === tabId;
            btn.className = `crew-tab-btn flex-1 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all ${isActive ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`;
        });
        
        // Toggle Views
        const profile = document.getElementById('tab-profile');
        const history = document.getElementById('tab-history');
        
        if (tabId === 'profile') {
            if(profile) profile.classList.remove('hidden');
            if(history) history.classList.add('hidden');
        } else {
            if(profile) profile.classList.add('hidden');
            if(history) history.classList.remove('hidden');
        }
    };

    window.openCrewProfile = function(el, event, itemId, sectionName) {
        if(event) event.stopPropagation();
        
        // --- LOGIC UPDATE: Phase 2 Context Detection ---
        let item = null;
        let isGlobalEdit = false;

        // 1. Try finding in Budget (Context: Line Item Click)
        if (itemId && sectionName && budget.sections && budget.sections[sectionName]) {
            item = budget.sections[sectionName].items.find(i => i.id === itemId);
        }

        // 2. Try finding in Global DB (Context: Database Manager Click)
        if (!item && !sectionName && itemId && !itemId.startsWith('dummy_')) {
            const globalC = mBTOG.contacts.find(c => c.id === itemId);
            if (globalC) {
                item = { 
                    id: globalC.id, 
                    crew: { name: globalC.name, phone: globalC.phone, email: globalC.email }, 
                    description: globalC.role || 'Global Contact',
                    payments: globalC.payments || []
                };
                isGlobalEdit = true;
            }
        }

        // 3. Fallback to Empty State (Context: Add New)
        if (!item) item = { id: itemId || 'temp', crew: { name: '', phone: '', email: '' }, description: 'New Contact' };
        
        const crew = item.crew || { name: '', phone: '', email: '' };
        
        // --- Render Components ---
        // 1. Ledger (History Tab)
        let ledgerHtml = '';
        if (typeof mBT.ui.render.paymentHistory === 'function') {
             // Resolve global payments if local item lacks them but has a name match
             let contextForHistory = item;
             if (!item.payments && item.crew && item.crew.name) {
                 const globalC = mBTOG.contacts.find(c => c.name.toLowerCase() === item.crew.name.toLowerCase());
                 if (globalC) contextForHistory = globalC;
             }
             ledgerHtml = mBT.ui.render.paymentHistory(contextForHistory);
        }

        // 2. Profile Form (Profile Tab)
        const profileHtml = `
            <div class="space-y-4 pt-2">
                <div class="flex justify-end">
                     <button type="button" id="importContactBtn" class="text-[9px] font-black uppercase tracking-widest text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-lg">${mBTAssets.plus} Import Contact</button>
                </div>
                <div class="space-y-3">
                    <input type="text" id="crewName" value="${mBT.ui.render.esc(crew.name || '')}" placeholder="FULL NAME" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-black uppercase tracking-tighter outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="tel" id="crewPhone" value="${mBT.ui.render.esc(crew.phone || '')}" placeholder="PHONE" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-mono font-bold outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                        <input type="email" id="crewEmail" value="${mBT.ui.render.esc(crew.email || '')}" placeholder="EMAIL" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-mono font-bold outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                    </div>
                </div>
                <div class="flex justify-between items-center pt-2">
                    ${!isGlobalEdit && sectionName ? `<button type="button" class="text-rose-500 text-[10px] font-black uppercase tracking-widest hover:bg-rose-50 px-4 py-3 rounded-2xl transition-all" onclick="window.clearCrewAssignment('${itemId}', '${sectionName}')">Unassign</button>` : '<div></div>'}
                    <button type="submit" class="py-3 px-8 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-2xl shadow-xl hover:bg-black transition-all active:scale-95">Save Profile</button>
                </div>
            </div>`;

        const content = `
            <form id="crewProfileForm" class="flex flex-col h-[500px]">
                <!-- Header -->
                <div class="text-center relative shrink-0 mb-4">
                    <div class="w-20 h-20 mx-auto rounded-full bg-slate-900 flex items-center justify-center text-white font-black text-3xl shadow-2xl border-4 border-white">
                        ${crew.name ? mBT.ui.render.esc(crew.name.substring(0,1).toUpperCase()) : '?'}
                    </div>
                    <h3 class="text-lg font-black text-slate-900 mt-2 uppercase tracking-tighter">${mBT.ui.render.esc(crew.name || 'Unknown')}</h3>
                    <p class="text-[9px] text-blue-500 font-bold uppercase tracking-widest">${mBT.ui.render.esc(item.description || 'New Contact')}</p>
                </div>

                <!-- Tabs -->
                <div class="flex bg-slate-100 p-1 rounded-xl shrink-0 mb-4">
                    <button type="button" data-tab="profile" onclick="toggleCrewProfileTab('profile')" class="crew-tab-btn flex-1 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all bg-white text-blue-600 shadow-sm">Profile</button>
                    <button type="button" data-tab="history" onclick="toggleCrewProfileTab('history')" class="crew-tab-btn flex-1 py-2 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all text-slate-400 hover:text-slate-600">Ledger</button>
                </div>

                <!-- Content Area -->
                <div class="flex-grow overflow-hidden relative bg-slate-50 rounded-2xl border border-slate-100">
                    <div id="tab-profile" class="absolute inset-0 p-5 overflow-y-auto no-scrollbar">
                        ${profileHtml}
                    </div>
                    <div id="tab-history" class="absolute inset-0 overflow-y-auto no-scrollbar hidden">
                        ${ledgerHtml}
                    </div>
                </div>
            </form>`;

        mBTME.open('crewProfile', '', content, 'max-w-sm', { hideHeader: true });

        // Bind events after render
        setTimeout(() => {
            const form = document.getElementById('crewProfileForm');
            if(form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const name = document.getElementById('crewName').value.trim();
                    const phone = document.getElementById('crewPhone').value.trim();
                    const email = document.getElementById('crewEmail').value.trim();

                    if (itemId && itemId.startsWith('dummy_new_contact')) {
                        if (!name) return mBTME.alert("Required", "Name is required.");
                        mBTOG.contacts.push({ id: 'c_' + Date.now(), name, role: 'Crew', phone, email });
                        mBTOG.saveContacts(); 
                        mBTME.close('crewProfileModal');
                        if(typeof showSettingsModal === 'function') showSettingsModal('database', 'contacts');
                    } 
                    else if (isGlobalEdit) {
                        const gIdx = mBTOG.contacts.findIndex(c => c.id === itemId);
                        if(gIdx > -1) {
                            mBTOG.contacts[gIdx].name = name;
                            mBTOG.contacts[gIdx].phone = phone;
                            mBTOG.contacts[gIdx].email = email;
                            mBTOG.saveContacts();
                            mBTME.close('crewProfileModal');
                            if(typeof showSettingsModal === 'function') showSettingsModal('database', 'contacts');
                        }
                    } 
                    else if (item) {
                        item.crew = { name, phone, email };
                        mBTME.close('crewProfileModal');
                        if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
                        if(typeof render === 'function') render();
                        if(document.getElementById('stagesViewModal')) window.showStagesModal();
                    }
                });
            }
            
            const importBtn = document.getElementById('importContactBtn');
            if(importBtn) {
                importBtn.addEventListener('click', async () => {
                    if ('contacts' in navigator && 'ContactsManager' in window) {
                        try {
                            const contacts = await navigator.contacts.select(['name', 'tel', 'email'], { multiple: false });
                            if (contacts.length) {
                                const c = contacts[0];
                                if(c.name?.[0]) document.getElementById('crewName').value = c.name[0];
                                if(c.tel?.[0]) document.getElementById('crewPhone').value = c.tel[0];
                                if(c.email?.[0]) document.getElementById('crewEmail').value = c.email[0];
                            }
                        } catch (ex) { console.log('Contact Import cancelled'); }
                    } else { mBTME.alert("Not Supported", "Contact import not available in this browser."); }
                });
            }
        }, 50);
    };

    window.clearCrewAssignment = function(itemId, sectionName) {
        mBTME.confirm("Remove Assignment", "Remove this crew assignment?", () => {
            const item = budget.sections[sectionName].items.find(i => i.id === itemId);
            if(item) {
                delete item.crew;
                mBTME.close('crewProfileModal');
                if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
                if(typeof render === 'function') render();
                if(document.getElementById('stagesViewModal')) window.showStagesModal();
            }
        });
    };

    /* --- 2. Stage & Analytics Interface (Orchestration) --- */
    
    // UI Helpers for Stages Modal
    window.handleStageAddItem = function(stageKey) {
        const sectionNames = Object.keys(budget.sections);
        let targetSectionName = sectionNames.find(s => s.toLowerCase().includes('production')) || sectionNames[0];
        
        // Intelligent Section Guessing
        if (stageKey === 'post') targetSectionName = sectionNames.find(s => /post|edit/.test(s.toLowerCase())) || targetSectionName;
        else if (stageKey === 'dev') targetSectionName = sectionNames.find(s => /dev|creative/.test(s.toLowerCase())) || targetSectionName;

        const existingItems = [];
        Object.entries(budget.sections).forEach(([secName, sec]) => {
            sec.items.forEach(i => {
                if (!(i.stageData && i.stageData[stageKey])) {
                    existingItems.push({ ...i, isExisting: true, sectionName: secName });
                }
            });
        });

        const initialList = [...existingItems.slice(0, 10), ...mBTOG.rates.slice(0, 20)];
        const content = `
            <div class="flex flex-col h-[400px]">
                <div class="mb-3"><input type="text" id="stageDbSearch" placeholder="Search..." class="w-full p-3 border rounded-lg shadow-sm text-sm font-bold"></div>
                <div id="stageDbList" class="flex-grow overflow-y-auto border rounded-lg bg-gray-50 mb-3">${renderStageDatabaseList(initialList, stageKey, targetSectionName)}</div>
                <button id="toggleStageCustomForm" class="text-xs text-blue-600 font-bold hover:underline mb-2">+ Create Custom Item</button>
                <div id="stageCustomForm" class="hidden space-y-3 border-t pt-3 bg-white">
                    <input type="text" id="stageCustomDesc" class="w-full p-2 border rounded text-sm" placeholder="Item Name">
                    <div class="flex gap-2"><input type="number" id="stageCustomRate" class="flex-1 p-2 border rounded text-sm" placeholder="0.00"><select id="stageCustomUnit" class="w-1/3 p-2 border rounded text-sm"><option>Day</option><option>Flat</option></select></div>
                    <button id="stageAddCustomBtn" class="w-full py-2 bg-blue-600 text-white font-bold rounded">Add Item</button>
                </div>
            </div>`;

        mBTME.open('stageAdd', `Add to ${budget.targetLock.stages[stageKey].label}`, content, 'max-w-sm');
        
        // Attach Listeners
        const searchInput = document.getElementById('stageDbSearch');
        if(searchInput) searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = [...existingItems, ...mBTOG.rates].filter(i => i.description.toLowerCase().includes(term)).slice(0, 30);
            document.getElementById('stageDbList').innerHTML = renderStageDatabaseList(filtered, stageKey, targetSectionName);
        });
        
        document.getElementById('toggleStageCustomForm')?.addEventListener('click', (e) => {
            document.getElementById('stageCustomForm').classList.toggle('hidden');
            document.getElementById('stageDbList').classList.toggle('hidden');
        });
        
        document.getElementById('stageAddCustomBtn')?.addEventListener('click', () => {
            const desc = document.getElementById('stageCustomDesc').value.trim();
            const rate = parseFloat(document.getElementById('stageCustomRate').value) || 0;
            const unit = document.getElementById('stageCustomUnit').value;
            if(desc) addStageItemToBudget(desc, rate, unit, stageKey, targetSectionName);
        });
    };

    window.renderStageDatabaseList = function(items, stageKey, targetSectionName) {
        if (!items.length) return `<div class="p-4 text-center text-xs text-gray-400">No matches.</div>`;
        return items.map(item => `
            <div onclick="${item.isExisting ? `assignItemToStage('${item.id}', '${stageKey}')` : `addStageItemToBudget('${RenderEngine.esc(item.description)}', ${item.rate}, '${item.unit}', '${stageKey}', '${targetSectionName}')`}" 
                 class="p-3 border-b bg-white hover:bg-blue-50 cursor-pointer flex justify-between items-center group">
                <div><div class="text-sm font-bold text-gray-700">${item.description}</div>${item.isExisting ? `<div class="text-[9px] text-emerald-600 font-bold">LINK FROM: ${item.sectionName}</div>` : ''}</div>
                <div class="font-mono text-xs text-gray-500 font-bold">${mBTLE.format.currency(item.rate)}</div>
            </div>`).join('');
    };

    window.assignItemToStage = function(itemId, stageKey) {
        let item = null;
        Object.values(budget.sections).forEach(sec => { if(!item) item = sec.items.find(i => i.id === itemId); });
        if (item) {
            if (!item.stageData) item.stageData = {};
            if (!item.stageData[stageKey]) {
                item.stageData[stageKey] = { days: 1, rate: item.rate || 0 };
                saveBudget();
                mBTME.close('stageAddModal');
                if(document.getElementById('stagesViewModal')) window.showStagesModal();
                mBTLE.reconcile();
            }
        }
    };

    window.addStageItemToBudget = function(desc, rate, unit, stageKey, targetSectionName) {
        const newItem = { id: crypto.randomUUID(), description: desc, quantity: 1, unit, multiplier: 1, rate, actual: 0, rateType: 'negotiable', stageData: {} };
        newItem.stageData[stageKey] = { days: 1, rate };
        if(budget.sections[targetSectionName]) {
            budget.sections[targetSectionName].items.push(newItem);
            mBTME.close('stageAddModal');
            saveBudget();
            if(document.getElementById('stagesViewModal')) window.showStagesModal();
            if(typeof render === 'function') render();
        }
    };

    // Stage Drag & Drop
    window.handleStageDragStart = (e, itemId, sourceStage) => { e.dataTransfer.setData('text/plain', JSON.stringify({ itemId, sourceStage })); };
    window.handleStageDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
    window.handleStageDrop = (e, targetStage) => {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        const { itemId, sourceStage } = data;
        if (sourceStage === targetStage) return;
        let item = null;
        Object.values(budget.sections).forEach(sec => { if(!item) item = sec.items.find(i => i.id === itemId); });
        if (item && item.stageData && item.stageData[sourceStage]) {
            item.stageData[targetStage] = { ...item.stageData[sourceStage] }; // Clone to new stage
            saveBudget();
            showStagesModal();
        }
    };

    window.updateStageItem = function(itemId, sectionName, stageKey, field, value, isRealTime = false) {
        const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
        if (item && item.stageData && item.stageData[stageKey]) {
            item.stageData[stageKey][field] = parseFloat(value) || 0;
            
            // Surgical Paint: Update Card Cost Immediately
            const days = item.stageData[stageKey].days || 0;
            const rate = item.stageData[stageKey].rate || 0;
            const cost = days * rate;
            const costEl = document.getElementById(`cost-${itemId}-${stageKey}`);
            if (costEl) costEl.innerText = mBTLE.format.currency(cost);

            // Update Headers & Main Budget
            if(typeof window.updateAllHeaders === 'function') window.updateAllHeaders();
            mBTLE.reconcile();
            if(typeof mBT.ui.paint === 'function') mBT.ui.paint(); 

            // Save Strategy: Debounce if realtime
            if(isRealTime) {
                if(mBT.features.stages.state._timer) clearTimeout(mBT.features.stages.state._timer);
                mBT.features.stages.state._timer = setTimeout(saveBudget, 1000);
            } else {
                // Fix: Clear any pending debounce to prevent double-save on blur
                if(mBT.features.stages.state._timer) clearTimeout(mBT.features.stages.state._timer);
                saveBudget();
            }
        }
    };

    window.handleStageBulkAction = function(action) {
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        if (action === 'lockAll' || action === 'unlockAll') {
            validKeys.forEach(k => budget.targetLock.stages[k].locked = (action === 'lockAll'));
            saveBudget();
            window.showStagesModal();
        } else if (action === 'syncDays') {
            mBTME.confirm("Sync Duration", "Overwrite individual item days with Stage settings?", () => {
                validKeys.forEach(k => {
                    const d = budget.targetLock.stages[k].days;
                    if(d > 0) Object.values(budget.sections).forEach(s => s.items.forEach(i => { if(i.stageData?.[k]) i.stageData[k].days = d; }));
                });
                saveBudget();
                window.showStagesModal();
            });
        }
    };

    // --- TIER 5 UPGRADE: Manual Duration Handler (Phase 2 Fix) ---
    window.updateStageDuration = function(stageKey, value) {
        if (!budget || !budget.targetLock || !budget.targetLock.stages) return;
        
        // 1. Update Data Model
        const days = parseFloat(value) || 0;
        if (budget.targetLock.stages[stageKey]) {
            budget.targetLock.stages[stageKey].days = days;
            
            // 2. Persist
            saveBudget();
            
            // 3. Trigger Temporal Engine (Updates Dates instantly)
            if(typeof window.updateAllHeaders === 'function') window.updateAllHeaders();
            
            // 4. Update Logic Engine (Burn Rates)
            if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
        }
    };

    // --- TIER 5 UPGRADE: Smart Sync Controller ---
    window.syncStageDays = function(stageKey) {
        // 1. Ask Tier 3 for the Truth
        const validation = mBT.logic.stages.validateTimeline(stageKey);
        
        if (validation.maxNeeded > 0) {
            // 2. Update the Governor (User Input) to match Reality
            if (!budget.targetLock.stages[stageKey]) return;
            
            budget.targetLock.stages[stageKey].days = validation.maxNeeded;
            
            // 3. Persist & Refresh
            saveBudget();
            mBTLE.reconcile(); // Recalc burn rates
            
            // 4. Update UI (Removes Red Warning)
            if(document.getElementById('stagesViewModal')) window.showStagesModal();
        } else {
            mBTME.alert("Sync Info", "No scheduled items found in this stage to sync with.");
        }
    };

    // --- NEW: Smart Auto-Fill Logic (Tier 5 Bridge) ---
    window.handleStageAutoFill = function(stageKey, mode = 'link') {
        const stageLabel = (budget.targetLock && budget.targetLock.stages[stageKey]) ? budget.targetLock.stages[stageKey].label : stageKey.toUpperCase();
        let count = 0;

        if (mode === 'link') {
            const matches = mBT.features.stages.logic.findMatchesInBudget(stageKey);
            if (matches.length === 0) return mBTME.alert("No Matches", "No matching items found to link.");
            
            matches.forEach(item => {
                if (!item.stageData) item.stageData = {};
                item.stageData[stageKey] = { days: 1, rate: item.rate };
                count++;
            });
        } 
        else if (mode === 'generate') {
            const missing = mBT.features.stages.logic.findMissingEssentials(stageKey);
            if (missing.length === 0) return mBTME.alert("Complete", "No missing essentials found.");
            
            // Determine target section
            const sectionNames = Object.keys(budget.sections);
            let targetSec = sectionNames.find(s => s.toLowerCase().includes('production')) || sectionNames[0];
            if (stageKey === 'post') targetSec = sectionNames.find(s => /post|edit/.test(s.toLowerCase())) || targetSec;
            else if (stageKey === 'dev') targetSec = sectionNames.find(s => /dev|creative/.test(s.toLowerCase())) || targetSec;

            if (!budget.sections[targetSec]) return mBTME.alert("Error", "Target section not found.");

            missing.forEach(dbItem => {
                const newItem = {
                    id: 'item_' + Date.now() + '_' + Math.floor(Math.random()*1000),
                    description: dbItem.description,
                    quantity: 1,
                    unit: dbItem.unit,
                    rate: dbItem.rate,
                    multiplier: 1,
                    actual: 0,
                    rateType: 'negotiable',
                    stageData: {}
                };
                newItem.stageData[stageKey] = { days: 1, rate: dbItem.rate };
                budget.sections[targetSec].items.push(newItem);
                count++;
            });
        }

        if (count > 0) {
            saveBudget();
            mBTLE.reconcile();
            if(document.getElementById('stagesViewModal')) window.showStagesModal();
            mBTME.alert("Auto-Fill Complete", `${count} items processed for ${stageLabel}.`);
        }
    };

    window.handleStageBulkAutoFill = function() {
        mBTME.confirm("Smart Scan", "Auto-populate ALL stages with existing budget items?", () => {
            let total = 0;
            const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
            
            validKeys.forEach(k => {
                const matches = mBT.features.stages.logic.findMatchesInBudget(k);
                matches.forEach(item => {
                    if (!item.stageData) item.stageData = {};
                    item.stageData[k] = { days: 1, rate: item.rate };
                    total++;
                });
            });

            if (total > 0) {
                saveBudget();
                mBTLE.reconcile();
                window.showStagesModal();
                mBTME.alert("Scan Complete", `Smart Scan Linked ${total} items.`);
            } else {
                mBTME.alert("Scan Complete", "No new matches found.");
            }
        });
    };

    window.toggleStageLock = function(stageKey) {
        if (budget.targetLock.stages[stageKey]) {
            budget.targetLock.stages[stageKey].locked = !budget.targetLock.stages[stageKey].locked;
            saveBudget();
            window.showStagesModal();
        }
    };

    // Main Stage Modal Render (Uses Tier 4 Components)
    window.showStagesModal = function() {
    if (!budget.targetLock) budget.targetLock = { enabled: false, totalCap: 0, stages: {} };
    const tl = budget.targetLock;
    const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
    validKeys.forEach(k => { if (!tl.stages[k]) tl.stages[k] = { label: k.toUpperCase(), ratio: 20, days: 0, locked: false }; });

    // 1. Setup Card (Configuration & Sliders)
    const setupCard = `
        <div id="card-setup" class="stage-card min-w-[320px] w-[320px] flex-shrink-0 bg-slate-900 text-white flex flex-col snap-center border-r border-slate-800 h-full">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="font-black text-xs uppercase tracking-widest text-slate-400">Configuration</h3>
                <div class="relative group">
                    <button class="text-slate-400 hover:text-white transition-colors">${mBTAssets.gear}</button>
                    <!-- Bulk Actions Menu (Simple absolute positioning) -->
                    <div class="hidden group-hover:block absolute right-0 top-full mt-2 w-48 bg-white border border-slate-200 shadow-xl rounded-xl z-50 overflow-hidden">
                        <div class="p-2 border-b border-slate-100 text-[9px] font-black text-slate-400 uppercase tracking-widest bg-slate-50">Bulk Actions</div>
                        <button onclick="handleStageBulkAutoFill()" class="w-full text-left text-[10px] font-bold text-slate-600 hover:text-emerald-600 hover:bg-emerald-50 px-4 py-2 transition-colors flex items-center gap-2">
                             ${mBTAssets.wand} Smart Auto-Fill
                        </button>
                        <button onclick="handleStageBulkAction('syncDays')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:text-blue-600 hover:bg-blue-50 px-4 py-2 transition-colors">Sync Days</button>
                        <button onclick="handleStageBulkAction('dedupe')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:text-red-600 hover:bg-red-50 px-4 py-2 transition-colors">Remove Dupes</button>
                        <div class="border-t border-slate-100 my-1"></div>
                        <button onclick="handleStageBulkAction('lockAll')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:bg-slate-50 px-4 py-2 transition-colors">Lock All</button>
                        <button onclick="handleStageBulkAction('unlockAll')" class="w-full text-left text-[10px] font-bold text-slate-600 hover:bg-slate-50 px-4 py-2 transition-colors">Unlock All</button>
                    </div>
                </div>
            </div>
            <div class="p-5 space-y-6 overflow-y-auto no-scrollbar">
                <!-- TIER 5 UPGRADE: Phase 2 - Temporal Control Center -->
                <div>
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Project Start Date</label>
                    <input type="date" value="${budget.startDate || new Date().toISOString().split('T')[0]}" 
                           onchange="budget.startDate=this.value; saveBudget(); window.updateAllHeaders();" 
                           class="w-full bg-slate-800 text-white text-[10px] font-bold p-3 rounded-xl outline-none border border-slate-700 focus:border-blue-600 transition-colors cursor-pointer uppercase tracking-widest shadow-inner">
                </div>

                <!-- TIER 5 UPGRADE: Phase 3.2 - Deadline Manager -->
                <div>
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Target Delivery Date</label>
                    <input type="date" value="${budget.deliveryDate || ''}" 
                           onchange="budget.deliveryDate=this.value; saveBudget(); window.updateAllHeaders();" 
                           class="w-full bg-slate-800 text-white text-[10px] font-bold p-3 rounded-xl outline-none border border-slate-700 focus:border-blue-600 transition-colors cursor-pointer uppercase tracking-widest shadow-inner">
                </div>

                <div>
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Total Cap Limit</label>
                    <div class="flex items-center gap-2 border-b border-slate-600 pb-1">
                        <span class="text-slate-500 text-lg">$</span>
                        <input type="number" value="${tl.totalCap}" onchange="budget.targetLock.totalCap=parseFloat(this.value); saveBudget(); window.updateAllHeaders();" class="w-full bg-transparent text-xl font-black text-white outline-none no-spinner placeholder-slate-700">
                    </div>
                </div>
                <div class="space-y-5">
                    ${validKeys.map(k => `
                        <div class="relative">
                            <div class="flex justify-between text-[9px] font-black uppercase text-slate-400 mb-1.5">
                                <span class="tracking-widest">${tl.stages[k].label}</span>
                                <span id="setup_perc_disp_${k}" class="text-white">${tl.stages[k].ratio.toFixed(1)}%</span>
                            </div>
                            <div class="h-2 bg-slate-800 rounded-full relative overflow-visible">
                                <div id="setup_bar_${k}" class="absolute h-full bg-blue-600 rounded-full opacity-80 pointer-events-none transition-all duration-300" style="width:0%"></div>
                                <input type="range" min="0" max="100" step="0.1" value="${tl.stages[k].ratio}" data-stage-key="${k}" class="stage-slider absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" ${tl.stages[k].locked ? 'disabled' : ''}>
                                <div id="setup_knob_${k}" class="absolute w-4 h-4 bg-white rounded-full top-1/2 -translate-y-1/2 shadow-md pointer-events-none transition-all duration-75" style="left: ${tl.stages[k].ratio}%; margin-left: -8px;"></div>
                            </div>
                        </div>`).join('')}
                </div>
                <div class="pt-6 border-t border-slate-800">
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3 block">Distribution Model</label>
                    <select onchange="window.applyStagePreset(this.value); window.showStagesModal();" class="w-full bg-slate-800 text-white text-[10px] font-bold p-3 rounded-xl outline-none border border-slate-700 focus:border-blue-600 transition-colors cursor-pointer appearance-none">
                        <option value="" disabled selected>Load Industry Preset...</option>
                        ${Object.keys(STAGE_PRESETS).map(k => `<option value="${k}">${k}</option>`).join('')}
                    </select>
                </div>
            </div>
        </div>`;

    // 2. Overview Card (Burn Rate & Analytics Link)
    const overviewCard = `
        <div id="card-overview" class="stage-card min-w-[320px] w-[320px] flex-shrink-0 bg-white flex flex-col snap-center border-r border-slate-200 h-full">
            <div class="p-8 flex flex-col items-center justify-center border-b border-slate-100 flex-grow relative overflow-hidden">
                <div class="absolute inset-0 bg-slate-50/50 -skew-y-12 scale-150 origin-bottom-left z-0 pointer-events-none"></div>
                <div id="burnRateRing" class="w-48 h-48 rounded-full border-[16px] border-slate-100 flex items-center justify-center relative mb-8 transition-all duration-500 z-10 bg-white shadow-sm">
                    <div class="text-center">
                        <span id="burnRateText" class="text-5xl font-black text-slate-300 block leading-none tracking-tighter">0%</span>
                        <span class="text-[9px] font-black uppercase tracking-widest text-slate-400 mt-2 block">Burn Rate</span>
                    </div>
                </div>
                <div class="text-center w-full z-10 space-y-4">
                    <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-400 border-b border-slate-200 pb-2">
                        <span>Estimated</span>
                        <span id="ovGrandTotal" class="text-slate-800 text-xs">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-[10px] font-black uppercase tracking-widest text-slate-400">
                        <span>Cap Limit</span>
                        <span id="ovTotalCap" class="text-slate-800 text-xs">$0.00</span>
                    </div>
                </div>
            </div>
            <div class="p-6 bg-white z-10">
                <button onclick="openAnalyticsHub()" class="w-full py-4 bg-white border-2 border-slate-100 text-blue-600 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-sm hover:shadow-md hover:border-blue-200 hover:bg-blue-50 transition-all flex items-center justify-center gap-3 group">
                    <span class="scale-125 group-hover:scale-110 transition-transform">${mBTAssets.doctor}</span> Open Analytics Hub
                </button>
            </div>
        </div>`;

     // 3. Main Modal Structure (Injecting Cards)
    // NOTE: Redesigned Navigation to be "Tab-Like" with Glow
    const modalWrapper = `
        <div class="flex flex-col h-[85vh] w-full max-w-[95vw] bg-white rounded-[32px] shadow-2xl overflow-hidden font-sans">
            <!-- New Compact Tab Navigation (Fit to Width) -->
            <div class="flex items-center w-full bg-white border-b border-slate-100 h-10 flex-shrink-0 shadow-[0_4px_12px_rgba(0,0,0,0.02)] z-30 sticky top-0 divide-x divide-slate-50">
                <button id="nav-tab-setup" onclick="document.getElementById('card-setup').scrollIntoView({behavior:'smooth',inline:'center'})" 
                        class="stage-nav-tab flex-1 h-full flex items-center justify-center text-[8px] sm:text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 border-b-2 border-transparent transition-all select-none min-w-0 px-1 truncate">
                    Setup
                </button>
                <button id="nav-tab-overview" onclick="document.getElementById('card-overview').scrollIntoView({behavior:'smooth',inline:'center'})" 
                        class="stage-nav-tab flex-1 h-full flex items-center justify-center text-[8px] sm:text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 border-b-2 border-transparent transition-all select-none min-w-0 px-1 truncate">
                    View
                </button>
                ${validKeys.map(k => `
                    <button id="nav-tab-${k}" onclick="document.getElementById('card-${k}').scrollIntoView({behavior:'smooth',inline:'center'})" 
                            class="stage-nav-tab flex-1 h-full flex items-center justify-center text-[8px] sm:text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 border-b-2 border-transparent transition-all select-none min-w-0 px-1 truncate">
                        ${tl.stages[k].label}
                    </button>
                `).join('')}
            </div>
            
            <!-- Content Carousel -->
            <div id="stagesCarousel" class="flex-grow flex overflow-x-auto snap-x snap-mandatory no-scrollbar cursor-grab active:cursor-grabbing select-none bg-slate-100">
                ${setupCard}
                ${overviewCard}
                ${validKeys.map(k => {
                    const config = tl.stages[k];
                    
                    // TIER 4 VISUALS: Smart Days Validation
                    const val = mBT.logic.stages.validateTimeline(k);
                    const syncBtn = (val.maxNeeded > val.current) 
                        ? `<button onclick="syncStageDays('${k}')" class="absolute -right-3 -top-3 bg-amber-500 text-white w-6 h-6 rounded-full shadow-lg hover:bg-amber-600 transition-all z-50 flex items-center justify-center animate-bounce" title="Sync to ${val.maxNeeded} days needed">${mBTAssets.sync}</button>` 
                        : '';

                    const fullTitles = { 'dev': 'Development', 'pre': 'Pre-Production', 'prod': 'Production', 'post': 'Post-Production', 'dist': 'Distribution' };
                    const displayTitle = fullTitles[k] || config.label;

                    return `
                    <div id="card-${k}" class="stage-card min-w-[340px] w-[340px] flex-shrink-0 flex flex-col h-full bg-white border-r border-slate-200 snap-center relative group">
                        <!-- ... Card Content ... -->
                        <div class="p-4 bg-white border-b border-slate-50 flex-shrink-0 sticky top-0 z-20 shadow-[0_4px_6px_-1px_rgba(0,0,0,0.02)]">
                            <div class="relative flex items-center justify-between mb-4 h-8">
                                <div class="flex items-center gap-1">
                                    <button onclick="budget.targetLock.stages['${k}'].locked = !budget.targetLock.stages['${k}'].locked; saveBudget(); showStagesModal();" class="relative z-10 text-slate-300 hover:text-blue-500 transition-colors p-1 hover:bg-slate-50 rounded-lg">
                                        ${config.locked ? mBTAssets.lock : mBTAssets.unlock}
                                    </button>
                                    <button onclick="mBT.features.stages.ui.openAutoFillMenu('${k}')" class="relative z-10 text-slate-300 hover:text-purple-500 transition-colors p-1 hover:bg-purple-50 rounded-lg" title="Auto-Fill Matching Items">
                                    ${mBTAssets.wand}
                                </button>
                            </div>
                            
                            <!-- Updated Header: Title + Temporal Projection -->
                            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <span class="font-black text-xs text-slate-800 uppercase tracking-widest leading-none">
                                    ${displayTitle}
                                </span>
                                <span id="date-range-${k}" class="text-[8px] font-bold text-slate-400 mt-0.5 tracking-tight">--</span>
                            </div>
                            
                            <div class="relative z-10 flex items-center gap-2">
                                <div class="relative w-14 group/input">
                                    <input type="number" id="header_perc_${k}" value="${config.ratio.toFixed(1)}" class="stage-number-input w-full text-right text-[10px] font-bold bg-slate-50 rounded-lg px-2 py-1 outline-none no-spinner text-slate-600 focus:text-blue-600 focus:bg-blue-50 focus:ring-2 focus:ring-blue-100 transition-all" data-stage-key="${k}" ${config.locked ? 'disabled' : ''}>
                                    <span class="absolute right-7 top-1/2 -translate-y-1/2 text-[8px] text-slate-400 group-hover/input:text-blue-400 pointer-events-none">%</span>
                                </div>
                                <div class="relative w-12 group/days">
                                    ${syncBtn}
                                    <input type="number" value="${config.days}" onchange="updateStageDuration('${k}', this.value)" class="w-full text-center text-[10px] font-bold ${val.maxNeeded > val.current ? 'bg-amber-50 text-amber-600 ring-2 ring-amber-100' : 'bg-slate-50 text-blue-600'} rounded-lg px-1 py-1 outline-none no-spinner focus:ring-2 focus:ring-blue-100 transition-all" placeholder="0">
                                    <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[6px] text-slate-300 font-black uppercase pointer-events-none">Day</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5 mb-3 overflow-hidden"><div id="bar-${k}" class="bg-blue-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                        <div class="flex justify-between text-[9px] font-mono font-bold text-slate-400 mb-4"><span id="total-${k}" class="text-slate-600">$0</span><span id="limit-${k}">Cap: $0</span></div>
                        <button onclick="handleStageAddItem('${k}')" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-blue-600 hover:text-white hover:shadow-lg transition-all flex items-center justify-center gap-2 transform active:scale-95">${mBTAssets.plus} Add Item</button>
                    </div>
                    <div class="stage-drop-zone flex-grow overflow-y-auto p-3 space-y-3 bg-slate-50/50 no-scrollbar pb-10" data-stage-key="${k}">
                        ${renderStageItems(k)}
                    </div>
                </div>`;
            }).join('')}
            </div>
        </div>`;

    mBTME.open('stagesView', '', modalWrapper, 'max-w-none w-fit !bg-transparent !shadow-none !border-0', { hideHeader: true, noPadding: true, onOpen: () => {
	if (typeof initializeStageDragAndDrop === 'function') initializeStageDragAndDrop();
        
        // --- NEW: Tab Scroll Spy (Intersection Observer) ---
        // This watches the carousel and lights up the matching tab with a glow
        const carousel = document.getElementById('stagesCarousel');
        const cards = document.querySelectorAll('.stage-card');
        const tabs = document.querySelectorAll('.stage-nav-tab');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // 1. Identify active ID
                    const cardId = entry.target.id;
                    const tabId = cardId.replace('card-', 'nav-tab-');
                    const activeTab = document.getElementById(tabId);
                    
                    if (activeTab) {
                        // 2. Reset all tabs
                        tabs.forEach(t => {
                            t.classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50/50');
                            t.classList.add('text-slate-400', 'border-transparent');
                            t.style.textShadow = 'none'; // Remove glow
                        });

                        // 3. Activate current tab
                        activeTab.classList.remove('text-slate-400', 'border-transparent');
                        activeTab.classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50/50');
                        
                        // 4. Apply the requested GLOW
                        activeTab.style.textShadow = '0 0 12px rgba(37,99,235,0.4)';
                        
                        // 5. Ensure tab is visible on mobile nav
                        activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                }
            });
        }, { root: carousel, threshold: 0.6 }); // 60% visibility required to trigger snap active state

        cards.forEach(card => observer.observe(card));
        
        // Interaction Bindings for Real-time Slider Sync
        const bindInput = (el) => {
            el.addEventListener('input', (e) => {
                if(typeof balanceStageSliders === 'function') balanceStageSliders(e.target.dataset.stageKey, parseFloat(e.target.value));
                if(window.updateAllHeaders) window.updateAllHeaders();
            });
            el.addEventListener('change', () => saveBudget());
        };
        document.querySelectorAll('.stage-slider').forEach(bindInput);
        document.querySelectorAll('.stage-number-input').forEach(bindInput);

        // NEW: Real-time Item Inputs Listener (Tier 6 emulation for Tier 5 modal)
        document.querySelectorAll('input[data-action="stage-update"]').forEach(el => {
            el.addEventListener('input', (e) => {
                 updateStageItem(e.target.dataset.id, e.target.dataset.section, e.target.dataset.stage, e.target.dataset.field, e.target.value, true);
            });
        });

        window.updateAllHeaders();
 
        // Drag to Scroll Logic
        const slider = document.getElementById('stagesCarousel');
        if(slider) {
            let isDown = false; let startX; let scrollLeft;
            slider.addEventListener('mousedown', (e) => {
                if(['INPUT','BUTTON','SELECT'].includes(e.target.tagName) || e.target.closest('.stage-draggable')) return;
                isDown = true; startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => isDown = false);
            slider.addEventListener('mouseup', () => isDown = false);
            slider.addEventListener('mousemove', (e) => {
                if(!isDown) return; e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                slider.scrollLeft = scrollLeft - (x - startX) * 2;
            });
        }
    }});
};
function renderStageItems(stageKey) {
    let stageItems = [];
    
    // 1. Collect all items for this stage
    Object.entries(budget.sections).forEach(([secName, sec]) => {
        sec.items.forEach(item => {
            if (item.stageData && item.stageData[stageKey]) {
                stageItems.push({
                    item: item,
                    secName: secName,
                    // Default to large number if no order exists so they go to end
                    order: (item.stageData[stageKey].order !== undefined) ? item.stageData[stageKey].order : 99999
                });
            }
        });
    });

    // 2. Sort based on 'order' property
    stageItems.sort((a, b) => a.order - b.order);

    if (stageItems.length === 0) return '<p class="text-[8px] text-center mt-10 font-black text-slate-300 uppercase">Drop Items Here</p>';

    // 3. Render
    return stageItems.map(entry => {
        return RenderEngine.stageCard({
            ...entry.item,
            _sDays: entry.item.stageData[stageKey].days,
            _sRate: entry.item.stageData[stageKey].rate,
            _sec: entry.secName
        }, stageKey);
    }).join('');
}
// --- Global Stages Header Update Logic (Available before modal open) ---
window.updateAllHeaders = () => {
    // Safety check
    if (!budget || !budget.targetLock || !budget.targetLock.stages) return;

    const metrics = mBTStagesEngine.getMetrics();
    let burn = mBTStagesEngine.getBurnStatus(metrics.grandTotal, metrics.totalCap);
    
    // --- Phase 3.4: The Messenger (Intelligent Risk Visuals) ---
    // We fetch the deep risk analysis calculated by the Logic Engine
    const timeline = mBTStagesEngine.calculateTimeline();
    const risk = mBTStagesEngine.analyzeRisk(metrics, timeline);

    // Logic Resolution: Risk Override
    // If a risk is detected (Critical or Warning), it overrides the standard financial display
    if (risk) {
        if (risk.status === 'CRITICAL') {
            burn.color = 'text-rose-600';
            burn.ring = 'border-rose-500';
            burn.message = "CRITICAL"; 
            burn.subMessage = risk.subMessage; // "Projected $X exceeds Cap"
        } else if (risk.status === 'WARNING') {
            burn.ring = 'border-amber-400';
            if (burn.color !== 'text-red-600') burn.color = 'text-amber-500';
            burn.message = "DELAY";
            burn.subMessage = risk.subMessage; // "Est. Penalty: $X"
        }
        
        // Visual Feedback on Delivery Input (if visible in Setup Card)
        const deliveryInput = document.querySelector('input[onchange*="budget.deliveryDate"]');
        if (deliveryInput) {
            // Apply visual border state based on health
            deliveryInput.classList.remove('border-slate-700', 'border-rose-500', 'border-amber-500', 'border-emerald-500');
            
            if(risk.status === 'CRITICAL') deliveryInput.classList.add('border-rose-500');
            else if(risk.status === 'WARNING') deliveryInput.classList.add('border-amber-500');
            else deliveryInput.classList.add('border-emerald-500');
        }
    }
    
    // Update Overview Card (Visuals)
    const ovGrandTotal = document.getElementById('ovGrandTotal');
    const ovTotalCap = document.getElementById('ovTotalCap');
    
    if(ovGrandTotal) ovGrandTotal.innerText = mBTLE.format.currency(metrics.grandTotal);
    if(ovTotalCap) ovTotalCap.innerText = mBTLE.format.currency(metrics.totalCap);

    // Update Burn Ring
    const ring = document.getElementById('burnRateRing');
    const ringTxt = document.getElementById('burnRateText');
    const ringLabel = ringTxt ? ringTxt.nextElementSibling : null; // "Burn Rate" text

    if(ring && ringTxt) {
        ring.className = `w-48 h-48 rounded-full border-[16px] ${burn.ring} flex items-center justify-center relative mb-8 transition-all duration-500 z-10 bg-white shadow-sm`;
        ringTxt.className = `text-5xl font-black ${burn.color} block leading-none tracking-tighter`;
        
        if (burn.message) {
            // Time Alert Mode
            ringTxt.innerText = burn.message;
            ringTxt.style.fontSize = "2.5rem"; // Adjust for text fit
            if(ringLabel) {
                ringLabel.innerText = burn.subMessage || "SCHEDULE CRITICAL";
                ringLabel.className = "text-[9px] font-black uppercase tracking-widest text-rose-500 mt-2 block animate-pulse";
            }
        } else {
            // Standard Financial Mode
            ringTxt.innerText = Math.round(burn.pct) + '%';
            ringTxt.style.fontSize = ""; 
            if(ringLabel) {
                ringLabel.innerText = "Burn Rate";
                ringLabel.className = "text-[9px] font-black uppercase tracking-widest text-slate-400 mt-2 block";
            }
        }
    }

    // Update Temporal Projections (Phase 1 + 3.1 Bankruptcy)
    Object.keys(timeline).forEach(k => {
        if (k === '_analysis') return; // Skip metadata
        const el = document.getElementById(`date-range-${k}`);
        const validation = mBTStagesEngine.validateTimeline(k);
        
        if(el) {
            if (validation.isBankrupt) {
                el.innerText = "TIME BANKRUPTCY";
                el.className = "text-[9px] font-black text-red-600 animate-pulse bg-red-50 px-2 rounded mt-0.5 tracking-tight";
            } else {
                el.innerText = timeline[k].label;
                el.className = "text-[8px] font-bold text-slate-400 mt-0.5 tracking-tight";
            }
        }
    });

    // 3. Update Setup Sliders (Visual Synchronization)
    const stages = budget.targetLock.stages;
    const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
    
    validKeys.forEach(k => {
        const cfg = stages[k];
        if (!cfg) return;
        
        // A. Update Text Display (Target Ratio)
        const disp = document.getElementById(`setup_perc_disp_${k}`);
        if (disp) disp.innerText = cfg.ratio.toFixed(1) + '%';
        
        // B. Update Bar Width (ACTUAL UTILIZATION)
        const stageCost = (metrics.stageTotals && metrics.stageTotals[k]) ? metrics.stageTotals[k] : 0;
        const stageCap = metrics.totalCap * (cfg.ratio / 100);
        const utilPct = stageCap > 0 ? (stageCost / stageCap) * 100 : 0;
        
        const bar = document.getElementById(`setup_bar_${k}`);
        if (bar) {
            bar.style.width = Math.min(utilPct, 100).toFixed(2) + '%';
            bar.className = `absolute h-full rounded-full opacity-80 pointer-events-none transition-all duration-300 ${stageCost > stageCap ? 'bg-red-500' : 'bg-blue-600'}`;
        }
        
        // C. Update Knob Position (TARGET STRATEGY)
        const knob = document.getElementById(`setup_knob_${k}`);
        if (knob) knob.style.left = cfg.ratio + '%';
        
        // D. Update Card Stats
        const totalEl = document.getElementById(`total-${k}`);
        const limitEl = document.getElementById(`limit-${k}`);
        if(totalEl) totalEl.innerText = mBTLE.format.currency(stageCost);
        if(limitEl) limitEl.innerText = `Cap: ${mBTLE.format.currency(stageCap)}`;
    });
};

/* ========= v19.54 CONNECTIVE UI & Interaction Handlers ========= */

    /* --- 1. UI Module: Project & Status Bar Resolution --- */
    // Kept here as it's the specific implementation for the Header UI
    async function renderProjectManagement() {
        const container = document.getElementById('project-management-container');
        if (!container) return; 

        let projects = (mBT.data && mBT.data.getList) ? await mBT.data.getList() : [];
        projects.sort().reverse();
        
        const menuItems = [
            { label: 'New Budget', icon: mBTAssets.plus, color: 'text-emerald-600', bg: 'hover:bg-emerald-50', action: 'project-new' },
            { label: 'Duplicate Budget', icon: mBTAssets.copy, color: 'text-blue-600', bg: 'hover:bg-blue-50', action: 'project-duplicate' },
            { label: 'Save as Blueprint', icon: mBTAssets.save, color: 'text-indigo-600', bg: 'hover:bg-indigo-50', action: 'blueprint-save' },
            { label: 'Import Budget', icon: mBTAssets.cloud, color: 'text-purple-600', bg: 'hover:bg-purple-50', action: 'project-import-trigger' },
            { label: 'Recycle Bin', icon: mBTAssets.trash, color: 'text-slate-500', bg: 'hover:bg-slate-50', action: 'project-recycle' },
            { divider: true },
            { label: 'Delete Budget', icon: mBTAssets.trash, color: 'text-rose-600', bg: 'hover:bg-rose-50', action: 'project-delete' }
        ];

        let html = `
            <div class="flex items-center gap-2 bg-white p-1 rounded-2xl border border-slate-200 shadow-sm relative z-50">
                <div class="relative group">
                    <select id="projectSelect" data-action="project-switch" class="appearance-none bg-slate-50 border-none text-[10px] font-black uppercase tracking-widest text-slate-700 rounded-xl pl-3 pr-8 py-2.5 outline-none focus:ring-2 focus:ring-blue-100 cursor-pointer min-w-[140px] transition-all hover:bg-slate-100">
        `;
        if (projects.length === 0 && typeof currentProjectName !== 'undefined' && currentProjectName) {
             html += `<option value="${currentProjectName}" selected>${currentProjectName}</option>`;
        }
        projects.forEach(p => {
            const selected = (typeof currentProjectName !== 'undefined' && p === currentProjectName) ? 'selected' : '';
            html += `<option value="${p}" ${selected}>${p}</option>`;
        });
        html += `   </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-400 group-hover:text-slate-600">
                        <svg class="fill-current h-3 w-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                <div class="relative">
                    <button onclick="const m=document.getElementById('fileMenuDropdown'); m.classList.toggle('hidden');" class="flex items-center gap-2 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 hover:text-emerald-700 px-4 py-2.5 rounded-xl transition-all active:scale-95 group">
                        <span class="text-[10px] font-black uppercase tracking-widest">File</span>
                        <svg class="w-3 h-3 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="fileMenuDropdown" class="hidden absolute right-0 top-full mt-2 w-56 bg-white border border-slate-100 rounded-xl shadow-xl z-50 overflow-hidden py-1 animate-in fade-in slide-in-from-top-2 duration-200" onmouseleave="this.classList.add('hidden')">
                        ${menuItems.map(item => item.divider ? `<div class="h-px bg-slate-100 my-1"></div>` : `<button data-action="${item.action}" onclick="document.getElementById('fileMenuDropdown').classList.add('hidden')" class="w-full text-left px-4 py-2.5 flex items-center gap-3 ${item.color} ${item.bg} transition-colors group"><span class="opacity-70 group-hover:opacity-100 scale-90">${item.icon}</span><span class="text-[9px] font-black uppercase tracking-widest">${item.label}</span></button>`).join('')}
                    </div>
                </div>
                <input type="file" id="importFile" class="hidden" accept=".json" data-action="project-import-file">
            </div>`;
        container.innerHTML = html;
    }

    function renderStatusBar() {
        const container = document.getElementById('statusBar');
        if (!container) return;
        
        // Logic Resolution: Interactive Status Bar (Tier 4)
        // Entry point for Audit Log (Tier 5). Pulsating dot indicates active recording.
        // Updated to remove legacy Undo/Redo and focus on Activity History.
        
        const isRecording = budget.activityLog && budget.activityLog.length > 0;
        
        // Tier 4 Logic: Prioritize Modern Audit Log > Legacy History Stack > Default
        let lastAction = "Ready to Go!";
        if (isRecording) {
            const lastEntry = budget.activityLog[budget.activityLog.length - 1];
            // Format: "ADD: Director" or "UPDATE: Production Fee"
            // Use Escaping to prevent XSS from user input
            const safeAction = mBT.ui.render.esc(lastEntry.action);
            const safeTarget = mBT.ui.render.esc(lastEntry.target);
            lastAction = `${safeAction}: ${safeTarget}`;
        } else if (typeof historyStack !== 'undefined' && historyStack.length > 0) {
            lastAction = historyStack[historyIndex]?.description || "Ready to Go!";
        }
        
        container.innerHTML = `
            <div class="flex items-center justify-between w-full h-full px-2">
                <!-- Left: Status & Rec -->
                <div class="flex items-center gap-3 overflow-hidden mr-4">
                     <div class="flex items-center gap-2 shrink-0">
                         <span class="relative flex h-2 w-2">
                            ${isRecording ? '<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>' : ''}
                            <span class="relative inline-flex rounded-full h-2 w-2 ${isRecording ? 'bg-red-500' : 'bg-slate-600'}"></span>
                         </span>
                         <span class="text-[9px] font-mono text-slate-500 uppercase tracking-widest">REC</span>
                    </div>
                    <div class="w-px h-3 bg-slate-800"></div>
                    <span class="truncate font-mono text-slate-400 text-[10px] uppercase tracking-widest">${lastAction}</span>
                </div>
                
                <!-- Right: Activity History Button -->
                <button onclick="mBT.features.history.open()" class="flex items-center gap-2 hover:text-blue-400 transition-colors group cursor-pointer shrink-0" title="View Activity Log & Undo Changes">
                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500 group-hover:text-white transition-colors hidden sm:block">Activity History</span>
                    <div class="w-6 h-6 bg-slate-800 rounded-full flex items-center justify-center text-slate-400 group-hover:bg-white group-hover:text-slate-900 transition-all shadow-sm border border-slate-700">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>
                    </div>
                </button>
            </div>`;
    }

    function handleUndo() {
        if (historyIndex > 0) {
            historyIndex--;
            budget = mBTState.wrap(JSON.parse(JSON.stringify(historyStack[historyIndex].budget)));
            render();
        }
    }
    function handleRedo() {
        if (historyIndex < historyStack.length - 1) {
            historyIndex++;
            budget = mBTState.wrap(JSON.parse(JSON.stringify(historyStack[historyIndex].budget)));
            render();
        }
    }
    
    function handleNewProjectSelection(e) { /* Stub kept for safety */ }
    
    function handleImportFile(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.projectName) throw new Error("Invalid file structure");
                mBT.data.importFile(input); // Delegate to new system
            } catch (err) { mBTME.alert("Import Failed", err.message); }
            input.value = '';
        };
        reader.readAsText(file);
    }

    window.importContactsCSV = function(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            if (!text) return;
            const lines = text.split(/\r\n|\n/);
            if (lines.length < 2) return mBTME.alert("Error", "Invalid CSV format.");
            const headers = lines[0].split(',').map(h => h.trim());
            const contacts = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = line.split(',');
                const obj = {};
                headers.forEach((h, idx) => {
                    let val = values[idx] ? values[idx].trim() : '';
                    if(val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                    obj[h] = val;
                });
                contacts.push(obj);
            }
            const count = mBTOG.ingest(contacts, 'contact');
            if (count > 0) { 
                mBTME.alert("Success", `${count} new contacts imported.`, () => {
                    if(typeof showSettingsModal === 'function') showSettingsModal('database', 'contacts');
                });
            } else { 
                mBTME.alert("Info", "Import completed. No new contacts added."); 
            }
            input.value = '';
        };
        reader.readAsText(file);
    };

/* ================= v19.54 TIER 6: SYSTEM IGNITION & EVENTS ================= */

    /* --- 1. OFFLINE ENDURANCE SERVICE (Service Worker Registration) --- */
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' })
                .then(reg => {
                    console.log('SW Synchronization active:', reg.scope);
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                mBTME.confirm("Update Available", "New production logic available! Synchronize environment now?", () => {
                                    window.location.reload();
                                });
                            }
                        };
                    };
                })
                .catch(err => console.log('Service Worker initialization failure:', err));
        });
    }

/* --- 2. ACTION REGISTRY (The Nervous System Configuration) --- */
    function registerCoreActions() {
        // A. Header / Project Actions
        mBT.core.action('project-switch', async (e, el) => {
            if (e.type !== 'change') return;
            if (el.value) {
                const originalText = el.options[el.selectedIndex].text;
                el.options[el.selectedIndex].text = "Loading...";
                await mBT.data.load(el.value);
            }
        });

        mBT.core.action('project-new', () => showNewProjectModal());
        mBT.core.action('project-duplicate', async () => await mBT.data.duplicate());
        mBT.core.action('project-delete', async () => { if (currentProjectName) await mBT.data.deleteProject(currentProjectName); });
        
        // New File Menu Actions
        mBT.core.action('project-recycle', () => { if(typeof mBT.features.trash !== 'undefined') mBT.features.trash.open('projects'); });
        mBT.core.action('project-sync', () => { fetchExchangeRates(); mBTME.alert("Coming Soon", "Cloud Sync infrastructure is currently in development. Local exchange rates have been refreshed."); });

        mBT.core.action('project-import-trigger', () => { const input = document.getElementById('importFile'); if(input) input.click(); });
        mBT.core.action('project-import-file', (e, el) => { if(e.type === 'change') mBT.data.importFile(el); });

        // B. Global Utilities
        mBT.core.action('set-currency', (e, el) => {
            displayCurrency = el.value;
            localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
            if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
            if(typeof render === 'function') render();
        });

        mBT.core.action('backup-env', () => { if(typeof mBTPublisher !== 'undefined') mBTPublisher.toMoo(); });
        mBT.core.action('print-pdf', () => window.print());
        mBT.core.action('export-xlsx', () => mBTME.alert("Coming Soon", "Excel export is currently being built. All features will be free to use."));
        mBT.core.action('publish-modal', () => showPublishModal());
        
        // C. Footer / Global Modals
        mBT.core.action('stages-modal', () => showStagesModal());
        mBT.core.action('docs-modal', () => showDocumentsModal());
        mBT.core.action('settings-modal', () => showSettingsModal());
        mBT.core.action('support-modal', () => showCoffeeWidget());
        
        // D. Budget Interaction (The Synapse)
        mBT.core.action('section-toggle', (e, el) => handleToggleSection(el.dataset.id, el));
        mBT.core.action('section-add', (e, el) => showItemSelectorModal(el.dataset.id));
        mBT.core.action('row-delete', (e, el) => handleRemoveItem(el.dataset.section, el.dataset.id));

        mBT.core.action('row-lock', (e, el) => {
            const item = budget.sections[el.dataset.section]?.items.find(i => i.id === el.dataset.id);
            if(item) {
                item.rateType = item.rateType === 'fixed' ? 'negotiable' : 'fixed';
                saveBudget();
                render(); // Full render needed to swap icon state
            }
        });

        // E. Personnel Actions
        mBT.core.action('crew-toggle', (e, el) => toggleCrewPopup(el, e));
        mBT.core.action('crew-profile', (e, el) => openCrewProfile(el, e, el.dataset.id, el.dataset.section));

        // --- NEW: Registry Expansion (Instruction Set 4) ---
        
        // 1. Export Bridge
        mBT.core.action('export', (e, el) => {
            const type = el.dataset.type;
            if(document.getElementById('publishModal')) mBTME.close('publishModal');
            if (typeof mBTPublisher === 'undefined') return;

            if (type === 'pdf') mBTPublisher.format.professionalPdf(budget);
            else if (type === 'moo') mBTPublisher.io.saveMoo(budget);
            else if (type === 'bundle') mBTPublisher.io.saveBundle(budget);
            else if (type === 'html') mBTPublisher.format.htmlStandalone('budget-sections', budget.projectName);
            else if (type === 'xlsx') mBTPublisher.format.professionalXlsx(budget);
        });

        // 2. Navigation
        mBT.core.action('nav-settings', (e, el) => mBT.features.settings.open(el.dataset.tab));

        // 3. Studio Engine
        mBT.core.action('studio-undo', () => { if(mBTDB.undo) mBTDB.undo(); });
        mBT.core.action('studio-redo', () => { if(mBTDB.redo) mBTDB.redo(); });
        mBT.core.action('studio-sync', () => mBTDB.syncFromBudget());
        mBT.core.action('studio-sync-prev', () => mBTDB.syncFromPrevious());
        mBT.core.action('studio-preview', () => mBTDB.openPreviewSelector());
        mBT.core.action('studio-snapshot', () => mBTDB.snapshotDoc());
        mBT.core.action('studio-template', () => mBTDB.saveTemplate());
        mBT.core.action('studio-toggle-edit', () => mBTDB.toggleEditMode());
        
        mBT.core.action('widget-toggle-view', (e, el) => mBTDB.toggleVertical(el.dataset.id));
        mBT.core.action('widget-neural-fill', (e, el) => mBTDB.neuralFill(el.dataset.id, el.dataset.docId));
        mBT.core.action('widget-autofill', (e, el) => mBTDB.autoFillWidget(el.dataset.type, el.dataset.docId));
        mBT.core.action('widget-delete', (e, el) => mBTDB.deleteWidget(el.dataset.id));

        // --- NEW: Documents Hub Actions ---
        mBT.core.action('nav-docs', (e, el) => mBT.features.documents.openVault(el.dataset.tab));
        mBT.core.action('doc-options', (e, el) => mBT.features.documents.showOptions(el.dataset.id));
        mBT.core.action('doc-duplicate', (e, el) => mBTDB.snapshotDoc(el.dataset.id));
        mBT.core.action('doc-archive', (e, el) => window.handleDocTrash(el.dataset.id));

        // 4. Trash Logic
        mBT.core.action('nav-trash', (e, el) => mBT.features.trash.open(el.dataset.tab));
        mBT.core.action('trash-toggle', (e, el) => mBT.features.trash.toggleItem(el.dataset.id));
        mBT.core.action('trash-toggle-all', (e, el) => mBT.features.trash.toggleAll(el.checked));
        mBT.core.action('trash-bulk', (e, el) => mBT.features.trash.performAction(el.dataset.type));
        mBT.core.action('trash-single', (e, el) => mBT.features.trash.singleAction(el.dataset.type, el.dataset.id));

        // F. Stage Actions
        mBT.core.action('stage-update', (e, el) => {
             updateStageItem(el.dataset.id, el.dataset.section, el.dataset.stage, el.dataset.field, el.value);
        });

        // G. History (Tier 4/5/6 Alignment)
        // Logic Resolution: Prioritize Tier 2 Namespace if available
        mBT.core.action('undo', () => { 
            if(mBT.data.history && typeof mBT.data.history.undoSnapshot === 'function') mBT.data.history.undoSnapshot();
            else if(typeof handleUndo === 'function') handleUndo(); 
        });
        mBT.core.action('redo', () => { 
            if(mBT.data.history && typeof mBT.data.history.redoSnapshot === 'function') mBT.data.history.redoSnapshot();
            else if(typeof handleRedo === 'function') handleRedo(); 
        });
    }

    /* --- 3. GLOBAL EVENT ORCHESTRATION --- */
    function bindAppEventListeners() {
        const footer = document.querySelector('footer');
        
        // Initialize Registry
        registerCoreActions();

        if (!document.body.dataset.listenersBound) {
            document.body.dataset.listenersBound = 'true';
            
            // --- Master Router (Delegation) ---
            const router = (e) => {
                if (mBT.core.route(e)) return;
                const target = e.target;
                if (target.id === 'loginBtn') handleLogin();
                if (target.closest('#openAiToolsBtn')) showAIToolsModal();
            };

            document.body.addEventListener('click', router);
            document.body.addEventListener('change', router);

            // --- Keyboard Shortcuts (Tier 6 Wiring) ---
            document.body.addEventListener('keydown', (e) => {
                // Undo: Ctrl+Z
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    if(mBT.core.actions['undo']) mBT.core.actions['undo']();
                }
                // Redo: Ctrl+Y
                if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                    e.preventDefault();
                    if(mBT.core.actions['redo']) mBT.core.actions['redo']();
                }
            });

            // --- Real-time Input Handling ---
            document.body.addEventListener('input', (e) => {
                const input = e.target;
                if (input.id === 'projectName') { handleProjectNameChange(e); return; }
                if (['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(input.id)) {
                    budget[input.id] = parseFloat(input.value) || 0;
                    if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
                    return;
                }
                if (input.dataset.field) {
                    if (input.dataset.action === 'stage-update') {
                         if(typeof updateStageItem === 'function') updateStageItem(input.dataset.id, input.dataset.section, input.dataset.stage, input.dataset.field, input.value, true);
                    } else if (!input.dataset.action) {
                        handleUpdate(input.dataset.section, input.dataset.id, input.dataset.field, input.value, 'User Input');
                    }
                }
            });
        }

        if (footer) {
            footer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                if (btn.id === 'stagesFooterBtn') mBT.core.actions['stages-modal']();
                else if (btn.id === 'docsFooterBtn') mBT.core.actions['docs-modal']();
                else if (btn.id === 'mainActionBtn') mBT.core.actions['settings-modal']();
                else if (btn.id === 'secondaryActionBtn') mBT.core.actions['publish-modal']();
                else if (btn.id === 'footerCoffeeBtn') mBT.core.actions['support-modal']();
            });
        }

        window.addEventListener('online', resolveConnectivityStatus);
        window.addEventListener('offline', resolveConnectivityStatus);
    }

    /* --- 4. INFRASTRUCTURE TELEMETRY --- */
    function resolveConnectivityStatus() {
        const isOnline = navigator.onLine;
        const btn = document.getElementById('loginBtn');
        if(btn) {
            btn.className = `w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0 ${isOnline ? 'border-emerald-400 bg-emerald-50 text-emerald-600' : 'border-rose-400 bg-rose-50 text-rose-600'}`;
            btn.title = isOnline ? "Studio Online" : "Studio Offline";
            btn.innerHTML = mBTAssets.user;
        }
        const aiBtn = document.getElementById('openAiToolsBtn');
        if(aiBtn) {
            aiBtn.className = `p-3 text-white rounded-2xl shadow-lg transition-all active:scale-95 flex items-center justify-center ${isOnline ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-400 cursor-not-allowed'}`;
            if(!isOnline) aiBtn.title = "AI Consultant Offline";
        }
    }
    
    // --- NEW: Support Widget (Buy Me a Coffee) ---
    function showCoffeeWidget() {
        const content = `
            <div class="text-center p-6 bg-yellow-50 min-h-[300px] flex flex-col items-center justify-center">
                <div class="w-20 h-20 bg-[#FFDD00] rounded-3xl flex items-center justify-center text-4xl shadow-xl mb-4 text-black border-4 border-white animate-bounce">
                    
                </div>
                <h3 class="text-xl font-black uppercase tracking-tighter text-slate-900 mb-2">Fuel the Code</h3>
                <p class="text-xs font-bold text-slate-500 mb-6 max-w-xs leading-relaxed">
                    mooBudget is free, offline-first, and built for the Caribbean industry. If it saves you time, consider buying a coffee for the dev team.
                </p>
                <div class="space-y-3 w-full max-w-xs">
                    <a href="https://buymeacoffee.com/jaysonmy" target="_blank" class="flex items-center justify-center gap-2 w-full py-4 bg-[#FFDD00] text-black rounded-xl font-black text-[10px] uppercase tracking-widest shadow-lg hover:scale-105 transition-transform active:scale-95">
                        Open Support Page
                    </a>
                    <button onclick="mBTME.close('coffeeModal')" class="w-full py-3 bg-white border border-slate-200 text-slate-400 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-50 transition-colors">
                        Maybe Later
                    </button>
                </div>
            </div>`;
        mBTME.open('coffee', '', content, 'max-w-sm', { hideHeader: true, noPadding: true });
    }

    // --- NEW: Distribution Share Selector (Preview Handler) ---
    window.openDocumentShareSelector = function(docId) {
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc) return;

        // Generate Share Message
        const shareText = (typeof mBTPublisher !== 'undefined' && mBTPublisher.comm) 
            ? mBTPublisher.comm.generateShareSheet(doc) 
            : `Reviewing ${doc.label}`;

        // Platform Links
        const waLink = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
        const mailLink = `mailto:?subject=${encodeURIComponent("Document Review: " + doc.label)}&body=${encodeURIComponent(shareText)}`;

        const content = `
            <div class="p-6 bg-white">
                <div class="text-center mb-6">
                    <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-3 text-xl">
                        ${mBTAssets.paperPlane}
                    </div>
                    <h3 class="text-sm font-black uppercase tracking-widest text-slate-900">Distribute Document</h3>
                    <p class="text-[10px] text-slate-400 font-bold mt-1">${doc.label}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <a href="${waLink}" target="_blank" class="flex flex-col items-center gap-2 p-4 bg-[#25D366]/10 border border-[#25D366]/20 rounded-xl hover:bg-[#25D366]/20 transition-all group no-underline">
                        <div class="text-[#25D366] text-2xl group-hover:scale-110 transition-transform">${mBTAssets.wa}</div>
                        <span class="text-[9px] font-black uppercase tracking-widest text-[#25D366] group-hover:text-[#128c7e]">WhatsApp</span>
                    </a>
                    <a href="${mailLink}" target="_blank" class="flex flex-col items-center gap-2 p-4 bg-blue-50 border border-blue-100 rounded-xl hover:bg-blue-100 transition-all group no-underline">
                        <div class="text-blue-500 text-2xl group-hover:scale-110 transition-transform">${mBTAssets.mail}</div>
                        <span class="text-[9px] font-black uppercase tracking-widest text-blue-600">Email</span>
                    </a>
                </div>
                
                <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                    <label class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Quick Copy Message</label>
                    <div class="flex gap-2">
                        <input type="text" value="${shareText}" class="flex-grow bg-white border border-slate-200 rounded-lg px-2 py-1.5 text-[10px] font-bold text-slate-600 outline-none" readonly>
                        <button onclick="navigator.clipboard.writeText('${shareText.replace(/'/g, "\\'")}'); this.innerHTML='Copied!';" class="px-3 bg-slate-200 text-slate-600 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-slate-300 transition-colors">Copy</button>
                    </div>
                </div>
            </div>`;

        mBTME.open('shareSelector', 'Share', content, 'max-w-sm', { hideHeader: true, noPadding: true });
    };

    function handleLogin() {
        if (navigator.onLine) {
            mBTME.confirm("Login", "Establish secure connection to Moo Studio Cloud infrastructure?", () => {
                mBTME.alert("Connected", "Environment Authenticated.");
            });
        }
    }

    function injectFooterIcons() {
        const mapping = {
            'icon-stages': mBTAssets.grid,
            'icon-docs': mBTAssets.file,
            'icon-main-action': mBTAssets.gear,
            'icon-secondary-action': mBTAssets.paperPlane,
            'icon-coffee': mBTAssets.coffee
        };
        Object.entries(mapping).forEach(([id, svg]) => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = svg;
        });
    }

    /* --- 5. GLOBAL BOOT TRIGGER --- */
    // Logic Resolution: Global Bridge Hooks for external calls
    window.showBinModal = () => { if (typeof mBT.features.trash !== 'undefined') mBT.features.trash.open('documents'); };
    window.handleDocTrash = (id) => { if (typeof mBT.features.trash !== 'undefined') mBT.features.trash.trashDocument(id); };
    
    // System Start
    document.addEventListener('DOMContentLoaded', () => {
        if (mBT.core && typeof mBT.core.init === 'function') {
            mBT.core.init();
        } else if (typeof init === 'function') {
            init(); // Fallback for safety
        }
    });

/* ======= END OF mBT ========== */
</script>
</body>
</html>
