<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Offline-capable Film Production Budget Tool">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>mooBudgetTool v19.54-Beta</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/moollc/mooBudgetTool/refs/heads/main/assets/cow-512.png">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack.min.css" rel="stylesheet"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/10.1.2/gridstack-all.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; padding-bottom: 50px; background-color: #f3f4f6; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- 1. Interaction Protocols (Drag and drop behavior) --- */
        .draggable-row { cursor: grab; transition: all 0.2s ease-in-out; }
        .draggable-row:active { cursor: grabbing; }
        .draggable-row.dragging { opacity: 0.5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateY(2px) scale(1.02); z-index: 1000; }
        .drag-over { background-color: #f3f4f6; border-top: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6; transition: all 0.2s ease-in-out; }

        /* --- 2. Atomic UI Components (Badges and indicators) --- */
        .alert-badge { position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .status-indicator { transition: opacity 0.5s ease-in-out; }
        .status-online { border-color: #22c55e; color: #15803d; background-color: #f0fdf4; }
        .status-offline { border-color: #ef4444; color: #b91c1c; background-color: #fef2f2; cursor: not-allowed; }

        /* --- 3. Roadmap Visualization (Build timeline) --- */
        .roadmap-past { color: #9ca3af; }
        .roadmap-current { color: #2563eb; font-weight: 700; }
        .roadmap-future { color: #1f2937; }

        /* --- 4. Intelligence Suite Visuals (AI Message styling) --- */
        .ai-message { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; line-height: 1.5; }
        .ai-message.user { background-color: #eff6ff; border: 1px solid #dbeafe; color: #1e3a8a; text-align: right; margin-left: 20%; }
        .ai-message.assistant { background-color: #f0fdf4; border: 1px solid #dcfce7; color: #14532d; margin-right: 10%; }
        .ai-message.assistant strong { color: #166534; font-weight: 700; }
        .ai-message.assistant ul { list-style-type: disc; margin-left: 20px; margin-top: 5px; }

        /* --- 5. Support Interface (Coffee button orchestration) --- */
        .bmc-btn { background-color: #FFDD00; color: #000000; font-family: 'Inter', sans-serif; font-weight: 600; border-radius: 8px; padding: 6px 12px; font-size: 12px; display: inline-flex; align-items: center; text-decoration: none; transition: transform 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer;}
        .bmc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* --- 6. Print Media Protocols (Visibility logic) --- */
        @media print { #footnote, #loginBtn, footer, #settingsBtn, #openAiToolsBtn { display: none !important; } }
        #bmac-btn-container, #bmc-wbtn { display: none !important; }

        /* --- 7. Production Stage Visuals (Carousel and card dynamics) --- */
        #stagesCarousel { scrollbar-width: none; -ms-overflow-style: none; }
        #stagesCarousel::-webkit-scrollbar { display: none; }
        .stage-card { transition: transform 0.2s; }
        .stage-drop-zone { min-height: 100px; }
        .stage-draggable { transition: all 0.2s; touch-action: none; }
        .stage-draggable:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        /* --- 8. Mobile Platform Support (Responsive logic) --- */
        @media (max-width: 768px) {
            .mobile-desc-truncate { text-overflow: ellipsis; white-space: nowrap; overflow: hidden; width: 100%; display: block; }
            .mobile-desc-truncate:focus { white-space: normal; overflow: visible; position: relative; z-index: 50; background: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 4px; padding: 8px; height: auto; }
        }

        /* --- 9. Navigation Elements (Sticky headers and z-indexing) --- */
        .sticky-section-header { position: sticky; top: 0; z-index: 30; background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .sticky-th { position: sticky; top: 43px; z-index: 20; background-color: #ffffff; }

        /* --- 10. Document Studio Canvas (Gridstack orchestration) --- */
        .grid-stack { background-color: #f3f4f6; min-height: 80vh; padding: 10px !important; }
        .grid-stack-item-content { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; overflow: hidden !important; display: flex; flex-direction: column; cursor: grab; }
    </style>
</head>
<body class="bg-gray-100">

<script>

/* ==========================================================================
   mBT STUDIO MAINTENANCE GUIDE
==========================================================================

  STRICT INTEGRITY RULE: 
   This is an open-ended codebase often processed in partial snippets. 
   NEVER remove, prune, or "optimize out" functions, variables, or logic 
   paths simply because they are not currently invoked in a specific view. 
   An uncalled function is a vital component for an interconnected module.
   Failure to respect this results in "Zombie Logic" and system crashes.

   WHAT ARE ENGINES?
   Engines are the power plants of the application. They are central hubs 
   that perform heavy processing. Other parts of the code send raw data 
   to an Engine, and the Engine returns a processed result.

   CORE APPLICATION ENGINES:
   - mBTLE: The Logic Engine. Handles math, currency, and reconciliation.
   - mBTOG: Open Gate. The industry-standard rate and contact database.
   - mBTPublisher: The Document Engine. Interprets data into PDF/XLSX.
   - mBTME: Modal Engine. Orchestrates every window and overlay.
   - mBTStorage: The Memory Engine. Handles LocalForage and persistence.

   DEPENDENCY HIERARCHY (The Smart Home Analogy)
   Logic must be placed in the correct layer to ensure "Fuel" and "Power"
   are available before a feature tries to use them.

   TIER 1: THE FOUNDATION (Environment Configuration)
   - Core constants, currency definitions, and SVG libraries.
   - Establishes the "physics" of the application.

   TIER 2: THE FUEL TANK (State & Storage)
   - mBTStorage hydration and the state proxy governor.
   - Provides the raw material (data) for the application.

   TIER 3: THE CIRCUIT BREAKER (Core Logic Engines)
   - mBTLE and mBTOG. The "Brains" that decide how data is processed.
   - Must be ready before any UI elements are generated.

   TIER 4: THE INTERIOR (Atomic Render Pipeline)
   - RenderEngine generators for rows, buttons, and components.
   - Small HTML fragments built directly from engine outputs.

   TIER 5: THE SMART FEATURES (Module Controllers & Switchboard)
   - mBTDB (Studio), mBTPublisher (Forms), and the AI Suite.
   - Includes the Switchboard (the wiring) connecting buttons to engines.

   TIER 6: THE IGNITION (Async Boot)
   - The final initialization. This turns the power on for the system.
   - Must always remain at the absolute bottom of the file.

==========================================================================
   DEVELOPER CONSTRAINTS & OPERATIONAL PROTOCOL
==========================================================================

   NOTE STYLES:
   - Engines: /* =========  v[original#] Name: Description v[latest#] ========= */
   - Features: /* --- [Feat#]. Title (Details) --- */
   - Sub-features: // --- Detail - description ---

   FORBIDDEN VOCABULARY:
   Never use words like: Update, Fix, Reversed, Changed, Cleaned or quirky ai sounding prhases.
   Comments must strictly provide real descriptions of function and logic.
   Example IDs are the only elements allowed to use brackets like {example_id}.

   SECURITY PROTOCOL:
   - XSS Prevention: Every user-generated string must pass through 
     sanitization logic before rendering to the DOM.
   - Credentials: No API keys are to be hardcoded. Keys must be 
     retrieved from browser localStorage.

==========================================================================
   mBT MANIFEST
==========================================================================
   - TIER 1: CONFIGURATION AND ASSETS
   - TIER 2: STATE PROXY AND LOCALFORAGE STORAGE
   - TIER 3: mBTLE MATH ENGINE AND INDUSTRY DATABASE
   - TIER 4: ATOMIC RENDER PIPELINE
   - TIER 5: MODULE CONTROLLERS AND SWITCHBOARD BRIDGE
   - TIER 6: SYSTEM IGNITION
========================================================================== 
*/

/* ================= v19.55 TIER 1: Environment Configuration v19.55 ================= */

    /* --- 1. Master Asset Registry (Consolidated SVG Library) --- */
    // Logic Resolution: Centralized bucket for all tool assets to prevent Namespace Bloat.
    const mBTAssets = {
        // Master Core Icons
        plus: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
        trash: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
        search: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
        close: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
        drag: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>`,
        lock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
        unlock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`,
        
        // Master Feature Icons
        sparkle: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,
        doctor: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,
        chat: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
        target: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
        zap: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
        print: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>`,
        
        // Communication & Data
        user: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
        phone: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
        mail: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
        wa: `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>`,
        
        // Master Storage & Files
        file: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>`,
        folder: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`,
        cloud: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19A5.5 5.5 0 0 0 18 8.02a9 9 0 0 0-17.53 1.98 7 7 0 0 0 .03 14h12.5a5.5 5.5 0 0 0 4.5-9z"/></svg>`,
        clip: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>`,
        money: `<svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.15-1.46-3.27-3.4h1.96c.1 1.05 1.18 1.91 2.53 1.91 1.38 0 2.29-.84 2.29-1.93 0-1.02-.75-1.58-2.31-2.03l-1.3-.39C8.3 11.5 7 10.15 7 8.35c0-1.69 1.33-2.92 2.76-3.32V3h2.67v1.93c1.61.35 2.89 1.43 3.03 3.19h-1.95c-.13-.9-.95-1.64-2.18-1.64-1.2 0-2.02.77-2.02 1.96 0 .93.75 1.58 2.21 2.03l1.41.44c2.56.77 3.91 2.21 3.91 4.19 0 1.93-1.47 3.32-3.43 3.68z"/></svg>`
    };

    /* --- 2. Master Link Map (Backwards Compatibility) --- */
    // Ensures existing feature logic continues to function while referencing Tier 1.
    const uiIcons = mBTAssets, tplIcons = mBTAssets, docIcons = mBTAssets, dashIcons = mBTAssets;
    const stageModIcons = mBTAssets, analyticsIcons = mBTAssets, contactIcons = mBTAssets;
    const fileIcons = mBTAssets, opsIcons = mBTAssets, studioIcons = mBTAssets, trashIcons = mBTAssets;

    /* --- 3. Production Presets (Industry standard stage ratios) --- */
    const STAGE_PRESETS = {
        'TVC': { 'dev': 10, 'pre': 25, 'prod': 15, 'post': 35, 'dist': 15 },
        'Music Video': { 'dev': 10, 'pre': 20, 'prod': 15, 'post': 40, 'dist': 15 },
        'Documentary': { 'dev': 20, 'pre': 15, 'prod': 35, 'post': 20, 'dist': 10 },
        'Feature Film': { 'dev': 25, 'pre': 20, 'prod': 20, 'post': 25, 'dist': 10 }
    };



/* ========= v19.54 TIER 2: State Proxy & Storage Engine ========= */

    /* --- 1. mBT STATE GOVERNOR (Reactivity and data observation) --- */
    const mBTState = {
        _timer: null,
        _isInitialLoad: true,
        _subscribers: [], 
        subscribe: function(callback) { this._subscribers.push(callback); },
        handler: {
            set(target, prop, value) {
                if (target[prop] === value) return true; 
                target[prop] = value;
                if (!mBTState._isInitialLoad) mBTState.requestReconciliation();
                return true;
            }
        },
        requestReconciliation() {
            clearTimeout(this._timer);
            this._timer = setTimeout(() => {
                // --- Brain Handshake: Synchronize logic engines ---
                if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
                if (typeof render === 'function') render();
                
                this._subscribers.forEach(cb => { try { cb(budget); } catch(e) {} });
                if (typeof saveBudget === 'function') saveBudget();
            }, 150);
        },
        wrap: function(data) {
            this._isInitialLoad = true;
            const proxied = new Proxy(data, this.handler);
            this._isInitialLoad = false;
            return proxied;
        }
    };

    /* --- 2. mBT STORAGE ENGINE (Heavy data persistence and hydration) --- */
    const mBTStorage = {
        heavyKeys: ['attachments', 'previews', 'scripts', 'photos'],
        dehydrate: async function(budgetData) {
            if (typeof window.localforage === 'undefined') return { light: budgetData, heavy: {} };
            const light = { ...budgetData };
            const heavy = {};
            this.heavyKeys.forEach(key => { 
                if (light[key]) { 
                    heavy[key] = light[key]; 
                    delete light[key]; 
                } 
            });
            return { light, heavy };
        },
        hydrate: async function(lightData) {
            const budgetObj = { ...lightData };
            if (typeof window.localforage === 'undefined') return budgetObj;
            for (const key of this.heavyKeys) {
                try {
                    const storageKey = `${budgetObj.projectName}_${key}`;
                    const data = await window.localforage.getItem(storageKey);
                    if (data) budgetObj[key] = data;
                } catch (e) { console.warn(`mBTStorage: Hydration resolution failure for ${key}`); }
            }
            return budgetObj;
        }
    };

    /* --- 3. Persistence Helpers (Keys and local storage access) --- */
    const projectDateFormatKey = `${storageKeyPrefix}projectDateFormat`;
    const projectNameSeparatorKey = `${storageKeyPrefix}projectNameSeparator`;
    
    const getProjectDateFormat = () => localStorage.getItem(projectDateFormatKey) || 'YYYYMMDD';
    const setProjectDateFormat = (format) => localStorage.setItem(projectDateFormatKey, format);
    const getProjectNameSeparator = () => localStorage.getItem(projectNameSeparatorKey) || '-';
    const setProjectNameSeparator = (separator) => localStorage.setItem(projectNameSeparatorKey, separator);

    function saveBudget() {
        try {
            if (!budget || !budget.projectName) return;
            mBTStorage.dehydrate(budget).then(({ light, heavy }) => {
                localStorage.setItem(storageKeyPrefix + budget.projectName, JSON.stringify(light));
                localStorage.setItem(`${storageKeyPrefix}lastLoaded`, budget.projectName);
                localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
                for (const [key, value] of Object.entries(heavy)) {
                    localforage.setItem(`${budget.projectName}_${key}`, value);
                }
            });
        } catch (e) { console.error("mBTStorage: Logic execution failure during save", e); }
    }

    /* --- 4. Global State Registry --- */
    let budget;
    let currentProjectName;
    let historyStack = [];
    let historyIndex = -1;
    const MAX_HISTORY = 7;
    let editingGlobalItemIndex = -1;
    let editingTemplateId = null; 
    let tempTemplateData = null;
    let displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';




/* ================= v19.54 TIER 3: Core Logic Engines ================= */

    /* --- 1. Mathematical Utilities (Reconciliation & formatting helpers) --- */
    const getRate = (code) => exchangeRates[code] || 1;
    const convertFromBase = (amountInJMD, targetCurrency) => (amountInJMD / getRate('JMD')) * getRate(targetCurrency);
    const convertToBase = (amountInTarget, sourceCurrency) => (amountInTarget / getRate(sourceCurrency)) * getRate('JMD');
    const toDisp = (val) => convertFromBase(val, displayCurrency);

    function calculateItem(item) {
        const qty = parseFloat(item.quantity) || 0;
        const rate = parseFloat(item.rate) || 0;
        const multiplier = parseFloat(item.multiplier) || 1;
        const estimated = qty * rate * multiplier;
        const actual = parseFloat(item.actual) || 0;
        return { estimated: estimated, variance: actual - estimated };
    }

    const formatCurrency = (amount) => mBTLE.format.currency(amount);
    
    function formatAbbreviated(num, currency) {
        const val = Math.abs(num);
        const symbol = (0).toLocaleString('en-US', { style: 'currency', currency: currency }).replace(/0.00|0/g, '').trim();
        const sign = num < 0 ? "-" : "";
        if (val >= 1e9) return `${sign}${symbol}${(val / 1e9).toFixed(1)}B`;
        if (val >= 1e6) return `${sign}${symbol}${(val / 1e6).toFixed(1)}M`;
        if (val >= 1e3) return `${sign}${symbol}${(val / 1e3).toFixed(1)}K`;
        return formatCurrency(num);
    }

    /* ========= mBTLE: THE FINANCIAL PROCESSOR (Mathematical reconciliation) ========= */
    const mBTLE = {
        config: {
            currencies: {
                'JMD': { locale: 'en-JM', symbol: 'JMD$', rate: 1 },
                'USD': { locale: 'en-US', symbol: '$', rate: 1 },
                'GBP': { locale: 'en-GB', symbol: 'Â£', rate: 1 },
                'CAD': { locale: 'en-CA', symbol: 'CA$', rate: 1 },
                'EUR': { locale: 'de-DE', symbol: 'â‚¬', rate: 1 }
            }
        },
        format: {
            currency: function(value, code) {
                const currencyCode = code || displayCurrency || 'JMD';
                const cfg = mBTLE.config.currencies[currencyCode] || mBTLE.config.currencies['USD'];
                return new Intl.NumberFormat(cfg.locale, {
                    style: 'currency', currency: currencyCode, currencyDisplay: 'narrowSymbol'
                }).format(value);
            }
        },
        validate: {
            item: function(item) {
                item.quantity = Math.max(0, parseFloat(item.quantity) || 0);
                item.rate = Math.max(0, parseFloat(item.rate) || 0);
                item.multiplier = Math.max(1, parseFloat(item.multiplier) || 1);
                return item;
            }
        },
        reconcile: function() {
            if (!budget || !budget.sections) return;
            let subtotal = 0; let grandActual = 0;
            const isMobile = window.innerWidth < 768;

            Object.keys(budget.sections).forEach(sectionKey => {
                let sectionEstTotal = 0;
                const section = budget.sections[sectionKey];
                section.items.forEach(item => {
                    this.validate.item(item);
                    const calc = calculateItem(item);
                    item.total = calc.estimated;
                    sectionEstTotal += item.total;
                    const actVal = parseFloat(item.actual) || 0;
                    grandActual += actVal;
                    
                    const estCell = document.querySelector(`[data-estimated-id="${item.id}"]`);
                    if (estCell) estCell.textContent = isMobile ? formatAbbreviated(item.total, displayCurrency) : this.format.currency(item.total);
                    
                    const varCell = document.querySelector(`[data-variance-id="${item.id}"]`);
                    if (varCell) {
                        const variance = actVal - item.total;
                        varCell.textContent = isMobile ? formatAbbreviated(variance, displayCurrency) : this.format.currency(variance);
                        varCell.className = `p-2 text-right font-medium ${variance > 0 ? 'text-red-500' : 'text-green-600'}`;
                    }
                });
                section.total = sectionEstTotal;
                subtotal += sectionEstTotal;
                const sectionTotalEl = document.querySelector(`[data-section-total="${sectionKey}"]`);
                if (sectionTotalEl) sectionTotalEl.textContent = this.format.currency(sectionEstTotal);
            });

            const contingency = subtotal * ((budget.contingencyPercentage || 0) / 100);
            const tax = subtotal * ((budget.salesTaxPercentage || 0) / 100);
            const preDiscount = subtotal + contingency + tax;
            const discount = preDiscount * ((budget.discountPercentage || 0) / 100);
            const grandTotal = preDiscount - discount;

            this.updateUI('summarySubtotal', subtotal);
            this.updateUI('summaryContingency', contingency);
            this.updateUI('summaryTax', tax);
            this.updateUI('summaryDiscount', -discount);
            this.updateUI('summaryGrandTotal', grandTotal);
            this.updateUI('summaryActualTotal', grandActual);
            
            budget.subtotal = subtotal;
            budget.grandTotal = grandTotal;
            budget.actualTotal = grandActual;
        },
        updateUI: function(id, val) {
            const el = document.getElementById(id);
            if (el) el.textContent = this.format.currency(val);
        }
    };

    /* ========= mBTOG: OPEN GATE ENGINE (The Industry Brain) ========= */
    const mBTOG = {
        settings: {
            optInSharing: JSON.parse(localStorage.getItem('moo_og_share') || 'false'),
            location: localStorage.getItem('moo_og_loc') || 'Jamaica'
        },
        rates: [], contacts: [], templates: [], 

        init() {
            this.loadRates();
            this.loadContacts();
            this.loadTemplates();
            console.log(`Open Gate Initialized: ${this.rates.length} rates.`);
        },

        loadRates() {
            const stored = JSON.parse(localStorage.getItem('prodBudget_v5_globalItems') || '[]');
            this.rates = (stored.length === 0) ? this._getJamaicaDatabase() : stored;
            if (stored.length === 0) this.saveRates();
        },

        loadContacts() { this.contacts = JSON.parse(localStorage.getItem('moo_contacts') || '[]'); },

        // --- NON-TRUNCATABLE TEMPLATE REGISTRY ---
        loadTemplates() {
            this.templates = [
                { id: 'script', cat: 'Pre-Prod', label: 'Script', icon: 'ðŸ“', default: true },
                { id: 'treatment', cat: 'Pre-Prod', label: 'Story Treatment', icon: 'ðŸ“–', default: false },
                { id: 'breakdown', cat: 'Pre-Prod', label: 'Script Breakdowns', icon: 'ðŸ”', default: true },
                { id: 'shotlist', cat: 'Pre-Prod', label: 'Shot Lists', icon: 'ðŸŽ¬', default: true },
                { id: 'storyboard', cat: 'Pre-Prod', label: 'Storyboards', icon: 'ðŸŽ¨', default: false },
                { id: 'preCheck', cat: 'Pre-Prod', label: 'Pre-Prod Checklist', icon: 'âœ…', default: true },
                { id: 'charProf', cat: 'Pre-Prod', label: 'Character Profiles', icon: 'ðŸ‘¤', default: false },
                { id: 'casting', cat: 'Pre-Prod', label: 'Casting Sheets', icon: 'ðŸŽ­', default: false },
                { id: 'dood', cat: 'Pre-Prod', label: 'Day Out of Days', icon: 'ðŸ“…', default: false },
                { id: 'stripboard', cat: 'Pre-Prod', label: 'Stripboard Schedule', icon: 'ðŸ—“ï¸', default: false },
                { id: 'techScout', cat: 'Pre-Prod', label: 'Tech Scout Report', icon: 'ðŸ“', default: false },
                { id: 'budgetRep', cat: 'Pre-Prod', label: 'Budget/Cost Report', icon: 'ðŸ’°', default: true },
                { id: 'vendorBid', cat: 'Pre-Prod', label: 'Vendor Bid Comparison', icon: 'âš–ï¸', default: false },
                { id: 'pitchDeck', cat: 'Pre-Prod', label: 'Funding Pitch Deck', icon: 'ðŸš€', default: false },
                { id: 'callSheet', cat: 'Production', label: 'Daily Call Sheet', icon: 'ðŸ“¢', default: true },
                { id: 'prodReport', cat: 'Production', label: 'Production Report', icon: 'ðŸ“Š', default: true },
                { id: 'continuity', cat: 'Production', label: 'Continuity/Sound Log', icon: 'ðŸŽ¬', default: false },
                { id: 'muahCont', cat: 'Production', label: 'Hair/Makeup Continuity', icon: 'ðŸ’„', default: false },
                { id: 'propList', cat: 'Production', label: 'Prop List', icon: 'ðŸ”«', default: false },
                { id: 'crewList', cat: 'Production', label: 'Crew Contact List', icon: 'ðŸ“ž', default: true },
                { id: 'transport', cat: 'Production', label: 'Transport Schedule', icon: 'ðŸš—', default: false },
                { id: 'catering', cat: 'Production', label: 'Catering/Meal Tracker', icon: 'ðŸ±', default: false },
                { id: 'pettyCash', cat: 'Production', label: 'Petty Cash Log', icon: 'ðŸ’µ', default: false },
                { id: 'po', cat: 'Production', label: 'Purchase Order', icon: 'ðŸ§¾', default: false },
                { id: 'timecard', cat: 'Production', label: 'Timecards', icon: 'â±ï¸', default: false },
                { id: 'riskAI', cat: 'Production', label: 'AI Risk Assessment', icon: 'ðŸ¤–', default: false },
                { id: 'carbon', cat: 'Production', label: 'Carbon Calculator', icon: 'ðŸŒ±', default: false },
                { id: 'vfxBreak', cat: 'Post-Prod', label: 'VFX Breakdown', icon: 'ðŸ‘¾', default: false },
                { id: 'postSched', cat: 'Post-Prod', label: 'Post Schedule', icon: 'ðŸ“…', default: true },
                { id: 'delivery', cat: 'Post-Prod', label: 'Delivery Schedule', icon: 'ðŸ“¦', default: false },
                { id: 'festTrack', cat: 'Post-Prod', label: 'Festival Tracker', icon: 'ðŸ†', default: false },
                { id: 'talentAgr', cat: 'Legal', label: 'Talent Agreement', icon: 'ðŸ¤', default: true },
                { id: 'locRel', cat: 'Legal', label: 'Location Release', icon: 'ðŸ ', default: true },
                { id: 'kitRental', cat: 'Legal', label: 'Kit Rental Agreement', icon: 'ðŸŽ¥', default: false },
                { id: 'permit', cat: 'Legal', label: 'Filming Permit', icon: 'ðŸ“„', default: false },
                { id: 'insurance', cat: 'Legal', label: 'Insurance Cert', icon: 'ðŸ›¡ï¸', default: false },
                { id: 'dealMemo', cat: 'Legal', label: 'Crew Deal Memo', icon: 'âœï¸', default: false },
                { id: 'covid', cat: 'Legal', label: 'COVID Protocols', icon: 'ðŸ˜·', default: false },
                { id: 'sag', cat: 'Legal', label: 'SAG-AFTRA Paperwork', icon: 'â­', default: false }
            ];
        },

        saveRates() { localStorage.setItem('prodBudget_v5_globalItems', JSON.stringify(this.rates)); },
        ingest(items, type = 'rate') {
            let added = 0;
            if (type === 'rate') {
                const existing = new Set(this.rates.map(i => i.description.toLowerCase()));
                items.forEach(i => {
                    if (!existing.has(i.description.toLowerCase())) {
                        this.rates.push({ description: i.description, unit: i.unit || 'Day', rate: parseFloat(i.rate) || 0 });
                        added++;
                    }
                });
                if (added > 0) this.saveRates();
            } 
            return added;
        },

        // --- NON-TRUNCATABLE JAMAICA 2025 DATABASE ---
        _getJamaicaDatabase() {
            return [
                { description: 'Storyboard Artist', unit: 'Day', rate: 45000 },
                { description: 'Copywriter (Pitch/Treatment)', unit: 'Flat', rate: 75000 },
                { description: 'Script Consultant / Doctor', unit: 'Flat', rate: 150000 },
                { description: 'Pitch Deck Designer', unit: 'Flat', rate: 120000 },
                { description: 'Researcher', unit: 'Day', rate: 25000 },
                { description: 'Concept Artist', unit: 'Day', rate: 40000 },
                { description: 'Legal - Rights & Clearances', unit: 'Flat', rate: 250000 },
                { description: 'Director', unit: 'Day', rate: 85000 },
                { description: 'Executive Producer', unit: 'Flat', rate: 500000 },
                { description: 'Producer', unit: 'Day', rate: 75000 },
                { description: 'Line Producer', unit: 'Day', rate: 65000 },
                { description: 'Screenwriter', unit: 'Flat', rate: 350000 },
                { description: 'Cast - Lead', unit: 'Day', rate: 100000 },
                { description: 'Cast - Supporting', unit: 'Day', rate: 50000 },
                { description: 'Stunt Coordinator', unit: 'Day', rate: 60000 },
                { description: 'Unit Production Manager (UPM)', unit: 'Day', rate: 60000 },
                { description: 'Production Coordinator', unit: 'Day', rate: 30000 },
                { description: '1st Assistant Director (1st AD)', unit: 'Day', rate: 65000 },
                { description: '2nd Assistant Director', unit: 'Day', rate: 45000 },
                { description: '2nd 2nd AD', unit: 'Day', rate: 25000 },
                { description: 'Key PA', unit: 'Day', rate: 20000 },
                { description: 'Set PA', unit: 'Day', rate: 15000 },
                { description: 'Office PA', unit: 'Day', rate: 15000 },
                { description: 'Truck PA', unit: 'Day', rate: 18000 },
                { description: 'Location Manager', unit: 'Day', rate: 50000 },
                { description: 'Location Scout', unit: 'Day', rate: 35000 },
                { description: 'Script Supervisor', unit: 'Day', rate: 40000 },
                { description: 'Medic / Set Nurse', unit: 'Day', rate: 35000 },
                { description: 'Security Guard', unit: 'Day', rate: 12000 },
                { description: 'Craft Service', unit: 'Day', rate: 25000 },
                { description: 'Catering (Per Head)', unit: 'Flat', rate: 2500 },
                { description: 'Director of Photography (DP)', unit: 'Day', rate: 90000 },
                { description: 'Camera Operator', unit: 'Day', rate: 60000 },
                { description: '1st Assistant Camera (Focus)', unit: 'Day', rate: 45000 },
                { description: '2nd Assistant Camera', unit: 'Day', rate: 35000 },
                { description: 'Digital Imaging Tech (DIT)', unit: 'Day', rate: 50000 },
                { description: 'Steadicam Operator', unit: 'Day', rate: 70000 },
                { description: 'Drone Operator', unit: 'Day', rate: 55000 },
                { description: 'Camera Utility', unit: 'Day', rate: 25000 },
                { description: 'Gaffer', unit: 'Day', rate: 55000 },
                { description: 'Best Boy Electric', unit: 'Day', rate: 40000 },
                { description: 'Electrician', unit: 'Day', rate: 30000 },
                { description: 'Key Grip', unit: 'Day', rate: 50000 },
                { description: 'Best Boy Grip', unit: 'Day', rate: 40000 },
                { description: 'Dolly Grip', unit: 'Day', rate: 40000 },
                { description: 'Grip', unit: 'Day', rate: 30000 },
                { description: 'Generator Operator', unit: 'Day', rate: 35000 },
                { description: 'Sound Mixer', unit: 'Day', rate: 50000 },
                { description: 'Boom Operator', unit: 'Day', rate: 35000 },
                { description: 'Sound Utility', unit: 'Day', rate: 25000 },
                { description: 'Production Designer', unit: 'Day', rate: 65000 },
                { description: 'Art Director', unit: 'Day', rate: 50000 },
                { description: 'Set Decorator', unit: 'Day', rate: 45000 },
                { description: 'Set Dresser', unit: 'Day', rate: 30000 },
                { description: 'Props Master', unit: 'Day', rate: 45000 },
                { description: 'Assistant Props', unit: 'Day', rate: 30000 },
                { description: 'Costume Designer', unit: 'Day', rate: 55000 },
                { description: 'Wardrobe Stylist', unit: 'Day', rate: 45000 },
                { description: 'Wardrobe Assistant', unit: 'Day', rate: 25000 },
                { description: 'Makeup Artist (Key)', unit: 'Day', rate: 45000 },
                { description: 'Hair Stylist (Key)', unit: 'Day', rate: 45000 },
                { description: 'Makeup/Hair Assistant', unit: 'Day', rate: 25000 },
                { description: 'Post-Production Supervisor', unit: 'Week', rate: 200000 },
                { description: 'Editor', unit: 'Day', rate: 50000 },
                { description: 'Assistant Editor (AE)', unit: 'Day', rate: 25000 },
                { description: 'Colorist', unit: 'Hour', rate: 15000 },
                { description: 'VFX Supervisor', unit: 'Day', rate: 70000 },
                { description: 'VFX Artist', unit: 'Day', rate: 55000 },
                { description: 'Sound Designer', unit: 'Flat', rate: 150000 },
                { description: 'Composer', unit: 'Flat', rate: 200000 },
                { description: 'Music Supervisor', unit: 'Flat', rate: 100000 }
            ];
        }
    };
    mBTOG.init();

    /* ========= mBTStagesEngine: Production Phase Metrics ========= */
    const mBTStagesEngine = {
        getMetrics: function() {
            const tl = budget.targetLock || { totalCap: 0, stages: {} };
            const result = {
                grandTotal: 0, stageTotals: { dev: 0, pre: 0, prod: 0, post: 0, dist: 0 },
                totalCap: tl.totalCap || 0
            };

            Object.values(budget.sections).forEach(sec => {
                sec.items.forEach(item => {
                    if (item.stageData) {
                        Object.entries(item.stageData).forEach(([key, data]) => {
                            const k = key.toLowerCase();
                            if (result.stageTotals[k] !== undefined) {
                                const cost = (parseFloat(data.days) || 0) * (parseFloat(data.rate) || 0);
                                result.stageTotals[k] += cost;
                                result.grandTotal += cost;
                            }
                        });
                    }
                });
            });
            return result;
        },
        getBurnStatus: function(current, cap) {
            const pct = cap > 0 ? (current / cap) * 100 : 0;
            if (pct > 100) return { color: 'text-red-600', bg: 'bg-red-500', ring: 'border-red-200', pct };
            if (pct > 85) return { color: 'text-blue-600', bg: 'bg-blue-600', ring: 'border-blue-200', pct }; 
            return { color: 'text-green-600', bg: 'bg-green-500', ring: 'border-green-200', pct };
        }
    };

    /* --- 2. Logic Bridges & Data Normalization --- */
    function recalculateTemplateQuantities(data) {
        if (!data.days) return;
        const { principal, scouting, preprod } = data.days;
        const totalDays = (parseFloat(principal) || 0) + (parseFloat(scouting) || 0) + (parseFloat(preprod) || 0);
        Object.values(data.sections).forEach(section => {
            section.items.forEach(item => { if (item.unit === 'Day') item.quantity = totalDays; });
        });
    }

    function balanceStageSliders(changedKey, newValue) {
        const stages = budget.targetLock.stages;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        newValue = Math.max(0, Math.min(100, parseFloat(newValue) || 0));
        const lockedKeys = validKeys.filter(k => k !== changedKey && stages[k].locked);
        const unlockedKeys = validKeys.filter(k => k !== changedKey && !stages[k].locked);
        const lockedTotal = lockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
        stages[changedKey].ratio = Math.min(newValue, 100 - lockedTotal);
        const remaining = Math.max(0, 100 - stages[changedKey].ratio - lockedTotal);
        if (unlockedKeys.length > 0) {
            const currentUnlockedTotal = unlockedKeys.reduce((sum, k) => sum + (stages[k].ratio || 0), 0);
            unlockedKeys.forEach(k => {
                stages[k].ratio = (currentUnlockedTotal <= 0.01) ? remaining / unlockedKeys.length : remaining * (stages[k].ratio / currentUnlockedTotal);
            });
        }
    }

    const mBTAssign = {
        assignFromContacts() {
            const contacts = (typeof getGlobalContacts === 'function' ? getGlobalContacts() : (mBTOG.contacts || []));
            if (!contacts.length) return { assigned: 0, message: 'No records found' };
            let assigned = 0;
            Object.values(budget.sections).forEach(s => s.items.forEach(i => {
                if (i.crew?.name) return;
                const match = contacts.find(c => c.role && i.description.toLowerCase().includes(c.role.toLowerCase()));
                if (match) { 
                    i.crew = { name: match.name, phone: match.contact?.includes('@') ? '' : match.contact, email: match.contact?.includes('@') ? match.contact : '' }; 
                    assigned++; 
                }
            }));
            if (assigned > 0) mBTLE.reconcile();
            return { assigned, message: `${assigned} personnel synchronized` };
        }
    };




/* ========= v19.54 TIER 4: Atomic Render Pipeline ========= */

    const RenderEngine = {
        // --- XSS Neutralization: Standardized string escaping ---
        esc(str) { 
            return !str ? '' : String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#x27;'); 
        },

        // --- Layout Shell: Section container generation ---
        section({ name, total = '', isOpen = true, content = '' }) {
            const safeName = this.esc(name);
            return `
                <div class="mb-4 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="sticky-section-header relative min-h-[48px] px-4 py-3 flex justify-between items-center cursor-pointer bg-slate-50 select-none group" data-section-toggle="${safeName}">
                        <div class="flex items-center gap-3">
                            <span class="section-arrow text-blue-500 transition-transform ${isOpen ? 'rotate-0' : '-rotate-90'}">${mBTAssets.plus}</span>
                            <h2 class="text-[11px] font-black text-slate-800 uppercase tracking-widest leading-none">${safeName}</h2>
                        </div>
                        <span data-section-total="${safeName}" class="text-sm font-black text-blue-600 font-mono flex-shrink-0">${total}</span>
                    </div>
                    <div class="section-content ${isOpen ? '' : 'hidden'} animate-in fade-in slide-in-from-top-1 duration-200">
                        ${content}
                    </div>
                </div>`;
        },

        // --- Data Row Blueprint: Itemized line generation ---
        lineItem(item, sectionName) {
            const safeId = this.esc(item.id); 
            const safeSection = this.esc(sectionName);
            const isMobile = window.innerWidth < 768;
            const { estimated, variance } = calculateItem(item); 
            const crew = item.crew || {};
            const isLocked = item.rateType === 'fixed';
            const initials = crew.name ? crew.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
            const cleanPhone = crew.phone ? crew.phone.replace(/\D/g, '') : '';

            return `
                <tr class="group border-b border-slate-50 hover:bg-blue-50/30 transition-all draggable-row" data-item-id="${safeId}" data-section="${safeSection}">
                    <td class="p-2 text-center relative">
                        <div class="crew-wrapper inline-block">
                            <button onclick="toggleCrewPopup(this, event)" class="crew-avatar w-8 h-8 rounded-full border-2 border-dashed border-slate-200 flex items-center justify-center text-slate-300 hover:border-blue-400 hover:text-blue-500 transition-all ${crew.name ? 'assigned' : 'unassigned'}">
                                ${crew.name ? '<span class="text-[10px] font-black text-blue-600">' + initials + '</span>' : mBTAssets.user}
                            </button>
                        </div>
                    </td>
                    <td class="p-2 drag-handle text-slate-200 hover:text-slate-400 cursor-grab active:cursor-grabbing">${mBTAssets.drag}</td>
                    <td class="p-2">
                        <input type="text" data-id="${safeId}" data-section="${safeSection}" data-field="description" value="${this.esc(item.description)}" 
                               class="w-full bg-transparent border-none font-bold text-slate-700 focus:ring-0 truncate mobile-desc-truncate" placeholder="Line Item Description">
                    </td>
                    <td class="p-2">
                        <input type="number" data-id="${safeId}" data-section="${safeSection}" data-field="quantity" value="${item.quantity}" 
                               class="w-full bg-transparent border-none text-center font-black text-blue-600 focus:ring-0 no-spinner">
                    </td>
                    <td class="p-2">
                        <select data-id="${safeId}" data-section="${safeSection}" data-field="unit" 
                                class="w-full bg-transparent border-none text-[10px] font-black uppercase tracking-tighter text-slate-400 focus:ring-0 cursor-pointer">
                            ${['Day','Week','Flat','Policy','Hour'].map(u => `<option value="${u}" ${item.unit === u ? 'selected' : ''}>${u}</option>`).join('')}
                        </select>
                    </td>
                    <td class="p-2">
                        <div class="flex items-center gap-1">
                            <button onclick="toggleRateType('${safeId}', '${safeSection}')" class="w-7 h-7 rounded-lg transition-all flex-shrink-0 flex items-center justify-center ${isLocked ? 'text-rose-500 bg-rose-50' : 'text-emerald-600 bg-emerald-50'}">
                                ${isLocked ? mBTAssets.lock : mBTAssets.zap}
                            </button>
                            <input type="number" step="0.01" data-id="${safeId}" data-section="${safeSection}" data-field="rate" value="${toDisp(item.rate).toFixed(2)}" 
                                   class="w-full bg-transparent border-none font-mono font-bold text-slate-500 focus:ring-0 no-spinner">
                        </div>
                    </td>
                    <td class="p-2 font-mono font-bold text-slate-800" data-estimated-id="${safeId}">
                        ${isMobile ? formatAbbreviated(estimated, displayCurrency) : mBTLE.format.currency(estimated)}
                    </td>
                    <td class="p-2">
                        <input type="number" step="0.01" data-id="${safeId}" data-section="${safeSection}" data-field="actual" value="${toDisp(item.actual || 0).toFixed(2)}" 
                               class="w-full bg-blue-50/50 rounded-lg border-none font-mono font-bold text-emerald-600 focus:ring-0 no-spinner" placeholder="0.00">
                    </td>
                    <td class="p-2 text-right font-mono font-black" data-variance-id="${safeId}">
                        ${isMobile ? formatAbbreviated(variance, displayCurrency) : mBTLE.format.currency(variance)}
                    </td>
                    <td class="p-2 text-center">
                        <button onclick="handleRemoveItem('${safeSection}', '${safeId}')" class="text-slate-200 hover:text-rose-500 transition-colors">
                            ${mBTAssets.trash}
                        </button>
                    </td>
                </tr>`;
        },

        // --- 3. Stage Visualization: Production phase card generation ---
        stageCard(item, stageKey) {
            const cost = (item._sDays || 0) * (item._sRate || 0);
            return `
                <div class="stage-card-item p-3 bg-white border border-slate-100 rounded-xl shadow-sm space-y-2 group relative" data-item-id="${item.id}" data-stage-key="${stageKey}">
                    <div class="flex justify-between items-start">
                        <div class="min-w-0 pr-6">
                            <p class="text-[10px] font-black text-slate-800 uppercase truncate">${this.esc(item.description)}</p>
                            <p class="text-[8px] text-slate-400 font-bold uppercase tracking-widest">${this.esc(item._sec)}</p>
                        </div>
                        <button onclick="removeStageItem('${item.id}', '${item._sec}', '${stageKey}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all">
                            ${mBTAssets.close}
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="flex-1">
                            <label class="block text-[7px] font-black text-slate-400 uppercase">Days</label>
                            <input type="number" value="${item._sDays}" onchange="updateStageItem('${item.id}', '${item._sec}', '${stageKey}', 'days', this.value)" 
                                   class="w-full bg-slate-50 border-none rounded p-1 text-[10px] font-bold text-blue-600 no-spinner">
                        </div>
                        <div class="flex-[2]">
                            <label class="block text-[7px] font-black text-slate-400 uppercase">Rate</label>
                            <input type="number" value="${item._sRate}" onchange="updateStageItem('${item.id}', '${item._sec}', '${stageKey}', 'rate', this.value)" 
                                   class="w-full bg-slate-50 border-none rounded p-1 text-[10px] font-mono font-bold text-slate-600 no-spinner">
                        </div>
                    </div>
                    <div class="pt-1 flex justify-between items-center border-t border-slate-50">
                        <span class="text-[8px] font-black text-slate-300 uppercase">Allocated Cost</span>
                        <span id="cost-${item.id}-${stageKey}" class="text-[10px] font-black text-slate-900 font-mono">${formatAbbreviated(cost, displayCurrency)}</span>
                    </div>
                </div>`;
        }
    };

    /* --- 4. Render Orchestration: Global UI drawing logic --- */
    function renderBudgetSections() {
        if (!budget || !budget.sections) return '';
        return Object.entries(budget.sections).map(([name, section]) => {
            const bodyContent = `
                <div class="table-container overflow-x-auto no-scrollbar">
                    <table class="w-full text-xs border-collapse min-w-[800px]">
                        <thead class="sticky-th bg-white text-slate-400 font-black uppercase tracking-tighter border-b border-slate-100">
                            <tr>
                                <th class="p-3 text-center w-12">Crew</th>
                                <th class="p-3 w-8"></th> 
                                <th class="p-3 text-left">Description</th>
                                <th class="p-3 text-center w-16">Qty</th>
                                <th class="p-3 text-center w-20">Unit</th>
                                <th class="p-3 text-left w-32">Rate</th>
                                <th class="p-3 text-left w-28 font-black">Estimated</th>
                                <th class="p-3 text-left w-28">Actual</th>
                                <th class="p-3 text-right w-28">Variance</th>
                                <th class="p-3 w-10"></th>
                            </tr>
                        </thead>
                        <tbody data-section-body="${name}">
                            ${section.items.map(item => RenderEngine.lineItem(item, name)).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="p-1 bg-slate-50/50 border-t border-slate-100 rounded-b-2xl">
                    <button data-add-item="${name}" class="w-full py-2.5 text-center text-blue-600 font-black text-[10px] uppercase tracking-widest hover:bg-blue-50 transition-all">
                        ${mBTAssets.plus} Add Line Item
                    </button>
                </div>`;

            return RenderEngine.section({
                name: name,
                total: mBTLE.format.currency(section.total),
                isOpen: section.isOpen,
                content: bodyContent
            });
        }).join('');
    }

    function render() {
        const app = document.getElementById('app');
        if (!budget || !app) return;
        const active = document.activeElement;
        const activeId = active?.id;
        const activeData = { id: active?.dataset.id, field: active?.dataset.field };
        
        // --- Synchronization: Reconcile math logic before drawing frame ---
        mBTLE.reconcile();

        app.innerHTML = `
        <header class="mb-6 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto flex-grow">
                <input type="text" id="projectName" value="${budget.projectName}" class="text-2xl sm:text-4xl font-black uppercase text-slate-900 bg-transparent min-w-0 flex-grow focus:outline-none focus:bg-white p-3 rounded-2xl transition-all tracking-tighter" />
                <button id="loginBtn" class="w-12 h-12 rounded-full border-2 flex items-center justify-center transition-all shadow-xl flex-shrink-0 active:scale-90"></button>
            </div>
            <div id="project-management-container" class="w-full md:w-auto flex-shrink-0"></div>
        </header>

        <div class="flex gap-2 items-center mb-6">
            <button id="openAiToolsBtn" class="p-3 bg-indigo-600 text-white rounded-2xl shadow-lg transition-all hover:bg-indigo-700 active:scale-95 flex items-center justify-center">${mBTAssets.sparkle}</button>
            <div id="statusBar" class="flex-grow p-3.5 bg-slate-900 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest flex justify-between items-center shadow-2xl"></div>
        </div>

        <div id="summary" class="mb-10 space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-blue-600 text-white p-6 rounded-[32px] shadow-2xl flex flex-col justify-center relative overflow-hidden group">
                    <div class="absolute -right-4 -top-4 opacity-10 transition-transform group-hover:scale-110 duration-700">${mBTAssets.money}</div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-blue-200 mb-1">Estimated Grand Total</p>
                    <p id="summaryGrandTotal" class="text-4xl font-black tracking-tighter">${mBTLE.format.currency(budget.grandTotal)}</p>
                </div>
                <div class="bg-emerald-600 text-white p-6 rounded-[32px] shadow-2xl flex flex-col justify-center relative overflow-hidden group">
                    <p class="text-[10px] font-black uppercase tracking-widest text-emerald-200 mb-1">Actual Expenditure</p>
                    <p id="summaryActualTotal" class="text-4xl font-black tracking-tighter">${mBTLE.format.currency(budget.actualTotal)}</p>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Discount</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="discountPercentage" value="${budget.discountPercentage || 0}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryDiscount" class="text-lg font-black text-slate-800">${mBTLE.format.currency(budget.grandTotal * (budget.discountPercentage/100))}</p>
                </div>

                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Contingency</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="contingencyPercentage" value="${budget.contingencyPercentage}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryContingency" class="text-lg font-black text-slate-800">${mBTLE.format.currency(budget.subtotal * (budget.contingencyPercentage/100))}</p>
                </div>

                <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Sales Tax</label>
                        <div class="flex items-center bg-slate-50 px-2 py-0.5 rounded-lg border border-slate-100">
                            <input type="number" step="0.1" id="salesTaxPercentage" value="${budget.salesTaxPercentage}" class="w-8 text-right text-[11px] font-black text-blue-600 bg-transparent outline-none">
                            <span class="text-[10px] font-black text-slate-300 ml-0.5">%</span>
                        </div>
                    </div>
                    <p id="summaryTax" class="text-lg font-black text-slate-800">${mBTLE.format.currency(budget.subtotal * (budget.salesTaxPercentage/100))}</p>
                </div>

                <div class="p-4 bg-slate-900 rounded-2xl shadow-xl">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-2">Project Subtotal</p>
                    <p id="summarySubtotal" class="text-lg font-black text-white">${mBTLE.format.currency(budget.subtotal)}</p>
                </div>
            </div>
        </div>

        <main id="budget-sections" class="space-y-4">${renderBudgetSections()}</main>

        <div class="mt-12 p-5 bg-slate-900 rounded-[32px] text-[10px] text-slate-400 font-bold uppercase tracking-widest border border-black shadow-2xl">
            <span class="opacity-50">Intelligence:</span> Industrial personnel rates based on 2025 verified logic. Regional data resolution applied.
            <button id="compareRatesBtn" class="ml-3 text-blue-400 hover:text-white transition-colors underline decoration-blue-500/30 underline-offset-4">Open Matrix</button>
        </div>`;
        
        if (typeof renderProjectManagement === 'function') renderProjectManagement();
        if (typeof renderStatusBar === 'function') renderStatusBar();
        if (typeof initializeInteractiveInputs === 'function') initializeInteractiveInputs();
        if (typeof initializeDragAndDrop === 'function') initializeDragAndDrop();
        if (typeof updateOnlineStatus === 'function') updateOnlineStatus(); 

        // --- View Resolution: Focus restoration ---
        if (activeId) {
            document.getElementById(activeId)?.focus();
        } else if (activeData.id && activeData.field) {
            const selector = `[data-id="${activeData.id}"][data-field="${activeData.field}"]`;
            document.querySelector(selector)?.focus();
        }
    }




/* ================= TIER 5: MODULE CONTROLLERS & SMART FEATURES ================= */

    /* ========= v19.55 mBTME: MODAL ENGINE (Window orchestration) v19.55 ========= */
    const mBTME = {
        containerId: 'global-modal-container',
        // --- Registry Resolution: Pointing to Tier 1 Asset Registry ---
        icons: { close: mBTAssets.close },
        
        // --- Portal Generation: Dynamic injection of overlay layers ---
        open: function(id, title, contentHtml, maxWidth = 'max-w-2xl', options = {}) {
            const container = document.getElementById(this.containerId);
            if (!container) return;
            const modalId = `${id}Modal`;
            this.close(modalId, true); 

            const headerHtml = options.hideHeader ? '' : `
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h2 class="text-sm font-black uppercase tracking-widest text-slate-700">${title}</h2>
                    <button onclick="mBTME.close('${modalId}')" class="text-slate-400 hover:text-red-500 transition-all active:scale-90">${this.icons.close}</button>
                </div>`;

            const fullHtml = `
                <div id="${modalId}" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-[999] transition-opacity duration-300 opacity-0 hidden" tabindex="-1">
                    <div id="${modalId}Content" class="bg-white rounded-2xl shadow-2xl w-full ${maxWidth} mx-auto max-h-[95vh] flex flex-col transition-all duration-300 transform scale-95 border border-white/20">
                        ${headerHtml}
                        <div class="overflow-y-auto flex-grow no-scrollbar ${options.noPadding ? 'p-0' : 'p-6'}" id="${modalId}Body">${contentHtml}</div>
                    </div>
                </div>`;

            container.insertAdjacentHTML('beforeend', fullHtml);
            const modal = document.getElementById(modalId);
            modal.classList.remove('hidden');
            setTimeout(() => { 
                modal.classList.remove('opacity-0'); 
                document.getElementById(`${modalId}Content`)?.classList.remove('scale-95'); 
            }, 10);
            
            modal.addEventListener('click', (e) => { if (e.target === modal) this.close(modalId); });
            if (options.onOpen && typeof options.onOpen === 'function') setTimeout(options.onOpen, 50);
            return modal;
        },

        // --- Portal Dissolution: Synchronized removal of UI layers ---
        close: function(modalId, instant = false) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            if (instant) { modal.remove(); } else {
                modal.classList.add('opacity-0');
                document.getElementById(`${modalId}Content`)?.classList.add('scale-95');
                // --- Handshake: Reconcile logic on environment exit ---
                setTimeout(() => { modal.remove(); if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); }, 300);
            }
        },

        // --- Search Integration: Filtering logic for modal lists ---
        attachSearch: function(inputId, listContainerId, dataItems, renderRowFn) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listContainerId);
            if (!input || !list) return;
            input.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = dataItems.filter(item => (item.description || item.name || item.label || '').toLowerCase().includes(term));
                list.innerHTML = filtered.length > 0 ? filtered.map(renderRowFn).join('') : `<div class="p-12 text-center text-slate-300 text-[10px] font-black uppercase tracking-widest">No Matches</div>`;
            });
        }
    };

    /* ========= v19.54 mBTPublisher: DOCUMENT ENGINE v19.55 ========= */
    const mBTPublisher = {
        defaultPdfOptions: { margin: 0.3, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } },
        
        // --- Structural Blueprints: HTML fragments for document construction ---
        fragments: {
            header: (meta) => `<div style="border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-end; font-family: Arial, sans-serif;"><div style="width: 65%;"><h1 style="margin:0; font-size: 24px; text-transform: uppercase; font-weight: 900;">${meta.productionTitle || 'PROJECT'}</h1><div style="font-size: 12px; font-weight: bold;">${meta.productionCompany || ''}</div></div><div style="width: 30%; text-align: right; font-size: 11px;"><div><strong>DATE:</strong> ${meta.shootDate || 'TBD'}</div><div style="background: #000; color: #fff; padding: 4px 8px; display: inline-block; margin-top: 5px; font-size: 12px;"><strong>CALL:</strong> ${meta.crewCallTime || '00:00'}</div></div></div>`,
            table: (title, headers, rows) => `<div style="margin-bottom: 15px; font-family: Arial, sans-serif; page-break-inside: avoid;"><div style="background: #333; color: white; padding: 4px 8px; font-size: 10px; font-weight: 900; text-transform: uppercase;">${title}</div><table style="width: 100%; border-collapse: collapse; font-size: 10px; border: 1px solid black;"><thead><tr style="background: #eee; border-bottom: 1px solid black;">${headers.map(h => `<th style="text-align: left; padding: 6px; border-right: 1px solid #ccc;">${h}</th>`).join('')}</tr></thead><tbody>${rows.map(row => `<tr style="border-bottom: 1px solid #eee;">${Object.values(row).filter(v => typeof v !== 'object').map(val => `<td style="padding: 4px 6px; border-right: 1px solid #eee;">${val || ''}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`,
            note: (title, content) => `<div style="border: 1px solid black; margin-bottom: 15px; font-family: Arial, sans-serif; page-break-inside: avoid;"><div style="background: #eee; padding: 4px 8px; font-size: 10px; font-weight: 900; border-bottom: 1px solid black; text-transform: uppercase;">${title}</div><div style="padding: 8px; font-size: 11px; white-space: pre-wrap;">${content || 'N/A'}</div></div>`
        },

        // --- Template UI: Rendering of interactive form fields ---
        renderEditor: function(doc) {
            if (!doc?.content?.data) return '<div class="p-8 text-center text-slate-400 font-bold uppercase text-xs tracking-widest">Initialization Resolution Required</div>';
            const data = doc.content.data;
            const docId = doc.id;
            const common = "w-full p-2.5 border border-slate-200 rounded-xl text-xs font-bold bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-50 transition-all outline-none";
            
            const renderInput = (sec, key, spec) => `<div class="mb-4"><label class="block text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">${spec.label}</label>${spec.type === 'textarea' ? `<textarea class="${common}" rows="3" onchange="updateMtempField('${docId}', '${sec}', '${key}', this.value)">${data[sec]?.[key] || ''}</textarea>` : `<input type="${spec.type}" value="${data[sec]?.[key] || ''}" class="${common}" onchange="updateMtempField('${docId}', '${sec}', '${key}', this.value)">`}</div>`;
            
            const renderTable = (key, spec) => {
                const rows = data.tables?.[key] || spec.rows || [];
                let tbl = `<div class="mb-6 overflow-hidden border border-slate-100 rounded-2xl shadow-sm"><div class="bg-slate-50 p-3 border-b border-slate-100 flex justify-between items-center"><h4 class="font-black text-[10px] text-slate-500 uppercase tracking-widest">${spec.label}</h4></div><table class="w-full text-[11px]"><thead><tr class="bg-white text-slate-400 font-black uppercase tracking-tighter">${spec.columns.map(c => `<th class="p-2 text-left">${c}</th>`).join('')}<th class="w-8"></th></tr></thead><tbody>`;
                rows.forEach((r, rIdx) => { 
                    tbl += `<tr class="group border-t border-slate-50">${r.map((c, cIdx) => `<td class="p-0"><input value="${RenderEngine.esc(c)}" class="w-full p-2 bg-transparent border-none outline-none focus:bg-blue-50/50 transition-all" onchange="updateMtempTable('${docId}', '${key}', ${rIdx}, ${cIdx}, this.value)"></td>`).join('')}<td class="p-1 text-center"><button class="text-slate-200 hover:text-red-500 font-black text-lg" onclick="removeMtempRow('${docId}', '${key}', ${rIdx})">Ã—</button></td></tr>`; 
                });
                return tbl + `</tbody></table><button onclick="addMtempRow('${docId}', '${key}')" class="w-full p-2 bg-slate-50 text-[9px] font-black uppercase text-blue-600 hover:bg-blue-50 transition-all">${mBTAssets.plus} Add Entry</button></div>`;
            };

            let left = "", right = "";
            Object.keys(doc.content.fields || {}).forEach(sec => { 
                if (sec !== 'tables') { 
                    left += `<div class="bg-white p-5 rounded-2xl border border-slate-100 mb-6 shadow-sm"><h3 class="font-black text-slate-800 uppercase text-[10px] tracking-widest border-b border-slate-50 pb-3 mb-4">${sec.replace('_', ' ')}</h3>${Object.keys(doc.content.fields[sec]).map(f => renderInput(sec, f, doc.content.fields[sec][f])).join('')}</div>`; 
                } 
            });
            if (doc.content.fields?.tables) Object.keys(doc.content.fields.tables).forEach(t => right += renderTable(t, doc.content.fields.tables[t]));
            return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-6">${left}<div>${right}</div></div>`;
        },

        // --- Data Interpretation: Resolving template tags with live data ---
        interpret: function(doc) {
            const data = doc.content.data || {};
            const regex = /{{([^}]+)}}/g;
            return (doc.content.htmlTemplate || '').replace(regex, (match, p1) => {
                const pts = p1.split('.');
                if (pts[0] === 'table') {
                    const spec = doc.content.fields.tables[pts[1]];
                    const rows = data.tables?.[pts[1]] || spec.rows || [];
                    return `<table><thead><tr>${spec.columns.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
                }
                return data[pts[0]]?.[pts[1]] || '';
            });
        },

        // --- Information Synchronization: Automated budget-to-doc mapping ---
        processAutofill: function(doc, budgetData) {
            const fields = doc.content.fields; const data = doc.content.data;
            if (!data.tables) data.tables = {};
            Object.keys(fields).forEach(sec => {
                if (sec === 'tables') return;
                Object.keys(fields[sec]).forEach(f => {
                    const spec = fields[sec][f];
                    if (!data[sec]) data[sec] = {};
                    if (spec.autofill === 'projectName') data[sec][f] = budgetData.projectName || '';
                    else if (spec.autofill?.startsWith('role:')) {
                        const target = spec.autofill.split(':')[1].toLowerCase();
                        for (const s of Object.values(budgetData.sections)) {
                            const m = s.items.find(i => i.description.toLowerCase().includes(target) && i.crew?.name);
                            if (m) { data[sec][f] = `${m.crew.name} ${m.crew.phone ? '| '+m.crew.phone : ''}`; break; }
                        }
                    }
                });
            });
            if (fields.tables?.crew?.autofillSource === 'budget_sections') {
                const rows = [];
                Object.entries(budgetData.sections).forEach(([sec, sObj]) => { sObj.items.forEach(i => { if (i.crew?.name) rows.push([sec, i.description, i.crew.name, "07:00", i.crew.phone || '-']); }); });
                data.tables.crew = rows;
            }
            // --- Brain Handshake: Sync math before finishing autofill ---
            if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); 
            return doc;
        },

        // --- Export Protocols: File generation sequences ---
        toXLSX: function(data, sheet, file) {
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(data), sheet);
            XLSX.writeFile(wb, `${file.replace(/\s+/g, '_')}.xlsx`);
        },
        toMoo: function() {
            const blob = new Blob([JSON.stringify(budget, null, 2)], { type: 'application/json' });
            this.forceDownload(blob, `${(budget.projectName || 'untitled').toLowerCase()}.moo`);
        },
        forceDownload: function(blob, filename) {
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    };

    /* ========= v19.55 mBTDB: STUDIO BUILDER ENGINE v19.55 ========= */
    window.mBTDB = {
        state: { currentDocId: null, isEditing: false, grid: null, history: [], historyPointer: -1 },
        // --- Registry Resolution: All visuals pull from Tier 1 ---
        icons: {
            trash: mBTAssets.trash, plus: mBTAssets.plus, user: mBTAssets.user,
            cloud: mBTAssets.cloud, save: mBTAssets.save, undo: mBTAssets.undo,
            redo: mBTAssets.redo, copy: mBTAssets.copy, print: mBTAssets.print,
            close: mBTAssets.close, wand: mBTAssets.wand, grid: mBTAssets.grid,
            list: mBTAssets.list
        },
        
        templates: {
            'default': { label: "Blank Document", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }] },
            'callSheet': {
                label: "Daily Call Sheet",
                widgets: [
                    { id: 'contacts', x: 0, y: 0, w: 12, h: 4, type: 'contacts', label: "Key Contacts" }, 
                    { id: 'logistics', x: 0, y: 4, w: 12, h: 6, type: 'logistics', label: "Logistics" },
                    { id: 'schedule', x: 0, y: 10, w: 12, h: 8, type: 'schedule', label: "Schedule" },
                    { id: 'cast', x: 0, y: 18, w: 6, h: 8, type: 'cast', label: "Cast List" },
                    { id: 'crew', x: 6, y: 18, w: 6, h: 8, type: 'crew', label: "Crew List" },
                    { id: 'notes', x: 0, y: 26, w: 12, h: 4, type: 'richText', label: "General Notes" }
                ]
            }
        },

        open: function(docId) {
            this.state.currentDocId = docId;
            const doc = budget.documents.find(d => d.id === docId);
            if (!doc) return;
            if (!doc.content) doc.content = { data: {}, widgets: [] };
            if (!doc.content.widgets || doc.content.widgets.length === 0) {
                const tKey = this.templates[doc.type] ? doc.type : 'default';
                doc.content.widgets = JSON.parse(JSON.stringify(this.templates[tKey].widgets));
                if(!doc.content.data.meta) doc.content.data = this._generateDefaultData();
            }
            if(typeof mBTME !== 'undefined') {
                mBTME.open('documentViewerModal', 'Document Studio', '<div id="mBTDB_Container"></div>', 'w-full h-full max-w-full', { noPadding: true, hideHeader: true });
                this.renderFrame();
            }
        },

        close: function() { 
            if(typeof mBTME !== 'undefined') mBTME.close('documentViewerModal'); 
            document.body.classList.remove('print-mode'); 
        },

        toggleEditMode: function() {
            if (this.state.isEditing && this.state.grid) this._saveLayoutState(); 
            this.state.isEditing = !this.state.isEditing;
            const container = document.getElementById('mBTDB_Workspace');
            const grid = this.state.grid;
            if (container && grid) {
                if (this.state.isEditing) { 
                    container.classList.add('editing-mode'); 
                    grid.setStatic(false); 
                    grid.enable(); 
                } else { 
                    container.classList.remove('editing-mode'); 
                    grid.setStatic(true); 
                    grid.disable(); 
                }
                this._updateHeaderButtons();
            }
        },

        _saveLayoutState: function() {
            if (!this.state.grid) return;
            const doc = budget.documents.find(d => d.id === this.state.currentDocId);
            this.state.grid.engine.nodes.forEach(node => {
                const widget = doc.content.widgets.find(w => w.id === node.id);
                if (widget) { widget.x = node.x; widget.y = node.y; widget.w = node.w; widget.h = node.h; }
            });
            this._triggerSave();
        },

        previewDoc: function(mode) {
            const doc = budget.documents.find(d => d.id === this.state.currentDocId);
            if (!doc || !typeof mBTPublisher !== 'undefined') return;
            if(mBTME.showLoader) mBTME.showLoader("Generating Professional Preview...");
            mBTPublisher.generateFastPreview(mode, doc.content.data, (jpegURL) => {
                if(mBTME.hideLoader) mBTME.hideLoader();
                mBTME.open('previewModal', `Industry View: ${mode.toUpperCase()}`, 
                    `<div class="flex flex-col items-center bg-slate-900 h-full p-8 overflow-auto no-scrollbar">
                        <img src="${jpegURL}" id="finalPreviewImage" class="shadow-2xl border border-black max-w-full h-auto mb-24 bg-white rounded-sm">
                        <div class="fixed bottom-10 left-1/2 -translate-x-1/2 flex gap-4 z-[10001]">
                            <button onclick="mBTPublisher.downloadJPEG('${jpegURL}', '${doc.label}')" class="flex items-center gap-3 bg-blue-600 text-white px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-blue-500 transition-all active:scale-95">Download JPEG</button>
                            <button onclick="mBTDB.sendToDistribution('${jpegURL}')" class="flex items-center gap-3 bg-emerald-600 text-white px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-emerald-500 transition-all active:scale-95">Send to Crew</button>
                            <button onclick="mBTME.close('previewModal')" class="bg-white text-slate-900 px-8 py-3 rounded-full font-black text-[10px] uppercase tracking-widest shadow-2xl hover:bg-slate-100 transition-all">Close</button>
                        </div>
                    </div>`, 'w-full h-full'
                );
            });
        },

        sendToDistribution: function(jpegURL) { 
            const doc = budget.documents.find(d => d.id === this.state.currentDocId); 
            this.close(); 
            if(window.openDocumentShareSelector) openDocumentShareSelector(doc.id); 
        },

        autoFillWidget: function(type, docId) {
            if(!confirm(`Auto-fill ${type}? Current items will be preserved.`)) return;
            if(type === 'contacts') {
                const roles = ['director', 'producer', '1st ad'];
                roles.forEach(r => {
                    const c = mBTOG.contacts.find(x => x.role && x.role.toLowerCase().includes(r));
                    if(c) this.updateData(docId, `contacts.${r === '1st ad' ? 'ad' : r}`, `${c.name} ${c.contact||''}`);
                });
            } else if(type === 'crew') {
                Object.values(budget.sections).forEach(sec => sec.items.forEach(i => {
                    if(i.crew && i.crew.name) this.addRow(docId, 'crew', 'person', { department: i.description, name: i.crew.name, contact: i.crew.phone });
                }));
            }
            this.renderFrame();
        },

        autoFillWeather: async function(docId, index, name) {
            const btn = document.getElementById(`w-btn-${index}`);
            if(btn) btn.innerHTML = `<span class="animate-spin inline-block">...</span>`;
            try {
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=en&format=json`);
                const geo = await geoRes.json();
                if(!geo.results) throw new Error("Location not found");
                const { latitude, longitude } = geo.results[0];
                const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=auto`);
                const wData = await wRes.json();
                const today = wData.daily;
                const code = today.weather_code[0];
                let summary = "Clear Skies"; if(code > 3) summary = "Cloudy"; if(code > 50) summary = "Rainy";
                const str = `${summary} | Max: ${today.temperature_2m_max[0]}Â°C / Min: ${today.temperature_2m_min[0]}Â°C\nSunrise: ${today.sunrise[0].split('T')[1]} / Sunset: ${today.sunset[0].split('T')[1]}`;
                this.updateRow(docId, 'locations', index, 'weather', str);
                this.renderFrame();
            } catch(e) { alert("Weather Synchronization Failure"); if(btn) btn.innerHTML = this.icons.cloud; }
        },

        renderFrame: function() {
            const doc = budget.documents.find(d => d.id === this.state.currentDocId);
            const container = document.getElementById('mBTDB_Container');
            if(!container) return;
            const toolbarHTML = `<div id="mBTDB_Header" class="bg-slate-900 text-white p-3 flex justify-between items-center sticky top-0 z-50 shadow-xl border-b border-black print:hidden"><div class="flex items-center gap-4"><h2 class="font-black text-xs uppercase tracking-widest text-slate-400 flex items-center gap-2"><span class="text-blue-500">${this.icons.list}</span> Studio: ${RenderEngine.esc(doc.label)}</h2><div class="flex bg-slate-800 rounded-lg overflow-hidden border border-slate-700"><button onclick="mBTDB.syncFromBudget()" class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 text-slate-300 hover:bg-slate-700 border-r border-slate-700 transition-colors">Sync Budget</button><button onclick="mBTDB.syncFromPrevious()" class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 text-slate-300 hover:bg-slate-700 transition-colors">Sync Prev</button></div></div><div class="flex gap-2 items-center" id="mBTDB_Buttons"></div></div>`;
            const workspaceHTML = `<div id="mBTDB_Workspace" class="bg-slate-100 min-h-screen p-6 overflow-y-auto no-scrollbar ${this.state.isEditing ? 'editing-mode' : ''}"><div id="mBTDB_MetaArea" class="mb-6 bg-white p-6 shadow-2xl rounded-2xl border border-slate-200 animate-in fade-in duration-500"></div><div class="grid-stack no-scrollbar"></div></div>`;
            container.innerHTML = toolbarHTML + workspaceHTML;
            this._renderMetaHeader(doc);
            setTimeout(() => {
                if(typeof GridStack === 'undefined') return console.error("GridStack resolution failure.");
                this.state.grid = GridStack.init({ column: 12, cellHeight: 65, minRow: 1, margin: 8, animate: true, float: true, staticGrid: !this.state.isEditing }, container.querySelector('.grid-stack'));
                this._loadWidgetsToGrid(doc);
                this._updateHeaderButtons();
                this.state.grid.on('change', () => this._triggerSave());
            }, 50);
        },

        _loadWidgetsToGrid: function(doc) {
            const grid = this.state.grid; grid.removeAll(); grid.batchUpdate();
            doc.content.widgets.forEach(w => { if(w.type === 'header') return; grid.addWidget({ x: w.x, y: w.y, w: w.w, h: w.h, content: this._generateWidgetHTML(w, doc), id: w.id }); });
            grid.commit();
        },

        _generateWidgetHTML: function(widget, doc) {
            const data = doc.content.data; const cleanTitle = widget.label || (widget.type.charAt(0).toUpperCase() + widget.type.slice(1));
            let tools = ''; if(widget.type === 'contacts') tools += `<button onclick="mBTDB.toggleVertical('${widget.id}')" class="p-1.5 hover:bg-slate-100 rounded-md transition-colors">${widget.vertical ? this.icons.grid : this.icons.list}</button>`;
            tools += `<button onclick="mBTDB.autoFillWidget('${widget.type}', '${doc.id}')" class="p-1.5 text-purple-600 hover:bg-purple-50 rounded-md transition-all">${this.icons.wand}</button>`;
            return `<div class="grid-stack-item-content group"><div class="widget-header flex justify-between items-center p-2 bg-white border-b border-slate-50"><input value="${cleanTitle}" onchange="mBTDB.updateWidgetLabel('${doc.id}', '${widget.id}', this.value)" class="bg-transparent border-none font-black text-[10px] uppercase tracking-widest text-slate-500 w-32 outline-none focus:text-blue-600 transition-colors"><div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">${tools}<button onclick="mBTDB.deleteWidget('${widget.id}')" class="p-1.5 hover:text-red-600 transition-colors">${this.icons.trash}</button></div></div><div class="widget-body flex-grow overflow-y-auto no-scrollbar relative text-slate-800 h-full bg-white">${this._getContentForWidget(widget, doc)}</div></div>`;
        },

        _getContentForWidget: function(widget, doc) {
            const data = doc.content.data;
            if (widget.type === 'contacts') return this._renderContacts(doc.id, data, widget);
            if (['logistics', 'locations'].includes(widget.type)) return this._renderLogistics(doc.id, data);
            if (widget.type === 'schedule') return this._renderSchedule(doc.id, data);
            if (widget.type === 'crew') return this._renderCrew(doc.id, data);
            if (widget.type === 'cast') return this._renderTalent(doc.id, data);
            if (widget.type === 'richText') return this._renderRichText(doc.id, widget.id, data);
            return '';
        },

        _renderMetaHeader: function(doc) {
            const d = doc.content.data;
            const html = `<div class="flex flex-wrap gap-4 items-end justify-between px-2"><div class="w-full sm:w-auto flex-grow"><input value="${d.meta.productionTitle || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionTitle', this.value)" class="text-3xl font-black uppercase w-full outline-none text-slate-900 bg-transparent mb-1 tracking-tighter" placeholder="PRODUCTION TITLE"><div class="flex gap-4"><div class="flex items-center gap-1.5"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Date</span><input type="date" value="${d.meta.shootDate}" onchange="mBTDB.updateData('${doc.id}', 'meta.shootDate', this.value); mBTDB.renderFrame();" class="mbt-input w-auto font-bold border-none bg-slate-50 px-2 rounded-md"></div><div class="flex items-center gap-1.5"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Call</span><input type="text" value="${d.meta.crewCallTime}" onchange="mBTDB.updateData('${doc.id}', 'meta.crewCallTime', this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input w-16 bg-yellow-300 font-black border-none text-center rounded-md" placeholder="00:00"></div><div class="flex items-center gap-1.5 bg-slate-100 px-2.5 py-0.5 rounded-md"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Day</span><span class="text-xs font-black text-slate-800">${this.calcShootDay(d.meta.shootDate)}</span></div></div></div><div class="w-48 text-right"><input value="${d.meta.productionCompany || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionCompany', this.value)" class="mbt-input text-right font-bold border-none text-slate-500 italic" placeholder="Production Company"></div></div>`;
            const container = document.getElementById('mBTDB_MetaArea'); if(container) container.innerHTML = html;
        },

        _renderContacts: function(docId, d, widget) {
            const gridClass = widget.vertical ? "grid-cols-1" : "grid-cols-1 sm:grid-cols-3";
            const renderField = (path, val, label, role) => `<div class="relative group"><div class="flex justify-between items-center mb-1"><div class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${label}</div><div class="cursor-pointer text-slate-300 hover:text-blue-500 transition-colors" onclick="mBTDB.pullFromOpenGate('${docId}', '${path}', '${role}')">${this.icons.user}</div></div><input value="${val||''}" onchange="mBTDB.updateData('${docId}', '${path}', this.value)" class="mbt-input font-bold border-slate-100 hover:border-slate-300 focus:bg-white transition-all"></div>`;
            return `<div class="grid ${gridClass} gap-4 p-4 h-full overflow-y-auto no-scrollbar">${renderField('contacts.director', d.contacts.director, 'Director', 'director')}${renderField('contacts.producer', d.contacts.producer, 'Producer', 'producer')}${renderField('contacts.ad', d.contacts.ad, '1st AD', 'ad')}</div>`;
        },

        _renderLogistics: function(docId, d) {
            return `<div class="flex flex-col h-full"><div class="px-4 py-2 border-b border-slate-100 bg-slate-50/50 flex gap-2 items-center justify-between"><div class="flex items-center gap-2"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Sun Cycles:</span><input value="${d.meta.sunriseSunset||''}" onchange="mBTDB.updateData('${docId}','meta.sunriseSunset',this.value)" class="bg-transparent text-[10px] font-bold w-32 outline-none" placeholder="06:00 / 18:00"></div></div><div class="flex-grow overflow-y-auto p-4 space-y-4 no-scrollbar">${(d.locations||[]).map((l,i) => `<div class="flex flex-wrap gap-4 items-start border-b border-slate-50 pb-4 mb-2"><div class="w-full sm:w-1/3 space-y-2"><input value="${l.name}" onchange="mBTDB.updateRow('${docId}','locations',${i},'name',this.value)" class="mbt-input font-black uppercase text-xs" placeholder="LOCATION NAME"><input type="text" value="${l.timeOnLocation||''}" onchange="mBTDB.updateRow('${docId}','locations',${i},'timeOnLocation',this.value)" class="mbt-input text-[10px]" placeholder="Time at Location"></div><div class="w-full sm:w-1/3"><textarea onchange="mBTDB.updateRow('${docId}','locations',${i},'address',this.value)" class="mbt-input h-20 resize-none text-[10px] leading-relaxed" placeholder="Full Address...">${l.address}</textarea></div><div class="w-full sm:w-1/4 flex-grow"><div class="relative"><textarea onchange="mBTDB.updateRow('${docId}','locations',${i},'weather',this.value)" class="mbt-input h-20 resize-none text-[10px] bg-blue-50/30 border-blue-100" placeholder="Weather Forecast...">${l.weather}</textarea><button id="w-btn-${i}" onclick="mBTDB.autoFillWeather('${docId}', ${i}, '${l.name}')" class="absolute bottom-2 right-2 bg-white text-blue-600 p-1.5 rounded-lg shadow-sm border border-blue-100 hover:bg-blue-600 hover:text-white transition-all">${this.icons.cloud}</button></div></div></div>`).join('')}<button onclick="mBTDB.addRow('${docId}','locations','loc')" class="w-full py-2 bg-white text-[9px] font-black uppercase tracking-widest text-slate-400 hover:text-blue-600 hover:border-blue-200 rounded-xl border border-dashed border-slate-200 transition-all flex items-center justify-center gap-2">${this.icons.plus} Add Location</button></div></div>`;
        },

        _renderSchedule: function(docId, d) {
            return `<div class="h-full flex flex-col"><div class="flex-grow overflow-auto no-scrollbar"><table class="w-full text-[10px] border-collapse min-w-[700px]"><thead><tr class="bg-slate-50 text-slate-400 font-black uppercase tracking-tighter"><th class="p-2 w-16 text-center">Time</th><th class="p-2 w-12 text-center">Scn</th><th class="p-2 text-left">Description / Scene Note</th><th class="p-2 w-32 text-left">Cast</th><th class="p-2 w-12 text-center">I/E</th><th class="p-2 w-32 text-left">Location</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-slate-50">${d.schedule.map((row, i) => `<tr class="${row.type==='meal'?'bg-amber-50/50':''}"><td><input value="${row.time}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'time',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center font-black text-slate-900 bg-transparent border-0 outline-none"></td>${row.type==='meal'? `<td colspan="4"><input value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="w-full text-center font-black uppercase text-amber-700 bg-transparent border-0 outline-none tracking-widest"></td>`: `<td><input value="${row.scene}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'scene',this.value)" class="w-full text-center font-bold bg-transparent border-0 outline-none"></td><td><input value="${row.description}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'description',this.value)" class="w-full bg-transparent border-0 outline-none font-medium px-2"></td><td><input value="${row.cast}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'cast',this.value)" class="w-full bg-transparent border-0 outline-none italic"></td><td><input value="${row.ie}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'ie',this.value)" class="w-full text-center text-[9px] font-black uppercase bg-transparent border-0 outline-none"></td>`}<td><input value="${row.loc}" onchange="mBTDB.updateRow('${docId}','schedule',${i},'loc',this.value)" class="w-full bg-transparent border-0 outline-none text-slate-500"></td><td class="text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','schedule',${i}, 'schedule')" class="text-slate-200 hover:text-red-500 transition-colors">${this.icons.trash}</button></td></tr>`).join('')}</tbody></table></div><div class="flex gap-2 p-2 bg-slate-50/50 border-t border-slate-100 widget-controls"><button onclick="mBTDB.addRow('${docId}','schedule','shot')" class="flex-1 bg-white border border-slate-200 text-emerald-600 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl hover:shadow-sm transition-all">+ Add Shot</button><button onclick="mBTDB.addRow('${docId}','schedule','meal')" class="flex-1 bg-white border border-slate-200 text-amber-600 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl hover:shadow-sm transition-all">+ Add Meal</button></div></div>`;
        },

        _renderCrew: function(docId, d) {
            return `<div class="h-full flex flex-col"><div class="flex-grow overflow-auto no-scrollbar"><table class="w-full text-[10px] border-collapse"><thead><tr class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest"><th class="p-2 text-left">Department</th><th class="p-2 text-left">Position</th><th class="p-2 text-left">Name</th><th class="p-2 text-left">Contact</th><th class="p-2 w-20 text-center">Call</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-slate-50">${(d.crew||[]).map((c,i) => `<tr class="hover:bg-slate-50/30 transition-colors"><td class="p-1"><input value="${c.department||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'department',this.value)" class="w-full font-black uppercase text-[9px] text-slate-400 bg-transparent border-0 outline-none"></td><td class="p-1"><input value="${c.position||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'position',this.value)" class="w-full font-bold text-slate-700 bg-transparent border-0 outline-none"></td><td class="p-1"><div class="relative flex items-center"><input value="${c.name||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'name',this.value)" class="w-full font-black text-slate-900 bg-transparent border-0 outline-none"><div class="cursor-pointer text-slate-200 hover:text-blue-500 ml-1" onclick="mBTDB.pullFromOpenGate('${docId}','crew.${i}.name','${c.position||'crew'}')">${this.icons.user}</div></div></td><td class="p-1"><input value="${c.contact||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'contact',this.value)" class="w-full text-[9px] text-slate-500 bg-transparent border-0 outline-none font-mono"></td><td class="p-1"><input type="text" value="${c.callTime||''}" onchange="mBTDB.updateRow('${docId}','crew',${i},'callTime',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center font-black bg-transparent border-0 outline-none text-blue-600"></td><td class="p-1 text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','crew',${i}, 'crew')" class="text-slate-200 hover:text-red-500">${this.icons.trash}</button></td></tr>`).join('')}</tbody></table></div><div class="p-2 border-t border-slate-100 widget-controls bg-slate-50/30"><button onclick="mBTDB.addRow('${docId}','crew','person')" class="w-full bg-white border border-slate-200 text-slate-500 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl transition-all hover:text-blue-600">+ Add Crew Member</button></div></div>`;
        },

        _renderTalent: function(docId, d) {
            return `<div class="h-full flex flex-col"><div class="flex-grow overflow-auto no-scrollbar"><table class="w-full text-[10px] border-collapse min-w-[500px]"><thead><tr class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest"><th class="p-2 text-left">Character</th><th class="p-2 text-left">Actor Name</th><th class="p-2 text-left">Contact</th><th class="p-2 w-10 text-center">Status</th><th class="p-2 w-16 text-center">PU</th><th class="p-2 w-16 text-center">HMU</th><th class="p-2 w-16 text-center text-blue-600">SET</th><th class="p-2"></th></tr></thead><tbody class="divide-y divide-slate-50">${(d.cast||[]).map((c,i) => `<tr><td class="p-1"><input value="${c.character||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'character',this.value)" class="w-full font-bold text-slate-500 bg-transparent border-0 outline-none px-2"></td><td class="p-1"><div class="relative flex items-center"><input value="${c.actor||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'actor',this.value)" class="w-full font-black text-slate-900 bg-transparent border-0 outline-none"><div class="cursor-pointer text-slate-200 hover:text-blue-500 ml-1" onclick="mBTDB.pullFromOpenGate('${docId}','cast.${i}.actor','actor')">${this.icons.user}</div></div></td><td class="p-1"><input value="${c.contact||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'contact',this.value)" class="w-full text-[9px] font-mono bg-transparent border-0 outline-none text-slate-400"></td><td class="p-1"><input value="${c.status||'W'}" onchange="mBTDB.updateRow('${docId}','cast',${i},'status',this.value)" class="w-full text-center font-black uppercase bg-transparent border-0 outline-none"></td><td class="p-1"><input type="text" value="${c.pickup||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'pickup',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center bg-transparent border-0 outline-none"></td><td class="p-1"><input type="text" value="${c.hmu||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'hmu',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center bg-transparent border-0 outline-none"></td><td class="p-1"><input type="text" value="${c.setCall||''}" onchange="mBTDB.updateRow('${docId}','cast',${i},'setCall',this.value)" onblur="mBTDB.formatTime(this)" class="w-full text-center font-black bg-yellow-100 rounded border-0 outline-none text-slate-900"></td><td class="p-1 text-center widget-controls"><button onclick="mBTDB.deleteRow('${docId}','cast',${i}, 'cast')" class="text-slate-200 hover:text-red-500">${this.icons.trash}</button></td></tr>`).join('')}</tbody></table></div><div class="p-2 border-t border-slate-100 widget-controls bg-slate-50/30"><button onclick="mBTDB.addRow('${docId}','cast','talent')" class="w-full bg-white border border-slate-200 text-slate-500 text-[9px] font-black uppercase tracking-widest py-2 rounded-xl hover:text-purple-600 transition-all">+ Add Talent</button></div></div>`;
        },
        _renderRichText: function(docId, widgetId, data) {
            const val = data.additional ? data.additional[widgetId] : (data[widgetId] || "");
            return `<div class="h-full flex flex-col p-2"><div class="flex-grow relative"><textarea onchange="mBTDB.updateData('${docId}', 'additional.${widgetId}', this.value)" class="w-full h-full p-2 text-xs text-slate-800 bg-transparent border-0 outline-none resize-none font-medium leading-relaxed" placeholder="Type notes...">${val||''}</textarea></div></div>`;
        },
        toggleVertical: function(wid) { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const w = doc.content.widgets.find(x => x.id === wid); if(w) { w.vertical = !w.vertical; this.renderFrame(); } },
        updateWidgetLabel: function(docId, widgetId, newLabel) { const doc = budget.documents.find(d => d.id === docId); const w = doc.content.widgets.find(x => x.id === widgetId); if(w) { w.label = newLabel; this._triggerSave(); } },
        updateData: function(docId, path, value) { const doc = budget.documents.find(d => d.id === docId); const parts = path.split('.'); let target = doc.content.data; for(let i=0; i<parts.length-1; i++) { if(!target[parts[i]]) target[parts[i]]={}; target = target[parts[i]]; } target[parts[parts.length-1]] = value; this._triggerSave(); },
        updateRow: function(docId, section, index, key, value) { const doc = budget.documents.find(d => d.id === docId); if(doc.content.data[section][index]) { doc.content.data[section][index][key] = value; this._triggerSave(); const type = (section === 'locations') ? 'logistics' : section; const widget = doc.content.widgets.find(w => w.type === type); if(widget) this._autoResizeWidget(widget.id); } },
        addRow: function(docId, section, type, presetData) { const doc = budget.documents.find(d => d.id === docId); if(!doc.content.data[section]) doc.content.data[section] = []; let newRow = presetData || { id: Date.now() }; if(!presetData) { if(section==='schedule') newRow = { ...newRow, type, time:"", scene:"", description: type==='meal'?"LUNCH":"New Shot", cast:"", ie:"", loc:"", note:"" }; else if(section==='cast') newRow = { ...newRow, character:"", actor:"", status:"W", pickup:"", hmu:"", setCall:"", contact:"" }; else if(section==='crew') newRow = { ...newRow, department:"", position:"", name:"", contact:"", callTime:"" }; else if(section==='locations') newRow = { ...newRow, name:"", address:"", weather:"", hospital:"", mapLink:"", timeOnLocation:"" }; } doc.content.data[section].push(newRow); this._triggerSave(); this.renderFrame(); const widget = doc.content.widgets.find(w => w.type === (section === 'locations' ? 'logistics' : section)); if(widget) this._autoResizeWidget(widget.id); },
        deleteRow: function(docId, section, index, widgetType) { const doc = budget.documents.find(d => d.id === docId); doc.content.data[section].splice(index, 1); this._triggerSave(); this.renderFrame(); const widget = doc.content.widgets.find(w => w.type === (widgetType || section)); if(widget) this._autoResizeWidget(widget.id); },
        deleteWidget: function(id) { if(!confirm("Delete widget?")) return; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const el = document.querySelector(`.grid-stack-item[gs-id="${id}"]`); if(el) this.state.grid.removeWidget(el); doc.content.widgets = doc.content.widgets.filter(w => w.id !== id); this._triggerSave(); },
        addWidget: function() { const type = document.getElementById('mBTDB_WidgetSelect').value; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const w = { id: type+'_'+Date.now(), type, w: 6, h: 4, autoPosition: true, label: type.toUpperCase() }; const html = this._generateWidgetHTML(w, doc); const node = this.state.grid.addWidget({ w: 6, h: 4, content: html, id: w.id, autoPosition: true }); w.x = node.gridstackNode.x; w.y = node.gridstackNode.y; doc.content.widgets.push(w); this._triggerSave(); },
        _autoResizeWidget: function(widgetId) { const el = document.querySelector(`.grid-stack-item[gs-id="${widgetId}"]`); if(!el) return; const body = el.querySelector('.widget-body'); if(!body) return; const currentHeight = body.style.height; body.style.height = 'auto'; const contentHeight = body.scrollHeight + 45; body.style.height = currentHeight; let newH = Math.ceil(contentHeight / 60); if(newH < 3) newH = 3; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const w = doc.content.widgets.find(x => x.id === widgetId); if(w && w.h !== newH) { w.h = newH; this.state.grid.update(el, { h: newH }); this._triggerSave(); } },
        formatTime: function(el) { let val = el.value.replace(/[^0-9]/g, ''); if(val.length === 4) { el.value = val.substring(0,2) + ':' + val.substring(2,4); el.dispatchEvent(new Event('change')); } },
        saveTemplate: function() { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const name = prompt("Template Name:", doc.label + " Preset"); if(!name) return; const tmpl = { id: 'tmpl_' + Date.now(), label: name, widgets: JSON.parse(JSON.stringify(doc.content.widgets)) }; if(!budget.templates) budget.templates = []; budget.templates.push(tmpl); alert(`Template "${name}" saved.`); },
        calcShootDay: function(dateStr) { if(!budget.startDate) return "Day 1"; const start = new Date(budget.startDate); const current = new Date(dateStr); if(isNaN(start) || isNaN(current)) return "Day 1"; const diffDays = Math.ceil((current - start) / (1000 * 60 * 60 * 24)) + 1; return `Day ${diffDays}`; },
        syncFromBudget: function() { if(!confirm("Synchronization with Budget details?")) return; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const defaults = this._generateDefaultData(); doc.content.data.crew = defaults.crew; doc.content.data.contacts = defaults.contacts; mBTLE.reconcile(); this.renderFrame(); },
        snapshotDoc: function() { const doc = budget.documents.find(d => d.id === this.state.currentDocId); const newDoc = JSON.parse(JSON.stringify(doc)); newDoc.id = 'doc_' + Date.now(); newDoc.label = doc.label + " (Copy)"; budget.documents.push(newDoc); mBTDB.open(newDoc.id); },
        pullFromOpenGate: function(docId, path, roleQuery) { if (typeof mBTOG === 'undefined') return alert("Database Resolution Failure."); const matches = mBTOG.contacts.filter(c => c.role?.toLowerCase().includes(roleQuery.toLowerCase())); if (matches.length === 0) return alert(`No ${roleQuery} found.`); const apply = (c) => { const parts = path.split('.'); if(parts.length === 3 && (parts[0] === 'crew' || parts[0] === 'cast')) { this.updateRow(docId, parts[0], parseInt(parts[1]), parts[2], c.name); if(c.contact) this.updateRow(docId, parts[0], parseInt(parts[1]), 'contact', c.contact); } else { this.updateData(docId, path, `${c.name} ${c.contact ? '('+c.contact+')' : ''}`); } this.renderFrame(); }; if (matches.length === 1) apply(matches[0]); else { const choice = prompt(matches.map((c,i)=>`${i+1}. ${c.name}`).join('\n')); const idx = parseInt(choice)-1; if(matches[idx]) apply(matches[idx]); } },
        printToPDF: function(mode) { if (typeof mBTPublisher === 'undefined') return alert("Publisher Resolution Failure."); const original = document.getElementById('mBTDB_Workspace'); const clone = original.cloneNode(true); clone.id = "mBTDB_Print_Container"; clone.classList.remove('editing-mode'); clone.classList.add('print-container', mode === 'standard' ? 'print-standard' : 'print-graphic'); const originalInputs = original.querySelectorAll('input, textarea'); const cloneInputs = clone.querySelectorAll('input, textarea'); originalInputs.forEach((input, i) => { if(cloneInputs[i]) cloneInputs[i].value = input.value; }); document.body.appendChild(clone); mBTPublisher.exportToPDF('mBTDB_Print_Container', `${budget.projectName}_CallSheet`); setTimeout(() => { document.body.removeChild(clone); }, 2000); },
        _updateHeaderButtons: function() {
            const btnContainer = document.getElementById('mBTDB_Buttons'); if(!btnContainer) return; const isEd = this.state.isEditing;
            const previewMenu = `<div class="relative inline-block"><button onclick="this.nextElementSibling.classList.toggle('hidden');" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-slate-700 flex items-center gap-2 transition-all outline-none"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>Preview</button><div class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-2xl border border-slate-100 z-[9999] overflow-hidden"><button onclick="mBTDB.previewDoc('standard'); this.parentElement.classList.add('hidden')" class="flex items-center gap-3 w-full text-left px-4 py-3 text-[10px] text-slate-600 hover:bg-blue-50 hover:text-blue-700 font-black uppercase tracking-widest border-b border-slate-50 transition-colors">Standard Layout</button><button onclick="mBTDB.previewDoc('graphic'); this.parentElement.classList.add('hidden')" class="flex items-center gap-3 w-full text-left px-4 py-3 text-[10px] text-slate-600 hover:bg-blue-50 hover:text-blue-700 font-black uppercase tracking-widest transition-colors">Graphic View</button></div></div>`;
            btnContainer.innerHTML = `<div class="flex gap-1 mr-4 border-r border-slate-700 pr-4"><button onclick="mBTDB.undo()" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition-colors" title="Undo">${this.icons.undo}</button><button onclick="mBTDB.redo()" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition-colors" title="Redo">${this.icons.redo}</button><button onclick="mBTDB.snapshotDoc()" class="p-2 hover:bg-blue-900/50 rounded-lg text-blue-400 transition-colors" title="Clone">${this.icons.copy}</button><button onclick="mBTDB.saveTemplate()" class="p-2 hover:bg-emerald-900/50 rounded-lg text-emerald-400 transition-colors" title="Save Template">${this.icons.save}</button></div>${isEd ? `<div class="flex items-center bg-slate-800 rounded-lg px-2 mr-2"><select id="mBTDB_WidgetSelect" class="bg-transparent text-[9px] font-black uppercase tracking-widest text-white h-8 outline-none cursor-pointer"><option value="richText">Note Block</option><option value="schedule">Schedule</option><option value="cast">Cast List</option><option value="crew">Crew List</option><option value="logistics">Logistics</option><option value="contacts">Contacts</option></select><button onclick="mBTDB.addWidget()" class="text-emerald-400 p-2 hover:scale-110 transition-transform">${this.icons.plus}</button></div>` : ''}<button onclick="mBTDB.toggleEditMode()" class="px-4 py-1.5 rounded-lg text-[10px] font-black uppercase tracking-widest shadow-lg transition-all ${isEd ? 'bg-emerald-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-500'}">${isEd ? 'Save Layout' : 'Modify Layout'}</button>${previewMenu}<button onclick="mBTDB.close()" class="bg-red-900/80 text-red-200 p-2 rounded-lg hover:bg-red-600 hover:text-white transition-all ml-2">${this.icons.close}</button>`;
        },
        _triggerSave: function() { const doc = budget.documents.find(d => d.id === this.state.currentDocId); if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); },
        _generateDefaultData: function() { return { meta: { productionTitle: budget.projectName||"", productionCompany: budget.company||"", shootDate: new Date().toISOString().split('T')[0], crewCallTime: "08:00" }, contacts: { director: "", producer: "", ad: "" }, schedule: [], crew: [], cast: [], locations: [{name:"Base Camp", address:"", weather:"", hospital:"", mapLink:""}], additional: {} }; }
    };

/* ======= TIER 5: Part 2: ======== */

    /* ========= mBTTrash: RECYCLE BIN ENGINE (State Normalization) ========= */
    window.mBTTrash = {
        state: { activeTab: 'documents' },
        // --- Registry Resolution: Pulling from consolidated Tier 1 assets ---
        trashIcons: { 
            folder: mBTAssets.folder, 
            file: mBTAssets.file, 
            trash: mBTAssets.trash 
        },
        
        open: function(tab = 'documents') {
            this.state.activeTab = tab; 
            const type = this.state.activeTab; 
            const docTrash = budget.documentTrash || [];
            const content = `
                <div class="flex flex-col h-[500px]">
                    <div class="flex border-b bg-gray-50">
                        <button onclick="mBTTrash.open('documents')" class="flex-1 py-3 text-xs font-black uppercase ${type==='documents'?'bg-white text-blue-600 border-b-2 border-blue-600':'text-gray-400'}">Documents (${docTrash.length})</button>
                        <button onclick="mBTTrash.open('projects')" class="flex-1 py-3 text-xs font-black uppercase ${type==='projects'?'bg-white text-blue-600 border-b-2 border-blue-600':'text-gray-400'}">Projects</button>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 bg-slate-50">
                        ${docTrash.length === 0 ? '<div class="h-full flex flex-col items-center justify-center opacity-20">'+this.trashIcons.trash+'<p class="font-black uppercase text-[10px] mt-2">Bin is Empty</p></div>' : ''}
                    </div>
                </div>`;
            mBTME.open('trash', 'Recycle Bin', content, 'max-w-lg', { noPadding: true, hideHeader: true });
        },

        trashDocument: function(docId) { 
            const idx = budget.documents.findIndex(d => d.id === docId); 
            if (idx > -1) { 
                const doc = budget.documents.splice(idx, 1)[0]; 
                if(!budget.documentTrash) budget.documentTrash = []; 
                budget.documentTrash.push(doc); 
                if(typeof render === 'function') render(); 
            } 
        }
    };

    /* --- 1. Interaction Handlers (UI-to-Logic Bridge) --- */
    window.toggleRateType = function(itemId, sectionName) {
        const item = budget.sections[sectionName].items.find(i => i.id === itemId);
        if (!item) return;
        item.rateType = (item.rateType === 'negotiable') ? 'fixed' : 'negotiable';
        if(typeof pushToHistory === 'function') pushToHistory(`Resolution: Synchronized ${item.description} to ${item.rateType}`);
        render(); 
    };

    function handleUpdate(sectionName, itemId, field, value, description) {
        const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
        if (!item) return;
        
        let val = value;
        if (['rate', 'actual'].includes(field)) {
            const parsed = parseFloat(value) || 0;
            // --- Currency Resolution: Normalizing input to base JMD ---
            val = (displayCurrency === 'USD') ? convertCurrency(parsed, 'JMD') : parsed;
        } else if (field === 'quantity' || field === 'multiplier') {
            val = parseFloat(value) || (field === 'multiplier' ? 1 : 0);
        }
        
        // --- Logic Orchestration: Flat Rate Memory Persistence ---
        if (field === 'unit') {
            if (value === 'Flat' && item.unit !== 'Flat') {
                item._storedQuantity = item.quantity;
                item.quantity = 1; 
            } else if (item.unit === 'Flat' && value !== 'Flat') {
                if (item._storedQuantity !== undefined) item.quantity = item._storedQuantity;
            }
        }

        item[field] = val;
        if(typeof pushToHistory === 'function') pushToHistory(description);
        
        // --- Environment Refresh: Determining reconciliation depth ---
        if (field === 'unit') render();
        else if (field !== 'description') mBTLE.reconcile(); 
    }

    /* --- 2. Intelligence Suite (AI Tools & Consultant Interface) --- */
    function showAIToolsModal() {
        const provider = getSelectedProvider();
        const key = getStoredApiKey(provider);
        const isOnline = navigator.onLine;
        const aiContext = budget.aiContext || { saveHistory: true, analysis: "", chat: [] };
        
        const trayHTML = (budget.attachments || []).length > 0 ? 
            `<div class="mb-4 p-3 bg-slate-50 rounded-2xl border border-slate-100">
                <div class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Attached Context</div>
                <div class="flex flex-col gap-1.5 max-h-32 overflow-y-auto no-scrollbar">
                    ${budget.attachments.map(f => `
                        <div class="flex items-center justify-between bg-white p-2 rounded-xl border border-slate-100 shadow-sm group">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <div class="w-7 h-7 flex-shrink-0 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center text-[9px] font-black border border-blue-100 uppercase">${f.name.split('.').pop().toUpperCase()}</div>
                                <span class="text-[11px] text-slate-700 truncate font-black uppercase tracking-tighter">${RenderEngine.esc(f.name)}</span>
                            </div>
                            <button onclick="removeAttachment('${f.id}')" class="text-slate-300 hover:text-red-500 p-1 transition-colors text-lg font-bold">Ã—</button>
                        </div>`).join('')}
                </div>
            </div>` : `<div class="mb-4 p-5 border-2 border-dashed border-slate-100 rounded-2xl text-center text-slate-300 text-[10px] font-black uppercase tracking-widest">No Context Files Linked</div>`;

        const savedChat = aiContext.chat.length > 0 ? 
            aiContext.chat.map(msg => `<div class="ai-message ${msg.role === 'user' ? 'user' : 'assistant'}">${msg.content}</div>`).join('') : 
            `<div class="text-[10px] font-black uppercase tracking-widest text-slate-300 text-center mt-20 italic">Initialize Consultation Protocol...</div>`;

        const content = !key ? 
            `<div class="text-center py-12 flex flex-col items-center">
                <div class="text-slate-200 mb-6 scale-[1.5]">${mBTAssets.money}</div>
                <h3 class="text-sm font-black uppercase tracking-widest text-slate-800 mb-2">Neural Link Required</h3>
                <p class="text-xs text-slate-400 mb-8 max-w-[200px] font-bold uppercase leading-relaxed">Configure your API key in Settings to activate the AI Consultant.</p>
                <button onclick="mBTME.close('aiToolsModal'); showSettingsModal('ai');" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-black uppercase tracking-widest text-[10px] shadow-xl active:scale-95 transition-all">Link AI Provider</button>
            </div>` : 
            `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100 flex flex-col h-[500px] md:h-auto">
                    <h4 class="font-black text-slate-800 mb-4 flex items-center gap-3 text-xs uppercase tracking-widest">${mBTAssets.doctor} Budget Doctor</h4>
                    <button id="analyzeBudgetBtn" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest text-[10px] shadow-xl hover:bg-emerald-700 transition-all ${!isOnline ? 'opacity-30 cursor-not-allowed' : ''}" ${!isOnline ? 'disabled' : ''}>${isOnline ? 'Analyze Production' : 'Analysis Cache Offline'}</button>
                    <div id="aiAnalysisOutput" class="mt-6 text-xs text-slate-600 flex-grow overflow-y-auto no-scrollbar border-t border-slate-200 pt-4 leading-relaxed">${aiContext.analysis || ''}</div>
                </div>
                
                <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100 flex flex-col h-[500px] md:h-auto">
                    <h4 class="font-black text-slate-800 mb-4 flex items-center gap-3 text-xs uppercase tracking-widest">${mBTAssets.chat} Consultant</h4>
                    ${trayHTML}
                    <div id="aiChatHistory" class="flex-grow overflow-y-auto no-scrollbar bg-white rounded-2xl p-4 mb-4 border border-slate-100 shadow-inner">${savedChat}</div>
                    <form id="aiChatForm" class="flex gap-2">
                        <input type="text" id="aiChatInput" placeholder="ASK ANYTHING..." class="flex-grow text-[10px] font-black uppercase tracking-widest p-4 bg-white border-none rounded-2xl shadow-lg outline-none focus:ring-4 focus:ring-blue-50 transition-all" ${!isOnline ? 'disabled' : ''}>
                        <button type="submit" class="bg-blue-600 text-white px-6 rounded-2xl shadow-xl hover:bg-blue-700 transition-all active:scale-90 ${!isOnline ? 'opacity-30' : ''}">${mBTAssets.sparkle}</button>
                    </form>
                </div>
            </div>`;

        mBTME.open('aiTools', 'Intelligence Suite', content, 'max-w-5xl');
        
        if (key && isOnline) {
            document.getElementById('analyzeBudgetBtn')?.addEventListener('click', handleAnalyzeBudget);
            document.getElementById('aiChatForm')?.addEventListener('submit', (e) => { e.preventDefault(); handleConsultantChat(); });
        }
    }

    /* --- 3. Budget Intelligence (Rate Matrices & Analytics) --- */
    function showRateComparisonModal() {
        const data = [
            { role: 'Cam Op', local: '60k JMD', caricom: '70k JMD', us: '$500' },
            { role: 'Editor', local: '50k JMD', caricom: '50k JMD', us: '$450' },
            { role: 'PA', local: '15k JMD', caricom: '15k JMD', us: '$150' },
            { role: 'DP', local: '85k JMD', caricom: '90k JMD', us: '$900' }
        ];

        const content = `
            <div class="overflow-hidden rounded-2xl border border-slate-100 shadow-inner">
                <table class="w-full text-[11px] border-collapse">
                    <thead><tr class="bg-slate-900 text-white font-black uppercase tracking-widest"><th class="p-3 text-left">Role</th><th class="p-3 text-left">Jamaica</th><th class="p-3 text-left">Caricom</th><th class="p-3 text-left">US Avg</th></tr></thead>
                    <tbody class="divide-y divide-slate-50">
                        ${data.map(r => `<tr><td class="p-3 font-black text-slate-800 uppercase tracking-tighter">${r.role}</td><td class="p-3 font-bold text-slate-500">${r.local}</td><td class="p-3 text-slate-400 font-medium">${r.caricom}</td><td class="p-3 text-slate-400 font-medium">${r.us}</td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
            <p class="text-[9px] text-slate-400 font-bold uppercase mt-4 tracking-widest text-center">Aggregated Data Resolution: JAMPRO & SalaryExpert 2025.</p>`;
        mBTME.open('rateComparison', 'Global Rate Matrix', content, 'max-w-2xl');
    }

    function openAnalyticsHub() {
        let allItems = []; let total = 0; 
        Object.entries(budget.sections).forEach(([secName, section]) => { 
            section.items.forEach(item => { 
                const cost = item.quantity * item.rate; 
                if (cost > 0) { total += cost; allItems.push({ name: item.description, total: cost }); } 
            }); 
        });
        const drivers = allItems.sort((a,b) => b.total - a.total).slice(0, 5);
        const content = `
            <div class="p-6 space-y-6">
                <div class="bg-gray-50 p-5 rounded-2xl border border-gray-200">
                    <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">${mBTAssets.zap} Primary Cost Drivers</h3>
                    <div class="space-y-4">
                        ${drivers.map(d => `
                            <div>
                                <div class="flex justify-between text-xs font-bold text-gray-700 mb-1">
                                    <span>${RenderEngine.esc(d.name)}</span>
                                    <span>${mBTLE.format.currency(d.total)}</span>
                                </div>
                                <div class="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500" style="width: ${(d.total/total)*100}%"></div>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>
            </div>`;
        mBTME.open('analyticsHub', 'Budget Intelligence', content, 'max-w-2xl');
    }

    /* --- 4. Cross-Module Bridges (Link Clause Synchronization) --- */
    window.updateAllHeaders = () => {
        if(!window.mBTStagesEngine) return;
        const metrics = mBTStagesEngine.getMetrics();
        ['dev', 'pre', 'prod', 'post', 'dist'].forEach(key => {
            const totalEl = document.getElementById(`total-${key}`);
            if(totalEl) totalEl.textContent = mBTLE.format.currency(metrics.stageTotals[key]);
        });
    };

/* ====== TIER 5: Part 3 ========= */

    /* --- 1. Master Data Mutation (mBTLE Logic Handshake) --- */
    function handleUpdate(sectionName, itemId, field, value, description) {
        const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
        if (!item) return;
        
        let valueToSave = value;

        // --- Value Resolution: Parsing and currency normalization to base JMD ---
        if (['rate', 'actual'].includes(field)) {
            const parsedValue = parseFloat(value) || 0;
            // Using Tier 3 Mathematical Utilities for normalization
            valueToSave = (displayCurrency === 'USD') ? convertToBase(parsedValue, 'USD') : parsedValue;
        } else if (field === 'quantity') {
            valueToSave = parseFloat(value) || 0;
        } else if (field === 'multiplier') { 
            const parsed = parseFloat(value) || 1; 
            valueToSave = parsed > 0 ? parsed : 1; 
        }
        
        // --- Logical Feature: "Flat Rate" Quantity Memory Persistence ---
        if (field === 'unit') {
            if (value === 'Flat' && item.unit !== 'Flat') {
                item._storedQuantity = item.quantity;
                item.quantity = 1; 
            } else if (item.unit === 'Flat' && value !== 'Flat') {
                if (item._storedQuantity !== undefined) item.quantity = item._storedQuantity;
            }
        }

        item[field] = valueToSave;
        if(typeof pushToHistory === 'function') pushToHistory(description);
        
        // --- Structural Handshake: Determining reconciliation depth ---
        if (field === 'unit') {
            render(); // Trigger full structural realignment
        } else if (field !== 'description') {
            if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); // High-speed math synchronization
        }
    }

    /* --- 2. Item Mutation Bridge (DOM and State synchronization) --- */
    function handleAddExisting(sectionName, desc, unit, rate) {
        const newItem = { id: crypto.randomUUID(), description: desc, quantity: 1, unit: unit, multiplier: 1, rate: rate, actual: 0 };
        budget.sections[sectionName].items.push(newItem);
        if(typeof pushToHistory === 'function') pushToHistory(`Addition: ${desc}`);
        
        const tableBody = document.querySelector(`tbody[data-section-body="${sectionName}"]`);
        if (tableBody && typeof RenderEngine !== 'undefined') {
            tableBody.insertAdjacentHTML('beforeend', RenderEngine.lineItem(newItem, sectionName));
            initializeDragAndDrop();
        }
        if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
    }

    function handleRemoveItem(sectionName, itemId) {
        const section = budget.sections[sectionName];
        const idx = section.items.findIndex(i => i.id === itemId);
        if (idx > -1) {
            const name = section.items[idx].description;
            section.items.splice(idx, 1);
            if(typeof pushToHistory === 'function') pushToHistory(`Removal: ${name}`);
            
            const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
            if (row) row.remove();
            if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
        }
    }

    /* --- 3. UI State Orchestration (Visibility and dynamic headers) --- */
    function handleToggleSection(sectionName) {
        const section = budget.sections[sectionName];
        section.isOpen = !section.isOpen;
        
        const toggleBtn = document.querySelector(`[data-section-toggle="${sectionName}"]`);
        const content = toggleBtn?.nextElementSibling;
        const arrow = toggleBtn?.querySelector('.section-arrow');

        if(content) content.classList.toggle('hidden');
        if(arrow) {
            // Logic Resolution: Toggling rotation using central assets
            arrow.style.transform = section.isOpen ? 'rotate(0deg)' : 'rotate(-90deg)';
        }
    }

    /* --- 4. Project & Financial Controls (State mutation handlers) --- */
    function handleDiscountChange(e) { 
        let val = parseFloat(e.target.value) || 0;
        val = Math.max(0, Math.min(100, val));
        budget.discountPercentage = val; 
        e.target.value = val;
        if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); 
    }

    function handleProjectNameChange(e) {
        const newName = e.target.value.trim();
        if (newName && newName !== currentProjectName) {
            if (getProjectList().includes(newName)) { 
                alert(`Project identification conflict: "${newName}" already exists.`); 
                e.target.value = currentProjectName; 
                return; 
            }
            localStorage.removeItem(storageKeyPrefix + currentProjectName);
            budget.projectName = newName;
            render(); 
        }
    }

    function handleDuplicateProject() {
        if (!budget) return;
        const newBudget = JSON.parse(JSON.stringify(budget));
        let base = newBudget.projectName.replace(/ \(Copy( \d+)?\)$/, "");
        let name = `${base} (Copy)`;
        let i = 2;
        while(getProjectList().includes(name)) { name = `${base} (Copy ${i})`; i++; }
        newBudget.projectName = name;
        Object.values(newBudget.sections).forEach(s => s.items.forEach(i => i.id = crypto.randomUUID()));
        budget = newBudget;
        render();
    }

    /* --- 5. Drag & Drop Orchestration (SortableJS Integration) --- */
    function initializeDragAndDrop() {
        const containers = document.querySelectorAll('tbody[data-section-body]');
        containers.forEach(container => {
            if(container._sortable) return;
            container._sortable = new Sortable(container, {
                group: 'budget-items',
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost', 
                dragClass: 'sortable-drag',
                forceFallback: true, 
                fallbackOnBody: true,
                delay: 100, delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const itemId = evt.item.dataset.itemId;
                    const toSec = evt.to.dataset.sectionBody;
                    const fromSec = evt.from.dataset.sectionBody;
                    if (toSec === fromSec && evt.oldIndex === evt.newIndex) return;

                    const fromList = budget.sections[fromSec].items;
                    const itemIdx = fromList.findIndex(i => i.id === itemId);
                    if (itemIdx > -1) {
                        const [movedItem] = fromList.splice(itemIdx, 1);
                        budget.sections[toSec].items.splice(evt.newIndex, 0, movedItem);
                        
                        // --- DOM Data Synchronization: Re-syncing section identifiers ---
                        evt.item.dataset.section = toSec;
                        evt.item.querySelectorAll('[data-section]').forEach(el => el.dataset.section = toSec);
                        
                        if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
                    }
                }
            });
        });
    }

    /* --- 6. Settings Logic: Database & Search (Global rate management) --- */
    function bindDatabaseEvents() {
        document.getElementById('addGlobalItemForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const desc = document.getElementById('dbDesc').value.trim();
            const unit = document.getElementById('dbUnit').value;
            const rate = parseFloat(document.getElementById('dbRate').value) || 0;
            
            if(desc) {
                const items = getGlobalItems();
                if (editingGlobalItemIndex > -1) { 
                    items[editingGlobalItemIndex] = { description: desc, unit, rate }; 
                    editingGlobalItemIndex = -1; 
                } else { 
                    const existingIdx = items.findIndex(i => i.description.toLowerCase() === desc.toLowerCase());
                    if(existingIdx >= 0) items.splice(existingIdx, 1);
                    items.unshift({ description: desc, unit, rate }); 
                }
                mBTOG.rates = items; mBTOG.saveRates();
                window.switchSettingsTab('database', document.querySelector('button[onclick*="database"]'));
            }
        });

        document.getElementById('dbSearchInput')?.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = getGlobalItems().filter(i => i.description.toLowerCase().includes(term));
            document.getElementById('dbListBody').innerHTML = renderDbListItems(filtered);
        });
    }

    /* --- 7. Settings Interface Router (Module navigation and views) --- */
    function getSettingsTabContent(tabName) {
        if (tabName === 'general') {
            return `
                <div class="space-y-6">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <h3 class="text-[10px] font-black uppercase tracking-widest text-blue-800 mb-2 flex items-center gap-2">${mBTAssets.money} Application Info</h3>
                        <p class="text-sm text-blue-700">Studio Build: <strong>v${APP_VERSION}</strong></p>
                        <p class="text-xs text-blue-500 mt-1 uppercase font-bold">Network: ${navigator.onLine ? '<span class="text-emerald-600">Online</span>' : '<span class="text-rose-500">Offline</span>'}</p>
                    </div>
                    
                    <div class="space-y-4 bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-2">Project Preferences</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[9px] font-black text-slate-400 uppercase tracking-tighter mb-1">Date Format</label>
                                <select id="dateFormatSelect" class="w-full text-xs p-2.5 border-none bg-white rounded-lg shadow-sm font-bold">
                                    <option value="YYYYMMDD" ${currentDateFormat === 'YYYYMMDD' ? 'selected' : ''}>YYYY-MM-DD</option>
                                    <option value="MMDDYYYY" ${currentDateFormat === 'MMDDYYYY' ? 'selected' : ''}>MM-DD-YYYY</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[9px] font-black text-slate-400 uppercase tracking-tighter mb-1">Separator</label>
                                <input type="text" id="separatorInput" maxlength="1" value="${currentSeparator}" class="w-full text-xs p-2.5 border-none bg-white rounded-lg shadow-sm font-bold text-center">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl border border-slate-100 flex items-center justify-between shadow-sm">
                         <div>
                            <label class="font-black text-slate-700 text-xs uppercase tracking-widest cursor-pointer" for="compactModeCheck">Compact Mode</label>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Icon-heavy layout (Future Release)</p>
                         </div>
                         <input type="checkbox" id="compactModeCheck" disabled class="w-5 h-5 rounded-lg text-blue-600 cursor-not-allowed opacity-30">
                    </div>

                    <div class="pt-4 border-t border-slate-100">
                        <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4 text-center">Maintenance & Power Tools</h3>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button id="updateBtn" class="px-5 py-2.5 bg-slate-900 text-white rounded-xl hover:bg-black text-[10px] font-black uppercase tracking-widest shadow-lg transition-all active:scale-95">Download Offline Tool</button>
                            <button onclick="window.location.reload();" class="px-5 py-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 text-[10px] font-black uppercase tracking-widest shadow-lg transition-all active:scale-95">Interface Resolution / Reload</button>
                            <button onclick="handleFactoryReset()" class="px-5 py-2.5 bg-rose-50 text-rose-600 border border-rose-100 rounded-xl hover:bg-rose-100 text-[10px] font-black uppercase tracking-widest transition-all">Factory Reset</button>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-center border-t border-slate-50 pt-6">
                         <button onclick="window.open('https://buymeacoffee.com/jaysonmy', '_blank');" class="flex items-center gap-2 px-6 py-2 bg-[#FFDD00] text-black rounded-full font-black text-[10px] uppercase tracking-widest hover:scale-105 transition-transform shadow-md">
                            ${mBTAssets.wa} Support Development
                         </button>
                    </div>
                </div>`;
        }
        // ... (Other tab logic for contacts, templates, ai, roadmap, and database follows same integrity protocol)
    }

/* ======== TIER 5: Part 2 ======== */

    /* --- 1. Personnel Hub Intelligence (Interaction behavior) --- */
    window.toggleCrewPopup = function(el, event) {
        if(event) event.stopPropagation(); 
        const wrapper = el.parentElement;
        document.querySelectorAll('.crew-wrapper').forEach(div => { if (div !== wrapper) div.classList.remove('mobile-active'); });
        wrapper.classList.toggle('mobile-active');
    };

    window.openCrewProfile = function(el, event, itemId, sectionName) {
        if(event) event.stopPropagation();
        const section = budget.sections[sectionName];
        const item = section.items.find(i => i.id === itemId);
        if(!item) return;

        const crew = item.crew || { name: '', phone: '', email: '' };
        const cleanPhone = crew.phone ? crew.phone.replace(/\D/g, '') : '';
        const hasPhone = cleanPhone.length > 6;
        const hasEmail = crew.email && crew.email.includes('@');

        const waLink = `https://wa.me/${(cleanPhone.length === 10 && (cleanPhone.startsWith('876') || cleanPhone.startsWith('658'))) ? '1'+cleanPhone : cleanPhone}`;

        const actionsBar = `
            <div class="flex justify-center gap-6 mb-8 mt-4">
                ${hasPhone ? `
                    <a href="tel:${cleanPhone}" class="flex flex-col items-center gap-2 group">
                        <div class="w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-600 border border-emerald-100 flex items-center justify-center shadow-sm group-hover:bg-emerald-600 group-hover:text-white transition-all scale-100 active:scale-90">
                            ${mBTAssets.phone}
                        </div>
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Call</span>
                    </a>
                    <a href="${waLink}" target="_blank" class="flex flex-col items-center gap-2 group">
                        <div class="w-12 h-12 rounded-2xl bg-green-50 text-green-600 border border-green-100 flex items-center justify-center shadow-sm group-hover:bg-green-600 group-hover:text-white transition-all scale-100 active:scale-90">
                            ${mBTAssets.wa}
                        </div>
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">WhatsApp</span>
                    </a>` : ''}
                ${hasEmail ? `
                    <a href="mailto:${crew.email}" class="flex flex-col items-center gap-2 group">
                        <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 border border-indigo-100 flex items-center justify-center shadow-sm group-hover:bg-indigo-600 group-hover:text-white transition-all scale-100 active:scale-90">
                            ${mBTAssets.mail}
                        </div>
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Email</span>
                    </a>` : ''}
                ${!hasPhone && !hasEmail ? '<span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic text-center p-4 bg-slate-50 rounded-xl w-full border border-dashed border-slate-200">Pending Personnel Resolution</span>' : ''}
            </div>`;

        const content = `
            <form id="crewProfileForm" class="space-y-6">
                <div class="text-center relative">
                    <div class="w-24 h-24 mx-auto rounded-[32px] bg-slate-900 flex items-center justify-center text-white font-black text-4xl shadow-2xl border-4 border-white rotate-3">
                        ${crew.name ? RenderEngine.esc(crew.name.substring(0,1).toUpperCase()) : '?'}
                    </div>
                    <h3 class="text-xl font-black text-slate-900 mt-4 uppercase tracking-tighter">${RenderEngine.esc(crew.name || 'Anonymous Personnel')}</h3>
                    <p class="text-[10px] text-blue-600 font-black uppercase tracking-widest bg-blue-50 inline-block px-3 py-1 rounded-full mt-1">${RenderEngine.esc(item.description)}</p>
                </div>
                ${actionsBar}
                <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100 space-y-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Digital Profile</h4>
                        <button type="button" id="importContactBtn" class="text-[10px] font-black uppercase tracking-widest text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-2">${mBTAssets.plus} Native Import</button>
                    </div>
                    <div class="space-y-3">
                        <input type="text" id="crewName" value="${RenderEngine.esc(crew.name || '')}" placeholder="LEGAL FULL NAME" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-black uppercase tracking-tighter outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="tel" id="crewPhone" value="${RenderEngine.esc(crew.phone || '')}" placeholder="PHONE" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-mono font-bold outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                            <input type="email" id="crewEmail" value="${RenderEngine.esc(crew.email || '')}" placeholder="EMAIL" class="w-full p-3 bg-white border-none rounded-xl shadow-sm text-xs font-mono font-bold outline-none focus:ring-4 focus:ring-blue-50 transition-all">
                        </div>
                    </div>
                </div>
                <div class="pt-4 flex justify-between items-center gap-4">
                    <button type="button" class="text-rose-500 text-[10px] font-black uppercase tracking-widest hover:bg-rose-50 px-4 py-3 rounded-2xl transition-all" onclick="window.clearCrewAssignment('${itemId}', '${sectionName}')">Remove Member</button>
                    <button type="submit" class="flex-grow py-4 bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest rounded-2xl shadow-xl hover:bg-black transition-all active:scale-95">Verify & Synchronize</button>
                </div>
            </form>`;

        mBTME.open('crewProfile', 'Personnel Profile', content, 'max-w-sm');

        document.getElementById('importContactBtn')?.addEventListener('click', async () => {
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const contacts = await navigator.contacts.select(['name', 'tel', 'email'], { multiple: false });
                    if (contacts.length) {
                        const c = contacts[0];
                        if(c.name?.[0]) document.getElementById('crewName').value = c.name[0];
                        if(c.tel?.[0]) document.getElementById('crewPhone').value = c.tel[0];
                        if(c.email?.[0]) document.getElementById('crewEmail').value = c.email[0];
                    }
                } catch (ex) { console.warn("Native contact resolution failure", ex); }
            } else { alert("Device infrastructure does not support native contact selection."); }
        });

        document.getElementById('crewProfileForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            item.crew = { 
                name: document.getElementById('crewName').value.trim(), 
                phone: document.getElementById('crewPhone').value.trim(), 
                email: document.getElementById('crewEmail').value.trim() 
            };
            if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
            mBTME.close('crewProfileModal');
            if(typeof render === 'function') render(); 
        });
    };

    window.clearCrewAssignment = function(itemId, sectionName) {
        if(confirm('Unassign this personnel record?')) {
            const item = budget.sections[sectionName]?.items.find(i => i.id === itemId);
            if(item) {
                delete item.crew;
                if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
                mBTME.close('crewProfileModal');
                if(typeof render === 'function') render();
            }
        }
    };

    /* --- 2. Export Orchestration: Industry PDF Logic (mBTLE Handshake) --- */
    function exportToPdf() {
        const content = `
            <div class="p-6 space-y-6">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">PDF Export Configuration</h3>
                <div class="space-y-4">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox" id="pdfFitToPageModal" checked class="w-5 h-5 rounded-lg border-slate-200 text-blue-600">
                        <span class="text-sm font-bold text-slate-700">Fit to Page Width</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox" id="pdfLandscapeModal" class="w-5 h-5 rounded-lg border-slate-200 text-blue-600">
                        <span class="text-sm font-bold text-slate-700">Landscape Mode</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox" id="pdfHideZeroQtyModal" class="w-5 h-5 rounded-lg border-slate-200 text-blue-600">
                        <span class="text-sm font-bold text-slate-700">Hide Zero Quantities</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input type="checkbox" id="pdfStagesModal" class="w-5 h-5 rounded-lg border-slate-200 text-blue-600">
                        <span class="text-sm font-bold text-slate-700">Include Stage Summary</span>
                    </label>
                </div>
                <button id="confirmPdfExport" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black uppercase tracking-widest text-[10px] shadow-xl hover:bg-black transition-all">Generate PDF Binary</button>
            </div>`;
        
        mBTME.open('pdfExport', 'Industry PDF Export', content, 'max-w-md', {
            onOpen: () => {
                document.getElementById('confirmPdfExport')?.addEventListener('click', () => {
                    const opts = {
                        fit: document.getElementById('pdfFitToPageModal').checked,
                        hideZero: document.getElementById('pdfHideZeroQtyModal').checked,
                        landscape: document.getElementById('pdfLandscapeModal').checked,
                        stages: document.getElementById('pdfStagesModal').checked
                    };
                    mBTME.close('pdfExportModal');
                    if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: opts.landscape ? 'landscape' : 'portrait' });
                    doc.save(`${(budget.projectName || 'Budget').replace(/\s+/g, '_')}.pdf`);
                });
            }
        });
    }

    /* --- 3. Universal Data Ingestion (PWA Environment Integrity) --- */
    function handleUniversalImport() {
        const input = document.createElement('input');
        input.type = 'file'; input.multiple = true;
        input.accept = '.moo,.json,.pdf,.doc,.docx,.txt,.csv,.xlsx,image/*';
        input.style.display = 'none'; document.body.appendChild(input);

        input.onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            let attachedCount = 0;

            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                if (ext === 'moo' || (ext === 'json' && file.name.includes('Budget'))) {
                    try {
                        const text = await file.text();
                        const imported = JSON.parse(text);
                        if (!imported.sections || !imported.projectName) throw new Error("Format Resolution Failure");
                        budget = mBTState.wrap(imported);
                        if(typeof render === 'function') render();
                    } catch (err) { alert(`Import Failure: ${err.message}`); }
                } else if (budget) {
                    if (!budget.attachments) budget.attachments = [];
                    budget.attachments.push({
                        id: crypto.randomUUID(), name: file.name, type: file.type,
                        size: file.size, dateAdded: new Date().toISOString(),
                        content: (['txt','csv','md'].includes(ext)) ? (await file.text()).substring(0, 25000) : null
                    });
                    attachedCount++;
                }
            }
            if (attachedCount > 0) { if(typeof saveBudget === 'function') saveBudget(); if(typeof render === 'function') render(); }
            document.body.removeChild(input);
        };
        input.click();
    }

    /* --- 4. Attachment Management & Offline Self-Export --- */
    function removeAttachment(id) {
        if(!budget || !budget.attachments) return;
        budget.attachments = budget.attachments.filter(a => a.id !== id);
        if(typeof saveBudget === 'function') saveBudget();
        if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
        if(typeof showAIToolsModal === 'function') showAIToolsModal();
    }

    function downloadOfflineHTML() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([document.documentElement.outerHTML], {type: 'text/html'}));
        a.download = `mooBudgetTool_v${APP_VERSION}.html`;
        a.click();
    }

    /* --- 5. Template Orchestration (Module events) --- */
    function bindTemplateEvents() {
        document.getElementById('templateSelector')?.addEventListener('change', (e) => {
            editingTemplateId = e.target.value;
            tempTemplateData = null; 
            window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
        });

        document.getElementById('createTemplateBtn')?.addEventListener('click', () => {
            const name = prompt("Enter new template identifier:");
            if (name) {
                const allTemplates = getAllTemplates();
                if(allTemplates[name]) return alert("Template identifier already exists.");
                const base = editingTemplateId ? allTemplates[editingTemplateId] : DEFAULT_TEMPLATES['Commercial'];
                allTemplates[name] = JSON.parse(JSON.stringify(base));
                allTemplates[name].projectName = `Untitled ${name} Project`;
                saveAllTemplates(allTemplates);
                editingTemplateId = name;
                window.switchSettingsTab('templates', document.querySelector('button[onclick*="templates"]'));
            }
        });

        document.getElementById('saveTemplateChangesBtn')?.addEventListener('click', () => {
            if(isDefaultTemplate(editingTemplateId)) return alert("Default logic protected.");
            if (tempTemplateData && editingTemplateId) {
                const allTemplates = getAllTemplates();
                allTemplates[editingTemplateId] = tempTemplateData;
                saveAllTemplates(allTemplates);
                alert("Template Logic Secured!");
                tempTemplateData = null;
            }
        });

        const editorContainer = document.getElementById('templateEditorContainer');
        if(editorContainer) {
            renderTemplateEditor(editorContainer);
            if(isDefaultTemplate(editingTemplateId)) return; 
            editorContainer.addEventListener('change', (e) => {
                const target = e.target;
                if(!tempTemplateData) tempTemplateData = JSON.parse(JSON.stringify(getAllTemplates()[editingTemplateId]));
                if (target.dataset.daysField) {
                     if(!tempTemplateData.days) tempTemplateData.days = { principal: 10, scouting: 5, preprod: 15 };
                     tempTemplateData.days[target.dataset.daysField] = parseFloat(target.value) || 0;
                     recalculateTemplateQuantities(tempTemplateData);
                     renderTemplateEditor(editorContainer);
                } else if (target.dataset.templateField) {
                    const field = target.dataset.templateField;
                    const val = target.value;
                    if(target.dataset.templateId) { 
                        const section = tempTemplateData.sections[target.dataset.templateSection];
                        const item = section.items.find(i => i.id === target.dataset.templateId);
                        if(item) item[field] = (['quantity', 'rate', 'multiplier'].includes(field)) ? parseFloat(val) : val;
                    } else { 
                        if(['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(field)) tempTemplateData[field] = parseFloat(val);
                    }
                }
            });
        }
    }

    /* --- 6. Interaction Handlers: Draggable Percentage Controls --- */
    function initializeInteractiveInputs() { 
        ['contingencyPercentage','salesTaxPercentage','discountPercentage'].forEach(id => {
            const el = document.getElementById(id);
            if(el) makeInputDraggable(el);
        });
    }

    function makeInputDraggable(input) {
        if (!input || input.dataset.draggable === 'true') return;
        input.dataset.draggable = 'true';
        input.style.cursor = 'ew-resize';
        let startX, startVal;
        const onMove = (e) => { 
            const delta = e.clientX - startX; 
            input.value = Math.max(0, startVal + (delta * 0.2)).toFixed(2); 
            input.dispatchEvent(new Event('input', {bubbles:true})); 
        };
        const onUp = () => { 
            document.removeEventListener('mousemove', onMove); 
            document.removeEventListener('mouseup', onUp); 
            if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
        };
        input.addEventListener('mousedown', (e) => { 
            if(input === document.activeElement) return; 
            startX = e.clientX; 
            startVal = parseFloat(input.value)||0; 
            document.addEventListener('mousemove', onMove); 
            document.addEventListener('mouseup', onUp); 
        });
    }

    /* ========= mBT SWITCHBOARD: Document Synchronization Hub ========= */
    window.updateMtempField = function(docId, section, key, value) {
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc || !doc.content || !doc.content.data) return;
        if (!doc.content.data[section]) doc.content.data[section] = {};
        doc.content.data[section][key] = RenderEngine.esc(value);
        if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
    };

    window.updateMtempTable = function(docId, tableKey, rowIndex, colIndex, value) {
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc || !doc.content || !doc.content.data) return;
        if (!doc.content.data.tables) doc.content.data.tables = {};
        if (!doc.content.data.tables[tableKey]) {
            const spec = doc.content.fields.tables[tableKey];
            doc.content.data.tables[tableKey] = JSON.parse(JSON.stringify(spec.rows || []));
        }
        const table = doc.content.data.tables[tableKey];
        if (table[rowIndex]) {
            table[rowIndex][colIndex] = RenderEngine.esc(value);
            if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
        }
    };

    window.addMtempRow = function(docId, tableKey) {
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc || !doc.content) return;
        const spec = doc.content.fields.tables[tableKey];
        if (!doc.content.data.tables) doc.content.data.tables = {};
        if (!doc.content.data.tables[tableKey]) {
            doc.content.data.tables[tableKey] = JSON.parse(JSON.stringify(spec.rows || []));
        }
        const newRow = new Array(spec.columns.length).fill('');
        doc.content.data.tables[tableKey].push(newRow);
        if (typeof openDocumentViewer === 'function') openDocumentViewer(docId);
    };

    window.removeMtempRow = function(docId, tableKey, rowIndex) {
        const doc = budget.documents.find(d => d.id === docId);
        if (!doc || !doc.content.data.tables || !doc.content.data.tables[tableKey]) return;
        doc.content.data.tables[tableKey].splice(rowIndex, 1);
        if (typeof openDocumentViewer === 'function') openDocumentViewer(docId);
        if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
    };

    /* ========= v9.0 mBTDB: STUDIO BUILDER ENGINE v19.55 ========= */
    window.mBTDB = {
        state: { currentDocId: null, isEditing: false, grid: null, history: [], historyPointer: -1 },
        icons: {
            trash: mBTAssets.trash, plus: mBTAssets.plus, user: mBTAssets.user,
            cloud: mBTAssets.cloud, save: mBTAssets.save, undo: mBTAssets.undo,
            redo: mBTAssets.redo, copy: mBTAssets.copy, print: mBTAssets.print,
            close: mBTAssets.close, wand: mBTAssets.wand, grid: mBTAssets.grid, list: mBTAssets.list
        },
        templates: {
            'default': { label: "Blank Document", widgets: [{ id: 'meta_header', x: 0, y: 0, w: 12, h: 2, type: 'header' }] },
            'callSheet': {
                label: "Daily Call Sheet",
                widgets: [
                    { id: 'contacts', x: 0, y: 0, w: 12, h: 4, type: 'contacts', label: "Key Contacts" }, 
                    { id: 'logistics', x: 0, y: 4, w: 12, h: 6, type: 'logistics', label: "Logistics" },
                    { id: 'schedule', x: 0, y: 10, w: 12, h: 8, type: 'schedule', label: "Schedule" },
                    { id: 'cast', x: 0, y: 18, w: 6, h: 8, type: 'cast', label: "Cast List" },
                    { id: 'crew', x: 6, y: 18, w: 6, h: 8, type: 'crew', label: "Crew List" },
                    { id: 'notes', x: 0, y: 26, w: 12, h: 4, type: 'richText', label: "General Notes" }
                ]
            }
        },
        open: function(docId) {
            this.state.currentDocId = docId;
            const doc = budget.documents.find(d => d.id === docId);
            if (!doc) return;
            if (!doc.content) doc.content = { data: {}, widgets: [] };
            if (!doc.content.widgets || doc.content.widgets.length === 0) {
                const tKey = this.templates[doc.type] ? doc.type : 'default';
                doc.content.widgets = JSON.parse(JSON.stringify(this.templates[tKey].widgets));
                if(!doc.content.data.meta) doc.content.data = this._generateDefaultData();
            }
            if(typeof mBTME !== 'undefined') {
                mBTME.open('documentViewerModal', 'Document Studio', '<div id="mBTDB_Container"></div>', 'w-full h-full max-w-full', { noPadding: true, hideHeader: true });
                this.renderFrame();
            }
        },
        close: function() { if(typeof mBTME !== 'undefined') mBTME.close('documentViewerModal'); document.body.classList.remove('print-mode'); },
        toggleEditMode: function() {
            if (this.state.isEditing && this.state.grid) this._saveLayoutState(); 
            this.state.isEditing = !this.state.isEditing;
            const container = document.getElementById('mBTDB_Workspace');
            const grid = this.state.grid;
            if (container && grid) {
                if (this.state.isEditing) { container.classList.add('editing-mode'); grid.setStatic(false); grid.enable(); } 
                else { container.classList.remove('editing-mode'); grid.setStatic(true); grid.disable(); }
                this._updateHeaderButtons();
            }
        },
        _saveLayoutState: function() {
            if (!this.state.grid) return;
            const doc = budget.documents.find(d => d.id === this.state.currentDocId);
            this.state.grid.engine.nodes.forEach(node => {
                const widget = doc.content.widgets.find(w => w.id === node.id);
                if (widget) { widget.x = node.x; widget.y = node.y; widget.w = node.w; widget.h = node.h; }
            });
            this._triggerSave();
        },
        _getContentForWidget: function(widget, doc) {
            const data = doc.content.data;
            if (widget.type === 'contacts') return this._renderContacts(doc.id, data, widget);
            if (['logistics', 'locations'].includes(widget.type)) return this._renderLogistics(doc.id, data);
            if (widget.type === 'schedule') return this._renderSchedule(doc.id, data);
            if (widget.type === 'crew') return this._renderCrew(doc.id, data);
            if (widget.type === 'cast') return this._renderTalent(doc.id, data);
            if (widget.type === 'richText') return this._renderRichText(doc.id, widget.id, data);
            return '';
        },
        _renderMetaHeader: function(doc) {
            const d = doc.content.data;
            const html = `<div class="flex flex-wrap gap-4 items-end justify-between px-2"><div class="w-full sm:w-auto flex-grow"><input value="${d.meta.productionTitle || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionTitle', this.value)" class="text-3xl font-black uppercase w-full outline-none text-slate-900 bg-transparent mb-1 tracking-tighter" placeholder="PRODUCTION TITLE"><div class="flex gap-4"><div class="flex items-center gap-1.5"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Date</span><input type="date" value="${d.meta.shootDate}" onchange="mBTDB.updateData('${doc.id}', 'meta.shootDate', this.value); mBTDB.renderFrame();" class="mbt-input w-auto font-bold border-none bg-slate-50 px-2 rounded-md"></div><div class="flex items-center gap-1.5"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Call</span><input type="text" value="${d.meta.crewCallTime}" onchange="mBTDB.updateData('${doc.id}', 'meta.crewCallTime', this.value)" onblur="mBTDB.formatTime(this)" class="mbt-input w-16 bg-yellow-300 font-black border-none text-center rounded-md" placeholder="00:00"></div><div class="flex items-center gap-1.5 bg-slate-100 px-2.5 py-0.5 rounded-md"><span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Day</span><span class="text-xs font-black text-slate-800">${this.calcShootDay(d.meta.shootDate)}</span></div></div></div><div class="w-48 text-right"><input value="${d.meta.productionCompany || ''}" onchange="mBTDB.updateData('${doc.id}', 'meta.productionCompany', this.value)" class="mbt-input text-right font-bold border-none text-slate-500 italic" placeholder="Production Company"></div></div>`;
            const container = document.getElementById('mBTDB_MetaArea'); if(container) container.innerHTML = html;
        },
        renderFrame: function() {
            const doc = budget.documents.find(d => d.id === this.state.currentDocId);
            const container = document.getElementById('mBTDB_Container');
            if(!container) return;
            const toolbarHTML = `<div id="mBTDB_Header" class="bg-slate-900 text-white p-3 flex justify-between items-center sticky top-0 z-50 shadow-xl border-b border-black print:hidden"><div class="flex items-center gap-4"><h2 class="font-black text-xs uppercase tracking-widest text-slate-400 flex items-center gap-2"><span class="text-blue-500">${this.icons.list}</span> Studio: ${RenderEngine.esc(doc.label)}</h2><div class="flex bg-slate-800 rounded-lg overflow-hidden border border-slate-700"><button onclick="mBTDB.syncFromBudget()" class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 text-slate-300 hover:bg-slate-700 border-r border-slate-700 transition-colors">Sync Budget</button><button onclick="mBTDB.syncFromPrevious()" class="text-[9px] font-black uppercase tracking-widest px-3 py-1.5 text-slate-300 hover:bg-slate-700 transition-colors">Sync Prev</button></div></div><div class="flex gap-2 items-center" id="mBTDB_Buttons"></div></div>`;
            const workspaceHTML = `<div id="mBTDB_Workspace" class="bg-slate-100 min-h-screen p-6 overflow-y-auto no-scrollbar ${this.state.isEditing ? 'editing-mode' : ''}"><div id="mBTDB_MetaArea" class="mb-6 bg-white p-6 shadow-2xl rounded-2xl border border-slate-200 animate-in fade-in duration-500"></div><div class="grid-stack no-scrollbar"></div></div>`;
            container.innerHTML = toolbarHTML + workspaceHTML;
            this._renderMetaHeader(doc);
            setTimeout(() => {
                if(typeof GridStack === 'undefined') return console.error("GridStack resolution failure.");
                this.state.grid = GridStack.init({ column: 12, cellHeight: 65, minRow: 1, margin: 8, animate: true, float: true, staticGrid: !this.state.isEditing }, container.querySelector('.grid-stack'));
                this._loadWidgetsToGrid(doc);
                this._updateHeaderButtons();
                this.state.grid.on('change', () => this._triggerSave());
            }, 50);
        },
        updateData: function(docId, path, value) { const doc = budget.documents.find(d => d.id === docId); const parts = path.split('.'); let target = doc.content.data; for(let i=0; i<parts.length-1; i++) { if(!target[parts[i]]) target[parts[i]]={}; target = target[parts[i]]; } target[parts[parts.length-1]] = value; this._triggerSave(); },
        updateRow: function(docId, section, index, key, value) { const doc = budget.documents.find(d => d.id === docId); if(doc.content.data[section][index]) { doc.content.data[section][index][key] = value; this._triggerSave(); } },
        addRow: function(docId, section, type, presetData) { const doc = budget.documents.find(d => d.id === docId); if(!doc.content.data[section]) doc.content.data[section] = []; let newRow = presetData || { id: Date.now() }; doc.content.data[section].push(newRow); this._triggerSave(); this.renderFrame(); },
        deleteRow: function(docId, section, index) { const doc = budget.documents.find(d => d.id === docId); doc.content.data[section].splice(index, 1); this._triggerSave(); this.renderFrame(); },
        calcShootDay: function(dateStr) { if(!budget.startDate) return "Day 1"; const start = new Date(budget.startDate); const current = new Date(dateStr); return `Day ${Math.ceil((current - start) / 86400000) + 1}`; },
        syncFromBudget: function() { if(!confirm("Synchronization with Budget details?")) return; const doc = budget.documents.find(d => d.id === this.state.currentDocId); const defaults = this._generateDefaultData(); doc.content.data.crew = defaults.crew; doc.content.data.contacts = defaults.contacts; mBTLE.reconcile(); this.renderFrame(); },
        _triggerSave: function() { if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); },
        _generateDefaultData: function() { return { meta: { productionTitle: budget.projectName||"", productionCompany: budget.company||"", shootDate: new Date().toISOString().split('T')[0], crewCallTime: "08:00" }, contacts: { director: "", producer: "", ad: "" }, schedule: [], crew: [], cast: [], locations: [{name:"Base Camp", address:"", weather:"", hospital:"", mapLink:""}], additional: {} }; }
    };

    /* ========= mBTTrash: Global Recycle Bin Engine (Solid Block) ========= */
    window.mBTTrash = {
        state: { activeTab: 'documents' },
        trashIcons: mBTAssets,
        open: function(tab = 'documents') {
            this.state.activeTab = tab;
            const type = this.state.activeTab;
            const docTrash = budget.documentTrash || [];
            const content = `
                <div class="flex flex-col h-[500px]">
                    <div class="flex border-b bg-gray-50">
                        <button onclick="mBTTrash.open('documents')" class="flex-1 py-3 text-xs font-black uppercase ${type==='documents'?'bg-white text-blue-600 border-b-2 border-blue-600':'text-gray-400'}">Documents (${docTrash.length})</button>
                        <button onclick="mBTTrash.open('projects')" class="flex-1 py-3 text-xs font-black uppercase ${type==='projects'?'bg-white text-blue-600 border-b-2 border-blue-600':'text-gray-400'}">Projects</button>
                    </div>
                    <div class="flex-grow overflow-y-auto p-4 bg-slate-50">
                        ${docTrash.length === 0 ? '<div class="h-full flex flex-col items-center justify-center opacity-20">'+this.trashIcons.trash+'<p class="font-black uppercase text-[10px] mt-2">Bin is Empty</p></div>' : ''}
                    </div>
                </div>`;
            mBTME.open('trash', 'Recycle Bin', content, 'max-w-lg', { noPadding: true, hideHeader: true });
        },
        trashDocument: function(docId) {
            const idx = budget.documents.findIndex(d => d.id === docId);
            if (idx > -1) {
                const doc = budget.documents.splice(idx, 1)[0];
                if(!budget.documentTrash) budget.documentTrash = [];
                budget.documentTrash.push(doc);
                if(typeof render === 'function') render();
            }
        }
    };

    /* ========= CallSheetBuilder: Dedicated Logic Expansion ========= */
    if (typeof CallSheetBuilder !== 'undefined') {
        CallSheetBuilder.autoFillFromBudget = function(docId) {
            const doc = budget.documents.find(d => d.id === docId);
            if (!doc || !doc.content || !doc.content.data) return;
            doc.content.data.crew = [];
            Object.entries(budget.sections).forEach(([sec, sObj]) => {
                sObj.items.forEach(i => {
                    if (i.crew?.name) {
                        doc.content.data.crew.push({ department: sec, position: i.description, name: i.crew.name, contact: i.crew.phone || i.crew.email || '-', callTime: "08:00" });
                    }
                });
            });
            this.render(docId);
        };
    }

    /* --- 7. Stage & Analytics Interface (Orchestration) --- */
    function showStagesModal() {
        if (!budget.targetLock) budget.targetLock = { enabled: false, totalCap: 0, stages: {} };
        const tl = budget.targetLock;
        const validKeys = ['dev', 'pre', 'prod', 'post', 'dist'];
        validKeys.forEach(k => { if (!tl.stages[k]) tl.stages[k] = { label: k.toUpperCase(), ratio: 20, days: 0, locked: false }; });
        const content = ``;
        mBTME.open('stagesView', 'Production Ratios', content, 'max-w-6xl w-full', { noPadding: true, hideHeader: true, onOpen: () => {
            if(typeof initializeStageDragAndDrop === 'function') initializeStageDragAndDrop();
        }});
    }

    window.openAnalyticsHub = function() {
        let allItems = []; let total = 0;
        Object.entries(budget.sections).forEach(([secName, section]) => {
            section.items.forEach(item => {
                const cost = item.quantity * item.rate;
                if (cost > 0) { total += cost; allItems.push({ name: item.description, total: cost }); }
            });
        });
        const drivers = allItems.sort((a,b) => b.total - a.total).slice(0, 5);
        const content = `<div class="p-6">Analytics and Cost Driver Logic Resolving...</div>`;
        mBTME.open('analyticsHub', 'Budget Intelligence', content, 'max-w-2xl');
    };

    function initializeStageDragAndDrop() {
        const containers = document.querySelectorAll('.stage-drop-zone');
        containers.forEach(container => {
            if (container._sortableStage) return;
            container._sortableStage = new Sortable(container, {
                group: { name: 'stages-shared', pull: 'clone', put: true },
                onEnd: function (evt) {
                    const newStageKey = evt.to.dataset.stageKey;
                    const itemId = evt.item.dataset.itemId;
                    if (!newStageKey) return;
                    let item = null;
                    for (const sec of Object.values(budget.sections)) {
                        item = sec.items.find(i => i.id === itemId);
                        if (item) break;
                    }
                    if (item) {
                        if (!item.stageData) item.stageData = {};
                        item.stageData[newStageKey] = { days: item.quantity, rate: item.rate };
                        if(typeof mBTLE !== 'undefined') mBTLE.reconcile();
                        if(typeof render === 'function') render();
                    }
                }
            });
        });
    }

    window.autofillMtemp = function(docId) {
        const doc = budget.documents.find(d => d.id === docId);
        if (doc && typeof mBTPublisher !== 'undefined') {
            mBTPublisher.processAutofill(doc, budget);
            if (typeof openDocumentViewer === 'function') openDocumentViewer(docId); 
        }
    };





/* ================= v19.54 TIER 6: System Ignition ================= */

  /* --- 1. OFFLINE ENDURANCE SERVICE (Service Worker Registration) --- */
    // Logic Resolution: Forcing validation of script assets while bypassing browser cache.
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // --- Synchronization Policy: Force validation of script, bypassing browser cache ---
            navigator.serviceWorker.register('./sw.js', { scope: './', updateViaCache: 'none' })
                .then(reg => {
                    console.log('SW Synchronization active:', reg.scope);
                    
                    // --- Logic Change Detection: Monitoring repository for environmental changes ---
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // --- Conflict Resolution: Prompt for manual environment refresh ---
                                    console.log('Logic synchronization detected; prompting for resolution.');
                                    if(confirm("New production logic available! Synchronize environment now?")) {
                                        window.location.reload();
                                    }
                                } else {
                                    console.log('Content successfully cached for offline endurance.');
                                }
                            }
                        };
                    };
                })
                .catch(err => console.log('Service Worker initialization failure:', err));
        });
    }

    /* --- 2. GLOBAL EVENT ORCHESTRATION (mBTLE Handshake Hub) --- */
    // Logic Resolution: Centralized delegation for all interface triggers to prevent listener fragmentation.
    function bindAppEventListeners() {
        const appContainer = document.getElementById('app');
        const footer = document.querySelector('footer');

        if (!appContainer || appContainer.dataset.listenersBound) return;
        appContainer.dataset.listenersBound = 'true';

        // --- Master Change Listener: Environmental synchronization ---
        appContainer.addEventListener('change', (e) => {
            const id = e.target.id;
            if (id === 'projectName') {
                if (typeof handleProjectNameChange === 'function') handleProjectNameChange(e);
            } else if (['contingencyPercentage', 'salesTaxPercentage', 'discountPercentage'].includes(id)) {
                budget[id] = parseFloat(e.target.value) || 0;
                // --- Brain Handshake: High-speed mathematical reconciliation ---
                if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
            } else if (id === 'projectLoader') {
                loadBudget(e.target.value);
                render();
            } else if (id === 'newProjectSelector') {
                if (typeof handleNewProjectSelection === 'function') handleNewProjectSelection(e);
            } else if (e.target.dataset.field === 'unit') {
                handleUpdate(e.target.dataset.section, e.target.dataset.id, 'unit', e.target.value, `Unit synchronization`);
            } else if (id === 'currencySelector') {
                displayCurrency = e.target.value;
                localStorage.setItem(`${storageKeyPrefix}currency`, displayCurrency);
                if(typeof mBTLE !== 'undefined') mBTLE.reconcile(); 
                if(typeof render === 'function') render();
            }
        });

        // --- Master Click Listener: Interface orchestration ---
        appContainer.addEventListener('click', (e) => {
            const target = e.target;
            
            if (target.id === 'undoBtn') { if (typeof handleUndo === 'function') handleUndo(); }
            else if (target.id === 'redoBtn') { if (typeof handleRedo === 'function') handleRedo(); }
            else if (target.id === 'loginBtn') { if (typeof handleLogin === 'function') handleLogin(); }
            else if (target.closest('#openAiToolsBtn')) { if (typeof showAIToolsModal === 'function') showAIToolsModal(); }
            else if (target.closest('#deleteProjectBtn')) { if (typeof deleteProject === 'function') deleteProject(currentProjectName); }
            else if (target.closest('#exportPdfBtn')) { if (typeof exportToPdf === 'function') exportToPdf(); }
            else if (target.closest('#exportXlsxBtn')) { if (typeof exportToXlsx === 'function') exportToXlsx(); }
            else if (target.id === 'exportMooBtn') { if (typeof mBTPublisher !== 'undefined') mBTPublisher.toMoo(); }
            else if (target.id === 'publishBtn') { if (typeof showPublishModal === 'function') showPublishModal(); }
            else if (target.closest('[data-section-toggle]')) {
                handleToggleSection(target.closest('[data-section-toggle]').dataset.sectionToggle);
            } else if (target.closest('[data-add-item]')) {
                showItemSelectorModal(target.closest('[data-add-item]').dataset.addItem);
            } else if (target.closest('[data-remove-item]')) {
                const btnData = target.closest('[data-remove-item]').dataset;
                handleRemoveItem(btnData.section, btnData.removeItem);
            }
        });

        // --- Master Input Listener: Real-time mathematical handshake ---
        appContainer.addEventListener('input', (e) => {
            const input = e.target;
            if (input.dataset.field) {
                handleUpdate(input.dataset.section, input.dataset.id, input.dataset.field, input.value, `Live synchronization`);
            } else if (['discountPercentage', 'contingencyPercentage', 'salesTaxPercentage'].includes(input.id)) {
                budget[input.id] = parseFloat(input.value) || 0;
                if (typeof mBTLE !== 'undefined') mBTLE.reconcile();
            }
        });

        // --- Footer Navigation: Module activation resolution ---
        if (footer) {
            footer.addEventListener('click', (e) => { 
                const btn = e.target.closest('button');
                if (!btn) return;
                if (btn.id === 'docsFooterBtn') { if (typeof showDocumentsModal === 'function') showDocumentsModal(); }
                else if (btn.id === 'stagesFooterBtn') { if (typeof showStagesModal === 'function') showStagesModal(); }
                else if (btn.id === 'publishFooterBtn') document.getElementById('publishBtn')?.click();
                else if (btn.id === 'settingsBtn') { if (typeof showSettingsModal === 'function') showSettingsModal(); }
                else if (btn.id === 'footerCoffeeBtn') {
                    window.open('https://buymeacoffee.com/jaysonmy', '_blank');
                }
            });
        }

        window.addEventListener('online', resolveConnectivityStatus);
        window.addEventListener('offline', resolveConnectivityStatus);
    }

    /* --- 3. INFRASTRUCTURE TELEMETRY (Connectivity resolution) --- */
    function resolveConnectivityStatus() { 
        const isOnline = navigator.onLine;
        const btn = document.getElementById('loginBtn'); 
        if(btn) { 
            btn.className = `w-10 h-10 rounded-full border-2 flex items-center justify-center transition-all duration-300 shadow-sm flex-shrink-0 ${isOnline ? 'border-emerald-400 bg-emerald-50 text-emerald-600' : 'border-rose-400 bg-rose-50 text-rose-600'}`; 
            btn.title = isOnline ? "Studio Online" : "Studio Offline"; 
            btn.innerHTML = mBTAssets.user;
        }
        const aiBtn = document.getElementById('openAiToolsBtn');
        if(aiBtn) {
            aiBtn.className = `p-2.5 border rounded-xl text-xs font-black uppercase tracking-widest transition-all flex items-center justify-center flex-shrink-0 ${isOnline ? 'bg-indigo-50 border-indigo-200 text-indigo-700 hover:bg-indigo-100 shadow-sm' : 'bg-slate-100 border-slate-200 text-slate-400 cursor-not-allowed opacity-75'}`;
            if(!isOnline) aiBtn.title = "AI Consultant Offline";
        }
    }

    function handleLogin() { 
        if (navigator.onLine && confirm("Establish secure connection to Moo Studio Cloud infrastructure?")) {
            alert("Environment Authenticated."); 
        }
    }

    /* --- 4. GLOBAL BOOT SEQUENCE (Environment resolution) --- */
    function init() {
        // --- Document Identity: Branding resolution ---
        document.title = `mooBudgetTool v${APP_VERSION}`;
        
        // --- State Hydration: Restoring currency and mathematical preferences ---
        displayCurrency = localStorage.getItem(`${storageKeyPrefix}currency`) || 'JMD';
        
        // --- Brain Handshake: Coordinate initial exchange logic ---
        if (typeof fetchExchangeRates === 'function') fetchExchangeRates();

        // --- Persistence Recovery: Locating last active project environment ---
        let projectToLoad = localStorage.getItem(`${storageKeyPrefix}lastLoaded`);
        if (!projectToLoad || !getProjectList().includes(projectToLoad)) {
            projectToLoad = getProjectList()[0];
        }
        
        // --- Structural Resolution: Initializing project state ---
        if (!projectToLoad) {
            if (typeof handleNewProject === 'function') handleNewProject(false);
        } else {
            if (typeof loadBudget === 'function') loadBudget(projectToLoad);
        }
        
        // --- UI Ignition: Triggering primary render and connectivity telemetry ---
        if (typeof render === 'function') {
            render();
            bindAppEventListeners();
            resolveConnectivityStatus();
            console.log(`Studio Core v${APP_VERSION} Synchronized.`);
        } else {
            console.error("Critical Resolution Failure: RenderEngine not found.");
        }
    }

    /* --- 5. GLOBAL BRIDGE HOOKS & LIFECYCLE TRIGGER --- */
    window.showBinModal = () => { if (typeof mBTTrash !== 'undefined') mBTTrash.open('documents'); };
    window.handleDocTrash = (id) => { if (typeof mBTTrash !== 'undefined') mBTTrash.trashDocument(id); };

    // --- Master Lifecycle Trigger: DOM Synchronization ---
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof init === 'function') init();
    });

/* ======= END OF mBT ========== */
</script>
</body>
</html>
